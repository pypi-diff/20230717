# Comparing `tmp/siat-2.4.0-py3-none-any.whl.zip` & `tmp/siat-2.4.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,26 +1,26 @@
-Zip file size: 1719259 bytes, number of entries: 127
+Zip file size: 1720783 bytes, number of entries: 127
 -rw-rw-rw-  2.0 fat      840 b- defN 23-Apr-10 11:29 siat/__init__.py
 -rw-rw-rw-  2.0 fat     2286 b- defN 23-Jul-17 01:30 siat/allin.py
 -rw-rw-rw-  2.0 fat      747 b- defN 23-Apr-10 11:29 siat/alpha_vantage_test.py
 -rw-rw-rw-  2.0 fat    28555 b- defN 23-Apr-10 11:29 siat/assets_liquidity.py
 -rw-rw-rw-  2.0 fat     1285 b- defN 23-Apr-10 11:29 siat/assets_liquidity_test.py
 -rw-rw-rw-  2.0 fat    10110 b- defN 23-Apr-10 11:29 siat/barrons_scraping_test.py
 -rw-rw-rw-  2.0 fat    36597 b- defN 23-Apr-10 11:29 siat/beta_adjustment.py
 -rw-rw-rw-  2.0 fat    20433 b- defN 23-Apr-10 11:29 siat/beta_adjustment_china.py
 -rw-rw-rw-  2.0 fat     2467 b- defN 23-Apr-10 11:29 siat/beta_adjustment_test.py
 -rw-rw-rw-  2.0 fat     6032 b- defN 23-Apr-10 11:29 siat/blockchain.py
 -rw-rw-rw-  2.0 fat    99528 b- defN 23-Jun-03 12:59 siat/bond.py
 -rw-rw-rw-  2.0 fat    24155 b- defN 23-Apr-10 11:29 siat/bond_base.py
 -rw-rw-rw-  2.0 fat     3002 b- defN 23-May-25 13:09 siat/bond_china.py
 -rw-rw-rw-  2.0 fat     5246 b- defN 23-Apr-10 11:29 siat/bond_test.py
--rw-rw-rw-  2.0 fat    28499 b- defN 23-Apr-10 11:29 siat/capm_beta.py
+-rw-rw-rw-  2.0 fat    28922 b- defN 23-Jul-17 14:01 siat/capm_beta.py
 -rw-rw-rw-  2.0 fat     1745 b- defN 23-Apr-10 11:29 siat/capm_beta_test.py
 -rw-rw-rw-  2.0 fat    38116 b- defN 23-Apr-10 11:29 siat/cmat_commons.py
--rw-rw-rw-  2.0 fat    66466 b- defN 23-Jul-16 14:53 siat/common.py
+-rw-rw-rw-  2.0 fat    76574 b- defN 23-Jul-17 17:28 siat/common.py
 -rw-rw-rw-  2.0 fat    20806 b- defN 23-Apr-11 14:17 siat/compare_cross.py
 -rw-rw-rw-  2.0 fat     3473 b- defN 23-Apr-10 11:29 siat/compare_cross_test.py
 -rw-rw-rw-  2.0 fat     3061 b- defN 23-Apr-10 11:29 siat/concepts_iwencai.py
 -rw-rw-rw-  2.0 fat     4941 b- defN 23-Apr-10 11:29 siat/concepts_kpl.py
 -rw-rw-rw-  2.0 fat      690 b- defN 23-Apr-10 11:29 siat/copyrights.py
 -rw-rw-rw-  2.0 fat    27351 b- defN 23-Apr-10 11:29 siat/cryptocurrency.py
 -rw-rw-rw-  2.0 fat     2669 b- defN 23-Apr-10 11:29 siat/cryptocurrency_test.py
@@ -75,29 +75,29 @@
 -rw-rw-rw-  2.0 fat    95227 b- defN 23-Jul-13 12:04 siat/option_china.py
 -rw-rw-rw-  2.0 fat    16355 b- defN 23-Apr-10 11:29 siat/option_china_test.py
 -rw-rw-rw-  2.0 fat    70231 b- defN 23-Jul-13 12:03 siat/option_pricing.py
 -rw-rw-rw-  2.0 fat     2203 b- defN 23-Apr-10 11:29 siat/option_pricing_test.py
 -rw-rw-rw-  2.0 fat     5908 b- defN 23-Apr-10 11:29 siat/option_sina_api_test.py
 -rw-rw-rw-  2.0 fat     2610 b- defN 23-Apr-10 11:29 siat/proxy_test.py
 -rw-rw-rw-  2.0 fat     1552 b- defN 23-Apr-10 11:29 siat/quandl_test.py
--rw-rw-rw-  2.0 fat    53746 b- defN 23-Jul-16 14:26 siat/risk_adjusted_return.py
+-rw-rw-rw-  2.0 fat    53820 b- defN 23-Jul-17 16:04 siat/risk_adjusted_return.py
 -rw-rw-rw-  2.0 fat     3416 b- defN 23-Apr-10 11:29 siat/risk_adjusted_return_test.py
 -rw-rw-rw-  2.0 fat    75899 b- defN 23-Jul-13 11:58 siat/risk_evaluation.py
 -rw-rw-rw-  2.0 fat     3731 b- defN 23-Apr-10 11:29 siat/risk_evaluation_test.py
 -rw-rw-rw-  2.0 fat    12388 b- defN 23-Jul-13 11:53 siat/risk_free_rate.py
 -rw-rw-rw-  2.0 fat     4285 b- defN 23-Apr-10 11:29 siat/risk_free_rate_test.py
 -rw-rw-rw-  2.0 fat   102148 b- defN 23-Jul-13 11:51 siat/sector_china.py
 -rw-rw-rw-  2.0 fat     5843 b- defN 23-Apr-11 14:17 siat/sector_china_test.py
 -rw-rw-rw-  2.0 fat    29185 b- defN 23-May-25 02:36 siat/security_price.py
 -rw-rw-rw-  2.0 fat    74707 b- defN 23-Jul-14 12:33 siat/security_prices.py
 -rw-rw-rw-  2.0 fat    10779 b- defN 23-Apr-10 11:29 siat/security_prices_test.py
 -rw-rw-rw-  2.0 fat    10785 b- defN 23-Jul-17 05:07 siat/security_trend.py
 -rw-rw-rw-  2.0 fat     1335 b- defN 23-Apr-10 11:29 siat/setup.py
 -rw-rw-rw-  2.0 fat     1418 b- defN 23-Apr-10 11:29 siat/shenwan index history test.py
--rw-rw-rw-  2.0 fat   130944 b- defN 23-Jul-16 13:45 siat/stock.py
+-rw-rw-rw-  2.0 fat   131075 b- defN 23-Jul-17 15:52 siat/stock.py
 -rw-rw-rw-  2.0 fat    31655 b- defN 23-Apr-10 11:29 siat/stock_advice_linear.py
 -rw-rw-rw-  2.0 fat     1312 b- defN 23-Apr-10 11:29 siat/stock_base.py
 -rw-rw-rw-  2.0 fat    83256 b- defN 23-Jul-13 11:37 siat/stock_china.py
 -rw-rw-rw-  2.0 fat     1294 b- defN 23-Jun-14 07:32 siat/stock_china_test.py
 -rw-rw-rw-  2.0 fat  1266744 b- defN 23-Jun-05 00:13 siat/stock_info.pickle
 -rw-rw-rw-  2.0 fat     6122 b- defN 23-Apr-10 11:29 siat/stock_info_test.py
 -rw-rw-rw-  2.0 fat     1014 b- defN 23-Apr-10 11:29 siat/stock_list_china_test.py
@@ -118,12 +118,12 @@
 -rw-rw-rw-  2.0 fat   118133 b- defN 23-Apr-10 11:29 siat/translate-20230206.py
 -rw-rw-rw-  2.0 fat   121657 b- defN 23-Apr-10 11:29 siat/translate-20230215.py
 -rw-rw-rw-  2.0 fat   134125 b- defN 23-Jul-13 11:40 siat/translate.py
 -rw-rw-rw-  2.0 fat     3936 b- defN 23-Apr-10 11:29 siat/universal_test.py
 -rw-rw-rw-  2.0 fat    52191 b- defN 23-Jul-13 11:46 siat/valuation_china.py
 -rw-rw-rw-  2.0 fat     1571 b- defN 23-Apr-10 11:29 siat/valuation_market_china_test.py
 -rw-rw-rw-  2.0 fat    14859 b- defN 23-Apr-10 11:29 siat/var_model_validation.py
--rw-rw-rw-  2.0 fat     1422 b- defN 23-Jul-17 05:14 siat-2.4.0.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 23-Jul-17 05:14 siat-2.4.0.dist-info/WHEEL
--rw-rw-rw-  2.0 fat        5 b- defN 23-Jul-17 05:14 siat-2.4.0.dist-info/top_level.txt
-?rw-rw-r--  2.0 fat    10211 b- defN 23-Jul-17 05:14 siat-2.4.0.dist-info/RECORD
-127 files, 7830545 bytes uncompressed, 1703673 bytes compressed:  78.2%
+-rw-rw-rw-  2.0 fat     1422 b- defN 23-Jul-17 17:34 siat-2.4.1.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 23-Jul-17 17:34 siat-2.4.1.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat        5 b- defN 23-Jul-17 17:33 siat-2.4.1.dist-info/top_level.txt
+?rw-rw-r--  2.0 fat    10211 b- defN 23-Jul-17 17:34 siat-2.4.1.dist-info/RECORD
+127 files, 7841281 bytes uncompressed, 1705197 bytes compressed:  78.3%
```

## zipnote {}

```diff
@@ -363,20 +363,20 @@
 
 Filename: siat/valuation_market_china_test.py
 Comment: 
 
 Filename: siat/var_model_validation.py
 Comment: 
 
-Filename: siat-2.4.0.dist-info/METADATA
+Filename: siat-2.4.1.dist-info/METADATA
 Comment: 
 
-Filename: siat-2.4.0.dist-info/WHEEL
+Filename: siat-2.4.1.dist-info/WHEEL
 Comment: 
 
-Filename: siat-2.4.0.dist-info/top_level.txt
+Filename: siat-2.4.1.dist-info/top_level.txt
 Comment: 
 
-Filename: siat-2.4.0.dist-info/RECORD
+Filename: siat-2.4.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## siat/capm_beta.py

```diff
@@ -302,15 +302,18 @@
             print("  #Error(capm_beta_yearly): no data for regression")
             print("  Information:",stkcd,year,R,r)
             return             
         (beta,alpha,r_value,p_value,std_err)=output
         
         row=pd.Series({'Year':year,'Beta':beta,'alpha':alpha, \
                        'R-sqr':r_value**2,'p-value':p_value})
-        betas=betas.append(row,ignore_index=True)          
+        try:
+            betas=betas.append(row,ignore_index=True)
+        except:
+            betas=betas._append(row,ignore_index=True)
         #print(year,round(beta,4),round(r_value**2,3),round(p_value,4))
     
     #设置打印标题与数据对齐
     pd.set_option('display.unicode.ambiguous_as_wide', True)
     pd.set_option('display.unicode.east_asian_width', True)
     pd.set_option('display.width', 180) # 设置打印宽度(**重要**)
     
@@ -470,15 +473,18 @@
             print("  #Error(capm_beta_portfolio_yearly): no data for regression")
             print("  Information:",year,R,r)
             return         
         (beta,alpha,r_value,p_value,std_err)=output
         
         row=pd.Series({'Year':year,'Beta':beta,'intercept':alpha, \
                        'R-sqr':r_value**2,'p-value':p_value})
-        betas=betas.append(row,ignore_index=True)          
+        try:
+            betas=betas.append(row,ignore_index=True)
+        except:
+            betas=betas._append(row,ignore_index=True)
         
     print("\n",betas)
     betas.set_index('Year',inplace=True)
     
     #绘图：年度贝塔系数变化
     df=pd.DataFrame(betas['Beta'])
     title="投资组合的年度贝塔系数"+ \
@@ -542,15 +548,18 @@
             print("  #Error(capm_beta_portfolio_yearly_excel): no data available for regressing beta")
             print("  Information:",year,R,r)
             return         
         (beta,alpha,r_value,p_value,std_err)=output
         
         row=pd.Series({'Year':year,'Beta':beta,'intercept':alpha, \
                        'R-sqr':r_value**2,'p-value':p_value})
-        betas=betas.append(row,ignore_index=True)          
+        try:
+            betas=betas.append(row,ignore_index=True)
+        except:
+            betas=betas._append(row,ignore_index=True)
         
     betas2=betas.copy() #用于保存excel   
     betas2['Year']=betas2['Year'].astype('int')
     betas2['Portfolio']=str(tickerlist)
     betas2['Share Ratio']=str(sharelist)
     betas2['Market Index']=mktidx
     
@@ -680,15 +689,18 @@
             print("  #Error(compare2_betas_yearly): no data for regression")
             print("  Information:",stkcd1,year,r,R1)
             continue         
         (beta,alpha,r_value,p_value,std_err)=output
         
         row=pd.Series({'Year':year,'Beta':beta,'alpha':alpha, \
                        'R-sqr':r_value**2,'p-value':p_value})
-        betas1=betas1.append(row,ignore_index=True)   
+        try:
+            betas1=betas1.append(row,ignore_index=True)   
+        except:
+            betas1=betas1._append(row,ignore_index=True)
         #print("  Calculated CAPM beta of",stkcd1,'on year',year)
         
     betas1.set_index('Year',inplace=True)
 
     betas2=pd.DataFrame(columns=('Year','Beta','alpha','R-sqr','p-value'))
     for year in yearlist:
         #print(year,' ',end='')
@@ -699,15 +711,18 @@
         except:
             print("  #Error(compare2_betas_yearly): no data for regression")
             print("  Information:",stkcd2,year,r,R2)
             continue         
         (beta,alpha,r_value,p_value,std_err)=output        
         row=pd.Series({'Year':year,'Beta':beta,'alpha':alpha, \
                        'R-sqr':r_value**2,'p-value':p_value})
-        betas2=betas2.append(row,ignore_index=True)      
+        try:
+            betas2=betas2.append(row,ignore_index=True)
+        except:
+            betas2=betas2._append(row,ignore_index=True)
         #print("  Calculated CAPM beta of",stkcd2,'on year',year)
         
     betas2.set_index('Year',inplace=True)
     
     #绘图：年度贝塔系数变化
     plt.plot(betas1['Beta'],label=codetranslate(stkcd1),c='red',marker='o',lw=1)
     plt.plot(betas2['Beta'],label=codetranslate(stkcd2),c='blue',marker='D',lw=2,linestyle='--')
```

## siat/common.py

```diff
@@ -1675,72 +1675,73 @@
 
 if __name__=='__main__':
     tickers=['NIO','LI','XPEV','TSLA']
     df=compare_mrar(tickers,
                     rar_name='sharpe',
                     start='2022-1-1',end='2023-1-31',
                     market='US',market_index='^GSPC',
-                    window=240,axhline_label='指标零线')    
+                    window=240,axhline_label='零线')    
     titletxt="This is the title text"
     footnote="This is the footnote"
 
 def descriptive_statistics(df,titletxt,footnote,decimals=4,sortby='tpw_mean', \
-                           recommend_only=False,trailing=20):
+                           recommend_only=False,trailing=20,trend_threshhold=0.01):
     """
     功能：进行描述性统计，并打印结果
     df的要求：
     索引列为datetime格式，不带时区
     各个列为比较对象，均为数值型，降序排列
     
     sortby='tpw_mean'：按照近期时间优先加权(time priority weighted)平均数排序
     recommend_only=False：是否仅打印推荐的证券
     """
     
     # 检查df
     if df is None:
         print("  #Error(descriptive_statistics): df is None")
         return
-    
     if len(df) == 0:
         print("  #Error(descriptive_statistics): df is empty")
         return
     
     # 计算短期趋势
     df20=df[-trailing:]
+    """
     df20ds=df20.describe()
     df20mean=df20ds[df20ds.index=='mean'].T
     
     df20tail=df20.tail(1).T
     df20tail.columns=['last']
     
     import pandas as pd
     df20trailing=pd.merge(df20tail,df20mean,left_index=True,right_index=True)
     df20trailing['trailing']=df20trailing['last']-df20trailing['mean']
-    
+    """
     ds=df.describe(include='all',percentiles=[.5])
     dst=ds.T   
-    #cols=['min','max','50%','mean','std']
-    cols=['min','max','50%','mean','trailing']
+    cols=['min','max','50%','mean','std']
+    #cols=['min','max','50%','mean','trailing']
     
     dst['item']=dst.index
-    dstt=pd.merge(dst,df20trailing['trailing'],left_index=True,right_index=True)
-    #cols2=['item','min','max','50%','mean','std']
-    cols2=['item','min','max','50%','mean','trailing']
+    #dstt=pd.merge(dst,df20trailing['trailing'],left_index=True,right_index=True)
+    cols2=['item','min','max','50%','mean','std']
+    #cols2=['item','min','max','50%','mean','trailing']
     
-    dst2=dstt[cols2]
+    #dst2=dstt[cols2]
+    dst2=dst[cols2]
     for c in cols:
         dst2[c]=dst2[c].apply(lambda x: round(x,decimals))
     
     if sortby != 'tpw_mean': 
         if sortby=='median':
             sortby='50%'
         dst2.sort_values(by=sortby,ascending=False,inplace=True)
 
-    #cols2cn=['比较对象','最小值','最大值','中位数','平均值','标准差']
-    cols2cn=['比较对象','最小值','最大值','中位数','平均值','最新均值差']
+    cols2cn=['比较对象','最小值','最大值','中位数','平均值','标准差']
+    #cols2cn=['比较对象','最小值','最大值','中位数','平均值','最新均值差']
     dst2.columns=cols2cn
     
     # 近期优先加权平均
     dst2['近期优先加权平均']=dst2['比较对象'].apply(lambda x:time_priority_weighted_average(df,x,4))
     if sortby == "tpw_mean":
         dst2.sort_values(by='近期优先加权平均',ascending=False,inplace=True)
     
@@ -1751,26 +1752,29 @@
     dst3=dst3[(dst3['比较对象'] != 'time_weight') & (dst3['比较对象'] != 'relative_weight')]
     
     dst3.reset_index(drop=True,inplace=True)
     dst3.index=dst3.index+1
     
     # 趋势标记
     #dst3['期间趋势']='➠'
-    dst3['期间趋势']='➷'
-    dst3['期间趋势']=dst3.apply(lambda x: '➹' if (x['近期优先加权平均']>x['平均值']) & (x['近期优先加权平均']>x['中位数']) else x['期间趋势'],axis=1)
+    #dst3['期间趋势']='➷'
+    #dst3['期间趋势']=dst3.apply(lambda x: '➹' if (x['近期优先加权平均']>x['平均值']) & (x['近期优先加权平均']>x['中位数']) else x['期间趋势'],axis=1)
     #dst3['期间趋势']=dst3.apply(lambda x: '➷' if (x['近期优先加权平均']<x['平均值']) & (x['近期优先加权平均']<x['中位数']) else x['期间趋势'],axis=1)
+    dst3['期间趋势']=dst3['比较对象'].apply(lambda x:curve_trend_regress(df,x,trend_threshhold))
 
     #dst3['近期趋势']='➠'
-    dst3['近期趋势']='➷'
-    dst3['近期趋势']=dst3.apply(lambda x: '➹' if x['最新均值差'] > 0.0 else x['近期趋势'],axis=1)
+    #dst3['近期趋势']='➷'
+    #dst3['近期趋势']=dst3.apply(lambda x: '➹' if x['最新均值差'] > 0.0 else x['近期趋势'],axis=1)
     #dst3['期间趋势']=dst3.apply(lambda x: '➷' if x['最新均值差'] < 0.0 else x['近期趋势'],axis=1)
+    #dst3['近期趋势']=dst3['比较对象'].apply(lambda x:curve_trend_direct(df20,x,trend_threshhold))
+    dst3['近期趋势']=dst3['比较对象'].apply(lambda x:curve_trend_regress(df20,x,trend_threshhold))
     
     # 推荐标记
     dst3['推荐标记']=''
-
+    """
     if sortby in ['tpw_mean','trailing']: #稳健推荐
         dst3['推荐标记']=dst3.apply(lambda x: '✮' if (x['近期优先加权平均']>0) else x['推荐标记'],axis=1)
         
         dst3['推荐标记']=dst3.apply(lambda x: '✮✮' if (x['中位数']>0) & (x['平均值']>0) & (x['近期优先加权平均']>0) else x['推荐标记'],axis=1)   
         
         maxvalue=dst3['近期优先加权平均'].max()
         dst3['推荐标记']=dst3.apply(lambda x: '✮✮✮' if (x['近期优先加权平均']==maxvalue) & (x['推荐标记']=='✮✮') else x['推荐标记'],axis=1)
@@ -1796,35 +1800,94 @@
         
         dst3['推荐标记']=dst3.apply(lambda x: '✮✮' if (x['平均值']>0) & (x['推荐标记']=='✮') else x['推荐标记'],axis=1)   
         
         maxvalue=dst3['中位数'].max()
         dst3['推荐标记']=dst3.apply(lambda x: '✮✮✮' if (x['中位数']==maxvalue) & (x['推荐标记']=='✮✮') else x['推荐标记'],axis=1)   
     else:
         pass
-
+    """
+    if sortby in ['tpw_mean','trailing']: #稳健推荐
+        dst3['推荐标记']=dst3.apply(lambda x: change_recommend_stars(x['推荐标记'],'+') if (x['近期优先加权平均']>0) else x['推荐标记'],axis=1)
+        
+        dst3['推荐标记']=dst3.apply(lambda x: change_recommend_stars(x['推荐标记'],'+') if (x['中位数']>0) & (x['平均值']>0) & (x['中位数']>x['平均值']) else x['推荐标记'],axis=1)  
+        
+        dst3['推荐标记']=dst3.apply(lambda x: change_recommend_stars(x['推荐标记'],'+') if (x['中位数']>0) & (x['平均值']>0) & (x['近期优先加权平均']>max(x['中位数'],x['平均值'])) else x['推荐标记'],axis=1)
+        """
+        maxvalue=dst3['近期优先加权平均'].max()
+        dst3['推荐标记']=dst3.apply(lambda x: change_recommend_stars(x['推荐标记'],'+') if (x['近期优先加权平均']==maxvalue) else x['推荐标记'],axis=1)
+        """
+    elif sortby == 'min': #保守推荐
+        dst3['推荐标记']=dst3.apply(lambda x: '✮' if (x['近期优先加权平均']>0) else x['推荐标记'],axis=1)
+        
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮' if (x['最小值']>0) else x['推荐标记'],axis=1)   
+        
+        maxvalue=dst3['最小值'].max()
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮✮' if (x['最小值']==maxvalue) & (x['推荐标记']=='✮✮') else x['推荐标记'],axis=1)
+        
+    elif sortby == 'mean': #进取推荐，均值
+        dst3['推荐标记']=dst3.apply(lambda x: '✮' if (x['平均值']>0) else x['推荐标记'],axis=1)
+        
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮' if (x['中位数']>0) & (x['推荐标记']=='✮') else x['推荐标记'],axis=1)   
+        
+        maxvalue=dst3['平均值'].max()
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮✮' if (x['平均值']==maxvalue) & (x['推荐标记']=='✮✮') else x['推荐标记'],axis=1)
+        
+    elif sortby == 'median': #进取推荐，中位数
+        dst3['推荐标记']=dst3.apply(lambda x: '✮' if (x['中位数']>0) else x['推荐标记'],axis=1)
+        
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮' if (x['平均值']>0) & (x['推荐标记']=='✮') else x['推荐标记'],axis=1)   
+        
+        maxvalue=dst3['中位数'].max()
+        dst3['推荐标记']=dst3.apply(lambda x: '✮✮✮' if (x['中位数']==maxvalue) & (x['推荐标记']=='✮✮') else x['推荐标记'],axis=1)   
+    else:
+        pass
+    
+    
     # 下降趋势时，星星个数降一级，执行顺序不可颠倒
     dst4=dst3
-
+    
+    # 减少星星的情形
+    droplist1=['➷','➠']
+    droplist2=['➷']
+    dst4['推荐标记']=dst4.apply(lambda x: change_recommend_stars(x['推荐标记'],'-') if (x['期间趋势'] in droplist1) else x['推荐标记'],axis=1)
+    dst4['推荐标记']=dst4.apply(lambda x: change_recommend_stars(x['推荐标记'],'-') if (x['近期趋势'] in droplist2) else x['推荐标记'],axis=1)
+    """
     # 一颗星颗星-->无星
-    dst4['推荐标记']=dst4.apply(lambda x: '' if (x['推荐标记']=='✮') & (x['近期趋势']=='➷') else x['推荐标记'],axis=1)   
+    dst4['推荐标记']=dst4.apply(lambda x: '' if (x['推荐标记']=='✮') & (x['期间趋势'] in droplist) else x['推荐标记'],axis=1) 
+    dst4['推荐标记']=dst4.apply(lambda x: '' if (x['推荐标记']=='✮') & (x['近期趋势'] in droplist) else x['推荐标记'],axis=1)   
+    
     
     # 两颗星颗星-->一颗星
-    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='✮✮') & (x['近期趋势']=='➷') else x['推荐标记'],axis=1)   
+    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='✮✮') & (x['期间趋势'] in droplist) else x['推荐标记'],axis=1)
+    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='✮✮') & (x['近期趋势'] in droplist) else x['推荐标记'],axis=1)   
     
     # 三颗星-->两颗星✮
     #dst4['推荐标记']=dst4.apply(lambda x: '✮✮✩' if (x['推荐标记']=='✮✮✮') & (x['趋势']=='➷') else x['推荐标记'],axis=1)
-    dst4['推荐标记']=dst4.apply(lambda x: '✮✮' if (x['推荐标记']=='✮✮✮') & (x['近期趋势']=='➷') else x['推荐标记'],axis=1)
+    dst4['推荐标记']=dst4.apply(lambda x: '✮✮' if (x['推荐标记']=='✮✮✮') & (x['期间趋势'] in droplist) else x['推荐标记'],axis=1)
+    dst4['推荐标记']=dst4.apply(lambda x: '✮✮' if (x['推荐标记']=='✮✮✮') & (x['近期趋势'] in droplist) else x['推荐标记'],axis=1)
+    """
     
     # 上升趋势时，星星个数加一级，执行顺序不可颠倒
+    dst4['推荐标记']=dst4.apply(lambda x: change_recommend_stars(x['推荐标记'],'+') if (x['期间趋势']=='➹') & (x['近期趋势']=='➹') else x['推荐标记'],axis=1)
+    
+    """
     # 两颗星颗星-->三颗星
+    dst4['推荐标记']=dst4.apply(lambda x: '✮✮✮' if (x['推荐标记']=='✮✮') & (x['期间趋势']=='➹') else x['推荐标记'],axis=1) 
     dst4['推荐标记']=dst4.apply(lambda x: '✮✮✮' if (x['推荐标记']=='✮✮') & (x['近期趋势']=='➹') else x['推荐标记'],axis=1)   
     
     # 一颗星颗星-->两颗星
+    dst4['推荐标记']=dst4.apply(lambda x: '✮✮' if (x['推荐标记']=='✮') & (x['期间趋势']=='➹') else x['推荐标记'],axis=1) 
     dst4['推荐标记']=dst4.apply(lambda x: '✮✮' if (x['推荐标记']=='✮') & (x['近期趋势']=='➹') else x['推荐标记'],axis=1)   
     
+    # 零颗星-->一颗星
+    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='') & (x['期间趋势']=='➹') & (x['近期趋势']=='➹') else x['推荐标记'],axis=1) 
+    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='') & (x['期间趋势']=='➹') else x['推荐标记'],axis=1) 
+    dst4['推荐标记']=dst4.apply(lambda x: '✮' if (x['推荐标记']=='') & (x['近期趋势']=='➹') else x['推荐标记'],axis=1)  
+    """
+    
     # 重排序：按照星星个数+数值，降序
     dst5=dst4
     if sortby == "tpw_mean":
         dst5.sort_values(by=['推荐标记','近期优先加权平均'],ascending=[False,False],inplace=True)
         #dst5.sort_values(by=['推荐标记','近期优先加权平均'],ascending=False,inplace=True)
     elif sortby == "min":
         dst5.sort_values(by=['推荐标记','最小值'],ascending=[False,False],inplace=True)
@@ -1947,8 +2010,179 @@
     
     # 打印尾注
     if not footnote == '':
         print('\n',footnote)
     
     return
 #==============================================================================
+if __name__=='__main__':
+    df=security_price("600519.SS","2023-1-1","2023-6-30")
+    col='Close'
+    threshhold=0.1
+    curve_trend_regress(df,col,threshhold=0.1)
+    
+    df=security_price("AAPL","2023-1-1","2023-6-30")
+    curve_trend_regress(df,col,threshhold=0.1)    
+    
+    df=security_price("AAPL","2023-1-1","2023-1-10")
+    curve_trend_regress(df,col,threshhold=0.1) 
+
+    
+def curve_trend_regress(df,col,threshhold=0.0001):
+    """
+    功能：回归简单方程y=a+b*x，并判断系数b的显著性星星。目的为判断曲线走势
+    
+    输入项：
+    df: 数据框，假设其索引为日期项，且已升序排列
+    col: 因变量，检查该变量的走势，向上，向下，or 不明显（无显著性星星）
+    
+    返回值：
+    '？'：回归不成功
+    '➠'：回归结果不显著或斜率接近零(其绝对值小于threshhold)
+    '➷'：斜率为负数且其绝对值不小于threshhold且显著
+    '➹'：斜率为正数且其绝对值不小于threshhold且显著
+    """    
+    # 检查df是否为空
+    if df is None:
+        return ' '
+    if len(df)==0:
+        return ' '
+    
+    # 按照索引升序排列，以防万一
+    df1=df.copy()
+    df1.sort_index(ascending=True,inplace=True)
+    df1['id']=range(len(df1))
+    
+    from scipy import stats
+    try:
+        output=stats.linregress(df1['id'],df1[col])
+        (b,a,r_value,p_value,std_err)=output
+    except:
+        # 处理可能的空值
+        df1.fillna(method='ffill',inplace=True)
+        df1.fillna(method='bfill',inplace=True)
+        try:
+            output=stats.linregress(df1['id'],df1[col])
+            (b,a,r_value,p_value,std_err)=output
+        except:
+            return ' '
+    
+    # 生成显著性星星
+    stars=sigstars(p_value)
+    
+    # 判断斜率方向
+    b_abs=abs(b)
+    result='➠'
+    #if b_abs >= threshhold and b > 0 and '*' in stars:
+    if b_abs >= threshhold and b > 0:    
+        result='➹'
+    #if b_abs >= threshhold and b < 0 and '*' in stars:
+    if b_abs >= threshhold and b < 0:    
+        result='➷'
+    
+    return result
+
+def curve_trend_direct(df,col,threshhold=0.0001):
+    """
+    功能：直接对比首尾值大小。目的为判断曲线走势
+    
+    输入项：
+    df: 数据框，假设其索引为日期项，且已升序排列
+    col: 考察变量，检查该变量的走势，向上，向下，or 不明显（无显著性星星）
+    
+    返回值：尾值-首值
+    '➠'：差接近零(其绝对值小于threshhold)
+    '➷'：差为负数且其绝对值不小于threshhold
+    '➹'：差为正数且其绝对值不小于threshhold
+    """    
+    # 检查df是否为空
+    if df is None:
+        return ' '
+    if len(df)==0:
+        return ' '
+    
+    # 按照索引升序排列，以防万一
+    df1=df.copy()
+    df1.sort_index(ascending=True,inplace=True)
+    first_value=df1.head(1)[col].values[0]
+    last_value=df1.tail(1)[col].values[0]
+    diff=last_value - first_value
+    diff_abs=abs(diff)
+    
+    # 判断斜率方向
+    result='➠'
+    if diff_abs >= threshhold and diff > 0:    
+        result='➹'
+    if diff_abs >= threshhold and diff < 0:    
+        result='➷'
+    
+    return result    
+#==============================================================================
+if __name__=='__main__':
+    stars_current=''
+    change_recommend_stars(stars_current,change='+')
+    change_recommend_stars(stars_current,change='-')
+    
+    stars_current='✮'
+    change_recommend_stars(stars_current,change='+')
+    change_recommend_stars(stars_current,change='-')
+    
+    stars_current='✮✮'
+    change_recommend_stars(stars_current,change='+')
+    change_recommend_stars(stars_current,change='-')
+    
+    stars_current='✮✮✮'
+    change_recommend_stars(stars_current,change='+')
+    change_recommend_stars(stars_current,change='-')
+    
+    
+def change_recommend_stars(stars_current,change='+'):
+    """
+    功能：增减推荐的星星个数
+    """   
+    stars0=''
+    stars1='✮'
+    stars2='✮✮'
+    stars3='✮✮✮'
+    
+    # 计算当前的星星个数
+    if stars_current==stars0:
+        num=0
+    elif stars_current==stars1:
+        num=1
+    elif stars_current==stars2:
+        num=2
+    elif stars_current==stars3:
+        num=3
+    else:
+        num=3
+        
+    if change == '+':
+        if stars_current==stars0:
+            stars_new=stars1
+        elif stars_current==stars1:
+            stars_new=stars2
+        elif stars_current==stars2:
+            stars_new=stars3
+        elif stars_current==stars3:
+            stars_new=stars3
+        else:
+            stars_new=stars3
+        
+    if change == '-':
+        if stars_current==stars0:
+            stars_new=stars0
+        elif stars_current==stars1:
+            stars_new=stars0
+        elif stars_current==stars2:
+            stars_new=stars1
+        elif stars_current==stars3:
+            stars_new=stars2
+        else:
+            stars_new=stars2   
+            
+    return stars_new
+    
+
+
+#==============================================================================
```

## siat/risk_adjusted_return.py

```diff
@@ -1178,15 +1178,15 @@
     graph=False
     source='auto'
     trailing=20
 
 def compare_mrar(tickers,rar_name,start,end, \
                  market="China",market_index="000300.SS",RF=False,window=60, \
                  axhline_value=0,axhline_label='零线',graph=True,printout=True, \
-                 sortby='tpw_mean',source='auto',trailing=20):
+                 sortby='tpw_mean',source='auto',trailing=20,trend_threshhold=0.001):
     """
     功能：计算多只股票的rar比率，并绘图对比
     比率：支持夏普比率、特雷诺比率、索替诺比率、阿尔法比率等
     
     sortby: 
         tpw_mean(近期优先加权平均值降序排列)
         min(最小值降序排列)
@@ -1306,17 +1306,18 @@
         elif sortby=='trailing':
             sortby_txt='按推荐标记+短期均值走势降序排列'
         else:
             pass
         
         title_txt='*** '+title_txt+'：'+y_label+'，'+sortby_txt
         additional_note="*** 注：列表仅显示有星号标记或特定数量的证券。"
-        footnote='期间趋势的时间范围：'+start+'至'+end+"；近期趋势的时间范围：近"+str(trailing)+"个交易日"
+        footnote='期间趋势范围：'+start+'至'+end+"；近期趋势范围：近"+str(trailing)+"个交易日"
         descriptive_statistics(df,title_txt,additional_note+footnote,decimals=4, \
-                               sortby=sortby,recommend_only=True,trailing=trailing)
+                               sortby=sortby,recommend_only=True,trailing=trailing, \
+                               trend_threshhold=trend_threshhold)
 
     return df1
 
 if __name__=='__main__':
     tickers = ['000858.SZ','600779.SS','000596.SZ','603589.SS','000001.SS']
     df=compare_mrar(tickers,'sharpe','2022-1-1','2022-10-31')
     df=compare_mrar(tickers,'alpha','2022-10-1','2022-10-31')
```

## siat/stock.py

```diff
@@ -690,14 +690,17 @@
                          graph=True,smooth=False,loc='best', \
                          date_range=False,date_freq=False,annotate=False, \
                          source='auto'):
     """
     功能：单个证券，多个指标对比
     date_range=False：指定开始结束日期绘图
     date_freq=False：指定横轴日期间隔，例如'D'、'2D'、'W'、'M'等，横轴一般不超过25个标注，否则会重叠
+    注意：
+    annotate：这里仅为预留，暂时未作处理
+    smooth：样本数目超过一定数量就默认忽略
     """
     # 提前开始日期
     fromdate1=date_adjust(fromdate,adjust=-365*3)
     
     if isinstance(ticker,list):
         if len(ticker) == 1:
             ticker=ticker[0]
```

## Comparing `siat-2.4.0.dist-info/METADATA` & `siat-2.4.1.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: siat
-Version: 2.4.0
+Version: 2.4.1
 Summary: Securities Investment Analysis Tools (siat)
 Home-page: https://pypi.org/project/siat/
 Author: Prof. WANG Dehong, Business School, BFSU (北京外国语大学 国际商学院 王德宏)
 Author-email: wdehong2000@163.com
 License: Copyright (C) WANG Dehong, 2023. For educational purpose only!
 Requires-Dist: pandas-datareader
 Requires-Dist: yfinance
```

## Comparing `siat-2.4.0.dist-info/RECORD` & `siat-2.4.1.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -8,18 +8,18 @@
 siat/beta_adjustment_china.py,sha256=FX5xdGHiVKo0f03RhWmkz398t5VbkvL8Eyw2xLz5Lvw,20433
 siat/beta_adjustment_test.py,sha256=nBhvQQfqxooCHjy5hL0a8V0ZC58BjuCZVFpqpWpHeF0,2467
 siat/blockchain.py,sha256=awF3GDtlwaJhku0a2kLuXOS8d3IzkjR_RyzlZWvD3L4,6032
 siat/bond.py,sha256=DrspW0zbj1YJm-gMl8jVJF7qNiciSM9sxIBsHk-gyaE,99528
 siat/bond_base.py,sha256=mY1TscUH2kWzsR3Cnh5ea0Xu7-Nc8ZyFupraRipi4BM,24155
 siat/bond_china.py,sha256=ct28F7d6V0m9S3S-t-0lW1ZnSQYSCZhmsCHcZrPZno8,3002
 siat/bond_test.py,sha256=yUOFw7ddGU-kb1rJdnsjkJWziDNgUR7OLDA7F7Ub91A,5246
-siat/capm_beta.py,sha256=L40UbrSU4QQ5CxmEu8CpLT5WptsOUOfDRF7Pxdw6HZs,28499
+siat/capm_beta.py,sha256=gmPHoaXwlUw5yrS7VCtkaDKX3ZLbMV1jxYcLvETj9_w,28922
 siat/capm_beta_test.py,sha256=ImR0c5mc4hIl714XmHztdl7qg8v1E2lycKyiqnFj6qs,1745
 siat/cmat_commons.py,sha256=Nj9Kf0alywaztVoMVeVVL_EZk5jRERJy8R8kBw88_Tg,38116
-siat/common.py,sha256=c6l2qQJ2jTqs78XkKWJHr-aPXj5zLt_PDNLqe8SIow8,66466
+siat/common.py,sha256=z3fKQ-nm7q1HRkwLVYhoczrOhmiAsWSLZtWKXBhmkEg,76574
 siat/compare_cross.py,sha256=XXLLBFz66vkrup50ehyP7jR5IyHUB3zqEJGCzWibVYw,20806
 siat/compare_cross_test.py,sha256=xra5XYmQGEtfIZL2h-GssdH2hLdFIhG3eoCrkDrL3gY,3473
 siat/concepts_iwencai.py,sha256=m1YEDtECRT6FqtzlKm91pt2I9d3Z_XoP59BtWdRdu8I,3061
 siat/concepts_kpl.py,sha256=SJ9UaJp5i79EXKZ3dPa_vBEoG_zgl1Ig5rZAm-ubgM4,4941
 siat/copyrights.py,sha256=YMLjZb328YpFMR-s_GUu0HBgeGce3pV7DgRut8S3I7w,690
 siat/cryptocurrency.py,sha256=SKh_S85cqd2tRgKBKls1Fpd6HdFd9JfmUTCa2e3mpsE,27351
 siat/cryptocurrency_test.py,sha256=3AikTNJ7j-HwLGLIYEfyXZ3bLVuLeru9mwiwHQi2SdA,2669
@@ -74,29 +74,29 @@
 siat/option_china.py,sha256=Drrr1QbyOIMwZRTxOc5508BXZTxsOIU0LHy32smgrSs,95227
 siat/option_china_test.py,sha256=UQ-YUHUjoGBQyanLcM-yzqeEIUQP_gCQIeT0W6rnUnA,16355
 siat/option_pricing.py,sha256=hTz0lD4Yoeq0jK4Kt38qKJC_iOz9a5qXC2OeXgnMmv8,70231
 siat/option_pricing_test.py,sha256=eeorV5Ja5vjlRXnP6fWJHetGU5Vb8SnLopkC6RV3GfA,2203
 siat/option_sina_api_test.py,sha256=dn-k_wrQnAaNKHoROvWJEc7lqlU0bwiV2Aa4usWAFGM,5908
 siat/proxy_test.py,sha256=erQJrmGs2X46z8Gb1h-7GYQ0rTUcaR8dxHExWoBz2eM,2610
 siat/quandl_test.py,sha256=EcPoXnLuqzPl5dKyVEZi3j3PJZFpsnU_iNPhLWC9p-A,1552
-siat/risk_adjusted_return.py,sha256=idKiM0tCE82RO7j2ywx9V_PhEc4L6isJZ8i3dcsBTZU,53746
+siat/risk_adjusted_return.py,sha256=6FRU1C0As732L2ypcgz5VVKTzUr--U0ToZEOKLONPIw,53820
 siat/risk_adjusted_return_test.py,sha256=m_VHL5AtT74cJv5i7taTeTfnkX48y0AFJk5phawyYWg,3416
 siat/risk_evaluation.py,sha256=k5yk4bxKsjxazp-kKfQyrXyFhIHz6fHk3AA4rk2jZXc,75899
 siat/risk_evaluation_test.py,sha256=YEXM96gKzTfwN4U61AS4Rr1tV7KgUvn4rRC6f3iMw9s,3731
 siat/risk_free_rate.py,sha256=X9k-JvEtHkcQxiwCTMtTVz7LHojfAERu7eOzw_hKjsc,12388
 siat/risk_free_rate_test.py,sha256=CpmhUf8aEAEZeNu4gvWP2Mz2dLoIgBX5bI41vfUBEr8,4285
 siat/sector_china.py,sha256=r_Rt63smYYEXxpHJ6mTvi2blO_bZ8yQ11OTi9g2OExY,102148
 siat/sector_china_test.py,sha256=1wq7ef8Bb_L8F0h0W6FvyBrIcBTEbrTV7hljtpj49U4,5843
 siat/security_price.py,sha256=2oHskgiw41KMGfqtnA0i2YjNNV6cYgtlUK0j3YeuXWs,29185
 siat/security_prices.py,sha256=I4pPcKWkWttqvJQgZnLZ94KMkixUPAUMf-E9bzj787A,74707
 siat/security_prices_test.py,sha256=OEphoJ87NPKoNow1QA8EU_5MUYrJF-qKoWKNapVfZNI,10779
 siat/security_trend.py,sha256=P52oIsRsTMam3tSRqGHdK9_bOmDpw3TS6a4LOS569h0,10785
 siat/setup.py,sha256=up65rQGLmTBkhtaMLowjoQXYmIsnycnm4g1SYmeQS6o,1335
 siat/shenwan index history test.py,sha256=JCVAzOSEldHalhSFa3pqD8JI_8_djPMQOxpkuYU-Esg,1418
-siat/stock.py,sha256=BiZBkvHFENjvsvFALetpt52JnkYISKUNf64Ual2nM_o,130944
+siat/stock.py,sha256=ztp3FsXf9_KFhkZli5h6eVM6cXBz8DC2IZa_XjtnWh4,131075
 siat/stock_advice_linear.py,sha256=-twT7IGP-NEplkL1WPSACcNJjggRB2j4mlAQCkzOAuo,31655
 siat/stock_base.py,sha256=uISvbRyOGy8p9QREA96CVydgflBkn5L3OXOGKl8oanc,1312
 siat/stock_china.py,sha256=IInnxq48z-31QINpIaR2I_s0S74FXa7RNbVXng3Dao4,83256
 siat/stock_china_test.py,sha256=eO4HWsSvc6qezl0LndjtL24lViEyrBjH_sx2c2Y2Q2M,1294
 siat/stock_info.pickle,sha256=o4M-pcN8Sh8QiwZQAZWY1aelI4xgIGIxors7n2uHSJI,1266744
 siat/stock_info_test.py,sha256=gfG3DbhDACbtD8wnv_R6zhj0t11XaC8NX8uLD9Qv3Fo,6122
 siat/stock_list_china_test.py,sha256=gv14UwMMvkZqtb6G7DCTSuehIwVHuVwu7w60p6gyHoo,1014
@@ -117,11 +117,11 @@
 siat/translate-20230206.py,sha256=-vtI125WyaJhmPotOpDAmclt_XnYVaWU9ByLWZ6FyYE,118133
 siat/translate-20230215.py,sha256=TJgtPE3n8IjljmZ4Pefy8dmHoNdFF-1zpML6BhA9FKE,121657
 siat/translate.py,sha256=NHaMYaQRfJJ8eTZc_J05vhhlqvZnYqDymZreR95E7OI,134125
 siat/universal_test.py,sha256=CDAOffW1Rvs-TcNN5giWVvHMlch1w4dp-w5SIV9jXL0,3936
 siat/valuation_china.py,sha256=1hLnVfyQiyHdg2ZSIpNtLgvON-HzKxA7Pf7K01J6ThQ,52191
 siat/valuation_market_china_test.py,sha256=gbJ0ioauuo4koTPH6WKUkqcXiQPafnbhU5eKJ6lpdLA,1571
 siat/var_model_validation.py,sha256=zB_Skk_tmzIR15l6oAW3am4HBGVIG-eZ8gJhCdXZ8Qw,14859
-siat-2.4.0.dist-info/METADATA,sha256=VWwisIHMkpuEgSzRZUYBwFq4aBZznwMeOw-QYynUOoU,1422
-siat-2.4.0.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-siat-2.4.0.dist-info/top_level.txt,sha256=r1cVyL7AIKqeAmEJjNR8FMT20OmEzufDstC2gv3NvEY,5
-siat-2.4.0.dist-info/RECORD,,
+siat-2.4.1.dist-info/METADATA,sha256=RDkNZL2C6CStvLmF3gvAMiaoKENtwg-Szv-94upQkNE,1422
+siat-2.4.1.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+siat-2.4.1.dist-info/top_level.txt,sha256=r1cVyL7AIKqeAmEJjNR8FMT20OmEzufDstC2gv3NvEY,5
+siat-2.4.1.dist-info/RECORD,,
```

