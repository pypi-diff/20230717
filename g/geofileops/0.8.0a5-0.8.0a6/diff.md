# Comparing `tmp/geofileops-0.8.0a5.tar.gz` & `tmp/geofileops-0.8.0a6.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "geofileops-0.8.0a5.tar", last modified: Thu May 11 10:19:31 2023, max compression
+gzip compressed data, was "geofileops-0.8.0a6.tar", last modified: Mon Jul 17 15:58:49 2023, max compression
```

## Comparing `geofileops-0.8.0a5.tar` & `geofileops-0.8.0a6.tar`

### file list

```diff
@@ -1,93 +1,93 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.817957 geofileops-0.8.0a5/
--rw-r--r--   0 runner    (1001) docker     (123)     1529 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)      277 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)     3106 2023-05-11 10:19:31.817957 geofileops-0.8.0a5/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     2664 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.805957 geofileops-0.8.0a5/benchmark/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)       80 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmark_all.py
--rw-r--r--   0 runner    (1001) docker     (123)      294 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmark_geofileops.py
--rw-r--r--   0 runner    (1001) docker     (123)     5158 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmarker.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.805957 geofileops-0.8.0a5/benchmark/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    11083 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmarks/benchmarks_geofileops.py
--rw-r--r--   0 runner    (1001) docker     (123)     5236 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/benchmarks/testdata.py
--rw-r--r--   0 runner    (1001) docker     (123)     9213 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/benchmark/reporter.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.805957 geofileops-0.8.0a5/geofileops/
--rw-r--r--   0 runner    (1001) docker     (123)      668 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)       78 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/_compat.py
--rw-r--r--   0 runner    (1001) docker     (123)    84479 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/fileops.py
--rw-r--r--   0 runner    (1001) docker     (123)    96065 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/geoops.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.809957 geofileops-0.8.0a5/geofileops/helpers/
--rw-r--r--   0 runner    (1001) docker     (123)      110 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/helpers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     3834 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/helpers/_parameter_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)     7834 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/helpers/layerstyles.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.809957 geofileops-0.8.0a5/geofileops/util/
--rw-r--r--   0 runner    (1001) docker     (123)      119 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5529 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_general_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    72763 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_geoops_gpd.py
--rw-r--r--   0 runner    (1001) docker     (123)     5224 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_geoops_ogr.py
--rw-r--r--   0 runner    (1001) docker     (123)   107339 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_geoops_sql.py
--rw-r--r--   0 runner    (1001) docker     (123)     4487 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_io_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     7761 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_ogr_sql_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    18218 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_ogr_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     4882 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_processing_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    22065 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/_sqlite_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     1052 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/geodataframe_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     4699 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/geofiletype.py
--rw-r--r--   0 runner    (1001) docker     (123)      628 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/geofiletypes.csv
--rw-r--r--   0 runner    (1001) docker     (123)    30024 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/geometry_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    12178 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/geoseries_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     8013 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/grid_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/util/test.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)        7 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/geofileops/version.txt
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.809957 geofileops-0.8.0a5/geofileops.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     3106 2023-05-11 10:19:31.000000 geofileops-0.8.0a5/geofileops.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     2456 2023-05-11 10:19:31.000000 geofileops-0.8.0a5/geofileops.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-11 10:19:31.000000 geofileops-0.8.0a5/geofileops.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)      117 2023-05-11 10:19:31.000000 geofileops-0.8.0a5/geofileops.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)       27 2023-05-11 10:19:31.000000 geofileops-0.8.0a5/geofileops.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       96 2023-05-11 10:19:31.817957 geofileops-0.8.0a5/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     1043 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.813957 geofileops-0.8.0a5/tests/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-11 10:19:31.817957 geofileops-0.8.0a5/tests/data/
--rw-r--r--   0 runner    (1001) docker     (123)   114688 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/BEFL-kbl.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    17534 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/geofileops_testdata.qgz
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/linestring-row-trees.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   765952 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/linestring-watercourse.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/linestrings_hedges.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   106496 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/point.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   139264 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-invalid.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-no-rows.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-all.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-one.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-two+three.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   122880 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-parcel.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   126976 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-simplify-onborder-testcase.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)   143360 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-twolayers.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygon-zone.gpkg
--rw-r--r--   0 runner    (1001) docker     (123)    19428 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygonstyle.qml
--rw-r--r--   0 runner    (1001) docker     (123)     1631 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/data/polygonstyle.sld
--rw-r--r--   0 runner    (1001) docker     (123)     1111 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_general_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    48459 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofile.py
--rw-r--r--   0 runner    (1001) docker     (123)    18119 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofileops_singlelayer.py
--rw-r--r--   0 runner    (1001) docker     (123)    38315 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofileops_singlelayer_gpd.py
--rw-r--r--   0 runner    (1001) docker     (123)     4344 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofileops_singlelayer_ogr.py
--rw-r--r--   0 runner    (1001) docker     (123)    16715 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofileops_singlelayer_sql.py
--rw-r--r--   0 runner    (1001) docker     (123)    40218 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofileops_twolayers.py
--rw-r--r--   0 runner    (1001) docker     (123)     1650 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geofiletype.py
--rw-r--r--   0 runner    (1001) docker     (123)    25181 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geometry_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    11797 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_geoseries_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     1196 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_grid_util.py
--rw-r--r--   0 runner    (1001) docker     (123)    10165 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)     1564 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_io_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     1948 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_layerstyles.py
--rw-r--r--   0 runner    (1001) docker     (123)     4266 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_ogr_sql_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     3874 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_ogr_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     2542 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_parameter_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)     1439 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_processing_util.py
--rw-r--r--   0 runner    (1001) docker     (123)     1096 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_spatialite.py
--rw-r--r--   0 runner    (1001) docker     (123)     4497 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_sqlite_util.py
--rw-r--r--   0 runner    (1001) docker     (123)      331 2023-05-11 10:19:19.000000 geofileops-0.8.0a5/tests/test_version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:49.010527 geofileops-0.8.0a6/
+-rw-r--r--   0 runner    (1001) docker     (123)     1529 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      277 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)     3106 2023-07-17 15:58:49.010527 geofileops-0.8.0a6/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     2664 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.982526 geofileops-0.8.0a6/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)       80 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmark_all.py
+-rw-r--r--   0 runner    (1001) docker     (123)      294 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmark_geofileops.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5158 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmarker.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.982526 geofileops-0.8.0a6/benchmark/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11083 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmarks/benchmarks_geofileops.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5219 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/benchmarks/testdata.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9213 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/benchmark/reporter.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.986526 geofileops-0.8.0a6/geofileops/
+-rw-r--r--   0 runner    (1001) docker     (123)      668 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)       78 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/_compat.py
+-rw-r--r--   0 runner    (1001) docker     (123)    88295 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/fileops.py
+-rw-r--r--   0 runner    (1001) docker     (123)   109339 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/geoops.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.986526 geofileops-0.8.0a6/geofileops/helpers/
+-rw-r--r--   0 runner    (1001) docker     (123)      110 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/helpers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3834 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/helpers/_parameter_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7834 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/helpers/layerstyles.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.994526 geofileops-0.8.0a6/geofileops/util/
+-rw-r--r--   0 runner    (1001) docker     (123)      119 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5529 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_general_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    80582 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_geoops_gpd.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5224 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_geoops_ogr.py
+-rw-r--r--   0 runner    (1001) docker     (123)   116767 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_geoops_sql.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4487 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_io_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7761 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_ogr_sql_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20626 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_ogr_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4882 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_processing_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22585 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/_sqlite_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1052 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/geodataframe_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4699 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/geofiletype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      628 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/geofiletypes.csv
+-rw-r--r--   0 runner    (1001) docker     (123)    30857 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/geometry_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12178 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/geoseries_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8013 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/grid_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/util/test.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)        7 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/geofileops/version.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:48.986526 geofileops-0.8.0a6/geofileops.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     3106 2023-07-17 15:58:48.000000 geofileops-0.8.0a6/geofileops.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     2456 2023-07-17 15:58:48.000000 geofileops-0.8.0a6/geofileops.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-07-17 15:58:48.000000 geofileops-0.8.0a6/geofileops.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      117 2023-07-17 15:58:48.000000 geofileops-0.8.0a6/geofileops.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       27 2023-07-17 15:58:48.000000 geofileops-0.8.0a6/geofileops.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       47 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       96 2023-07-17 15:58:49.010527 geofileops-0.8.0a6/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     1043 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:49.002526 geofileops-0.8.0a6/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-07-17 15:58:49.010527 geofileops-0.8.0a6/tests/data/
+-rw-r--r--   0 runner    (1001) docker     (123)   114688 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/BEFL-kbl.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    17534 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/geofileops_testdata.qgz
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/linestring-row-trees.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   765952 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/linestring-watercourse.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/linestrings_hedges.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   106496 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/point.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   139264 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-invalid.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-no-rows.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-all.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-one.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-two+three.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   122880 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-parcel.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   126976 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-simplify-onborder-testcase.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)   143360 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-twolayers.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    98304 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygon-zone.gpkg
+-rw-r--r--   0 runner    (1001) docker     (123)    19428 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygonstyle.qml
+-rw-r--r--   0 runner    (1001) docker     (123)     1631 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/data/polygonstyle.sld
+-rw-r--r--   0 runner    (1001) docker     (123)     1111 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_general_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    48719 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofile.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21904 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofileops_singlelayer.py
+-rw-r--r--   0 runner    (1001) docker     (123)    44181 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofileops_singlelayer_gpd.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4165 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofileops_singlelayer_ogr.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19139 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofileops_singlelayer_sql.py
+-rw-r--r--   0 runner    (1001) docker     (123)    47125 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofileops_twolayers.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1521 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geofiletype.py
+-rw-r--r--   0 runner    (1001) docker     (123)    27930 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geometry_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11588 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_geoseries_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1041 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_grid_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12779 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1564 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_io_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1948 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_layerstyles.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4112 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_ogr_sql_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4917 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_ogr_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2543 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_parameter_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1439 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_processing_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)      942 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_spatialite.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4507 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_sqlite_util.py
+-rw-r--r--   0 runner    (1001) docker     (123)      176 2023-07-17 15:58:37.000000 geofileops-0.8.0a6/tests/test_version.py
```

### Comparing `geofileops-0.8.0a5/LICENSE.txt` & `geofileops-0.8.0a6/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/PKG-INFO` & `geofileops-0.8.0a6/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: geofileops
-Version: 0.8.0a5
+Version: 0.8.0a6
 Summary: Package to do spatial operations on large geo files.
 Home-page: https://github.com/geofileops/geofileops
 Author: Pieter Roggemans
 Author-email: pieter.roggemans@gmail.com
 Classifier: Programming Language :: Python :: 3
 Classifier: Operating System :: OS Independent
 Requires-Python: >=3.8
```

### Comparing `geofileops-0.8.0a5/README.md` & `geofileops-0.8.0a6/README.md`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/benchmark/benchmarker.py` & `geofileops-0.8.0a6/benchmark/benchmarker.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/benchmark/benchmarks/benchmarks_geofileops.py` & `geofileops-0.8.0a6/benchmark/benchmarks/benchmarks_geofileops.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/benchmark/benchmarks/testdata.py` & `geofileops-0.8.0a6/benchmark/benchmarks/testdata.py`

 * *Files 5% similar despite different names*

```diff
@@ -133,16 +133,15 @@
 
             if dst_path.suffix == tmp_path.suffix:
                 gfo.move(tmp_path, dst_path)
             else:
                 logger.info(f"Convert tmp file to {dst_path}")
                 gfo.makevalid(tmp_path, dst_path)
         finally:
-            if tmp_dir.exists():
-                shutil.rmtree(tmp_dir)
+            shutil.rmtree(tmp_dir, ignore_errors=True)
 
     return dst_path
 
 
 def prepare_dst_path(dst_name: str, dst_dir: Optional[Path] = None):
     if dst_dir is None:
         return Path(tempfile.gettempdir()) / "geofileops_sampledata" / dst_name
```

### Comparing `geofileops-0.8.0a5/benchmark/reporter.py` & `geofileops-0.8.0a6/benchmark/reporter.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/__init__.py` & `geofileops-0.8.0a6/geofileops/__init__.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/fileops.py` & `geofileops-0.8.0a6/geofileops/fileops.py`

 * *Files 1% similar despite different names*

```diff
@@ -284,4997 +284,5236 @@
 000011b0: 7773 2920 696e 2074 6865 206c 6179 6572  ws) in the layer
 000011c0: 2e0a 2020 2020 2020 2020 746f 7461 6c5f  ..        total_
 000011d0: 626f 756e 6473 2028 5475 706c 655b 666c  bounds (Tuple[fl
 000011e0: 6f61 742c 2066 6c6f 6174 2c20 666c 6f61  oat, float, floa
 000011f0: 742c 2066 6c6f 6174 5d29 3a20 7468 6520  t, float]): the 
 00001200: 626f 756e 6469 6e67 2062 6f78 206f 660a  bounding box of.
 00001210: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00001220: 6c61 7965 722e 0a20 2020 2020 2020 2067  layer..        g
-00001230: 656f 6d65 7472 7963 6f6c 756d 6e20 2873  eometrycolumn (s
-00001240: 7472 293a 206e 616d 6520 6f66 2074 6865  tr): name of the
-00001250: 2063 6f6c 756d 6e20 7468 6174 2063 6f6e   column that con
-00001260: 7461 696e 7320 7468 650a 2020 2020 2020  tains the.      
-00001270: 2020 2020 2020 7072 696d 6172 7920 6765        primary ge
-00001280: 6f6d 6574 7279 2e0a 2020 2020 2020 2020  ometry..        
-00001290: 6765 6f6d 6574 7279 7479 7065 6e61 6d65  geometrytypename
-000012a0: 2028 7374 7229 3a20 7468 6520 6765 6f6d   (str): the geom
-000012b0: 6574 7279 2074 7970 6520 6e61 6d65 206f  etry type name o
-000012c0: 6620 7468 6520 6765 6f6d 6574 7279 636f  f the geometryco
-000012d0: 6c75 6d6e 2e0a 2020 2020 2020 2020 2020  lumn..          
-000012e0: 2020 5468 6520 7479 7065 206e 616d 6520    The type name 
-000012f0: 7265 7475 726e 6564 2069 7320 6f6e 6520  returned is one 
-00001300: 6f66 2074 6865 2066 6f6c 6c6f 7769 6e67  of the following
-00001310: 3a20 504f 494e 542c 204d 554c 5449 504f  : POINT, MULTIPO
-00001320: 494e 542c 0a20 2020 2020 2020 2020 2020  INT,.           
-00001330: 204c 494e 4553 5452 494e 472c 204d 554c   LINESTRING, MUL
-00001340: 5449 4c49 4e45 5354 5249 4e47 2c20 504f  TILINESTRING, PO
-00001350: 4c59 474f 4e2c 204d 554c 5449 504f 4c59  LYGON, MULTIPOLY
-00001360: 474f 4e2c 2043 4f4c 4c45 4354 494f 4e2e  GON, COLLECTION.
-00001370: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
-00001380: 7974 7970 6520 2847 656f 6d65 7472 7954  ytype (GeometryT
-00001390: 7970 6529 3a20 7468 6520 6765 6f6d 6574  ype): the geomet
-000013a0: 7279 2074 7970 6520 6f66 2074 6865 2067  ry type of the g
-000013b0: 656f 6d65 7472 7963 6f6c 756d 6e2e 0a20  eometrycolumn.. 
-000013c0: 2020 2020 2020 2063 6f6c 756d 6e73 2028         columns (
-000013d0: 6469 6374 293a 2074 6865 2063 6f6c 756d  dict): the colum
-000013e0: 6e73 2028 6f74 6865 7220 7468 616e 2074  ns (other than t
-000013f0: 6865 2067 656f 6d65 7472 7920 636f 6c75  he geometry colu
-00001400: 6d6e 2920 7468 6174 0a20 2020 2020 2020  mn) that.       
-00001410: 2020 2020 2061 7265 2061 7661 696c 6162       are availab
-00001420: 6c65 206f 6e20 7468 6520 6c61 7965 7220  le on the layer 
-00001430: 7769 7468 2074 6865 6972 2070 726f 7065  with their prope
-00001440: 7274 6965 7320 6173 2061 2064 6963 742e  rties as a dict.
-00001450: 0a20 2020 2020 2020 2066 6964 5f63 6f6c  .        fid_col
-00001460: 756d 6e20 2873 7472 293a 2063 6f6c 756d  umn (str): colum
-00001470: 6e20 6e61 6d65 206f 6620 7468 6520 4649  n name of the FI
-00001480: 4420 636f 6c75 6d6e 2e20 4973 2022 2220  D column. Is "" 
-00001490: 666f 7220 6669 6c65 2074 7970 6573 2074  for file types t
-000014a0: 6861 7420 646f 6e27 740a 2020 2020 2020  hat don't.      
-000014b0: 2020 2020 2020 6578 706c 6963 6974 6c79        explicitly
-000014c0: 2073 746f 7265 2061 6e20 4649 442c 206c   store an FID, l
-000014d0: 696b 6520 7368 6170 6566 696c 652e 0a20  ike shapefile.. 
-000014e0: 2020 2020 2020 2063 7273 2028 7079 7072         crs (pypr
-000014f0: 6f6a 2e43 5253 293a 2074 6865 2073 7061  oj.CRS): the spa
-00001500: 7469 616c 2072 6566 6572 656e 6365 206f  tial reference o
-00001510: 6620 7468 6520 6c61 7965 722e 0a20 2020  f the layer..   
-00001520: 2020 2020 2065 7272 6f72 7320 284c 6973       errors (Lis
-00001530: 745b 7374 725d 293a 206c 6973 7420 6f66  t[str]): list of
-00001540: 2065 7272 6f72 7320 696e 2074 6865 206c   errors in the l
-00001550: 6179 6572 2c20 6567 2e20 696e 7661 6c69  ayer, eg. invali
-00001560: 6420 636f 6c75 6d6e 0a20 2020 2020 2020  d column.       
-00001570: 2020 2020 206e 616d 6573 2c2e 2e2e 0a20       names,.... 
-00001580: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-00001590: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-000015a0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000015b0: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
-000015c0: 2020 2066 6561 7475 7265 636f 756e 743a     featurecount:
-000015d0: 2069 6e74 2c0a 2020 2020 2020 2020 746f   int,.        to
-000015e0: 7461 6c5f 626f 756e 6473 3a20 5475 706c  tal_bounds: Tupl
-000015f0: 655b 666c 6f61 742c 2066 6c6f 6174 2c20  e[float, float, 
-00001600: 666c 6f61 742c 2066 6c6f 6174 5d2c 0a20  float, float],. 
-00001610: 2020 2020 2020 2067 656f 6d65 7472 7963         geometryc
-00001620: 6f6c 756d 6e3a 2073 7472 2c0a 2020 2020  olumn: str,.    
-00001630: 2020 2020 6765 6f6d 6574 7279 7479 7065      geometrytype
-00001640: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
-00001650: 2020 2067 656f 6d65 7472 7974 7970 653a     geometrytype:
-00001660: 2047 656f 6d65 7472 7954 7970 652c 0a20   GeometryType,. 
-00001670: 2020 2020 2020 2063 6f6c 756d 6e73 3a20         columns: 
-00001680: 4469 6374 5b73 7472 2c20 436f 6c75 6d6e  Dict[str, Column
-00001690: 496e 666f 5d2c 0a20 2020 2020 2020 2066  Info],.        f
-000016a0: 6964 5f63 6f6c 756d 6e3a 2073 7472 2c0a  id_column: str,.
-000016b0: 2020 2020 2020 2020 6372 733a 204f 7074          crs: Opt
-000016c0: 696f 6e61 6c5b 7079 7072 6f6a 2e43 5253  ional[pyproj.CRS
-000016d0: 5d2c 0a20 2020 2020 2020 2065 7272 6f72  ],.        error
-000016e0: 733a 204c 6973 745b 7374 725d 2c0a 2020  s: List[str],.  
-000016f0: 2020 293a 0a20 2020 2020 2020 2073 656c    ):.        sel
-00001700: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
-00001710: 2020 2020 2020 7365 6c66 2e66 6561 7475        self.featu
-00001720: 7265 636f 756e 7420 3d20 6665 6174 7572  recount = featur
-00001730: 6563 6f75 6e74 0a20 2020 2020 2020 2073  ecount.        s
-00001740: 656c 662e 746f 7461 6c5f 626f 756e 6473  elf.total_bounds
-00001750: 203d 2074 6f74 616c 5f62 6f75 6e64 730a   = total_bounds.
-00001760: 2020 2020 2020 2020 7365 6c66 2e67 656f          self.geo
-00001770: 6d65 7472 7963 6f6c 756d 6e20 3d20 6765  metrycolumn = ge
-00001780: 6f6d 6574 7279 636f 6c75 6d6e 0a20 2020  ometrycolumn.   
-00001790: 2020 2020 2073 656c 662e 6765 6f6d 6574       self.geomet
-000017a0: 7279 7479 7065 6e61 6d65 203d 2067 656f  rytypename = geo
-000017b0: 6d65 7472 7974 7970 656e 616d 650a 2020  metrytypename.  
-000017c0: 2020 2020 2020 7365 6c66 2e67 656f 6d65        self.geome
-000017d0: 7472 7974 7970 6520 3d20 6765 6f6d 6574  trytype = geomet
-000017e0: 7279 7479 7065 0a20 2020 2020 2020 2073  rytype.        s
-000017f0: 656c 662e 636f 6c75 6d6e 7320 3d20 636f  elf.columns = co
-00001800: 6c75 6d6e 730a 2020 2020 2020 2020 7365  lumns.        se
-00001810: 6c66 2e66 6964 5f63 6f6c 756d 6e20 3d20  lf.fid_column = 
-00001820: 6669 645f 636f 6c75 6d6e 0a20 2020 2020  fid_column.     
-00001830: 2020 2073 656c 662e 6372 7320 3d20 6372     self.crs = cr
-00001840: 730a 2020 2020 2020 2020 7365 6c66 2e65  s.        self.e
-00001850: 7272 6f72 7320 3d20 6572 726f 7273 0a0a  rrors = errors..
-00001860: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-00001870: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00001880: 7265 7475 726e 2066 227b 7365 6c66 2e5f  return f"{self._
-00001890: 5f63 6c61 7373 5f5f 7d28 7b73 656c 662e  _class__}({self.
-000018a0: 5f5f 6469 6374 5f5f 7d29 220a 0a0a 6465  __dict__})"...de
-000018b0: 6620 6765 745f 6c61 7965 725f 6765 6f6d  f get_layer_geom
-000018c0: 6574 7279 7479 7065 7328 0a20 2020 2070  etrytypes(.    p
-000018d0: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
-000018e0: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
-000018f0: 5d22 5d2c 206c 6179 6572 3a20 4f70 7469  ]"], layer: Opti
-00001900: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00001910: 0a29 202d 3e20 4c69 7374 5b73 7472 5d3a  .) -> List[str]:
-00001920: 0a20 2020 2022 2222 0a20 2020 2047 6574  .    """.    Get
-00001930: 2074 6865 2067 656f 6d65 7472 7920 7479   the geometry ty
-00001940: 7065 7320 696e 2074 6865 206c 6179 6572  pes in the layer
-00001950: 2062 7920 6578 616d 696e 696e 6720 6561   by examining ea
-00001960: 6368 2067 656f 6d65 7472 7920 696e 2074  ch geometry in t
-00001970: 6865 206c 6179 6572 2e0a 0a20 2020 2054  he layer...    T
-00001980: 6865 2067 656e 6572 616c 2067 656f 6d65  he general geome
-00001990: 7472 7920 7479 7065 206f 6620 7468 6520  try type of the 
-000019a0: 6c61 7965 7220 6361 6e20 6265 2064 6574  layer can be det
-000019b0: 6572 6d69 6e65 6420 7573 696e 670a 2020  ermined using.  
-000019c0: 2020 3a6d 6574 683a 607e 6765 745f 6c61    :meth:`~get_la
-000019d0: 7965 7269 6e66 6f60 2e0a 0a20 2020 2041  yerinfo`...    A
-000019e0: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-000019f0: 6820 2850 6174 684c 696b 6529 3a20 7061  h (PathLike): pa
-00001a00: 7468 2074 6f20 7468 6520 6669 6c65 2074  th to the file t
-00001a10: 6f20 6765 7420 696e 666f 2061 626f 7574  o get info about
-00001a20: 0a20 2020 2020 2020 206c 6179 6572 2028  .        layer (
-00001a30: 7374 7229 3a20 7468 6520 6c61 7965 7220  str): the layer 
-00001a40: 796f 7520 7761 6e74 2069 6e66 6f20 6162  you want info ab
-00001a50: 6f75 742e 2044 6f65 736e 2774 206e 6565  out. Doesn't nee
-00001a60: 6420 746f 2062 650a 2020 2020 2020 2020  d to be.        
-00001a70: 2020 2020 7370 6563 6966 6965 6420 6966      specified if
-00001a80: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
-00001a90: 6e65 206c 6179 6572 2069 6e20 7468 6520  ne layer in the 
-00001aa0: 6765 6f66 696c 652e 0a0a 2020 2020 5265  geofile...    Re
-00001ab0: 7475 726e 733a 0a20 2020 2020 2020 204c  turns:.        L
-00001ac0: 6973 745b 7374 725d 3a20 7468 6520 6765  ist[str]: the ge
-00001ad0: 6f6d 6574 7279 2074 7970 6573 2069 6e20  ometry types in 
-00001ae0: 7468 6520 6c61 7965 722e 0a20 2020 2022  the layer..    "
-00001af0: 2222 0a20 2020 2073 716c 5f73 746d 7420  "".    sql_stmt 
-00001b00: 3d20 2222 220a 2020 2020 2020 2020 5345  = """.        SE
-00001b10: 4c45 4354 2044 4953 5449 4e43 540a 2020  LECT DISTINCT.  
-00001b20: 2020 2020 2020 2020 2020 2020 2043 4153               CAS
-00001b30: 450a 2020 2020 2020 2020 2020 2020 2020  E.              
-00001b40: 2020 2057 4845 4e20 4361 7374 546f 5369     WHEN CastToSi
-00001b50: 6e67 6c65 287b 6765 6f6d 6574 7279 636f  ngle({geometryco
-00001b60: 6c75 6d6e 7d29 2049 5320 4e4f 5420 4e55  lumn}) IS NOT NU
-00001b70: 4c4c 2054 4845 4e0a 2020 2020 2020 2020  LL THEN.        
-00001b80: 2020 2020 2020 2020 2020 2020 2053 545f               ST_
-00001b90: 4765 6f6d 6574 7279 5479 7065 2843 6173  GeometryType(Cas
-00001ba0: 7454 6f53 696e 676c 6528 7b67 656f 6d65  tToSingle({geome
-00001bb0: 7472 7963 6f6c 756d 6e7d 2929 0a20 2020  trycolumn})).   
-00001bc0: 2020 2020 2020 2020 2020 2020 2020 454c                EL
-00001bd0: 5345 2053 545f 4765 6f6d 6574 7279 5479  SE ST_GeometryTy
-00001be0: 7065 287b 6765 6f6d 6574 7279 636f 6c75  pe({geometrycolu
-00001bf0: 6d6e 7d29 0a20 2020 2020 2020 2020 2020  mn}).           
-00001c00: 2020 2020 454e 4420 4153 2067 656f 6d5f      END AS geom_
-00001c10: 7479 7065 0a20 2020 2020 2020 2020 2046  type.          F
-00001c20: 524f 4d20 227b 696e 7075 745f 6c61 7965  ROM "{input_laye
-00001c30: 727d 2220 6c61 7965 720a 2020 2020 2222  r}" layer.    ""
-00001c40: 220a 2020 2020 7265 7375 6c74 5f64 6620  ".    result_df 
-00001c50: 3d20 7265 6164 5f66 696c 6528 7061 7468  = read_file(path
-00001c60: 2c20 7371 6c5f 7374 6d74 3d73 716c 5f73  , sql_stmt=sql_s
-00001c70: 746d 742c 2073 716c 5f64 6961 6c65 6374  tmt, sql_dialect
-00001c80: 3d22 5351 4c49 5445 2229 0a20 2020 2072  ="SQLITE").    r
-00001c90: 6574 7572 6e20 7265 7375 6c74 5f64 665b  eturn result_df[
-00001ca0: 2267 656f 6d5f 7479 7065 225d 2e74 6f5f  "geom_type"].to_
-00001cb0: 6c69 7374 2829 2020 2320 7479 7065 3a20  list()  # type: 
-00001cc0: 6967 6e6f 7265 0a0a 0a64 6566 2067 6574  ignore...def get
-00001cd0: 5f6c 6179 6572 696e 666f 280a 2020 2020  _layerinfo(.    
-00001ce0: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
-00001cf0: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
-00001d00: 795d 225d 2c20 6c61 7965 723a 204f 7074  y]"], layer: Opt
-00001d10: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00001d20: 650a 2920 2d3e 204c 6179 6572 496e 666f  e.) -> LayerInfo
-00001d30: 3a0a 2020 2020 2222 220a 2020 2020 4765  :.    """.    Ge
-00001d40: 7420 696e 666f 726d 6174 696f 6e20 6162  t information ab
-00001d50: 6f75 7420 6120 6c61 7965 7220 696e 2074  out a layer in t
-00001d60: 6865 2067 656f 6669 6c65 2e0a 0a20 2020  he geofile...   
-00001d70: 2052 6169 7365 7320 616e 2065 7863 6570   Raises an excep
-00001d80: 7469 6f6e 2069 6620 7468 6520 6c61 7965  tion if the laye
-00001d90: 7220 6465 6669 6e69 7469 6f6e 2068 6173  r definition has
-00001da0: 2065 7272 6f72 7320 6c69 6b65 2069 6e76   errors like inv
-00001db0: 616c 6964 2063 6f6c 756d 6e0a 2020 2020  alid column.    
-00001dc0: 6e61 6d65 732c 2e2e 2e0a 0a20 2020 2041  names,.....    A
-00001dd0: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-00001de0: 6820 2850 6174 684c 696b 6529 3a20 7061  h (PathLike): pa
-00001df0: 7468 2074 6f20 7468 6520 6669 6c65 2074  th to the file t
-00001e00: 6f20 6765 7420 696e 666f 2061 626f 7574  o get info about
-00001e10: 0a20 2020 2020 2020 206c 6179 6572 2028  .        layer (
-00001e20: 7374 7229 3a20 7468 6520 6c61 7965 7220  str): the layer 
-00001e30: 796f 7520 7761 6e74 2069 6e66 6f20 6162  you want info ab
-00001e40: 6f75 742e 2044 6f65 736e 2774 206e 6565  out. Doesn't nee
-00001e50: 6420 746f 2062 650a 2020 2020 2020 2020  d to be.        
-00001e60: 2020 2020 7370 6563 6966 6965 6420 6966      specified if
-00001e70: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
-00001e80: 6e65 206c 6179 6572 2069 6e20 7468 6520  ne layer in the 
-00001e90: 6765 6f66 696c 652e 0a0a 2020 2020 5265  geofile...    Re
-00001ea0: 7475 726e 733a 0a20 2020 2020 2020 204c  turns:.        L
-00001eb0: 6179 6572 496e 666f 3a20 7468 6520 696e  ayerInfo: the in
-00001ec0: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
-00001ed0: 7468 6520 6c61 7965 722e 0a20 2020 2022  the layer..    "
-00001ee0: 2222 0a20 2020 2023 2049 6e69 740a 2020  "".    # Init.  
-00001ef0: 2020 7061 7468 203d 2050 6174 6828 7061    path = Path(pa
-00001f00: 7468 290a 2020 2020 6966 206e 6f74 2070  th).    if not p
-00001f10: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
-00001f20: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00001f30: 6545 7272 6f72 2866 2269 6e70 7574 5f70  eError(f"input_p
-00001f40: 6174 6820 646f 6573 6e27 7420 6578 6973  ath doesn't exis
-00001f50: 743a 207b 7061 7468 7d22 290a 0a20 2020  t: {path}")..   
-00001f60: 2069 6620 6c61 7965 7220 6973 204e 6f6e   if layer is Non
-00001f70: 653a 0a20 2020 2020 2020 206c 6179 6572  e:.        layer
-00001f80: 203d 2067 6574 5f6f 6e6c 795f 6c61 7965   = get_only_laye
-00001f90: 7228 7061 7468 290a 0a20 2020 2064 6174  r(path)..    dat
-00001fa0: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a20  asource = None. 
-00001fb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00001fc0: 6461 7461 736f 7572 6365 203d 2067 6461  datasource = gda
-00001fd0: 6c2e 4f70 656e 4578 2873 7472 2870 6174  l.OpenEx(str(pat
-00001fe0: 6829 290a 2020 2020 2020 2020 6461 7461  h)).        data
-00001ff0: 736f 7572 6365 5f6c 6179 6572 203d 2064  source_layer = d
-00002000: 6174 6173 6f75 7263 652e 4765 744c 6179  atasource.GetLay
-00002010: 6572 286c 6179 6572 290a 0a20 2020 2020  er(layer)..     
-00002020: 2020 2023 2049 6620 7468 6520 6c61 7965     # If the laye
-00002030: 7220 646f 6573 6e27 7420 6578 6973 742c  r doesn't exist,
-00002040: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00002050: 6966 2064 6174 6173 6f75 7263 655f 6c61  if datasource_la
-00002060: 7965 7220 6973 204e 6f6e 653a 0a20 2020  yer is None:.   
-00002070: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00002080: 616c 7565 4572 726f 7228 6622 4c61 7965  alueError(f"Laye
-00002090: 7220 7b6c 6179 6572 7d20 6e6f 7420 666f  r {layer} not fo
-000020a0: 756e 6420 696e 2066 696c 653a 207b 7061  und in file: {pa
-000020b0: 7468 7d22 290a 0a20 2020 2020 2020 2023  th}")..        #
-000020c0: 2047 6574 2063 6f6c 756d 6e20 696e 666f   Get column info
-000020d0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-000020e0: 203d 207b 7d0a 2020 2020 2020 2020 6572   = {}.        er
-000020f0: 726f 7273 203d 205b 5d0a 2020 2020 2020  rors = [].      
-00002100: 2020 6765 6f66 696c 6574 7970 6520 3d20    geofiletype = 
-00002110: 4765 6f66 696c 6554 7970 6528 7061 7468  GeofileType(path
-00002120: 290a 2020 2020 2020 2020 6c61 7965 725f  ).        layer_
-00002130: 6465 666e 203d 2064 6174 6173 6f75 7263  defn = datasourc
-00002140: 655f 6c61 7965 722e 4765 744c 6179 6572  e_layer.GetLayer
-00002150: 4465 666e 2829 0a20 2020 2020 2020 2066  Defn().        f
-00002160: 6f72 2069 2069 6e20 7261 6e67 6528 6c61  or i in range(la
-00002170: 7965 725f 6465 666e 2e47 6574 4669 656c  yer_defn.GetFiel
-00002180: 6443 6f75 6e74 2829 293a 0a20 2020 2020  dCount()):.     
-00002190: 2020 2020 2020 206e 616d 6520 3d20 6c61         name = la
-000021a0: 7965 725f 6465 666e 2e47 6574 4669 656c  yer_defn.GetFiel
-000021b0: 6444 6566 6e28 6929 2e47 6574 4e61 6d65  dDefn(i).GetName
-000021c0: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
-000021d0: 2054 4f44 4f3a 2074 6869 6e6b 2077 6865   TODO: think whe
-000021e0: 7468 6572 2074 6865 2074 7970 6520 6e61  ther the type na
-000021f0: 6d65 2073 686f 756c 6420 6265 2063 6f6e  me should be con
-00002200: 7665 7274 6564 2074 6f20 6f74 6865 7220  verted to other 
-00002210: 6e61 6d65 730a 2020 2020 2020 2020 2020  names.          
-00002220: 2020 6764 616c 5f74 7970 6520 3d20 6c61    gdal_type = la
-00002230: 7965 725f 6465 666e 2e47 6574 4669 656c  yer_defn.GetFiel
-00002240: 6444 6566 6e28 6929 2e47 6574 5479 7065  dDefn(i).GetType
-00002250: 4e61 6d65 2829 0a20 2020 2020 2020 2020  Name().         
-00002260: 2020 2077 6964 7468 203d 206c 6179 6572     width = layer
-00002270: 5f64 6566 6e2e 4765 7446 6965 6c64 4465  _defn.GetFieldDe
-00002280: 666e 2869 292e 4765 7457 6964 7468 2829  fn(i).GetWidth()
-00002290: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-000022a0: 7468 203d 2077 6964 7468 2069 6620 7769  th = width if wi
-000022b0: 6474 6820 3e20 3020 656c 7365 204e 6f6e  dth > 0 else Non
-000022c0: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-000022d0: 6563 6973 696f 6e20 3d20 6c61 7965 725f  ecision = layer_
-000022e0: 6465 666e 2e47 6574 4669 656c 6444 6566  defn.GetFieldDef
-000022f0: 6e28 6929 2e47 6574 5072 6563 6973 696f  n(i).GetPrecisio
-00002300: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
-00002310: 7072 6563 6973 696f 6e20 3d20 7072 6563  precision = prec
-00002320: 6973 696f 6e20 6966 2070 7265 6369 7369  ision if precisi
-00002330: 6f6e 203e 2030 2065 6c73 6520 4e6f 6e65  on > 0 else None
-00002340: 0a20 2020 2020 2020 2020 2020 2069 6c6c  .            ill
-00002350: 6567 616c 5f63 6f6c 756d 6e5f 6368 6172  egal_column_char
-00002360: 7320 3d20 5b27 2227 5d0a 2020 2020 2020  s = ['"'].      
-00002370: 2020 2020 2020 666f 7220 696c 6c65 6761        for illega
-00002380: 6c5f 6368 6172 2069 6e20 696c 6c65 6761  l_char in illega
-00002390: 6c5f 636f 6c75 6d6e 5f63 6861 7273 3a0a  l_column_chars:.
-000023a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023b0: 6966 2069 6c6c 6567 616c 5f63 6861 7220  if illegal_char 
-000023c0: 696e 206e 616d 653a 0a20 2020 2020 2020  in name:.       
-000023d0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-000023e0: 6f72 732e 6170 7065 6e64 280a 2020 2020  ors.append(.    
-000023f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002400: 2020 2020 6622 436f 6c75 6d6e 206e 616d      f"Column nam
-00002410: 6520 7b6e 616d 657d 2063 6f6e 7461 696e  e {name} contain
-00002420: 7320 696c 6c65 6761 6c20 6368 6172 3a20  s illegal char: 
-00002430: 7b69 6c6c 6567 616c 5f63 6861 727d 2022  {illegal_char} "
-00002440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002450: 2020 2020 2020 2020 2066 2269 6e20 6669           f"in fi
-00002460: 6c65 207b 7061 7468 7d2c 206c 6179 6572  le {path}, layer
-00002470: 207b 6c61 7965 727d 220a 2020 2020 2020   {layer}".      
-00002480: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00002490: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-000024a0: 6d6e 5f69 6e66 6f20 3d20 436f 6c75 6d6e  mn_info = Column
-000024b0: 496e 666f 280a 2020 2020 2020 2020 2020  Info(.          
-000024c0: 2020 2020 2020 6e61 6d65 3d6e 616d 652c        name=name,
-000024d0: 2067 6461 6c5f 7479 7065 3d67 6461 6c5f   gdal_type=gdal_
-000024e0: 7479 7065 2c20 7769 6474 683d 7769 6474  type, width=widt
-000024f0: 682c 2070 7265 6369 7369 6f6e 3d70 7265  h, precision=pre
-00002500: 6369 7369 6f6e 0a20 2020 2020 2020 2020  cision.         
-00002510: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00002520: 2063 6f6c 756d 6e73 5b6e 616d 655d 203d   columns[name] =
-00002530: 2063 6f6c 756d 6e5f 696e 666f 0a20 2020   column_info.   
-00002540: 2020 2020 2020 2020 2069 6620 6765 6f66           if geof
-00002550: 696c 6574 7970 6520 3d3d 2047 656f 6669  iletype == Geofi
-00002560: 6c65 5479 7065 2e45 5352 4953 6861 7065  leType.ESRIShape
-00002570: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00002580: 2020 2020 2020 6966 206e 616d 652e 6361        if name.ca
-00002590: 7365 666f 6c64 2829 203d 3d20 2267 656f  sefold() == "geo
-000025a0: 6d65 7472 7922 3a0a 2020 2020 2020 2020  metry":.        
-000025b0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-000025c0: 7273 2e61 7070 656e 6428 0a20 2020 2020  rs.append(.     
-000025d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000025e0: 2020 2022 416e 2061 7474 7269 6275 7465     "An attribute
-000025f0: 2063 6f6c 756d 6e20 2767 656f 6d65 7472   column 'geometr
-00002600: 7927 2069 7320 6e6f 7420 7375 7070 6f72  y' is not suppor
-00002610: 7465 6420 696e 2061 2073 6861 7065 6669  ted in a shapefi
-00002620: 6c65 220a 2020 2020 2020 2020 2020 2020  le".            
-00002630: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00002640: 2020 2023 2047 6574 2067 656f 6d65 7472     # Get geometr
-00002650: 7920 636f 6c75 6d6e 2069 6e66 6f2e 2e2e  y column info...
-00002660: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
-00002670: 7974 7970 656e 616d 6520 3d20 6764 616c  ytypename = gdal
-00002680: 2e6f 6772 2e47 656f 6d65 7472 7954 7970  .ogr.GeometryTyp
-00002690: 6554 6f4e 616d 6528 6461 7461 736f 7572  eToName(datasour
-000026a0: 6365 5f6c 6179 6572 2e47 6574 4765 6f6d  ce_layer.GetGeom
-000026b0: 5479 7065 2829 290a 2020 2020 2020 2020  Type()).        
-000026c0: 6765 6f6d 6574 7279 7479 7065 6e61 6d65  geometrytypename
-000026d0: 203d 2067 656f 6d65 7472 7974 7970 656e   = geometrytypen
-000026e0: 616d 652e 7265 706c 6163 6528 2220 222c  ame.replace(" ",
-000026f0: 2022 2229 2e75 7070 6572 2829 0a0a 2020   "").upper()..  
-00002700: 2020 2020 2020 2320 466f 7220 7368 6170        # For shap
-00002710: 6520 6669 6c65 732c 2074 6865 2064 6966  e files, the dif
-00002720: 6665 7265 6e63 6520 6265 7477 6565 6e20  ference between 
-00002730: 7468 6520 274d 554c 5449 2720 7661 7269  the 'MULTI' vari
-00002740: 616e 7420 616e 6420 7468 650a 2020 2020  ant and the.    
-00002750: 2020 2020 2320 7369 6e67 6c65 206f 6e65      # single one
-00002760: 2064 6f65 736e 2774 2065 7869 7374 732e   doesn't exists.
-00002770: 2e2e 2073 6f20 616c 7761 7973 2072 6570  .. so always rep
-00002780: 6f72 7420 4d55 4c54 4920 7661 7269 616e  ort MULTI varian
-00002790: 7420 6279 2063 6f6e 7665 6e74 696f 6e2e  t by convention.
-000027a0: 0a20 2020 2020 2020 2069 6620 4765 6f66  .        if Geof
-000027b0: 696c 6554 7970 6528 7061 7468 2920 3d3d  ileType(path) ==
-000027c0: 2047 656f 6669 6c65 5479 7065 2e45 5352   GeofileType.ESR
-000027d0: 4953 6861 7065 6669 6c65 3a0a 2020 2020  IShapefile:.    
-000027e0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
-000027f0: 2020 2020 2020 2020 2020 2020 2067 656f               geo
-00002800: 6d65 7472 7974 7970 656e 616d 652e 7374  metrytypename.st
-00002810: 6172 7473 7769 7468 2822 504f 4c59 474f  artswith("POLYGO
-00002820: 4e22 290a 2020 2020 2020 2020 2020 2020  N").            
-00002830: 2020 2020 6f72 2067 656f 6d65 7472 7974      or geometryt
-00002840: 7970 656e 616d 652e 7374 6172 7473 7769  ypename.startswi
-00002850: 7468 2822 4c49 4e45 5354 5249 4e47 2229  th("LINESTRING")
-00002860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002870: 206f 7220 6765 6f6d 6574 7279 7479 7065   or geometrytype
-00002880: 6e61 6d65 2e73 7461 7274 7377 6974 6828  name.startswith(
-00002890: 2250 4f49 4e54 2229 0a20 2020 2020 2020  "POINT").       
-000028a0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-000028b0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-000028c0: 7479 7065 6e61 6d65 203d 2066 224d 554c  typename = f"MUL
-000028d0: 5449 7b67 656f 6d65 7472 7974 7970 656e  TI{geometrytypen
-000028e0: 616d 657d 220a 2020 2020 2020 2020 6966  ame}".        if
-000028f0: 2067 656f 6d65 7472 7974 7970 656e 616d   geometrytypenam
-00002900: 6520 3d3d 2022 554e 4b4e 4f57 4e28 414e  e == "UNKNOWN(AN
-00002910: 5929 223a 0a20 2020 2020 2020 2020 2020  Y)":.           
-00002920: 2067 656f 6d65 7472 7974 7970 656e 616d   geometrytypenam
-00002930: 6520 3d20 2247 454f 4d45 5452 5922 0a0a  e = "GEOMETRY"..
-00002940: 2020 2020 2020 2020 2320 4765 6f6d 6574          # Geomet
-00002950: 7279 7479 7065 0a20 2020 2020 2020 2069  rytype.        i
-00002960: 6620 6765 6f6d 6574 7279 7479 7065 6e61  f geometrytypena
-00002970: 6d65 2021 3d20 224e 4f4e 4522 3a0a 2020  me != "NONE":.  
-00002980: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
-00002990: 7279 7479 7065 203d 2047 656f 6d65 7472  rytype = Geometr
-000029a0: 7954 7970 655b 6765 6f6d 6574 7279 7479  yType[geometryty
-000029b0: 7065 6e61 6d65 5d0a 2020 2020 2020 2020  pename].        
-000029c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000029d0: 2020 6765 6f6d 6574 7279 7479 7065 203d    geometrytype =
-000029e0: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
-000029f0: 2049 6620 7468 6520 6765 6f6d 6574 7279   If the geometry
-00002a00: 2074 7970 6520 6973 206e 6f74 204e 6f6e   type is not Non
-00002a10: 652c 2066 696c 6c20 6f75 7420 7468 6520  e, fill out the 
-00002a20: 6578 7472 6120 7072 6f70 6572 7469 6573  extra properties
-00002a30: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
-00002a40: 7963 6f6c 756d 6e20 3d20 4e6f 6e65 0a20  ycolumn = None. 
-00002a50: 2020 2020 2020 2065 7874 656e 7420 3d20         extent = 
-00002a60: 4e6f 6e65 0a20 2020 2020 2020 2063 7273  None.        crs
-00002a70: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00002a80: 746f 7461 6c5f 626f 756e 6473 203d 204e  total_bounds = N
-00002a90: 6f6e 650a 2020 2020 2020 2020 6966 2067  one.        if g
-00002aa0: 656f 6d65 7472 7974 7970 6520 6973 206e  eometrytype is n
-00002ab0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00002ac0: 2020 2020 2023 2047 656f 6d65 7472 7920       # Geometry 
-00002ad0: 636f 6c75 6d6e 206e 616d 650a 2020 2020  column name.    
-00002ae0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-00002af0: 636f 6c75 6d6e 203d 2064 6174 6173 6f75  column = datasou
-00002b00: 7263 655f 6c61 7965 722e 4765 7447 656f  rce_layer.GetGeo
-00002b10: 6d65 7472 7943 6f6c 756d 6e28 290a 2020  metryColumn().  
-00002b20: 2020 2020 2020 2020 2020 6966 2067 656f            if geo
-00002b30: 6d65 7472 7963 6f6c 756d 6e20 3d3d 2022  metrycolumn == "
-00002b40: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00002b50: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-00002b60: 6e20 3d20 2267 656f 6d65 7472 7922 0a20  n = "geometry". 
-00002b70: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-00002b80: 7665 7274 2065 7874 656e 7420 2878 6d69  vert extent (xmi
-00002b90: 6e2c 2078 6d61 782c 2079 6d69 6e2c 2079  n, xmax, ymin, y
-00002ba0: 6d61 7829 2074 6f20 626f 756e 6473 2028  max) to bounds (
-00002bb0: 786d 696e 2c20 796d 696e 2c20 786d 6178  xmin, ymin, xmax
-00002bc0: 2c20 796d 6178 290a 2020 2020 2020 2020  , ymax).        
-00002bd0: 2020 2020 6578 7465 6e74 203d 2064 6174      extent = dat
-00002be0: 6173 6f75 7263 655f 6c61 7965 722e 4765  asource_layer.Ge
-00002bf0: 7445 7874 656e 7428 290a 2020 2020 2020  tExtent().      
-00002c00: 2020 2020 2020 746f 7461 6c5f 626f 756e        total_boun
-00002c10: 6473 203d 2028 6578 7465 6e74 5b30 5d2c  ds = (extent[0],
-00002c20: 2065 7874 656e 745b 325d 2c20 6578 7465   extent[2], exte
-00002c30: 6e74 5b31 5d2c 2065 7874 656e 745b 335d  nt[1], extent[3]
-00002c40: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00002c50: 4352 530a 2020 2020 2020 2020 2020 2020  CRS.            
-00002c60: 7370 6174 6961 6c72 6566 203d 2064 6174  spatialref = dat
-00002c70: 6173 6f75 7263 655f 6c61 7965 722e 4765  asource_layer.Ge
-00002c80: 7453 7061 7469 616c 5265 6628 290a 2020  tSpatialRef().  
-00002c90: 2020 2020 2020 2020 2020 6966 2073 7061            if spa
-00002ca0: 7469 616c 7265 6620 6973 206e 6f74 204e  tialref is not N
-00002cb0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00002cc0: 2020 2020 2063 7273 203d 2070 7970 726f       crs = pypro
-00002cd0: 6a2e 4352 5328 7370 6174 6961 6c72 6566  j.CRS(spatialref
-00002ce0: 2e45 7870 6f72 7454 6f57 6b74 2829 290a  .ExportToWkt()).
-00002cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002d00: 2023 2049 6620 7370 6174 6961 6c20 7265   # If spatial re
-00002d10: 6620 6861 7320 6e6f 2065 7073 672c 2074  f has no epsg, t
-00002d20: 7279 2074 6f20 6669 6e64 2063 6f72 7265  ry to find corre
-00002d30: 7370 6f6e 6469 6e67 206f 6e65 0a20 2020  sponding one.   
-00002d40: 2020 2020 2020 2020 2020 2020 2063 7273               crs
-00002d50: 5f65 7073 6720 3d20 6372 732e 746f 5f65  _epsg = crs.to_e
-00002d60: 7073 6728 290a 2020 2020 2020 2020 2020  psg().          
-00002d70: 2020 2020 2020 6966 2063 7273 5f65 7073        if crs_eps
-00002d80: 6720 6973 204e 6f6e 653a 0a20 2020 2020  g is None:.     
-00002d90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00002da0: 6620 6372 732e 6e61 6d65 2069 6e20 5b0a  f crs.name in [.
-00002db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002dc0: 2020 2020 2020 2020 2242 656c 6765 2031          "Belge 1
-00002dd0: 3937 3220 2f20 4265 6c67 6961 6e20 4c61  972 / Belgian La
-00002de0: 6d62 6572 7420 3732 222c 0a20 2020 2020  mbert 72",.     
-00002df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e00: 2020 2022 4265 6c67 655f 3139 3732 5f42     "Belge_1972_B
-00002e10: 656c 6769 616e 5f4c 616d 6265 7274 5f37  elgian_Lambert_7
-00002e20: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
-00002e30: 2020 2020 2020 2020 2020 2020 2242 656c              "Bel
-00002e40: 6765 5f4c 616d 6265 7274 5f31 3937 3222  ge_Lambert_1972"
-00002e50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002e60: 2020 2020 2020 2020 2020 2242 4437 3220            "BD72 
-00002e70: 2f20 4265 6c67 6961 6e20 4c61 6d62 6572  / Belgian Lamber
-00002e80: 7420 3732 222c 0a20 2020 2020 2020 2020  t 72",.         
-00002e90: 2020 2020 2020 2020 2020 205d 3a0a 2020             ]:.  
-00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002eb0: 2020 2020 2020 2320 4265 6c67 6961 6e20        # Belgian 
-00002ec0: 4c61 6d62 6572 7420 696e 206e 616d 652c  Lambert in name,
-00002ed0: 2073 6f20 6173 7375 6d65 2033 3133 3730   so assume 31370
-00002ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002ef0: 2020 2020 2020 2020 2063 7273 203d 2070           crs = p
-00002f00: 7970 726f 6a2e 4352 532e 6672 6f6d 5f65  yproj.CRS.from_e
-00002f10: 7073 6728 3331 3337 3029 0a0a 2020 2020  psg(31370)..    
-00002f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f30: 2020 2020 2320 4966 2073 6861 7065 6669      # If shapefi
-00002f40: 6c65 2c20 6164 6420 636f 7272 6563 7420  le, add correct 
-00002f50: 3331 3337 3020 2e70 726a 2066 696c 650a  31370 .prj file.
-00002f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f70: 2020 2020 2020 2020 6966 2047 656f 6669          if Geofi
-00002f80: 6c65 5479 7065 2870 6174 6829 203d 3d20  leType(path) == 
-00002f90: 4765 6f66 696c 6554 7970 652e 4553 5249  GeofileType.ESRI
-00002fa0: 5368 6170 6566 696c 653a 0a20 2020 2020  Shapefile:.     
-00002fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fc0: 2020 2020 2020 2070 726a 5f70 6174 6820         prj_path 
-00002fd0: 3d20 7061 7468 2e70 6172 656e 7420 2f20  = path.parent / 
-00002fe0: 6622 7b70 6174 682e 7374 656d 7d2e 7072  f"{path.stem}.pr
-00002ff0: 6a22 0a20 2020 2020 2020 2020 2020 2020  j".             
-00003000: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003010: 6620 7072 6a5f 7061 7468 2e65 7869 7374  f prj_path.exist
-00003020: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00003030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003040: 2020 2020 2070 726a 5f72 656e 616d 655f       prj_rename_
-00003050: 7061 7468 203d 2070 6174 682e 7061 7265  path = path.pare
-00003060: 6e74 202f 2066 227b 7061 7468 2e73 7465  nt / f"{path.ste
-00003070: 6d7d 5f6f 7269 672e 7072 6a22 0a20 2020  m}_orig.prj".   
-00003080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003090: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000030a0: 6e6f 7420 7072 6a5f 7265 6e61 6d65 5f70  not prj_rename_p
-000030b0: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
-000030c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030e0: 2020 7072 6a5f 7061 7468 2e72 656e 616d    prj_path.renam
-000030f0: 6528 7072 6a5f 7265 6e61 6d65 5f70 6174  e(prj_rename_pat
-00003100: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00003110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003120: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00003130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003140: 2020 2020 2020 2020 2020 2020 2070 726a               prj
-00003150: 5f70 6174 682e 756e 6c69 6e6b 2829 0a20  _path.unlink(). 
-00003160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003170: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00003180: 726a 5f70 6174 682e 7772 6974 655f 7465  rj_path.write_te
-00003190: 7874 2850 524a 5f45 5053 475f 3331 3337  xt(PRJ_EPSG_3137
-000031a0: 3029 0a0a 2020 2020 2020 2020 2020 2020  0)..            
-000031b0: 7265 7475 726e 204c 6179 6572 496e 666f  return LayerInfo
-000031c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000031d0: 2020 6e61 6d65 3d64 6174 6173 6f75 7263    name=datasourc
-000031e0: 655f 6c61 7965 722e 4765 744e 616d 6528  e_layer.GetName(
-000031f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00003200: 2020 2066 6561 7475 7265 636f 756e 743d     featurecount=
-00003210: 6461 7461 736f 7572 6365 5f6c 6179 6572  datasource_layer
-00003220: 2e47 6574 4665 6174 7572 6543 6f75 6e74  .GetFeatureCount
-00003230: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00003240: 2020 2020 746f 7461 6c5f 626f 756e 6473      total_bounds
-00003250: 3d74 6f74 616c 5f62 6f75 6e64 732c 0a20  =total_bounds,. 
-00003260: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00003270: 656f 6d65 7472 7963 6f6c 756d 6e3d 6765  eometrycolumn=ge
-00003280: 6f6d 6574 7279 636f 6c75 6d6e 2c0a 2020  ometrycolumn,.  
-00003290: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-000032a0: 6f6d 6574 7279 7479 7065 6e61 6d65 3d67  ometrytypename=g
-000032b0: 656f 6d65 7472 7974 7970 656e 616d 652c  eometrytypename,
-000032c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000032d0: 2067 656f 6d65 7472 7974 7970 653d 6765   geometrytype=ge
-000032e0: 6f6d 6574 7279 7479 7065 2c0a 2020 2020  ometrytype,.    
-000032f0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-00003300: 6d6e 733d 636f 6c75 6d6e 732c 0a20 2020  mns=columns,.   
-00003310: 2020 2020 2020 2020 2020 2020 2066 6964               fid
-00003320: 5f63 6f6c 756d 6e3d 6461 7461 736f 7572  _column=datasour
-00003330: 6365 5f6c 6179 6572 2e47 6574 4649 4443  ce_layer.GetFIDC
-00003340: 6f6c 756d 6e28 292c 0a20 2020 2020 2020  olumn(),.       
-00003350: 2020 2020 2020 2020 2063 7273 3d63 7273           crs=crs
-00003360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003370: 2020 6572 726f 7273 3d65 7272 6f72 732c    errors=errors,
-00003380: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00003390: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000033a0: 2020 2020 2020 2020 2065 7272 6f72 732e           errors.
-000033b0: 6170 7065 6e64 2822 4c61 7965 7220 646f  append("Layer do
-000033c0: 6573 6e27 7420 6861 7665 2061 2067 656f  esn't have a geo
-000033d0: 6d65 7472 7920 636f 6c75 6d6e 2122 290a  metry column!").
-000033e0: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-000033f0: 7074 696f 6e20 6173 2065 783a 0a20 2020  ption as ex:.   
-00003400: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
-00003410: 6622 6765 745f 6c61 7965 7269 6e66 6f20  f"get_layerinfo 
-00003420: 6572 726f 7220 666f 7220 7b70 6174 687d  error for {path}
-00003430: 2e7b 6c61 7965 727d 3a5c 6e20 207b 6578  .{layer}:\n  {ex
-00003440: 7d22 2c29 0a20 2020 2020 2020 2072 6169  }",).        rai
-00003450: 7365 0a20 2020 2066 696e 616c 6c79 3a0a  se.    finally:.
-00003460: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00003470: 6365 203d 204e 6f6e 650a 0a20 2020 2023  ce = None..    #
-00003480: 2049 6620 7765 2064 6964 6e27 7420 7265   If we didn't re
-00003490: 7475 726e 206f 7220 7261 6973 6520 7965  turn or raise ye
-000034a0: 7420 6865 7265 2c20 7468 6572 6520 6d75  t here, there mu
-000034b0: 7374 2068 6176 6520 6265 656e 2065 7272  st have been err
-000034c0: 6f72 730a 2020 2020 6572 726f 7273 5f73  ors.    errors_s
-000034d0: 7472 203d 2070 7072 696e 742e 7066 6f72  tr = pprint.pfor
-000034e0: 6d61 7428 6572 726f 7273 290a 2020 2020  mat(errors).    
-000034f0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-00003500: 0a20 2020 2020 2020 2066 2245 7272 6f72  .        f"Error
-00003510: 7320 696e 206c 6179 6572 2064 6566 696e  s in layer defin
-00003520: 6974 696f 6e20 6f66 2066 696c 6520 7b70  ition of file {p
-00003530: 6174 687d 2c20 6c61 7965 7220 7b6c 6179  ath}, layer {lay
-00003540: 6572 7d3a 205c 6e7b 6572 726f 7273 5f73  er}: \n{errors_s
-00003550: 7472 7d22 0a20 2020 2029 0a0a 0a64 6566  tr}".    )...def
-00003560: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
-00003570: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
-00003580: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
-00003590: 795d 225d 2920 2d3e 2073 7472 3a0a 2020  y]"]) -> str:.  
-000035a0: 2020 2222 220a 2020 2020 4765 7420 7468    """.    Get th
-000035b0: 6520 6c61 7965 726e 616d 6520 666f 7220  e layername for 
-000035c0: 6120 6669 6c65 2074 6861 7420 6f6e 6c79  a file that only
-000035d0: 2063 6f6e 7461 696e 7320 6f6e 6520 6c61   contains one la
-000035e0: 7965 722e 0a0a 2020 2020 4966 2074 6865  yer...    If the
-000035f0: 2066 696c 6520 636f 6e74 6169 6e73 206d   file contains m
-00003600: 756c 7469 706c 6520 6c61 7965 7273 2c20  ultiple layers, 
-00003610: 616e 2065 7863 6570 7469 6f6e 2069 7320  an exception is 
-00003620: 7468 726f 776e 2e0a 0a20 2020 2041 7267  thrown...    Arg
-00003630: 733a 0a20 2020 2020 2020 2070 6174 6820  s:.        path 
-00003640: 2850 6174 684c 696b 6529 3a20 7468 6520  (PathLike): the 
-00003650: 6669 6c65 2e0a 0a20 2020 2052 6169 7365  file...    Raise
-00003660: 733a 0a20 2020 2020 2020 2056 616c 7565  s:.        Value
-00003670: 4572 726f 723a 2061 6e20 696e 7661 6c69  Error: an invali
-00003680: 6420 7061 7261 6d65 7465 7220 7661 6c75  d parameter valu
-00003690: 6520 7761 7320 7061 7373 6564 2e0a 0a20  e was passed... 
-000036a0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-000036b0: 2020 2020 7374 723a 2074 6865 206c 6179      str: the lay
-000036c0: 6572 206e 616d 650a 2020 2020 2222 220a  er name.    """.
-000036d0: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-000036e0: 204e 6f6e 650a 2020 2020 7472 793a 0a20   None.    try:. 
-000036f0: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
-00003700: 655f 6c61 7965 7220 3d20 4e6f 6e65 0a20  e_layer = None. 
-00003710: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
-00003720: 6520 3d20 6764 616c 2e4f 7065 6e45 7828  e = gdal.OpenEx(
-00003730: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00003740: 2870 6174 6829 2c20 6e4f 7065 6e46 6c61  (path), nOpenFla
-00003750: 6773 3d67 6461 6c2e 4f46 5f56 4543 544f  gs=gdal.OF_VECTO
-00003760: 5220 7c20 6764 616c 2e4f 465f 5245 4144  R | gdal.OF_READ
-00003770: 4f4e 4c59 207c 2067 6461 6c2e 4f46 5f53  ONLY | gdal.OF_S
-00003780: 4841 5245 440a 2020 2020 2020 2020 290a  HARED.        ).
-00003790: 2020 2020 2020 2020 6e62 5f6c 6179 6572          nb_layer
-000037a0: 7320 3d20 6461 7461 736f 7572 6365 2e47  s = datasource.G
-000037b0: 6574 4c61 7965 7243 6f75 6e74 2829 0a20  etLayerCount(). 
-000037c0: 2020 2020 2020 2069 6620 6e62 5f6c 6179         if nb_lay
-000037d0: 6572 7320 3d3d 2031 3a0a 2020 2020 2020  ers == 1:.      
-000037e0: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-000037f0: 5f6c 6179 6572 203d 2064 6174 6173 6f75  _layer = datasou
-00003800: 7263 652e 4765 744c 6179 6572 4279 496e  rce.GetLayerByIn
-00003810: 6465 7828 3029 0a20 2020 2020 2020 2065  dex(0).        e
-00003820: 6c69 6620 6e62 5f6c 6179 6572 7320 3d3d  lif nb_layers ==
-00003830: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00003840: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00003850: 2866 2245 7272 6f72 3a20 4e6f 206c 6179  (f"Error: No lay
-00003860: 6572 7320 666f 756e 6420 696e 207b 7061  ers found in {pa
-00003870: 7468 7d22 290a 2020 2020 2020 2020 656c  th}").        el
-00003880: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00003890: 2320 4368 6563 6b20 6966 2074 6865 7265  # Check if there
-000038a0: 2069 7320 6f6e 6c79 206f 6e65 2073 7061   is only one spa
-000038b0: 7469 616c 206c 6179 6572 0a20 2020 2020  tial layer.     
-000038c0: 2020 2020 2020 206c 6179 6572 7320 3d20         layers = 
-000038d0: 6c69 7374 6c61 7965 7273 2870 6174 682c  listlayers(path,
-000038e0: 206f 6e6c 795f 7370 6174 6961 6c5f 6c61   only_spatial_la
-000038f0: 7965 7273 3d54 7275 6529 0a20 2020 2020  yers=True).     
-00003900: 2020 2020 2020 2069 6620 6c65 6e28 6c61         if len(la
-00003910: 7965 7273 2920 3d3d 2031 3a0a 2020 2020  yers) == 1:.    
-00003920: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00003930: 736f 7572 6365 5f6c 6179 6572 203d 2064  source_layer = d
-00003940: 6174 6173 6f75 7263 652e 4765 744c 6179  atasource.GetLay
-00003950: 6572 286c 6179 6572 735b 305d 290a 2020  er(layers[0]).  
-00003960: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003980: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00003990: 2866 224c 6179 6572 2068 6173 203e 2031  (f"Layer has > 1
-000039a0: 206c 6179 6572 3a20 7b70 6174 687d 3a20   layer: {path}: 
-000039b0: 7b6c 6179 6572 737d 2229 0a0a 2020 2020  {layers}")..    
-000039c0: 2020 2020 7265 7475 726e 2064 6174 6173      return datas
-000039d0: 6f75 7263 655f 6c61 7965 722e 4765 744e  ource_layer.GetN
-000039e0: 616d 6528 290a 0a20 2020 2065 7863 6570  ame()..    excep
-000039f0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-00003a00: 783a 0a20 2020 2020 2020 2065 782e 6172  x:.        ex.ar
-00003a10: 6773 203d 2028 6622 6765 745f 6f6e 6c79  gs = (f"get_only
-00003a20: 5f6c 6179 6572 2065 7272 6f72 2066 6f72  _layer error for
-00003a30: 207b 7061 7468 7d3a 5c6e 2020 7b65 787d   {path}:\n  {ex}
-00003a40: 222c 290a 2020 2020 2020 2020 7261 6973  ",).        rais
-00003a50: 650a 2020 2020 6669 6e61 6c6c 793a 0a20  e.    finally:. 
-00003a60: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
-00003a70: 6520 3d20 4e6f 6e65 0a0a 0a64 6566 2067  e = None...def g
-00003a80: 6574 5f64 6566 6175 6c74 5f6c 6179 6572  et_default_layer
-00003a90: 2870 6174 683a 2055 6e69 6f6e 5b73 7472  (path: Union[str
-00003aa0: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-00003ab0: 6e79 5d22 5d29 202d 3e20 7374 723a 0a20  ny]"]) -> str:. 
-00003ac0: 2020 2022 2222 0a20 2020 2047 6574 2074     """.    Get t
-00003ad0: 6865 2064 6566 6175 6c74 206c 6179 6572  he default layer
-00003ae0: 206e 616d 6520 746f 2062 6520 7573 6564   name to be used
-00003af0: 2066 6f72 2061 206c 6179 6572 2069 6e20   for a layer in 
-00003b00: 7468 6973 2066 696c 652e 0a0a 2020 2020  this file...    
-00003b10: 5468 6973 2069 7320 7468 6520 7374 656d  This is the stem
-00003b20: 206f 6620 7468 6520 6669 6c65 7061 7468   of the filepath
-00003b30: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00003b40: 2020 2020 2070 6174 6820 2855 6e69 6f6e       path (Union
-00003b50: 5b73 7472 2c29 3a20 5468 6520 7061 7468  [str,): The path
-00003b60: 2074 6f20 7468 6520 6669 6c65 2e0a 0a20   to the file... 
-00003b70: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00003b80: 2020 2020 7374 723a 2054 6865 2064 6566      str: The def
-00003b90: 6175 6c74 206c 6179 6572 206e 616d 652e  ault layer name.
-00003ba0: 0a20 2020 2022 2222 0a20 2020 2072 6574  .    """.    ret
-00003bb0: 7572 6e20 5061 7468 2870 6174 6829 2e73  urn Path(path).s
-00003bc0: 7465 6d0a 0a0a 6465 6620 6578 6563 7574  tem...def execut
-00003bd0: 655f 7371 6c28 0a20 2020 2070 6174 683a  e_sql(.    path:
-00003be0: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
-00003bf0: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
-00003c00: 0a20 2020 2073 716c 5f73 746d 743a 2073  .    sql_stmt: s
-00003c10: 7472 2c0a 2020 2020 7371 6c5f 6469 616c  tr,.    sql_dial
-00003c20: 6563 743a 204f 7074 696f 6e61 6c5b 7374  ect: Optional[st
-00003c30: 725d 203d 204e 6f6e 652c 0a29 3a0a 2020  r] = None,.):.  
-00003c40: 2020 2222 220a 2020 2020 4578 6563 7574    """.    Execut
-00003c50: 6520 6120 7371 6c20 7374 6174 656d 656e  e a sql statemen
-00003c60: 7420 2844 4d4c 206f 7220 4444 4c29 206f  t (DML or DDL) o
-00003c70: 6e20 7468 6520 6669 6c65 2e0a 0a20 2020  n the file...   
-00003c80: 2054 6f20 7275 6e20 5345 4c45 4354 2073   To run SELECT s
-00003c90: 716c 2073 7461 7465 6d65 6e74 7320 6f6e  ql statements on
-00003ca0: 2061 2066 696c 652c 2075 7365 203a 6d65   a file, use :me
-00003cb0: 7468 3a60 7e72 6561 645f 6669 6c65 602e  th:`~read_file`.
-00003cc0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00003cd0: 2020 2020 7061 7468 2028 5061 7468 4c69      path (PathLi
-00003ce0: 6b65 293a 2054 6865 2070 6174 6820 746f  ke): The path to
-00003cf0: 2074 6865 2066 696c 652e 0a20 2020 2020   the file..     
-00003d00: 2020 2073 716c 5f73 746d 7420 2873 7472     sql_stmt (str
-00003d10: 293a 2054 6865 2073 716c 2073 7461 7465  ): The sql state
-00003d20: 6d65 6e74 2074 6f20 6578 6563 7574 652e  ment to execute.
-00003d30: 0a20 2020 2020 2020 2073 716c 5f64 6961  .        sql_dia
-00003d40: 6c65 6374 2028 7374 7229 3a20 5468 6520  lect (str): The 
-00003d50: 7371 6c20 6469 616c 6563 7420 746f 2075  sql dialect to u
-00003d60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00003d70: 2a20 4e6f 6e65 3a20 7573 6520 7468 6520  * None: use the 
-00003d80: 6e61 7469 7665 2053 514c 2064 6961 6c65  native SQL diale
-00003d90: 6374 206f 6620 7468 6520 6765 6f66 696c  ct of the geofil
-00003da0: 652e 0a20 2020 2020 2020 2020 2020 202a  e..            *
-00003db0: 2027 4f47 5253 514c 273a 2066 6f72 6365   'OGRSQL': force
-00003dc0: 2074 6865 2075 7365 206f 6620 7468 6520   the use of the 
-00003dd0: 4f47 5220 5351 4c20 6469 616c 6563 742e  OGR SQL dialect.
-00003de0: 0a20 2020 2020 2020 2020 2020 202a 2027  .            * '
-00003df0: 5351 4c49 5445 273a 2066 6f72 6365 2074  SQLITE': force t
-00003e00: 6865 2075 7365 206f 6620 7468 6520 5351  he use of the SQ
-00003e10: 4c49 5445 2064 6961 6c65 6374 2e0a 2020  LITE dialect..  
-00003e20: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
-00003e30: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
-00003e40: 2222 220a 2020 2020 6461 7461 736f 7572  """.    datasour
-00003e50: 6365 203d 204e 6f6e 650a 2020 2020 7472  ce = None.    tr
-00003e60: 793a 0a20 2020 2020 2020 2064 6174 6173  y:.        datas
-00003e70: 6f75 7263 6520 3d20 6764 616c 2e4f 7065  ource = gdal.Ope
-00003e80: 6e45 7828 7374 7228 7061 7468 292c 206e  nEx(str(path), n
-00003e90: 4f70 656e 466c 6167 733d 6764 616c 2e4f  OpenFlags=gdal.O
-00003ea0: 465f 5550 4441 5445 290a 2020 2020 2020  F_UPDATE).      
-00003eb0: 2020 7265 7375 6c74 203d 2064 6174 6173    result = datas
-00003ec0: 6f75 7263 652e 4578 6563 7574 6553 514c  ource.ExecuteSQL
-00003ed0: 2873 716c 5f73 746d 742c 2064 6961 6c65  (sql_stmt, diale
-00003ee0: 6374 3d73 716c 5f64 6961 6c65 6374 290a  ct=sql_dialect).
-00003ef0: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00003f00: 6365 2e52 656c 6561 7365 5265 7375 6c74  ce.ReleaseResult
-00003f10: 5365 7428 7265 7375 6c74 290a 0a20 2020  Set(result)..   
-00003f20: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00003f30: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-00003f40: 2065 782e 6172 6773 203d 2028 6622 6578   ex.args = (f"ex
-00003f50: 6563 7574 655f 7371 6c20 6572 726f 7220  ecute_sql error 
-00003f60: 666f 7220 7b70 6174 687d 5c6e 2020 7b65  for {path}\n  {e
-00003f70: 787d 222c 290a 2020 2020 2020 2020 7261  x}",).        ra
-00003f80: 6973 650a 2020 2020 6669 6e61 6c6c 793a  ise.    finally:
-00003f90: 0a20 2020 2020 2020 2064 6174 6173 6f75  .        datasou
-00003fa0: 7263 6520 3d20 4e6f 6e65 0a0a 0a64 6566  rce = None...def
-00003fb0: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
-00003fc0: 696e 6465 7828 0a20 2020 2070 6174 683a  index(.    path:
-00003fd0: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
-00003fe0: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
-00003ff0: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
-00004000: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00004010: 2c0a 2020 2020 6361 6368 655f 7369 7a65  ,.    cache_size
-00004020: 5f6d 623a 204f 7074 696f 6e61 6c5b 696e  _mb: Optional[in
-00004030: 745d 203d 2031 3238 2c0a 2020 2020 6578  t] = 128,.    ex
-00004040: 6973 745f 6f6b 3a20 626f 6f6c 203d 2046  ist_ok: bool = F
-00004050: 616c 7365 2c0a 2020 2020 666f 7263 655f  alse,.    force_
-00004060: 7265 6275 696c 643a 2062 6f6f 6c20 3d20  rebuild: bool = 
-00004070: 4661 6c73 652c 0a29 3a0a 2020 2020 2222  False,.):.    ""
-00004080: 220a 2020 2020 4372 6561 7465 2061 2073  ".    Create a s
-00004090: 7061 7469 616c 2069 6e64 6578 206f 6e20  patial index on 
-000040a0: 7468 6520 6c61 7965 7220 7370 6563 6966  the layer specif
-000040b0: 6965 642e 0a0a 2020 2020 4172 6773 3a0a  ied...    Args:.
-000040c0: 2020 2020 2020 2020 7061 7468 2028 5061          path (Pa
-000040d0: 7468 4c69 6b65 293a 2054 6865 2066 696c  thLike): The fil
-000040e0: 6520 7061 7468 2e0a 2020 2020 2020 2020  e path..        
-000040f0: 6c61 7965 7220 2873 7472 2c20 6f70 7469  layer (str, opti
-00004100: 6f6e 616c 293a 2054 6865 206c 6179 6572  onal): The layer
-00004110: 2e20 4966 206e 6f74 2073 7065 6369 6669  . If not specifi
-00004120: 6564 2c20 616e 6420 7468 6572 6520 6973  ed, and there is
-00004130: 206f 6e6c 790a 2020 2020 2020 2020 2020   only.          
-00004140: 2020 6f6e 6520 6c61 7965 7220 696e 2074    one layer in t
-00004150: 6865 2066 696c 652c 2074 6869 7320 6c61  he file, this la
-00004160: 7965 7220 6973 2075 7365 642e 204f 7468  yer is used. Oth
-00004170: 6572 7769 7365 2065 7863 6570 7469 6f6e  erwise exception
-00004180: 2e0a 2020 2020 2020 2020 6361 6368 655f  ..        cache_
-00004190: 7369 7a65 5f6d 6220 2869 6e74 2c20 6f70  size_mb (int, op
-000041a0: 7469 6f6e 616c 293a 2063 6163 6865 206d  tional): cache m
-000041b0: 656d 6f72 7920 696e 204d 4220 7468 6174  emory in MB that
-000041c0: 2063 616e 2062 6520 7573 6564 2077 6869   can be used whi
-000041d0: 6c65 0a20 2020 2020 2020 2020 2020 2063  le.            c
-000041e0: 7265 6174 696e 6720 7370 6174 6961 6c20  reating spatial 
-000041f0: 696e 6465 7820 666f 7220 7370 6174 6961  index for spatia
-00004200: 6c69 7465 2066 696c 6573 2028 2e67 706b  lite files (.gpk
-00004210: 6720 6f72 202e 7371 6c69 7465 292e 2049  g or .sqlite). I
-00004220: 6620 4e6f 6e65 2c0a 2020 2020 2020 2020  f None,.        
-00004230: 2020 2020 7468 6520 6465 6661 756c 7420      the default 
-00004240: 6361 6368 655f 7369 7a65 2066 726f 6d20  cache_size from 
-00004250: 7371 6c69 7465 2069 7320 7573 6564 2e20  sqlite is used. 
-00004260: 4465 6661 756c 7473 2074 6f20 3132 382e  Defaults to 128.
-00004270: 0a20 2020 2020 2020 2065 7869 7374 5f6f  .        exist_o
-00004280: 6b20 2862 6f6f 6c2c 206f 7074 696f 6e73  k (bool, options
-00004290: 293a 2049 6620 5472 7565 2061 6e64 2074  ): If True and t
-000042a0: 6865 2069 6e64 6578 2065 7869 7374 7320  he index exists 
-000042b0: 616c 7265 6164 792c 2064 6f6e 2774 0a20  already, don't. 
-000042c0: 2020 2020 2020 2020 2020 2074 6872 6f77             throw
-000042d0: 2061 6e20 6572 726f 722e 0a20 2020 2020   an error..     
-000042e0: 2020 2066 6f72 6365 5f72 6562 7569 6c64     force_rebuild
-000042f0: 2028 626f 6f6c 2c20 6f70 7469 6f6e 7329   (bool, options)
-00004300: 3a20 5472 7565 2074 6f20 666f 7263 6520  : True to force 
-00004310: 7265 6275 696c 6420 6576 656e 2069 6620  rebuild even if 
-00004320: 696e 6465 780a 2020 2020 2020 2020 2020  index.          
-00004330: 2020 6578 6973 7473 2061 6c72 6561 6479    exists already
-00004340: 2e20 4465 6661 756c 7473 2074 6f20 4661  . Defaults to Fa
-00004350: 6c73 652e 0a20 2020 2022 2222 0a20 2020  lse..    """.   
-00004360: 2023 2049 6e69 740a 2020 2020 7061 7468   # Init.    path
-00004370: 203d 2050 6174 6828 7061 7468 290a 2020   = Path(path).  
-00004380: 2020 6966 206c 6179 6572 2069 7320 4e6f    if layer is No
-00004390: 6e65 3a0a 2020 2020 2020 2020 6c61 7965  ne:.        laye
-000043a0: 7220 3d20 6765 745f 6f6e 6c79 5f6c 6179  r = get_only_lay
-000043b0: 6572 2870 6174 6829 0a0a 2020 2020 2320  er(path)..    # 
-000043c0: 4966 2069 6e64 6578 2061 6c72 6561 6479  If index already
-000043d0: 2065 7869 7374 732c 2072 656d 6f76 6520   exists, remove 
-000043e0: 696e 6465 7820 6f72 2072 6574 7572 6e0a  index or return.
-000043f0: 2020 2020 6966 2068 6173 5f73 7061 7469      if has_spati
-00004400: 616c 5f69 6e64 6578 2870 6174 682c 206c  al_index(path, l
-00004410: 6179 6572 293a 0a20 2020 2020 2020 2069  ayer):.        i
-00004420: 6620 666f 7263 655f 7265 6275 696c 643a  f force_rebuild:
-00004430: 0a20 2020 2020 2020 2020 2020 2072 656d  .            rem
-00004440: 6f76 655f 7370 6174 6961 6c5f 696e 6465  ove_spatial_inde
-00004450: 7828 7061 7468 2c20 6c61 7965 7229 0a20  x(path, layer). 
-00004460: 2020 2020 2020 2065 6c69 6620 6578 6973         elif exis
-00004470: 745f 6f6b 3a0a 2020 2020 2020 2020 2020  t_ok:.          
-00004480: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00004490: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000044a0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-000044b0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-000044c0: 2020 2020 6622 4572 726f 7220 6164 6469      f"Error addi
-000044d0: 6e67 2073 7061 7469 616c 2069 6e64 6578  ng spatial index
-000044e0: 2074 6f20 7b70 6174 687d 2e7b 6c61 7965   to {path}.{laye
-000044f0: 727d 2c20 6974 2065 7869 7374 7320 616c  r}, it exists al
-00004500: 7265 6164 7922 0a20 2020 2020 2020 2020  ready".         
-00004510: 2020 2029 0a0a 2020 2020 2320 4e6f 7720     )..    # Now 
-00004520: 7265 616c 6c79 2061 6464 2069 6e64 6578  really add index
-00004530: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-00004540: 3d20 4e6f 6e65 0a20 2020 2074 7279 3a0a  = None.    try:.
-00004550: 2020 2020 2020 2020 6765 6f66 696c 6574          geofilet
-00004560: 7970 6520 3d20 4765 6f66 696c 6554 7970  ype = GeofileTyp
-00004570: 6528 7061 7468 290a 2020 2020 2020 2020  e(path).        
-00004580: 6966 2067 656f 6669 6c65 7479 7065 2e69  if geofiletype.i
-00004590: 735f 7370 6174 6961 6c69 7465 5f62 6173  s_spatialite_bas
-000045a0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-000045b0: 2320 5468 6520 636f 6e66 6967 206f 7074  # The config opt
-000045c0: 696f 6e73 206e 6565 6420 746f 2062 6520  ions need to be 
-000045d0: 7365 7420 6265 666f 7265 206f 7065 6e69  set before openi
-000045e0: 6e67 2074 6865 2066 696c 6521 0a20 2020  ng the file!.   
-000045f0: 2020 2020 2020 2020 206c 6179 6572 696e           layerin
-00004600: 666f 203d 2067 6574 5f6c 6179 6572 696e  fo = get_layerin
-00004610: 666f 2870 6174 682c 206c 6179 6572 290a  fo(path, layer).
-00004620: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00004630: 205f 6f67 725f 7574 696c 2e73 6574 5f63   _ogr_util.set_c
-00004640: 6f6e 6669 675f 6f70 7469 6f6e 7328 7b22  onfig_options({"
-00004650: 4f47 525f 5351 4c49 5445 5f43 4143 4845  OGR_SQLITE_CACHE
-00004660: 223a 2063 6163 6865 5f73 697a 655f 6d62  ": cache_size_mb
-00004670: 7d29 3a0a 2020 2020 2020 2020 2020 2020  }):.            
-00004680: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-00004690: 2067 6461 6c2e 4f70 656e 4578 2873 7472   gdal.OpenEx(str
-000046a0: 2870 6174 6829 2c20 6e4f 7065 6e46 6c61  (path), nOpenFla
-000046b0: 6773 3d67 6461 6c2e 4f46 5f55 5044 4154  gs=gdal.OF_UPDAT
-000046c0: 4529 0a20 2020 2020 2020 2020 2020 2020  E).             
-000046d0: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-000046e0: 6e20 3d20 6c61 7965 7269 6e66 6f2e 6765  n = layerinfo.ge
-000046f0: 6f6d 6574 7279 636f 6c75 6d6e 0a20 2020  ometrycolumn.   
-00004700: 2020 2020 2020 2020 2020 2020 2073 716c               sql
-00004710: 203d 2066 2253 454c 4543 5420 4372 6561   = f"SELECT Crea
-00004720: 7465 5370 6174 6961 6c49 6e64 6578 2827  teSpatialIndex('
-00004730: 7b6c 6179 6572 7d27 2c20 277b 6765 6f6d  {layer}', '{geom
-00004740: 6574 7279 636f 6c75 6d6e 7d27 2922 0a20  etrycolumn}')". 
-00004750: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00004760: 6573 756c 7420 3d20 6461 7461 736f 7572  esult = datasour
-00004770: 6365 2e45 7865 6375 7465 5351 4c28 7371  ce.ExecuteSQL(sq
-00004780: 6c2c 2064 6961 6c65 6374 3d22 5351 4c49  l, dialect="SQLI
-00004790: 5445 2229 0a20 2020 2020 2020 2020 2020  TE").           
-000047a0: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
-000047b0: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
-000047c0: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-000047d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000047e0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-000047f0: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
-00004800: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
-00004810: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
-00004820: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00004830: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
-00004840: 652e 4578 6563 7574 6553 514c 2866 2743  e.ExecuteSQL(f'C
-00004850: 5245 4154 4520 5350 4154 4941 4c20 494e  REATE SPATIAL IN
-00004860: 4445 5820 4f4e 2022 7b6c 6179 6572 7d22  DEX ON "{layer}"
-00004870: 2729 0a20 2020 2020 2020 2020 2020 2064  ').            d
-00004880: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
-00004890: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
-000048a0: 7429 0a0a 2020 2020 6578 6365 7074 2045  t)..    except E
-000048b0: 7863 6570 7469 6f6e 2061 7320 6578 3a0a  xception as ex:.
-000048c0: 2020 2020 2020 2020 6578 2e61 7267 7320          ex.args 
-000048d0: 3d20 2866 2263 7265 6174 655f 7370 6174  = (f"create_spat
-000048e0: 6961 6c5f 696e 6465 7820 6572 726f 7220  ial_index error 
-000048f0: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
-00004900: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
-00004910: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00004920: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-00004930: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
-00004940: 6f6e 650a 0a20 2020 2069 6620 6e6f 7420  one..    if not 
-00004950: 6861 735f 7370 6174 6961 6c5f 696e 6465  has_spatial_inde
-00004960: 7828 7061 7468 2c20 6c61 7965 7229 3a0a  x(path, layer):.
-00004970: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00004980: 6e74 696d 6545 7272 6f72 2866 2263 7265  ntimeError(f"cre
-00004990: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-000049a0: 7820 6661 696c 6564 206f 6e20 7b70 6174  x failed on {pat
-000049b0: 687d 2c20 6c61 7965 723a 207b 6c61 7965  h}, layer: {laye
-000049c0: 727d 2229 0a0a 0a64 6566 2068 6173 5f73  r}")...def has_s
-000049d0: 7061 7469 616c 5f69 6e64 6578 280a 2020  patial_index(.  
-000049e0: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
-000049f0: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-00004a00: 416e 795d 225d 2c20 6c61 7965 723a 204f  Any]"], layer: O
-00004a10: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00004a20: 6f6e 650a 2920 2d3e 2062 6f6f 6c3a 0a20  one.) -> bool:. 
-00004a30: 2020 2022 2222 0a20 2020 2043 6865 636b     """.    Check
-00004a40: 2069 6620 7468 6520 6c61 7965 722f 636f   if the layer/co
-00004a50: 6c75 6d6e 2068 6173 2061 2073 7061 7469  lumn has a spati
-00004a60: 616c 2069 6e64 6578 2e0a 0a20 2020 2041  al index...    A
-00004a70: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-00004a80: 6820 2850 6174 684c 696b 6529 3a20 5468  h (PathLike): Th
-00004a90: 6520 6669 6c65 2070 6174 682e 0a20 2020  e file path..   
-00004aa0: 2020 2020 206c 6179 6572 2028 7374 722c       layer (str,
-00004ab0: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-00004ac0: 6c61 7965 722e 2044 6566 6175 6c74 7320  layer. Defaults 
-00004ad0: 746f 204e 6f6e 652e 0a0a 2020 2020 5261  to None...    Ra
-00004ae0: 6973 6573 3a0a 2020 2020 2020 2020 5661  ises:.        Va
-00004af0: 6c75 6545 7272 6f72 3a20 616e 2069 6e76  lueError: an inv
-00004b00: 616c 6964 2070 6172 616d 6574 6572 2076  alid parameter v
-00004b10: 616c 7565 2077 6173 2070 6173 7365 642e  alue was passed.
-00004b20: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-00004b30: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
-00004b40: 6520 6966 2074 6865 2073 7061 7469 616c  e if the spatial
-00004b50: 2063 6f6c 756d 6e20 6578 6973 7473 2e0a   column exists..
-00004b60: 2020 2020 2222 220a 2020 2020 2320 496e      """.    # In
-00004b70: 6974 0a20 2020 2070 6174 6820 3d20 5061  it.    path = Pa
-00004b80: 7468 2870 6174 6829 0a0a 2020 2020 2320  th(path)..    # 
-00004b90: 4e6f 7720 6368 6563 6b20 7468 6520 696e  Now check the in
-00004ba0: 6465 780a 2020 2020 6461 7461 736f 7572  dex.    datasour
-00004bb0: 6365 203d 204e 6f6e 650a 2020 2020 6765  ce = None.    ge
-00004bc0: 6f66 696c 6574 7970 6520 3d20 4765 6f66  ofiletype = Geof
-00004bd0: 696c 6554 7970 6528 7061 7468 290a 2020  ileType(path).  
-00004be0: 2020 7472 793a 0a20 2020 2020 2020 2069    try:.        i
-00004bf0: 6620 6765 6f66 696c 6574 7970 652e 6973  f geofiletype.is
-00004c00: 5f73 7061 7469 616c 6974 655f 6261 7365  _spatialite_base
-00004c10: 643a 0a20 2020 2020 2020 2020 2020 206c  d:.            l
-00004c20: 6179 6572 696e 666f 203d 2067 6574 5f6c  ayerinfo = get_l
-00004c30: 6179 6572 696e 666f 2870 6174 682c 206c  ayerinfo(path, l
-00004c40: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
-00004c50: 2020 6461 7461 736f 7572 6365 203d 2067    datasource = g
-00004c60: 6461 6c2e 4f70 656e 4578 2873 7472 2870  dal.OpenEx(str(p
-00004c70: 6174 6829 2c20 6e4f 7065 6e46 6c61 6773  ath), nOpenFlags
-00004c80: 3d67 6461 6c2e 4f46 5f52 4541 444f 4e4c  =gdal.OF_READONL
-00004c90: 5929 0a20 2020 2020 2020 2020 2020 2073  Y).            s
-00004ca0: 716c 203d 2066 2222 220a 2020 2020 2020  ql = f""".      
-00004cb0: 2020 2020 2020 2020 2020 5345 4c45 4354            SELECT
-00004cc0: 2048 6173 5370 6174 6961 6c49 6e64 6578   HasSpatialIndex
-00004cd0: 2827 7b6c 6179 6572 696e 666f 2e6e 616d  ('{layerinfo.nam
-00004ce0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00004cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d00: 2020 2020 2020 2020 2020 2020 277b 6c61              '{la
-00004d10: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
-00004d20: 636f 6c75 6d6e 7d27 290a 2020 2020 2020  column}').      
-00004d30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004d40: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
-00004d50: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
-00004d60: 6553 514c 2873 716c 2c20 6469 616c 6563  eSQL(sql, dialec
-00004d70: 743d 2253 514c 4954 4522 290a 2020 2020  t="SQLITE").    
-00004d80: 2020 2020 2020 2020 6861 735f 7370 6174          has_spat
-00004d90: 6961 6c5f 696e 6465 7820 3d20 7265 7375  ial_index = resu
-00004da0: 6c74 2e47 6574 4e65 7874 4665 6174 7572  lt.GetNextFeatur
-00004db0: 6528 292e 4765 7446 6965 6c64 2830 2920  e().GetField(0) 
-00004dc0: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
-00004dd0: 2064 6174 6173 6f75 7263 652e 5265 6c65   datasource.Rele
-00004de0: 6173 6552 6573 756c 7453 6574 2872 6573  aseResultSet(res
-00004df0: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-00004e00: 2072 6574 7572 6e20 6861 735f 7370 6174   return has_spat
-00004e10: 6961 6c5f 696e 6465 780a 2020 2020 2020  ial_index.      
-00004e20: 2020 656c 6966 2067 656f 6669 6c65 7479    elif geofilety
-00004e30: 7065 203d 3d20 4765 6f66 696c 6554 7970  pe == GeofileTyp
-00004e40: 652e 4553 5249 5368 6170 6566 696c 653a  e.ESRIShapefile:
-00004e50: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-00004e60: 6578 5f70 6174 6820 3d20 7061 7468 2e70  ex_path = path.p
-00004e70: 6172 656e 7420 2f20 6622 7b70 6174 682e  arent / f"{path.
-00004e80: 7374 656d 7d2e 7169 7822 0a20 2020 2020  stem}.qix".     
-00004e90: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
-00004ea0: 6465 785f 7061 7468 2e65 7869 7374 7328  dex_path.exists(
-00004eb0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00004ec0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004ed0: 6520 5661 6c75 6545 7272 6f72 2866 2268  e ValueError(f"h
-00004ee0: 6173 5f73 7061 7469 616c 5f69 6e64 6578  as_spatial_index
-00004ef0: 206e 6f74 2073 7570 706f 7274 6564 2066   not supported f
-00004f00: 6f72 207b 7061 7468 7d22 290a 0a20 2020  or {path}")..   
-00004f10: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00004f20: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-00004f30: 2065 782e 6172 6773 203d 2028 6622 6861   ex.args = (f"ha
-00004f40: 735f 7370 6174 6961 6c5f 696e 6465 7820  s_spatial_index 
-00004f50: 6572 726f 7220 666f 7220 7b70 6174 687d  error for {path}
-00004f60: 2e7b 6c61 7965 727d 3a5c 6e20 207b 6578  .{layer}:\n  {ex
-00004f70: 7d22 2c29 0a20 2020 2020 2020 2072 6169  }",).        rai
-00004f80: 7365 0a20 2020 2066 696e 616c 6c79 3a0a  se.    finally:.
-00004f90: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00004fa0: 6365 203d 204e 6f6e 650a 0a0a 6465 6620  ce = None...def 
-00004fb0: 7265 6d6f 7665 5f73 7061 7469 616c 5f69  remove_spatial_i
-00004fc0: 6e64 6578 280a 2020 2020 7061 7468 3a20  ndex(.    path: 
-00004fd0: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
-00004fe0: 6174 684c 696b 655b 416e 795d 225d 2c20  athLike[Any]"], 
-00004ff0: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
-00005000: 7374 725d 203d 204e 6f6e 650a 293a 0a20  str] = None.):. 
-00005010: 2020 2022 2222 0a20 2020 2052 656d 6f76     """.    Remov
-00005020: 6520 7468 6520 7370 6174 6961 6c20 696e  e the spatial in
-00005030: 6465 7820 6672 6f6d 2074 6865 206c 6179  dex from the lay
-00005040: 6572 2073 7065 6369 6669 6564 2e0a 0a20  er specified... 
-00005050: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00005060: 2070 6174 6820 2850 6174 684c 696b 6529   path (PathLike)
-00005070: 3a20 5468 6520 6669 6c65 2070 6174 682e  : The file path.
-00005080: 0a20 2020 2020 2020 206c 6179 6572 2028  .        layer (
-00005090: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
-000050a0: 5468 6520 6c61 7965 722e 2049 6620 6e6f  The layer. If no
-000050b0: 7420 7370 6563 6966 6965 642c 2061 6e64  t specified, and
-000050c0: 2074 6865 7265 2069 7320 6f6e 6c79 0a20   there is only. 
-000050d0: 2020 2020 2020 2020 2020 206f 6e65 206c             one l
-000050e0: 6179 6572 2069 6e20 7468 6520 6669 6c65  ayer in the file
-000050f0: 2c20 7468 6973 206c 6179 6572 2069 7320  , this layer is 
-00005100: 7573 6564 2e20 4f74 6865 7277 6973 6520  used. Otherwise 
-00005110: 6578 6365 7074 696f 6e2e 0a20 2020 2022  exception..    "
-00005120: 2222 0a20 2020 2023 2049 6e69 740a 2020  "".    # Init.  
-00005130: 2020 7061 7468 203d 2050 6174 6828 7061    path = Path(pa
-00005140: 7468 290a 0a20 2020 2023 204e 6f77 2072  th)..    # Now r
-00005150: 6561 6c6c 7920 7265 6d6f 7665 2069 6e64  eally remove ind
-00005160: 6578 0a20 2020 2064 6174 6173 6f75 7263  ex.    datasourc
-00005170: 6520 3d20 4e6f 6e65 0a20 2020 2067 656f  e = None.    geo
-00005180: 6669 6c65 7479 7065 203d 2047 656f 6669  filetype = Geofi
-00005190: 6c65 5479 7065 2870 6174 6829 0a20 2020  leType(path).   
-000051a0: 206c 6179 6572 696e 666f 203d 2067 6574   layerinfo = get
-000051b0: 5f6c 6179 6572 696e 666f 2870 6174 682c  _layerinfo(path,
-000051c0: 206c 6179 6572 290a 2020 2020 7472 793a   layer).    try:
-000051d0: 0a20 2020 2020 2020 2069 6620 6765 6f66  .        if geof
-000051e0: 696c 6574 7970 652e 6973 5f73 7061 7469  iletype.is_spati
-000051f0: 616c 6974 655f 6261 7365 643a 0a20 2020  alite_based:.   
-00005200: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
-00005210: 7263 6520 3d20 6764 616c 2e4f 7065 6e45  rce = gdal.OpenE
-00005220: 7828 7374 7228 7061 7468 292c 206e 4f70  x(str(path), nOp
-00005230: 656e 466c 6167 733d 6764 616c 2e4f 465f  enFlags=gdal.OF_
-00005240: 5550 4441 5445 290a 2020 2020 2020 2020  UPDATE).        
-00005250: 2020 2020 7265 7375 6c74 203d 2064 6174      result = dat
-00005260: 6173 6f75 7263 652e 4578 6563 7574 6553  asource.ExecuteS
-00005270: 514c 280a 2020 2020 2020 2020 2020 2020  QL(.            
-00005280: 2020 2020 6622 5345 4c45 4354 2044 6973      f"SELECT Dis
-00005290: 6162 6c65 5370 6174 6961 6c49 6e64 6578  ableSpatialIndex
-000052a0: 2827 7b6c 6179 6572 696e 666f 2e6e 616d  ('{layerinfo.nam
-000052b0: 657d 272c 2027 7b6c 6179 6572 696e 666f  e}', '{layerinfo
-000052c0: 2e67 656f 6d65 7472 7963 6f6c 756d 6e7d  .geometrycolumn}
-000052d0: 2729 222c 2020 2320 6e6f 7161 3a20 4535  ')",  # noqa: E5
-000052e0: 3031 0a20 2020 2020 2020 2020 2020 2020  01.             
-000052f0: 2020 2064 6961 6c65 6374 3d22 5351 4c49     dialect="SQLI
-00005300: 5445 222c 0a20 2020 2020 2020 2020 2020  TE",.           
-00005310: 2029 0a20 2020 2020 2020 2020 2020 2064   ).            d
-00005320: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
-00005330: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
-00005340: 7429 0a20 2020 2020 2020 2065 6c69 6620  t).        elif 
-00005350: 6765 6f66 696c 6574 7970 6520 3d3d 2047  geofiletype == G
-00005360: 656f 6669 6c65 5479 7065 2e45 5352 4953  eofileType.ESRIS
-00005370: 6861 7065 6669 6c65 3a0a 2020 2020 2020  hapefile:.      
-00005380: 2020 2020 2020 2320 4452 4f50 2053 5041        # DROP SPA
-00005390: 5449 414c 2049 4e44 4558 204f 4e20 2e2e  TIAL INDEX ON ..
-000053a0: 2e20 636f 6d6d 616e 6420 6769 7665 7320  . command gives 
-000053b0: 616e 2065 7272 6f72 2c20 736f 206a 7573  an error, so jus
-000053c0: 7420 7265 6d6f 7665 202e 7169 780a 2020  t remove .qix.  
-000053d0: 2020 2020 2020 2020 2020 696e 6465 785f            index_
-000053e0: 7061 7468 203d 2070 6174 682e 7061 7265  path = path.pare
-000053f0: 6e74 202f 2066 227b 7061 7468 2e73 7465  nt / f"{path.ste
-00005400: 6d7d 2e71 6978 220a 2020 2020 2020 2020  m}.qix".        
-00005410: 2020 2020 696e 6465 785f 7061 7468 2e75      index_path.u
-00005420: 6e6c 696e 6b28 290a 2020 2020 2020 2020  nlink().        
-00005430: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005440: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00005450: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00005460: 2020 2020 2020 6622 7265 6d6f 7665 5f73        f"remove_s
-00005470: 7061 7469 616c 5f69 6e64 6578 2069 7320  patial_index is 
-00005480: 6e6f 7420 7375 7070 6f72 7465 6420 666f  not supported fo
-00005490: 7220 7b70 6174 682e 7375 6666 6978 7d20  r {path.suffix} 
-000054a0: 6669 6c65 220a 2020 2020 2020 2020 2020  file".          
-000054b0: 2020 290a 0a20 2020 2065 7863 6570 7420    )..    except 
-000054c0: 4578 6365 7074 696f 6e20 6173 2065 783a  Exception as ex:
-000054d0: 0a20 2020 2020 2020 2065 782e 6172 6773  .        ex.args
-000054e0: 203d 2028 6622 7265 6d6f 7665 5f73 7061   = (f"remove_spa
-000054f0: 7469 616c 5f69 6e64 6578 2065 7272 6f72  tial_index error
-00005500: 2066 6f72 207b 7061 7468 7d2e 7b6c 6179   for {path}.{lay
-00005510: 6572 7d3a 5c6e 2020 7b65 787d 222c 290a  er}:\n  {ex}",).
-00005520: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
-00005530: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-00005540: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-00005550: 4e6f 6e65 0a0a 0a64 6566 2072 656e 616d  None...def renam
-00005560: 655f 6c61 7965 7228 0a20 2020 2070 6174  e_layer(.    pat
-00005570: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-00005580: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-00005590: 5d2c 206e 6577 5f6c 6179 6572 3a20 7374  ], new_layer: st
-000055a0: 722c 206c 6179 6572 3a20 4f70 7469 6f6e  r, layer: Option
-000055b0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 0a29  al[str] = None.)
-000055c0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-000055d0: 6e61 6d65 2074 6865 206c 6179 6572 2073  name the layer s
-000055e0: 7065 6369 6669 6564 2e0a 0a20 2020 2041  pecified...    A
-000055f0: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-00005600: 6820 2850 6174 684c 696b 6529 3a20 5468  h (PathLike): Th
-00005610: 6520 6669 6c65 2070 6174 682e 0a20 2020  e file path..   
-00005620: 2020 2020 206c 6179 6572 2028 4f70 7469       layer (Opti
-00005630: 6f6e 616c 5b73 7472 5d29 3a20 5468 6520  onal[str]): The 
-00005640: 6c61 7965 7220 6e61 6d65 2e20 4966 206e  layer name. If n
-00005650: 6f74 2073 7065 6369 6669 6564 2c20 616e  ot specified, an
-00005660: 6420 7468 6572 6520 6973 206f 6e6c 790a  d there is only.
-00005670: 2020 2020 2020 2020 2020 2020 6f6e 6520              one 
-00005680: 6c61 7965 7220 696e 2074 6865 2066 696c  layer in the fil
-00005690: 652c 2074 6869 7320 6c61 7965 7220 6973  e, this layer is
-000056a0: 2075 7365 642e 204f 7468 6572 7769 7365   used. Otherwise
-000056b0: 2065 7863 6570 7469 6f6e 2e0a 2020 2020   exception..    
-000056c0: 2020 2020 6e65 775f 6c61 7965 7220 2873      new_layer (s
-000056d0: 7472 293a 2054 6865 206e 6577 206c 6179  tr): The new lay
-000056e0: 6572 206e 616d 652e 2049 6620 6e6f 7420  er name. If not 
-000056f0: 7370 6563 6966 6965 642c 2061 6e64 2074  specified, and t
-00005700: 6865 7265 2069 7320 6f6e 6c79 0a20 2020  here is only.   
-00005710: 2020 2020 2020 2020 206f 6e65 206c 6179           one lay
-00005720: 6572 2069 6e20 7468 6520 6669 6c65 2c20  er in the file, 
-00005730: 7468 6973 206c 6179 6572 2069 7320 7573  this layer is us
-00005740: 6564 2e20 4f74 6865 7277 6973 6520 6578  ed. Otherwise ex
-00005750: 6365 7074 696f 6e2e 0a20 2020 2022 2222  ception..    """
-00005760: 0a20 2020 2023 2043 6865 636b 2069 6e70  .    # Check inp
-00005770: 7574 2070 6172 616d 6574 6572 730a 2020  ut parameters.  
-00005780: 2020 7061 7468 203d 2050 6174 6828 7061    path = Path(pa
-00005790: 7468 290a 2020 2020 6966 206c 6179 6572  th).    if layer
-000057a0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000057b0: 2020 6c61 7965 7220 3d20 6765 745f 6f6e    layer = get_on
-000057c0: 6c79 5f6c 6179 6572 2870 6174 6829 0a0a  ly_layer(path)..
-000057d0: 2020 2020 2320 4e6f 7720 7265 616c 6c79      # Now really
-000057e0: 2072 656e 616d 650a 2020 2020 6461 7461   rename.    data
-000057f0: 736f 7572 6365 203d 204e 6f6e 650a 2020  source = None.  
-00005800: 2020 6765 6f66 696c 6574 7970 6520 3d20    geofiletype = 
-00005810: 4765 6f66 696c 6554 7970 6528 7061 7468  GeofileType(path
-00005820: 290a 2020 2020 6966 2067 656f 6669 6c65  ).    if geofile
-00005830: 7479 7065 2e69 735f 7370 6174 6961 6c69  type.is_spatiali
-00005840: 7465 5f62 6173 6564 3a0a 2020 2020 2020  te_based:.      
-00005850: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00005860: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-00005870: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
-00005880: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
-00005890: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
-000058a0: 290a 2020 2020 2020 2020 2020 2020 7371  ).            sq
-000058b0: 6c5f 7374 6d74 203d 2066 2741 4c54 4552  l_stmt = f'ALTER
-000058c0: 2054 4142 4c45 2022 7b6c 6179 6572 7d22   TABLE "{layer}"
-000058d0: 2052 454e 414d 4520 544f 2022 7b6e 6577   RENAME TO "{new
-000058e0: 5f6c 6179 6572 7d22 270a 2020 2020 2020  _layer}"'.      
-000058f0: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
-00005900: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
-00005910: 6553 514c 2873 716c 5f73 746d 7429 0a20  eSQL(sql_stmt). 
-00005920: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-00005930: 6f75 7263 652e 5265 6c65 6173 6552 6573  ource.ReleaseRes
-00005940: 756c 7453 6574 2872 6573 756c 7429 0a20  ultSet(result). 
-00005950: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00005960: 6365 7074 696f 6e20 6173 2065 783a 0a20  ception as ex:. 
-00005970: 2020 2020 2020 2020 2020 2065 782e 6172             ex.ar
-00005980: 6773 203d 2028 6622 7265 6e61 6d65 5f6c  gs = (f"rename_l
-00005990: 6179 6572 2065 7272 6f72 2066 6f72 207b  ayer error for {
-000059a0: 7061 7468 7d2e 7b6c 6179 6572 7d3a 5c6e  path}.{layer}:\n
-000059b0: 2020 7b65 787d 222c 290a 2020 2020 2020    {ex}",).      
-000059c0: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
-000059d0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-000059e0: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
-000059f0: 7263 6520 3d20 4e6f 6e65 0a20 2020 2065  rce = None.    e
-00005a00: 6c69 6620 6765 6f66 696c 6574 7970 6520  lif geofiletype 
-00005a10: 3d3d 2047 656f 6669 6c65 5479 7065 2e45  == GeofileType.E
-00005a20: 5352 4953 6861 7065 6669 6c65 3a0a 2020  SRIShapefile:.  
-00005a30: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00005a40: 6545 7272 6f72 2866 2272 656e 616d 655f  eError(f"rename_
-00005a50: 6c61 7965 7220 6e6f 7420 706f 7373 6962  layer not possib
-00005a60: 6c65 2066 6f72 207b 6765 6f66 696c 6574  le for {geofilet
-00005a70: 7970 657d 2066 696c 6522 290a 2020 2020  ype} file").    
-00005a80: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
-00005a90: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00005aa0: 2272 656e 616d 655f 6c61 7965 7220 6e6f  "rename_layer no
-00005ab0: 7420 696d 706c 656d 656e 7465 6420 666f  t implemented fo
-00005ac0: 7220 7b70 6174 682e 7375 6666 6978 7d20  r {path.suffix} 
-00005ad0: 6669 6c65 2229 0a0a 0a64 6566 2072 656e  file")...def ren
-00005ae0: 616d 655f 636f 6c75 6d6e 280a 2020 2020  ame_column(.    
-00005af0: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
-00005b00: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
-00005b10: 795d 225d 2c0a 2020 2020 636f 6c75 6d6e  y]"],.    column
-00005b20: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
-00005b30: 6e65 775f 636f 6c75 6d6e 5f6e 616d 653a  new_column_name:
-00005b40: 2073 7472 2c0a 2020 2020 6c61 7965 723a   str,.    layer:
-00005b50: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00005b60: 204e 6f6e 652c 0a29 3a0a 2020 2020 2222   None,.):.    ""
-00005b70: 220a 2020 2020 5265 6e61 6d65 2074 6865  ".    Rename the
-00005b80: 2063 6f6c 756d 6e20 7370 6563 6966 6965   column specifie
-00005b90: 642e 0a0a 2020 2020 4172 6773 3a0a 2020  d...    Args:.  
-00005ba0: 2020 2020 2020 7061 7468 2028 5061 7468        path (Path
-00005bb0: 4c69 6b65 293a 2054 6865 2066 696c 6520  Like): The file 
-00005bc0: 7061 7468 2e0a 2020 2020 2020 2020 636f  path..        co
-00005bd0: 6c75 6d6e 5f6e 616d 6520 2873 7472 293a  lumn_name (str):
-00005be0: 2074 6865 2063 7572 7265 6e74 2063 6f6c   the current col
-00005bf0: 756d 6e20 6e61 6d65 2e0a 2020 2020 2020  umn name..      
-00005c00: 2020 6e65 775f 636f 6c75 6d6e 5f6e 616d    new_column_nam
-00005c10: 6520 2873 7472 293a 2074 6865 206e 6577  e (str): the new
-00005c20: 2063 6f6c 756d 6e20 6e61 6d65 2e0a 2020   column name..  
-00005c30: 2020 2020 2020 6c61 7965 7220 284f 7074        layer (Opt
-00005c40: 696f 6e61 6c5b 7374 725d 293a 2054 6865  ional[str]): The
-00005c50: 206c 6179 6572 206e 616d 652e 2049 6620   layer name. If 
-00005c60: 6e6f 7420 7370 6563 6966 6965 642c 2061  not specified, a
-00005c70: 6e64 2074 6865 7265 2069 7320 6f6e 6c79  nd there is only
-00005c80: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
-00005c90: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
-00005ca0: 6c65 2c20 7468 6973 206c 6179 6572 2069  le, this layer i
-00005cb0: 7320 7573 6564 2e20 4f74 6865 7277 6973  s used. Otherwis
-00005cc0: 6520 6578 6365 7074 696f 6e2e 0a20 2020  e exception..   
-00005cd0: 2022 2222 0a20 2020 2023 2043 6865 636b   """.    # Check
-00005ce0: 2069 6e70 7574 2070 6172 616d 6574 6572   input parameter
-00005cf0: 730a 2020 2020 7061 7468 203d 2050 6174  s.    path = Pat
-00005d00: 6828 7061 7468 290a 2020 2020 6966 206c  h(path).    if l
-00005d10: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
-00005d20: 2020 2020 2020 6c61 7965 7220 3d20 6765        layer = ge
-00005d30: 745f 6f6e 6c79 5f6c 6179 6572 2870 6174  t_only_layer(pat
-00005d40: 6829 0a20 2020 2069 6e66 6f20 3d20 6765  h).    info = ge
-00005d50: 745f 6c61 7965 7269 6e66 6f28 7061 7468  t_layerinfo(path
-00005d60: 2c20 6c61 7965 7229 0a20 2020 2069 6620  , layer).    if 
-00005d70: 636f 6c75 6d6e 5f6e 616d 6520 6e6f 7420  column_name not 
-00005d80: 696e 2069 6e66 6f2e 636f 6c75 6d6e 7320  in info.columns 
-00005d90: 616e 6420 6e65 775f 636f 6c75 6d6e 5f6e  and new_column_n
-00005da0: 616d 6520 696e 2069 6e66 6f2e 636f 6c75  ame in info.colu
-00005db0: 6d6e 733a 0a20 2020 2020 2020 206c 6f67  mns:.        log
-00005dc0: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
-00005dd0: 2020 2020 2020 6622 436f 6c75 6d6e 207b        f"Column {
-00005de0: 636f 6c75 6d6e 5f6e 616d 657d 2073 6565  column_name} see
-00005df0: 6d73 2074 6f20 6265 2072 656e 616d 6564  ms to be renamed
-00005e00: 2061 6c72 6561 6479 2074 6f20 7b6e 6577   already to {new
-00005e10: 5f63 6f6c 756d 6e5f 6e61 6d65 7d22 0a20  _column_name}". 
-00005e20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00005e30: 2072 6574 7572 6e0a 0a20 2020 2023 204e   return..    # N
-00005e40: 6f77 2072 6561 6c6c 7920 7265 6e61 6d65  ow really rename
-00005e50: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-00005e60: 3d20 4e6f 6e65 0a20 2020 2067 656f 6669  = None.    geofi
-00005e70: 6c65 7479 7065 203d 2047 656f 6669 6c65  letype = Geofile
-00005e80: 5479 7065 2870 6174 6829 0a20 2020 2069  Type(path).    i
-00005e90: 6620 6765 6f66 696c 6574 7970 652e 6973  f geofiletype.is
-00005ea0: 5f73 7061 7469 616c 6974 655f 6261 7365  _spatialite_base
-00005eb0: 643a 0a20 2020 2020 2020 2074 7279 3a0a  d:.        try:.
-00005ec0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00005ed0: 736f 7572 6365 203d 2067 6461 6c2e 4f70  source = gdal.Op
-00005ee0: 656e 4578 2873 7472 2870 6174 6829 2c20  enEx(str(path), 
-00005ef0: 6e4f 7065 6e46 6c61 6773 3d67 6461 6c2e  nOpenFlags=gdal.
-00005f00: 4f46 5f55 5044 4154 4529 0a20 2020 2020  OF_UPDATE).     
-00005f10: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
-00005f20: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00005f30: 2020 2020 6627 414c 5445 5220 5441 424c      f'ALTER TABL
-00005f40: 4520 227b 6c61 7965 727d 2220 270a 2020  E "{layer}" '.  
-00005f50: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00005f60: 5245 4e41 4d45 2043 4f4c 554d 4e20 227b  RENAME COLUMN "{
-00005f70: 636f 6c75 6d6e 5f6e 616d 657d 2220 544f  column_name}" TO
-00005f80: 2022 7b6e 6577 5f63 6f6c 756d 6e5f 6e61   "{new_column_na
-00005f90: 6d65 7d22 270a 2020 2020 2020 2020 2020  me}"'.          
-00005fa0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00005fb0: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
-00005fc0: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
-00005fd0: 716c 5f73 746d 7429 0a20 2020 2020 2020  ql_stmt).       
-00005fe0: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
-00005ff0: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
-00006000: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-00006010: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00006020: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-00006030: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
-00006040: 6622 7265 6e61 6d65 5f63 6f6c 756d 6e20  f"rename_column 
-00006050: 6572 726f 7220 666f 7220 7b70 6174 687d  error for {path}
-00006060: 2e7b 6c61 7965 727d 3a5c 6e20 207b 6578  .{layer}:\n  {ex
-00006070: 7d22 2c29 0a20 2020 2020 2020 2020 2020  }",).           
-00006080: 2072 6169 7365 0a20 2020 2020 2020 2066   raise.        f
-00006090: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-000060a0: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-000060b0: 204e 6f6e 650a 0a20 2020 2065 6c69 6620   None..    elif 
-000060c0: 6765 6f66 696c 6574 7970 6520 3d3d 2047  geofiletype == G
-000060d0: 656f 6669 6c65 5479 7065 2e45 5352 4953  eofileType.ESRIS
-000060e0: 6861 7065 6669 6c65 3a0a 2020 2020 2020  hapefile:.      
-000060f0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00006100: 6f72 2866 2272 656e 616d 655f 636f 6c75  or(f"rename_colu
-00006110: 6d6e 2069 7320 6e6f 7420 706f 7373 6962  mn is not possib
-00006120: 6c65 2066 6f72 207b 6765 6f66 696c 6574  le for {geofilet
-00006130: 7970 657d 2066 696c 6522 290a 2020 2020  ype} file").    
-00006140: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
-00006150: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00006160: 2272 656e 616d 655f 636f 6c75 6d6e 2069  "rename_column i
-00006170: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-00006180: 6420 666f 7220 7b70 6174 682e 7375 6666  d for {path.suff
-00006190: 6978 7d20 6669 6c65 2229 0a0a 0a63 6c61  ix} file")...cla
-000061a0: 7373 2044 6174 6154 7970 6528 656e 756d  ss DataType(enum
-000061b0: 2e45 6e75 6d29 3a0a 2020 2020 2222 220a  .Enum):.    """.
-000061c0: 2020 2020 5468 6973 2065 6e75 6d20 6465      This enum de
-000061d0: 6669 6e65 7320 7468 6520 7374 616e 6461  fines the standa
-000061e0: 7264 2064 6174 6120 7479 7065 7320 7468  rd data types th
-000061f0: 6174 2063 616e 2062 6520 7573 6564 2066  at can be used f
-00006200: 6f72 2063 6f6c 756d 6e73 2e0a 2020 2020  or columns..    
-00006210: 2222 220a 0a20 2020 2054 4558 5420 3d20  """..    TEXT = 
-00006220: 2254 4558 5422 0a20 2020 2022 2222 436f  "TEXT".    """Co
-00006230: 6c75 6d6e 2077 6974 6820 7465 7874 2064  lumn with text d
-00006240: 6174 613a 207e 2073 7472 696e 672c 2063  ata: ~ string, c
-00006250: 6861 722c 2076 6172 6368 6172 2c20 636c  har, varchar, cl
-00006260: 6f62 2e22 2222 0a20 2020 2049 4e54 4547  ob.""".    INTEG
-00006270: 4552 203d 2022 494e 5445 4745 5222 0a20  ER = "INTEGER". 
-00006280: 2020 2022 2222 436f 6c75 6d6e 2077 6974     """Column wit
-00006290: 6820 696e 7465 6765 7220 6461 7461 2e22  h integer data."
-000062a0: 2222 0a20 2020 2052 4541 4c20 3d20 2252  "".    REAL = "R
-000062b0: 4541 4c22 0a20 2020 2022 2222 436f 6c75  EAL".    """Colu
-000062c0: 6d6e 2077 6974 6820 666c 6f61 7469 6e67  mn with floating
-000062d0: 2070 6f69 6e74 2064 6174 613a 207e 2066   point data: ~ f
-000062e0: 6c6f 6174 2c20 646f 7562 6c65 2e22 2222  loat, double."""
-000062f0: 0a20 2020 2044 4154 4520 3d20 2244 4154  .    DATE = "DAT
-00006300: 4522 0a20 2020 2022 2222 436f 6c75 6d6e  E".    """Column
-00006310: 2077 6974 6820 6461 7465 2064 6174 612e   with date data.
-00006320: 2222 220a 2020 2020 5449 4d45 5354 414d  """.    TIMESTAM
-00006330: 5020 3d20 2254 494d 4553 5441 4d50 220a  P = "TIMESTAMP".
-00006340: 2020 2020 2222 2243 6f6c 756d 6e20 7769      """Column wi
-00006350: 7468 2074 696d 6573 7461 6d70 2064 6174  th timestamp dat
-00006360: 613a 207e 2064 6174 6574 696d 652e 2222  a: ~ datetime.""
-00006370: 220a 2020 2020 424f 4f4c 4541 4e20 3d20  ".    BOOLEAN = 
-00006380: 2242 4f4f 4c45 414e 220a 2020 2020 2222  "BOOLEAN".    ""
-00006390: 2243 6f6c 756d 6e20 7769 7468 2062 6f6f  "Column with boo
-000063a0: 6c65 616e 2064 6174 612e 2222 220a 2020  lean data.""".  
-000063b0: 2020 424c 4f42 203d 2022 424c 4f42 220a    BLOB = "BLOB".
-000063c0: 2020 2020 2222 2243 6f6c 756d 6e20 7769      """Column wi
-000063d0: 7468 2062 696e 6172 7920 6461 7461 2e22  th binary data."
-000063e0: 2222 0a20 2020 204e 554d 4552 4943 203d  "".    NUMERIC =
-000063f0: 2022 4e55 4d45 5249 4322 0a20 2020 2022   "NUMERIC".    "
-00006400: 2222 436f 6c75 6d6e 2077 6974 6820 6e75  ""Column with nu
-00006410: 6d65 7269 6320 6461 7461 3a20 6578 6163  meric data: exac
-00006420: 7420 6465 6369 6d61 6c20 6461 7461 2e22  t decimal data."
-00006430: 2222 0a0a 0a64 6566 2061 6464 5f63 6f6c  ""...def add_col
-00006440: 756d 6e28 0a20 2020 2070 6174 683a 2055  umn(.    path: U
-00006450: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
-00006460: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
-00006470: 2020 206e 616d 653a 2073 7472 2c0a 2020     name: str,.  
-00006480: 2020 7479 7065 3a20 556e 696f 6e5b 4461    type: Union[Da
-00006490: 7461 5479 7065 2c20 7374 725d 2c0a 2020  taType, str],.  
-000064a0: 2020 6578 7072 6573 7369 6f6e 3a20 556e    expression: Un
-000064b0: 696f 6e5b 7374 722c 2069 6e74 2c20 666c  ion[str, int, fl
-000064c0: 6f61 742c 204e 6f6e 655d 203d 204e 6f6e  oat, None] = Non
-000064d0: 652c 0a20 2020 2065 7870 7265 7373 696f  e,.    expressio
-000064e0: 6e5f 6469 616c 6563 743a 204f 7074 696f  n_dialect: Optio
-000064f0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
-00006500: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
-00006510: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00006520: 2c0a 2020 2020 666f 7263 655f 7570 6461  ,.    force_upda
-00006530: 7465 3a20 626f 6f6c 203d 2046 616c 7365  te: bool = False
-00006540: 2c0a 2020 2020 7769 6474 683a 204f 7074  ,.    width: Opt
-00006550: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
-00006560: 652c 0a29 3a0a 2020 2020 2222 220a 2020  e,.):.    """.  
-00006570: 2020 4164 6420 6120 636f 6c75 6d6e 2074    Add a column t
-00006580: 6f20 6120 6c61 7965 7220 6f66 2074 6865  o a layer of the
-00006590: 2067 656f 6669 6c65 2e0a 0a20 2020 2041   geofile...    A
-000065a0: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-000065b0: 6820 2850 6174 684c 696b 6529 3a20 5061  h (PathLike): Pa
-000065c0: 7468 2074 6f20 7468 6520 6765 6f66 696c  th to the geofil
-000065d0: 652e 0a20 2020 2020 2020 206e 616d 6520  e..        name 
-000065e0: 2873 7472 293a 204e 616d 6520 666f 7220  (str): Name for 
-000065f0: 7468 6520 6e65 7720 636f 6c75 6d6e 2e0a  the new column..
-00006600: 2020 2020 2020 2020 7479 7065 2028 7374          type (st
-00006610: 7229 3a20 436f 6c75 6d6e 2074 7970 6520  r): Column type 
-00006620: 6f66 2074 6865 206e 6577 2063 6f6c 756d  of the new colum
-00006630: 6e2e 0a20 2020 2020 2020 2065 7870 7265  n..        expre
-00006640: 7373 696f 6e20 2873 7472 2c20 6f70 7469  ssion (str, opti
-00006650: 6f6e 616c 293a 2053 514c 6974 6520 6578  onal): SQLite ex
-00006660: 7072 6573 7369 6f6e 2074 6f20 7573 6520  pression to use 
-00006670: 746f 2075 7064 6174 650a 2020 2020 2020  to update.      
-00006680: 2020 2020 2020 7468 6520 7661 6c75 652e        the value.
-00006690: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-000066a0: 652e 0a20 2020 2020 2020 2065 7870 7265  e..        expre
-000066b0: 7373 696f 6e5f 6469 616c 6563 7420 2873  ssion_dialect (s
-000066c0: 7472 2c20 6f70 7469 6f6e 616c 293a 2053  tr, optional): S
-000066d0: 514c 2064 6961 6c65 6374 2075 7365 6420  QL dialect used 
-000066e0: 666f 7220 7468 6520 6578 7072 6573 7369  for the expressi
-000066f0: 6f6e 2e0a 2020 2020 2020 2020 6c61 7965  on..        laye
-00006700: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
-00006710: 293a 2054 6865 206c 6179 6572 206e 616d  ): The layer nam
-00006720: 652e 2049 6620 4e6f 6e65 2061 6e64 2074  e. If None and t
-00006730: 6865 2067 656f 6669 6c65 0a20 2020 2020  he geofile.     
-00006740: 2020 2020 2020 2068 6173 206f 6e6c 7920         has only 
-00006750: 6f6e 6520 6c61 7965 722c 2074 6861 7420  one layer, that 
-00006760: 6c61 7965 7220 6973 2075 7365 642e 2044  layer is used. D
-00006770: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-00006780: 0a20 2020 2020 2020 2066 6f72 6365 5f75  .        force_u
-00006790: 7064 6174 6520 2862 6f6f 6c2c 206f 7074  pdate (bool, opt
-000067a0: 696f 6e61 6c29 3a20 4966 2074 6865 2063  ional): If the c
-000067b0: 6f6c 756d 6e20 616c 7265 6164 7920 6578  olumn already ex
-000067c0: 6973 7473 2c20 6578 6563 7574 650a 2020  ists, execute.  
-000067d0: 2020 2020 2020 2020 2020 7468 6520 7570            the up
-000067e0: 6461 7465 2061 6e79 7761 792e 2044 6566  date anyway. Def
-000067f0: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
-00006800: 2020 2020 2020 2020 7769 6474 6820 2869          width (i
-00006810: 6e74 2c20 6f70 7469 6f6e 616c 293a 2074  nt, optional): t
-00006820: 6865 2077 6964 7468 206f 6620 7468 6520  he width of the 
-00006830: 6669 656c 642e 0a0a 2020 2020 5261 6973  field...    Rais
-00006840: 6573 3a0a 2020 2020 2020 2020 6578 3a20  es:.        ex: 
-00006850: 5b64 6573 6372 6970 7469 6f6e 5d0a 2020  [description].  
-00006860: 2020 2222 220a 2020 2020 2320 496e 6974    """.    # Init
-00006870: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00006880: 6365 2874 7970 652c 2044 6174 6154 7970  ce(type, DataTyp
-00006890: 6529 3a0a 2020 2020 2020 2020 7479 7065  e):.        type
-000068a0: 5f73 7472 203d 2074 7970 652e 7661 6c75  _str = type.valu
-000068b0: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-000068c0: 2020 2020 7479 7065 5f6c 6f77 6572 203d      type_lower =
-000068d0: 2074 7970 652e 6c6f 7765 7228 290a 2020   type.lower().  
-000068e0: 2020 2020 2020 6966 2074 7970 655f 6c6f        if type_lo
-000068f0: 7765 7220 3d3d 2022 7374 7269 6e67 223a  wer == "string":
-00006900: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00006910: 4f44 4f3a 2074 6869 6e6b 2077 6865 7468  ODO: think wheth
-00006920: 6572 2062 6569 6e67 2066 6c65 7869 626c  er being flexibl
-00006930: 6520 6865 7265 2069 7320 6120 676f 6f64  e here is a good
-00006940: 2069 6465 612e 2e2e 0a20 2020 2020 2020   idea....       
-00006950: 2020 2020 2074 7970 655f 7374 7220 3d20       type_str = 
-00006960: 2254 4558 5422 0a20 2020 2020 2020 2065  "TEXT".        e
-00006970: 6c69 6620 7479 7065 5f6c 6f77 6572 203d  lif type_lower =
-00006980: 3d20 2262 696e 6172 7922 3a0a 2020 2020  = "binary":.    
-00006990: 2020 2020 2020 2020 7479 7065 5f73 7472          type_str
-000069a0: 203d 2022 424c 4f42 220a 2020 2020 2020   = "BLOB".      
-000069b0: 2020 656c 6966 2074 7970 655f 6c6f 7765    elif type_lowe
-000069c0: 7220 3d3d 2022 7469 6d65 223a 0a20 2020  r == "time":.   
-000069d0: 2020 2020 2020 2020 2074 7970 655f 7374           type_st
-000069e0: 7220 3d20 2244 4154 4554 494d 4522 0a20  r = "DATETIME". 
-000069f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00006a00: 2020 2020 2020 2020 2074 7970 655f 7374           type_st
-00006a10: 7220 3d20 7479 7065 0a20 2020 2070 6174  r = type.    pat
-00006a20: 6820 3d20 5061 7468 2870 6174 6829 0a20  h = Path(path). 
-00006a30: 2020 2069 6620 6c61 7965 7220 6973 204e     if layer is N
-00006a40: 6f6e 653a 0a20 2020 2020 2020 206c 6179  one:.        lay
-00006a50: 6572 203d 2067 6574 5f6f 6e6c 795f 6c61  er = get_only_la
-00006a60: 7965 7228 7061 7468 290a 2020 2020 6c61  yer(path).    la
-00006a70: 7965 7269 6e66 6f5f 6f72 6967 203d 2067  yerinfo_orig = g
-00006a80: 6574 5f6c 6179 6572 696e 666f 2870 6174  et_layerinfo(pat
-00006a90: 682c 206c 6179 6572 290a 0a20 2020 2023  h, layer)..    #
-00006aa0: 2047 6f21 0a20 2020 2064 6174 6173 6f75   Go!.    datasou
-00006ab0: 7263 6520 3d20 4e6f 6e65 0a20 2020 2074  rce = None.    t
-00006ac0: 7279 3a0a 2020 2020 2020 2020 2320 4966  ry:.        # If
-00006ad0: 2063 6f6c 756d 6e20 646f 6573 6e27 7420   column doesn't 
-00006ae0: 6578 6973 7420 7965 742c 2063 7265 6174  exist yet, creat
-00006af0: 6520 6974 0a20 2020 2020 2020 2063 6f6c  e it.        col
-00006b00: 756d 6e73 5f75 7070 6572 203d 205b 636f  umns_upper = [co
-00006b10: 6c75 6d6e 2e75 7070 6572 2829 2066 6f72  lumn.upper() for
-00006b20: 2063 6f6c 756d 6e20 696e 206c 6179 6572   column in layer
-00006b30: 696e 666f 5f6f 7269 672e 636f 6c75 6d6e  info_orig.column
-00006b40: 735d 0a20 2020 2020 2020 2069 6620 6e61  s].        if na
-00006b50: 6d65 2e75 7070 6572 2829 206e 6f74 2069  me.upper() not i
-00006b60: 6e20 636f 6c75 6d6e 735f 7570 7065 723a  n columns_upper:
-00006b70: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-00006b80: 7468 5f73 7472 203d 2066 2228 7b77 6964  th_str = f"({wid
-00006b90: 7468 7d29 2220 6966 2077 6964 7468 2069  th})" if width i
-00006ba0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-00006bb0: 2222 0a20 2020 2020 2020 2020 2020 2073  "".            s
-00006bc0: 716c 5f73 746d 7420 3d20 280a 2020 2020  ql_stmt = (.    
-00006bd0: 2020 2020 2020 2020 2020 2020 6627 414c              f'AL
-00006be0: 5445 5220 5441 424c 4520 227b 6c61 7965  TER TABLE "{laye
-00006bf0: 727d 2220 4144 4420 434f 4c55 4d4e 2022  r}" ADD COLUMN "
-00006c00: 7b6e 616d 657d 2220 7b74 7970 655f 7374  {name}" {type_st
-00006c10: 727d 7b77 6964 7468 5f73 7472 7d27 0a20  r}{width_str}'. 
-00006c20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00006c30: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
-00006c40: 7263 6520 3d20 6764 616c 2e4f 7065 6e45  rce = gdal.OpenE
-00006c50: 7828 7374 7228 7061 7468 292c 206e 4f70  x(str(path), nOp
-00006c60: 656e 466c 6167 733d 6764 616c 2e4f 465f  enFlags=gdal.OF_
-00006c70: 5550 4441 5445 290a 2020 2020 2020 2020  UPDATE).        
-00006c80: 2020 2020 7265 7375 6c74 203d 2064 6174      result = dat
-00006c90: 6173 6f75 7263 652e 4578 6563 7574 6553  asource.ExecuteS
-00006ca0: 514c 2873 716c 5f73 746d 7429 0a20 2020  QL(sql_stmt).   
-00006cb0: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
-00006cc0: 7263 652e 5265 6c65 6173 6552 6573 756c  rce.ReleaseResul
-00006cd0: 7453 6574 2872 6573 756c 7429 0a20 2020  tSet(result).   
-00006ce0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006cf0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00006d00: 726e 696e 6728 6622 436f 6c75 6d6e 207b  rning(f"Column {
-00006d10: 6e61 6d65 7d20 6578 6973 7465 6420 616c  name} existed al
-00006d20: 7265 6164 7920 696e 207b 7061 7468 7d2c  ready in {path},
-00006d30: 206c 6179 6572 207b 6c61 7965 727d 2229   layer {layer}")
-00006d40: 0a0a 2020 2020 2020 2020 2320 4966 2061  ..        # If a
-00006d50: 6e20 6578 7072 6573 7369 6f6e 2077 6173  n expression was
-00006d60: 2070 726f 7669 6465 6420 616e 6420 7570   provided and up
-00006d70: 6461 7465 2063 616e 2062 6520 646f 6e65  date can be done
-00006d80: 2c20 676f 2066 6f72 2069 742e 2e2e 0a20  , go for it.... 
-00006d90: 2020 2020 2020 2069 6620 6578 7072 6573         if expres
-00006da0: 7369 6f6e 2069 7320 6e6f 7420 4e6f 6e65  sion is not None
-00006db0: 2061 6e64 2028 0a20 2020 2020 2020 2020   and (.         
-00006dc0: 2020 206e 616d 6520 6e6f 7420 696e 206c     name not in l
-00006dd0: 6179 6572 696e 666f 5f6f 7269 672e 636f  ayerinfo_orig.co
-00006de0: 6c75 6d6e 7320 6f72 2066 6f72 6365 5f75  lumns or force_u
-00006df0: 7064 6174 6520 6973 2054 7275 650a 2020  pdate is True.  
-00006e00: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00006e10: 2020 2020 2069 6620 6461 7461 736f 7572       if datasour
-00006e20: 6365 2069 7320 4e6f 6e65 3a0a 2020 2020  ce is None:.    
-00006e30: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00006e40: 736f 7572 6365 203d 2067 6461 6c2e 4f70  source = gdal.Op
-00006e50: 656e 4578 2873 7472 2870 6174 6829 2c20  enEx(str(path), 
-00006e60: 6e4f 7065 6e46 6c61 6773 3d67 6461 6c2e  nOpenFlags=gdal.
-00006e70: 4f46 5f55 5044 4154 4529 0a20 2020 2020  OF_UPDATE).     
-00006e80: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
-00006e90: 3d20 6627 5550 4441 5445 2022 7b6c 6179  = f'UPDATE "{lay
-00006ea0: 6572 7d22 2053 4554 2022 7b6e 616d 657d  er}" SET "{name}
-00006eb0: 2220 3d20 7b65 7870 7265 7373 696f 6e7d  " = {expression}
-00006ec0: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-00006ed0: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
-00006ee0: 652e 4578 6563 7574 6553 514c 2873 716c  e.ExecuteSQL(sql
-00006ef0: 5f73 746d 742c 2064 6961 6c65 6374 3d65  _stmt, dialect=e
-00006f00: 7870 7265 7373 696f 6e5f 6469 616c 6563  xpression_dialec
-00006f10: 7429 0a20 2020 2020 2020 2020 2020 2064  t).            d
-00006f20: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
-00006f30: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
-00006f40: 7429 0a0a 2020 2020 6578 6365 7074 2045  t)..    except E
-00006f50: 7863 6570 7469 6f6e 2061 7320 6578 3a0a  xception as ex:.
-00006f60: 2020 2020 2020 2020 6578 2e61 7267 7320          ex.args 
-00006f70: 3d20 2866 2261 6464 5f63 6f6c 756d 6e20  = (f"add_column 
-00006f80: 6572 726f 7220 666f 7220 7b70 6174 687d  error for {path}
-00006f90: 2e7b 6c61 7965 727d 3a5c 6e20 207b 6578  .{layer}:\n  {ex
-00006fa0: 7d22 2c29 0a20 2020 2020 2020 2072 6169  }",).        rai
-00006fb0: 7365 0a20 2020 2066 696e 616c 6c79 3a0a  se.    finally:.
-00006fc0: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00006fd0: 6365 203d 204e 6f6e 650a 0a0a 6465 6620  ce = None...def 
-00006fe0: 6472 6f70 5f63 6f6c 756d 6e28 0a20 2020  drop_column(.   
-00006ff0: 2070 6174 683a 2055 6e69 6f6e 5b73 7472   path: Union[str
-00007000: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-00007010: 6e79 5d22 5d2c 2063 6f6c 756d 6e5f 6e61  ny]"], column_na
-00007020: 6d65 3a20 7374 722c 206c 6179 6572 3a20  me: str, layer: 
-00007030: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00007040: 4e6f 6e65 0a29 3a0a 2020 2020 2222 220a  None.):.    """.
-00007050: 2020 2020 4472 6f70 2074 6865 2063 6f6c      Drop the col
-00007060: 756d 6e20 7370 6563 6966 6965 642e 0a0a  umn specified...
-00007070: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00007080: 2020 7061 7468 2028 5061 7468 4c69 6b65    path (PathLike
-00007090: 293a 2054 6865 2066 696c 6520 7061 7468  ): The file path
-000070a0: 2e0a 2020 2020 2020 2020 636f 6c75 6d6e  ..        column
-000070b0: 5f6e 616d 6520 2873 7472 293a 2074 6865  _name (str): the
-000070c0: 2063 6f6c 756d 6e20 6e61 6d65 2e0a 2020   column name..  
-000070d0: 2020 2020 2020 6c61 7965 7220 284f 7074        layer (Opt
-000070e0: 696f 6e61 6c5b 7374 725d 293a 2054 6865  ional[str]): The
-000070f0: 206c 6179 6572 206e 616d 652e 2049 6620   layer name. If 
-00007100: 6e6f 7420 7370 6563 6966 6965 642c 2061  not specified, a
-00007110: 6e64 2074 6865 7265 2069 7320 6f6e 6c79  nd there is only
-00007120: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
-00007130: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
-00007140: 6c65 2c20 7468 6973 206c 6179 6572 2069  le, this layer i
-00007150: 7320 7573 6564 2e20 4f74 6865 7277 6973  s used. Otherwis
-00007160: 6520 6120 5661 6c75 6545 7272 6f72 2069  e a ValueError i
-00007170: 730a 2020 2020 2020 2020 2020 2020 7261  s.            ra
-00007180: 6973 6564 2e0a 2020 2020 2222 220a 2020  ised..    """.  
-00007190: 2020 2320 4368 6563 6b20 696e 7075 7420    # Check input 
-000071a0: 7061 7261 6d65 7465 7273 0a20 2020 2070  parameters.    p
-000071b0: 6174 6820 3d20 5061 7468 2870 6174 6829  ath = Path(path)
-000071c0: 0a20 2020 2069 6620 6c61 7965 7220 6973  .    if layer is
-000071d0: 204e 6f6e 653a 0a20 2020 2020 2020 206c   None:.        l
-000071e0: 6179 6572 203d 2067 6574 5f6f 6e6c 795f  ayer = get_only_
-000071f0: 6c61 7965 7228 7061 7468 290a 2020 2020  layer(path).    
-00007200: 696e 666f 203d 2067 6574 5f6c 6179 6572  info = get_layer
-00007210: 696e 666f 2870 6174 682c 206c 6179 6572  info(path, layer
-00007220: 290a 2020 2020 6966 2063 6f6c 756d 6e5f  ).    if column_
-00007230: 6e61 6d65 206e 6f74 2069 6e20 696e 666f  name not in info
-00007240: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
-00007250: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
-00007260: 436f 6c75 6d6e 207b 636f 6c75 6d6e 5f6e  Column {column_n
-00007270: 616d 657d 206e 6f74 2070 7265 7365 6e74  ame} not present
-00007280: 2073 6f20 6361 6e6e 6f74 2062 6520 6472   so cannot be dr
-00007290: 6f70 7065 642e 2229 0a20 2020 2020 2020  opped.").       
-000072a0: 2072 6574 7572 6e0a 0a20 2020 2023 204e   return..    # N
-000072b0: 6f77 2072 6561 6c6c 7920 7265 6e61 6d65  ow really rename
-000072c0: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-000072d0: 3d20 4e6f 6e65 0a20 2020 2074 7279 3a0a  = None.    try:.
-000072e0: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-000072f0: 6365 203d 2067 6461 6c2e 4f70 656e 4578  ce = gdal.OpenEx
-00007300: 2873 7472 2870 6174 6829 2c20 6e4f 7065  (str(path), nOpe
-00007310: 6e46 6c61 6773 3d67 6461 6c2e 4f46 5f55  nFlags=gdal.OF_U
-00007320: 5044 4154 4529 0a20 2020 2020 2020 2073  PDATE).        s
-00007330: 716c 5f73 746d 7420 3d20 6627 414c 5445  ql_stmt = f'ALTE
-00007340: 5220 5441 424c 4520 227b 6c61 7965 727d  R TABLE "{layer}
-00007350: 2220 4452 4f50 2043 4f4c 554d 4e20 227b  " DROP COLUMN "{
-00007360: 636f 6c75 6d6e 5f6e 616d 657d 2227 0a20  column_name}"'. 
-00007370: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00007380: 6461 7461 736f 7572 6365 2e45 7865 6375  datasource.Execu
-00007390: 7465 5351 4c28 7371 6c5f 7374 6d74 290a  teSQL(sql_stmt).
-000073a0: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-000073b0: 6365 2e52 656c 6561 7365 5265 7375 6c74  ce.ReleaseResult
-000073c0: 5365 7428 7265 7375 6c74 290a 0a20 2020  Set(result)..   
-000073d0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-000073e0: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-000073f0: 2065 782e 6172 6773 203d 2028 6622 6472   ex.args = (f"dr
-00007400: 6f70 5f63 6f6c 756d 6e20 6572 726f 7220  op_column error 
-00007410: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
-00007420: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
-00007430: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00007440: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-00007450: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
-00007460: 6f6e 650a 0a0a 6465 6620 7570 6461 7465  one...def update
-00007470: 5f63 6f6c 756d 6e28 0a20 2020 2070 6174  _column(.    pat
-00007480: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-00007490: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-000074a0: 5d2c 0a20 2020 206e 616d 653a 2073 7472  ],.    name: str
-000074b0: 2c0a 2020 2020 6578 7072 6573 7369 6f6e  ,.    expression
-000074c0: 3a20 7374 722c 0a20 2020 206c 6179 6572  : str,.    layer
-000074d0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000074e0: 3d20 4e6f 6e65 2c0a 2020 2020 7768 6572  = None,.    wher
-000074f0: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-00007500: 203d 204e 6f6e 652c 0a29 3a0a 2020 2020   = None,.):.    
-00007510: 2222 220a 2020 2020 5570 6461 7465 2061  """.    Update a
-00007520: 2063 6f6c 756d 6e20 6672 6f6d 2061 206c   column from a l
-00007530: 6179 6572 206f 6620 7468 6520 6765 6f66  ayer of the geof
-00007540: 696c 652e 0a0a 2020 2020 4172 6773 3a0a  ile...    Args:.
-00007550: 2020 2020 2020 2020 7061 7468 2028 5061          path (Pa
-00007560: 7468 4c69 6b65 293a 2050 6174 6820 746f  thLike): Path to
-00007570: 2074 6865 2067 656f 6669 6c65 0a20 2020   the geofile.   
-00007580: 2020 2020 206e 616d 6520 2873 7472 293a       name (str):
-00007590: 204e 616d 6520 666f 7220 7468 6520 6e65   Name for the ne
-000075a0: 7720 636f 6c75 6d6e 0a20 2020 2020 2020  w column.       
-000075b0: 2065 7870 7265 7373 696f 6e20 2873 7472   expression (str
-000075c0: 293a 2053 514c 6974 6520 6578 7072 6573  ): SQLite expres
-000075d0: 7369 6f6e 2074 6f20 7573 6520 746f 2075  sion to use to u
-000075e0: 7064 6174 650a 2020 2020 2020 2020 2020  pdate.          
-000075f0: 2020 7468 6520 7661 6c75 652e 0a20 2020    the value..   
-00007600: 2020 2020 206c 6179 6572 2028 7374 722c       layer (str,
-00007610: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-00007620: 6c61 7965 7220 6e61 6d65 2e20 4966 204e  layer name. If N
-00007630: 6f6e 6520 616e 6420 7468 6520 6765 6f66  one and the geof
-00007640: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
-00007650: 6861 7320 6f6e 6c79 206f 6e65 206c 6179  has only one lay
-00007660: 6572 2c20 7468 6174 206c 6179 6572 2069  er, that layer i
-00007670: 7320 7573 6564 2e20 4465 6661 756c 7473  s used. Defaults
-00007680: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
-00007690: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
-000076a0: 7469 6f6e 616c 293a 2053 514c 2077 6865  tional): SQL whe
-000076b0: 7265 2063 6c61 7573 6520 746f 2072 6573  re clause to res
-000076c0: 7472 6963 7420 7468 6520 726f 7773 2074  trict the rows t
-000076d0: 6861 7420 7769 6c6c 0a20 2020 2020 2020  hat will.       
-000076e0: 2020 2020 2062 6520 7570 6461 7465 642e       be updated.
-000076f0: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00007700: 652e 0a0a 2020 2020 5261 6973 6573 3a0a  e...    Raises:.
-00007710: 2020 2020 2020 2020 5661 6c75 6545 7272          ValueErr
-00007720: 6f72 3a20 616e 2069 6e76 616c 6964 2070  or: an invalid p
-00007730: 6172 616d 6574 6572 2076 616c 7565 2077  arameter value w
-00007740: 6173 2070 6173 7365 642e 0a20 2020 2022  as passed..    "
-00007750: 2222 0a0a 2020 2020 2320 496e 6974 0a20  ""..    # Init. 
-00007760: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
-00007770: 6174 6829 0a20 2020 2069 6620 6c61 7965  ath).    if laye
-00007780: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-00007790: 2020 206c 6179 6572 203d 2067 6574 5f6f     layer = get_o
-000077a0: 6e6c 795f 6c61 7965 7228 7061 7468 290a  nly_layer(path).
-000077b0: 2020 2020 6c61 7965 7269 6e66 6f5f 6f72      layerinfo_or
-000077c0: 6967 203d 2067 6574 5f6c 6179 6572 696e  ig = get_layerin
-000077d0: 666f 2870 6174 682c 206c 6179 6572 290a  fo(path, layer).
-000077e0: 2020 2020 636f 6c75 6d6e 735f 7570 7065      columns_uppe
-000077f0: 7220 3d20 5b63 6f6c 756d 6e2e 7570 7065  r = [column.uppe
-00007800: 7228 2920 666f 7220 636f 6c75 6d6e 2069  r() for column i
-00007810: 6e20 6c61 7965 7269 6e66 6f5f 6f72 6967  n layerinfo_orig
-00007820: 2e63 6f6c 756d 6e73 5d0a 2020 2020 6966  .columns].    if
-00007830: 206e 616d 652e 7570 7065 7228 2920 6e6f   name.upper() no
-00007840: 7420 696e 2063 6f6c 756d 6e73 5f75 7070  t in columns_upp
-00007850: 6572 3a0a 2020 2020 2020 2020 2320 4966  er:.        # If
-00007860: 2063 6f6c 756d 6e20 646f 6573 6e27 7420   column doesn't 
-00007870: 6578 6973 7420 7965 742c 2065 7272 6f72  exist yet, error
-00007880: 210a 2020 2020 2020 2020 7261 6973 6520  !.        raise 
-00007890: 5661 6c75 6545 7272 6f72 2866 2243 6f6c  ValueError(f"Col
-000078a0: 756d 6e20 7b6e 616d 657d 2064 6f65 736e  umn {name} doesn
-000078b0: 2774 2065 7869 7374 2069 6e20 7b70 6174  't exist in {pat
-000078c0: 687d 2c20 6c61 7965 7220 7b6c 6179 6572  h}, layer {layer
-000078d0: 7d22 290a 0a20 2020 2023 2047 6f21 0a20  }")..    # Go!. 
-000078e0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-000078f0: 4e6f 6e65 0a20 2020 2074 7279 3a0a 2020  None.    try:.  
-00007900: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00007910: 203d 2067 6461 6c2e 4f70 656e 4578 2873   = gdal.OpenEx(s
-00007920: 7472 2870 6174 6829 2c20 6e4f 7065 6e46  tr(path), nOpenF
-00007930: 6c61 6773 3d67 6461 6c2e 4f46 5f55 5044  lags=gdal.OF_UPD
-00007940: 4154 4529 0a20 2020 2020 2020 2073 716c  ATE).        sql
-00007950: 6974 655f 7374 6d74 203d 2066 2755 5044  ite_stmt = f'UPD
-00007960: 4154 4520 227b 6c61 7965 727d 2220 5345  ATE "{layer}" SE
-00007970: 5420 227b 6e61 6d65 7d22 203d 207b 6578  T "{name}" = {ex
-00007980: 7072 6573 7369 6f6e 7d27 0a20 2020 2020  pression}'.     
-00007990: 2020 2069 6620 7768 6572 6520 6973 206e     if where is n
-000079a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000079b0: 2020 2020 2073 716c 6974 655f 7374 6d74       sqlite_stmt
-000079c0: 202b 3d20 6622 5c6e 2057 4845 5245 207b   += f"\n WHERE {
-000079d0: 7768 6572 657d 220a 2020 2020 2020 2020  where}".        
-000079e0: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
-000079f0: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
-00007a00: 716c 6974 655f 7374 6d74 2c20 6469 616c  qlite_stmt, dial
-00007a10: 6563 743d 2253 514c 4954 4522 290a 2020  ect="SQLITE").  
-00007a20: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00007a30: 2e52 656c 6561 7365 5265 7375 6c74 5365  .ReleaseResultSe
-00007a40: 7428 7265 7375 6c74 290a 0a20 2020 2065  t(result)..    e
-00007a50: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00007a60: 6173 2065 783a 0a20 2020 2020 2020 2065  as ex:.        e
-00007a70: 782e 6172 6773 203d 2028 6622 7570 6461  x.args = (f"upda
-00007a80: 7465 5f63 6f6c 756d 6e20 6572 726f 7220  te_column error 
-00007a90: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
-00007aa0: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
-00007ab0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00007ac0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-00007ad0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
-00007ae0: 6f6e 650a 0a0a 6465 6620 7265 6164 5f66  one...def read_f
-00007af0: 696c 6528 0a20 2020 2070 6174 683a 2055  ile(.    path: U
-00007b00: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
-00007b10: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
-00007b20: 2020 206c 6179 6572 3a20 4f70 7469 6f6e     layer: Option
-00007b30: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00007b40: 2020 2020 636f 6c75 6d6e 733a 204f 7074      columns: Opt
-00007b50: 696f 6e61 6c5b 4974 6572 6162 6c65 5b73  ional[Iterable[s
-00007b60: 7472 5d5d 203d 204e 6f6e 652c 0a20 2020  tr]] = None,.   
-00007b70: 2062 626f 783d 4e6f 6e65 2c0a 2020 2020   bbox=None,.    
-00007b80: 726f 7773 3d4e 6f6e 652c 0a20 2020 2073  rows=None,.    s
-00007b90: 716c 5f73 746d 743a 204f 7074 696f 6e61  ql_stmt: Optiona
-00007ba0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00007bb0: 2020 2073 716c 5f64 6961 6c65 6374 3a20     sql_dialect: 
-00007bc0: 4f70 7469 6f6e 616c 5b4c 6974 6572 616c  Optional[Literal
-00007bd0: 5b22 5351 4c49 5445 222c 2022 4f47 5253  ["SQLITE", "OGRS
-00007be0: 514c 225d 5d20 3d20 4e6f 6e65 2c0a 2020  QL"]] = None,.  
-00007bf0: 2020 6967 6e6f 7265 5f67 656f 6d65 7472    ignore_geometr
-00007c00: 793a 2062 6f6f 6c20 3d20 4661 6c73 652c  y: bool = False,
-00007c10: 0a20 2020 2066 6964 5f61 735f 696e 6465  .    fid_as_inde
-00007c20: 783a 2062 6f6f 6c20 3d20 4661 6c73 652c  x: bool = False,
-00007c30: 0a29 202d 3e20 6770 642e 4765 6f44 6174  .) -> gpd.GeoDat
-00007c40: 6146 7261 6d65 3a0a 2020 2020 2222 220a  aFrame:.    """.
-00007c50: 2020 2020 5265 6164 7320 6120 6669 6c65      Reads a file
-00007c60: 2074 6f20 6120 6765 6f70 616e 6461 7320   to a geopandas 
-00007c70: 4765 6f44 6174 6166 7261 6d65 2e0a 0a20  GeoDataframe... 
-00007c80: 2020 2054 6865 2066 696c 6520 666f 726d     The file form
-00007c90: 6174 2069 7320 6465 7465 6374 6564 2062  at is detected b
-00007ca0: 6173 6564 206f 6e20 7468 6520 6669 6c65  ased on the file
-00007cb0: 7061 7468 2065 7874 656e 7369 6f6e 2e0a  path extension..
-00007cc0: 0a20 2020 2049 6620 616e 2073 716c 5f73  .    If an sql_s
-00007cd0: 746d 7420 6973 2073 7065 6369 6669 6564  tmt is specified
-00007ce0: 2c20 7468 6520 7371 6c69 7465 2071 7565  , the sqlite que
-00007cf0: 7279 2063 616e 2063 6f6e 7461 696e 2066  ry can contain f
-00007d00: 6f6c 6c6f 7769 6e67 2070 6c61 6365 686f  ollowing placeho
-00007d10: 6c64 6572 730a 2020 2020 7468 6174 2077  lders.    that w
-00007d20: 696c 6c20 6265 2061 7574 6f6d 6174 6963  ill be automatic
-00007d30: 616c 6c79 2072 6570 6c61 6365 6420 666f  ally replaced fo
-00007d40: 7220 796f 753a 0a0a 2020 2020 2020 2a20  r you:..      * 
-00007d50: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
-00007d60: 3a20 7468 6520 636f 6c75 6d6e 2077 6865  : the column whe
-00007d70: 7265 2074 6865 2070 7269 6d61 7279 2067  re the primary g
-00007d80: 656f 6d65 7472 7920 6973 2073 746f 7265  eometry is store
-00007d90: 642e 0a20 2020 2020 202a 207b 636f 6c75  d..      * {colu
-00007da0: 6d6e 735f 746f 5f73 656c 6563 745f 7374  mns_to_select_st
-00007db0: 727d 3a20 6966 2027 636f 6c75 6d6e 7327  r}: if 'columns'
-00007dc0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7468   is not None, th
-00007dd0: 6f73 6520 636f 6c75 6d6e 732c 0a20 2020  ose columns,.   
-00007de0: 2020 2020 206f 7468 6572 7769 7365 2061       otherwise a
-00007df0: 6c6c 2063 6f6c 756d 6e73 206f 6620 7468  ll columns of th
-00007e00: 6520 6c61 7965 722e 0a20 2020 2020 202a  e layer..      *
-00007e10: 207b 696e 7075 745f 6c61 7965 727d 3a20   {input_layer}: 
-00007e20: 7468 6520 6c61 7965 7220 6e61 6d65 206f  the layer name o
-00007e30: 6620 7468 6520 696e 7075 7420 6c61 7965  f the input laye
-00007e40: 722e 0a0a 2020 2020 4578 616d 706c 6520  r...    Example 
-00007e50: 7371 6c20 7374 6174 656d 656e 7420 7769  sql statement wi
-00007e60: 7468 2070 6c61 6365 686f 6c64 6572 733a  th placeholders:
-00007e70: 0a20 2020 203a 3a0a 0a20 2020 2020 2020  .    ::..       
-00007e80: 2053 454c 4543 5420 7b67 656f 6d65 7472   SELECT {geometr
-00007e90: 7963 6f6c 756d 6e7d 0a20 2020 2020 2020  ycolumn}.       
-00007ea0: 2020 2020 2020 207b 636f 6c75 6d6e 735f         {columns_
-00007eb0: 746f 5f73 656c 6563 745f 7374 727d 0a20  to_select_str}. 
-00007ec0: 2020 2020 2020 2020 2046 524f 4d20 227b           FROM "{
-00007ed0: 696e 7075 745f 6c61 7965 727d 2220 6c61  input_layer}" la
-00007ee0: 7965 720a 0a20 2020 2054 6865 2075 6e64  yer..    The und
-00007ef0: 6572 6c79 696e 6720 6c69 6272 6172 7920  erlying library 
-00007f00: 7573 6564 2074 6f20 7265 6164 2074 6865  used to read the
-00007f10: 2066 696c 6520 6361 6e20 6265 2063 686f   file can be cho
-00007f20: 6f73 656e 2075 7369 6e67 2074 6865 0a20  osen using the. 
-00007f30: 2020 2022 4746 4f5f 494f 5f45 4e47 494e     "GFO_IO_ENGIN
-00007f40: 4522 2065 6e76 6972 6f6e 6d65 6e74 2076  E" environment v
-00007f50: 6172 6961 626c 652e 2050 6f73 7369 626c  ariable. Possibl
-00007f60: 6520 7661 6c75 6573 2061 7265 2022 6669  e values are "fi
-00007f70: 6f6e 6122 2061 6e64 2022 7079 6f67 7269  ona" and "pyogri
-00007f80: 6f22 2e0a 2020 2020 5468 6973 206f 7074  o"..    This opt
-00007f90: 696f 6e20 6973 2063 7265 6174 6564 2061  ion is created a
-00007fa0: 7320 6120 7465 6d70 6f72 6172 7920 6661  s a temporary fa
-00007fb0: 6c6c 6261 636b 2074 6f20 2266 696f 6e61  llback to "fiona
-00007fc0: 2220 666f 7220 6361 7365 7320 7768 6572  " for cases wher
-00007fd0: 6520 2270 796f 6772 696f 220a 2020 2020  e "pyogrio".    
-00007fe0: 6769 7665 7320 6973 7375 6573 2c20 736f  gives issues, so
-00007ff0: 2070 6c65 6173 6520 7265 706f 7274 2069   please report i
-00008000: 7373 7565 7320 6966 2074 6865 7920 6172  ssues if they ar
-00008010: 6520 656e 636f 756e 7465 7265 642e 2049  e encountered. I
-00008020: 6e20 7468 6520 6675 7475 7265 2073 7570  n the future sup
-00008030: 706f 7274 0a20 2020 2066 6f72 2074 6865  port.    for the
-00008040: 2022 6669 6f6e 6122 2065 6e67 696e 6520   "fiona" engine 
-00008050: 6d6f 7374 206c 696b 656c 7920 7769 6c6c  most likely will
-00008060: 2062 6520 7265 6d6f 7665 642e 2044 6566   be removed. Def
-00008070: 6175 6c74 2065 6e67 696e 6520 6973 2022  ault engine is "
-00008080: 7079 6f67 7269 6f22 2e0a 0a20 2020 2041  pyogrio"...    A
-00008090: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-000080a0: 6820 2866 696c 6520 7061 7468 293a 2070  h (file path): p
-000080b0: 6174 6820 746f 2074 6865 2066 696c 6520  ath to the file 
-000080c0: 746f 2072 6561 6420 6672 6f6d 0a20 2020  to read from.   
-000080d0: 2020 2020 206c 6179 6572 2028 7374 722c       layer (str,
-000080e0: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-000080f0: 6c61 7965 7220 746f 2072 6561 642e 2044  layer to read. D
-00008100: 6566 6175 6c74 7320 746f 204e 6f6e 652c  efaults to None,
-00008110: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00008120: 6e20 7265 6164 7320 7468 6520 6f6e 6c79  n reads the only
-00008130: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
-00008140: 6c65 206f 7220 7468 726f 7773 2065 7272  le or throws err
-00008150: 6f72 2e0a 2020 2020 2020 2020 636f 6c75  or..        colu
-00008160: 6d6e 7320 2849 7465 7261 626c 655b 7374  mns (Iterable[st
-00008170: 725d 2c20 6f70 7469 6f6e 616c 293a 2054  r], optional): T
-00008180: 6865 2028 6e6f 6e2d 6765 6f6d 6574 7279  he (non-geometry
-00008190: 2920 636f 6c75 6d6e 7320 746f 2072 6561  ) columns to rea
-000081a0: 6420 7769 6c6c 0a20 2020 2020 2020 2020  d will.         
-000081b0: 2020 2062 6520 7265 7475 726e 6564 2069     be returned i
-000081c0: 6e20 7468 6520 6f72 6465 7220 7370 6563  n the order spec
-000081d0: 6966 6965 642e 2049 6620 4e6f 6e65 2c20  ified. If None, 
-000081e0: 616c 6c20 7374 616e 6461 7264 2063 6f6c  all standard col
-000081f0: 756d 6e73 2061 7265 2072 6561 642e 0a20  umns are read.. 
-00008200: 2020 2020 2020 2020 2020 2049 6e20 6164             In ad
-00008210: 6469 7469 6f6e 2074 6f20 7374 616e 6461  dition to standa
-00008220: 7264 2063 6f6c 756d 6e73 2c20 6974 2069  rd columns, it i
-00008230: 7320 616c 736f 2070 6f73 7369 626c 650a  s also possible.
-00008240: 2020 2020 2020 2020 2020 2020 746f 2073              to s
-00008250: 7065 6369 6679 2022 6669 6422 2c20 6120  pecify "fid", a 
-00008260: 756e 6971 7565 2069 6e64 6578 2061 7661  unique index ava
-00008270: 696c 6162 6c65 2069 6e20 616c 6c20 696e  ilable in all in
-00008280: 7075 7420 6669 6c65 732e 204e 6f74 6520  put files. Note 
-00008290: 7468 6174 2074 6865 0a20 2020 2020 2020  that the.       
-000082a0: 2020 2020 2022 6669 6422 2077 696c 6c20       "fid" will 
-000082b0: 6265 2061 6c69 6173 6564 2065 672e 2074  be aliased eg. t
-000082c0: 6f20 2266 6964 5f31 222e 2044 6566 6175  o "fid_1". Defau
-000082d0: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-000082e0: 2020 2020 2062 626f 7820 285b 7479 7065       bbox ([type
-000082f0: 5d2c 206f 7074 696f 6e61 6c29 3a20 5265  ], optional): Re
-00008300: 6164 206f 6e6c 7920 6765 6f6d 6574 7269  ad only geometri
-00008310: 6573 2069 6e74 6572 7365 6374 696e 6720  es intersecting 
-00008320: 7468 6973 2062 626f 782e 0a20 2020 2020  this bbox..     
-00008330: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-00008340: 746f 204e 6f6e 652c 2074 6865 6e20 616c  to None, then al
-00008350: 6c20 726f 7773 2061 7265 2072 6561 642e  l rows are read.
-00008360: 0a20 2020 2020 2020 2072 6f77 7320 285b  .        rows ([
-00008370: 7479 7065 5d2c 206f 7074 696f 6e61 6c29  type], optional)
-00008380: 3a20 5265 6164 206f 6e6c 7920 7468 6520  : Read only the 
-00008390: 726f 7773 2073 7065 6369 6669 6564 2e0a  rows specified..
-000083a0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-000083b0: 756c 7473 2074 6f20 4e6f 6e65 2c20 7468  ults to None, th
-000083c0: 656e 2061 6c6c 2072 6f77 7320 6172 6520  en all rows are 
-000083d0: 7265 6164 2e0a 2020 2020 2020 2020 7371  read..        sq
-000083e0: 6c5f 7374 6d74 2028 7374 7229 3a20 7371  l_stmt (str): sq
-000083f0: 6c20 7374 6174 656d 656e 7420 746f 2075  l statement to u
-00008400: 7365 2e20 4f6e 6c79 2073 7570 706f 7274  se. Only support
-00008410: 6564 2077 6974 6820 2270 796f 6772 696f  ed with "pyogrio
-00008420: 2220 656e 6769 6e65 2e0a 2020 2020 2020  " engine..      
-00008430: 2020 7371 6c5f 6469 616c 6563 7420 2873    sql_dialect (s
-00008440: 7472 2c20 6f70 7469 6f6e 616c 293a 2053  tr, optional): S
-00008450: 716c 2064 6961 6c65 6374 2075 7365 642e  ql dialect used.
-00008460: 2049 6620 4e6f 6e65 2c20 666f 7220 6461   If None, for da
-00008470: 7461 2073 6f75 7263 6573 2077 6974 680a  ta sources with.
-00008480: 2020 2020 2020 2020 2020 2020 6578 706c              expl
-00008490: 6963 6974 2053 514c 2073 7570 706f 7274  icit SQL support
-000084a0: 2074 6865 2073 7461 7465 6d65 6e74 2069   the statement i
-000084b0: 7320 7072 6f63 6573 7365 6420 6279 2074  s processed by t
-000084c0: 6865 2064 6566 6175 6c74 2053 514c 2065  he default SQL e
-000084d0: 6e67 696e 650a 2020 2020 2020 2020 2020  ngine.          
-000084e0: 2020 2865 2e67 2e20 506f 7374 4749 532c    (e.g. PostGIS,
-000084f0: 2047 656f 7061 636b 6167 652c 2053 7061   Geopackage, Spa
-00008500: 7469 616c 6974 652c 2e2e 2e29 2e20 466f  tialite,...). Fo
-00008510: 7220 6461 7461 2073 6f75 7263 6573 0a20  r data sources. 
-00008520: 2020 2020 2020 2020 2020 2077 6974 686f             witho
-00008530: 7574 2053 514c 2073 7570 706f 7274 2c20  ut SQL support, 
-00008540: 7468 6520 224f 4752 5351 4c22 2064 6961  the "OGRSQL" dia
-00008550: 6c65 6374 2069 7320 7468 6520 6465 6661  lect is the defa
-00008560: 756c 742e 2044 6566 6175 6c74 7320 746f  ult. Defaults to
-00008570: 204e 6f6e 652e 0a20 2020 2020 2020 2069   None..        i
-00008580: 676e 6f72 655f 6765 6f6d 6574 7279 2028  gnore_geometry (
-00008590: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
-000085a0: 2054 7275 6520 6e6f 7420 746f 2072 6561   True not to rea
-000085b0: 642f 7265 7475 726e 2074 6865 2067 656f  d/return the geo
-000085c0: 6d65 7472 792e 0a20 2020 2020 2020 2020  metry..         
-000085d0: 2020 2044 6566 6175 6c74 7320 746f 2046     Defaults to F
-000085e0: 616c 7365 2e0a 2020 2020 2020 2020 6669  alse..        fi
-000085f0: 645f 6173 5f69 6e64 6578 2028 626f 6f6c  d_as_index (bool
-00008600: 2c20 6f70 7469 6f6e 616c 293a 2049 6620  , optional): If 
-00008610: 5472 7565 2c20 7769 6c6c 2075 7365 2074  True, will use t
-00008620: 6865 2046 4944 7320 6f66 2074 6865 2066  he FIDs of the f
-00008630: 6561 7475 7265 7320 7468 6174 0a20 2020  eatures that.   
-00008640: 2020 2020 2020 2020 2077 6572 6520 7265           were re
-00008650: 6164 2061 7320 7468 6520 696e 6465 7820  ad as the index 
-00008660: 6f66 2074 6865 2047 656f 4461 7461 4672  of the GeoDataFr
-00008670: 616d 652e 204d 6179 2073 7461 7274 2061  ame. May start a
-00008680: 7420 3020 6f72 2031 2064 6570 656e 6469  t 0 or 1 dependi
-00008690: 6e67 206f 6e0a 2020 2020 2020 2020 2020  ng on.          
-000086a0: 2020 7468 6520 6472 6976 6572 2e20 4465    the driver. De
-000086b0: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
-000086c0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-000086d0: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
-000086e0: 3a20 616e 2069 6e76 616c 6964 2070 6172  : an invalid par
-000086f0: 616d 6574 6572 2076 616c 7565 2077 6173  ameter value was
-00008700: 2070 6173 7365 642e 0a0a 2020 2020 5265   passed...    Re
-00008710: 7475 726e 733a 0a20 2020 2020 2020 2067  turns:.        g
-00008720: 7064 2e47 656f 4461 7461 4672 616d 653a  pd.GeoDataFrame:
-00008730: 2074 6865 2064 6174 6120 7265 6164 2e0a   the data read..
-00008740: 2020 2020 2222 220a 2020 2020 7265 7375      """.    resu
-00008750: 6c74 5f67 6466 203d 205f 7265 6164 5f66  lt_gdf = _read_f
-00008760: 696c 655f 6261 7365 280a 2020 2020 2020  ile_base(.      
-00008770: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
-00008780: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
-00008790: 2c0a 2020 2020 2020 2020 636f 6c75 6d6e  ,.        column
-000087a0: 733d 636f 6c75 6d6e 732c 0a20 2020 2020  s=columns,.     
-000087b0: 2020 2062 626f 783d 6262 6f78 2c0a 2020     bbox=bbox,.  
-000087c0: 2020 2020 2020 726f 7773 3d72 6f77 732c        rows=rows,
-000087d0: 0a20 2020 2020 2020 2073 716c 5f73 746d  .        sql_stm
-000087e0: 743d 7371 6c5f 7374 6d74 2c0a 2020 2020  t=sql_stmt,.    
-000087f0: 2020 2020 7371 6c5f 6469 616c 6563 743d      sql_dialect=
-00008800: 7371 6c5f 6469 616c 6563 742c 0a20 2020  sql_dialect,.   
-00008810: 2020 2020 2069 676e 6f72 655f 6765 6f6d       ignore_geom
-00008820: 6574 7279 3d69 676e 6f72 655f 6765 6f6d  etry=ignore_geom
-00008830: 6574 7279 2c0a 2020 2020 2020 2020 6669  etry,.        fi
-00008840: 645f 6173 5f69 6e64 6578 3d66 6964 5f61  d_as_index=fid_a
-00008850: 735f 696e 6465 782c 0a20 2020 2029 0a0a  s_index,.    )..
-00008860: 2020 2020 2320 4e6f 2061 7373 6572 7420      # No assert 
-00008870: 746f 206b 6565 7020 6261 636b 7761 7264  to keep backward
-00008880: 7320 636f 6d70 6174 6962 696c 6974 790a  s compatibility.
-00008890: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-000088a0: 745f 6764 6620 2023 2074 7970 653a 2069  t_gdf  # type: i
-000088b0: 676e 6f72 650a 0a0a 6465 6620 7265 6164  gnore...def read
-000088c0: 5f66 696c 655f 6e6f 6765 6f6d 280a 2020  _file_nogeom(.  
-000088d0: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
-000088e0: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-000088f0: 416e 795d 225d 2c0a 2020 2020 6c61 7965  Any]"],.    laye
-00008900: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
-00008910: 203d 204e 6f6e 652c 0a20 2020 2063 6f6c   = None,.    col
-00008920: 756d 6e73 3a20 4f70 7469 6f6e 616c 5b49  umns: Optional[I
-00008930: 7465 7261 626c 655b 7374 725d 5d20 3d20  terable[str]] = 
-00008940: 4e6f 6e65 2c0a 2020 2020 6262 6f78 3d4e  None,.    bbox=N
-00008950: 6f6e 652c 0a20 2020 2072 6f77 733d 4e6f  one,.    rows=No
-00008960: 6e65 2c0a 2020 2020 7371 6c5f 7374 6d74  ne,.    sql_stmt
-00008970: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00008980: 3d20 4e6f 6e65 2c0a 2020 2020 7371 6c5f  = None,.    sql_
-00008990: 6469 616c 6563 743a 204f 7074 696f 6e61  dialect: Optiona
-000089a0: 6c5b 4c69 7465 7261 6c5b 2253 514c 4954  l[Literal["SQLIT
-000089b0: 4522 2c20 224f 4752 5351 4c22 5d5d 203d  E", "OGRSQL"]] =
-000089c0: 204e 6f6e 652c 0a20 2020 2066 6964 5f61   None,.    fid_a
-000089d0: 735f 696e 6465 783a 2062 6f6f 6c20 3d20  s_index: bool = 
-000089e0: 4661 6c73 652c 0a29 202d 3e20 7064 2e44  False,.) -> pd.D
-000089f0: 6174 6146 7261 6d65 3a0a 2020 2020 2222  ataFrame:.    ""
-00008a00: 220a 2020 2020 4445 5052 4543 4154 4544  ".    DEPRECATED
-00008a10: 3a20 706c 6561 7365 2075 7365 2072 6561  : please use rea
-00008a20: 645f 6669 6c65 2077 6974 6820 6f70 7469  d_file with opti
-00008a30: 6f6e 2069 676e 6f72 655f 6765 6f6d 6574  on ignore_geomet
-00008a40: 7279 3d54 7275 652e 0a20 2020 2022 2222  ry=True..    """
-00008a50: 0a20 2020 2077 6172 6e69 6e67 732e 7761  .    warnings.wa
-00008a60: 726e 280a 2020 2020 2020 2020 2272 6561  rn(.        "rea
-00008a70: 645f 6669 6c65 5f6e 6f67 656f 6d20 6973  d_file_nogeom is
-00008a80: 2064 6570 7265 6361 7465 643a 2075 7365   deprecated: use
-00008a90: 2072 6561 645f 6669 6c65 2077 6974 6820   read_file with 
-00008aa0: 6967 6e6f 7265 5f67 656f 6d65 7472 793d  ignore_geometry=
-00008ab0: 5472 7565 222c 0a20 2020 2020 2020 2046  True",.        F
-00008ac0: 7574 7572 6557 6172 6e69 6e67 2c0a 2020  utureWarning,.  
-00008ad0: 2020 290a 2020 2020 7265 7375 6c74 5f67    ).    result_g
-00008ae0: 6466 203d 205f 7265 6164 5f66 696c 655f  df = _read_file_
-00008af0: 6261 7365 280a 2020 2020 2020 2020 7061  base(.        pa
-00008b00: 7468 3d70 6174 682c 0a20 2020 2020 2020  th=path,.       
-00008b10: 206c 6179 6572 3d6c 6179 6572 2c0a 2020   layer=layer,.  
-00008b20: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
-00008b30: 6c75 6d6e 732c 0a20 2020 2020 2020 2062  lumns,.        b
-00008b40: 626f 783d 6262 6f78 2c0a 2020 2020 2020  box=bbox,.      
-00008b50: 2020 726f 7773 3d72 6f77 732c 0a20 2020    rows=rows,.   
-00008b60: 2020 2020 2073 716c 5f73 746d 743d 7371       sql_stmt=sq
-00008b70: 6c5f 7374 6d74 2c0a 2020 2020 2020 2020  l_stmt,.        
-00008b80: 7371 6c5f 6469 616c 6563 743d 7371 6c5f  sql_dialect=sql_
-00008b90: 6469 616c 6563 742c 0a20 2020 2020 2020  dialect,.       
-00008ba0: 2069 676e 6f72 655f 6765 6f6d 6574 7279   ignore_geometry
-00008bb0: 3d54 7275 652c 0a20 2020 2020 2020 2066  =True,.        f
-00008bc0: 6964 5f61 735f 696e 6465 783d 6669 645f  id_as_index=fid_
-00008bd0: 6173 5f69 6e64 6578 2c0a 2020 2020 290a  as_index,.    ).
-00008be0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00008bf0: 7461 6e63 6528 7265 7375 6c74 5f67 6466  tance(result_gdf
-00008c00: 2c20 7064 2e44 6174 6146 7261 6d65 290a  , pd.DataFrame).
-00008c10: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00008c20: 745f 6764 660a 0a0a 6465 6620 5f72 6561  t_gdf...def _rea
-00008c30: 645f 6669 6c65 5f62 6173 6528 0a20 2020  d_file_base(.   
-00008c40: 2070 6174 683a 2055 6e69 6f6e 5b73 7472   path: Union[str
-00008c50: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-00008c60: 6e79 5d22 5d2c 0a20 2020 206c 6179 6572  ny]"],.    layer
-00008c70: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00008c80: 3d20 4e6f 6e65 2c0a 2020 2020 636f 6c75  = None,.    colu
-00008c90: 6d6e 733a 204f 7074 696f 6e61 6c5b 4974  mns: Optional[It
-00008ca0: 6572 6162 6c65 5b73 7472 5d5d 203d 204e  erable[str]] = N
-00008cb0: 6f6e 652c 0a20 2020 2062 626f 783d 4e6f  one,.    bbox=No
-00008cc0: 6e65 2c0a 2020 2020 726f 7773 3d4e 6f6e  ne,.    rows=Non
-00008cd0: 652c 0a20 2020 2073 716c 5f73 746d 743a  e,.    sql_stmt:
-00008ce0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00008cf0: 204e 6f6e 652c 0a20 2020 2073 716c 5f64   None,.    sql_d
-00008d00: 6961 6c65 6374 3a20 4f70 7469 6f6e 616c  ialect: Optional
-00008d10: 5b4c 6974 6572 616c 5b22 5351 4c49 5445  [Literal["SQLITE
-00008d20: 222c 2022 4f47 5253 514c 225d 5d20 3d20  ", "OGRSQL"]] = 
-00008d30: 4e6f 6e65 2c0a 2020 2020 6967 6e6f 7265  None,.    ignore
-00008d40: 5f67 656f 6d65 7472 793a 2062 6f6f 6c20  _geometry: bool 
-00008d50: 3d20 4661 6c73 652c 0a20 2020 2066 6964  = False,.    fid
-00008d60: 5f61 735f 696e 6465 783a 2062 6f6f 6c20  _as_index: bool 
-00008d70: 3d20 4661 6c73 652c 0a29 202d 3e20 556e  = False,.) -> Un
-00008d80: 696f 6e5b 7064 2e44 6174 6146 7261 6d65  ion[pd.DataFrame
-00008d90: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
-00008da0: 6d65 5d3a 0a20 2020 2022 2222 0a20 2020  me]:.    """.   
-00008db0: 2052 6561 6473 2061 2066 696c 6520 746f   Reads a file to
-00008dc0: 2061 2070 616e 6461 7320 4461 7461 6672   a pandas Datafr
-00008dd0: 616d 652e 0a20 2020 2022 2222 0a20 2020  ame..    """.   
-00008de0: 2023 2043 6865 636b 2069 6620 7468 6520   # Check if the 
-00008df0: 6669 6420 636f 6c75 6d6e 206e 6565 6473  fid column needs
-00008e00: 2074 6f20 6265 2072 6561 6420 6173 2063   to be read as c
-00008e10: 6f6c 756d 6e20 7669 6120 7468 6520 636f  olumn via the co
-00008e20: 6c75 6d6e 7320 7061 7261 6d65 7465 720a  lumns parameter.
-00008e30: 2020 2020 6669 645f 6173 5f63 6f6c 756d      fid_as_colum
-00008e40: 6e20 3d20 4661 6c73 650a 2020 2020 6966  n = False.    if
-00008e50: 2063 6f6c 756d 6e73 2069 7320 6e6f 7420   columns is not 
-00008e60: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00008e70: 2022 6669 6422 2069 6e20 5b63 6f6c 756d   "fid" in [colum
-00008e80: 6e2e 6c6f 7765 7228 2920 666f 7220 636f  n.lower() for co
-00008e90: 6c75 6d6e 2069 6e20 636f 6c75 6d6e 735d  lumn in columns]
-00008ea0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00008eb0: 645f 6173 5f63 6f6c 756d 6e20 3d20 5472  d_as_column = Tr
-00008ec0: 7565 0a0a 2020 2020 2320 5265 6164 2077  ue..    # Read w
-00008ed0: 6974 6820 7468 6520 656e 6769 6e65 2073  ith the engine s
-00008ee0: 7065 6369 6669 6564 0a20 2020 2065 6e67  pecified.    eng
-00008ef0: 696e 6520 3d20 5f67 6574 5f65 6e67 696e  ine = _get_engin
-00008f00: 6528 290a 2020 2020 6966 2065 6e67 696e  e().    if engin
-00008f10: 6520 3d3d 2022 7079 6f67 7269 6f22 3a0a  e == "pyogrio":.
-00008f20: 2020 2020 2020 2020 6764 6620 3d20 5f72          gdf = _r
-00008f30: 6561 645f 6669 6c65 5f62 6173 655f 7079  ead_file_base_py
-00008f40: 6f67 7269 6f28 0a20 2020 2020 2020 2020  ogrio(.         
-00008f50: 2020 2070 6174 683d 7061 7468 2c0a 2020     path=path,.  
-00008f60: 2020 2020 2020 2020 2020 6c61 7965 723d            layer=
-00008f70: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
-00008f80: 2020 2063 6f6c 756d 6e73 3d63 6f6c 756d     columns=colum
-00008f90: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00008fa0: 6262 6f78 3d62 626f 782c 0a20 2020 2020  bbox=bbox,.     
-00008fb0: 2020 2020 2020 2072 6f77 733d 726f 7773         rows=rows
-00008fc0: 2c0a 2020 2020 2020 2020 2020 2020 7371  ,.            sq
-00008fd0: 6c5f 7374 6d74 3d73 716c 5f73 746d 742c  l_stmt=sql_stmt,
-00008fe0: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
-00008ff0: 5f64 6961 6c65 6374 3d73 716c 5f64 6961  _dialect=sql_dia
-00009000: 6c65 6374 2c0a 2020 2020 2020 2020 2020  lect,.          
-00009010: 2020 6967 6e6f 7265 5f67 656f 6d65 7472    ignore_geometr
-00009020: 793d 6967 6e6f 7265 5f67 656f 6d65 7472  y=ignore_geometr
-00009030: 792c 0a20 2020 2020 2020 2020 2020 2066  y,.            f
-00009040: 6964 5f61 735f 696e 6465 783d 6669 645f  id_as_index=fid_
-00009050: 6173 5f69 6e64 6578 206f 7220 6669 645f  as_index or fid_
-00009060: 6173 5f63 6f6c 756d 6e2c 0a20 2020 2020  as_column,.     
-00009070: 2020 2029 0a20 2020 2065 6c69 6620 656e     ).    elif en
-00009080: 6769 6e65 203d 3d20 2266 696f 6e61 223a  gine == "fiona":
-00009090: 0a20 2020 2020 2020 2067 6466 203d 205f  .        gdf = _
-000090a0: 7265 6164 5f66 696c 655f 6261 7365 5f66  read_file_base_f
-000090b0: 696f 6e61 280a 2020 2020 2020 2020 2020  iona(.          
-000090c0: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
-000090d0: 2020 2020 2020 2020 206c 6179 6572 3d6c           layer=l
-000090e0: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-000090f0: 2020 636f 6c75 6d6e 733d 636f 6c75 6d6e    columns=column
-00009100: 732c 0a20 2020 2020 2020 2020 2020 2062  s,.            b
-00009110: 626f 783d 6262 6f78 2c0a 2020 2020 2020  box=bbox,.      
-00009120: 2020 2020 2020 726f 7773 3d72 6f77 732c        rows=rows,
-00009130: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
-00009140: 5f73 746d 743d 7371 6c5f 7374 6d74 2c0a  _stmt=sql_stmt,.
-00009150: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
-00009160: 6469 616c 6563 743d 7371 6c5f 6469 616c  dialect=sql_dial
-00009170: 6563 742c 0a20 2020 2020 2020 2020 2020  ect,.           
-00009180: 2069 676e 6f72 655f 6765 6f6d 6574 7279   ignore_geometry
-00009190: 3d69 676e 6f72 655f 6765 6f6d 6574 7279  =ignore_geometry
-000091a0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-000091b0: 645f 6173 5f69 6e64 6578 3d66 6964 5f61  d_as_index=fid_a
-000091c0: 735f 696e 6465 7820 6f72 2066 6964 5f61  s_index or fid_a
-000091d0: 735f 636f 6c75 6d6e 2c0a 2020 2020 2020  s_column,.      
-000091e0: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
-000091f0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00009200: 6545 7272 6f72 2866 2255 6e73 7570 706f  eError(f"Unsuppo
-00009210: 7274 6564 2065 6e67 696e 653a 207b 656e  rted engine: {en
-00009220: 6769 6e65 7d22 290a 0a20 2020 2023 2043  gine}")..    # C
-00009230: 6f70 7920 7468 6520 696e 6465 7820 746f  opy the index to
-00009240: 2061 2063 6f6c 756d 6e20 6966 206e 6565   a column if nee
-00009250: 6465 642e 2e2e 0a20 2020 2069 6620 6669  ded....    if fi
-00009260: 645f 6173 5f63 6f6c 756d 6e3a 0a20 2020  d_as_column:.   
-00009270: 2020 2020 2067 6466 5b22 6669 6422 5d20       gdf["fid"] 
-00009280: 3d20 6764 662e 696e 6465 780a 2020 2020  = gdf.index.    
-00009290: 2020 2020 6966 206e 6f74 2066 6964 5f61      if not fid_a
-000092a0: 735f 696e 6465 783a 0a20 2020 2020 2020  s_index:.       
-000092b0: 2020 2020 2067 6466 203d 2067 6466 2e72       gdf = gdf.r
-000092c0: 6573 6574 5f69 6e64 6578 2864 726f 703d  eset_index(drop=
-000092d0: 5472 7565 290a 0a20 2020 2072 6574 7572  True)..    retur
-000092e0: 6e20 6764 660a 0a0a 6465 6620 5f72 6561  n gdf...def _rea
-000092f0: 645f 6669 6c65 5f62 6173 655f 6669 6f6e  d_file_base_fion
-00009300: 6128 0a20 2020 2070 6174 683a 2055 6e69  a(.    path: Uni
-00009310: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-00009320: 4c69 6b65 5b41 6e79 5d22 5d2c 0a20 2020  Like[Any]"],.   
-00009330: 206c 6179 6572 3a20 4f70 7469 6f6e 616c   layer: Optional
-00009340: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00009350: 2020 636f 6c75 6d6e 733a 204f 7074 696f    columns: Optio
-00009360: 6e61 6c5b 4974 6572 6162 6c65 5b73 7472  nal[Iterable[str
-00009370: 5d5d 203d 204e 6f6e 652c 0a20 2020 2062  ]] = None,.    b
-00009380: 626f 783d 4e6f 6e65 2c0a 2020 2020 726f  box=None,.    ro
-00009390: 7773 3d4e 6f6e 652c 0a20 2020 2073 716c  ws=None,.    sql
-000093a0: 5f73 746d 743a 204f 7074 696f 6e61 6c5b  _stmt: Optional[
-000093b0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-000093c0: 2073 716c 5f64 6961 6c65 6374 3a20 4f70   sql_dialect: Op
-000093d0: 7469 6f6e 616c 5b4c 6974 6572 616c 5b22  tional[Literal["
-000093e0: 5351 4c49 5445 222c 2022 4f47 5253 514c  SQLITE", "OGRSQL
-000093f0: 225d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  "]] = None,.    
-00009400: 6967 6e6f 7265 5f67 656f 6d65 7472 793a  ignore_geometry:
-00009410: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00009420: 2020 2066 6964 5f61 735f 696e 6465 783a     fid_as_index:
-00009430: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
-00009440: 202d 3e20 556e 696f 6e5b 7064 2e44 6174   -> Union[pd.Dat
-00009450: 6146 7261 6d65 2c20 6770 642e 4765 6f44  aFrame, gpd.GeoD
-00009460: 6174 6146 7261 6d65 5d3a 0a20 2020 2022  ataFrame]:.    "
-00009470: 2222 0a20 2020 2052 6561 6473 2061 2066  "".    Reads a f
-00009480: 696c 6520 746f 2061 2070 616e 6461 7320  ile to a pandas 
-00009490: 4461 7461 6672 616d 6520 7573 696e 6720  Dataframe using 
-000094a0: 6669 6f6e 612e 0a20 2020 2022 2222 0a20  fiona..    """. 
-000094b0: 2020 2069 6620 6967 6e6f 7265 5f67 656f     if ignore_geo
-000094c0: 6d65 7472 7920 616e 6420 636f 6c75 6d6e  metry and column
-000094d0: 7320 3d3d 205b 5d3a 0a20 2020 2020 2020  s == []:.       
-000094e0: 2072 6574 7572 6e20 7064 2e44 6174 6146   return pd.DataF
-000094f0: 7261 6d65 2829 0a20 2020 2069 6620 7371  rame().    if sq
-00009500: 6c5f 7374 6d74 2069 7320 6e6f 7420 4e6f  l_stmt is not No
-00009510: 6e65 3a0a 2020 2020 2020 2020 7261 6973  ne:.        rais
-00009520: 6520 5661 6c75 6545 7272 6f72 2822 7371  e ValueError("sq
-00009530: 6c5f 7374 6d74 2069 7320 6e6f 7420 7375  l_stmt is not su
-00009540: 7070 6f72 7465 6420 7769 7468 2066 696f  pported with fio
-00009550: 6e61 2065 6e67 696e 6522 290a 0a20 2020  na engine")..   
-00009560: 2023 2049 6e69 740a 2020 2020 7061 7468   # Init.    path
-00009570: 203d 2050 6174 6828 7061 7468 290a 2020   = Path(path).  
-00009580: 2020 6966 2070 6174 682e 6578 6973 7473    if path.exists
-00009590: 2829 2069 7320 4661 6c73 653a 0a20 2020  () is False:.   
-000095a0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000095b0: 4572 726f 7228 6622 6669 6c65 2064 6f65  Error(f"file doe
-000095c0: 736e 2774 2065 7869 7374 3a20 7b70 6174  sn't exist: {pat
-000095d0: 687d 2229 0a0a 2020 2020 2320 4966 206e  h}")..    # If n
-000095e0: 6f20 6c61 7965 7220 6e61 6d65 2073 7065  o layer name spe
-000095f0: 6369 6669 6564 2c20 6368 6563 6b20 6966  cified, check if
-00009600: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
-00009610: 6e65 206c 6179 6572 2069 6e20 7468 6520  ne layer in the 
-00009620: 6669 6c65 2e0a 2020 2020 6966 206c 6179  file..    if lay
-00009630: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
-00009640: 2020 2020 6c61 7965 7220 3d20 6765 745f      layer = get_
-00009650: 6f6e 6c79 5f6c 6179 6572 2870 6174 6829  only_layer(path)
-00009660: 0a0a 2020 2020 2320 5645 5259 2044 4952  ..    # VERY DIR
-00009670: 5459 2068 6163 6b20 746f 2067 6574 2074  TY hack to get t
-00009680: 6865 2066 6964 0a20 2020 2069 6620 6669  he fid.    if fi
-00009690: 645f 6173 5f69 6e64 6578 3a0a 2020 2020  d_as_index:.    
-000096a0: 2020 2020 2320 4d61 6b65 2061 2063 6f70      # Make a cop
-000096b0: 792f 636f 7079 2069 6e70 7574 2066 696c  y/copy input fil
-000096c0: 6520 746f 2067 656f 7061 636b 6167 652c  e to geopackage,
-000096d0: 2061 7320 7765 2077 696c 6c20 6164 6420   as we will add 
-000096e0: 616e 2066 6964 2f72 6f77 6420 636f 6c75  an fid/rowd colu
-000096f0: 6d6e 0a20 2020 2020 2020 2074 6d70 5f66  mn.        tmp_f
-00009700: 6964 5f70 6174 6820 3d20 5061 7468 2874  id_path = Path(t
-00009710: 656d 7066 696c 652e 6d6b 6474 656d 7028  empfile.mkdtemp(
-00009720: 2929 202f 2066 227b 7061 7468 2e73 7465  )) / f"{path.ste
-00009730: 6d7d 2e67 706b 6722 0a20 2020 2020 2020  m}.gpkg".       
-00009740: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00009750: 2020 6966 2047 656f 6669 6c65 5479 7065    if GeofileType
-00009760: 2870 6174 6829 203d 3d20 4765 6f66 696c  (path) == Geofil
-00009770: 6554 7970 652e 4750 4b47 3a0a 2020 2020  eType.GPKG:.    
-00009780: 2020 2020 2020 2020 2020 2020 636f 7079              copy
-00009790: 2870 6174 682c 2074 6d70 5f66 6964 5f70  (path, tmp_fid_p
-000097a0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-000097b0: 2020 2020 2061 6464 5f63 6f6c 756d 6e28       add_column(
-000097c0: 746d 705f 6669 645f 7061 7468 2c20 225f  tmp_fid_path, "_
-000097d0: 5f54 4d50 5f47 454f 4649 4c45 4f50 535f  _TMP_GEOFILEOPS_
-000097e0: 4649 4422 2c20 2249 4e54 4547 4552 222c  FID", "INTEGER",
-000097f0: 2022 6669 6422 290a 2020 2020 2020 2020   "fid").        
-00009800: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009810: 2020 2020 2020 2020 2020 636f 6e76 6572            conver
-00009820: 7428 7061 7468 2c20 746d 705f 6669 645f  t(path, tmp_fid_
-00009830: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-00009840: 2020 2020 2020 2320 6669 6420 696e 2073        # fid in s
-00009850: 6861 7065 6669 6c65 2069 7320 3020 6261  hapefile is 0 ba
-00009860: 7365 642c 2073 6f20 6669 642d 310a 2020  sed, so fid-1.  
-00009870: 2020 2020 2020 2020 2020 2020 2020 6164                ad
-00009880: 645f 636f 6c75 6d6e 2874 6d70 5f66 6964  d_column(tmp_fid
-00009890: 5f70 6174 682c 2022 5f5f 544d 505f 4745  _path, "__TMP_GE
-000098a0: 4f46 494c 454f 5053 5f46 4944 222c 2022  OFILEOPS_FID", "
-000098b0: 494e 5445 4745 5222 2c20 2266 6964 2d31  INTEGER", "fid-1
-000098c0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-000098d0: 7061 7468 203d 2074 6d70 5f66 6964 5f70  path = tmp_fid_p
-000098e0: 6174 680a 2020 2020 2020 2020 6669 6e61  ath.        fina
-000098f0: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00009900: 2069 6620 746d 705f 6669 645f 7061 7468   if tmp_fid_path
-00009910: 2e70 6172 656e 742e 6578 6973 7473 2829  .parent.exists()
-00009920: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009930: 2020 7368 7574 696c 2e72 6d74 7265 6528    shutil.rmtree(
-00009940: 746d 705f 6669 645f 7061 7468 2c20 6967  tmp_fid_path, ig
-00009950: 6e6f 7265 5f65 7272 6f72 733d 5472 7565  nore_errors=True
-00009960: 290a 0a20 2020 2023 2043 6865 636b 696e  )..    # Checkin
-00009970: 6720 6966 2066 6965 6c64 2f63 6f6c 756d  g if field/colum
-00009980: 6e20 6e61 6d65 7320 7368 6f75 6c64 2062  n names should b
-00009990: 6520 7265 6164 2069 7320 6361 7365 2073  e read is case s
-000099a0: 656e 7369 7469 7665 2069 6e20 6669 6f6e  ensitive in fion
-000099b0: 612c 2073 6f0a 2020 2020 2320 6d61 6b65  a, so.    # make
-000099c0: 2073 7572 6520 7468 6520 636f 6c75 6d6e   sure the column
-000099d0: 206e 616d 6573 2073 7065 6369 6669 6564   names specified
-000099e0: 2068 6176 6520 7468 6520 7361 6d65 2063   have the same c
-000099f0: 6173 696e 672e 0a20 2020 2063 6f6c 756d  asing..    colum
-00009a00: 6e73 5f70 7265 7061 7265 6420 3d20 4e6f  ns_prepared = No
-00009a10: 6e65 0a20 2020 2069 6620 636f 6c75 6d6e  ne.    if column
-00009a20: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00009a30: 2020 2020 2020 206c 6179 6572 696e 666f         layerinfo
-00009a40: 203d 2067 6574 5f6c 6179 6572 696e 666f   = get_layerinfo
-00009a50: 2870 6174 682c 206c 6179 6572 3d6c 6179  (path, layer=lay
-00009a60: 6572 290a 2020 2020 2020 2020 636f 6c75  er).        colu
-00009a70: 6d6e 735f 7570 7065 725f 6c6f 6f6b 7570  mns_upper_lookup
-00009a80: 203d 207b 636f 6c75 6d6e 2e75 7070 6572   = {column.upper
-00009a90: 2829 3a20 636f 6c75 6d6e 2066 6f72 2063  (): column for c
-00009aa0: 6f6c 756d 6e20 696e 2063 6f6c 756d 6e73  olumn in columns
-00009ab0: 7d0a 2020 2020 2020 2020 636f 6c75 6d6e  }.        column
-00009ac0: 735f 7072 6570 6172 6564 203d 207b 0a20  s_prepared = {. 
-00009ad0: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
-00009ae0: 6e3a 2063 6f6c 756d 6e73 5f75 7070 6572  n: columns_upper
-00009af0: 5f6c 6f6f 6b75 705b 636f 6c75 6d6e 2e75  _lookup[column.u
-00009b00: 7070 6572 2829 5d0a 2020 2020 2020 2020  pper()].        
-00009b10: 2020 2020 666f 7220 636f 6c75 6d6e 2069      for column i
-00009b20: 6e20 6c61 7965 7269 6e66 6f2e 636f 6c75  n layerinfo.colu
-00009b30: 6d6e 730a 2020 2020 2020 2020 2020 2020  mns.            
-00009b40: 6966 2063 6f6c 756d 6e2e 7570 7065 7228  if column.upper(
-00009b50: 2920 696e 2063 6f6c 756d 6e73 5f75 7070  ) in columns_upp
-00009b60: 6572 5f6c 6f6f 6b75 700a 2020 2020 2020  er_lookup.      
-00009b70: 2020 7d0a 0a20 2020 2023 2052 6561 642e    }..    # Read.
-00009b80: 2e2e 0a20 2020 2063 6f6c 756d 6e73 5f6c  ...    columns_l
-00009b90: 6973 7420 3d20 4e6f 6e65 2069 6620 636f  ist = None if co
-00009ba0: 6c75 6d6e 735f 7072 6570 6172 6564 2069  lumns_prepared i
-00009bb0: 7320 4e6f 6e65 2065 6c73 6520 6c69 7374  s None else list
-00009bc0: 2863 6f6c 756d 6e73 5f70 7265 7061 7265  (columns_prepare
-00009bd0: 6429 0a20 2020 2072 6573 756c 745f 6764  d).    result_gd
-00009be0: 6620 3d20 6770 642e 7265 6164 5f66 696c  f = gpd.read_fil
-00009bf0: 6528 0a20 2020 2020 2020 2073 7472 2870  e(.        str(p
-00009c00: 6174 6829 2c0a 2020 2020 2020 2020 6c61  ath),.        la
-00009c10: 7965 723d 6c61 7965 722c 0a20 2020 2020  yer=layer,.     
-00009c20: 2020 2062 626f 783d 6262 6f78 2c0a 2020     bbox=bbox,.  
-00009c30: 2020 2020 2020 726f 7773 3d72 6f77 732c        rows=rows,
-00009c40: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
-00009c50: 5f66 6965 6c64 733d 636f 6c75 6d6e 735f  _fields=columns_
-00009c60: 6c69 7374 2c0a 2020 2020 2020 2020 7371  list,.        sq
-00009c70: 6c3d 7371 6c5f 7374 6d74 2c0a 2020 2020  l=sql_stmt,.    
-00009c80: 2020 2020 7371 6c5f 6469 616c 6563 743d      sql_dialect=
-00009c90: 7371 6c5f 6469 616c 6563 742c 0a20 2020  sql_dialect,.   
-00009ca0: 2020 2020 2069 676e 6f72 655f 6765 6f6d       ignore_geom
-00009cb0: 6574 7279 3d69 676e 6f72 655f 6765 6f6d  etry=ignore_geom
-00009cc0: 6574 7279 2c0a 2020 2020 290a 0a20 2020  etry,.    )..   
-00009cd0: 2023 2053 6574 2074 6865 2069 6e64 6578   # Set the index
-00009ce0: 2074 6f20 7468 6520 6261 636b 6564 2d75   to the backed-u
-00009cf0: 7020 6669 640a 2020 2020 6966 2066 6964  p fid.    if fid
-00009d00: 5f61 735f 696e 6465 783a 0a20 2020 2020  _as_index:.     
-00009d10: 2020 2072 6573 756c 745f 6764 6620 3d20     result_gdf = 
-00009d20: 7265 7375 6c74 5f67 6466 2e73 6574 5f69  result_gdf.set_i
-00009d30: 6e64 6578 2822 5f5f 544d 505f 4745 4f46  ndex("__TMP_GEOF
-00009d40: 494c 454f 5053 5f46 4944 2229 0a0a 2020  ILEOPS_FID")..  
-00009d50: 2020 2320 5265 6f72 6465 7220 636f 6c75    # Reorder colu
-00009d60: 6d6e 7320 2b20 6368 616e 6765 2063 6173  mns + change cas
-00009d70: 696e 6720 736f 2074 6865 7920 6172 6520  ing so they are 
-00009d80: 7468 6520 7361 6d65 2061 7320 636f 6c75  the same as colu
-00009d90: 6d6e 7320 7061 7261 6d65 7465 720a 2020  mns parameter.  
-00009da0: 2020 6966 2063 6f6c 756d 6e73 5f70 7265    if columns_pre
-00009db0: 7061 7265 6420 6973 206e 6f74 204e 6f6e  pared is not Non
-00009dc0: 6520 616e 6420 6c65 6e28 636f 6c75 6d6e  e and len(column
-00009dd0: 735f 7072 6570 6172 6564 2920 3e20 303a  s_prepared) > 0:
-00009de0: 0a20 2020 2020 2020 2072 6573 756c 745f  .        result_
-00009df0: 6764 6620 3d20 7265 7375 6c74 5f67 6466  gdf = result_gdf
-00009e00: 5b6c 6973 7428 636f 6c75 6d6e 735f 7072  [list(columns_pr
-00009e10: 6570 6172 6564 2920 2b20 5b22 6765 6f6d  epared) + ["geom
-00009e20: 6574 7279 225d 5d0a 2020 2020 2020 2020  etry"]].        
-00009e30: 7265 7375 6c74 5f67 6466 203d 2072 6573  result_gdf = res
-00009e40: 756c 745f 6764 662e 7265 6e61 6d65 2863  ult_gdf.rename(c
-00009e50: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 5f70  olumns=columns_p
-00009e60: 7265 7061 7265 6429 2020 2320 7479 7065  repared)  # type
-00009e70: 3a20 6967 6e6f 7265 0a0a 2020 2020 2320  : ignore..    # 
-00009e80: 5374 6172 7469 6e67 2066 726f 6d20 6669  Starting from fi
-00009e90: 6f6e 6120 312e 392c 2073 7472 696e 6720  ona 1.9, string 
-00009ea0: 636f 6c75 6d6e 7320 7769 7468 2061 6c6c  columns with all
-00009eb0: 204e 6f6e 6520 7661 6c75 6573 2061 7265   None values are
-00009ec0: 2072 6561 6420 6173 2062 6569 6e67 0a20   read as being. 
-00009ed0: 2020 2023 2066 6c6f 6174 2063 6f6c 756d     # float colum
-00009ee0: 6e73 2e20 436f 6e76 6572 7420 7468 656d  ns. Convert them
-00009ef0: 2074 6f20 6f62 6a65 6374 2074 7970 652e   to object type.
-00009f00: 0a20 2020 2066 6c6f 6174 5f63 6f6c 7320  .    float_cols 
-00009f10: 3d20 6c69 7374 2872 6573 756c 745f 6764  = list(result_gd
-00009f20: 662e 7365 6c65 6374 5f64 7479 7065 7328  f.select_dtypes(
-00009f30: 5b22 666c 6f61 7436 3422 5d29 2e63 6f6c  ["float64"]).col
-00009f40: 756d 6e73 290a 2020 2020 6966 206c 656e  umns).    if len
-00009f50: 2866 6c6f 6174 5f63 6f6c 7329 203e 2030  (float_cols) > 0
-00009f60: 3a0a 2020 2020 2020 2020 2320 4368 6563  :.        # Chec
-00009f70: 6b20 666f 7220 616c 6c20 666c 6f61 7420  k for all float 
-00009f80: 636f 6c75 6d6e 7320 666f 756e 6420 6966  columns found if
-00009f90: 2074 6865 7920 7368 6f75 6c64 2062 6520   they should be 
-00009fa0: 6f62 6a65 6374 2063 6f6c 756d 6e73 2069  object columns i
-00009fb0: 6e73 7465 6164 0a20 2020 2020 2020 2077  nstead.        w
-00009fc0: 6974 6820 6669 6f6e 612e 6f70 656e 2870  ith fiona.open(p
-00009fd0: 6174 682c 206c 6179 6572 3d6c 6179 6572  ath, layer=layer
-00009fe0: 2920 6173 2063 6f6c 6c65 6374 696f 6e3a  ) as collection:
-00009ff0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000a000: 6572 7420 636f 6c6c 6563 7469 6f6e 2e73  ert collection.s
-0000a010: 6368 656d 6120 6973 206e 6f74 204e 6f6e  chema is not Non
-0000a020: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-0000a030: 6f70 6572 7469 6573 203d 2063 6f6c 6c65  operties = colle
-0000a040: 6374 696f 6e2e 7363 6865 6d61 5b22 7072  ction.schema["pr
-0000a050: 6f70 6572 7469 6573 225d 0a20 2020 2020  operties"].     
-0000a060: 2020 2020 2020 2066 6f72 2063 6f6c 2069         for col i
-0000a070: 6e20 666c 6f61 745f 636f 6c73 3a0a 2020  n float_cols:.  
-0000a080: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000a090: 2063 6f6c 2069 6e20 7072 6f70 6572 7469   col in properti
-0000a0a0: 6573 2061 6e64 2070 726f 7065 7274 6965  es and propertie
-0000a0b0: 735b 636f 6c5d 2e73 7461 7274 7377 6974  s[col].startswit
-0000a0c0: 6828 2273 7472 2229 3a0a 2020 2020 2020  h("str"):.      
-0000a0d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000a0e0: 7375 6c74 5f67 6466 5b63 6f6c 5d20 3d20  sult_gdf[col] = 
-0000a0f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a100: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0000a110: 5f67 6466 5b63 6f6c 5d20 2023 2074 7970  _gdf[col]  # typ
-0000a120: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-0000a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a140: 2020 2e61 7374 7970 6528 6f62 6a65 6374    .astype(object
-0000a150: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0000a160: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000a170: 2020 2020 2020 2020 2020 2e72 6570 6c61            .repla
-0000a180: 6365 286e 702e 6e61 6e2c 204e 6f6e 6529  ce(np.nan, None)
-0000a190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a1a0: 2020 2020 2029 0a0a 2020 2020 2320 6173       )..    # as
-0000a1b0: 7365 7274 2074 6f20 6576 6164 6520 7079  sert to evade py
-0000a1c0: 4c61 6e63 6520 7761 726e 696e 670a 2020  Lance warning.  
-0000a1d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0000a1e0: 6e63 6528 7265 7375 6c74 5f67 6466 2c20  nce(result_gdf, 
-0000a1f0: 7064 2e44 6174 6146 7261 6d65 2920 6f72  pd.DataFrame) or
-0000a200: 2069 7369 6e73 7461 6e63 6528 0a20 2020   isinstance(.   
-0000a210: 2020 2020 2072 6573 756c 745f 6764 662c       result_gdf,
-0000a220: 2067 7064 2e47 656f 4461 7461 4672 616d   gpd.GeoDataFram
-0000a230: 650a 2020 2020 290a 2020 2020 7265 7475  e.    ).    retu
-0000a240: 726e 2072 6573 756c 745f 6764 660a 0a0a  rn result_gdf...
-0000a250: 6465 6620 5f72 6561 645f 6669 6c65 5f62  def _read_file_b
-0000a260: 6173 655f 7079 6f67 7269 6f28 0a20 2020  ase_pyogrio(.   
-0000a270: 2070 6174 683a 2055 6e69 6f6e 5b73 7472   path: Union[str
-0000a280: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-0000a290: 6e79 5d22 5d2c 0a20 2020 206c 6179 6572  ny]"],.    layer
-0000a2a0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-0000a2b0: 3d20 4e6f 6e65 2c0a 2020 2020 636f 6c75  = None,.    colu
-0000a2c0: 6d6e 733a 204f 7074 696f 6e61 6c5b 4974  mns: Optional[It
-0000a2d0: 6572 6162 6c65 5b73 7472 5d5d 203d 204e  erable[str]] = N
-0000a2e0: 6f6e 652c 0a20 2020 2062 626f 783d 4e6f  one,.    bbox=No
-0000a2f0: 6e65 2c0a 2020 2020 726f 7773 3d4e 6f6e  ne,.    rows=Non
-0000a300: 652c 0a20 2020 2073 716c 5f73 746d 743a  e,.    sql_stmt:
-0000a310: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0000a320: 204e 6f6e 652c 0a20 2020 2073 716c 5f64   None,.    sql_d
-0000a330: 6961 6c65 6374 3a20 4f70 7469 6f6e 616c  ialect: Optional
-0000a340: 5b4c 6974 6572 616c 5b22 5351 4c49 5445  [Literal["SQLITE
-0000a350: 222c 2022 4f47 5253 514c 225d 5d20 3d20  ", "OGRSQL"]] = 
-0000a360: 4e6f 6e65 2c0a 2020 2020 6967 6e6f 7265  None,.    ignore
-0000a370: 5f67 656f 6d65 7472 793a 2062 6f6f 6c20  _geometry: bool 
-0000a380: 3d20 4661 6c73 652c 0a20 2020 2066 6964  = False,.    fid
-0000a390: 5f61 735f 696e 6465 783a 2062 6f6f 6c20  _as_index: bool 
-0000a3a0: 3d20 4661 6c73 652c 0a29 202d 3e20 556e  = False,.) -> Un
-0000a3b0: 696f 6e5b 7064 2e44 6174 6146 7261 6d65  ion[pd.DataFrame
-0000a3c0: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
-0000a3d0: 6d65 5d3a 0a20 2020 2022 2222 0a20 2020  me]:.    """.   
-0000a3e0: 2052 6561 6473 2061 2066 696c 6520 746f   Reads a file to
-0000a3f0: 2061 2070 616e 6461 7320 4461 7461 6672   a pandas Datafr
-0000a400: 616d 6520 7573 696e 6720 7079 6f67 7269  ame using pyogri
-0000a410: 6f2e 0a20 2020 2022 2222 0a20 2020 2023  o..    """.    #
-0000a420: 2049 6e69 740a 2020 2020 7061 7468 203d   Init.    path =
-0000a430: 2050 6174 6828 7061 7468 290a 2020 2020   Path(path).    
-0000a440: 6966 2070 6174 682e 6578 6973 7473 2829  if path.exists()
-0000a450: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
-0000a460: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000a470: 726f 7228 6622 6669 6c65 2064 6f65 736e  ror(f"file doesn
-0000a480: 2774 2065 7869 7374 3a20 7b70 6174 687d  't exist: {path}
-0000a490: 2229 0a0a 2020 2020 2320 436f 6e76 6572  ")..    # Conver
-0000a4a0: 7420 736c 6963 6520 6f62 6a65 6374 2074  t slice object t
-0000a4b0: 6f20 7079 6f67 7269 6f20 7061 7261 6d65  o pyogrio parame
-0000a4c0: 7465 7273 0a20 2020 2069 6620 726f 7773  ters.    if rows
-0000a4d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000a4e0: 2020 2020 2020 736b 6970 5f66 6561 7475        skip_featu
-0000a4f0: 7265 7320 3d20 726f 7773 2e73 7461 7274  res = rows.start
-0000a500: 0a20 2020 2020 2020 206d 6178 5f66 6561  .        max_fea
-0000a510: 7475 7265 7320 3d20 726f 7773 2e73 746f  tures = rows.sto
-0000a520: 7020 2d20 726f 7773 2e73 7461 7274 0a20  p - rows.start. 
-0000a530: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a540: 2073 6b69 705f 6665 6174 7572 6573 203d   skip_features =
-0000a550: 2030 0a20 2020 2020 2020 206d 6178 5f66   0.        max_f
-0000a560: 6561 7475 7265 7320 3d20 4e6f 6e65 0a0a  eatures = None..
-0000a570: 2020 2020 2320 4966 206e 6f20 7371 6c5f      # If no sql_
-0000a580: 7374 6d74 2073 7065 6369 6669 6564 0a20  stmt specified. 
-0000a590: 2020 2063 6f6c 756d 6e73 5f70 7265 7061     columns_prepa
-0000a5a0: 7265 6420 3d20 4e6f 6e65 0a20 2020 2069  red = None.    i
-0000a5b0: 6620 7371 6c5f 7374 6d74 2069 7320 4e6f  f sql_stmt is No
-0000a5c0: 6e65 3a0a 2020 2020 2020 2020 2320 4966  ne:.        # If
-0000a5d0: 206e 6f20 6c61 7965 7220 7370 6563 6966   no layer specif
-0000a5e0: 6965 642c 2074 6865 7265 2073 686f 756c  ied, there shoul
-0000a5f0: 6420 6265 206f 6e6c 7920 6f6e 6520 6c61  d be only one la
-0000a600: 7965 7220 696e 2074 6865 2066 696c 652e  yer in the file.
-0000a610: 0a20 2020 2020 2020 2069 6620 6c61 7965  .        if laye
-0000a620: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-0000a630: 2020 2020 2020 206c 6179 6572 203d 2067         layer = g
-0000a640: 6574 5f6f 6e6c 795f 6c61 7965 7228 7061  et_only_layer(pa
-0000a650: 7468 290a 0a20 2020 2020 2020 2023 2043  th)..        # C
-0000a660: 6865 636b 696e 6720 6966 2063 6f6c 756d  hecking if colum
-0000a670: 6e20 6e61 6d65 7320 7368 6f75 6c64 2062  n names should b
-0000a680: 6520 7265 6164 2069 7320 6361 7365 2073  e read is case s
-0000a690: 656e 7369 7469 7665 2069 6e20 7079 6f67  ensitive in pyog
-0000a6a0: 7269 6f2c 2073 6f0a 2020 2020 2020 2020  rio, so.        
-0000a6b0: 2320 6d61 6b65 2073 7572 6520 7468 6520  # make sure the 
-0000a6c0: 636f 6c75 6d6e 206e 616d 6573 2073 7065  column names spe
-0000a6d0: 6369 6669 6564 2068 6176 6520 7468 6520  cified have the 
-0000a6e0: 7361 6d65 2063 6173 696e 672e 0a20 2020  same casing..   
-0000a6f0: 2020 2020 2069 6620 636f 6c75 6d6e 7320       if columns 
-0000a700: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000a710: 2020 2020 2020 2020 206c 6179 6572 696e           layerin
-0000a720: 666f 203d 2067 6574 5f6c 6179 6572 696e  fo = get_layerin
-0000a730: 666f 2870 6174 682c 206c 6179 6572 3d6c  fo(path, layer=l
-0000a740: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
-0000a750: 2020 636f 6c75 6d6e 735f 7570 7065 725f    columns_upper_
-0000a760: 6c6f 6f6b 7570 203d 207b 636f 6c75 6d6e  lookup = {column
-0000a770: 2e75 7070 6572 2829 3a20 636f 6c75 6d6e  .upper(): column
-0000a780: 2066 6f72 2063 6f6c 756d 6e20 696e 2063   for column in c
-0000a790: 6f6c 756d 6e73 7d0a 2020 2020 2020 2020  olumns}.        
-0000a7a0: 2020 2020 636f 6c75 6d6e 735f 7072 6570      columns_prep
-0000a7b0: 6172 6564 203d 207b 0a20 2020 2020 2020  ared = {.       
-0000a7c0: 2020 2020 2020 2020 2063 6f6c 756d 6e3a           column:
-0000a7d0: 2063 6f6c 756d 6e73 5f75 7070 6572 5f6c   columns_upper_l
-0000a7e0: 6f6f 6b75 705b 636f 6c75 6d6e 2e75 7070  ookup[column.upp
-0000a7f0: 6572 2829 5d0a 2020 2020 2020 2020 2020  er()].          
-0000a800: 2020 2020 2020 666f 7220 636f 6c75 6d6e        for column
-0000a810: 2069 6e20 6c61 7965 7269 6e66 6f2e 636f   in layerinfo.co
-0000a820: 6c75 6d6e 730a 2020 2020 2020 2020 2020  lumns.          
-0000a830: 2020 2020 2020 6966 2063 6f6c 756d 6e2e        if column.
-0000a840: 7570 7065 7228 2920 696e 2063 6f6c 756d  upper() in colum
-0000a850: 6e73 5f75 7070 6572 5f6c 6f6f 6b75 700a  ns_upper_lookup.
-0000a860: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0000a870: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000a880: 2320 4669 6c6c 206f 7574 2070 6c61 6365  # Fill out place
-0000a890: 686f 6c64 6572 732c 206b 6565 7020 636f  holders, keep co
-0000a8a0: 6c75 6d6e 735f 7072 6570 6172 6564 204e  lumns_prepared N
-0000a8b0: 6f6e 6520 6265 6361 7573 6520 636f 6c75  one because colu
-0000a8c0: 6d6e 2066 696c 7465 7269 6e67 0a20 2020  mn filtering.   
-0000a8d0: 2020 2020 2023 2073 686f 756c 6420 6861       # should ha
-0000a8e0: 7070 656e 2069 6e20 7371 6c5f 7374 6d74  ppen in sql_stmt
-0000a8f0: 2e0a 2020 2020 2020 2020 7371 6c5f 7374  ..        sql_st
-0000a900: 6d74 203d 205f 6669 6c6c 5f6f 7574 5f73  mt = _fill_out_s
-0000a910: 716c 5f70 6c61 6365 686f 6c64 6572 7328  ql_placeholders(
-0000a920: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-0000a930: 683d 7061 7468 2c20 6c61 7965 723d 6c61  h=path, layer=la
-0000a940: 7965 722c 2073 716c 5f73 746d 743d 7371  yer, sql_stmt=sq
-0000a950: 6c5f 7374 6d74 2c20 636f 6c75 6d6e 733d  l_stmt, columns=
-0000a960: 636f 6c75 6d6e 730a 2020 2020 2020 2020  columns.        
-0000a970: 290a 0a20 2020 2023 2052 6561 6421 0a20  )..    # Read!. 
-0000a980: 2020 2063 6f6c 756d 6e73 5f6c 6973 7420     columns_list 
-0000a990: 3d20 4e6f 6e65 2069 6620 636f 6c75 6d6e  = None if column
-0000a9a0: 735f 7072 6570 6172 6564 2069 7320 4e6f  s_prepared is No
-0000a9b0: 6e65 2065 6c73 6520 6c69 7374 2863 6f6c  ne else list(col
-0000a9c0: 756d 6e73 5f70 7265 7061 7265 6429 0a20  umns_prepared). 
-0000a9d0: 2020 2072 6573 756c 745f 6764 6620 3d20     result_gdf = 
-0000a9e0: 7079 6f67 7269 6f2e 7265 6164 5f64 6174  pyogrio.read_dat
-0000a9f0: 6166 7261 6d65 280a 2020 2020 2020 2020  aframe(.        
-0000aa00: 7061 7468 2c0a 2020 2020 2020 2020 6c61  path,.        la
-0000aa10: 7965 723d 6c61 7965 722c 0a20 2020 2020  yer=layer,.     
-0000aa20: 2020 2063 6f6c 756d 6e73 3d63 6f6c 756d     columns=colum
-0000aa30: 6e73 5f6c 6973 742c 0a20 2020 2020 2020  ns_list,.       
-0000aa40: 2062 626f 783d 6262 6f78 2c0a 2020 2020   bbox=bbox,.    
-0000aa50: 2020 2020 736b 6970 5f66 6561 7475 7265      skip_feature
-0000aa60: 733d 736b 6970 5f66 6561 7475 7265 732c  s=skip_features,
-0000aa70: 0a20 2020 2020 2020 206d 6178 5f66 6561  .        max_fea
-0000aa80: 7475 7265 733d 6d61 785f 6665 6174 7572  tures=max_featur
-0000aa90: 6573 2c0a 2020 2020 2020 2020 7371 6c3d  es,.        sql=
-0000aaa0: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
-0000aab0: 2020 7371 6c5f 6469 616c 6563 743d 7371    sql_dialect=sq
-0000aac0: 6c5f 6469 616c 6563 742c 0a20 2020 2020  l_dialect,.     
-0000aad0: 2020 2072 6561 645f 6765 6f6d 6574 7279     read_geometry
-0000aae0: 3d6e 6f74 2069 676e 6f72 655f 6765 6f6d  =not ignore_geom
-0000aaf0: 6574 7279 2c0a 2020 2020 2020 2020 6669  etry,.        fi
-0000ab00: 645f 6173 5f69 6e64 6578 3d66 6964 5f61  d_as_index=fid_a
-0000ab10: 735f 696e 6465 782c 0a20 2020 2029 0a0a  s_index,.    )..
-0000ab20: 2020 2020 2320 5265 6f72 6465 7220 636f      # Reorder co
-0000ab30: 6c75 6d6e 7320 2b20 6368 616e 6765 2063  lumns + change c
-0000ab40: 6173 696e 6720 736f 2074 6865 7920 6172  asing so they ar
-0000ab50: 6520 7468 6520 7361 6d65 2061 7320 636f  e the same as co
-0000ab60: 6c75 6d6e 7320 7061 7261 6d65 7465 720a  lumns parameter.
-0000ab70: 2020 2020 6966 2063 6f6c 756d 6e73 5f70      if columns_p
-0000ab80: 7265 7061 7265 6420 6973 206e 6f74 204e  repared is not N
-0000ab90: 6f6e 6520 616e 6420 6c65 6e28 636f 6c75  one and len(colu
-0000aba0: 6d6e 735f 7072 6570 6172 6564 2920 3e20  mns_prepared) > 
-0000abb0: 303a 0a20 2020 2020 2020 2072 6573 756c  0:.        resul
-0000abc0: 745f 6764 6620 3d20 7265 7375 6c74 5f67  t_gdf = result_g
-0000abd0: 6466 5b6c 6973 7428 636f 6c75 6d6e 735f  df[list(columns_
-0000abe0: 7072 6570 6172 6564 2920 2b20 5b22 6765  prepared) + ["ge
-0000abf0: 6f6d 6574 7279 225d 5d0a 2020 2020 2020  ometry"]].      
-0000ac00: 2020 7265 7375 6c74 5f67 6466 203d 2072    result_gdf = r
-0000ac10: 6573 756c 745f 6764 662e 7265 6e61 6d65  esult_gdf.rename
-0000ac20: 2863 6f6c 756d 6e73 3d63 6f6c 756d 6e73  (columns=columns
-0000ac30: 5f70 7265 7061 7265 6429 2020 2320 7479  _prepared)  # ty
-0000ac40: 7065 3a20 6967 6e6f 7265 0a0a 2020 2020  pe: ignore..    
-0000ac50: 2320 6173 7365 7274 2074 6f20 6576 6164  # assert to evad
-0000ac60: 6520 7079 4c61 6e63 6520 7761 726e 696e  e pyLance warnin
-0000ac70: 670a 2020 2020 6173 7365 7274 2069 7369  g.    assert isi
-0000ac80: 6e73 7461 6e63 6528 7265 7375 6c74 5f67  nstance(result_g
-0000ac90: 6466 2c20 7064 2e44 6174 6146 7261 6d65  df, pd.DataFrame
-0000aca0: 2920 6f72 2069 7369 6e73 7461 6e63 6528  ) or isinstance(
-0000acb0: 0a20 2020 2020 2020 2072 6573 756c 745f  .        result_
-0000acc0: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000acd0: 4672 616d 650a 2020 2020 290a 2020 2020  Frame.    ).    
-0000ace0: 7265 7475 726e 2072 6573 756c 745f 6764  return result_gd
-0000acf0: 660a 0a0a 6465 6620 5f66 696c 6c5f 6f75  f...def _fill_ou
-0000ad00: 745f 7371 6c5f 706c 6163 6568 6f6c 6465  t_sql_placeholde
-0000ad10: 7273 280a 2020 2020 7061 7468 3a20 5061  rs(.    path: Pa
-0000ad20: 7468 2c20 6c61 7965 723a 204f 7074 696f  th, layer: Optio
-0000ad30: 6e61 6c5b 7374 725d 2c20 7371 6c5f 7374  nal[str], sql_st
-0000ad40: 6d74 3a20 7374 722c 2063 6f6c 756d 6e73  mt: str, columns
-0000ad50: 3a20 4f70 7469 6f6e 616c 5b49 7465 7261  : Optional[Itera
-0000ad60: 626c 655b 7374 725d 5d0a 2920 2d3e 2073  ble[str]].) -> s
-0000ad70: 7472 3a0a 2020 2020 2320 4669 6c6c 206f  tr:.    # Fill o
-0000ad80: 7574 2070 6c61 6365 686f 6c64 6572 7320  ut placeholders 
-0000ad90: 696e 2074 6865 2073 716c 5f73 746d 7420  in the sql_stmt 
-0000ada0: 6966 206e 6565 6465 643a 0a20 2020 2070  if needed:.    p
-0000adb0: 6c61 6365 686f 6c64 6572 7320 3d20 5b0a  laceholders = [.
-0000adc0: 2020 2020 2020 2020 6e61 6d65 2066 6f72          name for
-0000add0: 205f 2c20 6e61 6d65 2c20 5f2c 205f 2069   _, name, _, _ i
-0000ade0: 6e20 7374 7269 6e67 2e46 6f72 6d61 7474  n string.Formatt
-0000adf0: 6572 2829 2e70 6172 7365 2873 716c 5f73  er().parse(sql_s
-0000ae00: 746d 7429 2069 6620 6e61 6d65 0a20 2020  tmt) if name.   
-0000ae10: 205d 0a20 2020 206c 6179 6572 5f74 6d70   ].    layer_tmp
-0000ae20: 203d 206c 6179 6572 0a20 2020 206c 6179   = layer.    lay
-0000ae30: 6572 696e 666f 203d 204e 6f6e 650a 2020  erinfo = None.  
-0000ae40: 2020 666f 726d 6174 5f6b 7761 7267 7320    format_kwargs 
-0000ae50: 3d20 7b7d 0a20 2020 2066 6f72 2070 6c61  = {}.    for pla
-0000ae60: 6365 686f 6c64 6572 2069 6e20 706c 6163  ceholder in plac
-0000ae70: 6568 6f6c 6465 7273 3a0a 2020 2020 2020  eholders:.      
-0000ae80: 2020 6966 206c 6179 6572 5f74 6d70 2069    if layer_tmp i
-0000ae90: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000aea0: 2020 2020 6c61 7965 725f 746d 7020 3d20      layer_tmp = 
-0000aeb0: 6765 745f 6f6e 6c79 5f6c 6179 6572 2870  get_only_layer(p
-0000aec0: 6174 6829 0a20 2020 2020 2020 2069 6620  ath).        if 
-0000aed0: 706c 6163 6568 6f6c 6465 7220 3d3d 2022  placeholder == "
-0000aee0: 696e 7075 745f 6c61 7965 7222 3a0a 2020  input_layer":.  
-0000aef0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0000af00: 5f6b 7761 7267 735b 706c 6163 6568 6f6c  _kwargs[placehol
-0000af10: 6465 725d 203d 206c 6179 6572 5f74 6d70  der] = layer_tmp
-0000af20: 0a20 2020 2020 2020 2065 6c69 6620 706c  .        elif pl
-0000af30: 6163 6568 6f6c 6465 7220 3d3d 2022 6765  aceholder == "ge
-0000af40: 6f6d 6574 7279 636f 6c75 6d6e 223a 0a20  ometrycolumn":. 
-0000af50: 2020 2020 2020 2020 2020 2069 6620 6c61             if la
-0000af60: 7965 7269 6e66 6f20 6973 204e 6f6e 653a  yerinfo is None:
-0000af70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af80: 206c 6179 6572 696e 666f 203d 2067 6574   layerinfo = get
-0000af90: 5f6c 6179 6572 696e 666f 2870 6174 682c  _layerinfo(path,
-0000afa0: 206c 6179 6572 5f74 6d70 290a 2020 2020   layer_tmp).    
-0000afb0: 2020 2020 2020 2020 666f 726d 6174 5f6b          format_k
-0000afc0: 7761 7267 735b 706c 6163 6568 6f6c 6465  wargs[placeholde
-0000afd0: 725d 203d 206c 6179 6572 696e 666f 2e67  r] = layerinfo.g
-0000afe0: 656f 6d65 7472 7963 6f6c 756d 6e0a 2020  eometrycolumn.  
-0000aff0: 2020 2020 2020 656c 6966 2070 6c61 6365        elif place
-0000b000: 686f 6c64 6572 203d 3d20 2263 6f6c 756d  holder == "colum
-0000b010: 6e73 5f74 6f5f 7365 6c65 6374 5f73 7472  ns_to_select_str
-0000b020: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
-0000b030: 6620 6c61 7965 7269 6e66 6f20 6973 204e  f layerinfo is N
-0000b040: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000b050: 2020 2020 206c 6179 6572 696e 666f 203d       layerinfo =
-0000b060: 2067 6574 5f6c 6179 6572 696e 666f 2870   get_layerinfo(p
-0000b070: 6174 682c 206c 6179 6572 5f74 6d70 290a  ath, layer_tmp).
-0000b080: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-0000b090: 6d6e 735f 6173 6b65 6420 3d20 4e6f 6e65  mns_asked = None
-0000b0a0: 2069 6620 636f 6c75 6d6e 7320 6973 204e   if columns is N
-0000b0b0: 6f6e 6520 656c 7365 206c 6973 7428 636f  one else list(co
-0000b0c0: 6c75 6d6e 7329 0a20 2020 2020 2020 2020  lumns).         
-0000b0d0: 2020 2066 6f72 6d61 7474 6572 203d 205f     formatter = _
-0000b0e0: 6f67 725f 7371 6c5f 7574 696c 2e43 6f6c  ogr_sql_util.Col
-0000b0f0: 756d 6e46 6f72 6d61 7474 6572 280a 2020  umnFormatter(.  
-0000b100: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000b110: 6c75 6d6e 735f 6173 6b65 643d 636f 6c75  lumns_asked=colu
-0000b120: 6d6e 735f 6173 6b65 642c 0a20 2020 2020  mns_asked,.     
-0000b130: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
-0000b140: 6e73 5f69 6e5f 6c61 7965 723d 6c61 7965  ns_in_layer=laye
-0000b150: 7269 6e66 6f2e 636f 6c75 6d6e 732c 0a20  rinfo.columns,. 
-0000b160: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000b170: 6964 5f63 6f6c 756d 6e3d 6c61 7965 7269  id_column=layeri
-0000b180: 6e66 6f2e 6669 645f 636f 6c75 6d6e 2c0a  nfo.fid_column,.
-0000b190: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000b1a0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0000b1b0: 5f6b 7761 7267 735b 706c 6163 6568 6f6c  _kwargs[placehol
-0000b1c0: 6465 725d 203d 2066 6f72 6d61 7474 6572  der] = formatter
-0000b1d0: 2e70 7265 6669 7865 645f 616c 6961 7365  .prefixed_aliase
-0000b1e0: 6428 290a 0a20 2020 2020 2020 2065 6c73  d()..        els
-0000b1f0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000b200: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000b210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b220: 2066 2275 6e6b 6e6f 776e 2070 6c61 6365   f"unknown place
-0000b230: 686f 6c64 6572 207b 706c 6163 6568 6f6c  holder {placehol
-0000b240: 6465 727d 2069 6e20 7371 6c5f 7374 6d74  der} in sql_stmt
-0000b250: 3a20 7b73 716c 5f73 746d 747d 220a 2020  : {sql_stmt}".  
-0000b260: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000b270: 2069 6620 6c65 6e28 666f 726d 6174 5f6b   if len(format_k
-0000b280: 7761 7267 7329 203e 2030 3a0a 2020 2020  wargs) > 0:.    
-0000b290: 2020 2020 7371 6c5f 7374 6d74 203d 2073      sql_stmt = s
-0000b2a0: 716c 5f73 746d 742e 666f 726d 6174 282a  ql_stmt.format(*
-0000b2b0: 2a66 6f72 6d61 745f 6b77 6172 6773 290a  *format_kwargs).
-0000b2c0: 2020 2020 7265 7475 726e 2073 716c 5f73      return sql_s
-0000b2d0: 746d 740a 0a0a 6465 6620 7265 6164 5f66  tmt...def read_f
-0000b2e0: 696c 655f 7371 6c28 0a20 2020 2070 6174  ile_sql(.    pat
-0000b2f0: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-0000b300: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-0000b310: 5d2c 0a20 2020 2073 716c 5f73 746d 743a  ],.    sql_stmt:
-0000b320: 2073 7472 2c0a 2020 2020 7371 6c5f 6469   str,.    sql_di
-0000b330: 616c 6563 743a 204f 7074 696f 6e61 6c5b  alect: Optional[
-0000b340: 4c69 7465 7261 6c5b 2253 514c 4954 4522  Literal["SQLITE"
-0000b350: 2c20 224f 4752 5351 4c22 5d5d 203d 2022  , "OGRSQL"]] = "
-0000b360: 5351 4c49 5445 222c 0a20 2020 206c 6179  SQLITE",.    lay
-0000b370: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-0000b380: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6967  ] = None,.    ig
-0000b390: 6e6f 7265 5f67 656f 6d65 7472 793a 2062  nore_geometry: b
-0000b3a0: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-0000b3b0: 3e20 556e 696f 6e5b 7064 2e44 6174 6146  > Union[pd.DataF
-0000b3c0: 7261 6d65 2c20 6770 642e 4765 6f44 6174  rame, gpd.GeoDat
-0000b3d0: 6146 7261 6d65 5d3a 0a20 2020 2022 2222  aFrame]:.    """
-0000b3e0: 0a20 2020 2044 4550 5245 4341 5445 443a  .    DEPRECATED:
-0000b3f0: 2052 6561 6473 2061 2066 696c 6520 7573   Reads a file us
-0000b400: 696e 6720 616e 2073 716c 2073 7461 7465  ing an sql state
-0000b410: 6d65 6e74 2e0a 0a20 2020 2041 7267 733a  ment...    Args:
-0000b420: 0a20 2020 2020 2020 2070 6174 6820 2866  .        path (f
-0000b430: 696c 6520 7061 7468 293a 2070 6174 6820  ile path): path 
-0000b440: 746f 2074 6865 2066 696c 6520 746f 2072  to the file to r
-0000b450: 6561 6420 6672 6f6d 0a20 2020 2020 2020  ead from.       
-0000b460: 2073 716c 5f73 746d 7420 2873 7472 293a   sql_stmt (str):
-0000b470: 2073 716c 2073 7461 7465 6d65 6e74 2074   sql statement t
-0000b480: 6f20 7573 650a 2020 2020 2020 2020 7371  o use.        sq
-0000b490: 6c5f 6469 616c 6563 7420 2873 7472 2c20  l_dialect (str, 
-0000b4a0: 6f70 7469 6f6e 616c 293a 2053 716c 2064  optional): Sql d
-0000b4b0: 6961 6c65 6374 2075 7365 642e 2044 6566  ialect used. Def
-0000b4c0: 6175 6c74 7320 746f 2027 5351 4c49 5445  aults to 'SQLITE
-0000b4d0: 272e 0a20 2020 2020 2020 206c 6179 6572  '..        layer
-0000b4e0: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-0000b4f0: 3a20 5468 6520 6c61 7965 7220 746f 2072  : The layer to r
-0000b500: 6561 642e 2049 6620 6e6f 206c 6179 6572  ead. If no layer
-0000b510: 2069 7320 7370 6563 6966 6965 642c 0a20   is specified,. 
-0000b520: 2020 2020 2020 2020 2020 2072 6561 6473             reads
-0000b530: 2074 6865 206f 6e6c 7920 6c61 7965 7220   the only layer 
-0000b540: 696e 2074 6865 2066 696c 6520 6f72 2074  in the file or t
-0000b550: 6872 6f77 7320 616e 2045 7863 6570 7469  hrows an Excepti
-0000b560: 6f6e 2e0a 2020 2020 2020 2020 6967 6e6f  on..        igno
-0000b570: 7265 5f67 656f 6d65 7472 7920 2862 6f6f  re_geometry (boo
-0000b580: 6c2c 206f 7074 696f 6e61 6c29 3a20 5472  l, optional): Tr
-0000b590: 7565 206e 6f74 2074 6f20 7265 6164 2f72  ue not to read/r
-0000b5a0: 6574 7572 6e20 7468 6520 6765 6f6d 6174  eturn the geomat
-0000b5b0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
-0000b5c0: 4465 6661 756c 7473 2074 6f20 4661 6c73  Defaults to Fals
-0000b5d0: 652e 0a0a 2020 2020 5265 7475 726e 733a  e...    Returns:
-0000b5e0: 0a20 2020 2020 2020 2055 6e69 6f6e 5b70  .        Union[p
-0000b5f0: 642e 4461 7461 4672 616d 652c 2067 7064  d.DataFrame, gpd
-0000b600: 2e47 656f 4461 7461 4672 616d 655d 3a20  .GeoDataFrame]: 
-0000b610: 5468 6520 6461 7461 2072 6561 642e 0a20  The data read.. 
-0000b620: 2020 2022 2222 0a20 2020 2077 6172 6e69     """.    warni
-0000b630: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
-0000b640: 2020 2772 6561 645f 6669 6c65 5f73 716c    'read_file_sql
-0000b650: 2069 7320 6465 7072 6563 6174 6564 3a20   is deprecated: 
-0000b660: 7573 6520 7265 6164 5f66 696c 6521 204d  use read_file! M
-0000b670: 696e 643a 2073 716c 5f64 6961 6c65 6374  ind: sql_dialect
-0000b680: 2069 7320 6e6f 7420 2253 514c 4954 4522   is not "SQLITE"
-0000b690: 2027 0a20 2020 2020 2020 2022 6279 2064   '.        "by d
-0000b6a0: 6566 6175 6c74 2074 6865 7265 2122 2c0a  efault there!",.
-0000b6b0: 2020 2020 2020 2020 4675 7475 7265 5761          FutureWa
-0000b6c0: 726e 696e 672c 0a20 2020 2029 0a0a 2020  rning,.    )..  
-0000b6d0: 2020 2320 5275 6e0a 2020 2020 7265 7475    # Run.    retu
-0000b6e0: 726e 205f 7265 6164 5f66 696c 655f 6261  rn _read_file_ba
-0000b6f0: 7365 280a 2020 2020 2020 2020 7061 7468  se(.        path
-0000b700: 2c0a 2020 2020 2020 2020 7371 6c5f 7374  ,.        sql_st
-0000b710: 6d74 3d73 716c 5f73 746d 742c 0a20 2020  mt=sql_stmt,.   
-0000b720: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
-0000b730: 3d73 716c 5f64 6961 6c65 6374 2c0a 2020  =sql_dialect,.  
-0000b740: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
-0000b750: 722c 0a20 2020 2020 2020 2069 676e 6f72  r,.        ignor
-0000b760: 655f 6765 6f6d 6574 7279 3d69 676e 6f72  e_geometry=ignor
-0000b770: 655f 6765 6f6d 6574 7279 2c0a 2020 2020  e_geometry,.    
-0000b780: 290a 0a0a 6465 6620 746f 5f66 696c 6528  )...def to_file(
-0000b790: 0a20 2020 2067 6466 3a20 556e 696f 6e5b  .    gdf: Union[
-0000b7a0: 7064 2e44 6174 6146 7261 6d65 2c20 6770  pd.DataFrame, gp
-0000b7b0: 642e 4765 6f44 6174 6146 7261 6d65 5d2c  d.GeoDataFrame],
-0000b7c0: 0a20 2020 2070 6174 683a 2055 6e69 6f6e  .    path: Union
-0000b7d0: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
-0000b7e0: 6b65 5b41 6e79 5d22 5d2c 0a20 2020 206c  ke[Any]"],.    l
-0000b7f0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-0000b800: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-0000b810: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000b820: 6d65 7472 7974 7970 653a 2055 6e69 6f6e  metrytype: Union
-0000b830: 5b47 656f 6d65 7472 7954 7970 652c 2073  [GeometryType, s
-0000b840: 7472 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65  tr, None] = None
-0000b850: 2c0a 2020 2020 666f 7263 655f 6d75 6c74  ,.    force_mult
-0000b860: 6974 7970 653a 2062 6f6f 6c20 3d20 4661  itype: bool = Fa
-0000b870: 6c73 652c 0a20 2020 2061 7070 656e 643a  lse,.    append:
-0000b880: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-0000b890: 2020 2061 7070 656e 645f 7469 6d65 6f75     append_timeou
-0000b8a0: 745f 733a 2069 6e74 203d 2036 3030 2c0a  t_s: int = 600,.
-0000b8b0: 2020 2020 696e 6465 783a 204f 7074 696f      index: Optio
-0000b8c0: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
-0000b8d0: 2c0a 2020 2020 6372 6561 7465 5f73 7061  ,.    create_spa
-0000b8e0: 7469 616c 5f69 6e64 6578 3a20 4f70 7469  tial_index: Opti
-0000b8f0: 6f6e 616c 5b62 6f6f 6c5d 203d 2054 7275  onal[bool] = Tru
-0000b900: 652c 0a29 3a0a 2020 2020 2222 220a 2020  e,.):.    """.  
-0000b910: 2020 5772 6974 6573 2061 2070 616e 6461    Writes a panda
-0000b920: 7320 6461 7461 6672 616d 6520 746f 2066  s dataframe to f
-0000b930: 696c 652e 0a0a 2020 2020 5468 6520 6669  ile...    The fi
-0000b940: 6c65 666f 726d 6174 2069 7320 6465 7465  leformat is dete
-0000b950: 6374 6564 2062 6173 6564 206f 6e20 7468  cted based on th
-0000b960: 6520 6669 6c65 7061 7468 2065 7874 656e  e filepath exten
-0000b970: 7369 6f6e 2e0a 0a20 2020 2054 6865 2075  sion...    The u
-0000b980: 6e64 6572 6c79 696e 6720 6c69 6272 6172  nderlying librar
-0000b990: 7920 7573 6564 2074 6f20 7772 6974 6520  y used to write 
-0000b9a0: 7468 6520 6669 6c65 2063 616e 2062 6520  the file can be 
-0000b9b0: 6368 6f6f 7365 6e20 7573 696e 6720 7468  choosen using th
-0000b9c0: 650a 2020 2020 2247 464f 5f49 4f5f 454e  e.    "GFO_IO_EN
-0000b9d0: 4749 4e45 2220 656e 7669 726f 6e6d 656e  GINE" environmen
-0000b9e0: 7420 7661 7269 6162 6c65 2e20 506f 7373  t variable. Poss
-0000b9f0: 6962 6c65 2076 616c 7565 7320 6172 6520  ible values are 
-0000ba00: 2266 696f 6e61 2220 616e 6420 2270 796f  "fiona" and "pyo
-0000ba10: 6772 696f 222e 0a20 2020 2044 6566 6175  grio"..    Defau
-0000ba20: 6c74 2065 6e67 696e 6520 6973 2022 7079  lt engine is "py
-0000ba30: 6f67 7269 6f22 2e0a 0a20 2020 2041 7267  ogrio"...    Arg
-0000ba40: 733a 0a20 2020 2020 2020 2067 6466 2028  s:.        gdf (
-0000ba50: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000ba60: 293a 2054 6865 2047 656f 4461 7461 4672  ): The GeoDataFr
-0000ba70: 616d 6520 746f 2065 7870 6f72 7420 746f  ame to export to
-0000ba80: 2066 696c 652e 0a20 2020 2020 2020 2070   file..        p
-0000ba90: 6174 6820 2855 6e69 6f6e 5b73 7472 2c29  ath (Union[str,)
-0000baa0: 3a20 5468 6520 6669 6c65 2070 6174 6820  : The file path 
-0000bab0: 746f 2077 7269 7465 2074 6f2e 0a20 2020  to write to..   
-0000bac0: 2020 2020 206c 6179 6572 2028 7374 722c       layer (str,
-0000bad0: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-0000bae0: 6c61 7965 7220 746f 2072 6561 642e 2049  layer to read. I
-0000baf0: 6620 6e6f 206c 6179 6572 2069 7320 7370  f no layer is sp
-0000bb00: 6563 6966 6965 642c 0a20 2020 2020 2020  ecified,.       
-0000bb10: 2020 2020 2072 6561 6473 2074 6865 206f       reads the o
-0000bb20: 6e6c 7920 6c61 7965 7220 696e 2074 6865  nly layer in the
-0000bb30: 2066 696c 6520 6f72 2074 6872 6f77 7320   file or throws 
-0000bb40: 616e 2045 7863 6570 7469 6f6e 2e0a 2020  an Exception..  
-0000bb50: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
-0000bb60: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
-0000bb70: 2855 6e69 6f6e 5b47 656f 6d65 7472 7954  (Union[GeometryT
-0000bb80: 7970 652c 2073 7472 5d2c 206f 7074 696f  ype, str], optio
-0000bb90: 6e61 6c29 3a20 4765 6f6d 6574 7279 2074  nal): Geometry t
-0000bba0: 7970 650a 2020 2020 2020 2020 2020 2020  ype.            
-0000bbb0: 746f 2028 7472 7920 746f 2920 666f 7263  to (try to) forc
-0000bbc0: 6520 7468 6520 6f75 7470 7574 2074 6f2e  e the output to.
-0000bbd0: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-0000bbe0: 652e 0a20 2020 2020 2020 2020 2020 204d  e..            M
-0000bbf0: 6172 6b3a 2063 6f6d 7061 7265 6420 746f  ark: compared to
-0000bc00: 206f 7468 6572 2066 756e 6374 696f 6e73   other functions
-0000bc10: 2069 6e20 6766 6f20 7769 7468 2074 6869   in gfo with thi
-0000bc20: 7320 7061 7261 6d65 7465 722c 2074 6865  s parameter, the
-0000bc30: 2062 6568 6176 696f 7572 0a20 2020 2020   behaviour.     
-0000bc40: 2020 2020 2020 2068 6572 6520 6973 206c         here is l
-0000bc50: 696d 6974 6564 2074 6f20 7468 6520 666f  imited to the fo
-0000bc60: 6c6c 6f77 696e 673a 0a20 2020 2020 2020  llowing:.       
-0000bc70: 2020 2020 2020 2020 202d 2066 6f72 2065           - for e
-0000bc80: 6d70 7479 2069 6e70 7574 2067 6466 2773  mpty input gdf's
-0000bc90: 2c20 6120 7374 616e 6461 7264 2067 656f  , a standard geo
-0000bca0: 6d65 7472 7920 7479 7065 2028 6567 2e20  metry type (eg. 
-0000bcb0: 506f 6c79 676f 6e2c 2e2e 2e29 2063 616e  Polygon,...) can
-0000bcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bcd0: 2020 2062 6520 7573 6564 2074 6f20 666f     be used to fo
-0000bce0: 7263 6520 7468 6520 6765 6f6d 6574 7279  rce the geometry
-0000bcf0: 2063 6f6c 756d 6e20 746f 2062 6520 6f66   column to be of
-0000bd00: 2074 6861 7420 7479 7065 2e0a 2020 2020   that type..    
-0000bd10: 2020 2020 2020 2020 2020 2020 2d20 6966              - if
-0000bd20: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-0000bd30: 6f6d 6574 7279 7479 7065 2069 7320 6120  ometrytype is a 
-0000bd40: 4d55 4c54 4920 7479 7065 2c20 7061 7261  MULTI type, para
-0000bd50: 6d65 7465 720a 2020 2020 2020 2020 2020  meter.          
-0000bd60: 2020 2020 2020 2020 666f 7263 655f 6d75          force_mu
-0000bd70: 6c74 6974 7970 6520 6265 636f 6d65 7320  ltitype becomes 
-0000bd80: 5472 7565 2e0a 2020 2020 2020 2020 666f  True..        fo
-0000bd90: 7263 655f 6d75 6c74 6974 7970 6520 2862  rce_multitype (b
-0000bda0: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
-0000bdb0: 666f 7263 6520 7468 6520 6765 6f6d 6574  force the geomet
-0000bdc0: 7279 2074 7970 6520 746f 2061 206d 756c  ry type to a mul
-0000bdd0: 7469 7479 7065 0a20 2020 2020 2020 2020  titype.         
-0000bde0: 2020 2066 6f72 2066 696c 6520 7479 7065     for file type
-0000bdf0: 7320 7468 6174 2072 6571 7569 7265 206f  s that require o
-0000be00: 6e65 2067 656f 6d65 7472 7974 7970 6520  ne geometrytype 
-0000be10: 7065 7220 6c61 7965 722e 0a20 2020 2020  per layer..     
-0000be20: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-0000be30: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
-0000be40: 2020 6170 7065 6e64 2028 626f 6f6c 2c20    append (bool, 
-0000be50: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
-0000be60: 746f 2061 7070 656e 6420 746f 2074 6865  to append to the
-0000be70: 2066 696c 652f 6c61 7965 7220 6966 2069   file/layer if i
-0000be80: 7420 6578 6973 7473 2061 6c72 6561 6479  t exists already
-0000be90: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
-0000bea0: 2069 7420 646f 6573 6e27 7420 6578 6973   it doesn't exis
-0000beb0: 7420 7965 742c 2069 7420 6973 2063 7265  t yet, it is cre
-0000bec0: 6174 6564 2e20 4465 6661 756c 7473 2074  ated. Defaults t
-0000bed0: 6f20 4661 6c73 652e 0a20 2020 2020 2020  o False..       
-0000bee0: 2061 7070 656e 645f 7469 6d65 6f75 745f   append_timeout_
-0000bef0: 7320 2869 6e74 2c20 6f70 7469 6f6e 616c  s (int, optional
-0000bf00: 293a 2054 6865 206d 6178 696d 756d 2074  ): The maximum t
-0000bf10: 696d 656f 7574 2074 6f20 7761 6974 2077  imeout to wait w
-0000bf20: 6865 6e20 7468 650a 2020 2020 2020 2020  hen the.        
-0000bf30: 2020 2020 6f75 7470 7574 2066 696c 6520      output file 
-0000bf40: 6973 2061 6c72 6561 6479 2062 6569 6e67  is already being
-0000bf50: 2077 7269 7474 656e 2074 6f20 6279 2061   written to by a
-0000bf60: 6e6f 7468 6572 2070 726f 6365 7373 2e0a  nother process..
-0000bf70: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-0000bf80: 756c 7473 2074 6f20 3630 302e 0a20 2020  ults to 600..   
-0000bf90: 2020 2020 2069 6e64 6578 2028 626f 6f6c       index (bool
-0000bfa0: 2c20 6f70 7469 6f6e 616c 293a 2049 6620  , optional): If 
-0000bfb0: 5472 7565 2c20 7772 6974 6520 696e 6465  True, write inde
-0000bfc0: 7820 696e 746f 206f 6e65 206f 7220 6d6f  x into one or mo
-0000bfd0: 7265 2063 6f6c 756d 6e73 2028 666f 720a  re columns (for.
-0000bfe0: 2020 2020 2020 2020 2020 2020 4d75 6c74              Mult
-0000bff0: 6949 6e64 6578 292e 204e 6f6e 6520 7772  iIndex). None wr
-0000c000: 6974 6573 2074 6865 2069 6e64 6578 2069  ites the index i
-0000c010: 6e74 6f20 6f6e 6520 6f72 206d 6f72 6520  nto one or more 
-0000c020: 636f 6c75 6d6e 7320 6f6e 6c79 2069 6620  columns only if 
-0000c030: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0000c040: 696e 6465 7820 6973 206e 616d 6564 2c20  index is named, 
-0000c050: 6973 2061 204d 756c 7469 496e 6465 782c  is a MultiIndex,
-0000c060: 206f 7220 6861 7320 6120 6e6f 6e2d 696e   or has a non-in
-0000c070: 7465 6765 7220 6461 7461 2074 7970 652e  teger data type.
-0000c080: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0000c090: 4661 6c73 652c 206e 6f20 696e 6465 7820  False, no index 
-0000c0a0: 6973 2077 7269 7474 656e 2e20 4465 6661  is written. Defa
-0000c0b0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
-0000c0c0: 2020 2020 2020 6372 6561 7465 5f73 7061        create_spa
-0000c0d0: 7469 616c 5f69 6e64 6578 2028 626f 6f6c  tial_index (bool
-0000c0e0: 2c20 6f70 7469 6f6e 616c 293a 2054 7275  , optional): Tru
-0000c0f0: 6520 746f 2066 6f72 6365 2063 7265 6174  e to force creat
-0000c100: 696f 6e20 6f66 2073 7061 7469 616c 2069  ion of spatial i
-0000c110: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
-0000c120: 2020 4661 6c73 6520 746f 2061 766f 6964    False to avoid
-0000c130: 2063 7265 6174 696f 6e2e 204e 6f6e 6520   creation. None 
-0000c140: 6c65 6164 7320 746f 2074 6865 2064 6566  leads to the def
-0000c150: 6175 6c74 2062 6568 6176 696f 7572 206f  ault behaviour o
-0000c160: 6620 6764 616c 2e0a 2020 2020 2020 2020  f gdal..        
-0000c170: 2020 2020 4465 6661 756c 7473 2074 6f20      Defaults to 
-0000c180: 5472 7565 2e0a 0a20 2020 2052 6169 7365  True...    Raise
-0000c190: 733a 0a20 2020 2020 2020 2056 616c 7565  s:.        Value
-0000c1a0: 4572 726f 723a 2061 6e20 696e 7661 6c69  Error: an invali
-0000c1b0: 6420 7061 7261 6d65 7465 7220 7661 6c75  d parameter valu
-0000c1c0: 6520 7761 7320 7061 7373 6564 2e0a 2020  e was passed..  
-0000c1d0: 2020 2020 2020 5275 6e74 696d 6545 7272        RuntimeErr
-0000c1e0: 6f72 3a20 7469 6d65 6f75 7420 7761 7320  or: timeout was 
-0000c1f0: 7265 6163 6865 6420 7768 696c 6520 7472  reached while tr
-0000c200: 7969 6e67 2074 6f20 6170 7065 6e64 2064  ying to append d
-0000c210: 6174 6120 746f 2070 6174 682e 0a20 2020  ata to path..   
-0000c220: 2022 2222 0a20 2020 2023 2043 6865 636b   """.    # Check
-0000c230: 2069 6e70 7574 2070 6172 616d 6574 6572   input parameter
-0000c240: 730a 2020 2020 2320 2d2d 2d2d 2d2d 2d2d  s.    # --------
-0000c250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0000c260: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
-0000c270: 6174 6829 0a0a 2020 2020 2320 4966 206e  ath)..    # If n
-0000c280: 6f20 6c61 7965 7220 6e61 6d65 2073 7065  o layer name spe
-0000c290: 6369 6669 6564 2c20 6465 7465 726d 696e  cified, determin
-0000c2a0: 6520 6f6e 650a 2020 2020 6966 206c 6179  e one.    if lay
-0000c2b0: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
-0000c2c0: 2020 2020 6966 2061 7070 656e 6420 616e      if append an
-0000c2d0: 6420 7061 7468 2e65 7869 7374 7328 293a  d path.exists():
-0000c2e0: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
-0000c2f0: 6572 203d 2067 6574 5f6f 6e6c 795f 6c61  er = get_only_la
-0000c300: 7965 7228 7061 7468 290a 2020 2020 2020  yer(path).      
-0000c310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000c320: 2020 2020 6c61 7965 7220 3d20 5061 7468      layer = Path
-0000c330: 2870 6174 6829 2e73 7465 6d0a 0a20 2020  (path).stem..   
-0000c340: 2023 2049 6620 666f 7263 655f 6f75 7470   # If force_outp
-0000c350: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
-0000c360: 6973 2061 2073 7472 696e 672c 2063 6865  is a string, che
-0000c370: 636b 2069 6620 6974 2069 7320 6120 2273  ck if it is a "s
-0000c380: 7461 6e64 6172 6422 2067 656f 6d65 7472  tandard" geometr
-0000c390: 790a 2020 2020 2320 7479 7065 2c20 6173  y.    # type, as
-0000c3a0: 2047 4441 4c20 616c 736f 2073 7570 706f   GDAL also suppo
-0000c3b0: 7274 7320 7370 6563 6961 6c20 6765 6f6d  rts special geom
-0000c3c0: 6574 7279 2074 7970 6573 206c 696b 6520  etry types like 
-0000c3d0: 2250 524f 4d4f 5445 5f54 4f5f 4d55 4c54  "PROMOTE_TO_MULT
-0000c3e0: 4922 0a20 2020 2069 6620 6973 696e 7374  I".    if isinst
-0000c3f0: 616e 6365 2866 6f72 6365 5f6f 7574 7075  ance(force_outpu
-0000c400: 745f 6765 6f6d 6574 7279 7479 7065 2c20  t_geometrytype, 
-0000c410: 7374 7229 3a0a 2020 2020 2020 2020 666f  str):.        fo
-0000c420: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-0000c430: 7472 7974 7970 6520 3d20 666f 7263 655f  trytype = force_
-0000c440: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-0000c450: 7970 652e 7570 7065 7228 290a 2020 2020  ype.upper().    
-0000c460: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000c470: 2020 2020 2023 2056 6572 6966 7920 6966       # Verify if
-0000c480: 2069 7420 6973 2061 2022 7374 616e 6461   it is a "standa
-0000c490: 7264 2220 6765 6f6d 6574 7279 2074 7970  rd" geometry typ
-0000c4a0: 652c 2061 7320 4744 414c 2061 6c73 6f20  e, as GDAL also 
-0000c4b0: 7375 7070 6f72 7473 0a20 2020 2020 2020  supports.       
-0000c4c0: 2020 2020 2023 2073 7065 6369 616c 2067       # special g
-0000c4d0: 656f 6d65 7472 7920 7479 7065 7320 6c69  eometry types li
-0000c4e0: 6b65 2022 5052 4f4d 4f54 455f 544f 5f4d  ke "PROMOTE_TO_M
-0000c4f0: 554c 5449 220a 2020 2020 2020 2020 2020  ULTI".          
-0000c500: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-0000c510: 656f 6d65 7472 7974 7970 6520 3d20 4765  eometrytype = Ge
-0000c520: 6f6d 6574 7279 5479 7065 5b66 6f72 6365  ometryType[force
-0000c530: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-0000c540: 7479 7065 5d0a 2020 2020 2020 2020 6578  type].        ex
-0000c550: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-0000c560: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000c570: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-0000c580: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000c590: 556e 7375 7070 6f72 7465 6420 666f 7263  Unsupported forc
-0000c5a0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000c5b0: 7974 7970 653a 207b 666f 7263 655f 6f75  ytype: {force_ou
-0000c5c0: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000c5d0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
-0000c5e0: 290a 2020 2020 6966 2066 6f72 6365 5f6f  ).    if force_o
-0000c5f0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-0000c600: 7065 2069 7320 6e6f 7420 4e6f 6e65 2061  pe is not None a
-0000c610: 6e64 2066 6f72 6365 5f6f 7574 7075 745f  nd force_output_
-0000c620: 6765 6f6d 6574 7279 7479 7065 2e69 735f  geometrytype.is_
-0000c630: 6d75 6c74 6974 7970 653a 0a20 2020 2020  multitype:.     
-0000c640: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
-0000c650: 7065 203d 2054 7275 650a 0a20 2020 2023  pe = True..    #
-0000c660: 2049 6620 7468 6572 6520 6973 206e 6f20   If there is no 
-0000c670: 6765 6f6d 6574 7279 2063 6f6c 756d 6e20  geometry column 
-0000c680: 696e 2074 6865 2069 6e70 7574 2c20 616c  in the input, al
-0000c690: 7761 7973 2075 7365 2066 696f 6e61 2c20  ways use fiona, 
-0000c6a0: 6173 2070 796f 6772 696f 2064 6f65 736e  as pyogrio doesn
-0000c6b0: 2774 0a20 2020 2023 2073 7570 706f 7274  't.    # support
-0000c6c0: 2074 6861 7420 7965 7420 6174 2074 696d   that yet at tim
-0000c6d0: 6520 6f66 2077 7269 7469 6e67 2e0a 2020  e of writing..  
-0000c6e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000c6f0: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000c700: 4672 616d 6529 2069 7320 4661 6c73 6520  Frame) is False 
-0000c710: 6f72 2028 0a20 2020 2020 2020 2069 7369  or (.        isi
-0000c720: 6e73 7461 6e63 6528 6764 662c 2067 7064  nstance(gdf, gpd
-0000c730: 2e47 656f 4461 7461 4672 616d 6529 2061  .GeoDataFrame) a
-0000c740: 6e64 2022 6765 6f6d 6574 7279 2220 6e6f  nd "geometry" no
-0000c750: 7420 696e 2067 6466 2e63 6f6c 756d 6e73  t in gdf.columns
-0000c760: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0000c770: 656e 6769 6e65 203d 2022 6669 6f6e 6122  engine = "fiona"
-0000c780: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000c790: 2020 2065 6e67 696e 6520 3d20 5f67 6574     engine = _get
-0000c7a0: 5f65 6e67 696e 6528 290a 0a20 2020 2023  _engine()..    #
-0000c7b0: 204e 6f77 2077 7269 7465 2077 6974 6820   Now write with 
-0000c7c0: 7468 6520 636f 7272 6563 7420 656e 6769  the correct engi
-0000c7d0: 6e65 0a20 2020 2069 6620 656e 6769 6e65  ne.    if engine
-0000c7e0: 203d 3d20 2270 796f 6772 696f 223a 0a20   == "pyogrio":. 
-0000c7f0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000c800: 696e 7374 616e 6365 2867 6466 2c20 6770  instance(gdf, gp
-0000c810: 642e 4765 6f44 6174 6146 7261 6d65 290a  d.GeoDataFrame).
-0000c820: 2020 2020 2020 2020 7265 7475 726e 205f          return _
-0000c830: 746f 5f66 696c 655f 7079 6f67 7269 6f28  to_file_pyogrio(
-0000c840: 0a20 2020 2020 2020 2020 2020 2067 6466  .            gdf
-0000c850: 3d67 6466 2c0a 2020 2020 2020 2020 2020  =gdf,.          
-0000c860: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
-0000c870: 2020 2020 2020 2020 206c 6179 6572 3d6c           layer=l
-0000c880: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-0000c890: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-0000c8a0: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
-0000c8b0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000c8c0: 7974 7970 652c 0a20 2020 2020 2020 2020  ytype,.         
-0000c8d0: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
-0000c8e0: 7065 3d66 6f72 6365 5f6d 756c 7469 7479  pe=force_multity
-0000c8f0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-0000c900: 6170 7065 6e64 3d61 7070 656e 642c 0a20  append=append,. 
-0000c910: 2020 2020 2020 2020 2020 2061 7070 656e             appen
-0000c920: 645f 7469 6d65 6f75 745f 733d 6170 7065  d_timeout_s=appe
-0000c930: 6e64 5f74 696d 656f 7574 5f73 2c0a 2020  nd_timeout_s,.  
-0000c940: 2020 2020 2020 2020 2020 696e 6465 783d            index=
-0000c950: 696e 6465 782c 0a20 2020 2020 2020 2020  index,.         
-0000c960: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
-0000c970: 6c5f 696e 6465 783d 6372 6561 7465 5f73  l_index=create_s
-0000c980: 7061 7469 616c 5f69 6e64 6578 2c0a 2020  patial_index,.  
-0000c990: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0000c9a0: 2065 6e67 696e 6520 3d3d 2022 6669 6f6e   engine == "fion
-0000c9b0: 6122 3a0a 2020 2020 2020 2020 7265 7475  a":.        retu
-0000c9c0: 726e 205f 746f 5f66 696c 655f 6669 6f6e  rn _to_file_fion
-0000c9d0: 6128 0a20 2020 2020 2020 2020 2020 2067  a(.            g
-0000c9e0: 6466 3d67 6466 2c0a 2020 2020 2020 2020  df=gdf,.        
-0000c9f0: 2020 2020 7061 7468 3d70 6174 682c 0a20      path=path,. 
-0000ca00: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-0000ca10: 3d6c 6179 6572 2c0a 2020 2020 2020 2020  =layer,.        
-0000ca20: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-0000ca30: 5f67 656f 6d65 7472 7974 7970 653d 666f  _geometrytype=fo
-0000ca40: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-0000ca50: 7472 7974 7970 652c 0a20 2020 2020 2020  trytype,.       
-0000ca60: 2020 2020 2066 6f72 6365 5f6d 756c 7469       force_multi
-0000ca70: 7479 7065 3d66 6f72 6365 5f6d 756c 7469  type=force_multi
-0000ca80: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-0000ca90: 2020 6170 7065 6e64 3d61 7070 656e 642c    append=append,
-0000caa0: 0a20 2020 2020 2020 2020 2020 2061 7070  .            app
-0000cab0: 656e 645f 7469 6d65 6f75 745f 733d 6170  end_timeout_s=ap
-0000cac0: 7065 6e64 5f74 696d 656f 7574 5f73 2c0a  pend_timeout_s,.
-0000cad0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-0000cae0: 783d 696e 6465 782c 0a20 2020 2020 2020  x=index,.       
-0000caf0: 2020 2020 2063 7265 6174 655f 7370 6174       create_spat
-0000cb00: 6961 6c5f 696e 6465 783d 6372 6561 7465  ial_index=create
-0000cb10: 5f73 7061 7469 616c 5f69 6e64 6578 2c0a  _spatial_index,.
-0000cb20: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0000cb30: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-0000cb40: 6520 5661 6c75 6545 7272 6f72 2866 2255  e ValueError(f"U
-0000cb50: 6e73 7570 706f 7274 6564 2065 6e67 696e  nsupported engin
-0000cb60: 653a 207b 656e 6769 6e65 7d22 290a 0a0a  e: {engine}")...
-0000cb70: 6465 6620 5f67 6574 5f65 6e67 696e 6528  def _get_engine(
-0000cb80: 293a 0a20 2020 2072 6574 7572 6e20 6f73  ):.    return os
-0000cb90: 2e65 6e76 6972 6f6e 2e67 6574 2822 4746  .environ.get("GF
-0000cba0: 4f5f 494f 5f45 4e47 494e 4522 2c20 2270  O_IO_ENGINE", "p
-0000cbb0: 796f 6772 696f 2229 0a0a 0a64 6566 205f  yogrio")...def _
-0000cbc0: 746f 5f66 696c 655f 6669 6f6e 6128 0a20  to_file_fiona(. 
-0000cbd0: 2020 2067 6466 3a20 556e 696f 6e5b 7064     gdf: Union[pd
-0000cbe0: 2e44 6174 6146 7261 6d65 2c20 6770 642e  .DataFrame, gpd.
-0000cbf0: 4765 6f44 6174 6146 7261 6d65 5d2c 0a20  GeoDataFrame],. 
-0000cc00: 2020 2070 6174 683a 2050 6174 682c 0a20     path: Path,. 
-0000cc10: 2020 206c 6179 6572 3a20 7374 722c 0a20     layer: str,. 
-0000cc20: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
-0000cc30: 6765 6f6d 6574 7279 7479 7065 3a20 556e  geometrytype: Un
-0000cc40: 696f 6e5b 4765 6f6d 6574 7279 5479 7065  ion[GeometryType
-0000cc50: 2c20 7374 722c 204e 6f6e 655d 203d 204e  , str, None] = N
-0000cc60: 6f6e 652c 0a20 2020 2066 6f72 6365 5f6d  one,.    force_m
-0000cc70: 756c 7469 7479 7065 3a20 626f 6f6c 203d  ultitype: bool =
-0000cc80: 2046 616c 7365 2c0a 2020 2020 6170 7065   False,.    appe
-0000cc90: 6e64 3a20 626f 6f6c 203d 2046 616c 7365  nd: bool = False
-0000cca0: 2c0a 2020 2020 6170 7065 6e64 5f74 696d  ,.    append_tim
-0000ccb0: 656f 7574 5f73 3a20 696e 7420 3d20 3630  eout_s: int = 60
-0000ccc0: 302c 0a20 2020 2069 6e64 6578 3a20 4f70  0,.    index: Op
-0000ccd0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
-0000cce0: 6f6e 652c 0a20 2020 2063 7265 6174 655f  one,.    create_
-0000ccf0: 7370 6174 6961 6c5f 696e 6465 783a 204f  spatial_index: O
-0000cd00: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-0000cd10: 5472 7565 2c0a 293a 0a20 2020 2022 2222  True,.):.    """
-0000cd20: 0a20 2020 2057 7269 7465 7320 6120 7061  .    Writes a pa
-0000cd30: 6e64 6173 2064 6174 6166 7261 6d65 2074  ndas dataframe t
-0000cd40: 6f20 6669 6c65 2075 7369 6e67 2066 696f  o file using fio
-0000cd50: 6e61 2e0a 2020 2020 2222 220a 2020 2020  na..    """.    
-0000cd60: 2320 4861 6e64 6c65 2073 6f6d 6520 7370  # Handle some sp
-0000cd70: 6563 6966 6963 2063 6173 6573 2077 6865  ecific cases whe
-0000cd80: 7265 2074 6865 2066 696c 6520 7363 6865  re the file sche
-0000cd90: 6d61 206e 6565 6473 2074 6f20 6265 206d  ma needs to be m
-0000cda0: 616e 6970 756c 6174 6564 2e0a 2020 2020  anipulated..    
-0000cdb0: 7363 6865 6d61 203d 204e 6f6e 650a 2020  schema = None.  
-0000cdc0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000cdd0: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000cde0: 4672 616d 6529 2069 7320 4661 6c73 6520  Frame) is False 
-0000cdf0: 6f72 2028 0a20 2020 2020 2020 2069 7369  or (.        isi
-0000ce00: 6e73 7461 6e63 6528 6764 662c 2067 7064  nstance(gdf, gpd
-0000ce10: 2e47 656f 4461 7461 4672 616d 6529 2061  .GeoDataFrame) a
-0000ce20: 6e64 2022 6765 6f6d 6574 7279 2220 6e6f  nd "geometry" no
-0000ce30: 7420 696e 2067 6466 2e63 6f6c 756d 6e73  t in gdf.columns
-0000ce40: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0000ce50: 2320 4e6f 2067 656f 6d65 7472 792c 2073  # No geometry, s
-0000ce60: 6f20 7072 6570 6172 6520 746f 2062 6520  o prepare to be 
-0000ce70: 7772 6974 7465 6e20 6173 2061 7474 7269  written as attri
-0000ce80: 6275 7465 2074 6162 6c65 3a20 6164 6420  bute table: add 
-0000ce90: 6765 6f6d 6574 7279 2063 6f6c 756d 6e0a  geometry column.
-0000cea0: 2020 2020 2020 2020 2320 7769 7468 204e          # with N
-0000ceb0: 6f6e 6520 6765 6f6d 6574 7279 2074 7970  one geometry typ
-0000cec0: 6520 696e 2073 6368 656d 610a 2020 2020  e in schema.    
-0000ced0: 2020 2020 6764 6620 3d20 6770 642e 4765      gdf = gpd.Ge
-0000cee0: 6f44 6174 6146 7261 6d65 2867 6466 2c20  oDataFrame(gdf, 
-0000cef0: 6765 6f6d 6574 7279 3d5b 4e6f 6e65 2066  geometry=[None f
-0000cf00: 6f72 2069 2069 6e20 6764 662e 696e 6465  or i in gdf.inde
-0000cf10: 785d 2920 2023 2074 7970 653a 2069 676e  x])  # type: ign
-0000cf20: 6f72 650a 2020 2020 2020 2020 7363 6865  ore.        sche
-0000cf30: 6d61 203d 2067 7064 5f69 6f5f 6669 6c65  ma = gpd_io_file
-0000cf40: 2e69 6e66 6572 5f73 6368 656d 6128 6764  .infer_schema(gd
-0000cf50: 6629 0a20 2020 2020 2020 2073 6368 656d  f).        schem
-0000cf60: 615b 2267 656f 6d65 7472 7922 5d20 3d20  a["geometry"] = 
-0000cf70: 224e 6f6e 6522 0a20 2020 2065 6c69 6620  "None".    elif 
-0000cf80: 280a 2020 2020 2020 2020 6c65 6e28 6764  (.        len(gd
-0000cf90: 6629 203d 3d20 300a 2020 2020 2020 2020  f) == 0.        
-0000cfa0: 616e 6420 666f 7263 655f 6f75 7470 7574  and force_output
-0000cfb0: 5f67 656f 6d65 7472 7974 7970 6520 6973  _geometrytype is
-0000cfc0: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-0000cfd0: 2020 616e 6420 6973 696e 7374 616e 6365    and isinstance
-0000cfe0: 2866 6f72 6365 5f6f 7574 7075 745f 6765  (force_output_ge
-0000cff0: 6f6d 6574 7279 7479 7065 2c20 4765 6f6d  ometrytype, Geom
-0000d000: 6574 7279 5479 7065 290a 2020 2020 293a  etryType).    ):
-0000d010: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
-0000d020: 6520 6764 6620 6973 2065 6d70 7479 2062  e gdf is empty b
-0000d030: 7574 2061 2067 656f 6d65 7472 7920 7479  ut a geometry ty
-0000d040: 7065 2069 7320 7370 6563 6966 6965 642c  pe is specified,
-0000d050: 2075 7365 2074 6865 2073 7065 6369 6669   use the specifi
-0000d060: 6564 2074 7970 650a 2020 2020 2020 2020  ed type.        
-0000d070: 7363 6865 6d61 203d 2067 7064 5f69 6f5f  schema = gpd_io_
-0000d080: 6669 6c65 2e69 6e66 6572 5f73 6368 656d  file.infer_schem
-0000d090: 6128 6764 6629 0a20 2020 2020 2020 2023  a(gdf).        #
-0000d0a0: 2047 656f 6d65 7472 7920 7479 7065 206d   Geometry type m
-0000d0b0: 7573 7420 6265 2069 6e20 6361 6d65 6c63  ust be in camelc
-0000d0c0: 6173 6520 666f 7220 6669 6f6e 610a 2020  ase for fiona.  
-0000d0d0: 2020 2020 2020 7363 6865 6d61 5b22 6765        schema["ge
-0000d0e0: 6f6d 6574 7279 225d 203d 2066 6f72 6365  ometry"] = force
-0000d0f0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-0000d100: 7479 7065 2e6e 616d 655f 6361 6d65 6c63  type.name_camelc
-0000d110: 6173 650a 2020 2020 6173 7365 7274 2069  ase.    assert i
-0000d120: 7369 6e73 7461 6e63 6528 6764 662c 2067  sinstance(gdf, g
-0000d130: 7064 2e47 656f 4461 7461 4672 616d 6529  pd.GeoDataFrame)
-0000d140: 0a0a 2020 2020 2320 436f 6e76 6572 7420  ..    # Convert 
-0000d150: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000d160: 6d65 7472 7974 7970 6520 746f 2073 7472  metrytype to str
-0000d170: 696e 6720 746f 2073 696d 706c 6966 7920  ing to simplify 
-0000d180: 636f 6465 2061 6674 6572 7761 7264 730a  code afterwards.
-0000d190: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000d1a0: 6528 666f 7263 655f 6f75 7470 7574 5f67  e(force_output_g
-0000d1b0: 656f 6d65 7472 7974 7970 652c 2047 656f  eometrytype, Geo
-0000d1c0: 6d65 7472 7954 7970 6529 3a0a 2020 2020  metryType):.    
-0000d1d0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-0000d1e0: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
-0000d1f0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000d200: 6d65 7472 7974 7970 652e 6e61 6d65 0a0a  metrytype.name..
-0000d210: 2020 2020 2320 4e6f 2074 6865 2066 696c      # No the fil
-0000d220: 6520 6361 6e20 6163 7475 616c 6c79 2062  e can actually b
-0000d230: 6520 7772 6974 7465 6e0a 2020 2020 2320  e written.    # 
-0000d240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d260: 2d2d 2d0a 2020 2020 2320 4669 6f6e 6120  ---.    # Fiona 
-0000d270: 646f 6573 6e27 7420 7375 7070 6f72 7420  doesn't support 
-0000d280: 7468 6520 6f75 7470 7574 2067 656f 6d65  the output geome
-0000d290: 7472 7974 7970 6520 7061 7261 6d65 7465  trytype paramete
-0000d2a0: 7220 6173 2075 7365 6420 696e 2067 6461  r as used in gda
-0000d2b0: 6c2c 2073 6f20 6173 2061 0a20 2020 2023  l, so as a.    #
-0000d2c0: 206c 6967 6874 7765 6967 6874 2069 6d70   lightweight imp
-0000d2d0: 6c65 6d65 6e74 6174 696f 6e20 6a75 7374  lementation just
-0000d2e0: 2073 6574 2066 6f72 6365 0a20 2020 2064   set force.    d
-0000d2f0: 6566 2077 7269 7465 5f74 6f5f 6669 6c65  ef write_to_file
-0000d300: 280a 2020 2020 2020 2020 6764 663a 2067  (.        gdf: g
-0000d310: 7064 2e47 656f 4461 7461 4672 616d 652c  pd.GeoDataFrame,
-0000d320: 0a20 2020 2020 2020 2070 6174 683a 2050  .        path: P
-0000d330: 6174 682c 0a20 2020 2020 2020 206c 6179  ath,.        lay
-0000d340: 6572 3a20 7374 722c 0a20 2020 2020 2020  er: str,.       
-0000d350: 2069 6e64 6578 3a20 4f70 7469 6f6e 616c   index: Optional
-0000d360: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
-0000d370: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
-0000d380: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000d390: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-0000d3a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0000d3b0: 666f 7263 655f 6d75 6c74 6974 7970 653a  force_multitype:
-0000d3c0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-0000d3d0: 2020 2020 2020 2061 7070 656e 643a 2062         append: b
-0000d3e0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0000d3f0: 2020 2020 2073 6368 656d 613a 204f 7074       schema: Opt
-0000d400: 696f 6e61 6c5b 6469 6374 5d20 3d20 4e6f  ional[dict] = No
-0000d410: 6e65 2c0a 2020 2020 2020 2020 6372 6561  ne,.        crea
-0000d420: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000d430: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-0000d440: 203d 2054 7275 652c 0a20 2020 2029 3a0a   = True,.    ):.
-0000d450: 2020 2020 2020 2020 2320 5072 6570 6172          # Prepar
-0000d460: 6520 6172 6773 2066 6f72 2074 6f5f 6669  e args for to_fi
-0000d470: 6c65 0a20 2020 2020 2020 2069 6620 6170  le.        if ap
-0000d480: 7065 6e64 2069 7320 5472 7565 3a0a 2020  pend is True:.  
-0000d490: 2020 2020 2020 2020 2020 6966 2070 6174            if pat
-0000d4a0: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
-0000d4b0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000d4c0: 203d 2022 6122 0a20 2020 2020 2020 2020   = "a".         
-0000d4d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000d4e0: 2020 2020 2020 2020 206d 6f64 6520 3d20           mode = 
-0000d4f0: 2277 220a 2020 2020 2020 2020 656c 7365  "w".        else
-0000d500: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
-0000d510: 6465 203d 2022 7722 0a0a 2020 2020 2020  de = "w"..      
-0000d520: 2020 6b77 6172 6773 203d 207b 7d0a 2020    kwargs = {}.  
-0000d530: 2020 2020 2020 6b77 6172 6773 5b22 656e        kwargs["en
-0000d540: 6769 6e65 225d 203d 2022 6669 6f6e 6122  gine"] = "fiona"
-0000d550: 0a20 2020 2020 2020 206b 7761 7267 735b  .        kwargs[
-0000d560: 226d 6f64 6522 5d20 3d20 6d6f 6465 0a20  "mode"] = mode. 
-0000d570: 2020 2020 2020 2067 656f 6669 6c65 7479         geofilety
-0000d580: 7065 203d 2047 656f 6669 6c65 5479 7065  pe = GeofileType
-0000d590: 2870 6174 6829 0a20 2020 2020 2020 206b  (path).        k
-0000d5a0: 7761 7267 735b 2264 7269 7665 7222 5d20  wargs["driver"] 
-0000d5b0: 3d20 6765 6f66 696c 6574 7970 652e 6f67  = geofiletype.og
-0000d5c0: 7264 7269 7665 720a 2020 2020 2020 2020  rdriver.        
-0000d5d0: 6b77 6172 6773 5b22 696e 6465 7822 5d20  kwargs["index"] 
-0000d5e0: 3d20 696e 6465 780a 2020 2020 2020 2020  = index.        
-0000d5f0: 6966 2063 7265 6174 655f 7370 6174 6961  if create_spatia
-0000d600: 6c5f 696e 6465 7820 6973 206e 6f74 204e  l_index is not N
-0000d610: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000d620: 206b 7761 7267 735b 2253 5041 5449 414c   kwargs["SPATIAL
-0000d630: 5f49 4e44 4558 225d 203d 2063 7265 6174  _INDEX"] = creat
-0000d640: 655f 7370 6174 6961 6c5f 696e 6465 780a  e_spatial_index.
-0000d650: 2020 2020 2020 2020 6966 2066 6f72 6365          if force
-0000d660: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-0000d670: 7479 7065 2069 7320 6e6f 7420 4e6f 6e65  type is not None
-0000d680: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
-0000d690: 6172 6773 5b22 6765 6f6d 6574 7279 7479  args["geometryty
-0000d6a0: 7065 225d 203d 2066 6f72 6365 5f6f 7574  pe"] = force_out
-0000d6b0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000d6c0: 0a20 2020 2020 2020 2069 6620 7363 6865  .        if sche
-0000d6d0: 6d61 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ma is not None:.
-0000d6e0: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-0000d6f0: 6773 5b22 7363 6865 6d61 225d 203d 2073  gs["schema"] = s
-0000d700: 6368 656d 610a 0a20 2020 2020 2020 2023  chema..        #
-0000d710: 204e 6f77 2077 6520 6361 6e20 7772 6974   Now we can writ
-0000d720: 650a 2020 2020 2020 2020 6966 2067 656f  e.        if geo
-0000d730: 6669 6c65 7479 7065 203d 3d20 4765 6f66  filetype == Geof
-0000d740: 696c 6554 7970 652e 4553 5249 5368 6170  ileType.ESRIShap
-0000d750: 6566 696c 653a 0a20 2020 2020 2020 2020  efile:.         
-0000d760: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
-0000d770: 2020 2069 6620 696e 6465 7820 6973 2054     if index is T
-0000d780: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-0000d790: 2020 2020 2067 6466 5f74 6f5f 7772 6974       gdf_to_writ
-0000d7a0: 6520 3d20 6764 662e 7265 7365 745f 696e  e = gdf.reset_in
-0000d7b0: 6465 7828 6472 6f70 3d54 7275 6529 0a20  dex(drop=True). 
-0000d7c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000d7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d7e0: 2067 6466 5f74 6f5f 7772 6974 6520 3d20   gdf_to_write = 
-0000d7f0: 6764 660a 2020 2020 2020 2020 2020 2020  gdf.            
-0000d800: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-0000d810: 6764 665f 746f 5f77 7269 7465 203d 2067  gdf_to_write = g
-0000d820: 6466 0a20 2020 2020 2020 2020 2020 2067  df.            g
-0000d830: 6466 5f74 6f5f 7772 6974 652e 746f 5f66  df_to_write.to_f
-0000d840: 696c 6528 7374 7228 7061 7468 292c 202a  ile(str(path), *
-0000d850: 2a6b 7761 7267 7329 2020 2320 7479 7065  *kwargs)  # type
-0000d860: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-0000d870: 2065 6c69 6620 6765 6f66 696c 6574 7970   elif geofiletyp
-0000d880: 6520 3d3d 2047 656f 6669 6c65 5479 7065  e == GeofileType
-0000d890: 2e47 504b 473a 0a20 2020 2020 2020 2020  .GPKG:.         
-0000d8a0: 2020 2023 2054 7279 2074 6f20 6861 726d     # Try to harm
-0000d8b0: 6f6e 697a 6520 7468 6520 6765 6f6d 6574  onize the geomet
-0000d8c0: 7279 7479 7065 2074 6f20 6f6e 6520 286d  rytype to one (m
-0000d8d0: 756c 7469 2974 7970 652c 2061 7320 4750  ulti)type, as GP
-0000d8e0: 4b47 0a20 2020 2020 2020 2020 2020 2023  KG.            #
-0000d8f0: 2064 6f65 736e 2774 206c 696b 6520 3e20   doesn't like > 
-0000d900: 3120 7479 7065 2069 6e20 6120 6c61 7965  1 type in a laye
-0000d910: 720a 2020 2020 2020 2020 2020 2020 6966  r.            if
-0000d920: 2073 6368 656d 6120 6973 204e 6f6e 6520   schema is None 
-0000d930: 6f72 2028 6c65 6e28 6764 6629 203e 2030  or (len(gdf) > 0
-0000d940: 2061 6e64 2073 6368 656d 615b 2267 656f   and schema["geo
-0000d950: 6d65 7472 7922 5d20 213d 2022 4e6f 6e65  metry"] != "None
-0000d960: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0000d970: 2020 2020 6764 665f 746f 5f77 7269 7465      gdf_to_write
-0000d980: 203d 2067 6466 2e63 6f70 7928 290a 2020   = gdf.copy().  
-0000d990: 2020 2020 2020 2020 2020 2020 2020 6764                gd
-0000d9a0: 665f 746f 5f77 7269 7465 2e67 656f 6d65  f_to_write.geome
-0000d9b0: 7472 7920 3d20 6765 6f73 6572 6965 735f  try = geoseries_
-0000d9c0: 7574 696c 2e68 6172 6d6f 6e69 7a65 5f67  util.harmonize_g
-0000d9d0: 656f 6d65 7472 7974 7970 6573 280a 2020  eometrytypes(.  
-0000d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9f0: 2020 6764 662e 6765 6f6d 6574 7279 2c20    gdf.geometry, 
-0000da00: 666f 7263 655f 6d75 6c74 6974 7970 653d  force_multitype=
-0000da10: 666f 7263 655f 6d75 6c74 6974 7970 650a  force_multitype.
-0000da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000da40: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0000da50: 6e63 6528 6764 665f 746f 5f77 7269 7465  nce(gdf_to_write
-0000da60: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
-0000da70: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0000da80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000da90: 2020 2020 2020 6764 665f 746f 5f77 7269        gdf_to_wri
-0000daa0: 7465 203d 2067 6466 0a20 2020 2020 2020  te = gdf.       
-0000dab0: 2020 2020 2067 6466 5f74 6f5f 7772 6974       gdf_to_writ
-0000dac0: 652e 746f 5f66 696c 6528 7374 7228 7061  e.to_file(str(pa
-0000dad0: 7468 292c 206c 6179 6572 3d6c 6179 6572  th), layer=layer
-0000dae0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0000daf0: 2020 2020 656c 6966 2067 656f 6669 6c65      elif geofile
-0000db00: 7479 7065 203d 3d20 4765 6f66 696c 6554  type == GeofileT
-0000db10: 7970 652e 5351 4c69 7465 3a0a 2020 2020  ype.SQLite:.    
-0000db20: 2020 2020 2020 2020 6764 662e 746f 5f66          gdf.to_f
-0000db30: 696c 6528 7374 7228 7061 7468 292c 206c  ile(str(path), l
-0000db40: 6179 6572 3d6c 6179 6572 2c20 2a2a 6b77  ayer=layer, **kw
-0000db50: 6172 6773 290a 2020 2020 2020 2020 656c  args).        el
-0000db60: 6966 2067 656f 6669 6c65 7479 7065 203d  if geofiletype =
-0000db70: 3d20 4765 6f66 696c 6554 7970 652e 4765  = GeofileType.Ge
-0000db80: 6f4a 534f 4e3a 0a20 2020 2020 2020 2020  oJSON:.         
-0000db90: 2020 2067 6466 2e74 6f5f 6669 6c65 2873     gdf.to_file(s
-0000dba0: 7472 2870 6174 6829 2c20 2a2a 6b77 6172  tr(path), **kwar
-0000dbb0: 6773 290a 2020 2020 2020 2020 656c 7365  gs).        else
-0000dbc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000dbd0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0000dbe0: 224e 6f74 2069 6d70 6c65 6d65 6e74 6564  "Not implemented
-0000dbf0: 2066 6f72 2067 656f 6669 6c65 7479 7065   for geofiletype
-0000dc00: 207b 6765 6f66 696c 6574 7970 657d 2229   {geofiletype}")
-0000dc10: 0a0a 2020 2020 2320 4966 206e 6f20 6170  ..    # If no ap
-0000dc20: 7065 6e64 2c20 6a75 7374 2077 7269 7465  pend, just write
-0000dc30: 2074 6f20 6f75 7470 7574 2070 6174 680a   to output path.
-0000dc40: 2020 2020 6966 206e 6f74 2061 7070 656e      if not appen
-0000dc50: 643a 0a20 2020 2020 2020 2077 7269 7465  d:.        write
-0000dc60: 5f74 6f5f 6669 6c65 280a 2020 2020 2020  _to_file(.      
-0000dc70: 2020 2020 2020 6764 663d 6764 662c 0a20        gdf=gdf,. 
-0000dc80: 2020 2020 2020 2020 2020 2070 6174 683d             path=
-0000dc90: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000dca0: 2020 6c61 7965 723d 6c61 7965 722c 0a20    layer=layer,. 
-0000dcb0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-0000dcc0: 3d69 6e64 6578 2c0a 2020 2020 2020 2020  =index,.        
-0000dcd0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-0000dce0: 5f67 656f 6d65 7472 7974 7970 653d 666f  _geometrytype=fo
-0000dcf0: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-0000dd00: 7472 7974 7970 652c 0a20 2020 2020 2020  trytype,.       
-0000dd10: 2020 2020 2066 6f72 6365 5f6d 756c 7469       force_multi
-0000dd20: 7479 7065 3d66 6f72 6365 5f6d 756c 7469  type=force_multi
-0000dd30: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-0000dd40: 2020 6170 7065 6e64 3d61 7070 656e 642c    append=append,
-0000dd50: 0a20 2020 2020 2020 2020 2020 2073 6368  .            sch
-0000dd60: 656d 613d 7363 6865 6d61 2c0a 2020 2020  ema=schema,.    
-0000dd70: 2020 2020 2020 2020 6372 6561 7465 5f73          create_s
-0000dd80: 7061 7469 616c 5f69 6e64 6578 3d63 7265  patial_index=cre
-0000dd90: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-0000dda0: 782c 0a20 2020 2020 2020 2029 0a20 2020  x,.        ).   
-0000ddb0: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
-0000ddc0: 2041 7070 656e 6420 6973 2061 736b 6564   Append is asked
-0000ddd0: 2c20 6368 6563 6b20 6966 2074 6865 2066  , check if the f
-0000dde0: 696f 6e61 2064 7269 7665 7220 7375 7070  iona driver supp
-0000ddf0: 6f72 7473 2061 7070 656e 6469 6e67 2e20  orts appending. 
-0000de00: 4966 0a20 2020 2020 2020 2023 206e 6f74  If.        # not
-0000de10: 2c20 7772 6974 6520 746f 2074 656d 706f  , write to tempo
-0000de20: 7261 7279 206f 7574 7075 7420 6669 6c65  rary output file
-0000de30: 0a0a 2020 2020 2020 2020 2320 5265 6d61  ..        # Rema
-0000de40: 726b 3a20 6669 6f6e 6120 7072 652d 312e  rk: fiona pre-1.
-0000de50: 382e 3134 2064 6964 6e27 7420 7375 7070  8.14 didn't supp
-0000de60: 6f72 7420 6170 7065 6e64 696e 6720 746f  ort appending to
-0000de70: 2067 656f 7061 636b 6167 652e 204f 6e63   geopackage. Onc
-0000de80: 650a 2020 2020 2020 2020 2320 6f6c 6465  e.        # olde
-0000de90: 7220 7665 7273 696f 6e73 2062 6563 6f6d  r versions becom
-0000dea0: 6573 2072 6172 652c 2064 6570 656e 6465  es rare, depende
-0000deb0: 6e63 7920 6361 6e20 6265 2070 7574 2074  ncy can be put t
-0000dec0: 6f20 7468 6973 2076 6572 7369 6f6e 2c20  o this version, 
-0000ded0: 616e 640a 2020 2020 2020 2020 2320 7468  and.        # th
-0000dee0: 6973 2063 6f64 6520 6361 6e20 6265 2063  is code can be c
-0000def0: 6c65 616e 6564 2075 702e 2e2e 0a20 2020  leaned up....   
-0000df00: 2020 2020 2067 656f 6669 6c65 7479 7065       geofiletype
-0000df10: 203d 2047 656f 6669 6c65 5479 7065 2870   = GeofileType(p
-0000df20: 6174 6829 0a20 2020 2020 2020 2067 6466  ath).        gdf
-0000df30: 7465 6d70 5f70 6174 6820 3d20 4e6f 6e65  temp_path = None
-0000df40: 0a20 2020 2020 2020 2067 6466 7465 6d70  .        gdftemp
-0000df50: 5f6c 6f63 6b70 6174 6820 3d20 4e6f 6e65  _lockpath = None
-0000df60: 0a20 2020 2020 2020 2069 6620 2261 2220  .        if "a" 
-0000df70: 6e6f 7420 696e 2066 696f 6e61 2e73 7570  not in fiona.sup
-0000df80: 706f 7274 6564 5f64 7269 7665 7273 5b67  ported_drivers[g
-0000df90: 656f 6669 6c65 7479 7065 2e6f 6772 6472  eofiletype.ogrdr
-0000dfa0: 6976 6572 5d3a 0a20 2020 2020 2020 2020  iver]:.         
-0000dfb0: 2020 2023 2047 6574 2061 2075 6e69 7175     # Get a uniqu
-0000dfc0: 6520 7465 6d70 2066 696c 6520 7061 7468  e temp file path
-0000dfd0: 2e20 5468 6520 6669 6c65 2063 616e 6e6f  . The file canno
-0000dfe0: 7420 6265 2063 7265 6174 6564 2079 6574  t be created yet
-0000dff0: 2c20 736f 0a20 2020 2020 2020 2020 2020  , so.           
-0000e000: 2023 206f 6e6c 7920 6372 6561 7465 2061   # only create a
-0000e010: 206c 6f63 6b20 6669 6c65 2074 6f20 6576   lock file to ev
-0000e020: 6164 6520 6f74 6865 7220 7072 6f63 6573  ade other proces
-0000e030: 7365 7320 7573 696e 6720 7468 6520 7361  ses using the sa
-0000e040: 6d65 0a20 2020 2020 2020 2020 2020 2023  me.            #
-0000e050: 2074 656d 7020 6669 6c65 206e 616d 650a   temp file name.
-0000e060: 2020 2020 2020 2020 2020 2020 6764 6674              gdft
-0000e070: 656d 705f 7061 7468 2c20 6764 6674 656d  emp_path, gdftem
-0000e080: 705f 6c6f 636b 7061 7468 203d 205f 696f  p_lockpath = _io
-0000e090: 5f75 7469 6c2e 6765 745f 7465 6d70 6669  _util.get_tempfi
-0000e0a0: 6c65 5f6c 6f63 6b65 6428 0a20 2020 2020  le_locked(.     
-0000e0b0: 2020 2020 2020 2020 2020 2062 6173 655f             base_
-0000e0c0: 6669 6c65 6e61 6d65 3d22 6764 6674 656d  filename="gdftem
-0000e0d0: 7022 2c20 7375 6666 6978 3d70 6174 682e  p", suffix=path.
-0000e0e0: 7375 6666 6978 2c20 6469 726e 616d 653d  suffix, dirname=
-0000e0f0: 2267 656f 6669 6c65 5f74 6f5f 6669 6c65  "geofile_to_file
-0000e100: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0000e110: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-0000e120: 655f 746f 5f66 696c 6528 0a20 2020 2020  e_to_file(.     
-0000e130: 2020 2020 2020 2020 2020 2067 6466 2c0a             gdf,.
-0000e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e150: 7061 7468 3d67 6466 7465 6d70 5f70 6174  path=gdftemp_pat
-0000e160: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0000e170: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+00001220: 6c61 7965 723a 2028 6d69 6e78 2c20 6d69  layer: (minx, mi
+00001230: 6e79 2c20 6d61 7878 2c20 6d61 7879 292e  ny, maxx, maxy).
+00001240: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
+00001250: 7963 6f6c 756d 6e20 2873 7472 293a 206e  ycolumn (str): n
+00001260: 616d 6520 6f66 2074 6865 2063 6f6c 756d  ame of the colum
+00001270: 6e20 7468 6174 2063 6f6e 7461 696e 7320  n that contains 
+00001280: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+00001290: 7072 696d 6172 7920 6765 6f6d 6574 7279  primary geometry
+000012a0: 2e0a 2020 2020 2020 2020 6765 6f6d 6574  ..        geomet
+000012b0: 7279 7479 7065 6e61 6d65 2028 7374 7229  rytypename (str)
+000012c0: 3a20 7468 6520 6765 6f6d 6574 7279 2074  : the geometry t
+000012d0: 7970 6520 6e61 6d65 206f 6620 7468 6520  ype name of the 
+000012e0: 6765 6f6d 6574 7279 636f 6c75 6d6e 2e0a  geometrycolumn..
+000012f0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00001300: 7479 7065 206e 616d 6520 7265 7475 726e  type name return
+00001310: 6564 2069 7320 6f6e 6520 6f66 2074 6865  ed is one of the
+00001320: 2066 6f6c 6c6f 7769 6e67 3a20 504f 494e   following: POIN
+00001330: 542c 204d 554c 5449 504f 494e 542c 0a20  T, MULTIPOINT,. 
+00001340: 2020 2020 2020 2020 2020 204c 494e 4553             LINES
+00001350: 5452 494e 472c 204d 554c 5449 4c49 4e45  TRING, MULTILINE
+00001360: 5354 5249 4e47 2c20 504f 4c59 474f 4e2c  STRING, POLYGON,
+00001370: 204d 554c 5449 504f 4c59 474f 4e2c 2043   MULTIPOLYGON, C
+00001380: 4f4c 4c45 4354 494f 4e2e 0a20 2020 2020  OLLECTION..     
+00001390: 2020 2067 656f 6d65 7472 7974 7970 6520     geometrytype 
+000013a0: 2847 656f 6d65 7472 7954 7970 6529 3a20  (GeometryType): 
+000013b0: 7468 6520 6765 6f6d 6574 7279 2074 7970  the geometry typ
+000013c0: 6520 6f66 2074 6865 2067 656f 6d65 7472  e of the geometr
+000013d0: 7963 6f6c 756d 6e2e 0a20 2020 2020 2020  ycolumn..       
+000013e0: 2063 6f6c 756d 6e73 2028 6469 6374 293a   columns (dict):
+000013f0: 2074 6865 2063 6f6c 756d 6e73 2028 6f74   the columns (ot
+00001400: 6865 7220 7468 616e 2074 6865 2067 656f  her than the geo
+00001410: 6d65 7472 7920 636f 6c75 6d6e 2920 7468  metry column) th
+00001420: 6174 0a20 2020 2020 2020 2020 2020 2061  at.            a
+00001430: 7265 2061 7661 696c 6162 6c65 206f 6e20  re available on 
+00001440: 7468 6520 6c61 7965 7220 7769 7468 2074  the layer with t
+00001450: 6865 6972 2070 726f 7065 7274 6965 7320  heir properties 
+00001460: 6173 2061 2064 6963 742e 0a20 2020 2020  as a dict..     
+00001470: 2020 2066 6964 5f63 6f6c 756d 6e20 2873     fid_column (s
+00001480: 7472 293a 2063 6f6c 756d 6e20 6e61 6d65  tr): column name
+00001490: 206f 6620 7468 6520 4649 4420 636f 6c75   of the FID colu
+000014a0: 6d6e 2e20 4973 2022 2220 666f 7220 6669  mn. Is "" for fi
+000014b0: 6c65 2074 7970 6573 2074 6861 7420 646f  le types that do
+000014c0: 6e27 740a 2020 2020 2020 2020 2020 2020  n't.            
+000014d0: 6578 706c 6963 6974 6c79 2073 746f 7265  explicitly store
+000014e0: 2061 6e20 4649 442c 206c 696b 6520 7368   an FID, like sh
+000014f0: 6170 6566 696c 652e 0a20 2020 2020 2020  apefile..       
+00001500: 2063 7273 2028 7079 7072 6f6a 2e43 5253   crs (pyproj.CRS
+00001510: 293a 2074 6865 2073 7061 7469 616c 2072  ): the spatial r
+00001520: 6566 6572 656e 6365 206f 6620 7468 6520  eference of the 
+00001530: 6c61 7965 722e 0a20 2020 2020 2020 2065  layer..        e
+00001540: 7272 6f72 7320 284c 6973 745b 7374 725d  rrors (List[str]
+00001550: 293a 206c 6973 7420 6f66 2065 7272 6f72  ): list of error
+00001560: 7320 696e 2074 6865 206c 6179 6572 2c20  s in the layer, 
+00001570: 6567 2e20 696e 7661 6c69 6420 636f 6c75  eg. invalid colu
+00001580: 6d6e 0a20 2020 2020 2020 2020 2020 206e  mn.            n
+00001590: 616d 6573 2c2e 2e2e 0a20 2020 2022 2222  ames,....    """
+000015a0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+000015b0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+000015c0: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
+000015d0: 7374 722c 0a20 2020 2020 2020 2066 6561  str,.        fea
+000015e0: 7475 7265 636f 756e 743a 2069 6e74 2c0a  turecount: int,.
+000015f0: 2020 2020 2020 2020 746f 7461 6c5f 626f          total_bo
+00001600: 756e 6473 3a20 5475 706c 655b 666c 6f61  unds: Tuple[floa
+00001610: 742c 2066 6c6f 6174 2c20 666c 6f61 742c  t, float, float,
+00001620: 2066 6c6f 6174 5d2c 0a20 2020 2020 2020   float],.       
+00001630: 2067 656f 6d65 7472 7963 6f6c 756d 6e3a   geometrycolumn:
+00001640: 2073 7472 2c0a 2020 2020 2020 2020 6765   str,.        ge
+00001650: 6f6d 6574 7279 7479 7065 6e61 6d65 3a20  ometrytypename: 
+00001660: 7374 722c 0a20 2020 2020 2020 2067 656f  str,.        geo
+00001670: 6d65 7472 7974 7970 653a 2047 656f 6d65  metrytype: Geome
+00001680: 7472 7954 7970 652c 0a20 2020 2020 2020  tryType,.       
+00001690: 2063 6f6c 756d 6e73 3a20 4469 6374 5b73   columns: Dict[s
+000016a0: 7472 2c20 436f 6c75 6d6e 496e 666f 5d2c  tr, ColumnInfo],
+000016b0: 0a20 2020 2020 2020 2066 6964 5f63 6f6c  .        fid_col
+000016c0: 756d 6e3a 2073 7472 2c0a 2020 2020 2020  umn: str,.      
+000016d0: 2020 6372 733a 204f 7074 696f 6e61 6c5b    crs: Optional[
+000016e0: 7079 7072 6f6a 2e43 5253 5d2c 0a20 2020  pyproj.CRS],.   
+000016f0: 2020 2020 2065 7272 6f72 733a 204c 6973       errors: Lis
+00001700: 745b 7374 725d 2c0a 2020 2020 293a 0a20  t[str],.    ):. 
+00001710: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
+00001720: 203d 206e 616d 650a 2020 2020 2020 2020   = name.        
+00001730: 7365 6c66 2e66 6561 7475 7265 636f 756e  self.featurecoun
+00001740: 7420 3d20 6665 6174 7572 6563 6f75 6e74  t = featurecount
+00001750: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00001760: 7461 6c5f 626f 756e 6473 203d 2074 6f74  tal_bounds = tot
+00001770: 616c 5f62 6f75 6e64 730a 2020 2020 2020  al_bounds.      
+00001780: 2020 7365 6c66 2e67 656f 6d65 7472 7963    self.geometryc
+00001790: 6f6c 756d 6e20 3d20 6765 6f6d 6574 7279  olumn = geometry
+000017a0: 636f 6c75 6d6e 0a20 2020 2020 2020 2073  column.        s
+000017b0: 656c 662e 6765 6f6d 6574 7279 7479 7065  elf.geometrytype
+000017c0: 6e61 6d65 203d 2067 656f 6d65 7472 7974  name = geometryt
+000017d0: 7970 656e 616d 650a 2020 2020 2020 2020  ypename.        
+000017e0: 7365 6c66 2e67 656f 6d65 7472 7974 7970  self.geometrytyp
+000017f0: 6520 3d20 6765 6f6d 6574 7279 7479 7065  e = geometrytype
+00001800: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00001810: 6c75 6d6e 7320 3d20 636f 6c75 6d6e 730a  lumns = columns.
+00001820: 2020 2020 2020 2020 7365 6c66 2e66 6964          self.fid
+00001830: 5f63 6f6c 756d 6e20 3d20 6669 645f 636f  _column = fid_co
+00001840: 6c75 6d6e 0a20 2020 2020 2020 2073 656c  lumn.        sel
+00001850: 662e 6372 7320 3d20 6372 730a 2020 2020  f.crs = crs.    
+00001860: 2020 2020 7365 6c66 2e65 7272 6f72 7320      self.errors 
+00001870: 3d20 6572 726f 7273 0a0a 2020 2020 6465  = errors..    de
+00001880: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00001890: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000018a0: 2066 227b 7365 6c66 2e5f 5f63 6c61 7373   f"{self.__class
+000018b0: 5f5f 7d28 7b73 656c 662e 5f5f 6469 6374  __}({self.__dict
+000018c0: 5f5f 7d29 220a 0a0a 6465 6620 6765 745f  __})"...def get_
+000018d0: 6c61 7965 725f 6765 6f6d 6574 7279 7479  layer_geometryty
+000018e0: 7065 7328 0a20 2020 2070 6174 683a 2055  pes(.    path: U
+000018f0: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+00001900: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 206c  thLike[Any]"], l
+00001910: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00001920: 7472 5d20 3d20 4e6f 6e65 0a29 202d 3e20  tr] = None.) -> 
+00001930: 4c69 7374 5b73 7472 5d3a 0a20 2020 2022  List[str]:.    "
+00001940: 2222 0a20 2020 2047 6574 2074 6865 2067  "".    Get the g
+00001950: 656f 6d65 7472 7920 7479 7065 7320 696e  eometry types in
+00001960: 2074 6865 206c 6179 6572 2062 7920 6578   the layer by ex
+00001970: 616d 696e 696e 6720 6561 6368 2067 656f  amining each geo
+00001980: 6d65 7472 7920 696e 2074 6865 206c 6179  metry in the lay
+00001990: 6572 2e0a 0a20 2020 2054 6865 2067 656e  er...    The gen
+000019a0: 6572 616c 2067 656f 6d65 7472 7920 7479  eral geometry ty
+000019b0: 7065 206f 6620 7468 6520 6c61 7965 7220  pe of the layer 
+000019c0: 6361 6e20 6265 2064 6574 6572 6d69 6e65  can be determine
+000019d0: 6420 7573 696e 670a 2020 2020 3a6d 6574  d using.    :met
+000019e0: 683a 607e 6765 745f 6c61 7965 7269 6e66  h:`~get_layerinf
+000019f0: 6f60 2e0a 0a20 2020 2041 7267 733a 0a20  o`...    Args:. 
+00001a00: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+00001a10: 684c 696b 6529 3a20 7061 7468 2074 6f20  hLike): path to 
+00001a20: 7468 6520 6669 6c65 2074 6f20 6765 7420  the file to get 
+00001a30: 696e 666f 2061 626f 7574 0a20 2020 2020  info about.     
+00001a40: 2020 206c 6179 6572 2028 7374 7229 3a20     layer (str): 
+00001a50: 7468 6520 6c61 7965 7220 796f 7520 7761  the layer you wa
+00001a60: 6e74 2069 6e66 6f20 6162 6f75 742e 2044  nt info about. D
+00001a70: 6f65 736e 2774 206e 6565 6420 746f 2062  oesn't need to b
+00001a80: 650a 2020 2020 2020 2020 2020 2020 7370  e.            sp
+00001a90: 6563 6966 6965 6420 6966 2074 6865 7265  ecified if there
+00001aa0: 2069 7320 6f6e 6c79 206f 6e65 206c 6179   is only one lay
+00001ab0: 6572 2069 6e20 7468 6520 6765 6f66 696c  er in the geofil
+00001ac0: 652e 0a0a 2020 2020 5265 7475 726e 733a  e...    Returns:
+00001ad0: 0a20 2020 2020 2020 204c 6973 745b 7374  .        List[st
+00001ae0: 725d 3a20 7468 6520 6765 6f6d 6574 7279  r]: the geometry
+00001af0: 2074 7970 6573 2069 6e20 7468 6520 6c61   types in the la
+00001b00: 7965 722e 0a20 2020 2022 2222 0a20 2020  yer..    """.   
+00001b10: 2073 716c 5f73 746d 7420 3d20 2222 220a   sql_stmt = """.
+00001b20: 2020 2020 2020 2020 5345 4c45 4354 2044          SELECT D
+00001b30: 4953 5449 4e43 540a 2020 2020 2020 2020  ISTINCT.        
+00001b40: 2020 2020 2020 2043 4153 450a 2020 2020         CASE.    
+00001b50: 2020 2020 2020 2020 2020 2020 2057 4845               WHE
+00001b60: 4e20 4361 7374 546f 5369 6e67 6c65 287b  N CastToSingle({
+00001b70: 6765 6f6d 6574 7279 636f 6c75 6d6e 7d29  geometrycolumn})
+00001b80: 2049 5320 4e4f 5420 4e55 4c4c 2054 4845   IS NOT NULL THE
+00001b90: 4e0a 2020 2020 2020 2020 2020 2020 2020  N.              
+00001ba0: 2020 2020 2020 2053 545f 4765 6f6d 6574         ST_Geomet
+00001bb0: 7279 5479 7065 2843 6173 7454 6f53 696e  ryType(CastToSin
+00001bc0: 676c 6528 7b67 656f 6d65 7472 7963 6f6c  gle({geometrycol
+00001bd0: 756d 6e7d 2929 0a20 2020 2020 2020 2020  umn})).         
+00001be0: 2020 2020 2020 2020 454c 5345 2053 545f          ELSE ST_
+00001bf0: 4765 6f6d 6574 7279 5479 7065 287b 6765  GeometryType({ge
+00001c00: 6f6d 6574 7279 636f 6c75 6d6e 7d29 0a20  ometrycolumn}). 
+00001c10: 2020 2020 2020 2020 2020 2020 2020 454e                EN
+00001c20: 4420 4153 2067 656f 6d5f 7479 7065 0a20  D AS geom_type. 
+00001c30: 2020 2020 2020 2020 2046 524f 4d20 227b           FROM "{
+00001c40: 696e 7075 745f 6c61 7965 727d 2220 6c61  input_layer}" la
+00001c50: 7965 720a 2020 2020 2222 220a 2020 2020  yer.    """.    
+00001c60: 7265 7375 6c74 5f64 6620 3d20 7265 6164  result_df = read
+00001c70: 5f66 696c 6528 7061 7468 2c20 7371 6c5f  _file(path, sql_
+00001c80: 7374 6d74 3d73 716c 5f73 746d 742c 2073  stmt=sql_stmt, s
+00001c90: 716c 5f64 6961 6c65 6374 3d22 5351 4c49  ql_dialect="SQLI
+00001ca0: 5445 2229 0a20 2020 2072 6574 7572 6e20  TE").    return 
+00001cb0: 7265 7375 6c74 5f64 665b 2267 656f 6d5f  result_df["geom_
+00001cc0: 7479 7065 225d 2e74 6f5f 6c69 7374 2829  type"].to_list()
+00001cd0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00001ce0: 0a0a 0a64 6566 2067 6574 5f6c 6179 6572  ...def get_layer
+00001cf0: 696e 666f 280a 2020 2020 7061 7468 3a20  info(.    path: 
+00001d00: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+00001d10: 6174 684c 696b 655b 416e 795d 225d 2c20  athLike[Any]"], 
+00001d20: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
+00001d30: 7374 725d 203d 204e 6f6e 650a 2920 2d3e  str] = None.) ->
+00001d40: 204c 6179 6572 496e 666f 3a0a 2020 2020   LayerInfo:.    
+00001d50: 2222 220a 2020 2020 4765 7420 696e 666f  """.    Get info
+00001d60: 726d 6174 696f 6e20 6162 6f75 7420 6120  rmation about a 
+00001d70: 6c61 7965 7220 696e 2074 6865 2067 656f  layer in the geo
+00001d80: 6669 6c65 2e0a 0a20 2020 2052 6169 7365  file...    Raise
+00001d90: 7320 616e 2065 7863 6570 7469 6f6e 2069  s an exception i
+00001da0: 6620 7468 6520 6c61 7965 7220 6465 6669  f the layer defi
+00001db0: 6e69 7469 6f6e 2068 6173 2065 7272 6f72  nition has error
+00001dc0: 7320 6c69 6b65 2069 6e76 616c 6964 2063  s like invalid c
+00001dd0: 6f6c 756d 6e0a 2020 2020 6e61 6d65 732c  olumn.    names,
+00001de0: 2e2e 2e0a 0a20 2020 2041 7267 733a 0a20  .....    Args:. 
+00001df0: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+00001e00: 684c 696b 6529 3a20 7061 7468 2074 6f20  hLike): path to 
+00001e10: 7468 6520 6669 6c65 2074 6f20 6765 7420  the file to get 
+00001e20: 696e 666f 2061 626f 7574 0a20 2020 2020  info about.     
+00001e30: 2020 206c 6179 6572 2028 7374 7229 3a20     layer (str): 
+00001e40: 7468 6520 6c61 7965 7220 796f 7520 7761  the layer you wa
+00001e50: 6e74 2069 6e66 6f20 6162 6f75 742e 2044  nt info about. D
+00001e60: 6f65 736e 2774 206e 6565 6420 746f 2062  oesn't need to b
+00001e70: 650a 2020 2020 2020 2020 2020 2020 7370  e.            sp
+00001e80: 6563 6966 6965 6420 6966 2074 6865 7265  ecified if there
+00001e90: 2069 7320 6f6e 6c79 206f 6e65 206c 6179   is only one lay
+00001ea0: 6572 2069 6e20 7468 6520 6765 6f66 696c  er in the geofil
+00001eb0: 652e 0a0a 2020 2020 5265 7475 726e 733a  e...    Returns:
+00001ec0: 0a20 2020 2020 2020 204c 6179 6572 496e  .        LayerIn
+00001ed0: 666f 3a20 7468 6520 696e 666f 726d 6174  fo: the informat
+00001ee0: 696f 6e20 6162 6f75 7420 7468 6520 6c61  ion about the la
+00001ef0: 7965 722e 0a20 2020 2022 2222 0a20 2020  yer..    """.   
+00001f00: 2023 2049 6e69 740a 2020 2020 7061 7468   # Init.    path
+00001f10: 203d 2050 6174 6828 7061 7468 290a 2020   = Path(path).  
+00001f20: 2020 6966 206e 6f74 2070 6174 682e 6578    if not path.ex
+00001f30: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+00001f40: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00001f50: 2866 2269 6e70 7574 5f70 6174 6820 646f  (f"input_path do
+00001f60: 6573 6e27 7420 6578 6973 743a 207b 7061  esn't exist: {pa
+00001f70: 7468 7d22 290a 0a20 2020 2069 6620 6c61  th}")..    if la
+00001f80: 7965 7220 6973 204e 6f6e 653a 0a20 2020  yer is None:.   
+00001f90: 2020 2020 206c 6179 6572 203d 2067 6574       layer = get
+00001fa0: 5f6f 6e6c 795f 6c61 7965 7228 7061 7468  _only_layer(path
+00001fb0: 290a 0a20 2020 2064 6174 6173 6f75 7263  )..    datasourc
+00001fc0: 6520 3d20 4e6f 6e65 0a20 2020 2074 7279  e = None.    try
+00001fd0: 3a0a 2020 2020 2020 2020 6461 7461 736f  :.        dataso
+00001fe0: 7572 6365 203d 2067 6461 6c2e 4f70 656e  urce = gdal.Open
+00001ff0: 4578 2873 7472 2870 6174 6829 290a 2020  Ex(str(path)).  
+00002000: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00002010: 5f6c 6179 6572 203d 2064 6174 6173 6f75  _layer = datasou
+00002020: 7263 652e 4765 744c 6179 6572 286c 6179  rce.GetLayer(lay
+00002030: 6572 290a 0a20 2020 2020 2020 2023 2049  er)..        # I
+00002040: 6620 7468 6520 6c61 7965 7220 646f 6573  f the layer does
+00002050: 6e27 7420 6578 6973 742c 2072 6574 7572  n't exist, retur
+00002060: 6e0a 2020 2020 2020 2020 6966 2064 6174  n.        if dat
+00002070: 6173 6f75 7263 655f 6c61 7965 7220 6973  asource_layer is
+00002080: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00002090: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000020a0: 726f 7228 6622 4c61 7965 7220 7b6c 6179  ror(f"Layer {lay
+000020b0: 6572 7d20 6e6f 7420 666f 756e 6420 696e  er} not found in
+000020c0: 2066 696c 653a 207b 7061 7468 7d22 290a   file: {path}").
+000020d0: 0a20 2020 2020 2020 2023 2047 6574 2063  .        # Get c
+000020e0: 6f6c 756d 6e20 696e 666f 0a20 2020 2020  olumn info.     
+000020f0: 2020 2063 6f6c 756d 6e73 203d 207b 7d0a     columns = {}.
+00002100: 2020 2020 2020 2020 6572 726f 7273 203d          errors =
+00002110: 205b 5d0a 2020 2020 2020 2020 6765 6f66   [].        geof
+00002120: 696c 6574 7970 6520 3d20 4765 6f66 696c  iletype = Geofil
+00002130: 6554 7970 6528 7061 7468 290a 2020 2020  eType(path).    
+00002140: 2020 2020 6c61 7965 725f 6465 666e 203d      layer_defn =
+00002150: 2064 6174 6173 6f75 7263 655f 6c61 7965   datasource_laye
+00002160: 722e 4765 744c 6179 6572 4465 666e 2829  r.GetLayerDefn()
+00002170: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+00002180: 6e20 7261 6e67 6528 6c61 7965 725f 6465  n range(layer_de
+00002190: 666e 2e47 6574 4669 656c 6443 6f75 6e74  fn.GetFieldCount
+000021a0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+000021b0: 206e 616d 6520 3d20 6c61 7965 725f 6465   name = layer_de
+000021c0: 666e 2e47 6574 4669 656c 6444 6566 6e28  fn.GetFieldDefn(
+000021d0: 6929 2e47 6574 4e61 6d65 2829 0a20 2020  i).GetName().   
+000021e0: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
+000021f0: 2074 6869 6e6b 2077 6865 7468 6572 2074   think whether t
+00002200: 6865 2074 7970 6520 6e61 6d65 2073 686f  he type name sho
+00002210: 756c 6420 6265 2063 6f6e 7665 7274 6564  uld be converted
+00002220: 2074 6f20 6f74 6865 7220 6e61 6d65 730a   to other names.
+00002230: 2020 2020 2020 2020 2020 2020 6764 616c              gdal
+00002240: 5f74 7970 6520 3d20 6c61 7965 725f 6465  _type = layer_de
+00002250: 666e 2e47 6574 4669 656c 6444 6566 6e28  fn.GetFieldDefn(
+00002260: 6929 2e47 6574 5479 7065 4e61 6d65 2829  i).GetTypeName()
+00002270: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00002280: 7468 203d 206c 6179 6572 5f64 6566 6e2e  th = layer_defn.
+00002290: 4765 7446 6965 6c64 4465 666e 2869 292e  GetFieldDefn(i).
+000022a0: 4765 7457 6964 7468 2829 0a20 2020 2020  GetWidth().     
+000022b0: 2020 2020 2020 2077 6964 7468 203d 2077         width = w
+000022c0: 6964 7468 2069 6620 7769 6474 6820 3e20  idth if width > 
+000022d0: 3020 656c 7365 204e 6f6e 650a 2020 2020  0 else None.    
+000022e0: 2020 2020 2020 2020 7072 6563 6973 696f          precisio
+000022f0: 6e20 3d20 6c61 7965 725f 6465 666e 2e47  n = layer_defn.G
+00002300: 6574 4669 656c 6444 6566 6e28 6929 2e47  etFieldDefn(i).G
+00002310: 6574 5072 6563 6973 696f 6e28 290a 2020  etPrecision().  
+00002320: 2020 2020 2020 2020 2020 7072 6563 6973            precis
+00002330: 696f 6e20 3d20 7072 6563 6973 696f 6e20  ion = precision 
+00002340: 6966 2070 7265 6369 7369 6f6e 203e 2030  if precision > 0
+00002350: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00002360: 2020 2020 2020 2069 6c6c 6567 616c 5f63         illegal_c
+00002370: 6f6c 756d 6e5f 6368 6172 7320 3d20 5b27  olumn_chars = ['
+00002380: 2227 5d0a 2020 2020 2020 2020 2020 2020  "'].            
+00002390: 666f 7220 696c 6c65 6761 6c5f 6368 6172  for illegal_char
+000023a0: 2069 6e20 696c 6c65 6761 6c5f 636f 6c75   in illegal_colu
+000023b0: 6d6e 5f63 6861 7273 3a0a 2020 2020 2020  mn_chars:.      
+000023c0: 2020 2020 2020 2020 2020 6966 2069 6c6c            if ill
+000023d0: 6567 616c 5f63 6861 7220 696e 206e 616d  egal_char in nam
+000023e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000023f0: 2020 2020 2020 2065 7272 6f72 732e 6170         errors.ap
+00002400: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+00002410: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00002420: 436f 6c75 6d6e 206e 616d 6520 7b6e 616d  Column name {nam
+00002430: 657d 2063 6f6e 7461 696e 7320 696c 6c65  e} contains ille
+00002440: 6761 6c20 6368 6172 3a20 7b69 6c6c 6567  gal char: {illeg
+00002450: 616c 5f63 6861 727d 2022 0a20 2020 2020  al_char} ".     
+00002460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002470: 2020 2066 2269 6e20 6669 6c65 207b 7061     f"in file {pa
+00002480: 7468 7d2c 206c 6179 6572 207b 6c61 7965  th}, layer {laye
+00002490: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+000024a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000024b0: 2020 2020 2020 636f 6c75 6d6e 5f69 6e66        column_inf
+000024c0: 6f20 3d20 436f 6c75 6d6e 496e 666f 280a  o = ColumnInfo(.
+000024d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024e0: 6e61 6d65 3d6e 616d 652c 2067 6461 6c5f  name=name, gdal_
+000024f0: 7479 7065 3d67 6461 6c5f 7479 7065 2c20  type=gdal_type, 
+00002500: 7769 6474 683d 7769 6474 682c 2070 7265  width=width, pre
+00002510: 6369 7369 6f6e 3d70 7265 6369 7369 6f6e  cision=precision
+00002520: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00002530: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+00002540: 6e73 5b6e 616d 655d 203d 2063 6f6c 756d  ns[name] = colum
+00002550: 6e5f 696e 666f 0a20 2020 2020 2020 2020  n_info.         
+00002560: 2020 2069 6620 6765 6f66 696c 6574 7970     if geofiletyp
+00002570: 6520 3d3d 2047 656f 6669 6c65 5479 7065  e == GeofileType
+00002580: 2e45 5352 4953 6861 7065 6669 6c65 3a0a  .ESRIShapefile:.
+00002590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025a0: 6966 206e 616d 652e 6361 7365 666f 6c64  if name.casefold
+000025b0: 2829 203d 3d20 2267 656f 6d65 7472 7922  () == "geometry"
+000025c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000025d0: 2020 2020 2020 6572 726f 7273 2e61 7070        errors.app
+000025e0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+000025f0: 2020 2020 2020 2020 2020 2020 2022 416e               "An
+00002600: 2061 7474 7269 6275 7465 2063 6f6c 756d   attribute colum
+00002610: 6e20 2767 656f 6d65 7472 7927 2069 7320  n 'geometry' is 
+00002620: 6e6f 7420 7375 7070 6f72 7465 6420 696e  not supported in
+00002630: 2061 2073 6861 7065 6669 6c65 220a 2020   a shapefile".  
+00002640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002650: 2020 290a 0a20 2020 2020 2020 2023 2047    )..        # G
+00002660: 6574 2067 656f 6d65 7472 7920 636f 6c75  et geometry colu
+00002670: 6d6e 2069 6e66 6f2e 2e2e 0a20 2020 2020  mn info....     
+00002680: 2020 2067 656f 6d65 7472 7974 7970 656e     geometrytypen
+00002690: 616d 6520 3d20 6764 616c 2e6f 6772 2e47  ame = gdal.ogr.G
+000026a0: 656f 6d65 7472 7954 7970 6554 6f4e 616d  eometryTypeToNam
+000026b0: 6528 6461 7461 736f 7572 6365 5f6c 6179  e(datasource_lay
+000026c0: 6572 2e47 6574 4765 6f6d 5479 7065 2829  er.GetGeomType()
+000026d0: 290a 2020 2020 2020 2020 6765 6f6d 6574  ).        geomet
+000026e0: 7279 7479 7065 6e61 6d65 203d 2067 656f  rytypename = geo
+000026f0: 6d65 7472 7974 7970 656e 616d 652e 7265  metrytypename.re
+00002700: 706c 6163 6528 2220 222c 2022 2229 2e75  place(" ", "").u
+00002710: 7070 6572 2829 0a0a 2020 2020 2020 2020  pper()..        
+00002720: 2320 466f 7220 7368 6170 6520 6669 6c65  # For shape file
+00002730: 732c 2074 6865 2064 6966 6665 7265 6e63  s, the differenc
+00002740: 6520 6265 7477 6565 6e20 7468 6520 274d  e between the 'M
+00002750: 554c 5449 2720 7661 7269 616e 7420 616e  ULTI' variant an
+00002760: 6420 7468 650a 2020 2020 2020 2020 2320  d the.        # 
+00002770: 7369 6e67 6c65 206f 6e65 2064 6f65 736e  single one doesn
+00002780: 2774 2065 7869 7374 732e 2e2e 2073 6f20  't exists... so 
+00002790: 616c 7761 7973 2072 6570 6f72 7420 4d55  always report MU
+000027a0: 4c54 4920 7661 7269 616e 7420 6279 2063  LTI variant by c
+000027b0: 6f6e 7665 6e74 696f 6e2e 0a20 2020 2020  onvention..     
+000027c0: 2020 2069 6620 4765 6f66 696c 6554 7970     if GeofileTyp
+000027d0: 6528 7061 7468 2920 3d3d 2047 656f 6669  e(path) == Geofi
+000027e0: 6c65 5479 7065 2e45 5352 4953 6861 7065  leType.ESRIShape
+000027f0: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+00002800: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+00002810: 2020 2020 2020 2067 656f 6d65 7472 7974         geometryt
+00002820: 7970 656e 616d 652e 7374 6172 7473 7769  ypename.startswi
+00002830: 7468 2822 504f 4c59 474f 4e22 290a 2020  th("POLYGON").  
+00002840: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00002850: 2067 656f 6d65 7472 7974 7970 656e 616d   geometrytypenam
+00002860: 652e 7374 6172 7473 7769 7468 2822 4c49  e.startswith("LI
+00002870: 4e45 5354 5249 4e47 2229 0a20 2020 2020  NESTRING").     
+00002880: 2020 2020 2020 2020 2020 206f 7220 6765             or ge
+00002890: 6f6d 6574 7279 7479 7065 6e61 6d65 2e73  ometrytypename.s
+000028a0: 7461 7274 7377 6974 6828 2250 4f49 4e54  tartswith("POINT
+000028b0: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
+000028c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000028d0: 2020 6765 6f6d 6574 7279 7479 7065 6e61    geometrytypena
+000028e0: 6d65 203d 2066 224d 554c 5449 7b67 656f  me = f"MULTI{geo
+000028f0: 6d65 7472 7974 7970 656e 616d 657d 220a  metrytypename}".
+00002900: 2020 2020 2020 2020 6966 2067 656f 6d65          if geome
+00002910: 7472 7974 7970 656e 616d 6520 3d3d 2022  trytypename == "
+00002920: 554e 4b4e 4f57 4e28 414e 5929 223a 0a20  UNKNOWN(ANY)":. 
+00002930: 2020 2020 2020 2020 2020 2067 656f 6d65             geome
+00002940: 7472 7974 7970 656e 616d 6520 3d20 2247  trytypename = "G
+00002950: 454f 4d45 5452 5922 0a0a 2020 2020 2020  EOMETRY"..      
+00002960: 2020 2320 4765 6f6d 6574 7279 7479 7065    # Geometrytype
+00002970: 0a20 2020 2020 2020 2069 6620 6765 6f6d  .        if geom
+00002980: 6574 7279 7479 7065 6e61 6d65 2021 3d20  etrytypename != 
+00002990: 224e 4f4e 4522 3a0a 2020 2020 2020 2020  "NONE":.        
+000029a0: 2020 2020 6765 6f6d 6574 7279 7479 7065      geometrytype
+000029b0: 203d 2047 656f 6d65 7472 7954 7970 655b   = GeometryType[
+000029c0: 6765 6f6d 6574 7279 7479 7065 6e61 6d65  geometrytypename
+000029d0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+000029e0: 2020 2020 2020 2020 2020 2020 6765 6f6d              geom
+000029f0: 6574 7279 7479 7065 203d 204e 6f6e 650a  etrytype = None.
+00002a00: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
+00002a10: 6520 6765 6f6d 6574 7279 2074 7970 6520  e geometry type 
+00002a20: 6973 206e 6f74 204e 6f6e 652c 2066 696c  is not None, fil
+00002a30: 6c20 6f75 7420 7468 6520 6578 7472 6120  l out the extra 
+00002a40: 7072 6f70 6572 7469 6573 0a20 2020 2020  properties.     
+00002a50: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
+00002a60: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
+00002a70: 2065 7874 656e 7420 3d20 4e6f 6e65 0a20   extent = None. 
+00002a80: 2020 2020 2020 2063 7273 203d 204e 6f6e         crs = Non
+00002a90: 650a 2020 2020 2020 2020 746f 7461 6c5f  e.        total_
+00002aa0: 626f 756e 6473 203d 204e 6f6e 650a 2020  bounds = None.  
+00002ab0: 2020 2020 2020 6966 2067 656f 6d65 7472        if geometr
+00002ac0: 7974 7970 6520 6973 206e 6f74 204e 6f6e  ytype is not Non
+00002ad0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00002ae0: 2047 656f 6d65 7472 7920 636f 6c75 6d6e   Geometry column
+00002af0: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
+00002b00: 2020 6765 6f6d 6574 7279 636f 6c75 6d6e    geometrycolumn
+00002b10: 203d 2064 6174 6173 6f75 7263 655f 6c61   = datasource_la
+00002b20: 7965 722e 4765 7447 656f 6d65 7472 7943  yer.GetGeometryC
+00002b30: 6f6c 756d 6e28 290a 2020 2020 2020 2020  olumn().        
+00002b40: 2020 2020 6966 2067 656f 6d65 7472 7963      if geometryc
+00002b50: 6f6c 756d 6e20 3d3d 2022 223a 0a20 2020  olumn == "":.   
+00002b60: 2020 2020 2020 2020 2020 2020 2067 656f               geo
+00002b70: 6d65 7472 7963 6f6c 756d 6e20 3d20 2267  metrycolumn = "g
+00002b80: 656f 6d65 7472 7922 0a20 2020 2020 2020  eometry".       
+00002b90: 2020 2020 2023 2043 6f6e 7665 7274 2065       # Convert e
+00002ba0: 7874 656e 7420 2878 6d69 6e2c 2078 6d61  xtent (xmin, xma
+00002bb0: 782c 2079 6d69 6e2c 2079 6d61 7829 2074  x, ymin, ymax) t
+00002bc0: 6f20 626f 756e 6473 2028 786d 696e 2c20  o bounds (xmin, 
+00002bd0: 796d 696e 2c20 786d 6178 2c20 796d 6178  ymin, xmax, ymax
+00002be0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00002bf0: 7465 6e74 203d 2064 6174 6173 6f75 7263  tent = datasourc
+00002c00: 655f 6c61 7965 722e 4765 7445 7874 656e  e_layer.GetExten
+00002c10: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00002c20: 746f 7461 6c5f 626f 756e 6473 203d 2028  total_bounds = (
+00002c30: 6578 7465 6e74 5b30 5d2c 2065 7874 656e  extent[0], exten
+00002c40: 745b 325d 2c20 6578 7465 6e74 5b31 5d2c  t[2], extent[1],
+00002c50: 2065 7874 656e 745b 335d 290a 2020 2020   extent[3]).    
+00002c60: 2020 2020 2020 2020 2320 4352 530a 2020          # CRS.  
+00002c70: 2020 2020 2020 2020 2020 7370 6174 6961            spatia
+00002c80: 6c72 6566 203d 2064 6174 6173 6f75 7263  lref = datasourc
+00002c90: 655f 6c61 7965 722e 4765 7453 7061 7469  e_layer.GetSpati
+00002ca0: 616c 5265 6628 290a 2020 2020 2020 2020  alRef().        
+00002cb0: 2020 2020 6966 2073 7061 7469 616c 7265      if spatialre
+00002cc0: 6620 6973 206e 6f74 204e 6f6e 653a 0a20  f is not None:. 
+00002cd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00002ce0: 7273 203d 2070 7970 726f 6a2e 4352 5328  rs = pyproj.CRS(
+00002cf0: 7370 6174 6961 6c72 6566 2e45 7870 6f72  spatialref.Expor
+00002d00: 7454 6f57 6b74 2829 290a 0a20 2020 2020  tToWkt())..     
+00002d10: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00002d20: 7370 6174 6961 6c20 7265 6620 6861 7320  spatial ref has 
+00002d30: 6e6f 2065 7073 672c 2074 7279 2074 6f20  no epsg, try to 
+00002d40: 6669 6e64 2063 6f72 7265 7370 6f6e 6469  find correspondi
+00002d50: 6e67 206f 6e65 0a20 2020 2020 2020 2020  ng one.         
+00002d60: 2020 2020 2020 2063 7273 5f65 7073 6720         crs_epsg 
+00002d70: 3d20 6372 732e 746f 5f65 7073 6728 290a  = crs.to_epsg().
+00002d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d90: 6966 2063 7273 5f65 7073 6720 6973 204e  if crs_epsg is N
+00002da0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00002db0: 2020 2020 2020 2020 2069 6620 6372 732e           if crs.
+00002dc0: 6e61 6d65 2069 6e20 5b0a 2020 2020 2020  name in [.      
+00002dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002de0: 2020 2242 656c 6765 2031 3937 3220 2f20    "Belge 1972 / 
+00002df0: 4265 6c67 6961 6e20 4c61 6d62 6572 7420  Belgian Lambert 
+00002e00: 3732 222c 0a20 2020 2020 2020 2020 2020  72",.           
+00002e10: 2020 2020 2020 2020 2020 2020 2022 4265               "Be
+00002e20: 6c67 655f 3139 3732 5f42 656c 6769 616e  lge_1972_Belgian
+00002e30: 5f4c 616d 6265 7274 5f37 3222 2c0a 2020  _Lambert_72",.  
+00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e50: 2020 2020 2020 2242 656c 6765 5f4c 616d        "Belge_Lam
+00002e60: 6265 7274 5f31 3937 3222 2c0a 2020 2020  bert_1972",.    
+00002e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e80: 2020 2020 2242 4437 3220 2f20 4265 6c67      "BD72 / Belg
+00002e90: 6961 6e20 4c61 6d62 6572 7420 3732 222c  ian Lambert 72",
+00002ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002eb0: 2020 2020 205d 3a0a 2020 2020 2020 2020       ]:.        
+00002ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ed0: 2320 4265 6c67 6961 6e20 4c61 6d62 6572  # Belgian Lamber
+00002ee0: 7420 696e 206e 616d 652c 2073 6f20 6173  t in name, so as
+00002ef0: 7375 6d65 2033 3133 3730 0a20 2020 2020  sume 31370.     
+00002f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f10: 2020 2063 7273 203d 2070 7970 726f 6a2e     crs = pyproj.
+00002f20: 4352 532e 6672 6f6d 5f65 7073 6728 3331  CRS.from_epsg(31
+00002f30: 3337 3029 0a0a 2020 2020 2020 2020 2020  370)..          
+00002f40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00002f50: 4966 2073 6861 7065 6669 6c65 2c20 6164  If shapefile, ad
+00002f60: 6420 636f 7272 6563 7420 3331 3337 3020  d correct 31370 
+00002f70: 2e70 726a 2066 696c 650a 2020 2020 2020  .prj file.      
+00002f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f90: 2020 6966 2047 656f 6669 6c65 5479 7065    if GeofileType
+00002fa0: 2870 6174 6829 203d 3d20 4765 6f66 696c  (path) == Geofil
+00002fb0: 6554 7970 652e 4553 5249 5368 6170 6566  eType.ESRIShapef
+00002fc0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fe0: 2070 726a 5f70 6174 6820 3d20 7061 7468   prj_path = path
+00002ff0: 2e70 6172 656e 7420 2f20 6622 7b70 6174  .parent / f"{pat
+00003000: 682e 7374 656d 7d2e 7072 6a22 0a20 2020  h.stem}.prj".   
+00003010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003020: 2020 2020 2020 2020 2069 6620 7072 6a5f           if prj_
+00003030: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
+00003040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003050: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00003060: 726a 5f72 656e 616d 655f 7061 7468 203d  rj_rename_path =
+00003070: 2070 6174 682e 7061 7265 6e74 202f 2066   path.parent / f
+00003080: 227b 7061 7468 2e73 7465 6d7d 5f6f 7269  "{path.stem}_ori
+00003090: 672e 7072 6a22 0a20 2020 2020 2020 2020  g.prj".         
+000030a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030b0: 2020 2020 2020 2069 6620 6e6f 7420 7072         if not pr
+000030c0: 6a5f 7265 6e61 6d65 5f70 6174 682e 6578  j_rename_path.ex
+000030d0: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+000030e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030f0: 2020 2020 2020 2020 2020 2020 7072 6a5f              prj_
+00003100: 7061 7468 2e72 656e 616d 6528 7072 6a5f  path.rename(prj_
+00003110: 7265 6e61 6d65 5f70 6174 6829 0a20 2020  rename_path).   
+00003120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003130: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00003140: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00003150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003160: 2020 2020 2020 2070 726a 5f70 6174 682e         prj_path.
+00003170: 756e 6c69 6e6b 2829 0a20 2020 2020 2020  unlink().       
+00003180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003190: 2020 2020 2020 2020 2070 726a 5f70 6174           prj_pat
+000031a0: 682e 7772 6974 655f 7465 7874 2850 524a  h.write_text(PRJ
+000031b0: 5f45 5053 475f 3331 3337 3029 0a0a 2020  _EPSG_31370)..  
+000031c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000031d0: 204c 6179 6572 496e 666f 280a 2020 2020   LayerInfo(.    
+000031e0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000031f0: 3d64 6174 6173 6f75 7263 655f 6c61 7965  =datasource_laye
+00003200: 722e 4765 744e 616d 6528 292c 0a20 2020  r.GetName(),.   
+00003210: 2020 2020 2020 2020 2020 2020 2066 6561               fea
+00003220: 7475 7265 636f 756e 743d 6461 7461 736f  turecount=dataso
+00003230: 7572 6365 5f6c 6179 6572 2e47 6574 4665  urce_layer.GetFe
+00003240: 6174 7572 6543 6f75 6e74 2829 2c0a 2020  atureCount(),.  
+00003250: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00003260: 7461 6c5f 626f 756e 6473 3d74 6f74 616c  tal_bounds=total
+00003270: 5f62 6f75 6e64 732c 0a20 2020 2020 2020  _bounds,.       
+00003280: 2020 2020 2020 2020 2067 656f 6d65 7472           geometr
+00003290: 7963 6f6c 756d 6e3d 6765 6f6d 6574 7279  ycolumn=geometry
+000032a0: 636f 6c75 6d6e 2c0a 2020 2020 2020 2020  column,.        
+000032b0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+000032c0: 7479 7065 6e61 6d65 3d67 656f 6d65 7472  typename=geometr
+000032d0: 7974 7970 656e 616d 652c 0a20 2020 2020  ytypename,.     
+000032e0: 2020 2020 2020 2020 2020 2067 656f 6d65             geome
+000032f0: 7472 7974 7970 653d 6765 6f6d 6574 7279  trytype=geometry
+00003300: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+00003310: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
+00003320: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
+00003330: 2020 2020 2020 2066 6964 5f63 6f6c 756d         fid_colum
+00003340: 6e3d 6461 7461 736f 7572 6365 5f6c 6179  n=datasource_lay
+00003350: 6572 2e47 6574 4649 4443 6f6c 756d 6e28  er.GetFIDColumn(
+00003360: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00003370: 2020 2063 7273 3d63 7273 2c0a 2020 2020     crs=crs,.    
+00003380: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+00003390: 7273 3d65 7272 6f72 732c 0a20 2020 2020  rs=errors,.     
+000033a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000033b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000033c0: 2020 2065 7272 6f72 732e 6170 7065 6e64     errors.append
+000033d0: 2822 4c61 7965 7220 646f 6573 6e27 7420  ("Layer doesn't 
+000033e0: 6861 7665 2061 2067 656f 6d65 7472 7920  have a geometry 
+000033f0: 636f 6c75 6d6e 2122 290a 0a20 2020 2065  column!")..    e
+00003400: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00003410: 6173 2065 783a 0a20 2020 2020 2020 2065  as ex:.        e
+00003420: 782e 6172 6773 203d 2028 6622 6765 745f  x.args = (f"get_
+00003430: 6c61 7965 7269 6e66 6f20 6572 726f 7220  layerinfo error 
+00003440: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
+00003450: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
+00003460: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+00003470: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+00003480: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00003490: 6f6e 650a 0a20 2020 2023 2049 6620 7765  one..    # If we
+000034a0: 2064 6964 6e27 7420 7265 7475 726e 206f   didn't return o
+000034b0: 7220 7261 6973 6520 7965 7420 6865 7265  r raise yet here
+000034c0: 2c20 7468 6572 6520 6d75 7374 2068 6176  , there must hav
+000034d0: 6520 6265 656e 2065 7272 6f72 730a 2020  e been errors.  
+000034e0: 2020 6572 726f 7273 5f73 7472 203d 2070    errors_str = p
+000034f0: 7072 696e 742e 7066 6f72 6d61 7428 6572  print.pformat(er
+00003500: 726f 7273 290a 2020 2020 7261 6973 6520  rors).    raise 
+00003510: 4578 6365 7074 696f 6e28 0a20 2020 2020  Exception(.     
+00003520: 2020 2066 2245 7272 6f72 7320 696e 206c     f"Errors in l
+00003530: 6179 6572 2064 6566 696e 6974 696f 6e20  ayer definition 
+00003540: 6f66 2066 696c 6520 7b70 6174 687d 2c20  of file {path}, 
+00003550: 6c61 7965 7220 7b6c 6179 6572 7d3a 205c  layer {layer}: \
+00003560: 6e7b 6572 726f 7273 5f73 7472 7d22 0a20  n{errors_str}". 
+00003570: 2020 2029 0a0a 0a64 6566 2067 6574 5f6f     )...def get_o
+00003580: 6e6c 795f 6c61 7965 7228 7061 7468 3a20  nly_layer(path: 
+00003590: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+000035a0: 6174 684c 696b 655b 416e 795d 225d 2920  athLike[Any]"]) 
+000035b0: 2d3e 2073 7472 3a0a 2020 2020 2222 220a  -> str:.    """.
+000035c0: 2020 2020 4765 7420 7468 6520 6c61 7965      Get the laye
+000035d0: 726e 616d 6520 666f 7220 6120 6669 6c65  rname for a file
+000035e0: 2074 6861 7420 6f6e 6c79 2063 6f6e 7461   that only conta
+000035f0: 696e 7320 6f6e 6520 6c61 7965 722e 0a0a  ins one layer...
+00003600: 2020 2020 4966 2074 6865 2066 696c 6520      If the file 
+00003610: 636f 6e74 6169 6e73 206d 756c 7469 706c  contains multipl
+00003620: 6520 6c61 7965 7273 2c20 616e 2065 7863  e layers, an exc
+00003630: 6570 7469 6f6e 2069 7320 7468 726f 776e  eption is thrown
+00003640: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00003650: 2020 2020 2070 6174 6820 2850 6174 684c       path (PathL
+00003660: 696b 6529 3a20 7468 6520 6669 6c65 2e0a  ike): the file..
+00003670: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+00003680: 2020 2020 2056 616c 7565 4572 726f 723a       ValueError:
+00003690: 2061 6e20 696e 7661 6c69 6420 7061 7261   an invalid para
+000036a0: 6d65 7465 7220 7661 6c75 6520 7761 7320  meter value was 
+000036b0: 7061 7373 6564 2e0a 0a20 2020 2052 6574  passed...    Ret
+000036c0: 7572 6e73 3a0a 2020 2020 2020 2020 7374  urns:.        st
+000036d0: 723a 2074 6865 206c 6179 6572 206e 616d  r: the layer nam
+000036e0: 650a 2020 2020 2222 220a 2020 2020 6461  e.    """.    da
+000036f0: 7461 736f 7572 6365 203d 204e 6f6e 650a  tasource = None.
+00003700: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00003710: 2064 6174 6173 6f75 7263 655f 6c61 7965   datasource_laye
+00003720: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
+00003730: 2064 6174 6173 6f75 7263 6520 3d20 6764   datasource = gd
+00003740: 616c 2e4f 7065 6e45 7828 0a20 2020 2020  al.OpenEx(.     
+00003750: 2020 2020 2020 2073 7472 2870 6174 6829         str(path)
+00003760: 2c20 6e4f 7065 6e46 6c61 6773 3d67 6461  , nOpenFlags=gda
+00003770: 6c2e 4f46 5f56 4543 544f 5220 7c20 6764  l.OF_VECTOR | gd
+00003780: 616c 2e4f 465f 5245 4144 4f4e 4c59 207c  al.OF_READONLY |
+00003790: 2067 6461 6c2e 4f46 5f53 4841 5245 440a   gdal.OF_SHARED.
+000037a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000037b0: 2020 6e62 5f6c 6179 6572 7320 3d20 6461    nb_layers = da
+000037c0: 7461 736f 7572 6365 2e47 6574 4c61 7965  tasource.GetLaye
+000037d0: 7243 6f75 6e74 2829 0a20 2020 2020 2020  rCount().       
+000037e0: 2069 6620 6e62 5f6c 6179 6572 7320 3d3d   if nb_layers ==
+000037f0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00003800: 6461 7461 736f 7572 6365 5f6c 6179 6572  datasource_layer
+00003810: 203d 2064 6174 6173 6f75 7263 652e 4765   = datasource.Ge
+00003820: 744c 6179 6572 4279 496e 6465 7828 3029  tLayerByIndex(0)
+00003830: 0a20 2020 2020 2020 2065 6c69 6620 6e62  .        elif nb
+00003840: 5f6c 6179 6572 7320 3d3d 2030 3a0a 2020  _layers == 0:.  
+00003850: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00003860: 5661 6c75 6545 7272 6f72 2866 2245 7272  ValueError(f"Err
+00003870: 6f72 3a20 4e6f 206c 6179 6572 7320 666f  or: No layers fo
+00003880: 756e 6420 696e 207b 7061 7468 7d22 290a  und in {path}").
+00003890: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000038a0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
+000038b0: 6b20 6966 2074 6865 7265 2069 7320 6f6e  k if there is on
+000038c0: 6c79 206f 6e65 2073 7061 7469 616c 206c  ly one spatial l
+000038d0: 6179 6572 0a20 2020 2020 2020 2020 2020  ayer.           
+000038e0: 206c 6179 6572 7320 3d20 6c69 7374 6c61   layers = listla
+000038f0: 7965 7273 2870 6174 682c 206f 6e6c 795f  yers(path, only_
+00003900: 7370 6174 6961 6c5f 6c61 7965 7273 3d54  spatial_layers=T
+00003910: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+00003920: 2069 6620 6c65 6e28 6c61 7965 7273 2920   if len(layers) 
+00003930: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00003940: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00003950: 5f6c 6179 6572 203d 2064 6174 6173 6f75  _layer = datasou
+00003960: 7263 652e 4765 744c 6179 6572 286c 6179  rce.GetLayer(lay
+00003970: 6572 735b 305d 290a 2020 2020 2020 2020  ers[0]).        
+00003980: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00003990: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000039a0: 5661 6c75 6545 7272 6f72 2866 224c 6179  ValueError(f"Lay
+000039b0: 6572 2068 6173 203e 2031 206c 6179 6572  er has > 1 layer
+000039c0: 3a20 7b70 6174 687d 3a20 7b6c 6179 6572  : {path}: {layer
+000039d0: 737d 2229 0a0a 2020 2020 2020 2020 7265  s}")..        re
+000039e0: 7475 726e 2064 6174 6173 6f75 7263 655f  turn datasource_
+000039f0: 6c61 7965 722e 4765 744e 616d 6528 290a  layer.GetName().
+00003a00: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+00003a10: 7074 696f 6e20 6173 2065 783a 0a20 2020  ption as ex:.   
+00003a20: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
+00003a30: 6622 6765 745f 6f6e 6c79 5f6c 6179 6572  f"get_only_layer
+00003a40: 2065 7272 6f72 2066 6f72 207b 7061 7468   error for {path
+00003a50: 7d3a 5c6e 2020 7b65 787d 222c 290a 2020  }:\n  {ex}",).  
+00003a60: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
+00003a70: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00003a80: 2064 6174 6173 6f75 7263 6520 3d20 4e6f   datasource = No
+00003a90: 6e65 0a0a 0a64 6566 2067 6574 5f64 6566  ne...def get_def
+00003aa0: 6175 6c74 5f6c 6179 6572 2870 6174 683a  ault_layer(path:
+00003ab0: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
+00003ac0: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d29  PathLike[Any]"])
+00003ad0: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+00003ae0: 0a20 2020 2047 6574 2074 6865 2064 6566  .    Get the def
+00003af0: 6175 6c74 206c 6179 6572 206e 616d 6520  ault layer name 
+00003b00: 746f 2062 6520 7573 6564 2066 6f72 2061  to be used for a
+00003b10: 206c 6179 6572 2069 6e20 7468 6973 2066   layer in this f
+00003b20: 696c 652e 0a0a 2020 2020 5468 6973 2069  ile...    This i
+00003b30: 7320 7468 6520 7374 656d 206f 6620 7468  s the stem of th
+00003b40: 6520 6669 6c65 7061 7468 2e0a 0a20 2020  e filepath...   
+00003b50: 2041 7267 733a 0a20 2020 2020 2020 2070   Args:.        p
+00003b60: 6174 6820 2855 6e69 6f6e 5b73 7472 2c29  ath (Union[str,)
+00003b70: 3a20 5468 6520 7061 7468 2074 6f20 7468  : The path to th
+00003b80: 6520 6669 6c65 2e0a 0a20 2020 2052 6574  e file...    Ret
+00003b90: 7572 6e73 3a0a 2020 2020 2020 2020 7374  urns:.        st
+00003ba0: 723a 2054 6865 2064 6566 6175 6c74 206c  r: The default l
+00003bb0: 6179 6572 206e 616d 652e 0a20 2020 2022  ayer name..    "
+00003bc0: 2222 0a20 2020 2072 6574 7572 6e20 5061  "".    return Pa
+00003bd0: 7468 2870 6174 6829 2e73 7465 6d0a 0a0a  th(path).stem...
+00003be0: 6465 6620 6578 6563 7574 655f 7371 6c28  def execute_sql(
+00003bf0: 0a20 2020 2070 6174 683a 2055 6e69 6f6e  .    path: Union
+00003c00: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
+00003c10: 6b65 5b41 6e79 5d22 5d2c 0a20 2020 2073  ke[Any]"],.    s
+00003c20: 716c 5f73 746d 743a 2073 7472 2c0a 2020  ql_stmt: str,.  
+00003c30: 2020 7371 6c5f 6469 616c 6563 743a 204f    sql_dialect: O
+00003c40: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00003c50: 6f6e 652c 0a29 3a0a 2020 2020 2222 220a  one,.):.    """.
+00003c60: 2020 2020 4578 6563 7574 6520 6120 7371      Execute a sq
+00003c70: 6c20 7374 6174 656d 656e 7420 2844 4d4c  l statement (DML
+00003c80: 206f 7220 4444 4c29 206f 6e20 7468 6520   or DDL) on the 
+00003c90: 6669 6c65 2e0a 0a20 2020 2054 6f20 7275  file...    To ru
+00003ca0: 6e20 5345 4c45 4354 2073 716c 2073 7461  n SELECT sql sta
+00003cb0: 7465 6d65 6e74 7320 6f6e 2061 2066 696c  tements on a fil
+00003cc0: 652c 2075 7365 203a 6d65 7468 3a60 7e72  e, use :meth:`~r
+00003cd0: 6561 645f 6669 6c65 602e 0a0a 2020 2020  ead_file`...    
+00003ce0: 4172 6773 3a0a 2020 2020 2020 2020 7061  Args:.        pa
+00003cf0: 7468 2028 5061 7468 4c69 6b65 293a 2054  th (PathLike): T
+00003d00: 6865 2070 6174 6820 746f 2074 6865 2066  he path to the f
+00003d10: 696c 652e 0a20 2020 2020 2020 2073 716c  ile..        sql
+00003d20: 5f73 746d 7420 2873 7472 293a 2054 6865  _stmt (str): The
+00003d30: 2073 716c 2073 7461 7465 6d65 6e74 2074   sql statement t
+00003d40: 6f20 6578 6563 7574 652e 0a20 2020 2020  o execute..     
+00003d50: 2020 2073 716c 5f64 6961 6c65 6374 2028     sql_dialect (
+00003d60: 7374 7229 3a20 5468 6520 7371 6c20 6469  str): The sql di
+00003d70: 616c 6563 7420 746f 2075 7365 3a0a 2020  alect to use:.  
+00003d80: 2020 2020 2020 2020 2020 2a20 4e6f 6e65            * None
+00003d90: 3a20 7573 6520 7468 6520 6e61 7469 7665  : use the native
+00003da0: 2053 514c 2064 6961 6c65 6374 206f 6620   SQL dialect of 
+00003db0: 7468 6520 6765 6f66 696c 652e 0a20 2020  the geofile..   
+00003dc0: 2020 2020 2020 2020 202a 2027 4f47 5253           * 'OGRS
+00003dd0: 514c 273a 2066 6f72 6365 2074 6865 2075  QL': force the u
+00003de0: 7365 206f 6620 7468 6520 4f47 5220 5351  se of the OGR SQ
+00003df0: 4c20 6469 616c 6563 742e 0a20 2020 2020  L dialect..     
+00003e00: 2020 2020 2020 202a 2027 5351 4c49 5445         * 'SQLITE
+00003e10: 273a 2066 6f72 6365 2074 6865 2075 7365  ': force the use
+00003e20: 206f 6620 7468 6520 5351 4c49 5445 2064   of the SQLITE d
+00003e30: 6961 6c65 6374 2e0a 2020 2020 2020 2020  ialect..        
+00003e40: 2020 2020 4465 6661 756c 7473 2074 6f20      Defaults to 
+00003e50: 4e6f 6e65 2e0a 2020 2020 2222 220a 2020  None..    """.  
+00003e60: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00003e70: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
+00003e80: 2020 2020 2064 6174 6173 6f75 7263 6520       datasource 
+00003e90: 3d20 6764 616c 2e4f 7065 6e45 7828 7374  = gdal.OpenEx(st
+00003ea0: 7228 7061 7468 292c 206e 4f70 656e 466c  r(path), nOpenFl
+00003eb0: 6167 733d 6764 616c 2e4f 465f 5550 4441  ags=gdal.OF_UPDA
+00003ec0: 5445 290a 2020 2020 2020 2020 7265 7375  TE).        resu
+00003ed0: 6c74 203d 2064 6174 6173 6f75 7263 652e  lt = datasource.
+00003ee0: 4578 6563 7574 6553 514c 2873 716c 5f73  ExecuteSQL(sql_s
+00003ef0: 746d 742c 2064 6961 6c65 6374 3d73 716c  tmt, dialect=sql
+00003f00: 5f64 6961 6c65 6374 290a 2020 2020 2020  _dialect).      
+00003f10: 2020 6461 7461 736f 7572 6365 2e52 656c    datasource.Rel
+00003f20: 6561 7365 5265 7375 6c74 5365 7428 7265  easeResultSet(re
+00003f30: 7375 6c74 290a 0a20 2020 2065 7863 6570  sult)..    excep
+00003f40: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00003f50: 783a 0a20 2020 2020 2020 2065 782e 6172  x:.        ex.ar
+00003f60: 6773 203d 2028 6622 6578 6563 7574 655f  gs = (f"execute_
+00003f70: 7371 6c20 6572 726f 7220 666f 7220 7b70  sql error for {p
+00003f80: 6174 687d 5c6e 2020 7b65 787d 222c 290a  ath}\n  {ex}",).
+00003f90: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+00003fa0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+00003fb0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+00003fc0: 4e6f 6e65 0a0a 0a64 6566 2063 7265 6174  None...def creat
+00003fd0: 655f 7370 6174 6961 6c5f 696e 6465 7828  e_spatial_index(
+00003fe0: 0a20 2020 2070 6174 683a 2055 6e69 6f6e  .    path: Union
+00003ff0: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
+00004000: 6b65 5b41 6e79 5d22 5d2c 0a20 2020 206c  ke[Any]"],.    l
+00004010: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00004020: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+00004030: 6361 6368 655f 7369 7a65 5f6d 623a 204f  cache_size_mb: O
+00004040: 7074 696f 6e61 6c5b 696e 745d 203d 2031  ptional[int] = 1
+00004050: 3238 2c0a 2020 2020 6578 6973 745f 6f6b  28,.    exist_ok
+00004060: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00004070: 2020 2020 666f 7263 655f 7265 6275 696c      force_rebuil
+00004080: 643a 2062 6f6f 6c20 3d20 4661 6c73 652c  d: bool = False,
+00004090: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+000040a0: 4372 6561 7465 2061 2073 7061 7469 616c  Create a spatial
+000040b0: 2069 6e64 6578 206f 6e20 7468 6520 6c61   index on the la
+000040c0: 7965 7220 7370 6563 6966 6965 642e 0a0a  yer specified...
+000040d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+000040e0: 2020 7061 7468 2028 5061 7468 4c69 6b65    path (PathLike
+000040f0: 293a 2054 6865 2066 696c 6520 7061 7468  ): The file path
+00004100: 2e0a 2020 2020 2020 2020 6c61 7965 7220  ..        layer 
+00004110: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
+00004120: 2054 6865 206c 6179 6572 2e20 4966 206e   The layer. If n
+00004130: 6f74 2073 7065 6369 6669 6564 2c20 616e  ot specified, an
+00004140: 6420 7468 6572 6520 6973 206f 6e6c 790a  d there is only.
+00004150: 2020 2020 2020 2020 2020 2020 6f6e 6520              one 
+00004160: 6c61 7965 7220 696e 2074 6865 2066 696c  layer in the fil
+00004170: 652c 2074 6869 7320 6c61 7965 7220 6973  e, this layer is
+00004180: 2075 7365 642e 204f 7468 6572 7769 7365   used. Otherwise
+00004190: 2065 7863 6570 7469 6f6e 2e0a 2020 2020   exception..    
+000041a0: 2020 2020 6361 6368 655f 7369 7a65 5f6d      cache_size_m
+000041b0: 6220 2869 6e74 2c20 6f70 7469 6f6e 616c  b (int, optional
+000041c0: 293a 2063 6163 6865 206d 656d 6f72 7920  ): cache memory 
+000041d0: 696e 204d 4220 7468 6174 2063 616e 2062  in MB that can b
+000041e0: 6520 7573 6564 2077 6869 6c65 0a20 2020  e used while.   
+000041f0: 2020 2020 2020 2020 2063 7265 6174 696e           creatin
+00004200: 6720 7370 6174 6961 6c20 696e 6465 7820  g spatial index 
+00004210: 666f 7220 7370 6174 6961 6c69 7465 2066  for spatialite f
+00004220: 696c 6573 2028 2e67 706b 6720 6f72 202e  iles (.gpkg or .
+00004230: 7371 6c69 7465 292e 2049 6620 4e6f 6e65  sqlite). If None
+00004240: 2c0a 2020 2020 2020 2020 2020 2020 7468  ,.            th
+00004250: 6520 6465 6661 756c 7420 6361 6368 655f  e default cache_
+00004260: 7369 7a65 2066 726f 6d20 7371 6c69 7465  size from sqlite
+00004270: 2069 7320 7573 6564 2e20 4465 6661 756c   is used. Defaul
+00004280: 7473 2074 6f20 3132 382e 0a20 2020 2020  ts to 128..     
+00004290: 2020 2065 7869 7374 5f6f 6b20 2862 6f6f     exist_ok (boo
+000042a0: 6c2c 206f 7074 696f 6e73 293a 2049 6620  l, options): If 
+000042b0: 5472 7565 2061 6e64 2074 6865 2069 6e64  True and the ind
+000042c0: 6578 2065 7869 7374 7320 616c 7265 6164  ex exists alread
+000042d0: 792c 2064 6f6e 2774 0a20 2020 2020 2020  y, don't.       
+000042e0: 2020 2020 2074 6872 6f77 2061 6e20 6572       throw an er
+000042f0: 726f 722e 0a20 2020 2020 2020 2066 6f72  ror..        for
+00004300: 6365 5f72 6562 7569 6c64 2028 626f 6f6c  ce_rebuild (bool
+00004310: 2c20 6f70 7469 6f6e 7329 3a20 5472 7565  , options): True
+00004320: 2074 6f20 666f 7263 6520 7265 6275 696c   to force rebuil
+00004330: 6420 6576 656e 2069 6620 696e 6465 780a  d even if index.
+00004340: 2020 2020 2020 2020 2020 2020 6578 6973              exis
+00004350: 7473 2061 6c72 6561 6479 2e20 4465 6661  ts already. Defa
+00004360: 756c 7473 2074 6f20 4661 6c73 652e 0a20  ults to False.. 
+00004370: 2020 2022 2222 0a20 2020 2023 2049 6e69     """.    # Ini
+00004380: 740a 2020 2020 7061 7468 203d 2050 6174  t.    path = Pat
+00004390: 6828 7061 7468 290a 2020 2020 6966 206c  h(path).    if l
+000043a0: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
+000043b0: 2020 2020 2020 6c61 7965 7220 3d20 6765        layer = ge
+000043c0: 745f 6f6e 6c79 5f6c 6179 6572 2870 6174  t_only_layer(pat
+000043d0: 6829 0a0a 2020 2020 2320 4966 2069 6e64  h)..    # If ind
+000043e0: 6578 2061 6c72 6561 6479 2065 7869 7374  ex already exist
+000043f0: 732c 2072 656d 6f76 6520 696e 6465 7820  s, remove index 
+00004400: 6f72 2072 6574 7572 6e0a 2020 2020 6966  or return.    if
+00004410: 2068 6173 5f73 7061 7469 616c 5f69 6e64   has_spatial_ind
+00004420: 6578 2870 6174 682c 206c 6179 6572 293a  ex(path, layer):
+00004430: 0a20 2020 2020 2020 2069 6620 666f 7263  .        if forc
+00004440: 655f 7265 6275 696c 643a 0a20 2020 2020  e_rebuild:.     
+00004450: 2020 2020 2020 2072 656d 6f76 655f 7370         remove_sp
+00004460: 6174 6961 6c5f 696e 6465 7828 7061 7468  atial_index(path
+00004470: 2c20 6c61 7965 7229 0a20 2020 2020 2020  , layer).       
+00004480: 2065 6c69 6620 6578 6973 745f 6f6b 3a0a   elif exist_ok:.
+00004490: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000044a0: 726e 0a20 2020 2020 2020 2065 6c73 653a  rn.        else:
+000044b0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000044c0: 7365 2045 7863 6570 7469 6f6e 280a 2020  se Exception(.  
+000044d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000044e0: 4572 726f 7220 6164 6469 6e67 2073 7061  Error adding spa
+000044f0: 7469 616c 2069 6e64 6578 2074 6f20 7b70  tial index to {p
+00004500: 6174 687d 2e7b 6c61 7965 727d 2c20 6974  ath}.{layer}, it
+00004510: 2065 7869 7374 7320 616c 7265 6164 7922   exists already"
+00004520: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00004530: 2020 2020 2320 4e6f 7720 7265 616c 6c79      # Now really
+00004540: 2061 6464 2069 6e64 6578 0a20 2020 2064   add index.    d
+00004550: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+00004560: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00004570: 2020 6765 6f66 696c 6574 7970 6520 3d20    geofiletype = 
+00004580: 4765 6f66 696c 6554 7970 6528 7061 7468  GeofileType(path
+00004590: 290a 2020 2020 2020 2020 6966 2067 656f  ).        if geo
+000045a0: 6669 6c65 7479 7065 2e69 735f 7370 6174  filetype.is_spat
+000045b0: 6961 6c69 7465 5f62 6173 6564 3a0a 2020  ialite_based:.  
+000045c0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+000045d0: 636f 6e66 6967 206f 7074 696f 6e73 206e  config options n
+000045e0: 6565 6420 746f 2062 6520 7365 7420 6265  eed to be set be
+000045f0: 666f 7265 206f 7065 6e69 6e67 2074 6865  fore opening the
+00004600: 2066 696c 6521 0a20 2020 2020 2020 2020   file!.         
+00004610: 2020 206c 6179 6572 696e 666f 203d 2067     layerinfo = g
+00004620: 6574 5f6c 6179 6572 696e 666f 2870 6174  et_layerinfo(pat
+00004630: 682c 206c 6179 6572 290a 2020 2020 2020  h, layer).      
+00004640: 2020 2020 2020 7769 7468 205f 6f67 725f        with _ogr_
+00004650: 7574 696c 2e73 6574 5f63 6f6e 6669 675f  util.set_config_
+00004660: 6f70 7469 6f6e 7328 7b22 4f47 525f 5351  options({"OGR_SQ
+00004670: 4c49 5445 5f43 4143 4845 223a 2063 6163  LITE_CACHE": cac
+00004680: 6865 5f73 697a 655f 6d62 7d29 3a0a 2020  he_size_mb}):.  
+00004690: 2020 2020 2020 2020 2020 2020 2020 6461                da
+000046a0: 7461 736f 7572 6365 203d 2067 6461 6c2e  tasource = gdal.
+000046b0: 4f70 656e 4578 2873 7472 2870 6174 6829  OpenEx(str(path)
+000046c0: 2c20 6e4f 7065 6e46 6c61 6773 3d67 6461  , nOpenFlags=gda
+000046d0: 6c2e 4f46 5f55 5044 4154 4529 0a20 2020  l.OF_UPDATE).   
+000046e0: 2020 2020 2020 2020 2020 2020 2067 656f               geo
+000046f0: 6d65 7472 7963 6f6c 756d 6e20 3d20 6c61  metrycolumn = la
+00004700: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+00004710: 636f 6c75 6d6e 0a20 2020 2020 2020 2020  column.         
+00004720: 2020 2020 2020 2073 716c 203d 2066 2253         sql = f"S
+00004730: 454c 4543 5420 4372 6561 7465 5370 6174  ELECT CreateSpat
+00004740: 6961 6c49 6e64 6578 2827 7b6c 6179 6572  ialIndex('{layer
+00004750: 7d27 2c20 277b 6765 6f6d 6574 7279 636f  }', '{geometryco
+00004760: 6c75 6d6e 7d27 2922 0a20 2020 2020 2020  lumn}')".       
+00004770: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00004780: 3d20 6461 7461 736f 7572 6365 2e45 7865  = datasource.Exe
+00004790: 6375 7465 5351 4c28 7371 6c2c 2064 6961  cuteSQL(sql, dia
+000047a0: 6c65 6374 3d22 5351 4c49 5445 2229 0a20  lect="SQLITE"). 
+000047b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000047c0: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
+000047d0: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
+000047e0: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
+000047f0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+00004800: 6173 6f75 7263 6520 3d20 6764 616c 2e4f  asource = gdal.O
+00004810: 7065 6e45 7828 7374 7228 7061 7468 292c  penEx(str(path),
+00004820: 206e 4f70 656e 466c 6167 733d 6764 616c   nOpenFlags=gdal
+00004830: 2e4f 465f 5550 4441 5445 290a 2020 2020  .OF_UPDATE).    
+00004840: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00004850: 2064 6174 6173 6f75 7263 652e 4578 6563   datasource.Exec
+00004860: 7574 6553 514c 2866 2743 5245 4154 4520  uteSQL(f'CREATE 
+00004870: 5350 4154 4941 4c20 494e 4445 5820 4f4e  SPATIAL INDEX ON
+00004880: 2022 7b6c 6179 6572 7d22 2729 0a20 2020   "{layer}"').   
+00004890: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
+000048a0: 7263 652e 5265 6c65 6173 6552 6573 756c  rce.ReleaseResul
+000048b0: 7453 6574 2872 6573 756c 7429 0a0a 2020  tSet(result)..  
+000048c0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+000048d0: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+000048e0: 2020 6578 2e61 7267 7320 3d20 2866 2263    ex.args = (f"c
+000048f0: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+00004900: 6465 7820 6572 726f 7220 666f 7220 7b70  dex error for {p
+00004910: 6174 687d 2e7b 6c61 7965 727d 3a5c 6e20  ath}.{layer}:\n 
+00004920: 207b 6578 7d22 2c29 0a20 2020 2020 2020   {ex}",).       
+00004930: 2072 6169 7365 0a20 2020 2066 696e 616c   raise.    final
+00004940: 6c79 3a0a 2020 2020 2020 2020 6461 7461  ly:.        data
+00004950: 736f 7572 6365 203d 204e 6f6e 650a 0a20  source = None.. 
+00004960: 2020 2069 6620 6e6f 7420 6861 735f 7370     if not has_sp
+00004970: 6174 6961 6c5f 696e 6465 7828 7061 7468  atial_index(path
+00004980: 2c20 6c61 7965 7229 3a0a 2020 2020 2020  , layer):.      
+00004990: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+000049a0: 7272 6f72 2866 2263 7265 6174 655f 7370  rror(f"create_sp
+000049b0: 6174 6961 6c5f 696e 6465 7820 6661 696c  atial_index fail
+000049c0: 6564 206f 6e20 7b70 6174 687d 2c20 6c61  ed on {path}, la
+000049d0: 7965 723a 207b 6c61 7965 727d 2229 0a0a  yer: {layer}")..
+000049e0: 0a64 6566 2068 6173 5f73 7061 7469 616c  .def has_spatial
+000049f0: 5f69 6e64 6578 280a 2020 2020 7061 7468  _index(.    path
+00004a00: 3a20 556e 696f 6e5b 7374 722c 2022 6f73  : Union[str, "os
+00004a10: 2e50 6174 684c 696b 655b 416e 795d 225d  .PathLike[Any]"]
+00004a20: 2c20 6c61 7965 723a 204f 7074 696f 6e61  , layer: Optiona
+00004a30: 6c5b 7374 725d 203d 204e 6f6e 650a 2920  l[str] = None.) 
+00004a40: 2d3e 2062 6f6f 6c3a 0a20 2020 2022 2222  -> bool:.    """
+00004a50: 0a20 2020 2043 6865 636b 2069 6620 7468  .    Check if th
+00004a60: 6520 6c61 7965 722f 636f 6c75 6d6e 2068  e layer/column h
+00004a70: 6173 2061 2073 7061 7469 616c 2069 6e64  as a spatial ind
+00004a80: 6578 2e0a 0a20 2020 2041 7267 733a 0a20  ex...    Args:. 
+00004a90: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+00004aa0: 684c 696b 6529 3a20 5468 6520 6669 6c65  hLike): The file
+00004ab0: 2070 6174 682e 0a20 2020 2020 2020 206c   path..        l
+00004ac0: 6179 6572 2028 7374 722c 206f 7074 696f  ayer (str, optio
+00004ad0: 6e61 6c29 3a20 5468 6520 6c61 7965 722e  nal): The layer.
+00004ae0: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00004af0: 652e 0a0a 2020 2020 5261 6973 6573 3a0a  e...    Raises:.
+00004b00: 2020 2020 2020 2020 5661 6c75 6545 7272          ValueErr
+00004b10: 6f72 3a20 616e 2069 6e76 616c 6964 2070  or: an invalid p
+00004b20: 6172 616d 6574 6572 2076 616c 7565 2077  arameter value w
+00004b30: 6173 2070 6173 7365 642e 0a0a 2020 2020  as passed...    
+00004b40: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00004b50: 2062 6f6f 6c3a 2054 7275 6520 6966 2074   bool: True if t
+00004b60: 6865 2073 7061 7469 616c 2063 6f6c 756d  he spatial colum
+00004b70: 6e20 6578 6973 7473 2e0a 2020 2020 2222  n exists..    ""
+00004b80: 220a 2020 2020 2320 496e 6974 0a20 2020  ".    # Init.   
+00004b90: 2070 6174 6820 3d20 5061 7468 2870 6174   path = Path(pat
+00004ba0: 6829 0a0a 2020 2020 2320 4e6f 7720 6368  h)..    # Now ch
+00004bb0: 6563 6b20 7468 6520 696e 6465 780a 2020  eck the index.  
+00004bc0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00004bd0: 6f6e 650a 2020 2020 6765 6f66 696c 6574  one.    geofilet
+00004be0: 7970 6520 3d20 4765 6f66 696c 6554 7970  ype = GeofileTyp
+00004bf0: 6528 7061 7468 290a 2020 2020 7472 793a  e(path).    try:
+00004c00: 0a20 2020 2020 2020 2069 6620 6765 6f66  .        if geof
+00004c10: 696c 6574 7970 652e 6973 5f73 7061 7469  iletype.is_spati
+00004c20: 616c 6974 655f 6261 7365 643a 0a20 2020  alite_based:.   
+00004c30: 2020 2020 2020 2020 206c 6179 6572 696e           layerin
+00004c40: 666f 203d 2067 6574 5f6c 6179 6572 696e  fo = get_layerin
+00004c50: 666f 2870 6174 682c 206c 6179 6572 290a  fo(path, layer).
+00004c60: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00004c70: 736f 7572 6365 203d 2067 6461 6c2e 4f70  source = gdal.Op
+00004c80: 656e 4578 2873 7472 2870 6174 6829 2c20  enEx(str(path), 
+00004c90: 6e4f 7065 6e46 6c61 6773 3d67 6461 6c2e  nOpenFlags=gdal.
+00004ca0: 4f46 5f52 4541 444f 4e4c 5929 0a20 2020  OF_READONLY).   
+00004cb0: 2020 2020 2020 2020 2073 716c 203d 2066           sql = f
+00004cc0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+00004cd0: 2020 2020 5345 4c45 4354 2048 6173 5370      SELECT HasSp
+00004ce0: 6174 6961 6c49 6e64 6578 2827 7b6c 6179  atialIndex('{lay
+00004cf0: 6572 696e 666f 2e6e 616d 657d 272c 0a20  erinfo.name}',. 
+00004d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d20: 2020 2020 2020 277b 6c61 7965 7269 6e66        '{layerinf
+00004d30: 6f2e 6765 6f6d 6574 7279 636f 6c75 6d6e  o.geometrycolumn
+00004d40: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00004d50: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+00004d60: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
+00004d70: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
+00004d80: 716c 2c20 6469 616c 6563 743d 2253 514c  ql, dialect="SQL
+00004d90: 4954 4522 290a 2020 2020 2020 2020 2020  ITE").          
+00004da0: 2020 6861 735f 7370 6174 6961 6c5f 696e    has_spatial_in
+00004db0: 6465 7820 3d20 7265 7375 6c74 2e47 6574  dex = result.Get
+00004dc0: 4e65 7874 4665 6174 7572 6528 292e 4765  NextFeature().Ge
+00004dd0: 7446 6965 6c64 2830 2920 3d3d 2031 0a20  tField(0) == 1. 
+00004de0: 2020 2020 2020 2020 2020 2064 6174 6173             datas
+00004df0: 6f75 7263 652e 5265 6c65 6173 6552 6573  ource.ReleaseRes
+00004e00: 756c 7453 6574 2872 6573 756c 7429 0a20  ultSet(result). 
+00004e10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00004e20: 6e20 6861 735f 7370 6174 6961 6c5f 696e  n has_spatial_in
+00004e30: 6465 780a 2020 2020 2020 2020 656c 6966  dex.        elif
+00004e40: 2067 656f 6669 6c65 7479 7065 203d 3d20   geofiletype == 
+00004e50: 4765 6f66 696c 6554 7970 652e 4553 5249  GeofileType.ESRI
+00004e60: 5368 6170 6566 696c 653a 0a20 2020 2020  Shapefile:.     
+00004e70: 2020 2020 2020 2069 6e64 6578 5f70 6174         index_pat
+00004e80: 6820 3d20 7061 7468 2e70 6172 656e 7420  h = path.parent 
+00004e90: 2f20 6622 7b70 6174 682e 7374 656d 7d2e  / f"{path.stem}.
+00004ea0: 7169 7822 0a20 2020 2020 2020 2020 2020  qix".           
+00004eb0: 2072 6574 7572 6e20 696e 6465 785f 7061   return index_pa
+00004ec0: 7468 2e65 7869 7374 7328 290a 2020 2020  th.exists().    
+00004ed0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00004ee0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00004ef0: 6545 7272 6f72 2866 2268 6173 5f73 7061  eError(f"has_spa
+00004f00: 7469 616c 5f69 6e64 6578 206e 6f74 2073  tial_index not s
+00004f10: 7570 706f 7274 6564 2066 6f72 207b 7061  upported for {pa
+00004f20: 7468 7d22 290a 0a20 2020 2065 7863 6570  th}")..    excep
+00004f30: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00004f40: 783a 0a20 2020 2020 2020 2065 782e 6172  x:.        ex.ar
+00004f50: 6773 203d 2028 6622 6861 735f 7370 6174  gs = (f"has_spat
+00004f60: 6961 6c5f 696e 6465 7820 6572 726f 7220  ial_index error 
+00004f70: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
+00004f80: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
+00004f90: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+00004fa0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+00004fb0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00004fc0: 6f6e 650a 0a0a 6465 6620 7265 6d6f 7665  one...def remove
+00004fd0: 5f73 7061 7469 616c 5f69 6e64 6578 280a  _spatial_index(.
+00004fe0: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
+00004ff0: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+00005000: 655b 416e 795d 225d 2c20 6c61 7965 723a  e[Any]"], layer:
+00005010: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00005020: 204e 6f6e 650a 293a 0a20 2020 2022 2222   None.):.    """
+00005030: 0a20 2020 2052 656d 6f76 6520 7468 6520  .    Remove the 
+00005040: 7370 6174 6961 6c20 696e 6465 7820 6672  spatial index fr
+00005050: 6f6d 2074 6865 206c 6179 6572 2073 7065  om the layer spe
+00005060: 6369 6669 6564 2e0a 0a20 2020 2041 7267  cified...    Arg
+00005070: 733a 0a20 2020 2020 2020 2070 6174 6820  s:.        path 
+00005080: 2850 6174 684c 696b 6529 3a20 5468 6520  (PathLike): The 
+00005090: 6669 6c65 2070 6174 682e 0a20 2020 2020  file path..     
+000050a0: 2020 206c 6179 6572 2028 7374 722c 206f     layer (str, o
+000050b0: 7074 696f 6e61 6c29 3a20 5468 6520 6c61  ptional): The la
+000050c0: 7965 722e 2049 6620 6e6f 7420 7370 6563  yer. If not spec
+000050d0: 6966 6965 642c 2061 6e64 2074 6865 7265  ified, and there
+000050e0: 2069 7320 6f6e 6c79 0a20 2020 2020 2020   is only.       
+000050f0: 2020 2020 206f 6e65 206c 6179 6572 2069       one layer i
+00005100: 6e20 7468 6520 6669 6c65 2c20 7468 6973  n the file, this
+00005110: 206c 6179 6572 2069 7320 7573 6564 2e20   layer is used. 
+00005120: 4f74 6865 7277 6973 6520 6578 6365 7074  Otherwise except
+00005130: 696f 6e2e 0a20 2020 2022 2222 0a20 2020  ion..    """.   
+00005140: 2023 2049 6e69 740a 2020 2020 7061 7468   # Init.    path
+00005150: 203d 2050 6174 6828 7061 7468 290a 0a20   = Path(path).. 
+00005160: 2020 2023 204e 6f77 2072 6561 6c6c 7920     # Now really 
+00005170: 7265 6d6f 7665 2069 6e64 6578 0a20 2020  remove index.   
+00005180: 2064 6174 6173 6f75 7263 6520 3d20 4e6f   datasource = No
+00005190: 6e65 0a20 2020 2067 656f 6669 6c65 7479  ne.    geofilety
+000051a0: 7065 203d 2047 656f 6669 6c65 5479 7065  pe = GeofileType
+000051b0: 2870 6174 6829 0a20 2020 206c 6179 6572  (path).    layer
+000051c0: 696e 666f 203d 2067 6574 5f6c 6179 6572  info = get_layer
+000051d0: 696e 666f 2870 6174 682c 206c 6179 6572  info(path, layer
+000051e0: 290a 2020 2020 7472 793a 0a20 2020 2020  ).    try:.     
+000051f0: 2020 2069 6620 6765 6f66 696c 6574 7970     if geofiletyp
+00005200: 652e 6973 5f73 7061 7469 616c 6974 655f  e.is_spatialite_
+00005210: 6261 7365 643a 0a20 2020 2020 2020 2020  based:.         
+00005220: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+00005230: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
+00005240: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
+00005250: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
+00005260: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00005270: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
+00005280: 652e 4578 6563 7574 6553 514c 280a 2020  e.ExecuteSQL(.  
+00005290: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000052a0: 5345 4c45 4354 2044 6973 6162 6c65 5370  SELECT DisableSp
+000052b0: 6174 6961 6c49 6e64 6578 2827 7b6c 6179  atialIndex('{lay
+000052c0: 6572 696e 666f 2e6e 616d 657d 272c 2027  erinfo.name}', '
+000052d0: 7b6c 6179 6572 696e 666f 2e67 656f 6d65  {layerinfo.geome
+000052e0: 7472 7963 6f6c 756d 6e7d 2729 222c 2020  trycolumn}')",  
+000052f0: 2320 6e6f 7161 3a20 4535 3031 0a20 2020  # noqa: E501.   
+00005300: 2020 2020 2020 2020 2020 2020 2064 6961               dia
+00005310: 6c65 6374 3d22 5351 4c49 5445 222c 0a20  lect="SQLITE",. 
+00005320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00005330: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
+00005340: 7263 652e 5265 6c65 6173 6552 6573 756c  rce.ReleaseResul
+00005350: 7453 6574 2872 6573 756c 7429 0a20 2020  tSet(result).   
+00005360: 2020 2020 2065 6c69 6620 6765 6f66 696c       elif geofil
+00005370: 6574 7970 6520 3d3d 2047 656f 6669 6c65  etype == Geofile
+00005380: 5479 7065 2e45 5352 4953 6861 7065 6669  Type.ESRIShapefi
+00005390: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+000053a0: 2320 4452 4f50 2053 5041 5449 414c 2049  # DROP SPATIAL I
+000053b0: 4e44 4558 204f 4e20 2e2e 2e20 636f 6d6d  NDEX ON ... comm
+000053c0: 616e 6420 6769 7665 7320 616e 2065 7272  and gives an err
+000053d0: 6f72 2c20 736f 206a 7573 7420 7265 6d6f  or, so just remo
+000053e0: 7665 202e 7169 780a 2020 2020 2020 2020  ve .qix.        
+000053f0: 2020 2020 696e 6465 785f 7061 7468 203d      index_path =
+00005400: 2070 6174 682e 7061 7265 6e74 202f 2066   path.parent / f
+00005410: 227b 7061 7468 2e73 7465 6d7d 2e71 6978  "{path.stem}.qix
+00005420: 220a 2020 2020 2020 2020 2020 2020 696e  ".            in
+00005430: 6465 785f 7061 7468 2e75 6e6c 696e 6b28  dex_path.unlink(
+00005440: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00005450: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00005460: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+00005470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005480: 6622 7265 6d6f 7665 5f73 7061 7469 616c  f"remove_spatial
+00005490: 5f69 6e64 6578 2069 7320 6e6f 7420 7375  _index is not su
+000054a0: 7070 6f72 7465 6420 666f 7220 7b70 6174  pported for {pat
+000054b0: 682e 7375 6666 6978 7d20 6669 6c65 220a  h.suffix} file".
+000054c0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000054d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000054e0: 696f 6e20 6173 2065 783a 0a20 2020 2020  ion as ex:.     
+000054f0: 2020 2065 782e 6172 6773 203d 2028 6622     ex.args = (f"
+00005500: 7265 6d6f 7665 5f73 7061 7469 616c 5f69  remove_spatial_i
+00005510: 6e64 6578 2065 7272 6f72 2066 6f72 207b  ndex error for {
+00005520: 7061 7468 7d2e 7b6c 6179 6572 7d3a 5c6e  path}.{layer}:\n
+00005530: 2020 7b65 787d 222c 290a 2020 2020 2020    {ex}",).      
+00005540: 2020 7261 6973 650a 2020 2020 6669 6e61    raise.    fina
+00005550: 6c6c 793a 0a20 2020 2020 2020 2064 6174  lly:.        dat
+00005560: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a0a  asource = None..
+00005570: 0a64 6566 2072 656e 616d 655f 6c61 7965  .def rename_laye
+00005580: 7228 0a20 2020 2070 6174 683a 2055 6e69  r(.    path: Uni
+00005590: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
+000055a0: 4c69 6b65 5b41 6e79 5d22 5d2c 206e 6577  Like[Any]"], new
+000055b0: 5f6c 6179 6572 3a20 7374 722c 206c 6179  _layer: str, lay
+000055c0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+000055d0: 5d20 3d20 4e6f 6e65 0a29 3a0a 2020 2020  ] = None.):.    
+000055e0: 2222 220a 2020 2020 5265 6e61 6d65 2074  """.    Rename t
+000055f0: 6865 206c 6179 6572 2073 7065 6369 6669  he layer specifi
+00005600: 6564 2e0a 0a20 2020 2041 7267 733a 0a20  ed...    Args:. 
+00005610: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+00005620: 684c 696b 6529 3a20 5468 6520 6669 6c65  hLike): The file
+00005630: 2070 6174 682e 0a20 2020 2020 2020 206c   path..        l
+00005640: 6179 6572 2028 4f70 7469 6f6e 616c 5b73  ayer (Optional[s
+00005650: 7472 5d29 3a20 5468 6520 6c61 7965 7220  tr]): The layer 
+00005660: 6e61 6d65 2e20 4966 206e 6f74 2073 7065  name. If not spe
+00005670: 6369 6669 6564 2c20 616e 6420 7468 6572  cified, and ther
+00005680: 6520 6973 206f 6e6c 790a 2020 2020 2020  e is only.      
+00005690: 2020 2020 2020 6f6e 6520 6c61 7965 7220        one layer 
+000056a0: 696e 2074 6865 2066 696c 652c 2074 6869  in the file, thi
+000056b0: 7320 6c61 7965 7220 6973 2075 7365 642e  s layer is used.
+000056c0: 204f 7468 6572 7769 7365 2065 7863 6570   Otherwise excep
+000056d0: 7469 6f6e 2e0a 2020 2020 2020 2020 6e65  tion..        ne
+000056e0: 775f 6c61 7965 7220 2873 7472 293a 2054  w_layer (str): T
+000056f0: 6865 206e 6577 206c 6179 6572 206e 616d  he new layer nam
+00005700: 652e 2049 6620 6e6f 7420 7370 6563 6966  e. If not specif
+00005710: 6965 642c 2061 6e64 2074 6865 7265 2069  ied, and there i
+00005720: 7320 6f6e 6c79 0a20 2020 2020 2020 2020  s only.         
+00005730: 2020 206f 6e65 206c 6179 6572 2069 6e20     one layer in 
+00005740: 7468 6520 6669 6c65 2c20 7468 6973 206c  the file, this l
+00005750: 6179 6572 2069 7320 7573 6564 2e20 4f74  ayer is used. Ot
+00005760: 6865 7277 6973 6520 6578 6365 7074 696f  herwise exceptio
+00005770: 6e2e 0a20 2020 2022 2222 0a20 2020 2023  n..    """.    #
+00005780: 2043 6865 636b 2069 6e70 7574 2070 6172   Check input par
+00005790: 616d 6574 6572 730a 2020 2020 7061 7468  ameters.    path
+000057a0: 203d 2050 6174 6828 7061 7468 290a 2020   = Path(path).  
+000057b0: 2020 6966 206c 6179 6572 2069 7320 4e6f    if layer is No
+000057c0: 6e65 3a0a 2020 2020 2020 2020 6c61 7965  ne:.        laye
+000057d0: 7220 3d20 6765 745f 6f6e 6c79 5f6c 6179  r = get_only_lay
+000057e0: 6572 2870 6174 6829 0a0a 2020 2020 2320  er(path)..    # 
+000057f0: 4e6f 7720 7265 616c 6c79 2072 656e 616d  Now really renam
+00005800: 650a 2020 2020 6461 7461 736f 7572 6365  e.    datasource
+00005810: 203d 204e 6f6e 650a 2020 2020 6765 6f66   = None.    geof
+00005820: 696c 6574 7970 6520 3d20 4765 6f66 696c  iletype = Geofil
+00005830: 6554 7970 6528 7061 7468 290a 2020 2020  eType(path).    
+00005840: 6966 2067 656f 6669 6c65 7479 7065 2e69  if geofiletype.i
+00005850: 735f 7370 6174 6961 6c69 7465 5f62 6173  s_spatialite_bas
+00005860: 6564 3a0a 2020 2020 2020 2020 7472 793a  ed:.        try:
+00005870: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+00005880: 6173 6f75 7263 6520 3d20 6764 616c 2e4f  asource = gdal.O
+00005890: 7065 6e45 7828 7374 7228 7061 7468 292c  penEx(str(path),
+000058a0: 206e 4f70 656e 466c 6167 733d 6764 616c   nOpenFlags=gdal
+000058b0: 2e4f 465f 5550 4441 5445 290a 2020 2020  .OF_UPDATE).    
+000058c0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+000058d0: 203d 2066 2741 4c54 4552 2054 4142 4c45   = f'ALTER TABLE
+000058e0: 2022 7b6c 6179 6572 7d22 2052 454e 414d   "{layer}" RENAM
+000058f0: 4520 544f 2022 7b6e 6577 5f6c 6179 6572  E TO "{new_layer
+00005900: 7d22 270a 2020 2020 2020 2020 2020 2020  }"'.            
+00005910: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
+00005920: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
+00005930: 716c 5f73 746d 7429 0a20 2020 2020 2020  ql_stmt).       
+00005940: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
+00005950: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
+00005960: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+00005970: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00005980: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
+00005990: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
+000059a0: 6622 7265 6e61 6d65 5f6c 6179 6572 2065  f"rename_layer e
+000059b0: 7272 6f72 2066 6f72 207b 7061 7468 7d2e  rror for {path}.
+000059c0: 7b6c 6179 6572 7d3a 5c6e 2020 7b65 787d  {layer}:\n  {ex}
+000059d0: 222c 290a 2020 2020 2020 2020 2020 2020  ",).            
+000059e0: 7261 6973 650a 2020 2020 2020 2020 6669  raise.        fi
+000059f0: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+00005a00: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+00005a10: 4e6f 6e65 0a20 2020 2065 6c69 6620 6765  None.    elif ge
+00005a20: 6f66 696c 6574 7970 6520 3d3d 2047 656f  ofiletype == Geo
+00005a30: 6669 6c65 5479 7065 2e45 5352 4953 6861  fileType.ESRISha
+00005a40: 7065 6669 6c65 3a0a 2020 2020 2020 2020  pefile:.        
+00005a50: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00005a60: 2866 2272 656e 616d 655f 6c61 7965 7220  (f"rename_layer 
+00005a70: 6e6f 7420 706f 7373 6962 6c65 2066 6f72  not possible for
+00005a80: 207b 6765 6f66 696c 6574 7970 657d 2066   {geofiletype} f
+00005a90: 696c 6522 290a 2020 2020 656c 7365 3a0a  ile").    else:.
+00005aa0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00005ab0: 6c75 6545 7272 6f72 2866 2272 656e 616d  lueError(f"renam
+00005ac0: 655f 6c61 7965 7220 6e6f 7420 696d 706c  e_layer not impl
+00005ad0: 656d 656e 7465 6420 666f 7220 7b70 6174  emented for {pat
+00005ae0: 682e 7375 6666 6978 7d20 6669 6c65 2229  h.suffix} file")
+00005af0: 0a0a 0a64 6566 2072 656e 616d 655f 636f  ...def rename_co
+00005b00: 6c75 6d6e 280a 2020 2020 7061 7468 3a20  lumn(.    path: 
+00005b10: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+00005b20: 6174 684c 696b 655b 416e 795d 225d 2c0a  athLike[Any]"],.
+00005b30: 2020 2020 636f 6c75 6d6e 5f6e 616d 653a      column_name:
+00005b40: 2073 7472 2c0a 2020 2020 6e65 775f 636f   str,.    new_co
+00005b50: 6c75 6d6e 5f6e 616d 653a 2073 7472 2c0a  lumn_name: str,.
+00005b60: 2020 2020 6c61 7965 723a 204f 7074 696f      layer: Optio
+00005b70: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00005b80: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+00005b90: 5265 6e61 6d65 2074 6865 2063 6f6c 756d  Rename the colum
+00005ba0: 6e20 7370 6563 6966 6965 642e 0a0a 2020  n specified...  
+00005bb0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00005bc0: 7061 7468 2028 5061 7468 4c69 6b65 293a  path (PathLike):
+00005bd0: 2054 6865 2066 696c 6520 7061 7468 2e0a   The file path..
+00005be0: 2020 2020 2020 2020 636f 6c75 6d6e 5f6e          column_n
+00005bf0: 616d 6520 2873 7472 293a 2074 6865 2063  ame (str): the c
+00005c00: 7572 7265 6e74 2063 6f6c 756d 6e20 6e61  urrent column na
+00005c10: 6d65 2e0a 2020 2020 2020 2020 6e65 775f  me..        new_
+00005c20: 636f 6c75 6d6e 5f6e 616d 6520 2873 7472  column_name (str
+00005c30: 293a 2074 6865 206e 6577 2063 6f6c 756d  ): the new colum
+00005c40: 6e20 6e61 6d65 2e0a 2020 2020 2020 2020  n name..        
+00005c50: 6c61 7965 7220 284f 7074 696f 6e61 6c5b  layer (Optional[
+00005c60: 7374 725d 293a 2054 6865 206c 6179 6572  str]): The layer
+00005c70: 206e 616d 652e 2049 6620 6e6f 7420 7370   name. If not sp
+00005c80: 6563 6966 6965 642c 2061 6e64 2074 6865  ecified, and the
+00005c90: 7265 2069 7320 6f6e 6c79 0a20 2020 2020  re is only.     
+00005ca0: 2020 2020 2020 206f 6e65 206c 6179 6572         one layer
+00005cb0: 2069 6e20 7468 6520 6669 6c65 2c20 7468   in the file, th
+00005cc0: 6973 206c 6179 6572 2069 7320 7573 6564  is layer is used
+00005cd0: 2e20 4f74 6865 7277 6973 6520 6578 6365  . Otherwise exce
+00005ce0: 7074 696f 6e2e 0a20 2020 2022 2222 0a20  ption..    """. 
+00005cf0: 2020 2023 2043 6865 636b 2069 6e70 7574     # Check input
+00005d00: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
+00005d10: 7061 7468 203d 2050 6174 6828 7061 7468  path = Path(path
+00005d20: 290a 2020 2020 6966 206c 6179 6572 2069  ).    if layer i
+00005d30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00005d40: 6c61 7965 7220 3d20 6765 745f 6f6e 6c79  layer = get_only
+00005d50: 5f6c 6179 6572 2870 6174 6829 0a20 2020  _layer(path).   
+00005d60: 2069 6e66 6f20 3d20 6765 745f 6c61 7965   info = get_laye
+00005d70: 7269 6e66 6f28 7061 7468 2c20 6c61 7965  rinfo(path, laye
+00005d80: 7229 0a20 2020 2069 6620 636f 6c75 6d6e  r).    if column
+00005d90: 5f6e 616d 6520 6e6f 7420 696e 2069 6e66  _name not in inf
+00005da0: 6f2e 636f 6c75 6d6e 7320 616e 6420 6e65  o.columns and ne
+00005db0: 775f 636f 6c75 6d6e 5f6e 616d 6520 696e  w_column_name in
+00005dc0: 2069 6e66 6f2e 636f 6c75 6d6e 733a 0a20   info.columns:. 
+00005dd0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00005de0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00005df0: 6622 436f 6c75 6d6e 207b 636f 6c75 6d6e  f"Column {column
+00005e00: 5f6e 616d 657d 2073 6565 6d73 2074 6f20  _name} seems to 
+00005e10: 6265 2072 656e 616d 6564 2061 6c72 6561  be renamed alrea
+00005e20: 6479 2074 6f20 7b6e 6577 5f63 6f6c 756d  dy to {new_colum
+00005e30: 6e5f 6e61 6d65 7d22 0a20 2020 2020 2020  n_name}".       
+00005e40: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+00005e50: 6e0a 0a20 2020 2023 204e 6f77 2072 6561  n..    # Now rea
+00005e60: 6c6c 7920 7265 6e61 6d65 0a20 2020 2064  lly rename.    d
+00005e70: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+00005e80: 0a20 2020 2067 656f 6669 6c65 7479 7065  .    geofiletype
+00005e90: 203d 2047 656f 6669 6c65 5479 7065 2870   = GeofileType(p
+00005ea0: 6174 6829 0a20 2020 2069 6620 6765 6f66  ath).    if geof
+00005eb0: 696c 6574 7970 652e 6973 5f73 7061 7469  iletype.is_spati
+00005ec0: 616c 6974 655f 6261 7365 643a 0a20 2020  alite_based:.   
+00005ed0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00005ee0: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00005ef0: 203d 2067 6461 6c2e 4f70 656e 4578 2873   = gdal.OpenEx(s
+00005f00: 7472 2870 6174 6829 2c20 6e4f 7065 6e46  tr(path), nOpenF
+00005f10: 6c61 6773 3d67 6461 6c2e 4f46 5f55 5044  lags=gdal.OF_UPD
+00005f20: 4154 4529 0a20 2020 2020 2020 2020 2020  ATE).           
+00005f30: 2073 716c 5f73 746d 7420 3d20 280a 2020   sql_stmt = (.  
+00005f40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00005f50: 414c 5445 5220 5441 424c 4520 227b 6c61  ALTER TABLE "{la
+00005f60: 7965 727d 2220 270a 2020 2020 2020 2020  yer}" '.        
+00005f70: 2020 2020 2020 2020 6627 5245 4e41 4d45          f'RENAME
+00005f80: 2043 4f4c 554d 4e20 227b 636f 6c75 6d6e   COLUMN "{column
+00005f90: 5f6e 616d 657d 2220 544f 2022 7b6e 6577  _name}" TO "{new
+00005fa0: 5f63 6f6c 756d 6e5f 6e61 6d65 7d22 270a  _column_name}"'.
+00005fb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00005fc0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00005fd0: 203d 2064 6174 6173 6f75 7263 652e 4578   = datasource.Ex
+00005fe0: 6563 7574 6553 514c 2873 716c 5f73 746d  ecuteSQL(sql_stm
+00005ff0: 7429 0a20 2020 2020 2020 2020 2020 2064  t).            d
+00006000: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
+00006010: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
+00006020: 7429 0a20 2020 2020 2020 2065 7863 6570  t).        excep
+00006030: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00006040: 783a 0a20 2020 2020 2020 2020 2020 2065  x:.            e
+00006050: 782e 6172 6773 203d 2028 6622 7265 6e61  x.args = (f"rena
+00006060: 6d65 5f63 6f6c 756d 6e20 6572 726f 7220  me_column error 
+00006070: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
+00006080: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
+00006090: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000060a0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+000060b0: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
+000060c0: 7461 736f 7572 6365 203d 204e 6f6e 650a  tasource = None.
+000060d0: 0a20 2020 2065 6c69 6620 6765 6f66 696c  .    elif geofil
+000060e0: 6574 7970 6520 3d3d 2047 656f 6669 6c65  etype == Geofile
+000060f0: 5479 7065 2e45 5352 4953 6861 7065 6669  Type.ESRIShapefi
+00006100: 6c65 3a0a 2020 2020 2020 2020 7261 6973  le:.        rais
+00006110: 6520 5661 6c75 6545 7272 6f72 2866 2272  e ValueError(f"r
+00006120: 656e 616d 655f 636f 6c75 6d6e 2069 7320  ename_column is 
+00006130: 6e6f 7420 706f 7373 6962 6c65 2066 6f72  not possible for
+00006140: 207b 6765 6f66 696c 6574 7970 657d 2066   {geofiletype} f
+00006150: 696c 6522 290a 2020 2020 656c 7365 3a0a  ile").    else:.
+00006160: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00006170: 6c75 6545 7272 6f72 2866 2272 656e 616d  lueError(f"renam
+00006180: 655f 636f 6c75 6d6e 2069 7320 6e6f 7420  e_column is not 
+00006190: 696d 706c 656d 656e 7465 6420 666f 7220  implemented for 
+000061a0: 7b70 6174 682e 7375 6666 6978 7d20 6669  {path.suffix} fi
+000061b0: 6c65 2229 0a0a 0a63 6c61 7373 2044 6174  le")...class Dat
+000061c0: 6154 7970 6528 656e 756d 2e45 6e75 6d29  aType(enum.Enum)
+000061d0: 3a0a 2020 2020 2222 220a 2020 2020 5468  :.    """.    Th
+000061e0: 6973 2065 6e75 6d20 6465 6669 6e65 7320  is enum defines 
+000061f0: 7468 6520 7374 616e 6461 7264 2064 6174  the standard dat
+00006200: 6120 7479 7065 7320 7468 6174 2063 616e  a types that can
+00006210: 2062 6520 7573 6564 2066 6f72 2063 6f6c   be used for col
+00006220: 756d 6e73 2e0a 2020 2020 2222 220a 0a20  umns..    """.. 
+00006230: 2020 2054 4558 5420 3d20 2254 4558 5422     TEXT = "TEXT"
+00006240: 0a20 2020 2022 2222 436f 6c75 6d6e 2077  .    """Column w
+00006250: 6974 6820 7465 7874 2064 6174 613a 207e  ith text data: ~
+00006260: 2073 7472 696e 672c 2063 6861 722c 2076   string, char, v
+00006270: 6172 6368 6172 2c20 636c 6f62 2e22 2222  archar, clob."""
+00006280: 0a20 2020 2049 4e54 4547 4552 203d 2022  .    INTEGER = "
+00006290: 494e 5445 4745 5222 0a20 2020 2022 2222  INTEGER".    """
+000062a0: 436f 6c75 6d6e 2077 6974 6820 696e 7465  Column with inte
+000062b0: 6765 7220 6461 7461 2e22 2222 0a20 2020  ger data.""".   
+000062c0: 2052 4541 4c20 3d20 2252 4541 4c22 0a20   REAL = "REAL". 
+000062d0: 2020 2022 2222 436f 6c75 6d6e 2077 6974     """Column wit
+000062e0: 6820 666c 6f61 7469 6e67 2070 6f69 6e74  h floating point
+000062f0: 2064 6174 613a 207e 2066 6c6f 6174 2c20   data: ~ float, 
+00006300: 646f 7562 6c65 2e22 2222 0a20 2020 2044  double.""".    D
+00006310: 4154 4520 3d20 2244 4154 4522 0a20 2020  ATE = "DATE".   
+00006320: 2022 2222 436f 6c75 6d6e 2077 6974 6820   """Column with 
+00006330: 6461 7465 2064 6174 612e 2222 220a 2020  date data.""".  
+00006340: 2020 5449 4d45 5354 414d 5020 3d20 2254    TIMESTAMP = "T
+00006350: 494d 4553 5441 4d50 220a 2020 2020 2222  IMESTAMP".    ""
+00006360: 2243 6f6c 756d 6e20 7769 7468 2074 696d  "Column with tim
+00006370: 6573 7461 6d70 2064 6174 613a 207e 2064  estamp data: ~ d
+00006380: 6174 6574 696d 652e 2222 220a 2020 2020  atetime.""".    
+00006390: 424f 4f4c 4541 4e20 3d20 2242 4f4f 4c45  BOOLEAN = "BOOLE
+000063a0: 414e 220a 2020 2020 2222 2243 6f6c 756d  AN".    """Colum
+000063b0: 6e20 7769 7468 2062 6f6f 6c65 616e 2064  n with boolean d
+000063c0: 6174 612e 2222 220a 2020 2020 424c 4f42  ata.""".    BLOB
+000063d0: 203d 2022 424c 4f42 220a 2020 2020 2222   = "BLOB".    ""
+000063e0: 2243 6f6c 756d 6e20 7769 7468 2062 696e  "Column with bin
+000063f0: 6172 7920 6461 7461 2e22 2222 0a20 2020  ary data.""".   
+00006400: 204e 554d 4552 4943 203d 2022 4e55 4d45   NUMERIC = "NUME
+00006410: 5249 4322 0a20 2020 2022 2222 436f 6c75  RIC".    """Colu
+00006420: 6d6e 2077 6974 6820 6e75 6d65 7269 6320  mn with numeric 
+00006430: 6461 7461 3a20 6578 6163 7420 6465 6369  data: exact deci
+00006440: 6d61 6c20 6461 7461 2e22 2222 0a0a 0a64  mal data."""...d
+00006450: 6566 2061 6464 5f63 6f6c 756d 6e28 0a20  ef add_column(. 
+00006460: 2020 2070 6174 683a 2055 6e69 6f6e 5b73     path: Union[s
+00006470: 7472 2c20 226f 732e 5061 7468 4c69 6b65  tr, "os.PathLike
+00006480: 5b41 6e79 5d22 5d2c 0a20 2020 206e 616d  [Any]"],.    nam
+00006490: 653a 2073 7472 2c0a 2020 2020 7479 7065  e: str,.    type
+000064a0: 3a20 556e 696f 6e5b 4461 7461 5479 7065  : Union[DataType
+000064b0: 2c20 7374 725d 2c0a 2020 2020 6578 7072  , str],.    expr
+000064c0: 6573 7369 6f6e 3a20 556e 696f 6e5b 7374  ession: Union[st
+000064d0: 722c 2069 6e74 2c20 666c 6f61 742c 204e  r, int, float, N
+000064e0: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
+000064f0: 2065 7870 7265 7373 696f 6e5f 6469 616c   expression_dial
+00006500: 6563 743a 204f 7074 696f 6e61 6c5b 7374  ect: Optional[st
+00006510: 725d 203d 204e 6f6e 652c 0a20 2020 206c  r] = None,.    l
+00006520: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00006530: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+00006540: 666f 7263 655f 7570 6461 7465 3a20 626f  force_update: bo
+00006550: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00006560: 7769 6474 683a 204f 7074 696f 6e61 6c5b  width: Optional[
+00006570: 696e 745d 203d 204e 6f6e 652c 0a29 3a0a  int] = None,.):.
+00006580: 2020 2020 2222 220a 2020 2020 4164 6420      """.    Add 
+00006590: 6120 636f 6c75 6d6e 2074 6f20 6120 6c61  a column to a la
+000065a0: 7965 7220 6f66 2074 6865 2067 656f 6669  yer of the geofi
+000065b0: 6c65 2e0a 0a20 2020 2041 7267 733a 0a20  le...    Args:. 
+000065c0: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+000065d0: 684c 696b 6529 3a20 5061 7468 2074 6f20  hLike): Path to 
+000065e0: 7468 6520 6765 6f66 696c 652e 0a20 2020  the geofile..   
+000065f0: 2020 2020 206e 616d 6520 2873 7472 293a       name (str):
+00006600: 204e 616d 6520 666f 7220 7468 6520 6e65   Name for the ne
+00006610: 7720 636f 6c75 6d6e 2e0a 2020 2020 2020  w column..      
+00006620: 2020 7479 7065 2028 7374 7229 3a20 436f    type (str): Co
+00006630: 6c75 6d6e 2074 7970 6520 6f66 2074 6865  lumn type of the
+00006640: 206e 6577 2063 6f6c 756d 6e2e 0a20 2020   new column..   
+00006650: 2020 2020 2065 7870 7265 7373 696f 6e20       expression 
+00006660: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
+00006670: 2053 514c 6974 6520 6578 7072 6573 7369   SQLite expressi
+00006680: 6f6e 2074 6f20 7573 6520 746f 2075 7064  on to use to upd
+00006690: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+000066a0: 7468 6520 7661 6c75 652e 2044 6566 6175  the value. Defau
+000066b0: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
+000066c0: 2020 2020 2065 7870 7265 7373 696f 6e5f       expression_
+000066d0: 6469 616c 6563 7420 2873 7472 2c20 6f70  dialect (str, op
+000066e0: 7469 6f6e 616c 293a 2053 514c 2064 6961  tional): SQL dia
+000066f0: 6c65 6374 2075 7365 6420 666f 7220 7468  lect used for th
+00006700: 6520 6578 7072 6573 7369 6f6e 2e0a 2020  e expression..  
+00006710: 2020 2020 2020 6c61 7965 7220 2873 7472        layer (str
+00006720: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
+00006730: 206c 6179 6572 206e 616d 652e 2049 6620   layer name. If 
+00006740: 4e6f 6e65 2061 6e64 2074 6865 2067 656f  None and the geo
+00006750: 6669 6c65 0a20 2020 2020 2020 2020 2020  file.           
+00006760: 2068 6173 206f 6e6c 7920 6f6e 6520 6c61   has only one la
+00006770: 7965 722c 2074 6861 7420 6c61 7965 7220  yer, that layer 
+00006780: 6973 2075 7365 642e 2044 6566 6175 6c74  is used. Default
+00006790: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+000067a0: 2020 2066 6f72 6365 5f75 7064 6174 6520     force_update 
+000067b0: 2862 6f6f 6c2c 206f 7074 696f 6e61 6c29  (bool, optional)
+000067c0: 3a20 4966 2074 6865 2063 6f6c 756d 6e20  : If the column 
+000067d0: 616c 7265 6164 7920 6578 6973 7473 2c20  already exists, 
+000067e0: 6578 6563 7574 650a 2020 2020 2020 2020  execute.        
+000067f0: 2020 2020 7468 6520 7570 6461 7465 2061      the update a
+00006800: 6e79 7761 792e 2044 6566 6175 6c74 7320  nyway. Defaults 
+00006810: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
+00006820: 2020 7769 6474 6820 2869 6e74 2c20 6f70    width (int, op
+00006830: 7469 6f6e 616c 293a 2074 6865 2077 6964  tional): the wid
+00006840: 7468 206f 6620 7468 6520 6669 656c 642e  th of the field.
+00006850: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+00006860: 2020 2020 2020 6578 3a20 5b64 6573 6372        ex: [descr
+00006870: 6970 7469 6f6e 5d0a 2020 2020 2222 220a  iption].    """.
+00006880: 2020 2020 2320 496e 6974 0a20 2020 2069      # Init.    i
+00006890: 6620 6973 696e 7374 616e 6365 2874 7970  f isinstance(typ
+000068a0: 652c 2044 6174 6154 7970 6529 3a0a 2020  e, DataType):.  
+000068b0: 2020 2020 2020 7479 7065 5f73 7472 203d        type_str =
+000068c0: 2074 7970 652e 7661 6c75 650a 2020 2020   type.value.    
+000068d0: 656c 7365 3a0a 2020 2020 2020 2020 7479  else:.        ty
+000068e0: 7065 5f6c 6f77 6572 203d 2074 7970 652e  pe_lower = type.
+000068f0: 6c6f 7765 7228 290a 2020 2020 2020 2020  lower().        
+00006900: 6966 2074 7970 655f 6c6f 7765 7220 3d3d  if type_lower ==
+00006910: 2022 7374 7269 6e67 223a 0a20 2020 2020   "string":.     
+00006920: 2020 2020 2020 2023 2054 4f44 4f3a 2074         # TODO: t
+00006930: 6869 6e6b 2077 6865 7468 6572 2062 6569  hink whether bei
+00006940: 6e67 2066 6c65 7869 626c 6520 6865 7265  ng flexible here
+00006950: 2069 7320 6120 676f 6f64 2069 6465 612e   is a good idea.
+00006960: 2e2e 0a20 2020 2020 2020 2020 2020 2074  ...            t
+00006970: 7970 655f 7374 7220 3d20 2254 4558 5422  ype_str = "TEXT"
+00006980: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
+00006990: 7065 5f6c 6f77 6572 203d 3d20 2262 696e  pe_lower == "bin
+000069a0: 6172 7922 3a0a 2020 2020 2020 2020 2020  ary":.          
+000069b0: 2020 7479 7065 5f73 7472 203d 2022 424c    type_str = "BL
+000069c0: 4f42 220a 2020 2020 2020 2020 656c 6966  OB".        elif
+000069d0: 2074 7970 655f 6c6f 7765 7220 3d3d 2022   type_lower == "
+000069e0: 7469 6d65 223a 0a20 2020 2020 2020 2020  time":.         
+000069f0: 2020 2074 7970 655f 7374 7220 3d20 2244     type_str = "D
+00006a00: 4154 4554 494d 4522 0a20 2020 2020 2020  ATETIME".       
+00006a10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00006a20: 2020 2074 7970 655f 7374 7220 3d20 7479     type_str = ty
+00006a30: 7065 0a20 2020 2070 6174 6820 3d20 5061  pe.    path = Pa
+00006a40: 7468 2870 6174 6829 0a20 2020 2069 6620  th(path).    if 
+00006a50: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
+00006a60: 2020 2020 2020 206c 6179 6572 203d 2067         layer = g
+00006a70: 6574 5f6f 6e6c 795f 6c61 7965 7228 7061  et_only_layer(pa
+00006a80: 7468 290a 2020 2020 6c61 7965 7269 6e66  th).    layerinf
+00006a90: 6f5f 6f72 6967 203d 2067 6574 5f6c 6179  o_orig = get_lay
+00006aa0: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
+00006ab0: 6572 290a 0a20 2020 2023 2047 6f21 0a20  er)..    # Go!. 
+00006ac0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+00006ad0: 4e6f 6e65 0a20 2020 2074 7279 3a0a 2020  None.    try:.  
+00006ae0: 2020 2020 2020 2320 4966 2063 6f6c 756d        # If colum
+00006af0: 6e20 646f 6573 6e27 7420 6578 6973 7420  n doesn't exist 
+00006b00: 7965 742c 2063 7265 6174 6520 6974 0a20  yet, create it. 
+00006b10: 2020 2020 2020 2063 6f6c 756d 6e73 5f75         columns_u
+00006b20: 7070 6572 203d 205b 636f 6c75 6d6e 2e75  pper = [column.u
+00006b30: 7070 6572 2829 2066 6f72 2063 6f6c 756d  pper() for colum
+00006b40: 6e20 696e 206c 6179 6572 696e 666f 5f6f  n in layerinfo_o
+00006b50: 7269 672e 636f 6c75 6d6e 735d 0a20 2020  rig.columns].   
+00006b60: 2020 2020 2069 6620 6e61 6d65 2e75 7070       if name.upp
+00006b70: 6572 2829 206e 6f74 2069 6e20 636f 6c75  er() not in colu
+00006b80: 6d6e 735f 7570 7065 723a 0a20 2020 2020  mns_upper:.     
+00006b90: 2020 2020 2020 2077 6964 7468 5f73 7472         width_str
+00006ba0: 203d 2066 2228 7b77 6964 7468 7d29 2220   = f"({width})" 
+00006bb0: 6966 2077 6964 7468 2069 7320 6e6f 7420  if width is not 
+00006bc0: 4e6f 6e65 2065 6c73 6520 2222 0a20 2020  None else "".   
+00006bd0: 2020 2020 2020 2020 2073 716c 5f73 746d           sql_stm
+00006be0: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+00006bf0: 2020 2020 2020 6627 414c 5445 5220 5441        f'ALTER TA
+00006c00: 424c 4520 227b 6c61 7965 727d 2220 4144  BLE "{layer}" AD
+00006c10: 4420 434f 4c55 4d4e 2022 7b6e 616d 657d  D COLUMN "{name}
+00006c20: 2220 7b74 7970 655f 7374 727d 7b77 6964  " {type_str}{wid
+00006c30: 7468 5f73 7472 7d27 0a20 2020 2020 2020  th_str}'.       
+00006c40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00006c50: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+00006c60: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
+00006c70: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
+00006c80: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
+00006c90: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00006ca0: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
+00006cb0: 652e 4578 6563 7574 6553 514c 2873 716c  e.ExecuteSQL(sql
+00006cc0: 5f73 746d 7429 0a20 2020 2020 2020 2020  _stmt).         
+00006cd0: 2020 2064 6174 6173 6f75 7263 652e 5265     datasource.Re
+00006ce0: 6c65 6173 6552 6573 756c 7453 6574 2872  leaseResultSet(r
+00006cf0: 6573 756c 7429 0a20 2020 2020 2020 2065  esult).        e
+00006d00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00006d10: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00006d20: 6622 436f 6c75 6d6e 207b 6e61 6d65 7d20  f"Column {name} 
+00006d30: 6578 6973 7465 6420 616c 7265 6164 7920  existed already 
+00006d40: 696e 207b 7061 7468 7d2c 206c 6179 6572  in {path}, layer
+00006d50: 207b 6c61 7965 727d 2229 0a0a 2020 2020   {layer}")..    
+00006d60: 2020 2020 2320 4966 2061 6e20 6578 7072      # If an expr
+00006d70: 6573 7369 6f6e 2077 6173 2070 726f 7669  ession was provi
+00006d80: 6465 6420 616e 6420 7570 6461 7465 2063  ded and update c
+00006d90: 616e 2062 6520 646f 6e65 2c20 676f 2066  an be done, go f
+00006da0: 6f72 2069 742e 2e2e 0a20 2020 2020 2020  or it....       
+00006db0: 2069 6620 6578 7072 6573 7369 6f6e 2069   if expression i
+00006dc0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2028  s not None and (
+00006dd0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00006de0: 6520 6e6f 7420 696e 206c 6179 6572 696e  e not in layerin
+00006df0: 666f 5f6f 7269 672e 636f 6c75 6d6e 7320  fo_orig.columns 
+00006e00: 6f72 2066 6f72 6365 5f75 7064 6174 6520  or force_update 
+00006e10: 6973 2054 7275 650a 2020 2020 2020 2020  is True.        
+00006e20: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00006e30: 6620 6461 7461 736f 7572 6365 2069 7320  f datasource is 
+00006e40: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00006e50: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00006e60: 203d 2067 6461 6c2e 4f70 656e 4578 2873   = gdal.OpenEx(s
+00006e70: 7472 2870 6174 6829 2c20 6e4f 7065 6e46  tr(path), nOpenF
+00006e80: 6c61 6773 3d67 6461 6c2e 4f46 5f55 5044  lags=gdal.OF_UPD
+00006e90: 4154 4529 0a20 2020 2020 2020 2020 2020  ATE).           
+00006ea0: 2073 716c 5f73 746d 7420 3d20 6627 5550   sql_stmt = f'UP
+00006eb0: 4441 5445 2022 7b6c 6179 6572 7d22 2053  DATE "{layer}" S
+00006ec0: 4554 2022 7b6e 616d 657d 2220 3d20 7b65  ET "{name}" = {e
+00006ed0: 7870 7265 7373 696f 6e7d 270a 2020 2020  xpression}'.    
+00006ee0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00006ef0: 2064 6174 6173 6f75 7263 652e 4578 6563   datasource.Exec
+00006f00: 7574 6553 514c 2873 716c 5f73 746d 742c  uteSQL(sql_stmt,
+00006f10: 2064 6961 6c65 6374 3d65 7870 7265 7373   dialect=express
+00006f20: 696f 6e5f 6469 616c 6563 7429 0a20 2020  ion_dialect).   
+00006f30: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
+00006f40: 7263 652e 5265 6c65 6173 6552 6573 756c  rce.ReleaseResul
+00006f50: 7453 6574 2872 6573 756c 7429 0a0a 2020  tSet(result)..  
+00006f60: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00006f70: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+00006f80: 2020 6578 2e61 7267 7320 3d20 2866 2261    ex.args = (f"a
+00006f90: 6464 5f63 6f6c 756d 6e20 6572 726f 7220  dd_column error 
+00006fa0: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
+00006fb0: 727d 3a5c 6e20 207b 6578 7d22 2c29 0a20  r}:\n  {ex}",). 
+00006fc0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+00006fd0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+00006fe0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00006ff0: 6f6e 650a 0a0a 6465 6620 6472 6f70 5f63  one...def drop_c
+00007000: 6f6c 756d 6e28 0a20 2020 2070 6174 683a  olumn(.    path:
+00007010: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
+00007020: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
+00007030: 2063 6f6c 756d 6e5f 6e61 6d65 3a20 7374   column_name: st
+00007040: 722c 206c 6179 6572 3a20 4f70 7469 6f6e  r, layer: Option
+00007050: 616c 5b73 7472 5d20 3d20 4e6f 6e65 0a29  al[str] = None.)
+00007060: 3a0a 2020 2020 2222 220a 2020 2020 4472  :.    """.    Dr
+00007070: 6f70 2074 6865 2063 6f6c 756d 6e20 7370  op the column sp
+00007080: 6563 6966 6965 642e 0a0a 2020 2020 4172  ecified...    Ar
+00007090: 6773 3a0a 2020 2020 2020 2020 7061 7468  gs:.        path
+000070a0: 2028 5061 7468 4c69 6b65 293a 2054 6865   (PathLike): The
+000070b0: 2066 696c 6520 7061 7468 2e0a 2020 2020   file path..    
+000070c0: 2020 2020 636f 6c75 6d6e 5f6e 616d 6520      column_name 
+000070d0: 2873 7472 293a 2074 6865 2063 6f6c 756d  (str): the colum
+000070e0: 6e20 6e61 6d65 2e0a 2020 2020 2020 2020  n name..        
+000070f0: 6c61 7965 7220 284f 7074 696f 6e61 6c5b  layer (Optional[
+00007100: 7374 725d 293a 2054 6865 206c 6179 6572  str]): The layer
+00007110: 206e 616d 652e 2049 6620 6e6f 7420 7370   name. If not sp
+00007120: 6563 6966 6965 642c 2061 6e64 2074 6865  ecified, and the
+00007130: 7265 2069 7320 6f6e 6c79 0a20 2020 2020  re is only.     
+00007140: 2020 2020 2020 206f 6e65 206c 6179 6572         one layer
+00007150: 2069 6e20 7468 6520 6669 6c65 2c20 7468   in the file, th
+00007160: 6973 206c 6179 6572 2069 7320 7573 6564  is layer is used
+00007170: 2e20 4f74 6865 7277 6973 6520 6120 5661  . Otherwise a Va
+00007180: 6c75 6545 7272 6f72 2069 730a 2020 2020  lueError is.    
+00007190: 2020 2020 2020 2020 7261 6973 6564 2e0a          raised..
+000071a0: 2020 2020 2222 220a 2020 2020 2320 4368      """.    # Ch
+000071b0: 6563 6b20 696e 7075 7420 7061 7261 6d65  eck input parame
+000071c0: 7465 7273 0a20 2020 2070 6174 6820 3d20  ters.    path = 
+000071d0: 5061 7468 2870 6174 6829 0a20 2020 2069  Path(path).    i
+000071e0: 6620 6c61 7965 7220 6973 204e 6f6e 653a  f layer is None:
+000071f0: 0a20 2020 2020 2020 206c 6179 6572 203d  .        layer =
+00007200: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
+00007210: 7061 7468 290a 2020 2020 696e 666f 203d  path).    info =
+00007220: 2067 6574 5f6c 6179 6572 696e 666f 2870   get_layerinfo(p
+00007230: 6174 682c 206c 6179 6572 290a 2020 2020  ath, layer).    
+00007240: 6966 2063 6f6c 756d 6e5f 6e61 6d65 206e  if column_name n
+00007250: 6f74 2069 6e20 696e 666f 2e63 6f6c 756d  ot in info.colum
+00007260: 6e73 3a0a 2020 2020 2020 2020 6c6f 6767  ns:.        logg
+00007270: 6572 2e69 6e66 6f28 6622 436f 6c75 6d6e  er.info(f"Column
+00007280: 207b 636f 6c75 6d6e 5f6e 616d 657d 206e   {column_name} n
+00007290: 6f74 2070 7265 7365 6e74 2073 6f20 6361  ot present so ca
+000072a0: 6e6e 6f74 2062 6520 6472 6f70 7065 642e  nnot be dropped.
+000072b0: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+000072c0: 6e0a 0a20 2020 2023 204e 6f77 2072 6561  n..    # Now rea
+000072d0: 6c6c 7920 7265 6e61 6d65 0a20 2020 2064  lly rename.    d
+000072e0: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+000072f0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00007300: 2020 6461 7461 736f 7572 6365 203d 2067    datasource = g
+00007310: 6461 6c2e 4f70 656e 4578 2873 7472 2870  dal.OpenEx(str(p
+00007320: 6174 6829 2c20 6e4f 7065 6e46 6c61 6773  ath), nOpenFlags
+00007330: 3d67 6461 6c2e 4f46 5f55 5044 4154 4529  =gdal.OF_UPDATE)
+00007340: 0a20 2020 2020 2020 2073 716c 5f73 746d  .        sql_stm
+00007350: 7420 3d20 6627 414c 5445 5220 5441 424c  t = f'ALTER TABL
+00007360: 4520 227b 6c61 7965 727d 2220 4452 4f50  E "{layer}" DROP
+00007370: 2043 4f4c 554d 4e20 227b 636f 6c75 6d6e   COLUMN "{column
+00007380: 5f6e 616d 657d 2227 0a20 2020 2020 2020  _name}"'.       
+00007390: 2072 6573 756c 7420 3d20 6461 7461 736f   result = dataso
+000073a0: 7572 6365 2e45 7865 6375 7465 5351 4c28  urce.ExecuteSQL(
+000073b0: 7371 6c5f 7374 6d74 290a 2020 2020 2020  sql_stmt).      
+000073c0: 2020 6461 7461 736f 7572 6365 2e52 656c    datasource.Rel
+000073d0: 6561 7365 5265 7375 6c74 5365 7428 7265  easeResultSet(re
+000073e0: 7375 6c74 290a 0a20 2020 2065 7863 6570  sult)..    excep
+000073f0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00007400: 783a 0a20 2020 2020 2020 2065 782e 6172  x:.        ex.ar
+00007410: 6773 203d 2028 6622 6472 6f70 5f63 6f6c  gs = (f"drop_col
+00007420: 756d 6e20 6572 726f 7220 666f 7220 7b70  umn error for {p
+00007430: 6174 687d 2e7b 6c61 7965 727d 3a5c 6e20  ath}.{layer}:\n 
+00007440: 207b 6578 7d22 2c29 0a20 2020 2020 2020   {ex}",).       
+00007450: 2072 6169 7365 0a20 2020 2066 696e 616c   raise.    final
+00007460: 6c79 3a0a 2020 2020 2020 2020 6461 7461  ly:.        data
+00007470: 736f 7572 6365 203d 204e 6f6e 650a 0a0a  source = None...
+00007480: 6465 6620 7570 6461 7465 5f63 6f6c 756d  def update_colum
+00007490: 6e28 0a20 2020 2070 6174 683a 2055 6e69  n(.    path: Uni
+000074a0: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
+000074b0: 4c69 6b65 5b41 6e79 5d22 5d2c 0a20 2020  Like[Any]"],.   
+000074c0: 206e 616d 653a 2073 7472 2c0a 2020 2020   name: str,.    
+000074d0: 6578 7072 6573 7369 6f6e 3a20 7374 722c  expression: str,
+000074e0: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
+000074f0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00007500: 2c0a 2020 2020 7768 6572 653a 204f 7074  ,.    where: Opt
+00007510: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00007520: 652c 0a29 3a0a 2020 2020 2222 220a 2020  e,.):.    """.  
+00007530: 2020 5570 6461 7465 2061 2063 6f6c 756d    Update a colum
+00007540: 6e20 6672 6f6d 2061 206c 6179 6572 206f  n from a layer o
+00007550: 6620 7468 6520 6765 6f66 696c 652e 0a0a  f the geofile...
+00007560: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00007570: 2020 7061 7468 2028 5061 7468 4c69 6b65    path (PathLike
+00007580: 293a 2050 6174 6820 746f 2074 6865 2067  ): Path to the g
+00007590: 656f 6669 6c65 0a20 2020 2020 2020 206e  eofile.        n
+000075a0: 616d 6520 2873 7472 293a 204e 616d 6520  ame (str): Name 
+000075b0: 666f 7220 7468 6520 6e65 7720 636f 6c75  for the new colu
+000075c0: 6d6e 0a20 2020 2020 2020 2065 7870 7265  mn.        expre
+000075d0: 7373 696f 6e20 2873 7472 293a 2053 514c  ssion (str): SQL
+000075e0: 6974 6520 6578 7072 6573 7369 6f6e 2074  ite expression t
+000075f0: 6f20 7573 6520 746f 2075 7064 6174 650a  o use to update.
+00007600: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00007610: 7661 6c75 652e 0a20 2020 2020 2020 206c  value..        l
+00007620: 6179 6572 2028 7374 722c 206f 7074 696f  ayer (str, optio
+00007630: 6e61 6c29 3a20 5468 6520 6c61 7965 7220  nal): The layer 
+00007640: 6e61 6d65 2e20 4966 204e 6f6e 6520 616e  name. If None an
+00007650: 6420 7468 6520 6765 6f66 696c 650a 2020  d the geofile.  
+00007660: 2020 2020 2020 2020 2020 6861 7320 6f6e            has on
+00007670: 6c79 206f 6e65 206c 6179 6572 2c20 7468  ly one layer, th
+00007680: 6174 206c 6179 6572 2069 7320 7573 6564  at layer is used
+00007690: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+000076a0: 6e65 2e0a 2020 2020 2020 2020 6c61 7965  ne..        laye
+000076b0: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
+000076c0: 293a 2053 514c 2077 6865 7265 2063 6c61  ): SQL where cla
+000076d0: 7573 6520 746f 2072 6573 7472 6963 7420  use to restrict 
+000076e0: 7468 6520 726f 7773 2074 6861 7420 7769  the rows that wi
+000076f0: 6c6c 0a20 2020 2020 2020 2020 2020 2062  ll.            b
+00007700: 6520 7570 6461 7465 642e 2044 6566 6175  e updated. Defau
+00007710: 6c74 7320 746f 204e 6f6e 652e 0a0a 2020  lts to None...  
+00007720: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00007730: 2020 5661 6c75 6545 7272 6f72 3a20 616e    ValueError: an
+00007740: 2069 6e76 616c 6964 2070 6172 616d 6574   invalid paramet
+00007750: 6572 2076 616c 7565 2077 6173 2070 6173  er value was pas
+00007760: 7365 642e 0a20 2020 2022 2222 0a0a 2020  sed..    """..  
+00007770: 2020 2320 496e 6974 0a20 2020 2070 6174    # Init.    pat
+00007780: 6820 3d20 5061 7468 2870 6174 6829 0a20  h = Path(path). 
+00007790: 2020 2069 6620 6c61 7965 7220 6973 204e     if layer is N
+000077a0: 6f6e 653a 0a20 2020 2020 2020 206c 6179  one:.        lay
+000077b0: 6572 203d 2067 6574 5f6f 6e6c 795f 6c61  er = get_only_la
+000077c0: 7965 7228 7061 7468 290a 2020 2020 6c61  yer(path).    la
+000077d0: 7965 7269 6e66 6f5f 6f72 6967 203d 2067  yerinfo_orig = g
+000077e0: 6574 5f6c 6179 6572 696e 666f 2870 6174  et_layerinfo(pat
+000077f0: 682c 206c 6179 6572 290a 2020 2020 636f  h, layer).    co
+00007800: 6c75 6d6e 735f 7570 7065 7220 3d20 5b63  lumns_upper = [c
+00007810: 6f6c 756d 6e2e 7570 7065 7228 2920 666f  olumn.upper() fo
+00007820: 7220 636f 6c75 6d6e 2069 6e20 6c61 7965  r column in laye
+00007830: 7269 6e66 6f5f 6f72 6967 2e63 6f6c 756d  rinfo_orig.colum
+00007840: 6e73 5d0a 2020 2020 6966 206e 616d 652e  ns].    if name.
+00007850: 7570 7065 7228 2920 6e6f 7420 696e 2063  upper() not in c
+00007860: 6f6c 756d 6e73 5f75 7070 6572 3a0a 2020  olumns_upper:.  
+00007870: 2020 2020 2020 2320 4966 2063 6f6c 756d        # If colum
+00007880: 6e20 646f 6573 6e27 7420 6578 6973 7420  n doesn't exist 
+00007890: 7965 742c 2065 7272 6f72 210a 2020 2020  yet, error!.    
+000078a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000078b0: 7272 6f72 2866 2243 6f6c 756d 6e20 7b6e  rror(f"Column {n
+000078c0: 616d 657d 2064 6f65 736e 2774 2065 7869  ame} doesn't exi
+000078d0: 7374 2069 6e20 7b70 6174 687d 2c20 6c61  st in {path}, la
+000078e0: 7965 7220 7b6c 6179 6572 7d22 290a 0a20  yer {layer}").. 
+000078f0: 2020 2023 2047 6f21 0a20 2020 2064 6174     # Go!.    dat
+00007900: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a20  asource = None. 
+00007910: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00007920: 6461 7461 736f 7572 6365 203d 2067 6461  datasource = gda
+00007930: 6c2e 4f70 656e 4578 2873 7472 2870 6174  l.OpenEx(str(pat
+00007940: 6829 2c20 6e4f 7065 6e46 6c61 6773 3d67  h), nOpenFlags=g
+00007950: 6461 6c2e 4f46 5f55 5044 4154 4529 0a20  dal.OF_UPDATE). 
+00007960: 2020 2020 2020 2073 716c 6974 655f 7374         sqlite_st
+00007970: 6d74 203d 2066 2755 5044 4154 4520 227b  mt = f'UPDATE "{
+00007980: 6c61 7965 727d 2220 5345 5420 227b 6e61  layer}" SET "{na
+00007990: 6d65 7d22 203d 207b 6578 7072 6573 7369  me}" = {expressi
+000079a0: 6f6e 7d27 0a20 2020 2020 2020 2069 6620  on}'.        if 
+000079b0: 7768 6572 6520 6973 206e 6f74 204e 6f6e  where is not Non
+000079c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000079d0: 716c 6974 655f 7374 6d74 202b 3d20 6622  qlite_stmt += f"
+000079e0: 5c6e 2057 4845 5245 207b 7768 6572 657d  \n WHERE {where}
+000079f0: 220a 2020 2020 2020 2020 7265 7375 6c74  ".        result
+00007a00: 203d 2064 6174 6173 6f75 7263 652e 4578   = datasource.Ex
+00007a10: 6563 7574 6553 514c 2873 716c 6974 655f  ecuteSQL(sqlite_
+00007a20: 7374 6d74 2c20 6469 616c 6563 743d 2253  stmt, dialect="S
+00007a30: 514c 4954 4522 290a 2020 2020 2020 2020  QLITE").        
+00007a40: 6461 7461 736f 7572 6365 2e52 656c 6561  datasource.Relea
+00007a50: 7365 5265 7375 6c74 5365 7428 7265 7375  seResultSet(resu
+00007a60: 6c74 290a 0a20 2020 2065 7863 6570 7420  lt)..    except 
+00007a70: 4578 6365 7074 696f 6e20 6173 2065 783a  Exception as ex:
+00007a80: 0a20 2020 2020 2020 2065 782e 6172 6773  .        ex.args
+00007a90: 203d 2028 6622 7570 6461 7465 5f63 6f6c   = (f"update_col
+00007aa0: 756d 6e20 6572 726f 7220 666f 7220 7b70  umn error for {p
+00007ab0: 6174 687d 2e7b 6c61 7965 727d 3a5c 6e20  ath}.{layer}:\n 
+00007ac0: 207b 6578 7d22 2c29 0a20 2020 2020 2020   {ex}",).       
+00007ad0: 2072 6169 7365 0a20 2020 2066 696e 616c   raise.    final
+00007ae0: 6c79 3a0a 2020 2020 2020 2020 6461 7461  ly:.        data
+00007af0: 736f 7572 6365 203d 204e 6f6e 650a 0a0a  source = None...
+00007b00: 6465 6620 7265 6164 5f66 696c 6528 0a20  def read_file(. 
+00007b10: 2020 2070 6174 683a 2055 6e69 6f6e 5b73     path: Union[s
+00007b20: 7472 2c20 226f 732e 5061 7468 4c69 6b65  tr, "os.PathLike
+00007b30: 5b41 6e79 5d22 5d2c 0a20 2020 206c 6179  [Any]"],.    lay
+00007b40: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00007b50: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 636f  ] = None,.    co
+00007b60: 6c75 6d6e 733a 204f 7074 696f 6e61 6c5b  lumns: Optional[
+00007b70: 4974 6572 6162 6c65 5b73 7472 5d5d 203d  Iterable[str]] =
+00007b80: 204e 6f6e 652c 0a20 2020 2062 626f 783d   None,.    bbox=
+00007b90: 4e6f 6e65 2c0a 2020 2020 726f 7773 3d4e  None,.    rows=N
+00007ba0: 6f6e 652c 0a20 2020 2073 716c 5f73 746d  one,.    sql_stm
+00007bb0: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
+00007bc0: 203d 204e 6f6e 652c 0a20 2020 2073 716c   = None,.    sql
+00007bd0: 5f64 6961 6c65 6374 3a20 4f70 7469 6f6e  _dialect: Option
+00007be0: 616c 5b4c 6974 6572 616c 5b22 5351 4c49  al[Literal["SQLI
+00007bf0: 5445 222c 2022 4f47 5253 514c 225d 5d20  TE", "OGRSQL"]] 
+00007c00: 3d20 4e6f 6e65 2c0a 2020 2020 6967 6e6f  = None,.    igno
+00007c10: 7265 5f67 656f 6d65 7472 793a 2062 6f6f  re_geometry: boo
+00007c20: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
+00007c30: 6964 5f61 735f 696e 6465 783a 2062 6f6f  id_as_index: boo
+00007c40: 6c20 3d20 4661 6c73 652c 0a29 202d 3e20  l = False,.) -> 
+00007c50: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00007c60: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+00007c70: 6164 7320 6120 6669 6c65 2074 6f20 6120  ads a file to a 
+00007c80: 6765 6f70 616e 6461 7320 4765 6f44 6174  geopandas GeoDat
+00007c90: 6166 7261 6d65 2e0a 0a20 2020 2054 6865  aframe...    The
+00007ca0: 2066 696c 6520 666f 726d 6174 2069 7320   file format is 
+00007cb0: 6465 7465 6374 6564 2062 6173 6564 206f  detected based o
+00007cc0: 6e20 7468 6520 6669 6c65 7061 7468 2065  n the filepath e
+00007cd0: 7874 656e 7369 6f6e 2e0a 0a20 2020 2049  xtension...    I
+00007ce0: 6620 616e 2073 716c 5f73 746d 7420 6973  f an sql_stmt is
+00007cf0: 2073 7065 6369 6669 6564 2c20 7468 6520   specified, the 
+00007d00: 7371 6c69 7465 2071 7565 7279 2063 616e  sqlite query can
+00007d10: 2063 6f6e 7461 696e 2066 6f6c 6c6f 7769   contain followi
+00007d20: 6e67 2070 6c61 6365 686f 6c64 6572 730a  ng placeholders.
+00007d30: 2020 2020 7468 6174 2077 696c 6c20 6265      that will be
+00007d40: 2061 7574 6f6d 6174 6963 616c 6c79 2072   automatically r
+00007d50: 6570 6c61 6365 6420 666f 7220 796f 753a  eplaced for you:
+00007d60: 0a0a 2020 2020 2020 2a20 7b67 656f 6d65  ..      * {geome
+00007d70: 7472 7963 6f6c 756d 6e7d 3a20 7468 6520  trycolumn}: the 
+00007d80: 636f 6c75 6d6e 2077 6865 7265 2074 6865  column where the
+00007d90: 2070 7269 6d61 7279 2067 656f 6d65 7472   primary geometr
+00007da0: 7920 6973 2073 746f 7265 642e 0a20 2020  y is stored..   
+00007db0: 2020 202a 207b 636f 6c75 6d6e 735f 746f     * {columns_to
+00007dc0: 5f73 656c 6563 745f 7374 727d 3a20 6966  _select_str}: if
+00007dd0: 2027 636f 6c75 6d6e 7327 2069 7320 6e6f   'columns' is no
+00007de0: 7420 4e6f 6e65 2c20 7468 6f73 6520 636f  t None, those co
+00007df0: 6c75 6d6e 732c 0a20 2020 2020 2020 206f  lumns,.        o
+00007e00: 7468 6572 7769 7365 2061 6c6c 2063 6f6c  therwise all col
+00007e10: 756d 6e73 206f 6620 7468 6520 6c61 7965  umns of the laye
+00007e20: 722e 0a20 2020 2020 202a 207b 696e 7075  r..      * {inpu
+00007e30: 745f 6c61 7965 727d 3a20 7468 6520 6c61  t_layer}: the la
+00007e40: 7965 7220 6e61 6d65 206f 6620 7468 6520  yer name of the 
+00007e50: 696e 7075 7420 6c61 7965 722e 0a0a 2020  input layer...  
+00007e60: 2020 4578 616d 706c 6520 7371 6c20 7374    Example sql st
+00007e70: 6174 656d 656e 7420 7769 7468 2070 6c61  atement with pla
+00007e80: 6365 686f 6c64 6572 733a 0a20 2020 203a  ceholders:.    :
+00007e90: 3a0a 0a20 2020 2020 2020 2053 454c 4543  :..        SELEC
+00007ea0: 5420 7b67 656f 6d65 7472 7963 6f6c 756d  T {geometrycolum
+00007eb0: 6e7d 0a20 2020 2020 2020 2020 2020 2020  n}.             
+00007ec0: 207b 636f 6c75 6d6e 735f 746f 5f73 656c   {columns_to_sel
+00007ed0: 6563 745f 7374 727d 0a20 2020 2020 2020  ect_str}.       
+00007ee0: 2020 2046 524f 4d20 227b 696e 7075 745f     FROM "{input_
+00007ef0: 6c61 7965 727d 2220 6c61 7965 720a 0a20  layer}" layer.. 
+00007f00: 2020 2054 6865 2075 6e64 6572 6c79 696e     The underlyin
+00007f10: 6720 6c69 6272 6172 7920 7573 6564 2074  g library used t
+00007f20: 6f20 7265 6164 2074 6865 2066 696c 6520  o read the file 
+00007f30: 6361 6e20 6265 2063 686f 6f73 656e 2075  can be choosen u
+00007f40: 7369 6e67 2074 6865 0a20 2020 2022 4746  sing the.    "GF
+00007f50: 4f5f 494f 5f45 4e47 494e 4522 2065 6e76  O_IO_ENGINE" env
+00007f60: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
+00007f70: 652e 2050 6f73 7369 626c 6520 7661 6c75  e. Possible valu
+00007f80: 6573 2061 7265 2022 6669 6f6e 6122 2061  es are "fiona" a
+00007f90: 6e64 2022 7079 6f67 7269 6f22 2e0a 2020  nd "pyogrio"..  
+00007fa0: 2020 5468 6973 206f 7074 696f 6e20 6973    This option is
+00007fb0: 2063 7265 6174 6564 2061 7320 6120 7465   created as a te
+00007fc0: 6d70 6f72 6172 7920 6661 6c6c 6261 636b  mporary fallback
+00007fd0: 2074 6f20 2266 696f 6e61 2220 666f 7220   to "fiona" for 
+00007fe0: 6361 7365 7320 7768 6572 6520 2270 796f  cases where "pyo
+00007ff0: 6772 696f 220a 2020 2020 6769 7665 7320  grio".    gives 
+00008000: 6973 7375 6573 2c20 736f 2070 6c65 6173  issues, so pleas
+00008010: 6520 7265 706f 7274 2069 7373 7565 7320  e report issues 
+00008020: 6966 2074 6865 7920 6172 6520 656e 636f  if they are enco
+00008030: 756e 7465 7265 642e 2049 6e20 7468 6520  untered. In the 
+00008040: 6675 7475 7265 2073 7570 706f 7274 0a20  future support. 
+00008050: 2020 2066 6f72 2074 6865 2022 6669 6f6e     for the "fion
+00008060: 6122 2065 6e67 696e 6520 6d6f 7374 206c  a" engine most l
+00008070: 696b 656c 7920 7769 6c6c 2062 6520 7265  ikely will be re
+00008080: 6d6f 7665 642e 2044 6566 6175 6c74 2065  moved. Default e
+00008090: 6e67 696e 6520 6973 2022 7079 6f67 7269  ngine is "pyogri
+000080a0: 6f22 2e0a 0a20 2020 2041 7267 733a 0a20  o"...    Args:. 
+000080b0: 2020 2020 2020 2070 6174 6820 2866 696c         path (fil
+000080c0: 6520 7061 7468 293a 2070 6174 6820 746f  e path): path to
+000080d0: 2074 6865 2066 696c 6520 746f 2072 6561   the file to rea
+000080e0: 6420 6672 6f6d 0a20 2020 2020 2020 206c  d from.        l
+000080f0: 6179 6572 2028 7374 722c 206f 7074 696f  ayer (str, optio
+00008100: 6e61 6c29 3a20 5468 6520 6c61 7965 7220  nal): The layer 
+00008110: 746f 2072 6561 642e 2044 6566 6175 6c74  to read. Default
+00008120: 7320 746f 204e 6f6e 652c 0a20 2020 2020  s to None,.     
+00008130: 2020 2020 2020 2074 6865 6e20 7265 6164         then read
+00008140: 7320 7468 6520 6f6e 6c79 206c 6179 6572  s the only layer
+00008150: 2069 6e20 7468 6520 6669 6c65 206f 7220   in the file or 
+00008160: 7468 726f 7773 2065 7272 6f72 2e0a 2020  throws error..  
+00008170: 2020 2020 2020 636f 6c75 6d6e 7320 2849        columns (I
+00008180: 7465 7261 626c 655b 7374 725d 2c20 6f70  terable[str], op
+00008190: 7469 6f6e 616c 293a 2054 6865 2028 6e6f  tional): The (no
+000081a0: 6e2d 6765 6f6d 6574 7279 2920 636f 6c75  n-geometry) colu
+000081b0: 6d6e 7320 746f 2072 6561 6420 7769 6c6c  mns to read will
+000081c0: 0a20 2020 2020 2020 2020 2020 2062 6520  .            be 
+000081d0: 7265 7475 726e 6564 2069 6e20 7468 6520  returned in the 
+000081e0: 6f72 6465 7220 7370 6563 6966 6965 642e  order specified.
+000081f0: 2049 6620 4e6f 6e65 2c20 616c 6c20 7374   If None, all st
+00008200: 616e 6461 7264 2063 6f6c 756d 6e73 2061  andard columns a
+00008210: 7265 2072 6561 642e 0a20 2020 2020 2020  re read..       
+00008220: 2020 2020 2049 6e20 6164 6469 7469 6f6e       In addition
+00008230: 2074 6f20 7374 616e 6461 7264 2063 6f6c   to standard col
+00008240: 756d 6e73 2c20 6974 2069 7320 616c 736f  umns, it is also
+00008250: 2070 6f73 7369 626c 650a 2020 2020 2020   possible.      
+00008260: 2020 2020 2020 746f 2073 7065 6369 6679        to specify
+00008270: 2022 6669 6422 2c20 6120 756e 6971 7565   "fid", a unique
+00008280: 2069 6e64 6578 2061 7661 696c 6162 6c65   index available
+00008290: 2069 6e20 616c 6c20 696e 7075 7420 6669   in all input fi
+000082a0: 6c65 732e 204e 6f74 6520 7468 6174 2074  les. Note that t
+000082b0: 6865 0a20 2020 2020 2020 2020 2020 2022  he.            "
+000082c0: 6669 6422 2077 696c 6c20 6265 2061 6c69  fid" will be ali
+000082d0: 6173 6564 2065 672e 2074 6f20 2266 6964  ased eg. to "fid
+000082e0: 5f31 222e 2044 6566 6175 6c74 7320 746f  _1". Defaults to
+000082f0: 204e 6f6e 652e 0a20 2020 2020 2020 2062   None..        b
+00008300: 626f 7820 285b 7479 7065 5d2c 206f 7074  box ([type], opt
+00008310: 696f 6e61 6c29 3a20 5265 6164 206f 6e6c  ional): Read onl
+00008320: 7920 6765 6f6d 6574 7269 6573 2069 6e74  y geometries int
+00008330: 6572 7365 6374 696e 6720 7468 6973 2062  ersecting this b
+00008340: 626f 782e 0a20 2020 2020 2020 2020 2020  box..           
+00008350: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00008360: 652c 2074 6865 6e20 616c 6c20 726f 7773  e, then all rows
+00008370: 2061 7265 2072 6561 642e 0a20 2020 2020   are read..     
+00008380: 2020 2072 6f77 7320 285b 7479 7065 5d2c     rows ([type],
+00008390: 206f 7074 696f 6e61 6c29 3a20 5265 6164   optional): Read
+000083a0: 206f 6e6c 7920 7468 6520 726f 7773 2073   only the rows s
+000083b0: 7065 6369 6669 6564 2e0a 2020 2020 2020  pecified..      
+000083c0: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
+000083d0: 6f20 4e6f 6e65 2c20 7468 656e 2061 6c6c  o None, then all
+000083e0: 2072 6f77 7320 6172 6520 7265 6164 2e0a   rows are read..
+000083f0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+00008400: 2028 7374 7229 3a20 7371 6c20 7374 6174   (str): sql stat
+00008410: 656d 656e 7420 746f 2075 7365 2e20 4f6e  ement to use. On
+00008420: 6c79 2073 7570 706f 7274 6564 2077 6974  ly supported wit
+00008430: 6820 2270 796f 6772 696f 2220 656e 6769  h "pyogrio" engi
+00008440: 6e65 2e0a 2020 2020 2020 2020 7371 6c5f  ne..        sql_
+00008450: 6469 616c 6563 7420 2873 7472 2c20 6f70  dialect (str, op
+00008460: 7469 6f6e 616c 293a 2053 716c 2064 6961  tional): Sql dia
+00008470: 6c65 6374 2075 7365 642e 2049 6620 4e6f  lect used. If No
+00008480: 6e65 2c20 666f 7220 6461 7461 2073 6f75  ne, for data sou
+00008490: 7263 6573 2077 6974 680a 2020 2020 2020  rces with.      
+000084a0: 2020 2020 2020 6578 706c 6963 6974 2053        explicit S
+000084b0: 514c 2073 7570 706f 7274 2074 6865 2073  QL support the s
+000084c0: 7461 7465 6d65 6e74 2069 7320 7072 6f63  tatement is proc
+000084d0: 6573 7365 6420 6279 2074 6865 2064 6566  essed by the def
+000084e0: 6175 6c74 2053 514c 2065 6e67 696e 650a  ault SQL engine.
+000084f0: 2020 2020 2020 2020 2020 2020 2865 2e67              (e.g
+00008500: 2e20 506f 7374 4749 532c 2047 656f 7061  . PostGIS, Geopa
+00008510: 636b 6167 652c 2053 7061 7469 616c 6974  ckage, Spatialit
+00008520: 652c 2e2e 2e29 2e20 466f 7220 6461 7461  e,...). For data
+00008530: 2073 6f75 7263 6573 0a20 2020 2020 2020   sources.       
+00008540: 2020 2020 2077 6974 686f 7574 2053 514c       without SQL
+00008550: 2073 7570 706f 7274 2c20 7468 6520 224f   support, the "O
+00008560: 4752 5351 4c22 2064 6961 6c65 6374 2069  GRSQL" dialect i
+00008570: 7320 7468 6520 6465 6661 756c 742e 2044  s the default. D
+00008580: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
+00008590: 0a20 2020 2020 2020 2069 676e 6f72 655f  .        ignore_
+000085a0: 6765 6f6d 6574 7279 2028 626f 6f6c 2c20  geometry (bool, 
+000085b0: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
+000085c0: 6e6f 7420 746f 2072 6561 642f 7265 7475  not to read/retu
+000085d0: 726e 2074 6865 2067 656f 6d65 7472 792e  rn the geometry.
+000085e0: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
+000085f0: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
+00008600: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
+00008610: 6e64 6578 2028 626f 6f6c 2c20 6f70 7469  ndex (bool, opti
+00008620: 6f6e 616c 293a 2049 6620 5472 7565 2c20  onal): If True, 
+00008630: 7769 6c6c 2075 7365 2074 6865 2046 4944  will use the FID
+00008640: 7320 6f66 2074 6865 2066 6561 7475 7265  s of the feature
+00008650: 7320 7468 6174 0a20 2020 2020 2020 2020  s that.         
+00008660: 2020 2077 6572 6520 7265 6164 2061 7320     were read as 
+00008670: 7468 6520 696e 6465 7820 6f66 2074 6865  the index of the
+00008680: 2047 656f 4461 7461 4672 616d 652e 204d   GeoDataFrame. M
+00008690: 6179 2073 7461 7274 2061 7420 3020 6f72  ay start at 0 or
+000086a0: 2031 2064 6570 656e 6469 6e67 206f 6e0a   1 depending on.
+000086b0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+000086c0: 6472 6976 6572 2e20 4465 6661 756c 7473  driver. Defaults
+000086d0: 2074 6f20 4661 6c73 652e 0a0a 2020 2020   to False...    
+000086e0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+000086f0: 5661 6c75 6545 7272 6f72 3a20 616e 2069  ValueError: an i
+00008700: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+00008710: 2076 616c 7565 2077 6173 2070 6173 7365   value was passe
+00008720: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
+00008730: 0a20 2020 2020 2020 2067 7064 2e47 656f  .        gpd.Geo
+00008740: 4461 7461 4672 616d 653a 2074 6865 2064  DataFrame: the d
+00008750: 6174 6120 7265 6164 2e0a 2020 2020 2222  ata read..    ""
+00008760: 220a 2020 2020 7265 7375 6c74 5f67 6466  ".    result_gdf
+00008770: 203d 205f 7265 6164 5f66 696c 655f 6261   = _read_file_ba
+00008780: 7365 280a 2020 2020 2020 2020 7061 7468  se(.        path
+00008790: 3d70 6174 682c 0a20 2020 2020 2020 206c  =path,.        l
+000087a0: 6179 6572 3d6c 6179 6572 2c0a 2020 2020  ayer=layer,.    
+000087b0: 2020 2020 636f 6c75 6d6e 733d 636f 6c75      columns=colu
+000087c0: 6d6e 732c 0a20 2020 2020 2020 2062 626f  mns,.        bbo
+000087d0: 783d 6262 6f78 2c0a 2020 2020 2020 2020  x=bbox,.        
+000087e0: 726f 7773 3d72 6f77 732c 0a20 2020 2020  rows=rows,.     
+000087f0: 2020 2073 716c 5f73 746d 743d 7371 6c5f     sql_stmt=sql_
+00008800: 7374 6d74 2c0a 2020 2020 2020 2020 7371  stmt,.        sq
+00008810: 6c5f 6469 616c 6563 743d 7371 6c5f 6469  l_dialect=sql_di
+00008820: 616c 6563 742c 0a20 2020 2020 2020 2069  alect,.        i
+00008830: 676e 6f72 655f 6765 6f6d 6574 7279 3d69  gnore_geometry=i
+00008840: 676e 6f72 655f 6765 6f6d 6574 7279 2c0a  gnore_geometry,.
+00008850: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
+00008860: 6e64 6578 3d66 6964 5f61 735f 696e 6465  ndex=fid_as_inde
+00008870: 782c 0a20 2020 2029 0a0a 2020 2020 2320  x,.    )..    # 
+00008880: 4e6f 2061 7373 6572 7420 746f 206b 6565  No assert to kee
+00008890: 7020 6261 636b 7761 7264 7320 636f 6d70  p backwards comp
+000088a0: 6174 6962 696c 6974 790a 2020 2020 7265  atibility.    re
+000088b0: 7475 726e 2072 6573 756c 745f 6764 6620  turn result_gdf 
+000088c0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+000088d0: 0a0a 6465 6620 7265 6164 5f66 696c 655f  ..def read_file_
+000088e0: 6e6f 6765 6f6d 280a 2020 2020 7061 7468  nogeom(.    path
+000088f0: 3a20 556e 696f 6e5b 7374 722c 2022 6f73  : Union[str, "os
+00008900: 2e50 6174 684c 696b 655b 416e 795d 225d  .PathLike[Any]"]
+00008910: 2c0a 2020 2020 6c61 7965 723a 204f 7074  ,.    layer: Opt
+00008920: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00008930: 652c 0a20 2020 2063 6f6c 756d 6e73 3a20  e,.    columns: 
+00008940: 4f70 7469 6f6e 616c 5b49 7465 7261 626c  Optional[Iterabl
+00008950: 655b 7374 725d 5d20 3d20 4e6f 6e65 2c0a  e[str]] = None,.
+00008960: 2020 2020 6262 6f78 3d4e 6f6e 652c 0a20      bbox=None,. 
+00008970: 2020 2072 6f77 733d 4e6f 6e65 2c0a 2020     rows=None,.  
+00008980: 2020 7371 6c5f 7374 6d74 3a20 4f70 7469    sql_stmt: Opti
+00008990: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+000089a0: 2c0a 2020 2020 7371 6c5f 6469 616c 6563  ,.    sql_dialec
+000089b0: 743a 204f 7074 696f 6e61 6c5b 4c69 7465  t: Optional[Lite
+000089c0: 7261 6c5b 2253 514c 4954 4522 2c20 224f  ral["SQLITE", "O
+000089d0: 4752 5351 4c22 5d5d 203d 204e 6f6e 652c  GRSQL"]] = None,
+000089e0: 0a20 2020 2066 6964 5f61 735f 696e 6465  .    fid_as_inde
+000089f0: 783a 2062 6f6f 6c20 3d20 4661 6c73 652c  x: bool = False,
+00008a00: 0a29 202d 3e20 7064 2e44 6174 6146 7261  .) -> pd.DataFra
+00008a10: 6d65 3a0a 2020 2020 2222 220a 2020 2020  me:.    """.    
+00008a20: 4445 5052 4543 4154 4544 3a20 706c 6561  DEPRECATED: plea
+00008a30: 7365 2075 7365 2072 6561 645f 6669 6c65  se use read_file
+00008a40: 2077 6974 6820 6f70 7469 6f6e 2069 676e   with option ign
+00008a50: 6f72 655f 6765 6f6d 6574 7279 3d54 7275  ore_geometry=Tru
+00008a60: 652e 0a20 2020 2022 2222 0a20 2020 2077  e..    """.    w
+00008a70: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
+00008a80: 2020 2020 2020 2272 6561 645f 6669 6c65        "read_file
+00008a90: 5f6e 6f67 656f 6d20 6973 2064 6570 7265  _nogeom is depre
+00008aa0: 6361 7465 643a 2075 7365 2072 6561 645f  cated: use read_
+00008ab0: 6669 6c65 2077 6974 6820 6967 6e6f 7265  file with ignore
+00008ac0: 5f67 656f 6d65 7472 793d 5472 7565 222c  _geometry=True",
+00008ad0: 0a20 2020 2020 2020 2046 7574 7572 6557  .        FutureW
+00008ae0: 6172 6e69 6e67 2c0a 2020 2020 290a 2020  arning,.    ).  
+00008af0: 2020 7265 7375 6c74 5f67 6466 203d 205f    result_gdf = _
+00008b00: 7265 6164 5f66 696c 655f 6261 7365 280a  read_file_base(.
+00008b10: 2020 2020 2020 2020 7061 7468 3d70 6174          path=pat
+00008b20: 682c 0a20 2020 2020 2020 206c 6179 6572  h,.        layer
+00008b30: 3d6c 6179 6572 2c0a 2020 2020 2020 2020  =layer,.        
+00008b40: 636f 6c75 6d6e 733d 636f 6c75 6d6e 732c  columns=columns,
+00008b50: 0a20 2020 2020 2020 2062 626f 783d 6262  .        bbox=bb
+00008b60: 6f78 2c0a 2020 2020 2020 2020 726f 7773  ox,.        rows
+00008b70: 3d72 6f77 732c 0a20 2020 2020 2020 2073  =rows,.        s
+00008b80: 716c 5f73 746d 743d 7371 6c5f 7374 6d74  ql_stmt=sql_stmt
+00008b90: 2c0a 2020 2020 2020 2020 7371 6c5f 6469  ,.        sql_di
+00008ba0: 616c 6563 743d 7371 6c5f 6469 616c 6563  alect=sql_dialec
+00008bb0: 742c 0a20 2020 2020 2020 2069 676e 6f72  t,.        ignor
+00008bc0: 655f 6765 6f6d 6574 7279 3d54 7275 652c  e_geometry=True,
+00008bd0: 0a20 2020 2020 2020 2066 6964 5f61 735f  .        fid_as_
+00008be0: 696e 6465 783d 6669 645f 6173 5f69 6e64  index=fid_as_ind
+00008bf0: 6578 2c0a 2020 2020 290a 2020 2020 6173  ex,.    ).    as
+00008c00: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00008c10: 7265 7375 6c74 5f67 6466 2c20 7064 2e44  result_gdf, pd.D
+00008c20: 6174 6146 7261 6d65 290a 2020 2020 7265  ataFrame).    re
+00008c30: 7475 726e 2072 6573 756c 745f 6764 660a  turn result_gdf.
+00008c40: 0a0a 6465 6620 5f72 6561 645f 6669 6c65  ..def _read_file
+00008c50: 5f62 6173 6528 0a20 2020 2070 6174 683a  _base(.    path:
+00008c60: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
+00008c70: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
+00008c80: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
+00008c90: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00008ca0: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
+00008cb0: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
+00008cc0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00008cd0: 2020 2062 626f 783d 4e6f 6e65 2c0a 2020     bbox=None,.  
+00008ce0: 2020 726f 7773 3d4e 6f6e 652c 0a20 2020    rows=None,.   
+00008cf0: 2073 716c 5f73 746d 743a 204f 7074 696f   sql_stmt: Optio
+00008d00: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00008d10: 0a20 2020 2073 716c 5f64 6961 6c65 6374  .    sql_dialect
+00008d20: 3a20 4f70 7469 6f6e 616c 5b4c 6974 6572  : Optional[Liter
+00008d30: 616c 5b22 5351 4c49 5445 222c 2022 4f47  al["SQLITE", "OG
+00008d40: 5253 514c 225d 5d20 3d20 4e6f 6e65 2c0a  RSQL"]] = None,.
+00008d50: 2020 2020 6967 6e6f 7265 5f67 656f 6d65      ignore_geome
+00008d60: 7472 793a 2062 6f6f 6c20 3d20 4661 6c73  try: bool = Fals
+00008d70: 652c 0a20 2020 2066 6964 5f61 735f 696e  e,.    fid_as_in
+00008d80: 6465 783a 2062 6f6f 6c20 3d20 4661 6c73  dex: bool = Fals
+00008d90: 652c 0a29 202d 3e20 556e 696f 6e5b 7064  e,.) -> Union[pd
+00008da0: 2e44 6174 6146 7261 6d65 2c20 6770 642e  .DataFrame, gpd.
+00008db0: 4765 6f44 6174 6146 7261 6d65 5d3a 0a20  GeoDataFrame]:. 
+00008dc0: 2020 2022 2222 0a20 2020 2052 6561 6473     """.    Reads
+00008dd0: 2061 2066 696c 6520 746f 2061 2070 616e   a file to a pan
+00008de0: 6461 7320 4461 7461 6672 616d 652e 0a20  das Dataframe.. 
+00008df0: 2020 2022 2222 0a20 2020 2023 2043 6865     """.    # Che
+00008e00: 636b 2069 6620 7468 6520 6669 6420 636f  ck if the fid co
+00008e10: 6c75 6d6e 206e 6565 6473 2074 6f20 6265  lumn needs to be
+00008e20: 2072 6561 6420 6173 2063 6f6c 756d 6e20   read as column 
+00008e30: 7669 6120 7468 6520 636f 6c75 6d6e 7320  via the columns 
+00008e40: 7061 7261 6d65 7465 720a 2020 2020 6669  parameter.    fi
+00008e50: 645f 6173 5f63 6f6c 756d 6e20 3d20 4661  d_as_column = Fa
+00008e60: 6c73 650a 2020 2020 6966 2063 6f6c 756d  lse.    if colum
+00008e70: 6e73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ns is not None:.
+00008e80: 2020 2020 2020 2020 6966 2022 6669 6422          if "fid"
+00008e90: 2069 6e20 5b63 6f6c 756d 6e2e 6c6f 7765   in [column.lowe
+00008ea0: 7228 2920 666f 7220 636f 6c75 6d6e 2069  r() for column i
+00008eb0: 6e20 636f 6c75 6d6e 735d 3a0a 2020 2020  n columns]:.    
+00008ec0: 2020 2020 2020 2020 6669 645f 6173 5f63          fid_as_c
+00008ed0: 6f6c 756d 6e20 3d20 5472 7565 0a0a 2020  olumn = True..  
+00008ee0: 2020 2320 5265 6164 2077 6974 6820 7468    # Read with th
+00008ef0: 6520 656e 6769 6e65 2073 7065 6369 6669  e engine specifi
+00008f00: 6564 0a20 2020 2065 6e67 696e 6520 3d20  ed.    engine = 
+00008f10: 5f67 6574 5f65 6e67 696e 6528 290a 2020  _get_engine().  
+00008f20: 2020 6966 2065 6e67 696e 6520 3d3d 2022    if engine == "
+00008f30: 7079 6f67 7269 6f22 3a0a 2020 2020 2020  pyogrio":.      
+00008f40: 2020 6764 6620 3d20 5f72 6561 645f 6669    gdf = _read_fi
+00008f50: 6c65 5f62 6173 655f 7079 6f67 7269 6f28  le_base_pyogrio(
+00008f60: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00008f70: 683d 7061 7468 2c0a 2020 2020 2020 2020  h=path,.        
+00008f80: 2020 2020 6c61 7965 723d 6c61 7965 722c      layer=layer,
+00008f90: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+00008fa0: 756d 6e73 3d63 6f6c 756d 6e73 2c0a 2020  umns=columns,.  
+00008fb0: 2020 2020 2020 2020 2020 6262 6f78 3d62            bbox=b
+00008fc0: 626f 782c 0a20 2020 2020 2020 2020 2020  box,.           
+00008fd0: 2072 6f77 733d 726f 7773 2c0a 2020 2020   rows=rows,.    
+00008fe0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+00008ff0: 3d73 716c 5f73 746d 742c 0a20 2020 2020  =sql_stmt,.     
+00009000: 2020 2020 2020 2073 716c 5f64 6961 6c65         sql_diale
+00009010: 6374 3d73 716c 5f64 6961 6c65 6374 2c0a  ct=sql_dialect,.
+00009020: 2020 2020 2020 2020 2020 2020 6967 6e6f              igno
+00009030: 7265 5f67 656f 6d65 7472 793d 6967 6e6f  re_geometry=igno
+00009040: 7265 5f67 656f 6d65 7472 792c 0a20 2020  re_geometry,.   
+00009050: 2020 2020 2020 2020 2066 6964 5f61 735f           fid_as_
+00009060: 696e 6465 783d 6669 645f 6173 5f69 6e64  index=fid_as_ind
+00009070: 6578 206f 7220 6669 645f 6173 5f63 6f6c  ex or fid_as_col
+00009080: 756d 6e2c 0a20 2020 2020 2020 2029 0a20  umn,.        ). 
+00009090: 2020 2065 6c69 6620 656e 6769 6e65 203d     elif engine =
+000090a0: 3d20 2266 696f 6e61 223a 0a20 2020 2020  = "fiona":.     
+000090b0: 2020 2067 6466 203d 205f 7265 6164 5f66     gdf = _read_f
+000090c0: 696c 655f 6261 7365 5f66 696f 6e61 280a  ile_base_fiona(.
+000090d0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+000090e0: 3d70 6174 682c 0a20 2020 2020 2020 2020  =path,.         
+000090f0: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+00009100: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00009110: 6d6e 733d 636f 6c75 6d6e 732c 0a20 2020  mns=columns,.   
+00009120: 2020 2020 2020 2020 2062 626f 783d 6262           bbox=bb
+00009130: 6f78 2c0a 2020 2020 2020 2020 2020 2020  ox,.            
+00009140: 726f 7773 3d72 6f77 732c 0a20 2020 2020  rows=rows,.     
+00009150: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
+00009160: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
+00009170: 2020 2020 2020 7371 6c5f 6469 616c 6563        sql_dialec
+00009180: 743d 7371 6c5f 6469 616c 6563 742c 0a20  t=sql_dialect,. 
+00009190: 2020 2020 2020 2020 2020 2069 676e 6f72             ignor
+000091a0: 655f 6765 6f6d 6574 7279 3d69 676e 6f72  e_geometry=ignor
+000091b0: 655f 6765 6f6d 6574 7279 2c0a 2020 2020  e_geometry,.    
+000091c0: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
+000091d0: 6e64 6578 3d66 6964 5f61 735f 696e 6465  ndex=fid_as_inde
+000091e0: 7820 6f72 2066 6964 5f61 735f 636f 6c75  x or fid_as_colu
+000091f0: 6d6e 2c0a 2020 2020 2020 2020 290a 2020  mn,.        ).  
+00009200: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009210: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00009220: 2866 2255 6e73 7570 706f 7274 6564 2065  (f"Unsupported e
+00009230: 6e67 696e 653a 207b 656e 6769 6e65 7d22  ngine: {engine}"
+00009240: 290a 0a20 2020 2023 2043 6f70 7920 7468  )..    # Copy th
+00009250: 6520 696e 6465 7820 746f 2061 2063 6f6c  e index to a col
+00009260: 756d 6e20 6966 206e 6565 6465 642e 2e2e  umn if needed...
+00009270: 0a20 2020 2069 6620 6669 645f 6173 5f63  .    if fid_as_c
+00009280: 6f6c 756d 6e3a 0a20 2020 2020 2020 2067  olumn:.        g
+00009290: 6466 5b22 6669 6422 5d20 3d20 6764 662e  df["fid"] = gdf.
+000092a0: 696e 6465 780a 2020 2020 2020 2020 6966  index.        if
+000092b0: 206e 6f74 2066 6964 5f61 735f 696e 6465   not fid_as_inde
+000092c0: 783a 0a20 2020 2020 2020 2020 2020 2067  x:.            g
+000092d0: 6466 203d 2067 6466 2e72 6573 6574 5f69  df = gdf.reset_i
+000092e0: 6e64 6578 2864 726f 703d 5472 7565 290a  ndex(drop=True).
+000092f0: 0a20 2020 2072 6574 7572 6e20 6764 660a  .    return gdf.
+00009300: 0a0a 6465 6620 5f72 6561 645f 6669 6c65  ..def _read_file
+00009310: 5f62 6173 655f 6669 6f6e 6128 0a20 2020  _base_fiona(.   
+00009320: 2070 6174 683a 2055 6e69 6f6e 5b73 7472   path: Union[str
+00009330: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
+00009340: 6e79 5d22 5d2c 0a20 2020 206c 6179 6572  ny]"],.    layer
+00009350: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00009360: 3d20 4e6f 6e65 2c0a 2020 2020 636f 6c75  = None,.    colu
+00009370: 6d6e 733a 204f 7074 696f 6e61 6c5b 4974  mns: Optional[It
+00009380: 6572 6162 6c65 5b73 7472 5d5d 203d 204e  erable[str]] = N
+00009390: 6f6e 652c 0a20 2020 2062 626f 783d 4e6f  one,.    bbox=No
+000093a0: 6e65 2c0a 2020 2020 726f 7773 3d4e 6f6e  ne,.    rows=Non
+000093b0: 652c 0a20 2020 2073 716c 5f73 746d 743a  e,.    sql_stmt:
+000093c0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000093d0: 204e 6f6e 652c 0a20 2020 2073 716c 5f64   None,.    sql_d
+000093e0: 6961 6c65 6374 3a20 4f70 7469 6f6e 616c  ialect: Optional
+000093f0: 5b4c 6974 6572 616c 5b22 5351 4c49 5445  [Literal["SQLITE
+00009400: 222c 2022 4f47 5253 514c 225d 5d20 3d20  ", "OGRSQL"]] = 
+00009410: 4e6f 6e65 2c0a 2020 2020 6967 6e6f 7265  None,.    ignore
+00009420: 5f67 656f 6d65 7472 793a 2062 6f6f 6c20  _geometry: bool 
+00009430: 3d20 4661 6c73 652c 0a20 2020 2066 6964  = False,.    fid
+00009440: 5f61 735f 696e 6465 783a 2062 6f6f 6c20  _as_index: bool 
+00009450: 3d20 4661 6c73 652c 0a29 202d 3e20 556e  = False,.) -> Un
+00009460: 696f 6e5b 7064 2e44 6174 6146 7261 6d65  ion[pd.DataFrame
+00009470: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
+00009480: 6d65 5d3a 0a20 2020 2022 2222 0a20 2020  me]:.    """.   
+00009490: 2052 6561 6473 2061 2066 696c 6520 746f   Reads a file to
+000094a0: 2061 2070 616e 6461 7320 4461 7461 6672   a pandas Datafr
+000094b0: 616d 6520 7573 696e 6720 6669 6f6e 612e  ame using fiona.
+000094c0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+000094d0: 6967 6e6f 7265 5f67 656f 6d65 7472 7920  ignore_geometry 
+000094e0: 616e 6420 636f 6c75 6d6e 7320 3d3d 205b  and columns == [
+000094f0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00009500: 6e20 7064 2e44 6174 6146 7261 6d65 2829  n pd.DataFrame()
+00009510: 0a20 2020 2069 6620 7371 6c5f 7374 6d74  .    if sql_stmt
+00009520: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00009530: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00009540: 6545 7272 6f72 2822 7371 6c5f 7374 6d74  eError("sql_stmt
+00009550: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00009560: 6420 7769 7468 2066 696f 6e61 2065 6e67  d with fiona eng
+00009570: 696e 6522 290a 0a20 2020 2023 2049 6e69  ine")..    # Ini
+00009580: 740a 2020 2020 7061 7468 203d 2050 6174  t.    path = Pat
+00009590: 6828 7061 7468 290a 2020 2020 6966 2070  h(path).    if p
+000095a0: 6174 682e 6578 6973 7473 2829 2069 7320  ath.exists() is 
+000095b0: 4661 6c73 653a 0a20 2020 2020 2020 2072  False:.        r
+000095c0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000095d0: 6622 6669 6c65 2064 6f65 736e 2774 2065  f"file doesn't e
+000095e0: 7869 7374 3a20 7b70 6174 687d 2229 0a0a  xist: {path}")..
+000095f0: 2020 2020 2320 4966 206e 6f20 6c61 7965      # If no laye
+00009600: 7220 6e61 6d65 2073 7065 6369 6669 6564  r name specified
+00009610: 2c20 6368 6563 6b20 6966 2074 6865 7265  , check if there
+00009620: 2069 7320 6f6e 6c79 206f 6e65 206c 6179   is only one lay
+00009630: 6572 2069 6e20 7468 6520 6669 6c65 2e0a  er in the file..
+00009640: 2020 2020 6966 206c 6179 6572 2069 7320      if layer is 
+00009650: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c61  None:.        la
+00009660: 7965 7220 3d20 6765 745f 6f6e 6c79 5f6c  yer = get_only_l
+00009670: 6179 6572 2870 6174 6829 0a0a 2020 2020  ayer(path)..    
+00009680: 2320 5645 5259 2044 4952 5459 2068 6163  # VERY DIRTY hac
+00009690: 6b20 746f 2067 6574 2074 6865 2066 6964  k to get the fid
+000096a0: 0a20 2020 2069 6620 6669 645f 6173 5f69  .    if fid_as_i
+000096b0: 6e64 6578 3a0a 2020 2020 2020 2020 2320  ndex:.        # 
+000096c0: 4d61 6b65 2061 2063 6f70 792f 636f 7079  Make a copy/copy
+000096d0: 2069 6e70 7574 2066 696c 6520 746f 2067   input file to g
+000096e0: 656f 7061 636b 6167 652c 2061 7320 7765  eopackage, as we
+000096f0: 2077 696c 6c20 6164 6420 616e 2066 6964   will add an fid
+00009700: 2f72 6f77 6420 636f 6c75 6d6e 0a20 2020  /rowd column.   
+00009710: 2020 2020 2074 6d70 5f66 6964 5f70 6174       tmp_fid_pat
+00009720: 6820 3d20 5061 7468 2874 656d 7066 696c  h = Path(tempfil
+00009730: 652e 6d6b 6474 656d 7028 2929 202f 2066  e.mkdtemp()) / f
+00009740: 227b 7061 7468 2e73 7465 6d7d 2e67 706b  "{path.stem}.gpk
+00009750: 6722 0a20 2020 2020 2020 2074 7279 3a0a  g".        try:.
+00009760: 2020 2020 2020 2020 2020 2020 6966 2047              if G
+00009770: 656f 6669 6c65 5479 7065 2870 6174 6829  eofileType(path)
+00009780: 203d 3d20 4765 6f66 696c 6554 7970 652e   == GeofileType.
+00009790: 4750 4b47 3a0a 2020 2020 2020 2020 2020  GPKG:.          
+000097a0: 2020 2020 2020 636f 7079 2870 6174 682c        copy(path,
+000097b0: 2074 6d70 5f66 6964 5f70 6174 6829 0a20   tmp_fid_path). 
+000097c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000097d0: 6464 5f63 6f6c 756d 6e28 746d 705f 6669  dd_column(tmp_fi
+000097e0: 645f 7061 7468 2c20 225f 5f54 4d50 5f47  d_path, "__TMP_G
+000097f0: 454f 4649 4c45 4f50 535f 4649 4422 2c20  EOFILEOPS_FID", 
+00009800: 2249 4e54 4547 4552 222c 2022 6669 6422  "INTEGER", "fid"
+00009810: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00009820: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009830: 2020 2020 636f 7079 5f6c 6179 6572 2870      copy_layer(p
+00009840: 6174 682c 2074 6d70 5f66 6964 5f70 6174  ath, tmp_fid_pat
+00009850: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+00009860: 2020 2023 2066 6964 2069 6e20 7368 6170     # fid in shap
+00009870: 6566 696c 6520 6973 2030 2062 6173 6564  efile is 0 based
+00009880: 2c20 736f 2066 6964 2d31 0a20 2020 2020  , so fid-1.     
+00009890: 2020 2020 2020 2020 2020 2061 6464 5f63             add_c
+000098a0: 6f6c 756d 6e28 746d 705f 6669 645f 7061  olumn(tmp_fid_pa
+000098b0: 7468 2c20 225f 5f54 4d50 5f47 454f 4649  th, "__TMP_GEOFI
+000098c0: 4c45 4f50 535f 4649 4422 2c20 2249 4e54  LEOPS_FID", "INT
+000098d0: 4547 4552 222c 2022 6669 642d 3122 290a  EGER", "fid-1").
+000098e0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+000098f0: 6820 3d20 746d 705f 6669 645f 7061 7468  h = tmp_fid_path
+00009900: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+00009910: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00009920: 2074 6d70 5f66 6964 5f70 6174 682e 7061   tmp_fid_path.pa
+00009930: 7265 6e74 2e65 7869 7374 7328 293a 0a20  rent.exists():. 
+00009940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00009950: 6875 7469 6c2e 726d 7472 6565 2874 6d70  hutil.rmtree(tmp
+00009960: 5f66 6964 5f70 6174 682c 2069 676e 6f72  _fid_path, ignor
+00009970: 655f 6572 726f 7273 3d54 7275 6529 0a0a  e_errors=True)..
+00009980: 2020 2020 2320 4368 6563 6b69 6e67 2069      # Checking i
+00009990: 6620 6669 656c 642f 636f 6c75 6d6e 206e  f field/column n
+000099a0: 616d 6573 2073 686f 756c 6420 6265 2072  ames should be r
+000099b0: 6561 6420 6973 2063 6173 6520 7365 6e73  ead is case sens
+000099c0: 6974 6976 6520 696e 2066 696f 6e61 2c20  itive in fiona, 
+000099d0: 736f 0a20 2020 2023 206d 616b 6520 7375  so.    # make su
+000099e0: 7265 2074 6865 2063 6f6c 756d 6e20 6e61  re the column na
+000099f0: 6d65 7320 7370 6563 6966 6965 6420 6861  mes specified ha
+00009a00: 7665 2074 6865 2073 616d 6520 6361 7369  ve the same casi
+00009a10: 6e67 2e0a 2020 2020 636f 6c75 6d6e 735f  ng..    columns_
+00009a20: 7072 6570 6172 6564 203d 204e 6f6e 650a  prepared = None.
+00009a30: 2020 2020 6966 2063 6f6c 756d 6e73 2069      if columns i
+00009a40: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00009a50: 2020 2020 6c61 7965 7269 6e66 6f20 3d20      layerinfo = 
+00009a60: 6765 745f 6c61 7965 7269 6e66 6f28 7061  get_layerinfo(pa
+00009a70: 7468 2c20 6c61 7965 723d 6c61 7965 7229  th, layer=layer)
+00009a80: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
+00009a90: 5f75 7070 6572 5f6c 6f6f 6b75 7020 3d20  _upper_lookup = 
+00009aa0: 7b63 6f6c 756d 6e2e 7570 7065 7228 293a  {column.upper():
+00009ab0: 2063 6f6c 756d 6e20 666f 7220 636f 6c75   column for colu
+00009ac0: 6d6e 2069 6e20 636f 6c75 6d6e 737d 0a20  mn in columns}. 
+00009ad0: 2020 2020 2020 2063 6f6c 756d 6e73 5f70         columns_p
+00009ae0: 7265 7061 7265 6420 3d20 7b0a 2020 2020  repared = {.    
+00009af0: 2020 2020 2020 2020 636f 6c75 6d6e 3a20          column: 
+00009b00: 636f 6c75 6d6e 735f 7570 7065 725f 6c6f  columns_upper_lo
+00009b10: 6f6b 7570 5b63 6f6c 756d 6e2e 7570 7065  okup[column.uppe
+00009b20: 7228 295d 0a20 2020 2020 2020 2020 2020  r()].           
+00009b30: 2066 6f72 2063 6f6c 756d 6e20 696e 206c   for column in l
+00009b40: 6179 6572 696e 666f 2e63 6f6c 756d 6e73  ayerinfo.columns
+00009b50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009b60: 636f 6c75 6d6e 2e75 7070 6572 2829 2069  column.upper() i
+00009b70: 6e20 636f 6c75 6d6e 735f 7570 7065 725f  n columns_upper_
+00009b80: 6c6f 6f6b 7570 0a20 2020 2020 2020 207d  lookup.        }
+00009b90: 0a0a 2020 2020 2320 5265 6164 2e2e 2e0a  ..    # Read....
+00009ba0: 2020 2020 636f 6c75 6d6e 735f 6c69 7374      columns_list
+00009bb0: 203d 204e 6f6e 6520 6966 2063 6f6c 756d   = None if colum
+00009bc0: 6e73 5f70 7265 7061 7265 6420 6973 204e  ns_prepared is N
+00009bd0: 6f6e 6520 656c 7365 206c 6973 7428 636f  one else list(co
+00009be0: 6c75 6d6e 735f 7072 6570 6172 6564 290a  lumns_prepared).
+00009bf0: 2020 2020 7265 7375 6c74 5f67 6466 203d      result_gdf =
+00009c00: 2067 7064 2e72 6561 645f 6669 6c65 280a   gpd.read_file(.
+00009c10: 2020 2020 2020 2020 7374 7228 7061 7468          str(path
+00009c20: 292c 0a20 2020 2020 2020 206c 6179 6572  ),.        layer
+00009c30: 3d6c 6179 6572 2c0a 2020 2020 2020 2020  =layer,.        
+00009c40: 6262 6f78 3d62 626f 782c 0a20 2020 2020  bbox=bbox,.     
+00009c50: 2020 2072 6f77 733d 726f 7773 2c0a 2020     rows=rows,.  
+00009c60: 2020 2020 2020 696e 636c 7564 655f 6669        include_fi
+00009c70: 656c 6473 3d63 6f6c 756d 6e73 5f6c 6973  elds=columns_lis
+00009c80: 742c 0a20 2020 2020 2020 2073 716c 3d73  t,.        sql=s
+00009c90: 716c 5f73 746d 742c 0a20 2020 2020 2020  ql_stmt,.       
+00009ca0: 2073 716c 5f64 6961 6c65 6374 3d73 716c   sql_dialect=sql
+00009cb0: 5f64 6961 6c65 6374 2c0a 2020 2020 2020  _dialect,.      
+00009cc0: 2020 6967 6e6f 7265 5f67 656f 6d65 7472    ignore_geometr
+00009cd0: 793d 6967 6e6f 7265 5f67 656f 6d65 7472  y=ignore_geometr
+00009ce0: 792c 0a20 2020 2029 0a0a 2020 2020 2320  y,.    )..    # 
+00009cf0: 5365 7420 7468 6520 696e 6465 7820 746f  Set the index to
+00009d00: 2074 6865 2062 6163 6b65 642d 7570 2066   the backed-up f
+00009d10: 6964 0a20 2020 2069 6620 6669 645f 6173  id.    if fid_as
+00009d20: 5f69 6e64 6578 3a0a 2020 2020 2020 2020  _index:.        
+00009d30: 7265 7375 6c74 5f67 6466 203d 2072 6573  result_gdf = res
+00009d40: 756c 745f 6764 662e 7365 745f 696e 6465  ult_gdf.set_inde
+00009d50: 7828 225f 5f54 4d50 5f47 454f 4649 4c45  x("__TMP_GEOFILE
+00009d60: 4f50 535f 4649 4422 290a 0a20 2020 2023  OPS_FID")..    #
+00009d70: 2052 656f 7264 6572 2063 6f6c 756d 6e73   Reorder columns
+00009d80: 202b 2063 6861 6e67 6520 6361 7369 6e67   + change casing
+00009d90: 2073 6f20 7468 6579 2061 7265 2074 6865   so they are the
+00009da0: 2073 616d 6520 6173 2063 6f6c 756d 6e73   same as columns
+00009db0: 2070 6172 616d 6574 6572 0a20 2020 2069   parameter.    i
+00009dc0: 6620 636f 6c75 6d6e 735f 7072 6570 6172  f columns_prepar
+00009dd0: 6564 2069 7320 6e6f 7420 4e6f 6e65 2061  ed is not None a
+00009de0: 6e64 206c 656e 2863 6f6c 756d 6e73 5f70  nd len(columns_p
+00009df0: 7265 7061 7265 6429 203e 2030 3a0a 2020  repared) > 0:.  
+00009e00: 2020 2020 2020 7265 7375 6c74 5f67 6466        result_gdf
+00009e10: 203d 2072 6573 756c 745f 6764 665b 6c69   = result_gdf[li
+00009e20: 7374 2863 6f6c 756d 6e73 5f70 7265 7061  st(columns_prepa
+00009e30: 7265 6429 202b 205b 2267 656f 6d65 7472  red) + ["geometr
+00009e40: 7922 5d5d 0a20 2020 2020 2020 2072 6573  y"]].        res
+00009e50: 756c 745f 6764 6620 3d20 7265 7375 6c74  ult_gdf = result
+00009e60: 5f67 6466 2e72 656e 616d 6528 636f 6c75  _gdf.rename(colu
+00009e70: 6d6e 733d 636f 6c75 6d6e 735f 7072 6570  mns=columns_prep
+00009e80: 6172 6564 2920 2023 2074 7970 653a 2069  ared)  # type: i
+00009e90: 676e 6f72 650a 0a20 2020 2023 2053 7461  gnore..    # Sta
+00009ea0: 7274 696e 6720 6672 6f6d 2066 696f 6e61  rting from fiona
+00009eb0: 2031 2e39 2c20 7374 7269 6e67 2063 6f6c   1.9, string col
+00009ec0: 756d 6e73 2077 6974 6820 616c 6c20 4e6f  umns with all No
+00009ed0: 6e65 2076 616c 7565 7320 6172 6520 7265  ne values are re
+00009ee0: 6164 2061 7320 6265 696e 670a 2020 2020  ad as being.    
+00009ef0: 2320 666c 6f61 7420 636f 6c75 6d6e 732e  # float columns.
+00009f00: 2043 6f6e 7665 7274 2074 6865 6d20 746f   Convert them to
+00009f10: 206f 626a 6563 7420 7479 7065 2e0a 2020   object type..  
+00009f20: 2020 666c 6f61 745f 636f 6c73 203d 206c    float_cols = l
+00009f30: 6973 7428 7265 7375 6c74 5f67 6466 2e73  ist(result_gdf.s
+00009f40: 656c 6563 745f 6474 7970 6573 285b 2266  elect_dtypes(["f
+00009f50: 6c6f 6174 3634 225d 292e 636f 6c75 6d6e  loat64"]).column
+00009f60: 7329 0a20 2020 2069 6620 6c65 6e28 666c  s).    if len(fl
+00009f70: 6f61 745f 636f 6c73 2920 3e20 303a 0a20  oat_cols) > 0:. 
+00009f80: 2020 2020 2020 2023 2043 6865 636b 2066         # Check f
+00009f90: 6f72 2061 6c6c 2066 6c6f 6174 2063 6f6c  or all float col
+00009fa0: 756d 6e73 2066 6f75 6e64 2069 6620 7468  umns found if th
+00009fb0: 6579 2073 686f 756c 6420 6265 206f 626a  ey should be obj
+00009fc0: 6563 7420 636f 6c75 6d6e 7320 696e 7374  ect columns inst
+00009fd0: 6561 640a 2020 2020 2020 2020 7769 7468  ead.        with
+00009fe0: 2066 696f 6e61 2e6f 7065 6e28 7061 7468   fiona.open(path
+00009ff0: 2c20 6c61 7965 723d 6c61 7965 7229 2061  , layer=layer) a
+0000a000: 7320 636f 6c6c 6563 7469 6f6e 3a0a 2020  s collection:.  
+0000a010: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000a020: 2063 6f6c 6c65 6374 696f 6e2e 7363 6865   collection.sche
+0000a030: 6d61 2069 7320 6e6f 7420 4e6f 6e65 0a20  ma is not None. 
+0000a040: 2020 2020 2020 2020 2020 2070 726f 7065             prope
+0000a050: 7274 6965 7320 3d20 636f 6c6c 6563 7469  rties = collecti
+0000a060: 6f6e 2e73 6368 656d 615b 2270 726f 7065  on.schema["prope
+0000a070: 7274 6965 7322 5d0a 2020 2020 2020 2020  rties"].        
+0000a080: 2020 2020 666f 7220 636f 6c20 696e 2066      for col in f
+0000a090: 6c6f 6174 5f63 6f6c 733a 0a20 2020 2020  loat_cols:.     
+0000a0a0: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+0000a0b0: 6c20 696e 2070 726f 7065 7274 6965 7320  l in properties 
+0000a0c0: 616e 6420 7072 6f70 6572 7469 6573 5b63  and properties[c
+0000a0d0: 6f6c 5d2e 7374 6172 7473 7769 7468 2822  ol].startswith("
+0000a0e0: 7374 7222 293a 0a20 2020 2020 2020 2020  str"):.         
+0000a0f0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0000a100: 745f 6764 665b 636f 6c5d 203d 2028 0a20  t_gdf[col] = (. 
+0000a110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a120: 2020 2020 2020 2072 6573 756c 745f 6764         result_gd
+0000a130: 665b 636f 6c5d 2020 2320 7479 7065 3a20  f[col]  # type: 
+0000a140: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+0000a150: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0000a160: 6173 7479 7065 286f 626a 6563 7429 2020  astype(object)  
+0000a170: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a190: 2020 2020 2020 202e 7265 706c 6163 6528         .replace(
+0000a1a0: 6e70 2e6e 616e 2c20 4e6f 6e65 290a 2020  np.nan, None).  
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1c0: 2020 290a 0a20 2020 2023 2061 7373 6572    )..    # asser
+0000a1d0: 7420 746f 2065 7661 6465 2070 794c 616e  t to evade pyLan
+0000a1e0: 6365 2077 6172 6e69 6e67 0a20 2020 2061  ce warning.    a
+0000a1f0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000a200: 2872 6573 756c 745f 6764 662c 2070 642e  (result_gdf, pd.
+0000a210: 4461 7461 4672 616d 6529 206f 7220 6973  DataFrame) or is
+0000a220: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
+0000a230: 2020 7265 7375 6c74 5f67 6466 2c20 6770    result_gdf, gp
+0000a240: 642e 4765 6f44 6174 6146 7261 6d65 0a20  d.GeoDataFrame. 
+0000a250: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+0000a260: 7265 7375 6c74 5f67 6466 0a0a 0a64 6566  result_gdf...def
+0000a270: 205f 7265 6164 5f66 696c 655f 6261 7365   _read_file_base
+0000a280: 5f70 796f 6772 696f 280a 2020 2020 7061  _pyogrio(.    pa
+0000a290: 7468 3a20 556e 696f 6e5b 7374 722c 2022  th: Union[str, "
+0000a2a0: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
+0000a2b0: 225d 2c0a 2020 2020 6c61 7965 723a 204f  "],.    layer: O
+0000a2c0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0000a2d0: 6f6e 652c 0a20 2020 2063 6f6c 756d 6e73  one,.    columns
+0000a2e0: 3a20 4f70 7469 6f6e 616c 5b49 7465 7261  : Optional[Itera
+0000a2f0: 626c 655b 7374 725d 5d20 3d20 4e6f 6e65  ble[str]] = None
+0000a300: 2c0a 2020 2020 6262 6f78 3d4e 6f6e 652c  ,.    bbox=None,
+0000a310: 0a20 2020 2072 6f77 733d 4e6f 6e65 2c0a  .    rows=None,.
+0000a320: 2020 2020 7371 6c5f 7374 6d74 3a20 4f70      sql_stmt: Op
+0000a330: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000a340: 6e65 2c0a 2020 2020 7371 6c5f 6469 616c  ne,.    sql_dial
+0000a350: 6563 743a 204f 7074 696f 6e61 6c5b 4c69  ect: Optional[Li
+0000a360: 7465 7261 6c5b 2253 514c 4954 4522 2c20  teral["SQLITE", 
+0000a370: 224f 4752 5351 4c22 5d5d 203d 204e 6f6e  "OGRSQL"]] = Non
+0000a380: 652c 0a20 2020 2069 676e 6f72 655f 6765  e,.    ignore_ge
+0000a390: 6f6d 6574 7279 3a20 626f 6f6c 203d 2046  ometry: bool = F
+0000a3a0: 616c 7365 2c0a 2020 2020 6669 645f 6173  alse,.    fid_as
+0000a3b0: 5f69 6e64 6578 3a20 626f 6f6c 203d 2046  _index: bool = F
+0000a3c0: 616c 7365 2c0a 2920 2d3e 2055 6e69 6f6e  alse,.) -> Union
+0000a3d0: 5b70 642e 4461 7461 4672 616d 652c 2067  [pd.DataFrame, g
+0000a3e0: 7064 2e47 656f 4461 7461 4672 616d 655d  pd.GeoDataFrame]
+0000a3f0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+0000a400: 6164 7320 6120 6669 6c65 2074 6f20 6120  ads a file to a 
+0000a410: 7061 6e64 6173 2044 6174 6166 7261 6d65  pandas Dataframe
+0000a420: 2075 7369 6e67 2070 796f 6772 696f 2e0a   using pyogrio..
+0000a430: 2020 2020 2222 220a 2020 2020 2320 496e      """.    # In
+0000a440: 6974 0a20 2020 2070 6174 6820 3d20 5061  it.    path = Pa
+0000a450: 7468 2870 6174 6829 0a20 2020 2069 6620  th(path).    if 
+0000a460: 7061 7468 2e65 7869 7374 7328 2920 6973  path.exists() is
+0000a470: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+0000a480: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000a490: 2866 2266 696c 6520 646f 6573 6e27 7420  (f"file doesn't 
+0000a4a0: 6578 6973 743a 207b 7061 7468 7d22 290a  exist: {path}").
+0000a4b0: 0a20 2020 2023 2043 6f6e 7665 7274 2073  .    # Convert s
+0000a4c0: 6c69 6365 206f 626a 6563 7420 746f 2070  lice object to p
+0000a4d0: 796f 6772 696f 2070 6172 616d 6574 6572  yogrio parameter
+0000a4e0: 730a 2020 2020 6966 2072 6f77 7320 6973  s.    if rows is
+0000a4f0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000a500: 2020 2073 6b69 705f 6665 6174 7572 6573     skip_features
+0000a510: 203d 2072 6f77 732e 7374 6172 740a 2020   = rows.start.  
+0000a520: 2020 2020 2020 6d61 785f 6665 6174 7572        max_featur
+0000a530: 6573 203d 2072 6f77 732e 7374 6f70 202d  es = rows.stop -
+0000a540: 2072 6f77 732e 7374 6172 740a 2020 2020   rows.start.    
+0000a550: 656c 7365 3a0a 2020 2020 2020 2020 736b  else:.        sk
+0000a560: 6970 5f66 6561 7475 7265 7320 3d20 300a  ip_features = 0.
+0000a570: 2020 2020 2020 2020 6d61 785f 6665 6174          max_feat
+0000a580: 7572 6573 203d 204e 6f6e 650a 0a20 2020  ures = None..   
+0000a590: 2023 2049 6620 6e6f 2073 716c 5f73 746d   # If no sql_stm
+0000a5a0: 7420 7370 6563 6966 6965 640a 2020 2020  t specified.    
+0000a5b0: 636f 6c75 6d6e 735f 7072 6570 6172 6564  columns_prepared
+0000a5c0: 203d 204e 6f6e 650a 2020 2020 6966 2073   = None.    if s
+0000a5d0: 716c 5f73 746d 7420 6973 204e 6f6e 653a  ql_stmt is None:
+0000a5e0: 0a20 2020 2020 2020 2023 2049 6620 6e6f  .        # If no
+0000a5f0: 206c 6179 6572 2073 7065 6369 6669 6564   layer specified
+0000a600: 2c20 7468 6572 6520 7368 6f75 6c64 2062  , there should b
+0000a610: 6520 6f6e 6c79 206f 6e65 206c 6179 6572  e only one layer
+0000a620: 2069 6e20 7468 6520 6669 6c65 2e0a 2020   in the file..  
+0000a630: 2020 2020 2020 6966 206c 6179 6572 2069        if layer i
+0000a640: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000a650: 2020 2020 6c61 7965 7220 3d20 6765 745f      layer = get_
+0000a660: 6f6e 6c79 5f6c 6179 6572 2870 6174 6829  only_layer(path)
+0000a670: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+0000a680: 6b69 6e67 2069 6620 636f 6c75 6d6e 206e  king if column n
+0000a690: 616d 6573 2073 686f 756c 6420 6265 2072  ames should be r
+0000a6a0: 6561 6420 6973 2063 6173 6520 7365 6e73  ead is case sens
+0000a6b0: 6974 6976 6520 696e 2070 796f 6772 696f  itive in pyogrio
+0000a6c0: 2c20 736f 0a20 2020 2020 2020 2023 206d  , so.        # m
+0000a6d0: 616b 6520 7375 7265 2074 6865 2063 6f6c  ake sure the col
+0000a6e0: 756d 6e20 6e61 6d65 7320 7370 6563 6966  umn names specif
+0000a6f0: 6965 6420 6861 7665 2074 6865 2073 616d  ied have the sam
+0000a700: 6520 6361 7369 6e67 2e0a 2020 2020 2020  e casing..      
+0000a710: 2020 6966 2063 6f6c 756d 6e73 2069 7320    if columns is 
+0000a720: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000a730: 2020 2020 2020 6c61 7965 7269 6e66 6f20        layerinfo 
+0000a740: 3d20 6765 745f 6c61 7965 7269 6e66 6f28  = get_layerinfo(
+0000a750: 7061 7468 2c20 6c61 7965 723d 6c61 7965  path, layer=laye
+0000a760: 7229 0a20 2020 2020 2020 2020 2020 2063  r).            c
+0000a770: 6f6c 756d 6e73 5f75 7070 6572 5f6c 6f6f  olumns_upper_loo
+0000a780: 6b75 7020 3d20 7b63 6f6c 756d 6e2e 7570  kup = {column.up
+0000a790: 7065 7228 293a 2063 6f6c 756d 6e20 666f  per(): column fo
+0000a7a0: 7220 636f 6c75 6d6e 2069 6e20 636f 6c75  r column in colu
+0000a7b0: 6d6e 737d 0a20 2020 2020 2020 2020 2020  mns}.           
+0000a7c0: 2063 6f6c 756d 6e73 5f70 7265 7061 7265   columns_prepare
+0000a7d0: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
+0000a7e0: 2020 2020 2020 636f 6c75 6d6e 3a20 636f        column: co
+0000a7f0: 6c75 6d6e 735f 7570 7065 725f 6c6f 6f6b  lumns_upper_look
+0000a800: 7570 5b63 6f6c 756d 6e2e 7570 7065 7228  up[column.upper(
+0000a810: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
+0000a820: 2020 2066 6f72 2063 6f6c 756d 6e20 696e     for column in
+0000a830: 206c 6179 6572 696e 666f 2e63 6f6c 756d   layerinfo.colum
+0000a840: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
+0000a850: 2020 2069 6620 636f 6c75 6d6e 2e75 7070     if column.upp
+0000a860: 6572 2829 2069 6e20 636f 6c75 6d6e 735f  er() in columns_
+0000a870: 7570 7065 725f 6c6f 6f6b 7570 0a20 2020  upper_lookup.   
+0000a880: 2020 2020 2020 2020 207d 0a20 2020 2065           }.    e
+0000a890: 6c73 653a 0a20 2020 2020 2020 2023 2046  lse:.        # F
+0000a8a0: 696c 6c20 6f75 7420 706c 6163 6568 6f6c  ill out placehol
+0000a8b0: 6465 7273 2c20 6b65 6570 2063 6f6c 756d  ders, keep colum
+0000a8c0: 6e73 5f70 7265 7061 7265 6420 4e6f 6e65  ns_prepared None
+0000a8d0: 2062 6563 6175 7365 2063 6f6c 756d 6e20   because column 
+0000a8e0: 6669 6c74 6572 696e 670a 2020 2020 2020  filtering.      
+0000a8f0: 2020 2320 7368 6f75 6c64 2068 6170 7065    # should happe
+0000a900: 6e20 696e 2073 716c 5f73 746d 742e 0a20  n in sql_stmt.. 
+0000a910: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
+0000a920: 3d20 5f66 696c 6c5f 6f75 745f 7371 6c5f  = _fill_out_sql_
+0000a930: 706c 6163 6568 6f6c 6465 7273 280a 2020  placeholders(.  
+0000a940: 2020 2020 2020 2020 2020 7061 7468 3d70            path=p
+0000a950: 6174 682c 206c 6179 6572 3d6c 6179 6572  ath, layer=layer
+0000a960: 2c20 7371 6c5f 7374 6d74 3d73 716c 5f73  , sql_stmt=sql_s
+0000a970: 746d 742c 2063 6f6c 756d 6e73 3d63 6f6c  tmt, columns=col
+0000a980: 756d 6e73 0a20 2020 2020 2020 2029 0a0a  umns.        )..
+0000a990: 2020 2020 2320 5265 6164 210a 2020 2020      # Read!.    
+0000a9a0: 636f 6c75 6d6e 735f 6c69 7374 203d 204e  columns_list = N
+0000a9b0: 6f6e 6520 6966 2063 6f6c 756d 6e73 5f70  one if columns_p
+0000a9c0: 7265 7061 7265 6420 6973 204e 6f6e 6520  repared is None 
+0000a9d0: 656c 7365 206c 6973 7428 636f 6c75 6d6e  else list(column
+0000a9e0: 735f 7072 6570 6172 6564 290a 2020 2020  s_prepared).    
+0000a9f0: 7265 7375 6c74 5f67 6466 203d 2070 796f  result_gdf = pyo
+0000aa00: 6772 696f 2e72 6561 645f 6461 7461 6672  grio.read_datafr
+0000aa10: 616d 6528 0a20 2020 2020 2020 2070 6174  ame(.        pat
+0000aa20: 682c 0a20 2020 2020 2020 206c 6179 6572  h,.        layer
+0000aa30: 3d6c 6179 6572 2c0a 2020 2020 2020 2020  =layer,.        
+0000aa40: 636f 6c75 6d6e 733d 636f 6c75 6d6e 735f  columns=columns_
+0000aa50: 6c69 7374 2c0a 2020 2020 2020 2020 6262  list,.        bb
+0000aa60: 6f78 3d62 626f 782c 0a20 2020 2020 2020  ox=bbox,.       
+0000aa70: 2073 6b69 705f 6665 6174 7572 6573 3d73   skip_features=s
+0000aa80: 6b69 705f 6665 6174 7572 6573 2c0a 2020  kip_features,.  
+0000aa90: 2020 2020 2020 6d61 785f 6665 6174 7572        max_featur
+0000aaa0: 6573 3d6d 6178 5f66 6561 7475 7265 732c  es=max_features,
+0000aab0: 0a20 2020 2020 2020 2073 716c 3d73 716c  .        sql=sql
+0000aac0: 5f73 746d 742c 0a20 2020 2020 2020 2073  _stmt,.        s
+0000aad0: 716c 5f64 6961 6c65 6374 3d73 716c 5f64  ql_dialect=sql_d
+0000aae0: 6961 6c65 6374 2c0a 2020 2020 2020 2020  ialect,.        
+0000aaf0: 7265 6164 5f67 656f 6d65 7472 793d 6e6f  read_geometry=no
+0000ab00: 7420 6967 6e6f 7265 5f67 656f 6d65 7472  t ignore_geometr
+0000ab10: 792c 0a20 2020 2020 2020 2066 6964 5f61  y,.        fid_a
+0000ab20: 735f 696e 6465 783d 6669 645f 6173 5f69  s_index=fid_as_i
+0000ab30: 6e64 6578 2c0a 2020 2020 290a 0a20 2020  ndex,.    )..   
+0000ab40: 2023 2052 656f 7264 6572 2063 6f6c 756d   # Reorder colum
+0000ab50: 6e73 202b 2063 6861 6e67 6520 6361 7369  ns + change casi
+0000ab60: 6e67 2073 6f20 7468 6579 2061 7265 2074  ng so they are t
+0000ab70: 6865 2073 616d 6520 6173 2063 6f6c 756d  he same as colum
+0000ab80: 6e73 2070 6172 616d 6574 6572 0a20 2020  ns parameter.   
+0000ab90: 2069 6620 636f 6c75 6d6e 735f 7072 6570   if columns_prep
+0000aba0: 6172 6564 2069 7320 6e6f 7420 4e6f 6e65  ared is not None
+0000abb0: 2061 6e64 206c 656e 2863 6f6c 756d 6e73   and len(columns
+0000abc0: 5f70 7265 7061 7265 6429 203e 2030 3a0a  _prepared) > 0:.
+0000abd0: 2020 2020 2020 2020 7265 7375 6c74 5f67          result_g
+0000abe0: 6466 203d 2072 6573 756c 745f 6764 665b  df = result_gdf[
+0000abf0: 6c69 7374 2863 6f6c 756d 6e73 5f70 7265  list(columns_pre
+0000ac00: 7061 7265 6429 202b 205b 2267 656f 6d65  pared) + ["geome
+0000ac10: 7472 7922 5d5d 0a20 2020 2020 2020 2072  try"]].        r
+0000ac20: 6573 756c 745f 6764 6620 3d20 7265 7375  esult_gdf = resu
+0000ac30: 6c74 5f67 6466 2e72 656e 616d 6528 636f  lt_gdf.rename(co
+0000ac40: 6c75 6d6e 733d 636f 6c75 6d6e 735f 7072  lumns=columns_pr
+0000ac50: 6570 6172 6564 2920 2023 2074 7970 653a  epared)  # type:
+0000ac60: 2069 676e 6f72 650a 0a20 2020 2023 2061   ignore..    # a
+0000ac70: 7373 6572 7420 746f 2065 7661 6465 2070  ssert to evade p
+0000ac80: 794c 616e 6365 2077 6172 6e69 6e67 0a20  yLance warning. 
+0000ac90: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0000aca0: 616e 6365 2872 6573 756c 745f 6764 662c  ance(result_gdf,
+0000acb0: 2070 642e 4461 7461 4672 616d 6529 206f   pd.DataFrame) o
+0000acc0: 7220 6973 696e 7374 616e 6365 280a 2020  r isinstance(.  
+0000acd0: 2020 2020 2020 7265 7375 6c74 5f67 6466        result_gdf
+0000ace0: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
+0000acf0: 6d65 0a20 2020 2029 0a20 2020 2072 6574  me.    ).    ret
+0000ad00: 7572 6e20 7265 7375 6c74 5f67 6466 0a0a  urn result_gdf..
+0000ad10: 0a64 6566 205f 6669 6c6c 5f6f 7574 5f73  .def _fill_out_s
+0000ad20: 716c 5f70 6c61 6365 686f 6c64 6572 7328  ql_placeholders(
+0000ad30: 0a20 2020 2070 6174 683a 2050 6174 682c  .    path: Path,
+0000ad40: 206c 6179 6572 3a20 4f70 7469 6f6e 616c   layer: Optional
+0000ad50: 5b73 7472 5d2c 2073 716c 5f73 746d 743a  [str], sql_stmt:
+0000ad60: 2073 7472 2c20 636f 6c75 6d6e 733a 204f   str, columns: O
+0000ad70: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
+0000ad80: 5b73 7472 5d5d 0a29 202d 3e20 7374 723a  [str]].) -> str:
+0000ad90: 0a20 2020 2023 2046 696c 6c20 6f75 7420  .    # Fill out 
+0000ada0: 706c 6163 6568 6f6c 6465 7273 2069 6e20  placeholders in 
+0000adb0: 7468 6520 7371 6c5f 7374 6d74 2069 6620  the sql_stmt if 
+0000adc0: 6e65 6564 6564 3a0a 2020 2020 706c 6163  needed:.    plac
+0000add0: 6568 6f6c 6465 7273 203d 205b 0a20 2020  eholders = [.   
+0000ade0: 2020 2020 206e 616d 6520 666f 7220 5f2c       name for _,
+0000adf0: 206e 616d 652c 205f 2c20 5f20 696e 2073   name, _, _ in s
+0000ae00: 7472 696e 672e 466f 726d 6174 7465 7228  tring.Formatter(
+0000ae10: 292e 7061 7273 6528 7371 6c5f 7374 6d74  ).parse(sql_stmt
+0000ae20: 2920 6966 206e 616d 650a 2020 2020 5d0a  ) if name.    ].
+0000ae30: 2020 2020 6c61 7965 725f 746d 7020 3d20      layer_tmp = 
+0000ae40: 6c61 7965 720a 2020 2020 6c61 7965 7269  layer.    layeri
+0000ae50: 6e66 6f20 3d20 4e6f 6e65 0a20 2020 2066  nfo = None.    f
+0000ae60: 6f72 6d61 745f 6b77 6172 6773 203d 207b  ormat_kwargs = {
+0000ae70: 7d0a 2020 2020 666f 7220 706c 6163 6568  }.    for placeh
+0000ae80: 6f6c 6465 7220 696e 2070 6c61 6365 686f  older in placeho
+0000ae90: 6c64 6572 733a 0a20 2020 2020 2020 2069  lders:.        i
+0000aea0: 6620 6c61 7965 725f 746d 7020 6973 204e  f layer_tmp is N
+0000aeb0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000aec0: 206c 6179 6572 5f74 6d70 203d 2067 6574   layer_tmp = get
+0000aed0: 5f6f 6e6c 795f 6c61 7965 7228 7061 7468  _only_layer(path
+0000aee0: 290a 2020 2020 2020 2020 6966 2070 6c61  ).        if pla
+0000aef0: 6365 686f 6c64 6572 203d 3d20 2269 6e70  ceholder == "inp
+0000af00: 7574 5f6c 6179 6572 223a 0a20 2020 2020  ut_layer":.     
+0000af10: 2020 2020 2020 2066 6f72 6d61 745f 6b77         format_kw
+0000af20: 6172 6773 5b70 6c61 6365 686f 6c64 6572  args[placeholder
+0000af30: 5d20 3d20 6c61 7965 725f 746d 700a 2020  ] = layer_tmp.  
+0000af40: 2020 2020 2020 656c 6966 2070 6c61 6365        elif place
+0000af50: 686f 6c64 6572 203d 3d20 2267 656f 6d65  holder == "geome
+0000af60: 7472 7963 6f6c 756d 6e22 3a0a 2020 2020  trycolumn":.    
+0000af70: 2020 2020 2020 2020 6966 206c 6179 6572          if layer
+0000af80: 696e 666f 2069 7320 4e6f 6e65 3a0a 2020  info is None:.  
+0000af90: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0000afa0: 7965 7269 6e66 6f20 3d20 6765 745f 6c61  yerinfo = get_la
+0000afb0: 7965 7269 6e66 6f28 7061 7468 2c20 6c61  yerinfo(path, la
+0000afc0: 7965 725f 746d 7029 0a20 2020 2020 2020  yer_tmp).       
+0000afd0: 2020 2020 2066 6f72 6d61 745f 6b77 6172       format_kwar
+0000afe0: 6773 5b70 6c61 6365 686f 6c64 6572 5d20  gs[placeholder] 
+0000aff0: 3d20 6c61 7965 7269 6e66 6f2e 6765 6f6d  = layerinfo.geom
+0000b000: 6574 7279 636f 6c75 6d6e 0a20 2020 2020  etrycolumn.     
+0000b010: 2020 2065 6c69 6620 706c 6163 6568 6f6c     elif placehol
+0000b020: 6465 7220 3d3d 2022 636f 6c75 6d6e 735f  der == "columns_
+0000b030: 746f 5f73 656c 6563 745f 7374 7222 3a0a  to_select_str":.
+0000b040: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0000b050: 6179 6572 696e 666f 2069 7320 4e6f 6e65  ayerinfo is None
+0000b060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b070: 2020 6c61 7965 7269 6e66 6f20 3d20 6765    layerinfo = ge
+0000b080: 745f 6c61 7965 7269 6e66 6f28 7061 7468  t_layerinfo(path
+0000b090: 2c20 6c61 7965 725f 746d 7029 0a20 2020  , layer_tmp).   
+0000b0a0: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
+0000b0b0: 5f61 736b 6564 203d 204e 6f6e 6520 6966  _asked = None if
+0000b0c0: 2063 6f6c 756d 6e73 2069 7320 4e6f 6e65   columns is None
+0000b0d0: 2065 6c73 6520 6c69 7374 2863 6f6c 756d   else list(colum
+0000b0e0: 6e73 290a 2020 2020 2020 2020 2020 2020  ns).            
+0000b0f0: 666f 726d 6174 7465 7220 3d20 5f6f 6772  formatter = _ogr
+0000b100: 5f73 716c 5f75 7469 6c2e 436f 6c75 6d6e  _sql_util.Column
+0000b110: 466f 726d 6174 7465 7228 0a20 2020 2020  Formatter(.     
+0000b120: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+0000b130: 6e73 5f61 736b 6564 3d63 6f6c 756d 6e73  ns_asked=columns
+0000b140: 5f61 736b 6564 2c0a 2020 2020 2020 2020  _asked,.        
+0000b150: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+0000b160: 696e 5f6c 6179 6572 3d6c 6179 6572 696e  in_layer=layerin
+0000b170: 666f 2e63 6f6c 756d 6e73 2c0a 2020 2020  fo.columns,.    
+0000b180: 2020 2020 2020 2020 2020 2020 6669 645f              fid_
+0000b190: 636f 6c75 6d6e 3d6c 6179 6572 696e 666f  column=layerinfo
+0000b1a0: 2e66 6964 5f63 6f6c 756d 6e2c 0a20 2020  .fid_column,.   
+0000b1b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000b1c0: 2020 2020 2020 2066 6f72 6d61 745f 6b77         format_kw
+0000b1d0: 6172 6773 5b70 6c61 6365 686f 6c64 6572  args[placeholder
+0000b1e0: 5d20 3d20 666f 726d 6174 7465 722e 7072  ] = formatter.pr
+0000b1f0: 6566 6978 6564 5f61 6c69 6173 6564 2829  efixed_aliased()
+0000b200: 0a0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
+0000b210: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000b220: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+0000b230: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000b240: 756e 6b6e 6f77 6e20 706c 6163 6568 6f6c  unknown placehol
+0000b250: 6465 7220 7b70 6c61 6365 686f 6c64 6572  der {placeholder
+0000b260: 7d20 696e 2073 716c 5f73 746d 743a 207b  } in sql_stmt: {
+0000b270: 7371 6c5f 7374 6d74 7d22 0a20 2020 2020  sql_stmt}".     
+0000b280: 2020 2020 2020 2029 0a0a 2020 2020 6966         )..    if
+0000b290: 206c 656e 2866 6f72 6d61 745f 6b77 6172   len(format_kwar
+0000b2a0: 6773 2920 3e20 303a 0a20 2020 2020 2020  gs) > 0:.       
+0000b2b0: 2073 716c 5f73 746d 7420 3d20 7371 6c5f   sql_stmt = sql_
+0000b2c0: 7374 6d74 2e66 6f72 6d61 7428 2a2a 666f  stmt.format(**fo
+0000b2d0: 726d 6174 5f6b 7761 7267 7329 0a20 2020  rmat_kwargs).   
+0000b2e0: 2072 6574 7572 6e20 7371 6c5f 7374 6d74   return sql_stmt
+0000b2f0: 0a0a 0a64 6566 2072 6561 645f 6669 6c65  ...def read_file
+0000b300: 5f73 716c 280a 2020 2020 7061 7468 3a20  _sql(.    path: 
+0000b310: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+0000b320: 6174 684c 696b 655b 416e 795d 225d 2c0a  athLike[Any]"],.
+0000b330: 2020 2020 7371 6c5f 7374 6d74 3a20 7374      sql_stmt: st
+0000b340: 722c 0a20 2020 2073 716c 5f64 6961 6c65  r,.    sql_diale
+0000b350: 6374 3a20 4f70 7469 6f6e 616c 5b4c 6974  ct: Optional[Lit
+0000b360: 6572 616c 5b22 5351 4c49 5445 222c 2022  eral["SQLITE", "
+0000b370: 4f47 5253 514c 225d 5d20 3d20 2253 514c  OGRSQL"]] = "SQL
+0000b380: 4954 4522 2c0a 2020 2020 6c61 7965 723a  ITE",.    layer:
+0000b390: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+0000b3a0: 204e 6f6e 652c 0a20 2020 2069 676e 6f72   None,.    ignor
+0000b3b0: 655f 6765 6f6d 6574 7279 3a20 626f 6f6c  e_geometry: bool
+0000b3c0: 203d 2046 616c 7365 2c0a 2920 2d3e 2055   = False,.) -> U
+0000b3d0: 6e69 6f6e 5b70 642e 4461 7461 4672 616d  nion[pd.DataFram
+0000b3e0: 652c 2067 7064 2e47 656f 4461 7461 4672  e, gpd.GeoDataFr
+0000b3f0: 616d 655d 3a0a 2020 2020 2222 220a 2020  ame]:.    """.  
+0000b400: 2020 4445 5052 4543 4154 4544 3a20 5265    DEPRECATED: Re
+0000b410: 6164 7320 6120 6669 6c65 2075 7369 6e67  ads a file using
+0000b420: 2061 6e20 7371 6c20 7374 6174 656d 656e   an sql statemen
+0000b430: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
+0000b440: 2020 2020 2020 7061 7468 2028 6669 6c65        path (file
+0000b450: 2070 6174 6829 3a20 7061 7468 2074 6f20   path): path to 
+0000b460: 7468 6520 6669 6c65 2074 6f20 7265 6164  the file to read
+0000b470: 2066 726f 6d0a 2020 2020 2020 2020 7371   from.        sq
+0000b480: 6c5f 7374 6d74 2028 7374 7229 3a20 7371  l_stmt (str): sq
+0000b490: 6c20 7374 6174 656d 656e 7420 746f 2075  l statement to u
+0000b4a0: 7365 0a20 2020 2020 2020 2073 716c 5f64  se.        sql_d
+0000b4b0: 6961 6c65 6374 2028 7374 722c 206f 7074  ialect (str, opt
+0000b4c0: 696f 6e61 6c29 3a20 5371 6c20 6469 616c  ional): Sql dial
+0000b4d0: 6563 7420 7573 6564 2e20 4465 6661 756c  ect used. Defaul
+0000b4e0: 7473 2074 6f20 2753 514c 4954 4527 2e0a  ts to 'SQLITE'..
+0000b4f0: 2020 2020 2020 2020 6c61 7965 7220 2873          layer (s
+0000b500: 7472 2c20 6f70 7469 6f6e 616c 293a 2054  tr, optional): T
+0000b510: 6865 206c 6179 6572 2074 6f20 7265 6164  he layer to read
+0000b520: 2e20 4966 206e 6f20 6c61 7965 7220 6973  . If no layer is
+0000b530: 2073 7065 6369 6669 6564 2c0a 2020 2020   specified,.    
+0000b540: 2020 2020 2020 2020 7265 6164 7320 7468          reads th
+0000b550: 6520 6f6e 6c79 206c 6179 6572 2069 6e20  e only layer in 
+0000b560: 7468 6520 6669 6c65 206f 7220 7468 726f  the file or thro
+0000b570: 7773 2061 6e20 4578 6365 7074 696f 6e2e  ws an Exception.
+0000b580: 0a20 2020 2020 2020 2069 676e 6f72 655f  .        ignore_
+0000b590: 6765 6f6d 6574 7279 2028 626f 6f6c 2c20  geometry (bool, 
+0000b5a0: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
+0000b5b0: 6e6f 7420 746f 2072 6561 642f 7265 7475  not to read/retu
+0000b5c0: 726e 2074 6865 2067 656f 6d61 7472 792e  rn the geomatry.
+0000b5d0: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
+0000b5e0: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
+0000b5f0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0000b600: 2020 2020 2020 556e 696f 6e5b 7064 2e44        Union[pd.D
+0000b610: 6174 6146 7261 6d65 2c20 6770 642e 4765  ataFrame, gpd.Ge
+0000b620: 6f44 6174 6146 7261 6d65 5d3a 2054 6865  oDataFrame]: The
+0000b630: 2064 6174 6120 7265 6164 2e0a 2020 2020   data read..    
+0000b640: 2222 220a 2020 2020 7761 726e 696e 6773  """.    warnings
+0000b650: 2e77 6172 6e28 0a20 2020 2020 2020 2027  .warn(.        '
+0000b660: 7265 6164 5f66 696c 655f 7371 6c20 6973  read_file_sql is
+0000b670: 2064 6570 7265 6361 7465 643a 2075 7365   deprecated: use
+0000b680: 2072 6561 645f 6669 6c65 2120 4d69 6e64   read_file! Mind
+0000b690: 3a20 7371 6c5f 6469 616c 6563 7420 6973  : sql_dialect is
+0000b6a0: 206e 6f74 2022 5351 4c49 5445 2220 270a   not "SQLITE" '.
+0000b6b0: 2020 2020 2020 2020 2262 7920 6465 6661          "by defa
+0000b6c0: 756c 7420 7468 6572 6521 222c 0a20 2020  ult there!",.   
+0000b6d0: 2020 2020 2046 7574 7572 6557 6172 6e69       FutureWarni
+0000b6e0: 6e67 2c0a 2020 2020 290a 0a20 2020 2023  ng,.    )..    #
+0000b6f0: 2052 756e 0a20 2020 2072 6574 7572 6e20   Run.    return 
+0000b700: 5f72 6561 645f 6669 6c65 5f62 6173 6528  _read_file_base(
+0000b710: 0a20 2020 2020 2020 2070 6174 682c 0a20  .        path,. 
+0000b720: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
+0000b730: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
+0000b740: 2020 7371 6c5f 6469 616c 6563 743d 7371    sql_dialect=sq
+0000b750: 6c5f 6469 616c 6563 742c 0a20 2020 2020  l_dialect,.     
+0000b760: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+0000b770: 2020 2020 2020 2020 6967 6e6f 7265 5f67          ignore_g
+0000b780: 656f 6d65 7472 793d 6967 6e6f 7265 5f67  eometry=ignore_g
+0000b790: 656f 6d65 7472 792c 0a20 2020 2029 0a0a  eometry,.    )..
+0000b7a0: 0a64 6566 2074 6f5f 6669 6c65 280a 2020  .def to_file(.  
+0000b7b0: 2020 6764 663a 2055 6e69 6f6e 5b70 642e    gdf: Union[pd.
+0000b7c0: 4461 7461 4672 616d 652c 2067 7064 2e47  DataFrame, gpd.G
+0000b7d0: 656f 4461 7461 4672 616d 655d 2c0a 2020  eoDataFrame],.  
+0000b7e0: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
+0000b7f0: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
+0000b800: 416e 795d 225d 2c0a 2020 2020 6c61 7965  Any]"],.    laye
+0000b810: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0000b820: 203d 204e 6f6e 652c 0a20 2020 2066 6f72   = None,.    for
+0000b830: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000b840: 7279 7479 7065 3a20 556e 696f 6e5b 4765  rytype: Union[Ge
+0000b850: 6f6d 6574 7279 5479 7065 2c20 7374 722c  ometryType, str,
+0000b860: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
+0000b870: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
+0000b880: 7065 3a20 626f 6f6c 203d 2046 616c 7365  pe: bool = False
+0000b890: 2c0a 2020 2020 6170 7065 6e64 3a20 626f  ,.    append: bo
+0000b8a0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0000b8b0: 6170 7065 6e64 5f74 696d 656f 7574 5f73  append_timeout_s
+0000b8c0: 3a20 696e 7420 3d20 3630 302c 0a20 2020  : int = 600,.   
+0000b8d0: 2069 6e64 6578 3a20 4f70 7469 6f6e 616c   index: Optional
+0000b8e0: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000b8f0: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
+0000b900: 6c5f 696e 6465 783a 204f 7074 696f 6e61  l_index: Optiona
+0000b910: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
+0000b920: 293a 0a20 2020 2022 2222 0a20 2020 2057  ):.    """.    W
+0000b930: 7269 7465 7320 6120 7061 6e64 6173 2064  rites a pandas d
+0000b940: 6174 6166 7261 6d65 2074 6f20 6669 6c65  ataframe to file
+0000b950: 2e0a 0a20 2020 2054 6865 2066 696c 6566  ...    The filef
+0000b960: 6f72 6d61 7420 6973 2064 6574 6563 7465  ormat is detecte
+0000b970: 6420 6261 7365 6420 6f6e 2074 6865 2066  d based on the f
+0000b980: 696c 6570 6174 6820 6578 7465 6e73 696f  ilepath extensio
+0000b990: 6e2e 0a0a 2020 2020 5468 6520 756e 6465  n...    The unde
+0000b9a0: 726c 7969 6e67 206c 6962 7261 7279 2075  rlying library u
+0000b9b0: 7365 6420 746f 2077 7269 7465 2074 6865  sed to write the
+0000b9c0: 2066 696c 6520 6361 6e20 6265 2063 686f   file can be cho
+0000b9d0: 6f73 656e 2075 7369 6e67 2074 6865 0a20  osen using the. 
+0000b9e0: 2020 2022 4746 4f5f 494f 5f45 4e47 494e     "GFO_IO_ENGIN
+0000b9f0: 4522 2065 6e76 6972 6f6e 6d65 6e74 2076  E" environment v
+0000ba00: 6172 6961 626c 652e 2050 6f73 7369 626c  ariable. Possibl
+0000ba10: 6520 7661 6c75 6573 2061 7265 2022 6669  e values are "fi
+0000ba20: 6f6e 6122 2061 6e64 2022 7079 6f67 7269  ona" and "pyogri
+0000ba30: 6f22 2e0a 2020 2020 4465 6661 756c 7420  o"..    Default 
+0000ba40: 656e 6769 6e65 2069 7320 2270 796f 6772  engine is "pyogr
+0000ba50: 696f 222e 0a0a 2020 2020 4172 6773 3a0a  io"...    Args:.
+0000ba60: 2020 2020 2020 2020 6764 6620 2867 7064          gdf (gpd
+0000ba70: 2e47 656f 4461 7461 4672 616d 6529 3a20  .GeoDataFrame): 
+0000ba80: 5468 6520 4765 6f44 6174 6146 7261 6d65  The GeoDataFrame
+0000ba90: 2074 6f20 6578 706f 7274 2074 6f20 6669   to export to fi
+0000baa0: 6c65 2e0a 2020 2020 2020 2020 7061 7468  le..        path
+0000bab0: 2028 556e 696f 6e5b 7374 722c 293a 2054   (Union[str,): T
+0000bac0: 6865 2066 696c 6520 7061 7468 2074 6f20  he file path to 
+0000bad0: 7772 6974 6520 746f 2e0a 2020 2020 2020  write to..      
+0000bae0: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
+0000baf0: 7469 6f6e 616c 293a 2054 6865 206c 6179  tional): The lay
+0000bb00: 6572 2074 6f20 7265 6164 2e20 4966 206e  er to read. If n
+0000bb10: 6f20 6c61 7965 7220 6973 2073 7065 6369  o layer is speci
+0000bb20: 6669 6564 2c0a 2020 2020 2020 2020 2020  fied,.          
+0000bb30: 2020 7265 6164 7320 7468 6520 6f6e 6c79    reads the only
+0000bb40: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
+0000bb50: 6c65 206f 7220 7468 726f 7773 2061 6e20  le or throws an 
+0000bb60: 4578 6365 7074 696f 6e2e 0a20 2020 2020  Exception..     
+0000bb70: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
+0000bb80: 6765 6f6d 6574 7279 7479 7065 2028 556e  geometrytype (Un
+0000bb90: 696f 6e5b 4765 6f6d 6574 7279 5479 7065  ion[GeometryType
+0000bba0: 2c20 7374 725d 2c20 6f70 7469 6f6e 616c  , str], optional
+0000bbb0: 293a 2047 656f 6d65 7472 7920 7479 7065  ): Geometry type
+0000bbc0: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
+0000bbd0: 2874 7279 2074 6f29 2066 6f72 6365 2074  (try to) force t
+0000bbe0: 6865 206f 7574 7075 7420 746f 2e20 4465  he output to. De
+0000bbf0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+0000bc00: 2020 2020 2020 2020 2020 2020 4d61 726b              Mark
+0000bc10: 3a20 636f 6d70 6172 6564 2074 6f20 6f74  : compared to ot
+0000bc20: 6865 7220 6675 6e63 7469 6f6e 7320 696e  her functions in
+0000bc30: 2067 666f 2077 6974 6820 7468 6973 2070   gfo with this p
+0000bc40: 6172 616d 6574 6572 2c20 7468 6520 6265  arameter, the be
+0000bc50: 6861 7669 6f75 720a 2020 2020 2020 2020  haviour.        
+0000bc60: 2020 2020 6865 7265 2069 7320 6c69 6d69      here is limi
+0000bc70: 7465 6420 746f 2074 6865 2066 6f6c 6c6f  ted to the follo
+0000bc80: 7769 6e67 3a0a 2020 2020 2020 2020 2020  wing:.          
+0000bc90: 2020 2020 2020 2d20 666f 7220 656d 7074        - for empt
+0000bca0: 7920 696e 7075 7420 6764 6627 732c 2061  y input gdf's, a
+0000bcb0: 2073 7461 6e64 6172 6420 6765 6f6d 6574   standard geomet
+0000bcc0: 7279 2074 7970 6520 2865 672e 2050 6f6c  ry type (eg. Pol
+0000bcd0: 7967 6f6e 2c2e 2e2e 2920 6361 6e0a 2020  ygon,...) can.  
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 6265 2075 7365 6420 746f 2066 6f72 6365  be used to force
+0000bd00: 2074 6865 2067 656f 6d65 7472 7920 636f   the geometry co
+0000bd10: 6c75 6d6e 2074 6f20 6265 206f 6620 7468  lumn to be of th
+0000bd20: 6174 2074 7970 652e 0a20 2020 2020 2020  at type..       
+0000bd30: 2020 2020 2020 2020 202d 2069 6620 666f           - if fo
+0000bd40: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+0000bd50: 7472 7974 7970 6520 6973 2061 204d 554c  trytype is a MUL
+0000bd60: 5449 2074 7970 652c 2070 6172 616d 6574  TI type, paramet
+0000bd70: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0000bd80: 2020 2020 2066 6f72 6365 5f6d 756c 7469       force_multi
+0000bd90: 7479 7065 2062 6563 6f6d 6573 2054 7275  type becomes Tru
+0000bda0: 652e 0a20 2020 2020 2020 2066 6f72 6365  e..        force
+0000bdb0: 5f6d 756c 7469 7479 7065 2028 626f 6f6c  _multitype (bool
+0000bdc0: 2c20 6f70 7469 6f6e 616c 293a 2066 6f72  , optional): for
+0000bdd0: 6365 2074 6865 2067 656f 6d65 7472 7920  ce the geometry 
+0000bde0: 7479 7065 2074 6f20 6120 6d75 6c74 6974  type to a multit
+0000bdf0: 7970 650a 2020 2020 2020 2020 2020 2020  ype.            
+0000be00: 666f 7220 6669 6c65 2074 7970 6573 2074  for file types t
+0000be10: 6861 7420 7265 7175 6972 6520 6f6e 6520  hat require one 
+0000be20: 6765 6f6d 6574 7279 7479 7065 2070 6572  geometrytype per
+0000be30: 206c 6179 6572 2e0a 2020 2020 2020 2020   layer..        
+0000be40: 2020 2020 4465 6661 756c 7473 2074 6f20      Defaults to 
+0000be50: 4661 6c73 652e 0a20 2020 2020 2020 2061  False..        a
+0000be60: 7070 656e 6420 2862 6f6f 6c2c 206f 7074  ppend (bool, opt
+0000be70: 696f 6e61 6c29 3a20 5472 7565 2074 6f20  ional): True to 
+0000be80: 6170 7065 6e64 2074 6f20 7468 6520 6669  append to the fi
+0000be90: 6c65 2f6c 6179 6572 2069 6620 6974 2065  le/layer if it e
+0000bea0: 7869 7374 7320 616c 7265 6164 792e 0a20  xists already.. 
+0000beb0: 2020 2020 2020 2020 2020 2049 6620 6974             If it
+0000bec0: 2064 6f65 736e 2774 2065 7869 7374 2079   doesn't exist y
+0000bed0: 6574 2c20 6974 2069 7320 6372 6561 7465  et, it is create
+0000bee0: 642e 2044 6566 6175 6c74 7320 746f 2046  d. Defaults to F
+0000bef0: 616c 7365 2e0a 2020 2020 2020 2020 6170  alse..        ap
+0000bf00: 7065 6e64 5f74 696d 656f 7574 5f73 2028  pend_timeout_s (
+0000bf10: 696e 742c 206f 7074 696f 6e61 6c29 3a20  int, optional): 
+0000bf20: 5468 6520 6d61 7869 6d75 6d20 7469 6d65  The maximum time
+0000bf30: 6f75 7420 746f 2077 6169 7420 7768 656e  out to wait when
+0000bf40: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0000bf50: 206f 7574 7075 7420 6669 6c65 2069 7320   output file is 
+0000bf60: 616c 7265 6164 7920 6265 696e 6720 7772  already being wr
+0000bf70: 6974 7465 6e20 746f 2062 7920 616e 6f74  itten to by anot
+0000bf80: 6865 7220 7072 6f63 6573 732e 0a20 2020  her process..   
+0000bf90: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
+0000bfa0: 7320 746f 2036 3030 2e0a 2020 2020 2020  s to 600..      
+0000bfb0: 2020 696e 6465 7820 2862 6f6f 6c2c 206f    index (bool, o
+0000bfc0: 7074 696f 6e61 6c29 3a20 4966 2054 7275  ptional): If Tru
+0000bfd0: 652c 2077 7269 7465 2069 6e64 6578 2069  e, write index i
+0000bfe0: 6e74 6f20 6f6e 6520 6f72 206d 6f72 6520  nto one or more 
+0000bff0: 636f 6c75 6d6e 7320 2866 6f72 0a20 2020  columns (for.   
+0000c000: 2020 2020 2020 2020 204d 756c 7469 496e           MultiIn
+0000c010: 6465 7829 2e20 4e6f 6e65 2077 7269 7465  dex). None write
+0000c020: 7320 7468 6520 696e 6465 7820 696e 746f  s the index into
+0000c030: 206f 6e65 206f 7220 6d6f 7265 2063 6f6c   one or more col
+0000c040: 756d 6e73 206f 6e6c 7920 6966 2074 6865  umns only if the
+0000c050: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+0000c060: 6578 2069 7320 6e61 6d65 642c 2069 7320  ex is named, is 
+0000c070: 6120 4d75 6c74 6949 6e64 6578 2c20 6f72  a MultiIndex, or
+0000c080: 2068 6173 2061 206e 6f6e 2d69 6e74 6567   has a non-integ
+0000c090: 6572 2064 6174 6120 7479 7065 2e0a 2020  er data type..  
+0000c0a0: 2020 2020 2020 2020 2020 4966 2046 616c            If Fal
+0000c0b0: 7365 2c20 6e6f 2069 6e64 6578 2069 7320  se, no index is 
+0000c0c0: 7772 6974 7465 6e2e 2044 6566 6175 6c74  written. Default
+0000c0d0: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+0000c0e0: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
+0000c0f0: 6c5f 696e 6465 7820 2862 6f6f 6c2c 206f  l_index (bool, o
+0000c100: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
+0000c110: 6f20 666f 7263 6520 6372 6561 7469 6f6e  o force creation
+0000c120: 206f 6620 7370 6174 6961 6c20 696e 6465   of spatial inde
+0000c130: 782c 0a20 2020 2020 2020 2020 2020 2046  x,.            F
+0000c140: 616c 7365 2074 6f20 6176 6f69 6420 6372  alse to avoid cr
+0000c150: 6561 7469 6f6e 2e20 4e6f 6e65 206c 6561  eation. None lea
+0000c160: 6473 2074 6f20 7468 6520 6465 6661 756c  ds to the defaul
+0000c170: 7420 6265 6861 7669 6f75 7220 6f66 2067  t behaviour of g
+0000c180: 6461 6c2e 0a20 2020 2020 2020 2020 2020  dal..           
+0000c190: 2044 6566 6175 6c74 7320 746f 2054 7275   Defaults to Tru
+0000c1a0: 652e 0a0a 2020 2020 5261 6973 6573 3a0a  e...    Raises:.
+0000c1b0: 2020 2020 2020 2020 5661 6c75 6545 7272          ValueErr
+0000c1c0: 6f72 3a20 616e 2069 6e76 616c 6964 2070  or: an invalid p
+0000c1d0: 6172 616d 6574 6572 2076 616c 7565 2077  arameter value w
+0000c1e0: 6173 2070 6173 7365 642e 0a20 2020 2020  as passed..     
+0000c1f0: 2020 2052 756e 7469 6d65 4572 726f 723a     RuntimeError:
+0000c200: 2074 696d 656f 7574 2077 6173 2072 6561   timeout was rea
+0000c210: 6368 6564 2077 6869 6c65 2074 7279 696e  ched while tryin
+0000c220: 6720 746f 2061 7070 656e 6420 6461 7461  g to append data
+0000c230: 2074 6f20 7061 7468 2e0a 2020 2020 2222   to path..    ""
+0000c240: 220a 2020 2020 2320 4368 6563 6b20 696e  ".    # Check in
+0000c250: 7075 7420 7061 7261 6d65 7465 7273 0a20  put parameters. 
+0000c260: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d     # -----------
+0000c270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0000c280: 7061 7468 203d 2050 6174 6828 7061 7468  path = Path(path
+0000c290: 290a 0a20 2020 2023 2049 6620 6e6f 206c  )..    # If no l
+0000c2a0: 6179 6572 206e 616d 6520 7370 6563 6966  ayer name specif
+0000c2b0: 6965 642c 2064 6574 6572 6d69 6e65 206f  ied, determine o
+0000c2c0: 6e65 0a20 2020 2069 6620 6c61 7965 7220  ne.    if layer 
+0000c2d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000c2e0: 2069 6620 6170 7065 6e64 2061 6e64 2070   if append and p
+0000c2f0: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
+0000c300: 2020 2020 2020 2020 2020 6c61 7965 7220            layer 
+0000c310: 3d20 6765 745f 6f6e 6c79 5f6c 6179 6572  = get_only_layer
+0000c320: 2870 6174 6829 0a20 2020 2020 2020 2065  (path).        e
+0000c330: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000c340: 206c 6179 6572 203d 2050 6174 6828 7061   layer = Path(pa
+0000c350: 7468 292e 7374 656d 0a0a 2020 2020 2320  th).stem..    # 
+0000c360: 4966 2066 6f72 6365 5f6f 7574 7075 745f  If force_output_
+0000c370: 6765 6f6d 6574 7279 7479 7065 2069 7320  geometrytype is 
+0000c380: 6120 7374 7269 6e67 2c20 6368 6563 6b20  a string, check 
+0000c390: 6966 2069 7420 6973 2061 2022 7374 616e  if it is a "stan
+0000c3a0: 6461 7264 2220 6765 6f6d 6574 7279 0a20  dard" geometry. 
+0000c3b0: 2020 2023 2074 7970 652c 2061 7320 4744     # type, as GD
+0000c3c0: 414c 2061 6c73 6f20 7375 7070 6f72 7473  AL also supports
+0000c3d0: 2073 7065 6369 616c 2067 656f 6d65 7472   special geometr
+0000c3e0: 7920 7479 7065 7320 6c69 6b65 2022 5052  y types like "PR
+0000c3f0: 4f4d 4f54 455f 544f 5f4d 554c 5449 220a  OMOTE_TO_MULTI".
+0000c400: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000c410: 6528 666f 7263 655f 6f75 7470 7574 5f67  e(force_output_g
+0000c420: 656f 6d65 7472 7974 7970 652c 2073 7472  eometrytype, str
+0000c430: 293a 0a20 2020 2020 2020 2066 6f72 6365  ):.        force
+0000c440: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000c450: 7479 7065 203d 2066 6f72 6365 5f6f 7574  type = force_out
+0000c460: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+0000c470: 2e75 7070 6572 2829 0a20 2020 2020 2020  .upper().       
+0000c480: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000c490: 2020 2320 5665 7269 6679 2069 6620 6974    # Verify if it
+0000c4a0: 2069 7320 6120 2273 7461 6e64 6172 6422   is a "standard"
+0000c4b0: 2067 656f 6d65 7472 7920 7479 7065 2c20   geometry type, 
+0000c4c0: 6173 2047 4441 4c20 616c 736f 2073 7570  as GDAL also sup
+0000c4d0: 706f 7274 730a 2020 2020 2020 2020 2020  ports.          
+0000c4e0: 2020 2320 7370 6563 6961 6c20 6765 6f6d    # special geom
+0000c4f0: 6574 7279 2074 7970 6573 206c 696b 6520  etry types like 
+0000c500: 2250 524f 4d4f 5445 5f54 4f5f 4d55 4c54  "PROMOTE_TO_MULT
+0000c510: 4922 0a20 2020 2020 2020 2020 2020 2066  I".            f
+0000c520: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+0000c530: 6574 7279 7479 7065 203d 2047 656f 6d65  etrytype = Geome
+0000c540: 7472 7954 7970 655b 666f 7263 655f 6f75  tryType[force_ou
+0000c550: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+0000c560: 655d 0a20 2020 2020 2020 2065 7863 6570  e].        excep
+0000c570: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+0000c580: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0000c590: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+0000c5a0: 2020 2020 2020 2020 2020 2066 2255 6e73             f"Uns
+0000c5b0: 7570 706f 7274 6564 2066 6f72 6365 5f6f  upported force_o
+0000c5c0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+0000c5d0: 7065 3a20 7b66 6f72 6365 5f6f 7574 7075  pe: {force_outpu
+0000c5e0: 745f 6765 6f6d 6574 7279 7479 7065 7d22  t_geometrytype}"
+0000c5f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000c600: 2020 2069 6620 666f 7263 655f 6f75 7470     if force_outp
+0000c610: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+0000c620: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0000c630: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+0000c640: 6d65 7472 7974 7970 652e 6973 5f6d 756c  metrytype.is_mul
+0000c650: 7469 7479 7065 3a0a 2020 2020 2020 2020  titype:.        
+0000c660: 666f 7263 655f 6d75 6c74 6974 7970 6520  force_multitype 
+0000c670: 3d20 5472 7565 0a0a 2020 2020 2320 4966  = True..    # If
+0000c680: 2074 6865 7265 2069 7320 6e6f 2067 656f   there is no geo
+0000c690: 6d65 7472 7920 636f 6c75 6d6e 2069 6e20  metry column in 
+0000c6a0: 7468 6520 696e 7075 742c 2061 6c77 6179  the input, alway
+0000c6b0: 7320 7573 6520 6669 6f6e 612c 2061 7320  s use fiona, as 
+0000c6c0: 7079 6f67 7269 6f20 646f 6573 6e27 740a  pyogrio doesn't.
+0000c6d0: 2020 2020 2320 7375 7070 6f72 7420 7468      # support th
+0000c6e0: 6174 2079 6574 2061 7420 7469 6d65 206f  at yet at time o
+0000c6f0: 6620 7772 6974 696e 672e 0a20 2020 2069  f writing..    i
+0000c700: 6620 6973 696e 7374 616e 6365 2867 6466  f isinstance(gdf
+0000c710: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
+0000c720: 6d65 2920 6973 2046 616c 7365 206f 7220  me) is False or 
+0000c730: 280a 2020 2020 2020 2020 6973 696e 7374  (.        isinst
+0000c740: 616e 6365 2867 6466 2c20 6770 642e 4765  ance(gdf, gpd.Ge
+0000c750: 6f44 6174 6146 7261 6d65 2920 616e 6420  oDataFrame) and 
+0000c760: 2267 656f 6d65 7472 7922 206e 6f74 2069  "geometry" not i
+0000c770: 6e20 6764 662e 636f 6c75 6d6e 730a 2020  n gdf.columns.  
+0000c780: 2020 293a 0a20 2020 2020 2020 2065 6e67    ):.        eng
+0000c790: 696e 6520 3d20 2266 696f 6e61 220a 2020  ine = "fiona".  
+0000c7a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000c7b0: 656e 6769 6e65 203d 205f 6765 745f 656e  engine = _get_en
+0000c7c0: 6769 6e65 2829 0a0a 2020 2020 2320 4e6f  gine()..    # No
+0000c7d0: 7720 7772 6974 6520 7769 7468 2074 6865  w write with the
+0000c7e0: 2063 6f72 7265 6374 2065 6e67 696e 650a   correct engine.
+0000c7f0: 2020 2020 6966 2065 6e67 696e 6520 3d3d      if engine ==
+0000c800: 2022 7079 6f67 7269 6f22 3a0a 2020 2020   "pyogrio":.    
+0000c810: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000c820: 7461 6e63 6528 6764 662c 2067 7064 2e47  tance(gdf, gpd.G
+0000c830: 656f 4461 7461 4672 616d 6529 0a20 2020  eoDataFrame).   
+0000c840: 2020 2020 2072 6574 7572 6e20 5f74 6f5f       return _to_
+0000c850: 6669 6c65 5f70 796f 6772 696f 280a 2020  file_pyogrio(.  
+0000c860: 2020 2020 2020 2020 2020 6764 663d 6764            gdf=gd
+0000c870: 662c 0a20 2020 2020 2020 2020 2020 2070  f,.            p
+0000c880: 6174 683d 7061 7468 2c0a 2020 2020 2020  ath=path,.      
+0000c890: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
+0000c8a0: 722c 0a20 2020 2020 2020 2020 2020 2066  r,.            f
+0000c8b0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+0000c8c0: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
+0000c8d0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+0000c8e0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0000c8f0: 666f 7263 655f 6d75 6c74 6974 7970 653d  force_multitype=
+0000c900: 666f 7263 655f 6d75 6c74 6974 7970 652c  force_multitype,
+0000c910: 0a20 2020 2020 2020 2020 2020 2061 7070  .            app
+0000c920: 656e 643d 6170 7065 6e64 2c0a 2020 2020  end=append,.    
+0000c930: 2020 2020 2020 2020 6170 7065 6e64 5f74          append_t
+0000c940: 696d 656f 7574 5f73 3d61 7070 656e 645f  imeout_s=append_
+0000c950: 7469 6d65 6f75 745f 732c 0a20 2020 2020  timeout_s,.     
+0000c960: 2020 2020 2020 2069 6e64 6578 3d69 6e64         index=ind
+0000c970: 6578 2c0a 2020 2020 2020 2020 2020 2020  ex,.            
+0000c980: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+0000c990: 6e64 6578 3d63 7265 6174 655f 7370 6174  ndex=create_spat
+0000c9a0: 6961 6c5f 696e 6465 782c 0a20 2020 2020  ial_index,.     
+0000c9b0: 2020 2029 0a20 2020 2065 6c69 6620 656e     ).    elif en
+0000c9c0: 6769 6e65 203d 3d20 2266 696f 6e61 223a  gine == "fiona":
+0000c9d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c9e0: 5f74 6f5f 6669 6c65 5f66 696f 6e61 280a  _to_file_fiona(.
+0000c9f0: 2020 2020 2020 2020 2020 2020 6764 663d              gdf=
+0000ca00: 6764 662c 0a20 2020 2020 2020 2020 2020  gdf,.           
+0000ca10: 2070 6174 683d 7061 7468 2c0a 2020 2020   path=path,.    
+0000ca20: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0000ca30: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+0000ca40: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000ca50: 6f6d 6574 7279 7479 7065 3d66 6f72 6365  ometrytype=force
+0000ca60: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000ca70: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000ca80: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
+0000ca90: 653d 666f 7263 655f 6d75 6c74 6974 7970  e=force_multityp
+0000caa0: 652c 0a20 2020 2020 2020 2020 2020 2061  e,.            a
+0000cab0: 7070 656e 643d 6170 7065 6e64 2c0a 2020  ppend=append,.  
+0000cac0: 2020 2020 2020 2020 2020 6170 7065 6e64            append
+0000cad0: 5f74 696d 656f 7574 5f73 3d61 7070 656e  _timeout_s=appen
+0000cae0: 645f 7469 6d65 6f75 745f 732c 0a20 2020  d_timeout_s,.   
+0000caf0: 2020 2020 2020 2020 2069 6e64 6578 3d69           index=i
+0000cb00: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
+0000cb10: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+0000cb20: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
+0000cb30: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
+0000cb40: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
+0000cb50: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+0000cb60: 616c 7565 4572 726f 7228 6622 556e 7375  alueError(f"Unsu
+0000cb70: 7070 6f72 7465 6420 656e 6769 6e65 3a20  pported engine: 
+0000cb80: 7b65 6e67 696e 657d 2229 0a0a 0a64 6566  {engine}")...def
+0000cb90: 205f 6765 745f 656e 6769 6e65 2829 3a0a   _get_engine():.
+0000cba0: 2020 2020 7265 7475 726e 206f 732e 656e      return os.en
+0000cbb0: 7669 726f 6e2e 6765 7428 2247 464f 5f49  viron.get("GFO_I
+0000cbc0: 4f5f 454e 4749 4e45 222c 2022 7079 6f67  O_ENGINE", "pyog
+0000cbd0: 7269 6f22 290a 0a0a 6465 6620 5f74 6f5f  rio")...def _to_
+0000cbe0: 6669 6c65 5f66 696f 6e61 280a 2020 2020  file_fiona(.    
+0000cbf0: 6764 663a 2055 6e69 6f6e 5b70 642e 4461  gdf: Union[pd.Da
+0000cc00: 7461 4672 616d 652c 2067 7064 2e47 656f  taFrame, gpd.Geo
+0000cc10: 4461 7461 4672 616d 655d 2c0a 2020 2020  DataFrame],.    
+0000cc20: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
+0000cc30: 6c61 7965 723a 2073 7472 2c0a 2020 2020  layer: str,.    
+0000cc40: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+0000cc50: 6d65 7472 7974 7970 653a 2055 6e69 6f6e  metrytype: Union
+0000cc60: 5b47 656f 6d65 7472 7954 7970 652c 2073  [GeometryType, s
+0000cc70: 7472 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65  tr, None] = None
+0000cc80: 2c0a 2020 2020 666f 7263 655f 6d75 6c74  ,.    force_mult
+0000cc90: 6974 7970 653a 2062 6f6f 6c20 3d20 4661  itype: bool = Fa
+0000cca0: 6c73 652c 0a20 2020 2061 7070 656e 643a  lse,.    append:
+0000ccb0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+0000ccc0: 2020 2061 7070 656e 645f 7469 6d65 6f75     append_timeou
+0000ccd0: 745f 733a 2069 6e74 203d 2036 3030 2c0a  t_s: int = 600,.
+0000cce0: 2020 2020 696e 6465 783a 204f 7074 696f      index: Optio
+0000ccf0: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+0000cd00: 2c0a 2020 2020 6372 6561 7465 5f73 7061  ,.    create_spa
+0000cd10: 7469 616c 5f69 6e64 6578 3a20 4f70 7469  tial_index: Opti
+0000cd20: 6f6e 616c 5b62 6f6f 6c5d 203d 2054 7275  onal[bool] = Tru
+0000cd30: 652c 0a29 3a0a 2020 2020 2222 220a 2020  e,.):.    """.  
+0000cd40: 2020 5772 6974 6573 2061 2070 616e 6461    Writes a panda
+0000cd50: 7320 6461 7461 6672 616d 6520 746f 2066  s dataframe to f
+0000cd60: 696c 6520 7573 696e 6720 6669 6f6e 612e  ile using fiona.
+0000cd70: 0a20 2020 2022 2222 0a20 2020 2023 2048  .    """.    # H
+0000cd80: 616e 646c 6520 736f 6d65 2073 7065 6369  andle some speci
+0000cd90: 6669 6320 6361 7365 7320 7768 6572 6520  fic cases where 
+0000cda0: 7468 6520 6669 6c65 2073 6368 656d 6120  the file schema 
+0000cdb0: 6e65 6564 7320 746f 2062 6520 6d61 6e69  needs to be mani
+0000cdc0: 7075 6c61 7465 642e 0a20 2020 2073 6368  pulated..    sch
+0000cdd0: 656d 6120 3d20 4e6f 6e65 0a20 2020 2069  ema = None.    i
+0000cde0: 6620 6973 696e 7374 616e 6365 2867 6466  f isinstance(gdf
+0000cdf0: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
+0000ce00: 6d65 2920 6973 2046 616c 7365 206f 7220  me) is False or 
+0000ce10: 280a 2020 2020 2020 2020 6973 696e 7374  (.        isinst
+0000ce20: 616e 6365 2867 6466 2c20 6770 642e 4765  ance(gdf, gpd.Ge
+0000ce30: 6f44 6174 6146 7261 6d65 2920 616e 6420  oDataFrame) and 
+0000ce40: 2267 656f 6d65 7472 7922 206e 6f74 2069  "geometry" not i
+0000ce50: 6e20 6764 662e 636f 6c75 6d6e 730a 2020  n gdf.columns.  
+0000ce60: 2020 293a 0a20 2020 2020 2020 2023 204e    ):.        # N
+0000ce70: 6f20 6765 6f6d 6574 7279 2c20 736f 2070  o geometry, so p
+0000ce80: 7265 7061 7265 2074 6f20 6265 2077 7269  repare to be wri
+0000ce90: 7474 656e 2061 7320 6174 7472 6962 7574  tten as attribut
+0000cea0: 6520 7461 626c 653a 2061 6464 2067 656f  e table: add geo
+0000ceb0: 6d65 7472 7920 636f 6c75 6d6e 0a20 2020  metry column.   
+0000cec0: 2020 2020 2023 2077 6974 6820 4e6f 6e65       # with None
+0000ced0: 2067 656f 6d65 7472 7920 7479 7065 2069   geometry type i
+0000cee0: 6e20 7363 6865 6d61 0a20 2020 2020 2020  n schema.       
+0000cef0: 2067 6466 203d 2067 7064 2e47 656f 4461   gdf = gpd.GeoDa
+0000cf00: 7461 4672 616d 6528 6764 662c 2067 656f  taFrame(gdf, geo
+0000cf10: 6d65 7472 793d 5b4e 6f6e 6520 666f 7220  metry=[None for 
+0000cf20: 6920 696e 2067 6466 2e69 6e64 6578 5d29  i in gdf.index])
+0000cf30: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0000cf40: 0a20 2020 2020 2020 2073 6368 656d 6120  .        schema 
+0000cf50: 3d20 6770 645f 696f 5f66 696c 652e 696e  = gpd_io_file.in
+0000cf60: 6665 725f 7363 6865 6d61 2867 6466 290a  fer_schema(gdf).
+0000cf70: 2020 2020 2020 2020 7363 6865 6d61 5b22          schema["
+0000cf80: 6765 6f6d 6574 7279 225d 203d 2022 4e6f  geometry"] = "No
+0000cf90: 6e65 220a 2020 2020 656c 6966 2028 0a20  ne".    elif (. 
+0000cfa0: 2020 2020 2020 206c 656e 2867 6466 2920         len(gdf) 
+0000cfb0: 3d3d 2030 0a20 2020 2020 2020 2061 6e64  == 0.        and
+0000cfc0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000cfd0: 6f6d 6574 7279 7479 7065 2069 7320 6e6f  ometrytype is no
+0000cfe0: 7420 4e6f 6e65 0a20 2020 2020 2020 2061  t None.        a
+0000cff0: 6e64 2069 7369 6e73 7461 6e63 6528 666f  nd isinstance(fo
+0000d000: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+0000d010: 7472 7974 7970 652c 2047 656f 6d65 7472  trytype, Geometr
+0000d020: 7954 7970 6529 0a20 2020 2029 3a0a 2020  yType).    ):.  
+0000d030: 2020 2020 2020 2320 4966 2074 6865 2067        # If the g
+0000d040: 6466 2069 7320 656d 7074 7920 6275 7420  df is empty but 
+0000d050: 6120 6765 6f6d 6574 7279 2074 7970 6520  a geometry type 
+0000d060: 6973 2073 7065 6369 6669 6564 2c20 7573  is specified, us
+0000d070: 6520 7468 6520 7370 6563 6966 6965 6420  e the specified 
+0000d080: 7479 7065 0a20 2020 2020 2020 2073 6368  type.        sch
+0000d090: 656d 6120 3d20 6770 645f 696f 5f66 696c  ema = gpd_io_fil
+0000d0a0: 652e 696e 6665 725f 7363 6865 6d61 2867  e.infer_schema(g
+0000d0b0: 6466 290a 2020 2020 2020 2020 2320 4765  df).        # Ge
+0000d0c0: 6f6d 6574 7279 2074 7970 6520 6d75 7374  ometry type must
+0000d0d0: 2062 6520 696e 2063 616d 656c 6361 7365   be in camelcase
+0000d0e0: 2066 6f72 2066 696f 6e61 0a20 2020 2020   for fiona.     
+0000d0f0: 2020 2073 6368 656d 615b 2267 656f 6d65     schema["geome
+0000d100: 7472 7922 5d20 3d20 666f 7263 655f 6f75  try"] = force_ou
+0000d110: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+0000d120: 652e 6e61 6d65 5f63 616d 656c 6361 7365  e.name_camelcase
+0000d130: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+0000d140: 7374 616e 6365 2867 6466 2c20 6770 642e  stance(gdf, gpd.
+0000d150: 4765 6f44 6174 6146 7261 6d65 290a 0a20  GeoDataFrame).. 
+0000d160: 2020 2023 2043 6f6e 7665 7274 2066 6f72     # Convert for
+0000d170: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000d180: 7279 7479 7065 2074 6f20 7374 7269 6e67  rytype to string
+0000d190: 2074 6f20 7369 6d70 6c69 6679 2063 6f64   to simplify cod
+0000d1a0: 6520 6166 7465 7277 6172 6473 0a20 2020  e afterwards.   
+0000d1b0: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
+0000d1c0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+0000d1d0: 6574 7279 7479 7065 2c20 4765 6f6d 6574  etrytype, Geomet
+0000d1e0: 7279 5479 7065 293a 0a20 2020 2020 2020  ryType):.       
+0000d1f0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000d200: 6f6d 6574 7279 7479 7065 203d 2066 6f72  ometrytype = for
+0000d210: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000d220: 7279 7479 7065 2e6e 616d 650a 0a20 2020  rytype.name..   
+0000d230: 2023 204e 6f20 7468 6520 6669 6c65 2063   # No the file c
+0000d240: 616e 2061 6374 7561 6c6c 7920 6265 2077  an actually be w
+0000d250: 7269 7474 656e 0a20 2020 2023 202d 2d2d  ritten.    # ---
+0000d260: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000d270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000d280: 0a20 2020 2023 2046 696f 6e61 2064 6f65  .    # Fiona doe
+0000d290: 736e 2774 2073 7570 706f 7274 2074 6865  sn't support the
+0000d2a0: 206f 7574 7075 7420 6765 6f6d 6574 7279   output geometry
+0000d2b0: 7479 7065 2070 6172 616d 6574 6572 2061  type parameter a
+0000d2c0: 7320 7573 6564 2069 6e20 6764 616c 2c20  s used in gdal, 
+0000d2d0: 736f 2061 7320 610a 2020 2020 2320 6c69  so as a.    # li
+0000d2e0: 6768 7477 6569 6768 7420 696d 706c 656d  ghtweight implem
+0000d2f0: 656e 7461 7469 6f6e 206a 7573 7420 7365  entation just se
+0000d300: 7420 666f 7263 650a 2020 2020 6465 6620  t force.    def 
+0000d310: 7772 6974 655f 746f 5f66 696c 6528 0a20  write_to_file(. 
+0000d320: 2020 2020 2020 2067 6466 3a20 6770 642e         gdf: gpd.
+0000d330: 4765 6f44 6174 6146 7261 6d65 2c0a 2020  GeoDataFrame,.  
+0000d340: 2020 2020 2020 7061 7468 3a20 5061 7468        path: Path
+0000d350: 2c0a 2020 2020 2020 2020 6c61 7965 723a  ,.        layer:
+0000d360: 2073 7472 2c0a 2020 2020 2020 2020 696e   str,.        in
+0000d370: 6465 783a 204f 7074 696f 6e61 6c5b 626f  dex: Optional[bo
+0000d380: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000d390: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+0000d3a0: 5f67 656f 6d65 7472 7974 7970 653a 204f  _geometrytype: O
+0000d3b0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0000d3c0: 6f6e 652c 0a20 2020 2020 2020 2066 6f72  one,.        for
+0000d3d0: 6365 5f6d 756c 7469 7479 7065 3a20 626f  ce_multitype: bo
+0000d3e0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0000d3f0: 2020 2020 6170 7065 6e64 3a20 626f 6f6c      append: bool
+0000d400: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+0000d410: 2020 7363 6865 6d61 3a20 4f70 7469 6f6e    schema: Option
+0000d420: 616c 5b64 6963 745d 203d 204e 6f6e 652c  al[dict] = None,
+0000d430: 0a20 2020 2020 2020 2063 7265 6174 655f  .        create_
+0000d440: 7370 6174 6961 6c5f 696e 6465 783a 204f  spatial_index: O
+0000d450: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000d460: 5472 7565 2c0a 2020 2020 293a 0a20 2020  True,.    ):.   
+0000d470: 2020 2020 2023 2050 7265 7061 7265 2061       # Prepare a
+0000d480: 7267 7320 666f 7220 746f 5f66 696c 650a  rgs for to_file.
+0000d490: 2020 2020 2020 2020 6966 2061 7070 656e          if appen
+0000d4a0: 6420 6973 2054 7275 653a 0a20 2020 2020  d is True:.     
+0000d4b0: 2020 2020 2020 2069 6620 7061 7468 2e65         if path.e
+0000d4c0: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+0000d4d0: 2020 2020 2020 2020 206d 6f64 6520 3d20           mode = 
+0000d4e0: 2261 220a 2020 2020 2020 2020 2020 2020  "a".            
+0000d4f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000d500: 2020 2020 2020 6d6f 6465 203d 2022 7722        mode = "w"
+0000d510: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000d520: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
+0000d530: 3d20 2277 220a 0a20 2020 2020 2020 206b  = "w"..        k
+0000d540: 7761 7267 7320 3d20 7b7d 0a20 2020 2020  wargs = {}.     
+0000d550: 2020 206b 7761 7267 735b 2265 6e67 696e     kwargs["engin
+0000d560: 6522 5d20 3d20 2266 696f 6e61 220a 2020  e"] = "fiona".  
+0000d570: 2020 2020 2020 6b77 6172 6773 5b22 6d6f        kwargs["mo
+0000d580: 6465 225d 203d 206d 6f64 650a 2020 2020  de"] = mode.    
+0000d590: 2020 2020 6765 6f66 696c 6574 7970 6520      geofiletype 
+0000d5a0: 3d20 4765 6f66 696c 6554 7970 6528 7061  = GeofileType(pa
+0000d5b0: 7468 290a 2020 2020 2020 2020 6b77 6172  th).        kwar
+0000d5c0: 6773 5b22 6472 6976 6572 225d 203d 2067  gs["driver"] = g
+0000d5d0: 656f 6669 6c65 7479 7065 2e6f 6772 6472  eofiletype.ogrdr
+0000d5e0: 6976 6572 0a20 2020 2020 2020 206b 7761  iver.        kwa
+0000d5f0: 7267 735b 2269 6e64 6578 225d 203d 2069  rgs["index"] = i
+0000d600: 6e64 6578 0a20 2020 2020 2020 2069 6620  ndex.        if 
+0000d610: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+0000d620: 6e64 6578 2069 7320 6e6f 7420 4e6f 6e65  ndex is not None
+0000d630: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
+0000d640: 6172 6773 5b22 5350 4154 4941 4c5f 494e  args["SPATIAL_IN
+0000d650: 4445 5822 5d20 3d20 6372 6561 7465 5f73  DEX"] = create_s
+0000d660: 7061 7469 616c 5f69 6e64 6578 0a20 2020  patial_index.   
+0000d670: 2020 2020 2069 6620 666f 7263 655f 6f75       if force_ou
+0000d680: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+0000d690: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+0000d6a0: 2020 2020 2020 2020 2020 206b 7761 7267             kwarg
+0000d6b0: 735b 2267 656f 6d65 7472 7974 7970 6522  s["geometrytype"
+0000d6c0: 5d20 3d20 666f 7263 655f 6f75 7470 7574  ] = force_output
+0000d6d0: 5f67 656f 6d65 7472 7974 7970 650a 2020  _geometrytype.  
+0000d6e0: 2020 2020 2020 6966 2073 6368 656d 6120        if schema 
+0000d6f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000d700: 2020 2020 2020 2020 206b 7761 7267 735b           kwargs[
+0000d710: 2273 6368 656d 6122 5d20 3d20 7363 6865  "schema"] = sche
+0000d720: 6d61 0a0a 2020 2020 2020 2020 2320 4e6f  ma..        # No
+0000d730: 7720 7765 2063 616e 2077 7269 7465 0a20  w we can write. 
+0000d740: 2020 2020 2020 2069 6620 6765 6f66 696c         if geofil
+0000d750: 6574 7970 6520 3d3d 2047 656f 6669 6c65  etype == Geofile
+0000d760: 5479 7065 2e45 5352 4953 6861 7065 6669  Type.ESRIShapefi
+0000d770: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+0000d780: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+0000d790: 6966 2069 6e64 6578 2069 7320 5472 7565  if index is True
+0000d7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d7b0: 2020 6764 665f 746f 5f77 7269 7465 203d    gdf_to_write =
+0000d7c0: 2067 6466 2e72 6573 6574 5f69 6e64 6578   gdf.reset_index
+0000d7d0: 2864 726f 703d 5472 7565 290a 2020 2020  (drop=True).    
+0000d7e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000d7f0: 2020 2020 2020 2020 2020 2020 2020 6764                gd
+0000d800: 665f 746f 5f77 7269 7465 203d 2067 6466  f_to_write = gdf
+0000d810: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+0000d820: 0a20 2020 2020 2020 2020 2020 2067 6466  .            gdf
+0000d830: 5f74 6f5f 7772 6974 6520 3d20 6764 660a  _to_write = gdf.
+0000d840: 2020 2020 2020 2020 2020 2020 6764 665f              gdf_
+0000d850: 746f 5f77 7269 7465 2e74 6f5f 6669 6c65  to_write.to_file
+0000d860: 2873 7472 2870 6174 6829 2c20 2a2a 6b77  (str(path), **kw
+0000d870: 6172 6773 2920 2023 2074 7970 653a 2069  args)  # type: i
+0000d880: 676e 6f72 650a 2020 2020 2020 2020 656c  gnore.        el
+0000d890: 6966 2067 656f 6669 6c65 7479 7065 203d  if geofiletype =
+0000d8a0: 3d20 4765 6f66 696c 6554 7970 652e 4750  = GeofileType.GP
+0000d8b0: 4b47 3a0a 2020 2020 2020 2020 2020 2020  KG:.            
+0000d8c0: 2320 5472 7920 746f 2068 6172 6d6f 6e69  # Try to harmoni
+0000d8d0: 7a65 2074 6865 2067 656f 6d65 7472 7974  ze the geometryt
+0000d8e0: 7970 6520 746f 206f 6e65 2028 6d75 6c74  ype to one (mult
+0000d8f0: 6929 7479 7065 2c20 6173 2047 504b 470a  i)type, as GPKG.
+0000d900: 2020 2020 2020 2020 2020 2020 2320 646f              # do
+0000d910: 6573 6e27 7420 6c69 6b65 203e 2031 2074  esn't like > 1 t
+0000d920: 7970 6520 696e 2061 206c 6179 6572 0a20  ype in a layer. 
+0000d930: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
+0000d940: 6865 6d61 2069 7320 4e6f 6e65 206f 7220  hema is None or 
+0000d950: 286c 656e 2867 6466 2920 3e20 3020 616e  (len(gdf) > 0 an
+0000d960: 6420 7363 6865 6d61 5b22 6765 6f6d 6574  d schema["geomet
+0000d970: 7279 225d 2021 3d20 224e 6f6e 6522 293a  ry"] != "None"):
+0000d980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d990: 2067 6466 5f74 6f5f 7772 6974 6520 3d20   gdf_to_write = 
+0000d9a0: 6764 662e 636f 7079 2829 0a20 2020 2020  gdf.copy().     
+0000d9b0: 2020 2020 2020 2020 2020 2067 6466 5f74             gdf_t
+0000d9c0: 6f5f 7772 6974 652e 6765 6f6d 6574 7279  o_write.geometry
+0000d9d0: 203d 2067 656f 7365 7269 6573 5f75 7469   = geoseries_uti
+0000d9e0: 6c2e 6861 726d 6f6e 697a 655f 6765 6f6d  l.harmonize_geom
+0000d9f0: 6574 7279 7479 7065 7328 0a20 2020 2020  etrytypes(.     
+0000da00: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000da10: 6466 2e67 656f 6d65 7472 792c 2066 6f72  df.geometry, for
+0000da20: 6365 5f6d 756c 7469 7479 7065 3d66 6f72  ce_multitype=for
+0000da30: 6365 5f6d 756c 7469 7479 7065 0a20 2020  ce_multitype.   
+0000da40: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000da50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000da60: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000da70: 2867 6466 5f74 6f5f 7772 6974 652c 2067  (gdf_to_write, g
+0000da80: 7064 2e47 656f 4461 7461 4672 616d 6529  pd.GeoDataFrame)
+0000da90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000daa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000dab0: 2020 2067 6466 5f74 6f5f 7772 6974 6520     gdf_to_write 
+0000dac0: 3d20 6764 660a 2020 2020 2020 2020 2020  = gdf.          
+0000dad0: 2020 6764 665f 746f 5f77 7269 7465 2e74    gdf_to_write.t
+0000dae0: 6f5f 6669 6c65 2873 7472 2870 6174 6829  o_file(str(path)
+0000daf0: 2c20 6c61 7965 723d 6c61 7965 722c 202a  , layer=layer, *
+0000db00: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+0000db10: 2065 6c69 6620 6765 6f66 696c 6574 7970   elif geofiletyp
+0000db20: 6520 3d3d 2047 656f 6669 6c65 5479 7065  e == GeofileType
+0000db30: 2e53 514c 6974 653a 0a20 2020 2020 2020  .SQLite:.       
+0000db40: 2020 2020 2067 6466 2e74 6f5f 6669 6c65       gdf.to_file
+0000db50: 2873 7472 2870 6174 6829 2c20 6c61 7965  (str(path), laye
+0000db60: 723d 6c61 7965 722c 202a 2a6b 7761 7267  r=layer, **kwarg
+0000db70: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
+0000db80: 6765 6f66 696c 6574 7970 6520 3d3d 2047  geofiletype == G
+0000db90: 656f 6669 6c65 5479 7065 2e47 656f 4a53  eofileType.GeoJS
+0000dba0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+0000dbb0: 6764 662e 746f 5f66 696c 6528 7374 7228  gdf.to_file(str(
+0000dbc0: 7061 7468 292c 202a 2a6b 7761 7267 7329  path), **kwargs)
+0000dbd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000dbe0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000dbf0: 2056 616c 7565 4572 726f 7228 6622 4e6f   ValueError(f"No
+0000dc00: 7420 696d 706c 656d 656e 7465 6420 666f  t implemented fo
+0000dc10: 7220 6765 6f66 696c 6574 7970 6520 7b67  r geofiletype {g
+0000dc20: 656f 6669 6c65 7479 7065 7d22 290a 0a20  eofiletype}").. 
+0000dc30: 2020 2023 2049 6620 6e6f 2061 7070 656e     # If no appen
+0000dc40: 642c 206a 7573 7420 7772 6974 6520 746f  d, just write to
+0000dc50: 206f 7574 7075 7420 7061 7468 0a20 2020   output path.   
+0000dc60: 2069 6620 6e6f 7420 6170 7065 6e64 3a0a   if not append:.
+0000dc70: 2020 2020 2020 2020 7772 6974 655f 746f          write_to
+0000dc80: 5f66 696c 6528 0a20 2020 2020 2020 2020  _file(.         
+0000dc90: 2020 2067 6466 3d67 6466 2c0a 2020 2020     gdf=gdf,.    
+0000dca0: 2020 2020 2020 2020 7061 7468 3d70 6174          path=pat
+0000dcb0: 682c 0a20 2020 2020 2020 2020 2020 206c  h,.            l
+0000dcc0: 6179 6572 3d6c 6179 6572 2c0a 2020 2020  ayer=layer,.    
+0000dcd0: 2020 2020 2020 2020 696e 6465 783d 696e          index=in
+0000dce0: 6465 782c 0a20 2020 2020 2020 2020 2020  dex,.           
+0000dcf0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000dd00: 6f6d 6574 7279 7479 7065 3d66 6f72 6365  ometrytype=force
+0000dd10: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000dd20: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000dd30: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
+0000dd40: 653d 666f 7263 655f 6d75 6c74 6974 7970  e=force_multityp
+0000dd50: 652c 0a20 2020 2020 2020 2020 2020 2061  e,.            a
+0000dd60: 7070 656e 643d 6170 7065 6e64 2c0a 2020  ppend=append,.  
+0000dd70: 2020 2020 2020 2020 2020 7363 6865 6d61            schema
+0000dd80: 3d73 6368 656d 612c 0a20 2020 2020 2020  =schema,.       
+0000dd90: 2020 2020 2063 7265 6174 655f 7370 6174       create_spat
+0000dda0: 6961 6c5f 696e 6465 783d 6372 6561 7465  ial_index=create
+0000ddb0: 5f73 7061 7469 616c 5f69 6e64 6578 2c0a  _spatial_index,.
+0000ddc0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+0000ddd0: 7365 3a0a 2020 2020 2020 2020 2320 4170  se:.        # Ap
+0000dde0: 7065 6e64 2069 7320 6173 6b65 642c 2063  pend is asked, c
+0000ddf0: 6865 636b 2069 6620 7468 6520 6669 6f6e  heck if the fion
+0000de00: 6120 6472 6976 6572 2073 7570 706f 7274  a driver support
+0000de10: 7320 6170 7065 6e64 696e 672e 2049 660a  s appending. If.
+0000de20: 2020 2020 2020 2020 2320 6e6f 742c 2077          # not, w
+0000de30: 7269 7465 2074 6f20 7465 6d70 6f72 6172  rite to temporar
+0000de40: 7920 6f75 7470 7574 2066 696c 650a 0a20  y output file.. 
+0000de50: 2020 2020 2020 2023 2052 656d 6172 6b3a         # Remark:
+0000de60: 2066 696f 6e61 2070 7265 2d31 2e38 2e31   fiona pre-1.8.1
+0000de70: 3420 6469 646e 2774 2073 7570 706f 7274  4 didn't support
+0000de80: 2061 7070 656e 6469 6e67 2074 6f20 6765   appending to ge
+0000de90: 6f70 6163 6b61 6765 2e20 4f6e 6365 0a20  opackage. Once. 
+0000dea0: 2020 2020 2020 2023 206f 6c64 6572 2076         # older v
+0000deb0: 6572 7369 6f6e 7320 6265 636f 6d65 7320  ersions becomes 
+0000dec0: 7261 7265 2c20 6465 7065 6e64 656e 6379  rare, dependency
+0000ded0: 2063 616e 2062 6520 7075 7420 746f 2074   can be put to t
+0000dee0: 6869 7320 7665 7273 696f 6e2c 2061 6e64  his version, and
+0000def0: 0a20 2020 2020 2020 2023 2074 6869 7320  .        # this 
+0000df00: 636f 6465 2063 616e 2062 6520 636c 6561  code can be clea
+0000df10: 6e65 6420 7570 2e2e 2e0a 2020 2020 2020  ned up....      
+0000df20: 2020 6765 6f66 696c 6574 7970 6520 3d20    geofiletype = 
+0000df30: 4765 6f66 696c 6554 7970 6528 7061 7468  GeofileType(path
+0000df40: 290a 2020 2020 2020 2020 6764 6674 656d  ).        gdftem
+0000df50: 705f 7061 7468 203d 204e 6f6e 650a 2020  p_path = None.  
+0000df60: 2020 2020 2020 6764 6674 656d 705f 6c6f        gdftemp_lo
+0000df70: 636b 7061 7468 203d 204e 6f6e 650a 2020  ckpath = None.  
+0000df80: 2020 2020 2020 6966 2022 6122 206e 6f74        if "a" not
+0000df90: 2069 6e20 6669 6f6e 612e 7375 7070 6f72   in fiona.suppor
+0000dfa0: 7465 645f 6472 6976 6572 735b 6765 6f66  ted_drivers[geof
+0000dfb0: 696c 6574 7970 652e 6f67 7264 7269 7665  iletype.ogrdrive
+0000dfc0: 725d 3a0a 2020 2020 2020 2020 2020 2020  r]:.            
+0000dfd0: 2320 4765 7420 6120 756e 6971 7565 2074  # Get a unique t
+0000dfe0: 656d 7020 6669 6c65 2070 6174 682e 2054  emp file path. T
+0000dff0: 6865 2066 696c 6520 6361 6e6e 6f74 2062  he file cannot b
+0000e000: 6520 6372 6561 7465 6420 7965 742c 2073  e created yet, s
+0000e010: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+0000e020: 6f6e 6c79 2063 7265 6174 6520 6120 6c6f  only create a lo
+0000e030: 636b 2066 696c 6520 746f 2065 7661 6465  ck file to evade
+0000e040: 206f 7468 6572 2070 726f 6365 7373 6573   other processes
+0000e050: 2075 7369 6e67 2074 6865 2073 616d 650a   using the same.
+0000e060: 2020 2020 2020 2020 2020 2020 2320 7465              # te
+0000e070: 6d70 2066 696c 6520 6e61 6d65 0a20 2020  mp file name.   
+0000e080: 2020 2020 2020 2020 2067 6466 7465 6d70           gdftemp
+0000e090: 5f70 6174 682c 2067 6466 7465 6d70 5f6c  _path, gdftemp_l
+0000e0a0: 6f63 6b70 6174 6820 3d20 5f69 6f5f 7574  ockpath = _io_ut
+0000e0b0: 696c 2e67 6574 5f74 656d 7066 696c 655f  il.get_tempfile_
+0000e0c0: 6c6f 636b 6564 280a 2020 2020 2020 2020  locked(.        
+0000e0d0: 2020 2020 2020 2020 6261 7365 5f66 696c          base_fil
+0000e0e0: 656e 616d 653d 2267 6466 7465 6d70 222c  ename="gdftemp",
+0000e0f0: 2073 7566 6669 783d 7061 7468 2e73 7566   suffix=path.suf
+0000e100: 6669 782c 2064 6972 6e61 6d65 3d22 6765  fix, dirname="ge
+0000e110: 6f66 696c 655f 746f 5f66 696c 6522 0a20  ofile_to_file". 
+0000e120: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000e130: 2020 2020 2020 2020 2077 7269 7465 5f74           write_t
+0000e140: 6f5f 6669 6c65 280a 2020 2020 2020 2020  o_file(.        
+0000e150: 2020 2020 2020 2020 6764 662c 0a20 2020          gdf,.   
+0000e160: 2020 2020 2020 2020 2020 2020 2070 6174               pat
+0000e170: 683d 6764 6674 656d 705f 7061 7468 2c0a  h=gdftemp_path,.
 0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e190: 696e 6465 783d 696e 6465 782c 0a20 2020  index=index,.   
-0000e1a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000e1b0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-0000e1c0: 7279 7479 7065 3d66 6f72 6365 5f6f 7574  rytype=force_out
-0000e1d0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000e1e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e1f0: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
-0000e200: 653d 666f 7263 655f 6d75 6c74 6974 7970  e=force_multityp
-0000e210: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e220: 2020 2073 6368 656d 613d 7363 6865 6d61     schema=schema
-0000e230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e240: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
-0000e250: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
-0000e260: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
-0000e270: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000e280: 2020 2020 2320 4669 6c65 7320 646f 6e27      # Files don'
-0000e290: 7420 7479 7069 6361 6c6c 7920 7375 7070  t typically supp
-0000e2a0: 6f72 7420 6861 7669 6e67 206d 756c 7469  ort having multi
-0000e2b0: 706c 6520 7072 6f63 6573 7365 7320 7772  ple processes wr
-0000e2c0: 6974 696e 670a 2020 2020 2020 2020 2320  iting.        # 
-0000e2d0: 7369 6d75 6c74 616e 6f75 736c 7920 746f  simultanously to
-0000e2e0: 2074 6865 6d2c 2073 6f20 7573 6520 6c6f   them, so use lo
-0000e2f0: 636b 2066 696c 6520 746f 2073 796e 6368  ck file to synch
-0000e300: 726f 6e69 7a65 2061 6363 6573 732e 0a20  ronize access.. 
-0000e310: 2020 2020 2020 206c 6f63 6b66 696c 6520         lockfile 
-0000e320: 3d20 5061 7468 2866 227b 7374 7228 7061  = Path(f"{str(pa
-0000e330: 7468 297d 2e6c 6f63 6b22 290a 2020 2020  th)}.lock").    
-0000e340: 2020 2020 7374 6172 745f 7469 6d65 203d      start_time =
-0000e350: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
-0000e360: 6d65 2e6e 6f77 2829 0a20 2020 2020 2020  me.now().       
-0000e370: 2072 6561 6479 203d 2046 616c 7365 0a20   ready = False. 
-0000e380: 2020 2020 2020 2077 6869 6c65 206e 6f74         while not
-0000e390: 2072 6561 6479 3a0a 2020 2020 2020 2020   ready:.        
-0000e3a0: 2020 2020 6966 205f 696f 5f75 7469 6c2e      if _io_util.
-0000e3b0: 6372 6561 7465 5f66 696c 655f 6174 6f6d  create_file_atom
-0000e3c0: 6963 286c 6f63 6b66 696c 6529 2069 7320  ic(lockfile) is 
-0000e3d0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-0000e3e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000e3f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000e400: 2049 6620 6764 6620 7761 736e 2774 2077   If gdf wasn't w
-0000e410: 7269 7474 656e 2074 6f20 7465 6d70 2066  ritten to temp f
-0000e420: 696c 652c 2075 7365 2073 7461 6e64 6172  ile, use standar
-0000e430: 6420 7772 6974 652d 746f 2d66 696c 650a  d write-to-file.
-0000e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e450: 2020 2020 6966 2067 6466 7465 6d70 5f70      if gdftemp_p
-0000e460: 6174 6820 6973 204e 6f6e 653a 0a20 2020  ath is None:.   
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e480: 2020 2020 2077 7269 7465 5f74 6f5f 6669       write_to_fi
-0000e490: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0000e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4b0: 6764 663d 6764 662c 0a20 2020 2020 2020  gdf=gdf,.       
-0000e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4d0: 2020 2020 2070 6174 683d 7061 7468 2c0a       path=path,.
+0000e190: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
+0000e1a0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0000e1b0: 6578 3d69 6e64 6578 2c0a 2020 2020 2020  ex=index,.      
+0000e1c0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+0000e1d0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+0000e1e0: 7970 653d 666f 7263 655f 6f75 7470 7574  ype=force_output
+0000e1f0: 5f67 656f 6d65 7472 7974 7970 652c 0a20  _geometrytype,. 
+0000e200: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e210: 6f72 6365 5f6d 756c 7469 7479 7065 3d66  orce_multitype=f
+0000e220: 6f72 6365 5f6d 756c 7469 7479 7065 2c0a  orce_multitype,.
+0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e240: 7363 6865 6d61 3d73 6368 656d 612c 0a20  schema=schema,. 
+0000e250: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000e260: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+0000e270: 6465 783d 6372 6561 7465 5f73 7061 7469  dex=create_spati
+0000e280: 616c 5f69 6e64 6578 2c0a 2020 2020 2020  al_index,.      
+0000e290: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000e2a0: 2023 2046 696c 6573 2064 6f6e 2774 2074   # Files don't t
+0000e2b0: 7970 6963 616c 6c79 2073 7570 706f 7274  ypically support
+0000e2c0: 2068 6176 696e 6720 6d75 6c74 6970 6c65   having multiple
+0000e2d0: 2070 726f 6365 7373 6573 2077 7269 7469   processes writi
+0000e2e0: 6e67 0a20 2020 2020 2020 2023 2073 696d  ng.        # sim
+0000e2f0: 756c 7461 6e6f 7573 6c79 2074 6f20 7468  ultanously to th
+0000e300: 656d 2c20 736f 2075 7365 206c 6f63 6b20  em, so use lock 
+0000e310: 6669 6c65 2074 6f20 7379 6e63 6872 6f6e  file to synchron
+0000e320: 697a 6520 6163 6365 7373 2e0a 2020 2020  ize access..    
+0000e330: 2020 2020 6c6f 636b 6669 6c65 203d 2050      lockfile = P
+0000e340: 6174 6828 6622 7b73 7472 2870 6174 6829  ath(f"{str(path)
+0000e350: 7d2e 6c6f 636b 2229 0a20 2020 2020 2020  }.lock").       
+0000e360: 2073 7461 7274 5f74 696d 6520 3d20 6461   start_time = da
+0000e370: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
+0000e380: 6e6f 7728 290a 2020 2020 2020 2020 7265  now().        re
+0000e390: 6164 7920 3d20 4661 6c73 650a 2020 2020  ady = False.    
+0000e3a0: 2020 2020 7768 696c 6520 6e6f 7420 7265      while not re
+0000e3b0: 6164 793a 0a20 2020 2020 2020 2020 2020  ady:.           
+0000e3c0: 2069 6620 5f69 6f5f 7574 696c 2e63 7265   if _io_util.cre
+0000e3d0: 6174 655f 6669 6c65 5f61 746f 6d69 6328  ate_file_atomic(
+0000e3e0: 6c6f 636b 6669 6c65 2920 6973 2054 7275  lockfile) is Tru
+0000e3f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e400: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000e410: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0000e420: 2067 6466 2077 6173 6e27 7420 7772 6974   gdf wasn't writ
+0000e430: 7465 6e20 746f 2074 656d 7020 6669 6c65  ten to temp file
+0000e440: 2c20 7573 6520 7374 616e 6461 7264 2077  , use standard w
+0000e450: 7269 7465 2d74 6f2d 6669 6c65 0a20 2020  rite-to-file.   
+0000e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e470: 2069 6620 6764 6674 656d 705f 7061 7468   if gdftemp_path
+0000e480: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4a0: 2020 7772 6974 655f 746f 5f66 696c 6528    write_to_file(
+0000e4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e4c0: 2020 2020 2020 2020 2020 2020 2067 6466               gdf
+0000e4d0: 3d67 6466 2c0a 2020 2020 2020 2020 2020  =gdf,.          
 0000e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4f0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
-0000e500: 723d 6c61 7965 722c 0a20 2020 2020 2020  r=layer,.       
-0000e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e520: 2020 2020 2069 6e64 6578 3d69 6e64 6578       index=index
-0000e530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e540: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000e550: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-0000e560: 7472 7974 7970 653d 666f 7263 655f 6f75  trytype=force_ou
-0000e570: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000e580: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e590: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000e5a0: 6f72 6365 5f6d 756c 7469 7479 7065 3d66  orce_multitype=f
-0000e5b0: 6f72 6365 5f6d 756c 7469 7479 7065 2c0a  orce_multitype,.
-0000e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5d0: 2020 2020 2020 2020 2020 2020 6170 7065              appe
-0000e5e0: 6e64 3d54 7275 652c 0a20 2020 2020 2020  nd=True,.       
-0000e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e600: 2020 2020 2073 6368 656d 613d 7363 6865       schema=sche
-0000e610: 6d61 2c0a 2020 2020 2020 2020 2020 2020  ma,.            
-0000e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e630: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-0000e640: 6e64 6578 3d63 7265 6174 655f 7370 6174  ndex=create_spat
-0000e650: 6961 6c5f 696e 6465 782c 0a20 2020 2020  ial_index,.     
-0000e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e670: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000e680: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6a0: 2020 2020 2020 2023 2049 6620 6764 6620         # If gdf 
-0000e6b0: 7772 6974 7465 6e20 746f 2074 656d 7020  written to temp 
-0000e6c0: 6669 6c65 2c20 7573 6520 6170 7065 6e64  file, use append
-0000e6d0: 5f74 6f5f 6e6f 6c6f 636b 202b 2063 6c65  _to_nolock + cle
-0000e6e0: 616e 7570 0a20 2020 2020 2020 2020 2020  anup.           
-0000e6f0: 2020 2020 2020 2020 2020 2020 205f 6170               _ap
-0000e700: 7065 6e64 5f74 6f5f 6e6f 6c6f 636b 280a  pend_to_nolock(.
-0000e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e720: 2020 2020 2020 2020 2020 2020 7372 633d              src=
-0000e730: 6764 6674 656d 705f 7061 7468 2c0a 2020  gdftemp_path,.  
-0000e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e750: 2020 2020 2020 2020 2020 6473 743d 7061            dst=pa
-0000e760: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e780: 6473 745f 6c61 7965 723d 6c61 7965 722c  dst_layer=layer,
-0000e790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e7a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000e7b0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-0000e7c0: 7279 7479 7065 3d66 6f72 6365 5f6f 7574  rytype=force_out
-0000e7d0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000e7e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e7f0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
-0000e800: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-0000e810: 6578 3d63 7265 6174 655f 7370 6174 6961  ex=create_spatia
-0000e820: 6c5f 696e 6465 782c 0a20 2020 2020 2020  l_index,.       
-0000e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e840: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000e850: 2020 2020 2020 2020 2020 2072 656d 6f76             remov
-0000e860: 6528 6764 6674 656d 705f 7061 7468 290a  e(gdftemp_path).
-0000e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e880: 2020 2020 2020 2020 6966 2067 6466 7465          if gdfte
-0000e890: 6d70 5f6c 6f63 6b70 6174 6820 6973 206e  mp_lockpath is n
-0000e8a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8c0: 2020 2020 2067 6466 7465 6d70 5f6c 6f63       gdftemp_loc
-0000e8d0: 6b70 6174 682e 756e 6c69 6e6b 2829 0a20  kpath.unlink(). 
-0000e8e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000e8f0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0000e900: 6173 2065 783a 0a20 2020 2020 2020 2020  as ex:.         
-0000e910: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0000e920: 7371 6c69 7465 206f 7574 7075 7420 6669  sqlite output fi
-0000e930: 6c65 206c 6f63 6b65 642c 2061 6c73 6f20  le locked, also 
-0000e940: 7265 7472 790a 2020 2020 2020 2020 2020  retry.          
-0000e950: 2020 2020 2020 2020 2020 6966 2067 656f            if geo
-0000e960: 6669 6c65 7479 7065 2e69 735f 7370 6174  filetype.is_spat
-0000e970: 6961 6c69 7465 5f62 6173 6564 2061 6e64  ialite_based and
-0000e980: 2073 7472 2865 7829 206e 6f74 2069 6e20   str(ex) not in 
-0000e990: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0000e9a0: 2020 2020 2020 2020 2020 2264 6174 6162            "datab
-0000e9b0: 6173 6520 6973 206c 6f63 6b65 6422 2c0a  ase is locked",.
-0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9d0: 2020 2020 2020 2020 2261 7474 656d 7074          "attempt
-0000e9e0: 2074 6f20 7772 6974 6520 6120 7265 6164   to write a read
-0000e9f0: 6f6e 6c79 2064 6174 6162 6173 6522 2c0a  only database",.
-0000ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea10: 2020 2020 5d3a 0a20 2020 2020 2020 2020      ]:.         
-0000ea20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ea30: 6169 7365 2065 780a 2020 2020 2020 2020  aise ex.        
-0000ea40: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-0000ea50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ea60: 2020 2020 2072 6561 6479 203d 2054 7275       ready = Tru
-0000ea70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000ea80: 2020 2020 2020 6c6f 636b 6669 6c65 2e75        lockfile.u
-0000ea90: 6e6c 696e 6b28 290a 2020 2020 2020 2020  nlink().        
-0000eaa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000eab0: 2020 2020 2020 2020 2020 7469 6d65 5f77            time_w
-0000eac0: 6169 7469 6e67 203d 2028 6461 7465 7469  aiting = (dateti
-0000ead0: 6d65 2e64 6174 6574 696d 652e 6e6f 7728  me.datetime.now(
-0000eae0: 2920 2d20 7374 6172 745f 7469 6d65 292e  ) - start_time).
-0000eaf0: 746f 7461 6c5f 7365 636f 6e64 7328 290a  total_seconds().
-0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb10: 6966 2074 696d 655f 7761 6974 696e 6720  if time_waiting 
-0000eb20: 3e20 6170 7065 6e64 5f74 696d 656f 7574  > append_timeout
-0000eb30: 5f73 3a0a 2020 2020 2020 2020 2020 2020  _s:.            
-0000eb40: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-0000eb50: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
-0000eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb70: 2020 2020 6622 746f 5f66 696c 6520 7469      f"to_file ti
-0000eb80: 6d65 6f75 7420 6f66 207b 6170 7065 6e64  meout of {append
-0000eb90: 5f74 696d 656f 7574 5f73 7d20 7265 6163  _timeout_s} reac
-0000eba0: 6865 642c 2073 746f 7020 6170 7065 6e64  hed, stop append
-0000ebb0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000ebc0: 2020 2020 2020 2020 2020 2066 2274 6f20             f"to 
-0000ebd0: 7b70 6174 687d 2122 0a20 2020 2020 2020  {path}!".       
-0000ebe0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0000ebf0: 2020 2020 2020 2020 2020 2020 2320 536c              # Sl
-0000ec00: 6565 7020 666f 7220 6120 7365 636f 6e64  eep for a second
-0000ec10: 2062 6566 6f72 6520 7472 7969 6e67 2061   before trying a
-0000ec20: 6761 696e 0a20 2020 2020 2020 2020 2020  gain.           
-0000ec30: 2074 696d 652e 736c 6565 7028 3129 0a0a   time.sleep(1)..
-0000ec40: 0a64 6566 205f 746f 5f66 696c 655f 7079  .def _to_file_py
-0000ec50: 6f67 7269 6f28 0a20 2020 2067 6466 3a20  ogrio(.    gdf: 
-0000ec60: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000ec70: 2c0a 2020 2020 7061 7468 3a20 5061 7468  ,.    path: Path
-0000ec80: 2c0a 2020 2020 6c61 7965 723a 2073 7472  ,.    layer: str
-0000ec90: 2c0a 2020 2020 666f 7263 655f 6f75 7470  ,.    force_outp
-0000eca0: 7574 5f67 656f 6d65 7472 7974 7970 653a  ut_geometrytype:
-0000ecb0: 2055 6e69 6f6e 5b47 656f 6d65 7472 7954   Union[GeometryT
-0000ecc0: 7970 652c 2073 7472 2c20 4e6f 6e65 5d20  ype, str, None] 
-0000ecd0: 3d20 4e6f 6e65 2c0a 2020 2020 666f 7263  = None,.    forc
-0000ece0: 655f 6d75 6c74 6974 7970 653a 2062 6f6f  e_multitype: boo
-0000ecf0: 6c20 3d20 4661 6c73 652c 0a20 2020 2061  l = False,.    a
-0000ed00: 7070 656e 643a 2062 6f6f 6c20 3d20 4661  ppend: bool = Fa
-0000ed10: 6c73 652c 0a20 2020 2061 7070 656e 645f  lse,.    append_
-0000ed20: 7469 6d65 6f75 745f 733a 2069 6e74 203d  timeout_s: int =
-0000ed30: 2036 3030 2c0a 2020 2020 696e 6465 783a   600,.    index:
-0000ed40: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-0000ed50: 3d20 4e6f 6e65 2c0a 2020 2020 6372 6561  = None,.    crea
-0000ed60: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000ed70: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-0000ed80: 203d 2054 7275 652c 0a29 3a0a 2020 2020   = True,.):.    
-0000ed90: 2222 220a 2020 2020 5772 6974 6573 2061  """.    Writes a
-0000eda0: 2070 616e 6461 7320 6461 7461 6672 616d   pandas datafram
-0000edb0: 6520 746f 2066 696c 6520 7573 696e 6720  e to file using 
-0000edc0: 7079 6f67 7269 6f2e 0a0a 2020 2020 5265  pyogrio...    Re
-0000edd0: 6d61 726b 3a20 7468 6973 2066 756e 6374  mark: this funct
-0000ede0: 696f 6e20 6f6e 6c79 2073 7570 706f 7274  ion only support
-0000edf0: 7320 7772 6974 696e 6720 4765 6f44 6174  s writing GeoDat
-0000ee00: 6146 7261 6d65 7320 6174 2074 6865 206d  aFrames at the m
-0000ee10: 6f6d 656e 742e 0a20 2020 2022 2222 0a20  oment..    """. 
-0000ee20: 2020 2023 2050 7265 7061 7265 2061 7267     # Prepare arg
-0000ee30: 7320 666f 7220 7772 6974 655f 6461 7461  s for write_data
-0000ee40: 6672 616d 650a 2020 2020 6b77 6172 6773  frame.    kwargs
-0000ee50: 203d 207b 7d0a 2020 2020 6b77 6172 6773   = {}.    kwargs
-0000ee60: 5b22 656e 6769 6e65 225d 203d 2022 7079  ["engine"] = "py
-0000ee70: 6f67 7269 6f22 0a0a 2020 2020 2320 4368  ogrio"..    # Ch
-0000ee80: 6563 6b20 7570 6672 6f6e 7420 6966 2061  eck upfront if a
-0000ee90: 7070 656e 6420 6973 2067 6f69 6e67 2074  ppend is going t
-0000eea0: 6f20 776f 726b 2074 6f20 6769 7665 206e  o work to give n
-0000eeb0: 6963 6520 6572 726f 720a 2020 2020 6966  ice error.    if
-0000eec0: 2061 7070 656e 6420 6973 2054 7275 6520   append is True 
-0000eed0: 616e 6420 7061 7468 2e65 7869 7374 7328  and path.exists(
-0000eee0: 293a 0a20 2020 2020 2020 206b 7761 7267  ):.        kwarg
-0000eef0: 735b 2261 7070 656e 6422 5d20 3d20 5472  s["append"] = Tr
-0000ef00: 7565 0a20 2020 2020 2020 206c 6179 6572  ue.        layer
-0000ef10: 696e 666f 203d 2067 6574 5f6c 6179 6572  info = get_layer
-0000ef20: 696e 666f 2870 6174 682c 206c 6179 6572  info(path, layer
-0000ef30: 290a 2020 2020 2020 2020 6669 6c65 5f63  ).        file_c
-0000ef40: 6f6c 7320 3d20 5b63 6f6c 2e75 7070 6572  ols = [col.upper
-0000ef50: 2829 2066 6f72 2063 6f6c 2069 6e20 6c61  () for col in la
-0000ef60: 7965 7269 6e66 6f2e 636f 6c75 6d6e 735d  yerinfo.columns]
-0000ef70: 0a20 2020 2020 2020 2067 6466 5f63 6f6c  .        gdf_col
-0000ef80: 7320 3d20 5b63 6f6c 2e75 7070 6572 2829  s = [col.upper()
-0000ef90: 2066 6f72 2063 6f6c 2069 6e20 6764 662e   for col in gdf.
-0000efa0: 636f 6c75 6d6e 7320 6966 2063 6f6c 2021  columns if col !
-0000efb0: 3d20 6764 662e 6765 6f6d 6574 7279 2e6e  = gdf.geometry.n
-0000efc0: 616d 655d 0a20 2020 2020 2020 2069 6620  ame].        if 
-0000efd0: 6764 665f 636f 6c73 2021 3d20 6669 6c65  gdf_cols != file
-0000efe0: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
-0000eff0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000f000: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000f010: 2020 2020 2022 6465 7374 696e 6174 696f       "destinatio
-0000f020: 6e20 6c61 7965 7220 646f 6573 6e27 7420  n layer doesn't 
-0000f030: 6861 7665 2074 6865 2073 616d 6520 636f  have the same co
-0000f040: 6c75 6d6e 7320 6173 2067 6466 3a20 220a  lumns as gdf: ".
-0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f060: 6622 7b66 696c 655f 636f 6c73 7d20 7673  f"{file_cols} vs
-0000f070: 207b 6764 665f 636f 6c73 7d22 0a20 2020   {gdf_cols}".   
-0000f080: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000f090: 6966 2063 7265 6174 655f 7370 6174 6961  if create_spatia
-0000f0a0: 6c5f 696e 6465 7820 6973 206e 6f74 204e  l_index is not N
-0000f0b0: 6f6e 653a 0a20 2020 2020 2020 206b 7761  one:.        kwa
-0000f0c0: 7267 735b 2253 5041 5449 414c 5f49 4e44  rgs["SPATIAL_IND
-0000f0d0: 4558 225d 203d 2063 7265 6174 655f 7370  EX"] = create_sp
-0000f0e0: 6174 6961 6c5f 696e 6465 780a 2020 2020  atial_index.    
-0000f0f0: 6765 6f66 696c 6574 7970 6520 3d20 4765  geofiletype = Ge
-0000f100: 6f66 696c 6554 7970 6528 7061 7468 290a  ofileType(path).
-0000f110: 2020 2020 6b77 6172 6773 5b22 6472 6976      kwargs["driv
-0000f120: 6572 225d 203d 2067 656f 6669 6c65 7479  er"] = geofilety
-0000f130: 7065 2e6f 6772 6472 6976 6572 0a20 2020  pe.ogrdriver.   
-0000f140: 206b 7761 7267 735b 2269 6e64 6578 225d   kwargs["index"]
-0000f150: 203d 2069 6e64 6578 0a20 2020 2069 6620   = index.    if 
-0000f160: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-0000f170: 6e64 6578 2069 7320 6e6f 7420 4e6f 6e65  ndex is not None
-0000f180: 3a0a 2020 2020 2020 2020 6b77 6172 6773  :.        kwargs
-0000f190: 5b22 5350 4154 4941 4c5f 494e 4445 5822  ["SPATIAL_INDEX"
-0000f1a0: 5d20 3d20 6372 6561 7465 5f73 7061 7469  ] = create_spati
-0000f1b0: 616c 5f69 6e64 6578 0a20 2020 2069 6620  al_index.    if 
-0000f1c0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000f1d0: 6d65 7472 7974 7970 6520 6973 206e 6f74  metrytype is not
-0000f1e0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-0000f1f0: 6620 6973 696e 7374 616e 6365 2866 6f72  f isinstance(for
-0000f200: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-0000f210: 7279 7479 7065 2c20 4765 6f6d 6574 7279  rytype, Geometry
-0000f220: 5479 7065 293a 0a20 2020 2020 2020 2020  Type):.         
-0000f230: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
-0000f240: 6765 6f6d 6574 7279 7479 7065 203d 2066  geometrytype = f
-0000f250: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-0000f260: 6574 7279 7479 7065 2e6e 616d 655f 6361  etrytype.name_ca
-0000f270: 6d65 6c63 6173 650a 2020 2020 2020 2020  melcase.        
-0000f280: 6b77 6172 6773 5b22 6765 6f6d 6574 7279  kwargs["geometry
-0000f290: 5f74 7970 6522 5d20 3d20 666f 7263 655f  _type"] = force_
-0000f2a0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-0000f2b0: 7970 650a 2020 2020 6966 2066 6f72 6365  ype.    if force
-0000f2c0: 5f6d 756c 7469 7479 7065 3a0a 2020 2020  _multitype:.    
-0000f2d0: 2020 2020 6b77 6172 6773 5b22 7072 6f6d      kwargs["prom
-0000f2e0: 6f74 655f 746f 5f6d 756c 7469 225d 203d  ote_to_multi"] =
-0000f2f0: 2054 7275 650a 0a20 2020 2023 204e 6f77   True..    # Now
-0000f300: 2077 6520 6361 6e20 7772 6974 650a 2020   we can write.  
-0000f310: 2020 6966 2067 656f 6669 6c65 7479 7065    if geofiletype
-0000f320: 2e69 735f 7369 6e67 6c65 6c61 7965 723a  .is_singlelayer:
-0000f330: 0a20 2020 2020 2020 2067 6466 2e74 6f5f  .        gdf.to_
-0000f340: 6669 6c65 2873 7472 2870 6174 6829 2c20  file(str(path), 
-0000f350: 2a2a 6b77 6172 6773 290a 2020 2020 656c  **kwargs).    el
-0000f360: 7365 3a0a 2020 2020 2020 2020 6764 662e  se:.        gdf.
-0000f370: 746f 5f66 696c 6528 7374 7228 7061 7468  to_file(str(path
-0000f380: 292c 206c 6179 6572 3d6c 6179 6572 2c20  ), layer=layer, 
-0000f390: 2a2a 6b77 6172 6773 290a 0a0a 6465 6620  **kwargs)...def 
-0000f3a0: 6765 745f 6372 7328 7061 7468 3a20 556e  get_crs(path: Un
-0000f3b0: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-0000f3c0: 684c 696b 655b 416e 795d 225d 2920 2d3e  hLike[Any]"]) ->
-0000f3d0: 2070 7970 726f 6a2e 4352 533a 0a20 2020   pyproj.CRS:.   
-0000f3e0: 2022 2222 0a20 2020 2047 6574 2074 6865   """.    Get the
-0000f3f0: 2043 5253 2028 7072 6f6a 6563 7469 6f6e   CRS (projection
-0000f400: 2920 6f66 2074 6865 2066 696c 650a 0a20  ) of the file.. 
-0000f410: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000f420: 2070 6174 6820 2850 6174 684c 696b 6529   path (PathLike)
-0000f430: 3a20 5061 7468 2074 6f20 7468 6520 6669  : Path to the fi
-0000f440: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
-0000f450: 3a0a 2020 2020 2020 2020 7079 7072 6f6a  :.        pyproj
-0000f460: 2e43 5253 3a20 5468 6520 7072 6f6a 6563  .CRS: The projec
-0000f470: 7469 6f6e 206f 6620 7468 6520 6669 6c65  tion of the file
-0000f480: 0a20 2020 2022 2222 0a20 2020 2023 2054  .    """.    # T
-0000f490: 4f44 4f3a 2073 6565 6d73 206c 696b 6520  ODO: seems like 
-0000f4a0: 7375 7070 6f72 7420 666f 7220 6d75 6c74  support for mult
-0000f4b0: 6970 6c65 206c 6179 6572 7320 696e 2074  iple layers in t
-0000f4c0: 6865 2066 696c 6520 6973 6e27 7420 6865  he file isn't he
-0000f4d0: 7265 2079 6574 3f3f 3f0a 2020 2020 7769  re yet???.    wi
-0000f4e0: 7468 2066 696f 6e61 2e6f 7065 6e28 7374  th fiona.open(st
-0000f4f0: 7228 7061 7468 292c 2022 7222 2920 6173  r(path), "r") as
-0000f500: 2067 656f 6669 6c65 3a0a 2020 2020 2020   geofile:.      
-0000f510: 2020 6173 7365 7274 2067 656f 6669 6c65    assert geofile
-0000f520: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0000f530: 2020 2020 2072 6574 7572 6e20 7079 7072       return pypr
-0000f540: 6f6a 2e43 5253 2867 656f 6669 6c65 2e63  oj.CRS(geofile.c
-0000f550: 7273 290a 0a0a 6465 6620 6973 5f67 656f  rs)...def is_geo
-0000f560: 6669 6c65 2870 6174 683a 2055 6e69 6f6e  file(path: Union
-0000f570: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
-0000f580: 6b65 5b41 6e79 5d22 5d29 202d 3e20 626f  ke[Any]"]) -> bo
-0000f590: 6f6c 3a0a 2020 2020 2222 220a 2020 2020  ol:.    """.    
-0000f5a0: 4465 7465 726d 696e 6573 2062 6173 6564  Determines based
-0000f5b0: 206f 6e20 7468 6520 6669 6c65 7061 7468   on the filepath
-0000f5c0: 2069 6620 7468 6973 2069 7320 6120 6765   if this is a ge
-0000f5d0: 6f66 696c 652e 0a0a 2020 2020 4172 6773  ofile...    Args
-0000f5e0: 3a0a 2020 2020 2020 2020 7061 7468 2028  :.        path (
-0000f5f0: 5061 7468 4c69 6b65 293a 2054 6865 2066  PathLike): The f
-0000f600: 696c 6520 7061 7468 2e0a 0a20 2020 2052  ile path...    R
-0000f610: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000f620: 626f 6f6c 3a20 5472 7565 2069 6620 6974  bool: True if it
-0000f630: 2069 7320 6120 6765 6f20 6669 6c65 2e0a   is a geo file..
-0000f640: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
-0000f650: 726e 2069 735f 6765 6f66 696c 655f 6578  rn is_geofile_ex
-0000f660: 7428 5061 7468 2870 6174 6829 2e73 7566  t(Path(path).suf
-0000f670: 6669 7829 0a0a 0a64 6566 2069 735f 6765  fix)...def is_ge
-0000f680: 6f66 696c 655f 6578 7428 6669 6c65 5f65  ofile_ext(file_e
-0000f690: 7874 3a20 7374 7229 202d 3e20 626f 6f6c  xt: str) -> bool
-0000f6a0: 3a0a 2020 2020 2222 220a 2020 2020 4465  :.    """.    De
-0000f6b0: 7465 726d 696e 6573 2062 6173 6564 206f  termines based o
-0000f6c0: 6e20 7468 6520 6669 6c65 2065 7874 656e  n the file exten
-0000f6d0: 7369 6f6e 2069 6620 7468 6973 2069 7320  sion if this is 
-0000f6e0: 6120 6765 6f66 696c 652e 0a0a 2020 2020  a geofile...    
-0000f6f0: 4172 6773 3a0a 2020 2020 2020 2020 6669  Args:.        fi
-0000f700: 6c65 5f65 7874 2028 7374 7229 3a20 7468  le_ext (str): th
-0000f710: 6520 6578 7465 6e73 696f 6e2e 0a0a 2020  e extension...  
-0000f720: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0000f730: 2020 2062 6f6f 6c3a 2054 7275 6520 6966     bool: True if
-0000f740: 2069 7420 6973 2061 2067 656f 6669 6c65   it is a geofile
-0000f750: 2e0a 2020 2020 2222 220a 2020 2020 7472  ..    """.    tr
-0000f760: 793a 0a20 2020 2020 2020 2023 2049 6620  y:.        # If 
-0000f770: 7468 6520 6472 6976 6572 2063 616e 2062  the driver can b
-0000f780: 6520 6465 7465 726d 696e 6564 2c20 6974  e determined, it
-0000f790: 2069 7320 6120 2873 7570 706f 7274 6564   is a (supported
-0000f7a0: 2920 6765 6f20 6669 6c65 2e0a 2020 2020  ) geo file..    
-0000f7b0: 2020 2020 5f20 3d20 4765 6f66 696c 6554      _ = GeofileT
-0000f7c0: 7970 6528 6669 6c65 5f65 7874 290a 2020  ype(file_ext).  
-0000f7d0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000f7e0: 650a 2020 2020 6578 6365 7074 2045 7863  e.    except Exc
-0000f7f0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000f800: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
-0000f810: 6566 2063 6d70 280a 2020 2020 7061 7468  ef cmp(.    path
-0000f820: 313a 2055 6e69 6f6e 5b73 7472 2c20 226f  1: Union[str, "o
-0000f830: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-0000f840: 5d2c 2070 6174 6832 3a20 556e 696f 6e5b  ], path2: Union[
-0000f850: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
-0000f860: 655b 416e 795d 225d 0a29 202d 3e20 626f  e[Any]"].) -> bo
-0000f870: 6f6c 3a0a 2020 2020 2222 220a 2020 2020  ol:.    """.    
-0000f880: 436f 6d70 6172 6520 6966 2074 776f 2067  Compare if two g
-0000f890: 656f 6669 6c65 7320 6172 6520 6964 656e  eofiles are iden
-0000f8a0: 7469 6361 6c2e 0a0a 2020 2020 466f 7220  tical...    For 
-0000f8b0: 6765 6f66 696c 6573 2074 6861 7420 7573  geofiles that us
-0000f8c0: 6520 6d75 6c74 6970 6c65 2066 696c 6573  e multiple files
-0000f8d0: 2c20 616c 6c20 7265 6c65 7661 6e74 2066  , all relevant f
-0000f8e0: 696c 6573 206d 7573 7420 6265 2069 6465  iles must be ide
-0000f8f0: 6e74 6963 616c 2e0a 2020 2020 4567 2e20  ntical..    Eg. 
-0000f900: 666f 7220 7368 6170 6566 696c 6573 2c20  for shapefiles, 
-0000f910: 7468 6520 2e73 6870 2c20 2e73 6878 2061  the .shp, .shx a
-0000f920: 6e64 202e 6462 6620 6669 6c65 206d 7573  nd .dbf file mus
-0000f930: 7420 6265 2069 6465 6e74 6963 616c 2e0a  t be identical..
-0000f940: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000f950: 2020 2070 6174 6831 2028 5061 7468 4c69     path1 (PathLi
-0000f960: 6b65 293a 2070 6174 6820 746f 2074 6865  ke): path to the
-0000f970: 2066 6972 7374 2066 696c 652e 0a20 2020   first file..   
-0000f980: 2020 2020 2070 6174 6832 2028 5061 7468       path2 (Path
-0000f990: 4c69 6b65 293a 2070 6174 6820 746f 2074  Like): path to t
-0000f9a0: 6865 2073 6563 6f6e 6420 6669 6c65 2e0a  he second file..
-0000f9b0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0000f9c0: 2020 2020 2020 626f 6f6c 3a20 5472 7565        bool: True
-0000f9d0: 2069 6620 7468 6520 6669 6c65 7320 6172   if the files ar
-0000f9e0: 6520 6964 656e 7469 6361 6c0a 2020 2020  e identical.    
-0000f9f0: 2222 220a 2020 2020 2320 4368 6563 6b20  """.    # Check 
-0000fa00: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
-0000fa10: 0a20 2020 2070 6174 6831 5f70 203d 2050  .    path1_p = P
-0000fa20: 6174 6828 7061 7468 3129 0a20 2020 2070  ath(path1).    p
-0000fa30: 6174 6832 5f70 203d 2050 6174 6828 7061  ath2_p = Path(pa
-0000fa40: 7468 3229 0a0a 2020 2020 2320 466f 7220  th2)..    # For 
-0000fa50: 6120 7368 6170 6566 696c 652c 206d 756c  a shapefile, mul
-0000fa60: 7469 706c 6520 6669 6c65 7320 6e65 6564  tiple files need
-0000fa70: 2074 6f20 6265 2063 6f6d 7061 7265 640a   to be compared.
-0000fa80: 2020 2020 6966 2070 6174 6831 5f70 2e73      if path1_p.s
-0000fa90: 7566 6669 782e 6c6f 7765 7228 2920 3d3d  uffix.lower() ==
-0000faa0: 2022 2e73 6870 223a 0a20 2020 2020 2020   ".shp":.       
-0000fab0: 2070 6174 6832 5f6e 6f65 7874 2c20 5f20   path2_noext, _ 
-0000fac0: 3d20 6f73 2e70 6174 682e 7370 6c69 7465  = os.path.splite
-0000fad0: 7874 2870 6174 6832 5f70 290a 2020 2020  xt(path2_p).    
-0000fae0: 2020 2020 7368 6170 6566 696c 655f 6261      shapefile_ba
-0000faf0: 7365 5f73 7566 6669 7865 7320 3d20 5b22  se_suffixes = ["
-0000fb00: 2e73 6870 222c 2022 2e64 6266 222c 2022  .shp", ".dbf", "
-0000fb10: 2e73 6878 225d 0a20 2020 2020 2020 2070  .shx"].        p
-0000fb20: 6174 6831 5f6e 6f65 7874 203d 2070 6174  ath1_noext = pat
-0000fb30: 6831 5f70 2e70 6172 656e 7420 2f20 7061  h1_p.parent / pa
-0000fb40: 7468 315f 702e 7374 656d 0a20 2020 2020  th1_p.stem.     
-0000fb50: 2020 2070 6174 6832 5f6e 6f65 7874 203d     path2_noext =
-0000fb60: 2070 6174 6832 5f70 2e70 6172 656e 7420   path2_p.parent 
-0000fb70: 2f20 7061 7468 325f 702e 7374 656d 0a20  / path2_p.stem. 
-0000fb80: 2020 2020 2020 2066 6f72 2065 7874 2069         for ext i
-0000fb90: 6e20 7368 6170 6566 696c 655f 6261 7365  n shapefile_base
-0000fba0: 5f73 7566 6669 7865 733a 0a20 2020 2020  _suffixes:.     
-0000fbb0: 2020 2020 2020 2069 6620 6e6f 7420 6669         if not fi
-0000fbc0: 6c65 636d 702e 636d 7028 6622 7b73 7472  lecmp.cmp(f"{str
-0000fbd0: 2870 6174 6831 5f6e 6f65 7874 297d 7b65  (path1_noext)}{e
-0000fbe0: 7874 7d22 2c20 6622 7b73 7472 2870 6174  xt}", f"{str(pat
-0000fbf0: 6832 5f6e 6f65 7874 297d 7b65 7874 7d22  h2_noext)}{ext}"
-0000fc00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000fc10: 2020 206c 6f67 6765 722e 696e 666f 280a     logger.info(.
+0000e4f0: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
+0000e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e510: 2020 2020 2020 2020 206c 6179 6572 3d6c           layer=l
+0000e520: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
+0000e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e540: 2020 696e 6465 783d 696e 6465 782c 0a20    index=index,. 
+0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e560: 2020 2020 2020 2020 2020 2066 6f72 6365             force
+0000e570: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000e580: 7479 7065 3d66 6f72 6365 5f6f 7574 7075  type=force_outpu
+0000e590: 745f 6765 6f6d 6574 7279 7479 7065 2c0a  t_geometrytype,.
+0000e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5b0: 2020 2020 2020 2020 2020 2020 666f 7263              forc
+0000e5c0: 655f 6d75 6c74 6974 7970 653d 666f 7263  e_multitype=forc
+0000e5d0: 655f 6d75 6c74 6974 7970 652c 0a20 2020  e_multitype,.   
+0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5f0: 2020 2020 2020 2020 2061 7070 656e 643d           append=
+0000e600: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e620: 2020 7363 6865 6d61 3d73 6368 656d 612c    schema=schema,
+0000e630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e640: 2020 2020 2020 2020 2020 2020 2063 7265               cre
+0000e650: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+0000e660: 783d 6372 6561 7465 5f73 7061 7469 616c  x=create_spatial
+0000e670: 5f69 6e64 6578 2c0a 2020 2020 2020 2020  _index,.        
+0000e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e690: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e6a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6c0: 2020 2020 2320 4966 2067 6466 2077 7269      # If gdf wri
+0000e6d0: 7474 656e 2074 6f20 7465 6d70 2066 696c  tten to temp fil
+0000e6e0: 652c 2075 7365 2061 7070 656e 645f 746f  e, use append_to
+0000e6f0: 5f6e 6f6c 6f63 6b20 2b20 636c 6561 6e75  _nolock + cleanu
+0000e700: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+0000e710: 2020 2020 2020 2020 2020 5f61 7070 656e            _appen
+0000e720: 645f 746f 5f6e 6f6c 6f63 6b28 0a20 2020  d_to_nolock(.   
+0000e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e740: 2020 2020 2020 2020 2073 7263 3d67 6466           src=gdf
+0000e750: 7465 6d70 5f70 6174 682c 0a20 2020 2020  temp_path,.     
+0000e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e770: 2020 2020 2020 2064 7374 3d70 6174 682c         dst=path,
+0000e780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e790: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+0000e7a0: 5f6c 6179 6572 3d6c 6179 6572 2c0a 2020  _layer=layer,.  
+0000e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7c0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+0000e7d0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+0000e7e0: 7970 653d 666f 7263 655f 6f75 7470 7574  ype=force_output
+0000e7f0: 5f67 656f 6d65 7472 7974 7970 652c 0a20  _geometrytype,. 
+0000e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e810: 2020 2020 2020 2020 2020 2063 7265 6174             creat
+0000e820: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
+0000e830: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+0000e840: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
+0000e850: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e870: 2020 2020 2020 2020 7265 6d6f 7665 2867          remove(g
+0000e880: 6466 7465 6d70 5f70 6174 6829 0a20 2020  dftemp_path).   
+0000e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8a0: 2020 2020 2069 6620 6764 6674 656d 705f       if gdftemp_
+0000e8b0: 6c6f 636b 7061 7468 2069 7320 6e6f 7420  lockpath is not 
+0000e8c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8e0: 2020 6764 6674 656d 705f 6c6f 636b 7061    gdftemp_lockpa
+0000e8f0: 7468 2e75 6e6c 696e 6b28 290a 2020 2020  th.unlink().    
+0000e900: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000e910: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0000e920: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
+0000e930: 2020 2020 2020 2020 2320 4966 2073 716c          # If sql
+0000e940: 6974 6520 6f75 7470 7574 2066 696c 6520  ite output file 
+0000e950: 6c6f 636b 6564 2c20 616c 736f 2072 6574  locked, also ret
+0000e960: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
+0000e970: 2020 2020 2020 2069 6620 6765 6f66 696c         if geofil
+0000e980: 6574 7970 652e 6973 5f73 7061 7469 616c  etype.is_spatial
+0000e990: 6974 655f 6261 7365 6420 616e 6420 7374  ite_based and st
+0000e9a0: 7228 6578 2920 6e6f 7420 696e 205b 0a20  r(ex) not in [. 
+0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9c0: 2020 2020 2020 2022 6461 7461 6261 7365         "database
+0000e9d0: 2069 7320 6c6f 636b 6564 222c 0a20 2020   is locked",.   
+0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9f0: 2020 2020 2022 6174 7465 6d70 7420 746f       "attempt to
+0000ea00: 2077 7269 7465 2061 2072 6561 646f 6e6c   write a readonl
+0000ea10: 7920 6461 7461 6261 7365 222c 0a20 2020  y database",.   
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea30: 205d 3a0a 2020 2020 2020 2020 2020 2020   ]:.            
+0000ea40: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000ea50: 6520 6578 0a20 2020 2020 2020 2020 2020  e ex.           
+0000ea60: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
+0000ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea80: 2020 7265 6164 7920 3d20 5472 7565 0a20    ready = True. 
+0000ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eaa0: 2020 206c 6f63 6b66 696c 652e 756e 6c69     lockfile.unli
+0000eab0: 6e6b 2829 0a20 2020 2020 2020 2020 2020  nk().           
+0000eac0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ead0: 2020 2020 2020 2074 696d 655f 7761 6974         time_wait
+0000eae0: 696e 6720 3d20 2864 6174 6574 696d 652e  ing = (datetime.
+0000eaf0: 6461 7465 7469 6d65 2e6e 6f77 2829 202d  datetime.now() -
+0000eb00: 2073 7461 7274 5f74 696d 6529 2e74 6f74   start_time).tot
+0000eb10: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
+0000eb20: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000eb30: 7469 6d65 5f77 6169 7469 6e67 203e 2061  time_waiting > a
+0000eb40: 7070 656e 645f 7469 6d65 6f75 745f 733a  ppend_timeout_s:
+0000eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eb60: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0000eb70: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb90: 2066 2274 6f5f 6669 6c65 2074 696d 656f   f"to_file timeo
+0000eba0: 7574 206f 6620 7b61 7070 656e 645f 7469  ut of {append_ti
+0000ebb0: 6d65 6f75 745f 737d 2072 6561 6368 6564  meout_s} reached
+0000ebc0: 2c20 7374 6f70 2061 7070 656e 6420 220a  , stop append ".
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebe0: 2020 2020 2020 2020 6622 746f 207b 7061          f"to {pa
+0000ebf0: 7468 7d21 220a 2020 2020 2020 2020 2020  th}!".          
+0000ec00: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000ec10: 2020 2020 2020 2020 2023 2053 6c65 6570           # Sleep
+0000ec20: 2066 6f72 2061 2073 6563 6f6e 6420 6265   for a second be
+0000ec30: 666f 7265 2074 7279 696e 6720 6167 6169  fore trying agai
+0000ec40: 6e0a 2020 2020 2020 2020 2020 2020 7469  n.            ti
+0000ec50: 6d65 2e73 6c65 6570 2831 290a 0a0a 6465  me.sleep(1)...de
+0000ec60: 6620 5f74 6f5f 6669 6c65 5f70 796f 6772  f _to_file_pyogr
+0000ec70: 696f 280a 2020 2020 6764 663a 2067 7064  io(.    gdf: gpd
+0000ec80: 2e47 656f 4461 7461 4672 616d 652c 0a20  .GeoDataFrame,. 
+0000ec90: 2020 2070 6174 683a 2050 6174 682c 0a20     path: Path,. 
+0000eca0: 2020 206c 6179 6572 3a20 7374 722c 0a20     layer: str,. 
+0000ecb0: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
+0000ecc0: 6765 6f6d 6574 7279 7479 7065 3a20 556e  geometrytype: Un
+0000ecd0: 696f 6e5b 4765 6f6d 6574 7279 5479 7065  ion[GeometryType
+0000ece0: 2c20 7374 722c 204e 6f6e 655d 203d 204e  , str, None] = N
+0000ecf0: 6f6e 652c 0a20 2020 2066 6f72 6365 5f6d  one,.    force_m
+0000ed00: 756c 7469 7479 7065 3a20 626f 6f6c 203d  ultitype: bool =
+0000ed10: 2046 616c 7365 2c0a 2020 2020 6170 7065   False,.    appe
+0000ed20: 6e64 3a20 626f 6f6c 203d 2046 616c 7365  nd: bool = False
+0000ed30: 2c0a 2020 2020 6170 7065 6e64 5f74 696d  ,.    append_tim
+0000ed40: 656f 7574 5f73 3a20 696e 7420 3d20 3630  eout_s: int = 60
+0000ed50: 302c 0a20 2020 2069 6e64 6578 3a20 4f70  0,.    index: Op
+0000ed60: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+0000ed70: 6f6e 652c 0a20 2020 2063 7265 6174 655f  one,.    create_
+0000ed80: 7370 6174 6961 6c5f 696e 6465 783a 204f  spatial_index: O
+0000ed90: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000eda0: 5472 7565 2c0a 293a 0a20 2020 2022 2222  True,.):.    """
+0000edb0: 0a20 2020 2057 7269 7465 7320 6120 7061  .    Writes a pa
+0000edc0: 6e64 6173 2064 6174 6166 7261 6d65 2074  ndas dataframe t
+0000edd0: 6f20 6669 6c65 2075 7369 6e67 2070 796f  o file using pyo
+0000ede0: 6772 696f 2e0a 0a20 2020 2052 656d 6172  grio...    Remar
+0000edf0: 6b3a 2074 6869 7320 6675 6e63 7469 6f6e  k: this function
+0000ee00: 206f 6e6c 7920 7375 7070 6f72 7473 2077   only supports w
+0000ee10: 7269 7469 6e67 2047 656f 4461 7461 4672  riting GeoDataFr
+0000ee20: 616d 6573 2061 7420 7468 6520 6d6f 6d65  ames at the mome
+0000ee30: 6e74 2e0a 2020 2020 2222 220a 2020 2020  nt..    """.    
+0000ee40: 2320 5072 6570 6172 6520 6172 6773 2066  # Prepare args f
+0000ee50: 6f72 2077 7269 7465 5f64 6174 6166 7261  or write_datafra
+0000ee60: 6d65 0a20 2020 206b 7761 7267 7320 3d20  me.    kwargs = 
+0000ee70: 7b7d 0a20 2020 206b 7761 7267 735b 2265  {}.    kwargs["e
+0000ee80: 6e67 696e 6522 5d20 3d20 2270 796f 6772  ngine"] = "pyogr
+0000ee90: 696f 220a 0a20 2020 2023 2043 6865 636b  io"..    # Check
+0000eea0: 2075 7066 726f 6e74 2069 6620 6170 7065   upfront if appe
+0000eeb0: 6e64 2069 7320 676f 696e 6720 746f 2077  nd is going to w
+0000eec0: 6f72 6b20 746f 2067 6976 6520 6e69 6365  ork to give nice
+0000eed0: 2065 7272 6f72 0a20 2020 2069 6620 6170   error.    if ap
+0000eee0: 7065 6e64 2069 7320 5472 7565 2061 6e64  pend is True and
+0000eef0: 2070 6174 682e 6578 6973 7473 2829 3a0a   path.exists():.
+0000ef00: 2020 2020 2020 2020 6b77 6172 6773 5b22          kwargs["
+0000ef10: 6170 7065 6e64 225d 203d 2054 7275 650a  append"] = True.
+0000ef20: 2020 2020 2020 2020 6c61 7965 7269 6e66          layerinf
+0000ef30: 6f20 3d20 6765 745f 6c61 7965 7269 6e66  o = get_layerinf
+0000ef40: 6f28 7061 7468 2c20 6c61 7965 7229 0a20  o(path, layer). 
+0000ef50: 2020 2020 2020 2066 696c 655f 636f 6c73         file_cols
+0000ef60: 203d 205b 636f 6c2e 7570 7065 7228 2920   = [col.upper() 
+0000ef70: 666f 7220 636f 6c20 696e 206c 6179 6572  for col in layer
+0000ef80: 696e 666f 2e63 6f6c 756d 6e73 5d0a 2020  info.columns].  
+0000ef90: 2020 2020 2020 6764 665f 636f 6c73 203d        gdf_cols =
+0000efa0: 205b 636f 6c2e 7570 7065 7228 2920 666f   [col.upper() fo
+0000efb0: 7220 636f 6c20 696e 2067 6466 2e63 6f6c  r col in gdf.col
+0000efc0: 756d 6e73 2069 6620 636f 6c20 213d 2067  umns if col != g
+0000efd0: 6466 2e67 656f 6d65 7472 792e 6e61 6d65  df.geometry.name
+0000efe0: 5d0a 2020 2020 2020 2020 6966 2067 6466  ].        if gdf
+0000eff0: 5f63 6f6c 7320 213d 2066 696c 655f 636f  _cols != file_co
+0000f000: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0000f010: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000f020: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000f030: 2020 2264 6573 7469 6e61 7469 6f6e 206c    "destination l
+0000f040: 6179 6572 2064 6f65 736e 2774 2068 6176  ayer doesn't hav
+0000f050: 6520 7468 6520 7361 6d65 2063 6f6c 756d  e the same colum
+0000f060: 6e73 2061 7320 6764 663a 2022 0a20 2020  ns as gdf: ".   
+0000f070: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+0000f080: 6669 6c65 5f63 6f6c 737d 2076 7320 7b67  file_cols} vs {g
+0000f090: 6466 5f63 6f6c 737d 220a 2020 2020 2020  df_cols}".      
+0000f0a0: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
+0000f0b0: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+0000f0c0: 6e64 6578 2069 7320 6e6f 7420 4e6f 6e65  ndex is not None
+0000f0d0: 3a0a 2020 2020 2020 2020 6b77 6172 6773  :.        kwargs
+0000f0e0: 5b22 5350 4154 4941 4c5f 494e 4445 5822  ["SPATIAL_INDEX"
+0000f0f0: 5d20 3d20 6372 6561 7465 5f73 7061 7469  ] = create_spati
+0000f100: 616c 5f69 6e64 6578 0a20 2020 2067 656f  al_index.    geo
+0000f110: 6669 6c65 7479 7065 203d 2047 656f 6669  filetype = Geofi
+0000f120: 6c65 5479 7065 2870 6174 6829 0a20 2020  leType(path).   
+0000f130: 206b 7761 7267 735b 2264 7269 7665 7222   kwargs["driver"
+0000f140: 5d20 3d20 6765 6f66 696c 6574 7970 652e  ] = geofiletype.
+0000f150: 6f67 7264 7269 7665 720a 2020 2020 6b77  ogrdriver.    kw
+0000f160: 6172 6773 5b22 696e 6465 7822 5d20 3d20  args["index"] = 
+0000f170: 696e 6465 780a 2020 2020 6966 2063 7265  index.    if cre
+0000f180: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+0000f190: 7820 6973 206e 6f74 204e 6f6e 653a 0a20  x is not None:. 
+0000f1a0: 2020 2020 2020 206b 7761 7267 735b 2253         kwargs["S
+0000f1b0: 5041 5449 414c 5f49 4e44 4558 225d 203d  PATIAL_INDEX"] =
+0000f1c0: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+0000f1d0: 696e 6465 780a 2020 2020 6966 2066 6f72  index.    if for
+0000f1e0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000f1f0: 7279 7479 7065 2069 7320 6e6f 7420 4e6f  rytype is not No
+0000f200: 6e65 3a0a 2020 2020 2020 2020 6966 2069  ne:.        if i
+0000f210: 7369 6e73 7461 6e63 6528 666f 7263 655f  sinstance(force_
+0000f220: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+0000f230: 7970 652c 2047 656f 6d65 7472 7954 7970  ype, GeometryTyp
+0000f240: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000f250: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+0000f260: 6d65 7472 7974 7970 6520 3d20 666f 7263  metrytype = forc
+0000f270: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+0000f280: 7974 7970 652e 6e61 6d65 5f63 616d 656c  ytype.name_camel
+0000f290: 6361 7365 0a20 2020 2020 2020 206b 7761  case.        kwa
+0000f2a0: 7267 735b 2267 656f 6d65 7472 795f 7479  rgs["geometry_ty
+0000f2b0: 7065 225d 203d 2066 6f72 6365 5f6f 7574  pe"] = force_out
+0000f2c0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+0000f2d0: 0a20 2020 2069 6620 666f 7263 655f 6d75  .    if force_mu
+0000f2e0: 6c74 6974 7970 653a 0a20 2020 2020 2020  ltitype:.       
+0000f2f0: 206b 7761 7267 735b 2270 726f 6d6f 7465   kwargs["promote
+0000f300: 5f74 6f5f 6d75 6c74 6922 5d20 3d20 5472  _to_multi"] = Tr
+0000f310: 7565 0a0a 2020 2020 2320 4e6f 7720 7765  ue..    # Now we
+0000f320: 2063 616e 2077 7269 7465 0a20 2020 2069   can write.    i
+0000f330: 6620 6765 6f66 696c 6574 7970 652e 6973  f geofiletype.is
+0000f340: 5f73 696e 676c 656c 6179 6572 3a0a 2020  _singlelayer:.  
+0000f350: 2020 2020 2020 6764 662e 746f 5f66 696c        gdf.to_fil
+0000f360: 6528 7374 7228 7061 7468 292c 202a 2a6b  e(str(path), **k
+0000f370: 7761 7267 7329 0a20 2020 2065 6c73 653a  wargs).    else:
+0000f380: 0a20 2020 2020 2020 2067 6466 2e74 6f5f  .        gdf.to_
+0000f390: 6669 6c65 2873 7472 2870 6174 6829 2c20  file(str(path), 
+0000f3a0: 6c61 7965 723d 6c61 7965 722c 202a 2a6b  layer=layer, **k
+0000f3b0: 7761 7267 7329 0a0a 0a64 6566 2067 6574  wargs)...def get
+0000f3c0: 5f63 7273 2870 6174 683a 2055 6e69 6f6e  _crs(path: Union
+0000f3d0: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
+0000f3e0: 6b65 5b41 6e79 5d22 5d29 202d 3e20 7079  ke[Any]"]) -> py
+0000f3f0: 7072 6f6a 2e43 5253 3a0a 2020 2020 2222  proj.CRS:.    ""
+0000f400: 220a 2020 2020 4765 7420 7468 6520 4352  ".    Get the CR
+0000f410: 5320 2870 726f 6a65 6374 696f 6e29 206f  S (projection) o
+0000f420: 6620 7468 6520 6669 6c65 0a0a 2020 2020  f the file..    
+0000f430: 4172 6773 3a0a 2020 2020 2020 2020 7061  Args:.        pa
+0000f440: 7468 2028 5061 7468 4c69 6b65 293a 2050  th (PathLike): P
+0000f450: 6174 6820 746f 2074 6865 2066 696c 652e  ath to the file.
+0000f460: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0000f470: 2020 2020 2020 2070 7970 726f 6a2e 4352         pyproj.CR
+0000f480: 533a 2054 6865 2070 726f 6a65 6374 696f  S: The projectio
+0000f490: 6e20 6f66 2074 6865 2066 696c 650a 2020  n of the file.  
+0000f4a0: 2020 2222 220a 2020 2020 2320 544f 444f    """.    # TODO
+0000f4b0: 3a20 7365 656d 7320 6c69 6b65 2073 7570  : seems like sup
+0000f4c0: 706f 7274 2066 6f72 206d 756c 7469 706c  port for multipl
+0000f4d0: 6520 6c61 7965 7273 2069 6e20 7468 6520  e layers in the 
+0000f4e0: 6669 6c65 2069 736e 2774 2068 6572 6520  file isn't here 
+0000f4f0: 7965 743f 3f3f 0a20 2020 2077 6974 6820  yet???.    with 
+0000f500: 6669 6f6e 612e 6f70 656e 2873 7472 2870  fiona.open(str(p
+0000f510: 6174 6829 2c20 2272 2229 2061 7320 6765  ath), "r") as ge
+0000f520: 6f66 696c 653a 0a20 2020 2020 2020 2061  ofile:.        a
+0000f530: 7373 6572 7420 6765 6f66 696c 6520 6973  ssert geofile is
+0000f540: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+0000f550: 2020 7265 7475 726e 2070 7970 726f 6a2e    return pyproj.
+0000f560: 4352 5328 6765 6f66 696c 652e 6372 7329  CRS(geofile.crs)
+0000f570: 0a0a 0a64 6566 2069 735f 6765 6f66 696c  ...def is_geofil
+0000f580: 6528 7061 7468 3a20 556e 696f 6e5b 7374  e(path: Union[st
+0000f590: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
+0000f5a0: 416e 795d 225d 2920 2d3e 2062 6f6f 6c3a  Any]"]) -> bool:
+0000f5b0: 0a20 2020 2022 2222 0a20 2020 2044 6574  .    """.    Det
+0000f5c0: 6572 6d69 6e65 7320 6261 7365 6420 6f6e  ermines based on
+0000f5d0: 2074 6865 2066 696c 6570 6174 6820 6966   the filepath if
+0000f5e0: 2074 6869 7320 6973 2061 2067 656f 6669   this is a geofi
+0000f5f0: 6c65 2e0a 0a20 2020 2041 7267 733a 0a20  le...    Args:. 
+0000f600: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+0000f610: 684c 696b 6529 3a20 5468 6520 6669 6c65  hLike): The file
+0000f620: 2070 6174 682e 0a0a 2020 2020 5265 7475   path...    Retu
+0000f630: 726e 733a 0a20 2020 2020 2020 2062 6f6f  rns:.        boo
+0000f640: 6c3a 2054 7275 6520 6966 2069 7420 6973  l: True if it is
+0000f650: 2061 2067 656f 2066 696c 652e 0a20 2020   a geo file..   
+0000f660: 2022 2222 0a20 2020 2072 6574 7572 6e20   """.    return 
+0000f670: 6973 5f67 656f 6669 6c65 5f65 7874 2850  is_geofile_ext(P
+0000f680: 6174 6828 7061 7468 292e 7375 6666 6978  ath(path).suffix
+0000f690: 290a 0a0a 6465 6620 6973 5f67 656f 6669  )...def is_geofi
+0000f6a0: 6c65 5f65 7874 2866 696c 655f 6578 743a  le_ext(file_ext:
+0000f6b0: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
+0000f6c0: 2020 2022 2222 0a20 2020 2044 6574 6572     """.    Deter
+0000f6d0: 6d69 6e65 7320 6261 7365 6420 6f6e 2074  mines based on t
+0000f6e0: 6865 2066 696c 6520 6578 7465 6e73 696f  he file extensio
+0000f6f0: 6e20 6966 2074 6869 7320 6973 2061 2067  n if this is a g
+0000f700: 656f 6669 6c65 2e0a 0a20 2020 2041 7267  eofile...    Arg
+0000f710: 733a 0a20 2020 2020 2020 2066 696c 655f  s:.        file_
+0000f720: 6578 7420 2873 7472 293a 2074 6865 2065  ext (str): the e
+0000f730: 7874 656e 7369 6f6e 2e0a 0a20 2020 2052  xtension...    R
+0000f740: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000f750: 626f 6f6c 3a20 5472 7565 2069 6620 6974  bool: True if it
+0000f760: 2069 7320 6120 6765 6f66 696c 652e 0a20   is a geofile.. 
+0000f770: 2020 2022 2222 0a20 2020 2074 7279 3a0a     """.    try:.
+0000f780: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+0000f790: 2064 7269 7665 7220 6361 6e20 6265 2064   driver can be d
+0000f7a0: 6574 6572 6d69 6e65 642c 2069 7420 6973  etermined, it is
+0000f7b0: 2061 2028 7375 7070 6f72 7465 6429 2067   a (supported) g
+0000f7c0: 656f 2066 696c 652e 0a20 2020 2020 2020  eo file..       
+0000f7d0: 205f 203d 2047 656f 6669 6c65 5479 7065   _ = GeofileType
+0000f7e0: 2866 696c 655f 6578 7429 0a20 2020 2020  (file_ext).     
+0000f7f0: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+0000f800: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000f810: 696f 6e3a 0a20 2020 2020 2020 2072 6574  ion:.        ret
+0000f820: 7572 6e20 4661 6c73 650a 0a0a 6465 6620  urn False...def 
+0000f830: 636d 7028 0a20 2020 2070 6174 6831 3a20  cmp(.    path1: 
+0000f840: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+0000f850: 6174 684c 696b 655b 416e 795d 225d 2c20  athLike[Any]"], 
+0000f860: 7061 7468 323a 2055 6e69 6f6e 5b73 7472  path2: Union[str
+0000f870: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
+0000f880: 6e79 5d22 5d0a 2920 2d3e 2062 6f6f 6c3a  ny]"].) -> bool:
+0000f890: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
+0000f8a0: 7061 7265 2069 6620 7477 6f20 6765 6f66  pare if two geof
+0000f8b0: 696c 6573 2061 7265 2069 6465 6e74 6963  iles are identic
+0000f8c0: 616c 2e0a 0a20 2020 2046 6f72 2067 656f  al...    For geo
+0000f8d0: 6669 6c65 7320 7468 6174 2075 7365 206d  files that use m
+0000f8e0: 756c 7469 706c 6520 6669 6c65 732c 2061  ultiple files, a
+0000f8f0: 6c6c 2072 656c 6576 616e 7420 6669 6c65  ll relevant file
+0000f900: 7320 6d75 7374 2062 6520 6964 656e 7469  s must be identi
+0000f910: 6361 6c2e 0a20 2020 2045 672e 2066 6f72  cal..    Eg. for
+0000f920: 2073 6861 7065 6669 6c65 732c 2074 6865   shapefiles, the
+0000f930: 202e 7368 702c 202e 7368 7820 616e 6420   .shp, .shx and 
+0000f940: 2e64 6266 2066 696c 6520 6d75 7374 2062  .dbf file must b
+0000f950: 6520 6964 656e 7469 6361 6c2e 0a0a 2020  e identical...  
+0000f960: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000f970: 7061 7468 3120 2850 6174 684c 696b 6529  path1 (PathLike)
+0000f980: 3a20 7061 7468 2074 6f20 7468 6520 6669  : path to the fi
+0000f990: 7273 7420 6669 6c65 2e0a 2020 2020 2020  rst file..      
+0000f9a0: 2020 7061 7468 3220 2850 6174 684c 696b    path2 (PathLik
+0000f9b0: 6529 3a20 7061 7468 2074 6f20 7468 6520  e): path to the 
+0000f9c0: 7365 636f 6e64 2066 696c 652e 0a0a 2020  second file...  
+0000f9d0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0000f9e0: 2020 2062 6f6f 6c3a 2054 7275 6520 6966     bool: True if
+0000f9f0: 2074 6865 2066 696c 6573 2061 7265 2069   the files are i
+0000fa00: 6465 6e74 6963 616c 0a20 2020 2022 2222  dentical.    """
+0000fa10: 0a20 2020 2023 2043 6865 636b 2069 6e70  .    # Check inp
+0000fa20: 7574 2070 6172 616d 6574 6572 730a 2020  ut parameters.  
+0000fa30: 2020 7061 7468 315f 7020 3d20 5061 7468    path1_p = Path
+0000fa40: 2870 6174 6831 290a 2020 2020 7061 7468  (path1).    path
+0000fa50: 325f 7020 3d20 5061 7468 2870 6174 6832  2_p = Path(path2
+0000fa60: 290a 0a20 2020 2023 2046 6f72 2061 2073  )..    # For a s
+0000fa70: 6861 7065 6669 6c65 2c20 6d75 6c74 6970  hapefile, multip
+0000fa80: 6c65 2066 696c 6573 206e 6565 6420 746f  le files need to
+0000fa90: 2062 6520 636f 6d70 6172 6564 0a20 2020   be compared.   
+0000faa0: 2069 6620 7061 7468 315f 702e 7375 6666   if path1_p.suff
+0000fab0: 6978 2e6c 6f77 6572 2829 203d 3d20 222e  ix.lower() == ".
+0000fac0: 7368 7022 3a0a 2020 2020 2020 2020 7061  shp":.        pa
+0000fad0: 7468 325f 6e6f 6578 742c 205f 203d 206f  th2_noext, _ = o
+0000fae0: 732e 7061 7468 2e73 706c 6974 6578 7428  s.path.splitext(
+0000faf0: 7061 7468 325f 7029 0a20 2020 2020 2020  path2_p).       
+0000fb00: 2073 6861 7065 6669 6c65 5f62 6173 655f   shapefile_base_
+0000fb10: 7375 6666 6978 6573 203d 205b 222e 7368  suffixes = [".sh
+0000fb20: 7022 2c20 222e 6462 6622 2c20 222e 7368  p", ".dbf", ".sh
+0000fb30: 7822 5d0a 2020 2020 2020 2020 7061 7468  x"].        path
+0000fb40: 315f 6e6f 6578 7420 3d20 7061 7468 315f  1_noext = path1_
+0000fb50: 702e 7061 7265 6e74 202f 2070 6174 6831  p.parent / path1
+0000fb60: 5f70 2e73 7465 6d0a 2020 2020 2020 2020  _p.stem.        
+0000fb70: 7061 7468 325f 6e6f 6578 7420 3d20 7061  path2_noext = pa
+0000fb80: 7468 325f 702e 7061 7265 6e74 202f 2070  th2_p.parent / p
+0000fb90: 6174 6832 5f70 2e73 7465 6d0a 2020 2020  ath2_p.stem.    
+0000fba0: 2020 2020 666f 7220 6578 7420 696e 2073      for ext in s
+0000fbb0: 6861 7065 6669 6c65 5f62 6173 655f 7375  hapefile_base_su
+0000fbc0: 6666 6978 6573 3a0a 2020 2020 2020 2020  ffixes:.        
+0000fbd0: 2020 2020 6966 206e 6f74 2066 696c 6563      if not filec
+0000fbe0: 6d70 2e63 6d70 2866 227b 7374 7228 7061  mp.cmp(f"{str(pa
+0000fbf0: 7468 315f 6e6f 6578 7429 7d7b 6578 747d  th1_noext)}{ext}
+0000fc00: 222c 2066 227b 7374 7228 7061 7468 325f  ", f"{str(path2_
+0000fc10: 6e6f 6578 7429 7d7b 6578 747d 2229 3a0a  noext)}{ext}"):.
 0000fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc30: 2020 2020 6622 4669 6c65 207b 7061 7468      f"File {path
-0000fc40: 315f 6e6f 6578 747d 7b65 7874 7d20 6973  1_noext}{ext} is
-0000fc50: 2064 6966 6665 7265 6e74 2066 726f 6d20   different from 
-0000fc60: 7b70 6174 6832 5f6e 6f65 7874 7d7b 6578  {path2_noext}{ex
-0000fc70: 747d 220a 2020 2020 2020 2020 2020 2020  t}".            
-0000fc80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000fc90: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0000fca0: 7365 0a20 2020 2020 2020 2072 6574 7572  se.        retur
-0000fcb0: 6e20 5472 7565 0a20 2020 2065 6c73 653a  n True.    else:
-0000fcc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000fcd0: 6669 6c65 636d 702e 636d 7028 7374 7228  filecmp.cmp(str(
-0000fce0: 7061 7468 315f 7029 2c20 7374 7228 7061  path1_p), str(pa
-0000fcf0: 7468 325f 7029 290a 0a0a 6465 6620 636f  th2_p))...def co
-0000fd00: 7079 2873 7263 3a20 556e 696f 6e5b 7374  py(src: Union[st
-0000fd10: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-0000fd20: 416e 795d 225d 2c20 6473 743a 2055 6e69  Any]"], dst: Uni
-0000fd30: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-0000fd40: 4c69 6b65 5b41 6e79 5d22 5d29 3a0a 2020  Like[Any]"]):.  
-0000fd50: 2020 2222 220a 2020 2020 436f 7069 6573    """.    Copies
-0000fd60: 2074 6865 2067 656f 6669 6c65 2066 726f   the geofile fro
-0000fd70: 6d20 7372 6320 746f 2064 7374 2e20 4973  m src to dst. Is
-0000fd80: 2074 6865 2073 6f75 7263 6520 6669 6c65   the source file
-0000fd90: 2069 7320 6120 6765 6f66 696c 6520 636f   is a geofile co
-0000fda0: 6e74 6169 6e69 6e67 0a20 2020 206f 6620  ntaining.    of 
-0000fdb0: 6d75 6c74 6970 6c65 2066 696c 6573 2028  multiple files (
-0000fdc0: 6567 2e20 2e73 6870 2920 616c 6c20 6669  eg. .shp) all fi
-0000fdd0: 6c65 7320 6172 6520 636f 7069 6564 2e0a  les are copied..
-0000fde0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000fdf0: 2020 2073 7263 2028 5061 7468 4c69 6b65     src (PathLike
-0000fe00: 293a 2074 6865 2066 696c 6520 746f 2063  ): the file to c
-0000fe10: 6f70 792e 0a20 2020 2020 2020 2064 7374  opy..        dst
-0000fe20: 2028 5061 7468 4c69 6b65 293a 2074 6865   (PathLike): the
-0000fe30: 206c 6f63 6174 696f 6e20 746f 2063 6f70   location to cop
-0000fe40: 7920 7468 6520 6669 6c65 2873 2920 746f  y the file(s) to
-0000fe50: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
-0000fe60: 4368 6563 6b20 696e 7075 7420 7061 7261  Check input para
-0000fe70: 6d65 7465 7273 0a20 2020 2073 7263 203d  meters.    src =
-0000fe80: 2050 6174 6828 7372 6329 0a20 2020 2064   Path(src).    d
-0000fe90: 7374 203d 2050 6174 6828 6473 7429 0a20  st = Path(dst). 
-0000fea0: 2020 2067 656f 6669 6c65 7479 7065 203d     geofiletype =
-0000feb0: 2047 656f 6669 6c65 5479 7065 2873 7263   GeofileType(src
-0000fec0: 290a 0a20 2020 2023 2043 6f70 7920 7468  )..    # Copy th
-0000fed0: 6520 6d61 696e 2066 696c 650a 2020 2020  e main file.    
-0000fee0: 7368 7574 696c 2e63 6f70 7928 7374 7228  shutil.copy(str(
-0000fef0: 7372 6329 2c20 6473 7429 0a0a 2020 2020  src), dst)..    
-0000ff00: 2320 466f 7220 736f 6d65 2066 696c 6520  # For some file 
-0000ff10: 7479 7065 732c 2065 7874 7261 2066 696c  types, extra fil
-0000ff20: 6573 206e 6565 6420 746f 2062 6520 636f  es need to be co
-0000ff30: 7069 6564 0a20 2020 2023 2049 6620 6465  pied.    # If de
-0000ff40: 7374 2069 7320 6120 6469 722c 206a 7573  st is a dir, jus
-0000ff50: 7420 7573 6520 6d6f 7665 2e20 4f74 6865  t use move. Othe
-0000ff60: 7277 6973 6520 636f 6e63 6174 2064 6573  rwise concat des
-0000ff70: 7420 6669 6c65 7061 7468 730a 2020 2020  t filepaths.    
-0000ff80: 6966 2067 656f 6669 6c65 7479 7065 2e73  if geofiletype.s
-0000ff90: 7566 6669 7865 735f 6578 7472 6166 696c  uffixes_extrafil
-0000ffa0: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
-0000ffb0: 2020 2020 2020 2020 6966 2064 7374 2e69          if dst.i
-0000ffc0: 735f 6469 7228 293a 0a20 2020 2020 2020  s_dir():.       
-0000ffd0: 2020 2020 2066 6f72 2073 7566 6669 7820       for suffix 
-0000ffe0: 696e 2067 656f 6669 6c65 7479 7065 2e73  in geofiletype.s
-0000fff0: 7566 6669 7865 735f 6578 7472 6166 696c  uffixes_extrafil
-00010000: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00010010: 2020 2020 7372 6366 696c 6520 3d20 7372      srcfile = sr
-00010020: 632e 7061 7265 6e74 202f 2066 227b 7372  c.parent / f"{sr
-00010030: 632e 7374 656d 7d7b 7375 6666 6978 7d22  c.stem}{suffix}"
-00010040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010050: 2069 6620 7372 6366 696c 652e 6578 6973   if srcfile.exis
-00010060: 7473 2829 3a0a 2020 2020 2020 2020 2020  ts():.          
-00010070: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
-00010080: 2e63 6f70 7928 7374 7228 7372 6366 696c  .copy(str(srcfil
-00010090: 6529 2c20 6473 7429 0a20 2020 2020 2020  e), dst).       
-000100a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000100b0: 2020 2066 6f72 2073 7566 6669 7820 696e     for suffix in
-000100c0: 2067 656f 6669 6c65 7479 7065 2e73 7566   geofiletype.suf
-000100d0: 6669 7865 735f 6578 7472 6166 696c 6573  fixes_extrafiles
-000100e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000100f0: 2020 7372 6366 696c 6520 3d20 7372 632e    srcfile = src.
-00010100: 7061 7265 6e74 202f 2066 227b 7372 632e  parent / f"{src.
-00010110: 7374 656d 7d7b 7375 6666 6978 7d22 0a20  stem}{suffix}". 
-00010120: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010130: 7374 6669 6c65 203d 2064 7374 2e70 6172  stfile = dst.par
-00010140: 656e 7420 2f20 6622 7b64 7374 2e73 7465  ent / f"{dst.ste
-00010150: 6d7d 7b73 7566 6669 787d 220a 2020 2020  m}{suffix}".    
-00010160: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00010170: 7263 6669 6c65 2e65 7869 7374 7328 293a  rcfile.exists():
-00010180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010190: 2020 2020 2073 6875 7469 6c2e 636f 7079       shutil.copy
-000101a0: 2873 7472 2873 7263 6669 6c65 292c 2064  (str(srcfile), d
-000101b0: 7374 6669 6c65 290a 0a0a 6465 6620 6d6f  stfile)...def mo
-000101c0: 7665 2873 7263 3a20 556e 696f 6e5b 7374  ve(src: Union[st
-000101d0: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-000101e0: 416e 795d 225d 2c20 6473 743a 2055 6e69  Any]"], dst: Uni
-000101f0: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-00010200: 4c69 6b65 5b41 6e79 5d22 5d29 3a0a 2020  Like[Any]"]):.  
-00010210: 2020 2222 220a 2020 2020 4d6f 7665 7320    """.    Moves 
-00010220: 7468 6520 6765 6f66 696c 6520 6672 6f6d  the geofile from
-00010230: 2073 7263 2074 6f20 6473 742e 2049 6620   src to dst. If 
-00010240: 7468 6520 736f 7572 6365 2066 696c 6520  the source file 
-00010250: 6973 2061 2067 656f 6669 6c65 2063 6f6e  is a geofile con
-00010260: 7461 696e 696e 670a 2020 2020 6f66 206d  taining.    of m
-00010270: 756c 7469 706c 6520 6669 6c65 7320 2865  ultiple files (e
-00010280: 672e 202e 7368 7029 2061 6c6c 2066 696c  g. .shp) all fil
-00010290: 6573 2061 7265 206d 6f76 6564 2e0a 0a20  es are moved... 
-000102a0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000102b0: 2073 7263 2028 5061 7468 4c69 6b65 293a   src (PathLike):
-000102c0: 2074 6865 2066 696c 6520 746f 206d 6f76   the file to mov
-000102d0: 650a 2020 2020 2020 2020 6473 7420 2850  e.        dst (P
-000102e0: 6174 684c 696b 6529 3a20 7468 6520 6c6f  athLike): the lo
-000102f0: 6361 7469 6f6e 2074 6f20 6d6f 7665 2074  cation to move t
-00010300: 6865 2066 696c 6528 7329 2074 6f0a 2020  he file(s) to.  
-00010310: 2020 2222 220a 2020 2020 2320 4368 6563    """.    # Chec
-00010320: 6b20 696e 7075 7420 7061 7261 6d65 7465  k input paramete
-00010330: 7273 0a20 2020 2073 7263 203d 2050 6174  rs.    src = Pat
-00010340: 6828 7372 6329 0a20 2020 2064 7374 203d  h(src).    dst =
-00010350: 2050 6174 6828 6473 7429 0a20 2020 2067   Path(dst).    g
-00010360: 656f 6669 6c65 7479 7065 203d 2047 656f  eofiletype = Geo
-00010370: 6669 6c65 5479 7065 2873 7263 290a 0a20  fileType(src).. 
-00010380: 2020 2023 204d 6f76 6520 7468 6520 6d61     # Move the ma
-00010390: 696e 2066 696c 650a 2020 2020 7368 7574  in file.    shut
-000103a0: 696c 2e6d 6f76 6528 7374 7228 7372 6329  il.move(str(src)
-000103b0: 2c20 6473 7429 0a0a 2020 2020 2320 466f  , dst)..    # Fo
-000103c0: 7220 736f 6d65 2066 696c 6520 7479 7065  r some file type
-000103d0: 732c 2065 7874 7261 2066 696c 6573 206e  s, extra files n
-000103e0: 6565 6420 746f 2062 6520 6d6f 7665 640a  eed to be moved.
-000103f0: 2020 2020 2320 4966 2064 6573 7420 6973      # If dest is
-00010400: 2061 2064 6972 2c20 6a75 7374 2075 7365   a dir, just use
-00010410: 206d 6f76 652e 204f 7468 6572 7769 7365   move. Otherwise
-00010420: 2063 6f6e 6361 7420 6465 7374 2066 696c   concat dest fil
-00010430: 6570 6174 6873 0a20 2020 2069 6620 6765  epaths.    if ge
-00010440: 6f66 696c 6574 7970 652e 7375 6666 6978  ofiletype.suffix
-00010450: 6573 5f65 7874 7261 6669 6c65 7320 6973  es_extrafiles is
-00010460: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00010470: 2020 2069 6620 6473 742e 6973 5f64 6972     if dst.is_dir
-00010480: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00010490: 666f 7220 7375 6666 6978 2069 6e20 6765  for suffix in ge
-000104a0: 6f66 696c 6574 7970 652e 7375 6666 6978  ofiletype.suffix
-000104b0: 6573 5f65 7874 7261 6669 6c65 733a 0a20  es_extrafiles:. 
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000104d0: 7263 6669 6c65 203d 2073 7263 2e70 6172  rcfile = src.par
-000104e0: 656e 7420 2f20 6622 7b73 7263 2e73 7465  ent / f"{src.ste
-000104f0: 6d7d 7b73 7566 6669 787d 220a 2020 2020  m}{suffix}".    
-00010500: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00010510: 7263 6669 6c65 2e65 7869 7374 7328 293a  rcfile.exists():
-00010520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010530: 2020 2020 2073 6875 7469 6c2e 6d6f 7665       shutil.move
-00010540: 2873 7472 2873 7263 6669 6c65 292c 2064  (str(srcfile), d
-00010550: 7374 290a 2020 2020 2020 2020 656c 7365  st).        else
-00010560: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00010570: 7220 7375 6666 6978 2069 6e20 6765 6f66  r suffix in geof
-00010580: 696c 6574 7970 652e 7375 6666 6978 6573  iletype.suffixes
-00010590: 5f65 7874 7261 6669 6c65 733a 0a20 2020  _extrafiles:.   
-000105a0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-000105b0: 6669 6c65 203d 2073 7263 2e70 6172 656e  file = src.paren
-000105c0: 7420 2f20 6622 7b73 7263 2e73 7465 6d7d  t / f"{src.stem}
-000105d0: 7b73 7566 6669 787d 220a 2020 2020 2020  {suffix}".      
-000105e0: 2020 2020 2020 2020 2020 6473 7466 696c            dstfil
-000105f0: 6520 3d20 6473 742e 7061 7265 6e74 202f  e = dst.parent /
-00010600: 2066 227b 6473 742e 7374 656d 7d7b 7375   f"{dst.stem}{su
-00010610: 6666 6978 7d22 0a20 2020 2020 2020 2020  ffix}".         
-00010620: 2020 2020 2020 2069 6620 7372 6366 696c         if srcfil
-00010630: 652e 6578 6973 7473 2829 3a0a 2020 2020  e.exists():.    
-00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010650: 7368 7574 696c 2e6d 6f76 6528 7374 7228  shutil.move(str(
-00010660: 7372 6366 696c 6529 2c20 6473 7466 696c  srcfile), dstfil
-00010670: 6529 0a0a 0a64 6566 2072 656d 6f76 6528  e)...def remove(
-00010680: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
-00010690: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
-000106a0: 795d 225d 2c20 6d69 7373 696e 675f 6f6b  y]"], missing_ok
-000106b0: 3a20 626f 6f6c 203d 2046 616c 7365 293a  : bool = False):
-000106c0: 0a20 2020 2022 2222 0a20 2020 2052 656d  .    """.    Rem
-000106d0: 6f76 6573 2074 6865 2067 656f 6669 6c65  oves the geofile
-000106e0: 2e20 4973 2069 7420 6973 2061 2067 656f  . Is it is a geo
-000106f0: 6669 6c65 2063 6f6d 706f 7365 6420 6f66  file composed of
-00010700: 206d 756c 7469 706c 6520 6669 6c65 730a   multiple files.
-00010710: 2020 2020 2865 672e 202e 7368 7029 2061      (eg. .shp) a
-00010720: 6c6c 2066 696c 6573 2061 7265 2072 656d  ll files are rem
-00010730: 6f76 6564 2e0a 2020 2020 4966 202e 6c6f  oved..    If .lo
-00010740: 636b 2066 696c 6573 2061 7265 2070 7265  ck files are pre
-00010750: 7365 6e74 2c20 7468 6579 2061 7265 2072  sent, they are r
-00010760: 656d 6f76 6564 2061 7320 7765 6c6c 2e0a  emoved as well..
-00010770: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00010780: 2020 2070 6174 6820 2850 6174 684c 696b     path (PathLik
-00010790: 6529 3a20 7468 6520 6669 6c65 2074 6f20  e): the file to 
-000107a0: 7265 6d6f 7665 0a20 2020 2022 2222 0a20  remove.    """. 
-000107b0: 2020 2023 2043 6865 636b 2069 6e70 7574     # Check input
-000107c0: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
-000107d0: 7061 7468 203d 2050 6174 6828 7061 7468  path = Path(path
-000107e0: 290a 2020 2020 6765 6f66 696c 6574 7970  ).    geofiletyp
-000107f0: 6520 3d20 4765 6f66 696c 6554 7970 6528  e = GeofileType(
-00010800: 7061 7468 290a 0a20 2020 2023 2049 6620  path)..    # If 
-00010810: 7468 6572 6520 6973 2061 206c 6f63 6b20  there is a lock 
-00010820: 6669 6c65 2c20 7265 6d6f 7665 2069 740a  file, remove it.
-00010830: 2020 2020 6c6f 636b 6669 6c65 5f70 6174      lockfile_pat
-00010840: 6820 3d20 7061 7468 2e70 6172 656e 7420  h = path.parent 
-00010850: 2f20 6622 7b70 6174 682e 6e61 6d65 7d2e  / f"{path.name}.
-00010860: 6c6f 636b 220a 2020 2020 6c6f 636b 6669  lock".    lockfi
-00010870: 6c65 5f70 6174 682e 756e 6c69 6e6b 286d  le_path.unlink(m
-00010880: 6973 7369 6e67 5f6f 6b3d 5472 7565 290a  issing_ok=True).
-00010890: 0a20 2020 2023 2052 656d 6f76 6520 7468  .    # Remove th
-000108a0: 6520 6d61 696e 2066 696c 650a 2020 2020  e main file.    
-000108b0: 6966 2070 6174 682e 6578 6973 7473 2829  if path.exists()
-000108c0: 3a0a 2020 2020 2020 2020 7061 7468 2e75  :.        path.u
-000108d0: 6e6c 696e 6b28 6d69 7373 696e 675f 6f6b  nlink(missing_ok
-000108e0: 3d6d 6973 7369 6e67 5f6f 6b29 0a0a 2020  =missing_ok)..  
-000108f0: 2020 2320 466f 7220 736f 6d65 2066 696c    # For some fil
-00010900: 6520 7479 7065 732c 2065 7874 7261 2066  e types, extra f
-00010910: 696c 6573 206e 6565 6420 746f 2062 6520  iles need to be 
-00010920: 7265 6d6f 7665 640a 2020 2020 6966 2067  removed.    if g
-00010930: 656f 6669 6c65 7479 7065 2e73 7566 6669  eofiletype.suffi
-00010940: 7865 735f 6578 7472 6166 696c 6573 2069  xes_extrafiles i
-00010950: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00010960: 2020 2020 666f 7220 7375 6666 6978 2069      for suffix i
-00010970: 6e20 6765 6f66 696c 6574 7970 652e 7375  n geofiletype.su
-00010980: 6666 6978 6573 5f65 7874 7261 6669 6c65  ffixes_extrafile
-00010990: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-000109a0: 7572 725f 7061 7468 203d 2070 6174 682e  urr_path = path.
-000109b0: 7061 7265 6e74 202f 2066 227b 7061 7468  parent / f"{path
-000109c0: 2e73 7465 6d7d 7b73 7566 6669 787d 220a  .stem}{suffix}".
-000109d0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-000109e0: 5f70 6174 682e 756e 6c69 6e6b 286d 6973  _path.unlink(mis
-000109f0: 7369 6e67 5f6f 6b3d 5472 7565 290a 0a0a  sing_ok=True)...
-00010a00: 6465 6620 6170 7065 6e64 5f74 6f28 0a20  def append_to(. 
-00010a10: 2020 2073 7263 3a20 556e 696f 6e5b 7374     src: Union[st
-00010a20: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-00010a30: 416e 795d 225d 2c0a 2020 2020 6473 743a  Any]"],.    dst:
-00010a40: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
-00010a50: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
-00010a60: 0a20 2020 2073 7263 5f6c 6179 6572 3a20  .    src_layer: 
-00010a70: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00010a80: 4e6f 6e65 2c0a 2020 2020 6473 745f 6c61  None,.    dst_la
-00010a90: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00010aa0: 725d 203d 204e 6f6e 652c 0a20 2020 2073  r] = None,.    s
-00010ab0: 7263 5f63 7273 3a20 556e 696f 6e5b 696e  rc_crs: Union[in
-00010ac0: 742c 2073 7472 2c20 4e6f 6e65 5d20 3d20  t, str, None] = 
-00010ad0: 4e6f 6e65 2c0a 2020 2020 6473 745f 6372  None,.    dst_cr
-00010ae0: 733a 2055 6e69 6f6e 5b69 6e74 2c20 7374  s: Union[int, st
-00010af0: 722c 204e 6f6e 655d 203d 204e 6f6e 652c  r, None] = None,
-00010b00: 0a20 2020 2072 6570 726f 6a65 6374 3a20  .    reproject: 
-00010b10: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00010b20: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
-00010b30: 696f 6e73 3a20 626f 6f6c 203d 2046 616c  ions: bool = Fal
-00010b40: 7365 2c0a 2020 2020 666f 7263 655f 6f75  se,.    force_ou
-00010b50: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-00010b60: 653a 2055 6e69 6f6e 5b47 656f 6d65 7472  e: Union[Geometr
-00010b70: 7954 7970 652c 2073 7472 2c20 4e6f 6e65  yType, str, None
-00010b80: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6372  ] = None,.    cr
-00010b90: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-00010ba0: 6578 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ex: Optional[boo
-00010bb0: 6c5d 203d 2054 7275 652c 0a20 2020 2061  l] = True,.    a
-00010bc0: 7070 656e 645f 7469 6d65 6f75 745f 733a  ppend_timeout_s:
-00010bd0: 2069 6e74 203d 2036 3030 2c0a 2020 2020   int = 600,.    
-00010be0: 7472 616e 7361 6374 696f 6e5f 7369 7a65  transaction_size
-00010bf0: 3a20 696e 7420 3d20 3530 3030 302c 0a20  : int = 50000,. 
-00010c00: 2020 2070 7265 7365 7276 655f 6669 643a     preserve_fid:
-00010c10: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00010c20: 3d20 4e6f 6e65 2c0a 2020 2020 6f70 7469  = None,.    opti
-00010c30: 6f6e 733a 2064 6963 7420 3d20 7b7d 2c0a  ons: dict = {},.
-00010c40: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
-00010c50: 7070 656e 6420 7372 6320 6669 6c65 2074  ppend src file t
-00010c60: 6f20 7468 6520 6473 7420 6669 6c65 2e0a  o the dst file..
-00010c70: 0a20 2020 2052 656d 6172 6b3a 2061 7070  .    Remark: app
-00010c80: 656e 6420 6973 206e 6f74 2073 7570 706f  end is not suppo
-00010c90: 7274 6564 2066 6f72 2061 6c6c 2066 696c  rted for all fil
-00010ca0: 6574 7970 6573 2069 6e20 6669 6f6e 612f  etypes in fiona/
-00010cb0: 6765 6f70 616e 6461 7320 2830 2e38 290a  geopandas (0.8).
-00010cc0: 2020 2020 736f 2077 6f72 6b61 726f 756e      so workaroun
-00010cd0: 6420 7669 6120 6764 616c 206e 6565 6465  d via gdal neede
-00010ce0: 642e 0a0a 2020 2020 5468 6520 6f70 7469  d...    The opti
-00010cf0: 6f6e 7320 7061 7261 6d65 7465 7220 6361  ons parameter ca
-00010d00: 6e20 6265 2075 7365 6420 746f 2070 6173  n be used to pas
-00010d10: 7320 616e 7920 7479 7065 206f 6620 6f70  s any type of op
-00010d20: 7469 6f6e 7320 746f 2047 4441 4c20 696e  tions to GDAL in
-00010d30: 0a20 2020 2074 6865 2066 6f6c 6c6f 7769  .    the followi
-00010d40: 6e67 2066 6f72 6d3a 0a20 2020 2020 2020  ng form:.       
-00010d50: 207b 2022 3c6f 7074 696f 6e5f 7479 7065   { "<option_type
-00010d60: 3e2e 3c6f 7074 696f 6e5f 6e61 6d65 3e22  >.<option_name>"
-00010d70: 3a20 3c6f 7074 696f 6e5f 7661 6c75 653e  : <option_value>
-00010d80: 207d 0a0a 2020 2020 5468 6520 6f70 7469   }..    The opti
-00010d90: 6f6e 2074 7970 6573 2063 616e 2062 6520  on types can be 
-00010da0: 616e 7920 6f66 2074 6865 2066 6f6c 6c6f  any of the follo
-00010db0: 7769 6e67 3a0a 2020 2020 2020 2020 2d20  wing:.        - 
-00010dc0: 4c41 5945 525f 4352 4541 5449 4f4e 3a20  LAYER_CREATION: 
-00010dd0: 6c61 7965 7220 6372 6561 7469 6f6e 206f  layer creation o
-00010de0: 7074 696f 6e20 286c 636f 290a 2020 2020  ption (lco).    
-00010df0: 2020 2020 2d20 4441 5441 5345 545f 4352      - DATASET_CR
-00010e00: 4541 5449 4f4e 3a20 6461 7461 7365 7420  EATION: dataset 
-00010e10: 6372 6561 7469 6f6e 206f 7074 696f 6e20  creation option 
-00010e20: 2864 7363 6f29 0a20 2020 2020 2020 202d  (dsco).        -
-00010e30: 2049 4e50 5554 5f4f 5045 4e3a 2069 6e70   INPUT_OPEN: inp
-00010e40: 7574 2064 6174 6173 6574 206f 7065 6e20  ut dataset open 
-00010e50: 6f70 7469 6f6e 2028 6f6f 290a 2020 2020  option (oo).    
-00010e60: 2020 2020 2d20 4445 5354 494e 4154 494f      - DESTINATIO
-00010e70: 4e5f 4f50 454e 3a20 6465 7374 696e 6174  N_OPEN: destinat
-00010e80: 696f 6e20 6461 7461 7365 7420 6f70 656e  ion dataset open
-00010e90: 206f 7074 696f 6e20 2864 6f6f 290a 2020   option (doo).  
-00010ea0: 2020 2020 2020 2d20 434f 4e46 4947 3a20        - CONFIG: 
-00010eb0: 636f 6e66 6967 206f 7074 696f 6e20 2863  config option (c
-00010ec0: 6f6e 6669 6729 0a0a 2020 2020 5468 6520  onfig)..    The 
-00010ed0: 6f70 7469 6f6e 7320 6361 6e20 6265 2066  options can be f
-00010ee0: 6f75 6e64 2069 6e20 7468 6520 5b47 4441  ound in the [GDA
-00010ef0: 4c20 7665 6374 6f72 2064 7269 7665 7220  L vector driver 
-00010f00: 646f 6375 6d65 6e74 6174 696f 6e5d 0a20  documentation]. 
-00010f10: 2020 2028 6874 7470 733a 2f2f 6764 616c     (https://gdal
-00010f20: 2e6f 7267 2f64 7269 7665 7273 2f76 6563  .org/drivers/vec
-00010f30: 746f 722f 696e 6465 782e 6874 6d6c 292e  tor/index.html).
-00010f40: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00010f50: 2020 2020 7372 6320 2855 6e69 6f6e 5b73      src (Union[s
-00010f60: 7472 2c29 3a20 736f 7572 6365 2066 696c  tr,): source fil
-00010f70: 6520 7061 7468 2e0a 2020 2020 2020 2020  e path..        
-00010f80: 6473 7420 2855 6e69 6f6e 5b73 7472 2c29  dst (Union[str,)
-00010f90: 3a20 6465 7374 696e 6174 696f 6e20 6669  : destination fi
-00010fa0: 6c65 2070 6174 682e 0a20 2020 2020 2020  le path..       
-00010fb0: 2073 7263 5f6c 6179 6572 2028 7374 722c   src_layer (str,
-00010fc0: 206f 7074 696f 6e61 6c29 3a20 736f 7572   optional): sour
-00010fd0: 6365 206c 6179 6572 2e20 4465 6661 756c  ce layer. Defaul
-00010fe0: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
-00010ff0: 2020 2020 6473 745f 6c61 7965 7220 2873      dst_layer (s
-00011000: 7472 2c20 6f70 7469 6f6e 616c 293a 2064  tr, optional): d
-00011010: 6573 7469 6e61 7469 6f6e 206c 6179 6572  estination layer
-00011020: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
-00011030: 6e65 2e0a 2020 2020 2020 2020 7372 635f  ne..        src_
-00011040: 6372 7320 2873 7472 2c20 6f70 7469 6f6e  crs (str, option
-00011050: 616c 293a 2061 6e20 6570 7367 2069 6e74  al): an epsg int
-00011060: 206f 7220 616e 7974 6869 6e67 2073 7570   or anything sup
-00011070: 706f 7274 6564 0a20 2020 2020 2020 2020  ported.         
-00011080: 2020 2062 7920 7468 6520 4f47 5253 7061     by the OGRSpa
-00011090: 7469 616c 5265 6665 7265 6e63 652e 5365  tialReference.Se
-000110a0: 7446 726f 6d55 7365 7249 6e70 7574 2829  tFromUserInput()
-000110b0: 2063 616c 6c2c 2077 6869 6368 2069 6e63   call, which inc
-000110c0: 6c75 6465 730a 2020 2020 2020 2020 2020  ludes.          
-000110d0: 2020 616e 2045 5053 4720 7374 7269 6e67    an EPSG string
-000110e0: 2028 6567 2e20 2245 5053 473a 3433 3236   (eg. "EPSG:4326
-000110f0: 2229 2c20 6120 7765 6c6c 206b 6e6f 776e  "), a well known
-00011100: 2074 6578 7420 2857 4b54 2920 4352 530a   text (WKT) CRS.
-00011110: 2020 2020 2020 2020 2020 2020 6465 6669              defi
-00011120: 6e69 7469 6f6e 2c2e 2e2e 2044 6566 6175  nition,... Defau
-00011130: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00011140: 2020 2020 2064 7374 5f63 7273 2028 7374       dst_crs (st
-00011150: 722c 206f 7074 696f 6e61 6c29 3a20 616e  r, optional): an
-00011160: 2065 7073 6720 696e 7420 6f72 2061 6e79   epsg int or any
-00011170: 7468 696e 6720 7375 7070 6f72 7465 640a  thing supported.
-00011180: 2020 2020 2020 2020 2020 2020 6279 2074              by t
-00011190: 6865 204f 4752 5370 6174 6961 6c52 6566  he OGRSpatialRef
-000111a0: 6572 656e 6365 2e53 6574 4672 6f6d 5573  erence.SetFromUs
-000111b0: 6572 496e 7075 7428 2920 6361 6c6c 2c20  erInput() call, 
-000111c0: 7768 6963 6820 696e 636c 7564 6573 0a20  which includes. 
-000111d0: 2020 2020 2020 2020 2020 2061 6e20 4550             an EP
-000111e0: 5347 2073 7472 696e 6720 2865 672e 2022  SG string (eg. "
-000111f0: 4550 5347 3a34 3332 3622 292c 2061 2077  EPSG:4326"), a w
-00011200: 656c 6c20 6b6e 6f77 6e20 7465 7874 2028  ell known text (
-00011210: 574b 5429 2043 5253 0a20 2020 2020 2020  WKT) CRS.       
-00011220: 2020 2020 2064 6566 696e 6974 696f 6e2c       definition,
-00011230: 2e2e 2e20 4465 6661 756c 7473 2074 6f20  ... Defaults to 
-00011240: 4e6f 6e65 2e0a 2020 2020 2020 2020 7265  None..        re
-00011250: 7072 6f6a 6563 7420 2862 6f6f 6c2c 206f  project (bool, o
-00011260: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00011270: 6f20 7265 7072 6f6a 6563 7420 7768 696c  o reproject whil
-00011280: 6520 636f 6e76 6572 7469 6e67 2074 6865  e converting the
-00011290: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-000112a0: 652e 2044 6566 6175 6c74 7320 746f 2046  e. Defaults to F
-000112b0: 616c 7365 2e0a 2020 2020 2020 2020 6578  alse..        ex
-000112c0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-000112d0: 2028 626f 6f6c 292c 206f 7074 696f 6e61   (bool), optiona
-000112e0: 6c29 3a20 5472 7565 2074 6f20 6f75 7470  l): True to outp
-000112f0: 7574 206f 6e6c 7920 7369 6d70 6c65 2067  ut only simple g
-00011300: 656f 6d65 7472 6965 732e 0a20 2020 2020  eometries..     
-00011310: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-00011320: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
-00011330: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-00011340: 656f 6d65 7472 7974 7970 6520 2855 6e69  eometrytype (Uni
-00011350: 6f6e 5b47 656f 6d65 7472 7954 7970 652c  on[GeometryType,
-00011360: 2073 7472 5d2c 206f 7074 696f 6e61 6c29   str], optional)
-00011370: 3a20 4765 6f6d 6574 7279 2074 7970 652e  : Geometry type.
-00011380: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
-00011390: 2874 7279 2074 6f29 2066 6f72 6365 2074  (try to) force t
-000113a0: 6865 206f 7574 7075 7420 746f 2e20 4465  he output to. De
-000113b0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-000113c0: 2020 2020 2020 2020 6372 6561 7465 5f73          create_s
-000113d0: 7061 7469 616c 5f69 6e64 6578 2028 626f  patial_index (bo
-000113e0: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2054  ol, optional): T
-000113f0: 7275 6520 746f 2063 7265 6174 6520 6120  rue to create a 
-00011400: 7370 6174 6961 6c20 696e 6465 780a 2020  spatial index.  
-00011410: 2020 2020 2020 2020 2020 6f6e 2074 6865            on the
-00011420: 2064 6573 7469 6e61 7469 6f6e 2066 696c   destination fil
-00011430: 652f 6c61 7965 722e 2049 6620 4e6f 6e65  e/layer. If None
-00011440: 2c20 7468 6520 6465 6661 756c 7420 6265  , the default be
-00011450: 6861 7669 6f75 7220 6279 2067 6461 6c20  haviour by gdal 
-00011460: 666f 720a 2020 2020 2020 2020 2020 2020  for.            
-00011470: 7468 6174 2066 696c 6520 7479 7065 2069  that file type i
-00011480: 7320 7265 7370 6563 7465 642e 2049 6620  s respected. If 
-00011490: 7468 6520 4c41 5945 525f 4352 4541 5449  the LAYER_CREATI
-000114a0: 4f4e 2e53 5041 5449 414c 5f49 4e44 4558  ON.SPATIAL_INDEX
-000114b0: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-000114c0: 616d 6574 6572 2069 7320 7370 6563 6966  ameter is specif
-000114d0: 6965 6420 696e 206f 7074 696f 6e73 2c20  ied in options, 
-000114e0: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-000114f0: 6e64 6578 2069 7320 6967 6e6f 7265 642e  ndex is ignored.
-00011500: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
-00011510: 6175 6c74 7320 746f 2054 7275 652e 0a20  aults to True.. 
-00011520: 2020 2020 2020 2061 7070 656e 645f 7469         append_ti
-00011530: 6d65 6f75 745f 7320 2869 6e74 2c20 6f70  meout_s (int, op
-00011540: 7469 6f6e 616c 293a 2074 696d 656f 7574  tional): timeout
-00011550: 2074 6f20 7573 6520 6966 2074 6865 206f   to use if the o
-00011560: 7574 7075 7420 6669 6c65 2069 730a 2020  utput file is.  
-00011570: 2020 2020 2020 2020 2020 6265 696e 6720            being 
-00011580: 7772 6974 7465 6e20 746f 2062 7920 616e  written to by an
-00011590: 6f74 6865 7220 7072 6f63 6573 7320 616c  other process al
-000115a0: 7265 6164 792e 2044 6566 6175 6c74 7320  ready. Defaults 
-000115b0: 746f 2036 3030 2e0a 2020 2020 2020 2020  to 600..        
-000115c0: 7472 616e 7361 6374 696f 6e5f 7369 7a65  transaction_size
-000115d0: 2028 696e 742c 206f 7074 696f 6e61 6c29   (int, optional)
-000115e0: 3a20 5472 616e 7361 6374 696f 6e20 7369  : Transaction si
-000115f0: 7a65 2e0a 2020 2020 2020 2020 2020 2020  ze..            
-00011600: 4465 6661 756c 7473 2074 6f20 3530 3030  Defaults to 5000
-00011610: 302e 0a20 2020 2020 2020 2070 7265 7365  0..        prese
-00011620: 7276 655f 6669 6420 2862 6f6f 6c2c 206f  rve_fid (bool, o
-00011630: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00011640: 6f20 6d61 6b65 2061 6e20 6578 7472 6120  o make an extra 
-00011650: 6566 666f 7274 2074 6f20 7072 6573 6572  effort to preser
-00011660: 7665 2066 6964 2773 206f 660a 2020 2020  ve fid's of.    
-00011670: 2020 2020 2020 2020 7468 6520 736f 7572          the sour
-00011680: 6365 206c 6179 6572 2074 6f20 7468 6520  ce layer to the 
-00011690: 6465 7374 696e 6174 696f 6e20 6c61 7965  destination laye
-000116a0: 722e 2046 616c 7365 206e 6f74 2074 6f20  r. False not to 
-000116b0: 646f 2061 6e79 2065 6666 6f72 742e 204e  do any effort. N
-000116c0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-000116d0: 746f 2075 7365 2074 6865 2064 6566 6175  to use the defau
-000116e0: 6c74 2062 6568 6176 696f 7572 206f 6620  lt behaviour of 
-000116f0: 6764 616c 2c20 7468 6174 2061 6c72 6561  gdal, that alrea
-00011700: 6479 2070 7265 7365 7276 6573 2069 6e20  dy preserves in 
-00011710: 736f 6d65 2063 6173 6573 2e0a 2020 2020  some cases..    
-00011720: 2020 2020 2020 2020 536f 6d65 2066 696c          Some fil
-00011730: 6520 666f 726d 6174 7320 646f 6e27 7420  e formats don't 
-00011740: 6578 706c 6963 6974 6c79 2073 746f 7265  explicitly store
-00011750: 2074 6865 2066 6964 2028 652e 672e 2073   the fid (e.g. s
-00011760: 6861 7065 6669 6c65 292c 2073 6f20 7468  hapefile), so th
-00011770: 6579 0a20 2020 2020 2020 2020 2020 2077  ey.            w
-00011780: 696c 6c20 6e65 7665 7220 6265 2061 626c  ill never be abl
-00011790: 6520 746f 2070 7265 7365 7276 6520 6669  e to preserve fi
-000117a0: 6473 2e20 4465 6661 756c 7473 2074 6f20  ds. Defaults to 
-000117b0: 4e6f 6e65 2e0a 2020 2020 2020 2020 6f70  None..        op
-000117c0: 7469 6f6e 7320 2864 6963 742c 206f 7074  tions (dict, opt
-000117d0: 696f 6e61 6c29 3a20 6f70 7469 6f6e 7320  ional): options 
-000117e0: 746f 2070 6173 7320 746f 2067 6461 6c2e  to pass to gdal.
-000117f0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-00011800: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
-00011810: 3a20 616e 2069 6e76 616c 6964 2070 6172  : an invalid par
-00011820: 616d 6574 6572 2076 616c 7565 2077 6173  ameter value was
-00011830: 2070 6173 7365 642e 0a20 2020 2020 2020   passed..       
-00011840: 2052 756e 7469 6d65 4572 726f 723a 2074   RuntimeError: t
-00011850: 696d 656f 7574 2077 6173 2072 6561 6368  imeout was reach
-00011860: 6564 2077 6869 6c65 2074 7279 696e 6720  ed while trying 
-00011870: 746f 2061 7070 656e 6420 6461 7461 2074  to append data t
-00011880: 6f20 7061 7468 2e0a 2020 2020 2222 220a  o path..    """.
-00011890: 2020 2020 2320 4368 6563 6b2f 636c 6561      # Check/clea
-000118a0: 6e20 696e 7075 7420 7061 7261 6d73 0a20  n input params. 
-000118b0: 2020 2073 7263 203d 2050 6174 6828 7372     src = Path(sr
-000118c0: 6329 0a20 2020 2064 7374 203d 2050 6174  c).    dst = Pat
-000118d0: 6828 6473 7429 0a20 2020 2069 6620 666f  h(dst).    if fo
-000118e0: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-000118f0: 7472 7974 7970 6520 6973 206e 6f74 204e  trytype is not N
-00011900: 6f6e 653a 0a20 2020 2020 2020 2066 6f72  one:.        for
-00011910: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00011920: 7279 7479 7065 203d 2047 656f 6d65 7472  rytype = Geometr
-00011930: 7954 7970 6528 666f 7263 655f 6f75 7470  yType(force_outp
-00011940: 7574 5f67 656f 6d65 7472 7974 7970 6529  ut_geometrytype)
-00011950: 0a0a 2020 2020 2320 4669 6c65 7320 646f  ..    # Files do
-00011960: 6e27 7420 7479 7069 6361 6c6c 7920 7375  n't typically su
-00011970: 7070 6f72 7420 6861 7669 6e67 206d 756c  pport having mul
-00011980: 7469 706c 6520 7072 6f63 6573 7365 7320  tiple processes 
-00011990: 7772 6974 696e 670a 2020 2020 2320 7369  writing.    # si
-000119a0: 6d75 6c74 616e 6f75 736c 7920 746f 2074  multanously to t
-000119b0: 6865 6d2c 2073 6f20 7573 6520 6c6f 636b  hem, so use lock
-000119c0: 2066 696c 6520 746f 2073 796e 6368 726f   file to synchro
-000119d0: 6e69 7a65 2061 6363 6573 732e 0a20 2020  nize access..   
-000119e0: 206c 6f63 6b66 696c 6520 3d20 5061 7468   lockfile = Path
-000119f0: 2866 227b 7374 7228 6473 7429 7d2e 6c6f  (f"{str(dst)}.lo
-00011a00: 636b 2229 0a0a 2020 2020 2320 4966 2074  ck")..    # If t
-00011a10: 6865 2064 6573 7469 6e61 7469 6f6e 2066  he destination f
-00011a20: 696c 6520 646f 6573 6e27 7420 6578 6973  ile doesn't exis
-00011a30: 7420 7965 742c 2062 7574 2074 6865 206c  t yet, but the l
-00011a40: 6f63 6b66 696c 6520 646f 6573 2c0a 2020  ockfile does,.  
-00011a50: 2020 2320 7472 7920 7265 6d6f 7669 6e67    # try removing
-00011a60: 2074 6865 206c 6f63 6b66 696c 6520 6173   the lockfile as
-00011a70: 2069 7420 6d69 6768 7420 6265 2061 2067   it might be a g
-00011a80: 686f 7374 206c 6f63 6b66 696c 652e 0a20  host lockfile.. 
-00011a90: 2020 2069 6620 6e6f 7420 6473 742e 6578     if not dst.ex
-00011aa0: 6973 7473 2829 2061 6e64 206c 6f63 6b66  ists() and lockf
-00011ab0: 696c 652e 6578 6973 7473 2829 3a0a 2020  ile.exists():.  
-00011ac0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00011ad0: 2020 2020 2020 206c 6f63 6b66 696c 652e         lockfile.
-00011ae0: 756e 6c69 6e6b 2829 0a20 2020 2020 2020  unlink().       
-00011af0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00011b00: 6e3a 0a20 2020 2020 2020 2020 2020 205f  n:.            _
-00011b10: 203d 204e 6f6e 650a 0a20 2020 2023 2043   = None..    # C
-00011b20: 7265 6174 696e 6720 6c6f 636b 6669 6c65  reating lockfile
-00011b30: 2061 6e64 2061 7070 656e 640a 2020 2020   and append.    
-00011b40: 7374 6172 745f 7469 6d65 203d 2064 6174  start_time = dat
-00011b50: 6574 696d 652e 6461 7465 7469 6d65 2e6e  etime.datetime.n
-00011b60: 6f77 2829 0a20 2020 2072 6561 6479 203d  ow().    ready =
-00011b70: 2046 616c 7365 0a20 2020 2077 6869 6c65   False.    while
-00011b80: 206e 6f74 2072 6561 6479 3a0a 2020 2020   not ready:.    
-00011b90: 2020 2020 6966 205f 696f 5f75 7469 6c2e      if _io_util.
-00011ba0: 6372 6561 7465 5f66 696c 655f 6174 6f6d  create_file_atom
-00011bb0: 6963 286c 6f63 6b66 696c 6529 2069 7320  ic(lockfile) is 
-00011bc0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-00011bd0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00011be0: 2020 2020 2020 2023 2061 7070 656e 640a         # append.
-00011bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c00: 5f61 7070 656e 645f 746f 5f6e 6f6c 6f63  _append_to_noloc
-00011c10: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
-00011c20: 2020 2020 2020 2073 7263 3d73 7263 2c0a         src=src,.
-00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c40: 2020 2020 6473 743d 6473 742c 0a20 2020      dst=dst,.   
-00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c60: 2073 7263 5f6c 6179 6572 3d73 7263 5f6c   src_layer=src_l
-00011c70: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-00011c80: 2020 2020 2020 2020 2020 6473 745f 6c61            dst_la
-00011c90: 7965 723d 6473 745f 6c61 7965 722c 0a20  yer=dst_layer,. 
-00011ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011cb0: 2020 2073 7263 5f63 7273 3d73 7263 5f63     src_crs=src_c
-00011cc0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00011cd0: 2020 2020 2020 2020 6473 745f 6372 733d          dst_crs=
-00011ce0: 6473 745f 6372 732c 0a20 2020 2020 2020  dst_crs,.       
-00011cf0: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-00011d00: 726f 6a65 6374 3d72 6570 726f 6a65 6374  roject=reproject
-00011d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011d20: 2020 2020 2020 6578 706c 6f64 6563 6f6c        explodecol
-00011d30: 6c65 6374 696f 6e73 3d65 7870 6c6f 6465  lections=explode
-00011d40: 636f 6c6c 6563 7469 6f6e 732c 0a20 2020  collections,.   
-00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d60: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00011d70: 6f6d 6574 7279 7479 7065 3d66 6f72 6365  ometrytype=force
-00011d80: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-00011d90: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-00011da0: 2020 2020 2020 2020 2020 6372 6561 7465            create
-00011db0: 5f73 7061 7469 616c 5f69 6e64 6578 3d63  _spatial_index=c
-00011dc0: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-00011dd0: 6465 782c 0a20 2020 2020 2020 2020 2020  dex,.           
-00011de0: 2020 2020 2020 2020 2074 7261 6e73 6163           transac
-00011df0: 7469 6f6e 5f73 697a 653d 7472 616e 7361  tion_size=transa
-00011e00: 6374 696f 6e5f 7369 7a65 2c0a 2020 2020  ction_size,.    
-00011e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e20: 7072 6573 6572 7665 5f66 6964 3d70 7265  preserve_fid=pre
-00011e30: 7365 7276 655f 6669 642c 0a20 2020 2020  serve_fid,.     
-00011e40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00011e50: 7074 696f 6e73 3d6f 7074 696f 6e73 2c0a  ptions=options,.
-00011e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e70: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
-00011e80: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00011e90: 2020 2020 2020 2072 6561 6479 203d 2054         ready = T
-00011ea0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00011eb0: 2020 2020 6c6f 636b 6669 6c65 2e75 6e6c      lockfile.unl
-00011ec0: 696e 6b28 290a 2020 2020 2020 2020 656c  ink().        el
-00011ed0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011ee0: 7469 6d65 5f77 6169 7469 6e67 203d 2028  time_waiting = (
-00011ef0: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-00011f00: 652e 6e6f 7728 2920 2d20 7374 6172 745f  e.now() - start_
-00011f10: 7469 6d65 292e 746f 7461 6c5f 7365 636f  time).total_seco
-00011f20: 6e64 7328 290a 2020 2020 2020 2020 2020  nds().          
-00011f30: 2020 6966 2074 696d 655f 7761 6974 696e    if time_waitin
-00011f40: 6720 3e20 6170 7065 6e64 5f74 696d 656f  g > append_timeo
-00011f50: 7574 5f73 3a0a 2020 2020 2020 2020 2020  ut_s:.          
-00011f60: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00011f70: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
-00011f80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00011f90: 6170 7065 6e64 5f74 6f20 7469 6d65 6f75  append_to timeou
-00011fa0: 7420 6f66 207b 6170 7065 6e64 5f74 696d  t of {append_tim
-00011fb0: 656f 7574 5f73 7d20 7265 6163 6865 642c  eout_s} reached,
-00011fc0: 2073 6f20 7374 6f70 2077 7269 7465 2022   so stop write "
-00011fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011fe0: 2020 2020 2066 2274 6f20 7b64 7374 7d21       f"to {dst}!
-00011ff0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00012000: 2020 290a 0a20 2020 2020 2020 2023 2053    )..        # S
-00012010: 6c65 6570 2066 6f72 2061 2073 6563 6f6e  leep for a secon
-00012020: 6420 6265 666f 7265 2074 7279 696e 6720  d before trying 
-00012030: 6167 6169 6e0a 2020 2020 2020 2020 7469  again.        ti
-00012040: 6d65 2e73 6c65 6570 2831 290a 0a0a 6465  me.sleep(1)...de
-00012050: 6620 5f61 7070 656e 645f 746f 5f6e 6f6c  f _append_to_nol
-00012060: 6f63 6b28 0a20 2020 2073 7263 3a20 5061  ock(.    src: Pa
-00012070: 7468 2c0a 2020 2020 6473 743a 2050 6174  th,.    dst: Pat
-00012080: 682c 0a20 2020 2073 7263 5f6c 6179 6572  h,.    src_layer
-00012090: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000120a0: 3d20 4e6f 6e65 2c0a 2020 2020 6473 745f  = None,.    dst_
-000120b0: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
-000120c0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-000120d0: 2073 7263 5f63 7273 3a20 556e 696f 6e5b   src_crs: Union[
-000120e0: 696e 742c 2073 7472 2c20 4e6f 6e65 5d20  int, str, None] 
-000120f0: 3d20 4e6f 6e65 2c0a 2020 2020 6473 745f  = None,.    dst_
-00012100: 6372 733a 2055 6e69 6f6e 5b69 6e74 2c20  crs: Union[int, 
-00012110: 7374 722c 204e 6f6e 655d 203d 204e 6f6e  str, None] = Non
-00012120: 652c 0a20 2020 2072 6570 726f 6a65 6374  e,.    reproject
-00012130: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00012140: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-00012150: 6374 696f 6e73 3a20 626f 6f6c 203d 2046  ctions: bool = F
-00012160: 616c 7365 2c0a 2020 2020 6372 6561 7465  alse,.    create
-00012170: 5f73 7061 7469 616c 5f69 6e64 6578 3a20  _spatial_index: 
-00012180: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
-00012190: 2054 7275 652c 0a20 2020 2066 6f72 6365   True,.    force
-000121a0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-000121b0: 7479 7065 3a20 556e 696f 6e5b 4765 6f6d  type: Union[Geom
-000121c0: 6574 7279 5479 7065 2c20 7374 722c 204e  etryType, str, N
-000121d0: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
-000121e0: 2074 7261 6e73 6163 7469 6f6e 5f73 697a   transaction_siz
-000121f0: 653a 2069 6e74 203d 2035 3030 3030 2c0a  e: int = 50000,.
-00012200: 2020 2020 7072 6573 6572 7665 5f66 6964      preserve_fid
-00012210: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-00012220: 203d 204e 6f6e 652c 0a20 2020 206f 7074   = None,.    opt
-00012230: 696f 6e73 3a20 6469 6374 203d 207b 7d2c  ions: dict = {},
-00012240: 0a29 3a0a 2020 2020 2320 4368 6563 6b2f  .):.    # Check/
-00012250: 636c 6561 6e20 696e 7075 7420 7061 7261  clean input para
-00012260: 6d73 0a20 2020 206f 7074 696f 6e73 203d  ms.    options =
-00012270: 205f 6f67 725f 7574 696c 2e5f 7072 6570   _ogr_util._prep
-00012280: 6172 655f 6764 616c 5f6f 7074 696f 6e73  are_gdal_options
-00012290: 286f 7074 696f 6e73 290a 2020 2020 6966  (options).    if
-000122a0: 2028 0a20 2020 2020 2020 2063 7265 6174   (.        creat
-000122b0: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
-000122c0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-000122d0: 2020 2020 616e 6420 224c 4159 4552 5f43      and "LAYER_C
-000122e0: 5245 4154 494f 4e2e 5350 4154 4941 4c5f  REATION.SPATIAL_
-000122f0: 494e 4445 5822 206e 6f74 2069 6e20 6f70  INDEX" not in op
-00012300: 7469 6f6e 730a 2020 2020 293a 0a20 2020  tions.    ):.   
-00012310: 2020 2020 206f 7074 696f 6e73 5b22 4c41       options["LA
-00012320: 5945 525f 4352 4541 5449 4f4e 2e53 5041  YER_CREATION.SPA
-00012330: 5449 414c 5f49 4e44 4558 225d 203d 2063  TIAL_INDEX"] = c
-00012340: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-00012350: 6465 780a 0a20 2020 2023 2057 6865 6e20  dex..    # When 
-00012360: 6372 6561 7469 6e67 2f61 7070 656e 6469  creating/appendi
-00012370: 6e67 2074 6f20 6120 7368 6170 6566 696c  ng to a shapefil
-00012380: 652c 206c 6175 6e64 6572 2074 6865 2063  e, launder the c
-00012390: 6f6c 756d 6e73 206e 616d 6573 2076 6961  olumns names via
-000123a0: 0a20 2020 2023 2061 2073 716c 2073 7461  .    # a sql sta
-000123b0: 7465 6d65 6e74 2c20 6f74 6865 7277 6973  tement, otherwis
-000123c0: 6520 7768 656e 2061 7070 656e 6469 6e67  e when appending
-000123d0: 2074 6865 206c 6175 6e64 6572 6564 2063   the laundered c
-000123e0: 6f6c 756d 6e73 2077 696c 6c0a 2020 2020  olumns will.    
-000123f0: 2320 6765 7420 4e55 4c4c 2076 616c 7565  # get NULL value
-00012400: 7320 696e 7374 6561 6420 6f66 2074 6865  s instead of the
-00012410: 2064 6174 612e 0a20 2020 2073 716c 5f73   data..    sql_s
-00012420: 746d 7420 3d20 4e6f 6e65 0a20 2020 2073  tmt = None.    s
-00012430: 7263 5f6c 6179 6572 696e 666f 203d 204e  rc_layerinfo = N
-00012440: 6f6e 650a 2020 2020 6966 2064 7374 2e73  one.    if dst.s
-00012450: 7566 6669 782e 6c6f 7765 7228 2920 3d3d  uffix.lower() ==
-00012460: 2022 2e73 6870 223a 0a20 2020 2020 2020   ".shp":.       
-00012470: 2073 7263 5f6c 6179 6572 696e 666f 203d   src_layerinfo =
-00012480: 2067 6574 5f6c 6179 6572 696e 666f 2873   get_layerinfo(s
-00012490: 7263 2c20 7372 635f 6c61 7965 7229 0a20  rc, src_layer). 
-000124a0: 2020 2020 2020 2073 7263 5f63 6f6c 756d         src_colum
-000124b0: 6e73 203d 2073 7263 5f6c 6179 6572 696e  ns = src_layerin
-000124c0: 666f 2e63 6f6c 756d 6e73 0a20 2020 2020  fo.columns.     
-000124d0: 2020 2063 6f6c 756d 6e73 5f6c 6175 6e64     columns_laund
-000124e0: 6572 6564 203d 205f 6c61 756e 6465 725f  ered = _launder_
-000124f0: 636f 6c75 6d6e 5f6e 616d 6573 2873 7263  column_names(src
-00012500: 5f63 6f6c 756d 6e73 290a 2020 2020 2020  _columns).      
-00012510: 2020 636f 6c75 6d6e 735f 616c 6961 7365    columns_aliase
-00012520: 6420 3d20 5b0a 2020 2020 2020 2020 2020  d = [.          
-00012530: 2020 6627 227b 636f 6c75 6d6e 7d22 2041    f'"{column}" A
-00012540: 5320 227b 6c61 756e 6465 7265 647d 2227  S "{laundered}"'
-00012550: 2066 6f72 2063 6f6c 756d 6e2c 206c 6175   for column, lau
-00012560: 6e64 6572 6564 2069 6e20 636f 6c75 6d6e  ndered in column
-00012570: 735f 6c61 756e 6465 7265 640a 2020 2020  s_laundered.    
-00012580: 2020 2020 5d0a 2020 2020 2020 2020 6c61      ].        la
-00012590: 7965 7220 3d20 7372 635f 6c61 7965 7220  yer = src_layer 
-000125a0: 6966 2073 7263 5f6c 6179 6572 2069 7320  if src_layer is 
-000125b0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6765  not None else ge
-000125c0: 745f 6f6e 6c79 5f6c 6179 6572 2873 7263  t_only_layer(src
-000125d0: 290a 2020 2020 2020 2020 7371 6c5f 7374  ).        sql_st
-000125e0: 6d74 203d 2066 2753 454c 4543 5420 7b22  mt = f'SELECT {"
-000125f0: 2c20 222e 6a6f 696e 2863 6f6c 756d 6e73  , ".join(columns
-00012600: 5f61 6c69 6173 6564 297d 2046 524f 4d20  _aliased)} FROM 
-00012610: 227b 6c61 7965 727d 2227 0a0a 2020 2020  "{layer}"'..    
-00012620: 2320 5768 656e 2064 7374 2066 696c 6520  # When dst file 
-00012630: 646f 6573 6e27 7420 6578 6973 7420 616e  doesn't exist an
-00012640: 6420 7372 6320 6973 2065 6d70 7479 2066  d src is empty f
-00012650: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00012660: 6574 7279 7479 7065 2073 686f 756c 6420  etrytype should 
-00012670: 6265 0a20 2020 2023 2073 7065 6369 6669  be.    # specifi
-00012680: 6564 2c20 6f74 6865 7277 6973 6520 696e  ed, otherwise in
-00012690: 7661 6c69 6420 6f75 7470 7574 2e0a 2020  valid output..  
-000126a0: 2020 6966 2066 6f72 6365 5f6f 7574 7075    if force_outpu
-000126b0: 745f 6765 6f6d 6574 7279 7479 7065 2069  t_geometrytype i
-000126c0: 7320 4e6f 6e65 2061 6e64 206e 6f74 2064  s None and not d
-000126d0: 7374 2e65 7869 7374 7328 293a 0a20 2020  st.exists():.   
-000126e0: 2020 2020 2069 6620 7372 635f 6c61 7965       if src_laye
-000126f0: 7269 6e66 6f20 6973 204e 6f6e 653a 0a20  rinfo is None:. 
-00012700: 2020 2020 2020 2020 2020 2073 7263 5f6c             src_l
-00012710: 6179 6572 696e 666f 203d 2067 6574 5f6c  ayerinfo = get_l
-00012720: 6179 6572 696e 666f 2873 7263 2c20 7372  ayerinfo(src, sr
-00012730: 635f 6c61 7965 7229 0a20 2020 2020 2020  c_layer).       
-00012740: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00012750: 6f6d 6574 7279 7479 7065 203d 2073 7263  ometrytype = src
-00012760: 5f6c 6179 6572 696e 666f 2e67 656f 6d65  _layerinfo.geome
-00012770: 7472 7974 7970 650a 0a20 2020 2023 2047  trytype..    # G
-00012780: 6f21 0a20 2020 2074 7261 6e73 6c61 7465  o!.    translate
-00012790: 5f69 6e66 6f20 3d20 5f6f 6772 5f75 7469  _info = _ogr_uti
-000127a0: 6c2e 5665 6374 6f72 5472 616e 736c 6174  l.VectorTranslat
-000127b0: 6549 6e66 6f28 0a20 2020 2020 2020 2069  eInfo(.        i
-000127c0: 6e70 7574 5f70 6174 683d 7372 632c 0a20  nput_path=src,. 
-000127d0: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
-000127e0: 7468 3d64 7374 2c0a 2020 2020 2020 2020  th=dst,.        
-000127f0: 696e 7075 745f 6c61 7965 7273 3d73 7263  input_layers=src
-00012800: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00012810: 6f75 7470 7574 5f6c 6179 6572 3d64 7374  output_layer=dst
-00012820: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00012830: 696e 7075 745f 7372 733d 7372 635f 6372  input_srs=src_cr
-00012840: 732c 0a20 2020 2020 2020 206f 7574 7075  s,.        outpu
-00012850: 745f 7372 733d 6473 745f 6372 732c 0a20  t_srs=dst_crs,. 
-00012860: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
-00012870: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
-00012880: 2020 7371 6c5f 6469 616c 6563 743d 224f    sql_dialect="O
-00012890: 4752 5351 4c22 2c0a 2020 2020 2020 2020  GRSQL",.        
-000128a0: 7265 7072 6f6a 6563 743d 7265 7072 6f6a  reproject=reproj
-000128b0: 6563 742c 0a20 2020 2020 2020 2074 7261  ect,.        tra
-000128c0: 6e73 6163 7469 6f6e 5f73 697a 653d 7472  nsaction_size=tr
-000128d0: 616e 7361 6374 696f 6e5f 7369 7a65 2c0a  ansaction_size,.
-000128e0: 2020 2020 2020 2020 6170 7065 6e64 3d54          append=T
-000128f0: 7275 652c 0a20 2020 2020 2020 2075 7064  rue,.        upd
-00012900: 6174 653d 5472 7565 2c0a 2020 2020 2020  ate=True,.      
-00012910: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
-00012920: 696f 6e73 3d65 7870 6c6f 6465 636f 6c6c  ions=explodecoll
-00012930: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
-00012940: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00012950: 6f6d 6574 7279 7479 7065 3d66 6f72 6365  ometrytype=force
-00012960: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-00012970: 7479 7065 2c0a 2020 2020 2020 2020 6f70  type,.        op
-00012980: 7469 6f6e 733d 6f70 7469 6f6e 732c 0a20  tions=options,. 
-00012990: 2020 2020 2020 2070 7265 7365 7276 655f         preserve_
-000129a0: 6669 643d 7072 6573 6572 7665 5f66 6964  fid=preserve_fid
-000129b0: 2c0a 2020 2020 290a 2020 2020 5f6f 6772  ,.    ).    _ogr
-000129c0: 5f75 7469 6c2e 7665 6374 6f72 5f74 7261  _util.vector_tra
-000129d0: 6e73 6c61 7465 5f62 795f 696e 666f 2869  nslate_by_info(i
-000129e0: 6e66 6f3d 7472 616e 736c 6174 655f 696e  nfo=translate_in
-000129f0: 666f 290a 0a0a 6465 6620 636f 6e76 6572  fo)...def conver
-00012a00: 7428 0a20 2020 2073 7263 3a20 556e 696f  t(.    src: Unio
-00012a10: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
-00012a20: 696b 655b 416e 795d 225d 2c0a 2020 2020  ike[Any]"],.    
-00012a30: 6473 743a 2055 6e69 6f6e 5b73 7472 2c20  dst: Union[str, 
-00012a40: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
-00012a50: 5d22 5d2c 0a20 2020 2073 7263 5f6c 6179  ]"],.    src_lay
-00012a60: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-00012a70: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6473  ] = None,.    ds
-00012a80: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
-00012a90: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00012aa0: 2020 2073 7263 5f63 7273 3a20 556e 696f     src_crs: Unio
-00012ab0: 6e5b 7374 722c 2069 6e74 2c20 4e6f 6e65  n[str, int, None
-00012ac0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6473  ] = None,.    ds
-00012ad0: 745f 6372 733a 2055 6e69 6f6e 5b73 7472  t_crs: Union[str
-00012ae0: 2c20 696e 742c 204e 6f6e 655d 203d 204e  , int, None] = N
-00012af0: 6f6e 652c 0a20 2020 2072 6570 726f 6a65  one,.    reproje
-00012b00: 6374 3a20 626f 6f6c 203d 2046 616c 7365  ct: bool = False
-00012b10: 2c0a 2020 2020 6578 706c 6f64 6563 6f6c  ,.    explodecol
-00012b20: 6c65 6374 696f 6e73 3a20 626f 6f6c 203d  lections: bool =
-00012b30: 2046 616c 7365 2c0a 2020 2020 666f 7263   False,.    forc
-00012b40: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-00012b50: 7974 7970 653a 2055 6e69 6f6e 5b47 656f  ytype: Union[Geo
-00012b60: 6d65 7472 7954 7970 652c 2073 7472 2c20  metryType, str, 
-00012b70: 4e6f 6e65 5d20 3d20 4e6f 6e65 2c0a 2020  None] = None,.  
-00012b80: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
-00012b90: 5f69 6e64 6578 3a20 4f70 7469 6f6e 616c  _index: Optional
-00012ba0: 5b62 6f6f 6c5d 203d 2054 7275 652c 0a20  [bool] = True,. 
-00012bb0: 2020 2070 7265 7365 7276 655f 6669 643a     preserve_fid:
-00012bc0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00012bd0: 3d20 4e6f 6e65 2c0a 2020 2020 6f70 7469  = None,.    opti
-00012be0: 6f6e 733a 2064 6963 7420 3d20 7b7d 2c0a  ons: dict = {},.
-00012bf0: 2020 2020 6170 7065 6e64 3a20 626f 6f6c      append: bool
-00012c00: 203d 2046 616c 7365 2c0a 2020 2020 666f   = False,.    fo
-00012c10: 7263 653a 2062 6f6f 6c20 3d20 4661 6c73  rce: bool = Fals
-00012c20: 652c 0a29 3a0a 2020 2020 2222 220a 2020  e,.):.    """.  
-00012c30: 2020 5265 6164 2061 206c 6179 6572 2066    Read a layer f
-00012c40: 726f 6d20 6120 736f 7572 6365 2066 696c  rom a source fil
-00012c50: 6520 616e 6420 7772 6974 6520 6974 2074  e and write it t
-00012c60: 6f20 6120 6e65 7720 6465 7374 696e 6174  o a new destinat
-00012c70: 696f 6e20 6669 6c65 2e0a 0a20 2020 2054  ion file...    T
-00012c80: 7970 6963 616c 6c79 2075 7365 6420 746f  ypically used to
-00012c90: 2063 6f6e 7665 7274 2066 726f 6d20 6f6e   convert from on
-00012ca0: 6520 6669 6c65 666f 726d 6174 2074 6f20  e fileformat to 
-00012cb0: 616e 6f74 6865 7220 6f72 2074 6f20 7265  another or to re
-00012cc0: 7072 6f6a 6563 742e 0a0a 2020 2020 5468  project...    Th
-00012cd0: 6520 6f70 7469 6f6e 7320 7061 7261 6d65  e options parame
-00012ce0: 7465 7220 6361 6e20 6265 2075 7365 6420  ter can be used 
-00012cf0: 746f 2070 6173 7320 616e 7920 7479 7065  to pass any type
-00012d00: 206f 6620 6f70 7469 6f6e 7320 746f 2047   of options to G
-00012d10: 4441 4c20 696e 0a20 2020 2074 6865 2066  DAL in.    the f
-00012d20: 6f6c 6c6f 7769 6e67 2066 6f72 6d3a 0a20  ollowing form:. 
-00012d30: 2020 2020 2020 207b 2022 3c6f 7074 696f         { "<optio
-00012d40: 6e5f 7479 7065 3e2e 3c6f 7074 696f 6e5f  n_type>.<option_
-00012d50: 6e61 6d65 3e22 3a20 3c6f 7074 696f 6e5f  name>": <option_
-00012d60: 7661 6c75 653e 207d 0a0a 2020 2020 5468  value> }..    Th
-00012d70: 6520 6f70 7469 6f6e 2074 7970 6573 2063  e option types c
-00012d80: 616e 2062 6520 616e 7920 6f66 2074 6865  an be any of the
-00012d90: 2066 6f6c 6c6f 7769 6e67 3a0a 2020 2020   following:.    
-00012da0: 2020 2020 2d20 4c41 5945 525f 4352 4541      - LAYER_CREA
-00012db0: 5449 4f4e 3a20 6c61 7965 7220 6372 6561  TION: layer crea
-00012dc0: 7469 6f6e 206f 7074 696f 6e20 286c 636f  tion option (lco
-00012dd0: 290a 2020 2020 2020 2020 2d20 4441 5441  ).        - DATA
-00012de0: 5345 545f 4352 4541 5449 4f4e 3a20 6461  SET_CREATION: da
-00012df0: 7461 7365 7420 6372 6561 7469 6f6e 206f  taset creation o
-00012e00: 7074 696f 6e20 2864 7363 6f29 0a20 2020  ption (dsco).   
-00012e10: 2020 2020 202d 2049 4e50 5554 5f4f 5045       - INPUT_OPE
-00012e20: 4e3a 2069 6e70 7574 2064 6174 6173 6574  N: input dataset
-00012e30: 206f 7065 6e20 6f70 7469 6f6e 2028 6f6f   open option (oo
-00012e40: 290a 2020 2020 2020 2020 2d20 4445 5354  ).        - DEST
-00012e50: 494e 4154 494f 4e5f 4f50 454e 3a20 6465  INATION_OPEN: de
-00012e60: 7374 696e 6174 696f 6e20 6461 7461 7365  stination datase
-00012e70: 7420 6f70 656e 206f 7074 696f 6e20 2864  t open option (d
-00012e80: 6f6f 290a 2020 2020 2020 2020 2d20 434f  oo).        - CO
-00012e90: 4e46 4947 3a20 636f 6e66 6967 206f 7074  NFIG: config opt
-00012ea0: 696f 6e20 2863 6f6e 6669 6729 0a0a 2020  ion (config)..  
-00012eb0: 2020 5468 6520 6f70 7469 6f6e 7320 6361    The options ca
-00012ec0: 6e20 6265 2066 6f75 6e64 2069 6e20 7468  n be found in th
-00012ed0: 6520 5b47 4441 4c20 7665 6374 6f72 2064  e [GDAL vector d
-00012ee0: 7269 7665 7220 646f 6375 6d65 6e74 6174  river documentat
-00012ef0: 696f 6e5d 0a20 2020 2028 6874 7470 733a  ion].    (https:
-00012f00: 2f2f 6764 616c 2e6f 7267 2f64 7269 7665  //gdal.org/drive
-00012f10: 7273 2f76 6563 746f 722f 696e 6465 782e  rs/vector/index.
-00012f20: 6874 6d6c 292e 0a0a 2020 2020 4172 6773  html)...    Args
-00012f30: 3a0a 2020 2020 2020 2020 7372 6320 2850  :.        src (P
-00012f40: 6174 684c 696b 6529 3a20 5468 6520 736f  athLike): The so
-00012f50: 7572 6365 2066 696c 6520 7061 7468 2e0a  urce file path..
-00012f60: 2020 2020 2020 2020 6473 7420 2850 6174          dst (Pat
-00012f70: 684c 696b 6529 3a20 5468 6520 6465 7374  hLike): The dest
-00012f80: 696e 6174 696f 6e20 6669 6c65 2070 6174  ination file pat
-00012f90: 682e 0a20 2020 2020 2020 2073 7263 5f6c  h..        src_l
-00012fa0: 6179 6572 2028 7374 722c 206f 7074 696f  ayer (str, optio
-00012fb0: 6e61 6c29 3a20 5468 6520 736f 7572 6365  nal): The source
-00012fc0: 206c 6179 6572 2e20 4966 204e 6f6e 6520   layer. If None 
-00012fd0: 616e 6420 7468 6572 6520 6973 206f 6e6c  and there is onl
-00012fe0: 790a 2020 2020 2020 2020 2020 2020 6f6e  y.            on
-00012ff0: 6520 6c61 7965 7220 696e 2074 6865 2073  e layer in the s
-00013000: 7263 2066 696c 652c 2074 6861 7420 6c61  rc file, that la
-00013010: 7965 7220 6973 2074 616b 656e 2e20 4465  yer is taken. De
-00013020: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-00013030: 2020 2020 2020 2020 6473 745f 6c61 7965          dst_laye
-00013040: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
-00013050: 293a 2054 6865 2064 6573 7469 6e61 7469  ): The destinati
-00013060: 6f6e 206c 6179 6572 2e20 4966 204e 6f6e  on layer. If Non
-00013070: 652c 2074 6865 2066 696c 650a 2020 2020  e, the file.    
-00013080: 2020 2020 2020 2020 7374 656d 2069 7320          stem is 
-00013090: 7461 6b65 6e20 6173 206c 6179 6572 206e  taken as layer n
-000130a0: 616d 652e 2044 6566 6175 6c74 7320 746f  ame. Defaults to
-000130b0: 204e 6f6e 652e 0a20 2020 2020 2020 2073   None..        s
-000130c0: 7263 5f63 7273 2028 556e 696f 6e5b 7374  rc_crs (Union[st
-000130d0: 722c 2069 6e74 5d2c 206f 7074 696f 6e61  r, int], optiona
-000130e0: 6c29 3a20 616e 2065 7073 6720 696e 7420  l): an epsg int 
-000130f0: 6f72 2061 6e79 7468 696e 6720 7375 7070  or anything supp
-00013100: 6f72 7465 640a 2020 2020 2020 2020 2020  orted.          
-00013110: 2020 6279 2074 6865 204f 4752 5370 6174    by the OGRSpat
-00013120: 6961 6c52 6566 6572 656e 6365 2e53 6574  ialReference.Set
-00013130: 4672 6f6d 5573 6572 496e 7075 7428 2920  FromUserInput() 
-00013140: 6361 6c6c 2c20 7768 6963 6820 696e 636c  call, which incl
-00013150: 7564 6573 0a20 2020 2020 2020 2020 2020  udes.           
-00013160: 2061 6e20 4550 5347 2073 7472 696e 6720   an EPSG string 
-00013170: 2865 672e 2022 4550 5347 3a34 3332 3622  (eg. "EPSG:4326"
-00013180: 292c 2061 2077 656c 6c20 6b6e 6f77 6e20  ), a well known 
-00013190: 7465 7874 2028 574b 5429 2043 5253 0a20  text (WKT) CRS. 
-000131a0: 2020 2020 2020 2020 2020 2064 6566 696e             defin
-000131b0: 6974 696f 6e2c 2e2e 2e20 4465 6661 756c  ition,... Defaul
-000131c0: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
-000131d0: 2020 2020 6473 745f 6372 7320 2855 6e69      dst_crs (Uni
-000131e0: 6f6e 5b73 7472 2c20 696e 745d 2c20 6f70  on[str, int], op
-000131f0: 7469 6f6e 616c 293a 2061 6e20 6570 7367  tional): an epsg
-00013200: 2069 6e74 206f 7220 616e 7974 6869 6e67   int or anything
-00013210: 2073 7570 706f 7274 6564 0a20 2020 2020   supported.     
-00013220: 2020 2020 2020 2062 7920 7468 6520 4f47         by the OG
-00013230: 5253 7061 7469 616c 5265 6665 7265 6e63  RSpatialReferenc
-00013240: 652e 5365 7446 726f 6d55 7365 7249 6e70  e.SetFromUserInp
-00013250: 7574 2829 2063 616c 6c2c 2077 6869 6368  ut() call, which
-00013260: 2069 6e63 6c75 6465 730a 2020 2020 2020   includes.      
-00013270: 2020 2020 2020 616e 2045 5053 4720 7374        an EPSG st
-00013280: 7269 6e67 2028 6567 2e20 2245 5053 473a  ring (eg. "EPSG:
-00013290: 3433 3236 2229 2c20 6120 7765 6c6c 206b  4326"), a well k
-000132a0: 6e6f 776e 2074 6578 7420 2857 4b54 2920  nown text (WKT) 
-000132b0: 4352 530a 2020 2020 2020 2020 2020 2020  CRS.            
-000132c0: 6465 6669 6e69 7469 6f6e 2c2e 2e2e 2044  definition,... D
-000132d0: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-000132e0: 0a20 2020 2020 2020 2072 6570 726f 6a65  .        reproje
-000132f0: 6374 2028 626f 6f6c 2c20 6f70 7469 6f6e  ct (bool, option
-00013300: 616c 293a 2054 7275 6520 746f 2072 6570  al): True to rep
-00013310: 726f 6a65 6374 2077 6869 6c65 2063 6f6e  roject while con
-00013320: 7665 7274 696e 6720 7468 650a 2020 2020  verting the.    
-00013330: 2020 2020 2020 2020 6669 6c65 2e20 4465          file. De
-00013340: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
-00013350: 0a20 2020 2020 2020 2065 7870 6c6f 6465  .        explode
-00013360: 636f 6c6c 6563 7469 6f6e 7320 2862 6f6f  collections (boo
-00013370: 6c2c 206f 7074 696f 6e61 6c29 3a20 5472  l, optional): Tr
-00013380: 7565 2074 6f20 6f75 7470 7574 206f 6e6c  ue to output onl
-00013390: 7920 7369 6d70 6c65 0a20 2020 2020 2020  y simple.       
-000133a0: 2020 2020 2067 656f 6d65 7472 6965 732e       geometries.
-000133b0: 2044 6566 6175 6c74 7320 746f 2046 616c   Defaults to Fal
-000133c0: 7365 2e0a 2020 2020 2020 2020 666f 7263  se..        forc
-000133d0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-000133e0: 7974 7970 6520 2855 6e69 6f6e 5b47 656f  ytype (Union[Geo
-000133f0: 6d65 7472 7954 7970 652c 2073 7472 5d2c  metryType, str],
-00013400: 206f 7074 696f 6e61 6c29 3a20 4765 6f6d   optional): Geom
-00013410: 6574 7279 2074 7970 652e 0a20 2020 2020  etry type..     
-00013420: 2020 2020 2020 2074 6f20 2874 7279 2074         to (try t
-00013430: 6f29 2066 6f72 6365 2074 6865 206f 7574  o) force the out
-00013440: 7075 7420 746f 2e20 4465 6661 756c 7473  put to. Defaults
-00013450: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
-00013460: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
-00013470: 5f69 6e64 6578 2028 626f 6f6c 2c20 6f70  _index (bool, op
-00013480: 7469 6f6e 616c 293a 2054 7275 6520 746f  tional): True to
-00013490: 2063 7265 6174 6520 6120 7370 6174 6961   create a spatia
-000134a0: 6c20 696e 6465 780a 2020 2020 2020 2020  l index.        
-000134b0: 2020 2020 6f6e 2074 6865 2064 6573 7469      on the desti
-000134c0: 6e61 7469 6f6e 2066 696c 652f 6c61 7965  nation file/laye
-000134d0: 722e 2049 6620 4e6f 6e65 2c20 7468 6520  r. If None, the 
-000134e0: 6465 6661 756c 7420 6265 6861 7669 6f75  default behaviou
-000134f0: 7220 6279 2067 6461 6c20 666f 720a 2020  r by gdal for.  
-00013500: 2020 2020 2020 2020 2020 7468 6174 2066            that f
-00013510: 696c 6520 7479 7065 2069 7320 7265 7370  ile type is resp
-00013520: 6563 7465 642e 2049 6620 7468 6520 4c41  ected. If the LA
-00013530: 5945 525f 4352 4541 5449 4f4e 2e53 5041  YER_CREATION.SPA
-00013540: 5449 414c 5f49 4e44 4558 0a20 2020 2020  TIAL_INDEX.     
-00013550: 2020 2020 2020 2070 6172 616d 6574 6572         parameter
-00013560: 2069 7320 7370 6563 6966 6965 6420 696e   is specified in
-00013570: 206f 7074 696f 6e73 2c20 6372 6561 7465   options, create
-00013580: 5f73 7061 7469 616c 5f69 6e64 6578 2069  _spatial_index i
-00013590: 7320 6967 6e6f 7265 642e 0a20 2020 2020  s ignored..     
-000135a0: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-000135b0: 746f 2054 7275 652e 0a20 2020 2020 2020  to True..       
-000135c0: 2070 7265 7365 7276 655f 6669 6420 2862   preserve_fid (b
-000135d0: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
-000135e0: 5472 7565 2074 6f20 6d61 6b65 2061 6e20  True to make an 
-000135f0: 6578 7472 6120 6566 666f 7274 2074 6f20  extra effort to 
-00013600: 7072 6573 6572 7665 2066 6964 2773 206f  preserve fid's o
-00013610: 660a 2020 2020 2020 2020 2020 2020 7468  f.            th
-00013620: 6520 736f 7572 6365 206c 6179 6572 2074  e source layer t
-00013630: 6f20 7468 6520 6465 7374 696e 6174 696f  o the destinatio
-00013640: 6e20 6c61 7965 722e 2046 616c 7365 206e  n layer. False n
-00013650: 6f74 2074 6f20 646f 2061 6e79 2065 6666  ot to do any eff
-00013660: 6f72 742e 204e 6f6e 650a 2020 2020 2020  ort. None.      
-00013670: 2020 2020 2020 746f 2075 7365 2074 6865        to use the
-00013680: 2064 6566 6175 6c74 2062 6568 6176 696f   default behavio
-00013690: 7572 206f 6620 6764 616c 2c20 7468 6174  ur of gdal, that
-000136a0: 2061 6c72 6561 6479 2070 7265 7365 7276   already preserv
-000136b0: 6573 2069 6e20 736f 6d65 2063 6173 6573  es in some cases
-000136c0: 2e0a 2020 2020 2020 2020 2020 2020 536f  ..            So
-000136d0: 6d65 2066 696c 6520 666f 726d 6174 7320  me file formats 
-000136e0: 646f 6e27 7420 6578 706c 6963 6974 6c79  don't explicitly
-000136f0: 2073 746f 7265 2074 6865 2066 6964 2028   store the fid (
-00013700: 652e 672e 2073 6861 7065 6669 6c65 292c  e.g. shapefile),
-00013710: 2073 6f20 7468 6579 0a20 2020 2020 2020   so they.       
-00013720: 2020 2020 2077 696c 6c20 6e65 7665 7220       will never 
-00013730: 6265 2061 626c 6520 746f 2070 7265 7365  be able to prese
-00013740: 7276 6520 6669 6473 2e20 4465 6661 756c  rve fids. Defaul
-00013750: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
-00013760: 2020 2020 6f70 7469 6f6e 7320 2864 6963      options (dic
-00013770: 742c 206f 7074 696f 6e61 6c29 3a20 6f70  t, optional): op
-00013780: 7469 6f6e 7320 746f 2070 6173 7320 746f  tions to pass to
-00013790: 2067 6461 6c2e 0a20 2020 2020 2020 2061   gdal..        a
-000137a0: 7070 656e 6420 2862 6f6f 6c2c 206f 7074  ppend (bool, opt
-000137b0: 696f 6e61 6c29 3a20 5472 7565 2074 6f20  ional): True to 
-000137c0: 6170 7065 6e64 2074 6f20 7468 6520 6f75  append to the ou
-000137d0: 7470 7574 2066 696c 6520 6966 2069 7420  tput file if it 
-000137e0: 6578 6973 7473 2e0a 2020 2020 2020 2020  exists..        
-000137f0: 2020 2020 4465 6661 756c 7473 2074 6f20      Defaults to 
-00013800: 4661 6c73 652e 0a20 2020 2020 2020 2066  False..        f
-00013810: 6f72 6365 2028 626f 6f6c 2c20 6f70 7469  orce (bool, opti
-00013820: 6f6e 616c 293a 206f 7665 7277 7269 7465  onal): overwrite
-00013830: 2065 7869 7374 696e 6720 6f75 7470 7574   existing output
-00013840: 2066 696c 6528 7329 0a20 2020 2020 2020   file(s).       
-00013850: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
-00013860: 2046 616c 7365 2e0a 2020 2020 2222 220a   False..    """.
-00013870: 2020 2020 2320 496e 6974 0a20 2020 2073      # Init.    s
-00013880: 7263 203d 2050 6174 6828 7372 6329 0a20  rc = Path(src). 
-00013890: 2020 2064 7374 203d 2050 6174 6828 6473     dst = Path(ds
-000138a0: 7429 0a0a 2020 2020 2320 4966 2073 6f75  t)..    # If sou
-000138b0: 7263 6520 6669 6c65 2064 6f65 736e 2774  rce file doesn't
-000138c0: 2065 7869 7374 2c20 7261 6973 6520 6572   exist, raise er
-000138d0: 726f 720a 2020 2020 6966 206e 6f74 2073  ror.    if not s
-000138e0: 7263 2e65 7869 7374 7328 293a 0a20 2020  rc.exists():.   
-000138f0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00013900: 4572 726f 7228 6622 7372 6320 6669 6c65  Error(f"src file
-00013910: 2064 6f65 736e 2774 2065 7869 7374 3a20   doesn't exist: 
-00013920: 7b73 7263 7d22 290a 2020 2020 2320 4966  {src}").    # If
-00013930: 2064 6573 7420 6669 6c65 2065 7869 7374   dest file exist
-00013940: 7320 616c 7265 6164 792c 2072 656d 6f76  s already, remov
-00013950: 6520 6974 0a20 2020 2069 6620 6e6f 7420  e it.    if not 
-00013960: 6170 7065 6e64 2061 6e64 2064 7374 2e65  append and dst.e
-00013970: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
-00013980: 2069 6620 666f 7263 6520 6973 2054 7275   if force is Tru
-00013990: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000139a0: 656d 6f76 6528 6473 7429 0a20 2020 2020  emove(dst).     
-000139b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000139c0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-000139d0: 2866 224f 7574 7075 7420 6669 6c65 2065  (f"Output file e
-000139e0: 7869 7374 7320 616c 7265 6164 792c 2073  xists already, s
-000139f0: 6f20 7374 6f70 3a20 7b64 7374 7d22 290a  o stop: {dst}").
-00013a00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013a10: 726e 0a0a 2020 2020 2320 436f 6e76 6572  rn..    # Conver
-00013a20: 740a 2020 2020 6c6f 6767 6572 2e69 6e66  t.    logger.inf
-00013a30: 6f28 6622 436f 6e76 6572 7420 7b73 7263  o(f"Convert {src
-00013a40: 7d20 746f 207b 6473 747d 2229 0a20 2020  } to {dst}").   
-00013a50: 205f 6170 7065 6e64 5f74 6f5f 6e6f 6c6f   _append_to_nolo
-00013a60: 636b 280a 2020 2020 2020 2020 7372 632c  ck(.        src,
-00013a70: 0a20 2020 2020 2020 2064 7374 2c0a 2020  .        dst,.  
-00013a80: 2020 2020 2020 7372 635f 6c61 7965 722c        src_layer,
-00013a90: 0a20 2020 2020 2020 2064 7374 5f6c 6179  .        dst_lay
-00013aa0: 6572 2c0a 2020 2020 2020 2020 7372 635f  er,.        src_
-00013ab0: 6372 733d 7372 635f 6372 732c 0a20 2020  crs=src_crs,.   
-00013ac0: 2020 2020 2064 7374 5f63 7273 3d64 7374       dst_crs=dst
-00013ad0: 5f63 7273 2c0a 2020 2020 2020 2020 7265  _crs,.        re
-00013ae0: 7072 6f6a 6563 743d 7265 7072 6f6a 6563  project=reprojec
-00013af0: 742c 0a20 2020 2020 2020 2065 7870 6c6f  t,.        explo
-00013b00: 6465 636f 6c6c 6563 7469 6f6e 733d 6578  decollections=ex
-00013b10: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-00013b20: 2c0a 2020 2020 2020 2020 666f 7263 655f  ,.        force_
-00013b30: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-00013b40: 7970 653d 666f 7263 655f 6f75 7470 7574  ype=force_output
-00013b50: 5f67 656f 6d65 7472 7974 7970 652c 0a20  _geometrytype,. 
-00013b60: 2020 2020 2020 2063 7265 6174 655f 7370         create_sp
-00013b70: 6174 6961 6c5f 696e 6465 783d 6372 6561  atial_index=crea
-00013b80: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-00013b90: 2c0a 2020 2020 2020 2020 7072 6573 6572  ,.        preser
-00013ba0: 7665 5f66 6964 3d70 7265 7365 7276 655f  ve_fid=preserve_
-00013bb0: 6669 642c 0a20 2020 2020 2020 206f 7074  fid,.        opt
-00013bc0: 696f 6e73 3d6f 7074 696f 6e73 2c0a 2020  ions=options,.  
-00013bd0: 2020 290a 0a0a 6465 6620 5f6c 6175 6e64    )...def _laund
-00013be0: 6572 5f63 6f6c 756d 6e5f 6e61 6d65 7328  er_column_names(
-00013bf0: 636f 6c75 6d6e 733a 2049 7465 7261 626c  columns: Iterabl
-00013c00: 6529 202d 3e20 4c69 7374 5b54 7570 6c65  e) -> List[Tuple
-00013c10: 5b73 7472 2c20 7374 725d 5d3a 0a20 2020  [str, str]]:.   
-00013c20: 2022 2222 0a20 2020 204c 6175 6e64 6572   """.    Launder
-00013c30: 7320 7468 6520 636f 6c75 6d6e 206e 616d  s the column nam
-00013c40: 6573 2070 6173 7365 6420 746f 2063 6f6d  es passed to com
-00013c50: 706c 7920 7769 7468 2073 6861 7065 6669  ply with shapefi
-00013c60: 6c65 2072 6573 7472 6963 7469 6f6e 732e  le restrictions.
-00013c70: 0a0a 2020 2020 5261 7469 6f6e 616c 653a  ..    Rationale:
-00013c80: 206e 6f72 6d61 6c6c 7920 6764 616c 206c   normally gdal l
-00013c90: 6175 6e64 6572 7320 7468 656d 2069 6620  aunders them if 
-00013ca0: 6e65 6564 6564 2c20 6275 7420 7768 656e  needed, but when
-00013cb0: 2079 6f75 2061 7070 656e 640a 2020 2020   you append.    
-00013cc0: 6d75 6c74 6970 6c65 2066 696c 6573 2074  multiple files t
-00013cd0: 6f20 6120 7368 6170 6566 696c 6520 7769  o a shapefile wi
-00013ce0: 7468 2063 6f6c 756d 6e73 2074 6861 7420  th columns that 
-00013cf0: 6e65 6564 2074 6f20 6265 206c 6175 6e64  need to be laund
-00013d00: 6572 6564 0a20 2020 2074 6865 7920 6172  ered.    they ar
-00013d10: 6520 6e6f 7420 6d61 7463 6865 6420 616e  e not matched an
-00013d20: 6420 736f 2061 7265 2061 7070 656e 6465  d so are appende
-00013d30: 6420 7769 7468 204e 554c 4c20 7661 6c75  d with NULL valu
-00013d40: 6573 2066 6f72 2074 6865 7365 0a20 2020  es for these.   
-00013d50: 2063 6f6c 756d 6e73 2e20 4e6f 726d 616c   columns. Normal
-00013d60: 6c79 2074 6865 202d 7265 6c61 7865 6446  ly the -relaxedF
-00013d70: 6965 6c64 4e61 6d65 4d61 7463 6820 7061  ieldNameMatch pa
-00013d80: 7261 6d65 7465 7220 696e 206f 6772 326f  rameter in ogr2o
-00013d90: 6772 0a20 2020 2073 686f 756c 6420 6669  gr.    should fi
-00013da0: 7820 7468 6973 2c20 6275 7420 6974 2073  x this, but it s
-00013db0: 6565 6d73 2074 6861 7420 7468 6973 2069  eems that this i
-00013dc0: 736e 2774 2073 7570 706f 7274 6564 2066  sn't supported f
-00013dd0: 6f72 2073 6861 7065 6669 6c65 732e 0a0a  or shapefiles...
-00013de0: 2020 2020 4c61 756e 6465 7269 6e67 2069      Laundering i
-00013df0: 7320 6261 7365 6420 6f6e 2074 6869 7320  s based on this 
-00013e00: 7465 7874 2066 726f 6d20 7468 6520 6764  text from the gd
-00013e10: 616c 2073 6861 7065 6669 6c65 2064 7269  al shapefile dri
-00013e20: 7665 720a 2020 2020 646f 6375 6d65 6e74  ver.    document
-00013e30: 6174 696f 6e3a 0a0a 2020 2020 5368 6170  ation:..    Shap
-00013e40: 6566 696c 6520 6665 6174 7572 6520 6174  efile feature at
-00013e50: 7472 6962 7574 6573 2061 7265 2073 746f  tributes are sto
-00013e60: 7265 6420 696e 2061 6e20 6173 736f 6369  red in an associ
-00013e70: 6174 6564 202e 6462 6620 6669 6c65 2c20  ated .dbf file, 
-00013e80: 616e 640a 2020 2020 736f 2061 7474 7269  and.    so attri
-00013e90: 6275 7465 7320 7375 6666 6572 2061 206e  butes suffer a n
-00013ea0: 756d 6265 7220 6f66 206c 696d 6974 6174  umber of limitat
-00013eb0: 696f 6e73 3a0a 2020 2020 2d20 2020 4174  ions:.    -   At
-00013ec0: 7472 6962 7574 6520 6e61 6d65 7320 6361  tribute names ca
-00013ed0: 6e20 6f6e 6c79 2062 6520 7570 2074 6f20  n only be up to 
-00013ee0: 3130 2063 6861 7261 6374 6572 7320 6c6f  10 characters lo
-00013ef0: 6e67 2e0a 2020 2020 2020 2020 5468 6520  ng..        The 
-00013f00: 4f47 5220 5368 6170 6566 696c 6520 6472  OGR Shapefile dr
-00013f10: 6976 6572 2074 7269 6573 2074 6f20 6765  iver tries to ge
-00013f20: 6e65 7261 7465 2075 6e69 7175 6520 6669  nerate unique fi
-00013f30: 656c 640a 2020 2020 2020 2020 6e61 6d65  eld.        name
-00013f40: 732e 2053 7563 6365 7373 6976 6520 6475  s. Successive du
-00013f50: 706c 6963 6174 6520 6669 656c 6420 6e61  plicate field na
-00013f60: 6d65 732c 2069 6e63 6c75 6469 6e67 2074  mes, including t
-00013f70: 686f 7365 2063 7265 6174 6564 2062 790a  hose created by.
-00013f80: 2020 2020 2020 2020 7472 756e 6361 7469          truncati
-00013f90: 6f6e 2074 6f20 3130 2063 6861 7261 6374  on to 10 charact
-00013fa0: 6572 732c 2077 696c 6c20 6265 2074 7275  ers, will be tru
-00013fb0: 6e63 6174 6564 2074 6f20 3820 6368 6172  ncated to 8 char
-00013fc0: 6163 7465 7273 2061 6e64 0a20 2020 2020  acters and.     
-00013fd0: 2020 2061 7070 656e 6465 6420 7769 7468     appended with
-00013fe0: 2061 2073 6572 6961 6c20 6e75 6d62 6572   a serial number
-00013ff0: 2066 726f 6d20 3120 746f 2039 392e 0a0a   from 1 to 99...
-00014000: 2020 2020 2020 2020 466f 7220 6578 616d          For exam
-00014010: 706c 653a 0a0a 2020 2020 2020 2020 2d20  ple:..        - 
-00014020: 2061 20e2 8692 2061 2c20 6120 e286 9220   a ... a, a ... 
-00014030: 615f 312c 2041 20e2 8692 2041 5f32 3b0a  a_1, A ... A_2;.
-00014040: 2020 2020 2020 2020 2d20 2061 6263 6465          -  abcde
-00014050: 6667 6869 6a6b 20e2 8692 2061 6263 6465  fghijk ... abcde
-00014060: 6667 6869 6a2c 2061 6263 6465 6667 6869  fghij, abcdefghi
-00014070: 6a6b 6c20 e286 9220 6162 6364 6566 6768  jkl ... abcdefgh
-00014080: 5f31 0a0a 2020 2020 2d20 2020 4f6e 6c79  _1..    -   Only
-00014090: 2049 6e74 6567 6572 2c20 496e 7465 6765   Integer, Intege
-000140a0: 7236 342c 2052 6561 6c2c 2053 7472 696e  r64, Real, Strin
-000140b0: 6720 616e 6420 4461 7465 2028 6e6f 7420  g and Date (not 
-000140c0: 4461 7465 5469 6d65 2c20 6a75 7374 0a20  DateTime, just. 
-000140d0: 2020 2020 2020 2079 6561 722f 6d6f 6e74         year/mont
-000140e0: 682f 6461 7929 2066 6965 6c64 2074 7970  h/day) field typ
-000140f0: 6573 2061 7265 2073 7570 706f 7274 6564  es are supported
-00014100: 2e20 5468 6520 7661 7269 6f75 7320 6c69  . The various li
-00014110: 7374 2c20 616e 640a 2020 2020 2020 2020  st, and.        
-00014120: 6269 6e61 7279 2066 6965 6c64 2074 7970  binary field typ
-00014130: 6573 2063 616e 6e6f 7420 6265 2063 7265  es cannot be cre
-00014140: 6174 6564 2e0a 2020 2020 2d20 2020 5468  ated..    -   Th
-00014150: 6520 6669 656c 6420 7769 6474 6820 616e  e field width an
-00014160: 6420 7072 6563 6973 696f 6e20 6172 6520  d precision are 
-00014170: 6469 7265 6374 6c79 2075 7365 6420 746f  directly used to
-00014180: 2065 7374 6162 6c69 7368 2073 746f 7261   establish stora
-00014190: 6765 0a20 2020 2020 2020 2073 697a 6520  ge.        size 
-000141a0: 696e 2074 6865 202e 6462 6620 6669 6c65  in the .dbf file
-000141b0: 2e20 5468 6973 206d 6561 6e73 2074 6861  . This means tha
-000141c0: 7420 7374 7269 6e67 7320 6c6f 6e67 6572  t strings longer
-000141d0: 2074 6861 6e20 7468 6520 6669 656c 640a   than the field.
-000141e0: 2020 2020 2020 2020 7769 6474 682c 206f          width, o
-000141f0: 7220 6e75 6d62 6572 7320 7468 6174 2064  r numbers that d
-00014200: 6f6e 2774 2066 6974 2069 6e74 6f20 7468  on't fit into th
-00014210: 6520 696e 6469 6361 7465 6420 6669 656c  e indicated fiel
-00014220: 6420 666f 726d 6174 2077 696c 6c0a 2020  d format will.  
-00014230: 2020 2020 2020 7375 6666 6572 2074 7275        suffer tru
-00014240: 6e63 6174 696f 6e2e 0a20 2020 202d 2020  ncation..    -  
-00014250: 2049 6e74 6567 6572 2066 6965 6c64 7320   Integer fields 
-00014260: 7769 7468 6f75 7420 616e 2065 7870 6c69  without an expli
-00014270: 6369 7420 7769 6474 6820 6172 6520 7472  cit width are tr
-00014280: 6561 7465 6420 6173 2077 6964 7468 2039  eated as width 9
-00014290: 2c20 616e 640a 2020 2020 2020 2020 6578  , and.        ex
-000142a0: 7465 6e64 6564 2074 6f20 3130 206f 7220  tended to 10 or 
-000142b0: 3131 2069 6620 6e65 6564 6564 2e0a 2020  11 if needed..  
-000142c0: 2020 2d20 2020 496e 7465 6765 7236 3420    -   Integer64 
-000142d0: 6669 656c 6473 2077 6974 686f 7574 2061  fields without a
-000142e0: 6e20 6578 706c 6963 6974 2077 6964 7468  n explicit width
-000142f0: 2061 7265 2074 7265 6174 6564 2061 7320   are treated as 
-00014300: 7769 6474 6820 3138 2c0a 2020 2020 2020  width 18,.      
-00014310: 2020 616e 6420 6578 7465 6e64 6564 2074    and extended t
-00014320: 6f20 3139 206f 7220 3230 2069 6620 6e65  o 19 or 20 if ne
-00014330: 6564 6564 2e0a 2020 2020 2d20 2020 5265  eded..    -   Re
-00014340: 616c 2028 666c 6f61 7469 6e67 2070 6f69  al (floating poi
-00014350: 6e74 2920 6669 656c 6473 2077 6974 686f  nt) fields witho
-00014360: 7574 2061 6e20 6578 706c 6963 6974 2077  ut an explicit w
-00014370: 6964 7468 2061 7265 2074 7265 6174 6564  idth are treated
-00014380: 2061 730a 2020 2020 2020 2020 7769 6474   as.        widt
-00014390: 6820 3234 2077 6974 6820 3135 2064 6563  h 24 with 15 dec
-000143a0: 696d 616c 2070 6c61 6365 7320 6f66 2070  imal places of p
-000143b0: 7265 6369 7369 6f6e 2e0a 2020 2020 2d20  recision..    - 
-000143c0: 2020 5374 7269 6e67 2066 6965 6c64 7320    String fields 
-000143d0: 7769 7468 6f75 7420 616e 2061 7373 6967  without an assig
-000143e0: 6e65 6420 7769 6474 6820 6172 6520 7472  ned width are tr
-000143f0: 6561 7465 6420 6173 2038 3020 6368 6172  eated as 80 char
-00014400: 6163 7465 7273 2e0a 0a20 2020 2041 7267  acters...    Arg
-00014410: 733a 0a20 2020 2020 2020 2063 6f6c 756d  s:.        colum
-00014420: 6e73 2028 4974 6572 6162 6c65 293a 2074  ns (Iterable): t
-00014430: 6865 2063 6f6c 756d 6e73 2074 6f20 6c61  he columns to la
-00014440: 756e 6465 722e 0a0a 2020 2020 5265 7475  under...    Retu
-00014450: 726e 733a 2061 204c 6973 7420 6f66 2074  rns: a List of t
-00014460: 7570 706c 6573 2077 6974 6820 7468 6520  upples with the 
-00014470: 6f72 6967 696e 616c 2061 6e64 206c 6175  original and lau
-00014480: 6e64 6572 6564 2063 6f6c 756d 6e20 6e61  ndered column na
-00014490: 6d65 732e 0a20 2020 2022 2222 0a20 2020  mes..    """.   
-000144a0: 206c 6175 6e64 6572 6564 203d 205b 5d0a   laundered = [].
-000144b0: 2020 2020 6c61 756e 6465 7265 645f 7570      laundered_up
-000144c0: 7065 7220 3d20 5b5d 0a20 2020 2066 6f72  per = [].    for
-000144d0: 2063 6f6c 756d 6e20 696e 2063 6f6c 756d   column in colum
-000144e0: 6e73 3a0a 2020 2020 2020 2020 2320 446f  ns:.        # Do
-000144f0: 7562 6c65 7320 696e 2063 6173 696e 6720  ubles in casing 
-00014500: 6172 6565 206e 6f74 2061 6c6c 6f77 6564  aree not allowed
-00014510: 2065 6974 6865 720a 2020 2020 2020 2020   either.        
-00014520: 6966 206c 656e 2863 6f6c 756d 6e29 203c  if len(column) <
-00014530: 3d20 3130 3a0a 2020 2020 2020 2020 2020  = 10:.          
-00014540: 2020 6966 2063 6f6c 756d 6e2e 7570 7065    if column.uppe
-00014550: 7228 2920 6e6f 7420 696e 206c 6175 6e64  r() not in laund
-00014560: 6572 6564 5f75 7070 6572 3a0a 2020 2020  ered_upper:.    
-00014570: 2020 2020 2020 2020 2020 2020 6c61 756e              laun
-00014580: 6465 7265 645f 7570 7065 722e 6170 7065  dered_upper.appe
-00014590: 6e64 2863 6f6c 756d 6e2e 7570 7065 7228  nd(column.upper(
-000145a0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000145b0: 2020 206c 6175 6e64 6572 6564 2e61 7070     laundered.app
-000145c0: 656e 6428 2863 6f6c 756d 6e2c 2063 6f6c  end((column, col
-000145d0: 756d 6e29 290a 2020 2020 2020 2020 2020  umn)).          
-000145e0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-000145f0: 2020 2020 2020 2020 2320 4c61 756e 6465          # Launde
-00014600: 7269 6e67 2069 7320 6e65 6564 6564 0a20  ring is needed. 
-00014610: 2020 2020 2020 2063 6f6c 756d 6e5f 6c61         column_la
-00014620: 756e 6465 7265 6420 3d20 636f 6c75 6d6e  undered = column
-00014630: 5b3a 3130 5d0a 2020 2020 2020 2020 6966  [:10].        if
-00014640: 2063 6f6c 756d 6e5f 6c61 756e 6465 7265   column_laundere
-00014650: 642e 7570 7065 7228 2920 6e6f 7420 696e  d.upper() not in
-00014660: 206c 6175 6e64 6572 6564 5f75 7070 6572   laundered_upper
-00014670: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
-00014680: 756e 6465 7265 645f 7570 7065 722e 6170  undered_upper.ap
-00014690: 7065 6e64 2863 6f6c 756d 6e5f 6c61 756e  pend(column_laun
-000146a0: 6465 7265 642e 7570 7065 7228 2929 0a20  dered.upper()). 
-000146b0: 2020 2020 2020 2020 2020 206c 6175 6e64             laund
-000146c0: 6572 6564 2e61 7070 656e 6428 2863 6f6c  ered.append((col
-000146d0: 756d 6e2c 2063 6f6c 756d 6e5f 6c61 756e  umn, column_laun
-000146e0: 6465 7265 6429 290a 2020 2020 2020 2020  dered)).        
-000146f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014700: 2020 2320 4a75 7374 2074 616b 696e 6720    # Just taking 
-00014710: 6669 7273 7420 3130 2063 6861 7261 6374  first 10 charact
-00014720: 6572 7320 6469 646e 2774 2068 656c 700a  ers didn't help.
-00014730: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00014740: 696e 6465 7820 696e 2072 616e 6765 2831  index in range(1
-00014750: 2c20 3130 3129 3a0a 2020 2020 2020 2020  , 101):.        
-00014760: 2020 2020 2020 2020 6966 2069 6e64 6578          if index
-00014770: 203e 3d20 3130 303a 0a20 2020 2020 2020   >= 100:.       
-00014780: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00014790: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-000147a0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147c0: 224e 6f74 2073 7570 706f 7274 6564 2074  "Not supported t
-000147d0: 6f20 6c61 756e 6465 7220 3e20 3939 2063  o launder > 99 c
-000147e0: 6f6c 756d 6e73 2073 7461 7274 696e 6720  olumns starting 
-000147f0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00014800: 2020 2020 2020 2020 2020 6622 7769 7468            f"with
-00014810: 207b 636f 6c75 6d6e 5f6c 6175 6e64 6572   {column_launder
-00014820: 6564 5b3a 385d 7d22 0a20 2020 2020 2020  ed[:8]}".       
-00014830: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00014840: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014850: 6620 696e 6465 7820 3c3d 2039 3a0a 2020  f index <= 9:.  
-00014860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014870: 2020 636f 6c75 6d6e 5f6c 6175 6e64 6572    column_launder
-00014880: 6564 203d 2066 227b 636f 6c75 6d6e 5f6c  ed = f"{column_l
-00014890: 6175 6e64 6572 6564 5b3a 385d 7d5f 7b69  aundered[:8]}_{i
-000148a0: 6e64 6578 7d22 0a20 2020 2020 2020 2020  ndex}".         
-000148b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000148c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148d0: 2063 6f6c 756d 6e5f 6c61 756e 6465 7265   column_laundere
-000148e0: 6420 3d20 6622 7b63 6f6c 756d 6e5f 6c61  d = f"{column_la
-000148f0: 756e 6465 7265 645b 3a38 5d7d 7b69 6e64  undered[:8]}{ind
-00014900: 6578 7d22 0a20 2020 2020 2020 2020 2020  ex}".           
-00014910: 2020 2020 2069 6620 636f 6c75 6d6e 5f6c       if column_l
-00014920: 6175 6e64 6572 6564 2e75 7070 6572 2829  aundered.upper()
-00014930: 206e 6f74 2069 6e20 6c61 756e 6465 7265   not in laundere
-00014940: 645f 7570 7065 723a 0a20 2020 2020 2020  d_upper:.       
-00014950: 2020 2020 2020 2020 2020 2020 206c 6175               lau
-00014960: 6e64 6572 6564 5f75 7070 6572 2e61 7070  ndered_upper.app
-00014970: 656e 6428 636f 6c75 6d6e 5f6c 6175 6e64  end(column_laund
-00014980: 6572 6564 2e75 7070 6572 2829 290a 2020  ered.upper()).  
-00014990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149a0: 2020 6c61 756e 6465 7265 642e 6170 7065    laundered.appe
-000149b0: 6e64 2828 636f 6c75 6d6e 2c20 636f 6c75  nd((column, colu
-000149c0: 6d6e 5f6c 6175 6e64 6572 6564 2929 0a20  mn_laundered)). 
-000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149e0: 2020 2062 7265 616b 0a0a 2020 2020 7265     break..    re
-000149f0: 7475 726e 206c 6175 6e64 6572 6564 0a    turn laundered.
+0000fc30: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+0000fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc50: 2066 2246 696c 6520 7b70 6174 6831 5f6e   f"File {path1_n
+0000fc60: 6f65 7874 7d7b 6578 747d 2069 7320 6469  oext}{ext} is di
+0000fc70: 6666 6572 656e 7420 6672 6f6d 207b 7061  fferent from {pa
+0000fc80: 7468 325f 6e6f 6578 747d 7b65 7874 7d22  th2_noext}{ext}"
+0000fc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fca0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000fcb0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0000fcc0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000fcd0: 7275 650a 2020 2020 656c 7365 3a0a 2020  rue.    else:.  
+0000fce0: 2020 2020 2020 7265 7475 726e 2066 696c        return fil
+0000fcf0: 6563 6d70 2e63 6d70 2873 7472 2870 6174  ecmp.cmp(str(pat
+0000fd00: 6831 5f70 292c 2073 7472 2870 6174 6832  h1_p), str(path2
+0000fd10: 5f70 2929 0a0a 0a64 6566 2063 6f70 7928  _p))...def copy(
+0000fd20: 7372 633a 2055 6e69 6f6e 5b73 7472 2c20  src: Union[str, 
+0000fd30: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+0000fd40: 5d22 5d2c 2064 7374 3a20 556e 696f 6e5b  ]"], dst: Union[
+0000fd50: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+0000fd60: 655b 416e 795d 225d 293a 0a20 2020 2022  e[Any]"]):.    "
+0000fd70: 2222 0a20 2020 2043 6f70 6965 7320 7468  "".    Copies th
+0000fd80: 6520 6765 6f66 696c 6520 6672 6f6d 2073  e geofile from s
+0000fd90: 7263 2074 6f20 6473 742e 2049 7320 7468  rc to dst. Is th
+0000fda0: 6520 736f 7572 6365 2066 696c 6520 6973  e source file is
+0000fdb0: 2061 2067 656f 6669 6c65 2063 6f6e 7461   a geofile conta
+0000fdc0: 696e 696e 670a 2020 2020 6f66 206d 756c  ining.    of mul
+0000fdd0: 7469 706c 6520 6669 6c65 7320 2865 672e  tiple files (eg.
+0000fde0: 202e 7368 7029 2061 6c6c 2066 696c 6573   .shp) all files
+0000fdf0: 2061 7265 2063 6f70 6965 642e 0a0a 2020   are copied...  
+0000fe00: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000fe10: 7372 6320 2850 6174 684c 696b 6529 3a20  src (PathLike): 
+0000fe20: 7468 6520 6669 6c65 2074 6f20 636f 7079  the file to copy
+0000fe30: 2e0a 2020 2020 2020 2020 6473 7420 2850  ..        dst (P
+0000fe40: 6174 684c 696b 6529 3a20 7468 6520 6c6f  athLike): the lo
+0000fe50: 6361 7469 6f6e 2074 6f20 636f 7079 2074  cation to copy t
+0000fe60: 6865 2066 696c 6528 7329 2074 6f2e 0a20  he file(s) to.. 
+0000fe70: 2020 2022 2222 0a20 2020 2023 2043 6865     """.    # Che
+0000fe80: 636b 2069 6e70 7574 2070 6172 616d 6574  ck input paramet
+0000fe90: 6572 730a 2020 2020 7372 6320 3d20 5061  ers.    src = Pa
+0000fea0: 7468 2873 7263 290a 2020 2020 6473 7420  th(src).    dst 
+0000feb0: 3d20 5061 7468 2864 7374 290a 2020 2020  = Path(dst).    
+0000fec0: 6765 6f66 696c 6574 7970 6520 3d20 4765  geofiletype = Ge
+0000fed0: 6f66 696c 6554 7970 6528 7372 6329 0a0a  ofileType(src)..
+0000fee0: 2020 2020 2320 436f 7079 2074 6865 206d      # Copy the m
+0000fef0: 6169 6e20 6669 6c65 0a20 2020 2073 6875  ain file.    shu
+0000ff00: 7469 6c2e 636f 7079 2873 7472 2873 7263  til.copy(str(src
+0000ff10: 292c 2064 7374 290a 0a20 2020 2023 2046  ), dst)..    # F
+0000ff20: 6f72 2073 6f6d 6520 6669 6c65 2074 7970  or some file typ
+0000ff30: 6573 2c20 6578 7472 6120 6669 6c65 7320  es, extra files 
+0000ff40: 6e65 6564 2074 6f20 6265 2063 6f70 6965  need to be copie
+0000ff50: 640a 2020 2020 2320 4966 2064 6573 7420  d.    # If dest 
+0000ff60: 6973 2061 2064 6972 2c20 6a75 7374 2075  is a dir, just u
+0000ff70: 7365 206d 6f76 652e 204f 7468 6572 7769  se move. Otherwi
+0000ff80: 7365 2063 6f6e 6361 7420 6465 7374 2066  se concat dest f
+0000ff90: 696c 6570 6174 6873 0a20 2020 2069 6620  ilepaths.    if 
+0000ffa0: 6765 6f66 696c 6574 7970 652e 7375 6666  geofiletype.suff
+0000ffb0: 6978 6573 5f65 7874 7261 6669 6c65 7320  ixes_extrafiles 
+0000ffc0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000ffd0: 2020 2020 2069 6620 6473 742e 6973 5f64       if dst.is_d
+0000ffe0: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+0000fff0: 2020 666f 7220 7375 6666 6978 2069 6e20    for suffix in 
+00010000: 6765 6f66 696c 6574 7970 652e 7375 6666  geofiletype.suff
+00010010: 6978 6573 5f65 7874 7261 6669 6c65 733a  ixes_extrafiles:
+00010020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010030: 2073 7263 6669 6c65 203d 2073 7263 2e70   srcfile = src.p
+00010040: 6172 656e 7420 2f20 6622 7b73 7263 2e73  arent / f"{src.s
+00010050: 7465 6d7d 7b73 7566 6669 787d 220a 2020  tem}{suffix}".  
+00010060: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010070: 2073 7263 6669 6c65 2e65 7869 7374 7328   srcfile.exists(
+00010080: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010090: 2020 2020 2020 2073 6875 7469 6c2e 636f         shutil.co
+000100a0: 7079 2873 7472 2873 7263 6669 6c65 292c  py(str(srcfile),
+000100b0: 2064 7374 290a 2020 2020 2020 2020 656c   dst).        el
+000100c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000100d0: 666f 7220 7375 6666 6978 2069 6e20 6765  for suffix in ge
+000100e0: 6f66 696c 6574 7970 652e 7375 6666 6978  ofiletype.suffix
+000100f0: 6573 5f65 7874 7261 6669 6c65 733a 0a20  es_extrafiles:. 
+00010100: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010110: 7263 6669 6c65 203d 2073 7263 2e70 6172  rcfile = src.par
+00010120: 656e 7420 2f20 6622 7b73 7263 2e73 7465  ent / f"{src.ste
+00010130: 6d7d 7b73 7566 6669 787d 220a 2020 2020  m}{suffix}".    
+00010140: 2020 2020 2020 2020 2020 2020 6473 7466              dstf
+00010150: 696c 6520 3d20 6473 742e 7061 7265 6e74  ile = dst.parent
+00010160: 202f 2066 227b 6473 742e 7374 656d 7d7b   / f"{dst.stem}{
+00010170: 7375 6666 6978 7d22 0a20 2020 2020 2020  suffix}".       
+00010180: 2020 2020 2020 2020 2069 6620 7372 6366           if srcf
+00010190: 696c 652e 6578 6973 7473 2829 3a0a 2020  ile.exists():.  
+000101a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101b0: 2020 7368 7574 696c 2e63 6f70 7928 7374    shutil.copy(st
+000101c0: 7228 7372 6366 696c 6529 2c20 6473 7466  r(srcfile), dstf
+000101d0: 696c 6529 0a0a 0a64 6566 206d 6f76 6528  ile)...def move(
+000101e0: 7372 633a 2055 6e69 6f6e 5b73 7472 2c20  src: Union[str, 
+000101f0: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00010200: 5d22 5d2c 2064 7374 3a20 556e 696f 6e5b  ]"], dst: Union[
+00010210: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+00010220: 655b 416e 795d 225d 293a 0a20 2020 2022  e[Any]"]):.    "
+00010230: 2222 0a20 2020 204d 6f76 6573 2074 6865  "".    Moves the
+00010240: 2067 656f 6669 6c65 2066 726f 6d20 7372   geofile from sr
+00010250: 6320 746f 2064 7374 2e20 4966 2074 6865  c to dst. If the
+00010260: 2073 6f75 7263 6520 6669 6c65 2069 7320   source file is 
+00010270: 6120 6765 6f66 696c 6520 636f 6e74 6169  a geofile contai
+00010280: 6e69 6e67 0a20 2020 206f 6620 6d75 6c74  ning.    of mult
+00010290: 6970 6c65 2066 696c 6573 2028 6567 2e20  iple files (eg. 
+000102a0: 2e73 6870 2920 616c 6c20 6669 6c65 7320  .shp) all files 
+000102b0: 6172 6520 6d6f 7665 642e 0a0a 2020 2020  are moved...    
+000102c0: 4172 6773 3a0a 2020 2020 2020 2020 7372  Args:.        sr
+000102d0: 6320 2850 6174 684c 696b 6529 3a20 7468  c (PathLike): th
+000102e0: 6520 6669 6c65 2074 6f20 6d6f 7665 0a20  e file to move. 
+000102f0: 2020 2020 2020 2064 7374 2028 5061 7468         dst (Path
+00010300: 4c69 6b65 293a 2074 6865 206c 6f63 6174  Like): the locat
+00010310: 696f 6e20 746f 206d 6f76 6520 7468 6520  ion to move the 
+00010320: 6669 6c65 2873 2920 746f 0a20 2020 2022  file(s) to.    "
+00010330: 2222 0a20 2020 2023 2043 6865 636b 2069  "".    # Check i
+00010340: 6e70 7574 2070 6172 616d 6574 6572 730a  nput parameters.
+00010350: 2020 2020 7372 6320 3d20 5061 7468 2873      src = Path(s
+00010360: 7263 290a 2020 2020 6473 7420 3d20 5061  rc).    dst = Pa
+00010370: 7468 2864 7374 290a 2020 2020 6765 6f66  th(dst).    geof
+00010380: 696c 6574 7970 6520 3d20 4765 6f66 696c  iletype = Geofil
+00010390: 6554 7970 6528 7372 6329 0a0a 2020 2020  eType(src)..    
+000103a0: 2320 4d6f 7665 2074 6865 206d 6169 6e20  # Move the main 
+000103b0: 6669 6c65 0a20 2020 2073 6875 7469 6c2e  file.    shutil.
+000103c0: 6d6f 7665 2873 7472 2873 7263 292c 2064  move(str(src), d
+000103d0: 7374 290a 0a20 2020 2023 2046 6f72 2073  st)..    # For s
+000103e0: 6f6d 6520 6669 6c65 2074 7970 6573 2c20  ome file types, 
+000103f0: 6578 7472 6120 6669 6c65 7320 6e65 6564  extra files need
+00010400: 2074 6f20 6265 206d 6f76 6564 0a20 2020   to be moved.   
+00010410: 2023 2049 6620 6465 7374 2069 7320 6120   # If dest is a 
+00010420: 6469 722c 206a 7573 7420 7573 6520 6d6f  dir, just use mo
+00010430: 7665 2e20 4f74 6865 7277 6973 6520 636f  ve. Otherwise co
+00010440: 6e63 6174 2064 6573 7420 6669 6c65 7061  ncat dest filepa
+00010450: 7468 730a 2020 2020 6966 2067 656f 6669  ths.    if geofi
+00010460: 6c65 7479 7065 2e73 7566 6669 7865 735f  letype.suffixes_
+00010470: 6578 7472 6166 696c 6573 2069 7320 6e6f  extrafiles is no
+00010480: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00010490: 6966 2064 7374 2e69 735f 6469 7228 293a  if dst.is_dir():
+000104a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000104b0: 2073 7566 6669 7820 696e 2067 656f 6669   suffix in geofi
+000104c0: 6c65 7479 7065 2e73 7566 6669 7865 735f  letype.suffixes_
+000104d0: 6578 7472 6166 696c 6573 3a0a 2020 2020  extrafiles:.    
+000104e0: 2020 2020 2020 2020 2020 2020 7372 6366              srcf
+000104f0: 696c 6520 3d20 7372 632e 7061 7265 6e74  ile = src.parent
+00010500: 202f 2066 227b 7372 632e 7374 656d 7d7b   / f"{src.stem}{
+00010510: 7375 6666 6978 7d22 0a20 2020 2020 2020  suffix}".       
+00010520: 2020 2020 2020 2020 2069 6620 7372 6366           if srcf
+00010530: 696c 652e 6578 6973 7473 2829 3a0a 2020  ile.exists():.  
+00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010550: 2020 7368 7574 696c 2e6d 6f76 6528 7374    shutil.move(st
+00010560: 7228 7372 6366 696c 6529 2c20 6473 7429  r(srcfile), dst)
+00010570: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00010580: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+00010590: 7566 6669 7820 696e 2067 656f 6669 6c65  uffix in geofile
+000105a0: 7479 7065 2e73 7566 6669 7865 735f 6578  type.suffixes_ex
+000105b0: 7472 6166 696c 6573 3a0a 2020 2020 2020  trafiles:.      
+000105c0: 2020 2020 2020 2020 2020 7372 6366 696c            srcfil
+000105d0: 6520 3d20 7372 632e 7061 7265 6e74 202f  e = src.parent /
+000105e0: 2066 227b 7372 632e 7374 656d 7d7b 7375   f"{src.stem}{su
+000105f0: 6666 6978 7d22 0a20 2020 2020 2020 2020  ffix}".         
+00010600: 2020 2020 2020 2064 7374 6669 6c65 203d         dstfile =
+00010610: 2064 7374 2e70 6172 656e 7420 2f20 6622   dst.parent / f"
+00010620: 7b64 7374 2e73 7465 6d7d 7b73 7566 6669  {dst.stem}{suffi
+00010630: 787d 220a 2020 2020 2020 2020 2020 2020  x}".            
+00010640: 2020 2020 6966 2073 7263 6669 6c65 2e65      if srcfile.e
+00010650: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00010660: 2020 2020 2020 2020 2020 2020 2073 6875               shu
+00010670: 7469 6c2e 6d6f 7665 2873 7472 2873 7263  til.move(str(src
+00010680: 6669 6c65 292c 2064 7374 6669 6c65 290a  file), dstfile).
+00010690: 0a0a 6465 6620 7265 6d6f 7665 2870 6174  ..def remove(pat
+000106a0: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
+000106b0: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
+000106c0: 5d2c 206d 6973 7369 6e67 5f6f 6b3a 2062  ], missing_ok: b
+000106d0: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+000106e0: 2020 2222 220a 2020 2020 5265 6d6f 7665    """.    Remove
+000106f0: 7320 7468 6520 6765 6f66 696c 652e 2049  s the geofile. I
+00010700: 7320 6974 2069 7320 6120 6765 6f66 696c  s it is a geofil
+00010710: 6520 636f 6d70 6f73 6564 206f 6620 6d75  e composed of mu
+00010720: 6c74 6970 6c65 2066 696c 6573 0a20 2020  ltiple files.   
+00010730: 2028 6567 2e20 2e73 6870 2920 616c 6c20   (eg. .shp) all 
+00010740: 6669 6c65 7320 6172 6520 7265 6d6f 7665  files are remove
+00010750: 642e 0a20 2020 2049 6620 2e6c 6f63 6b20  d..    If .lock 
+00010760: 6669 6c65 7320 6172 6520 7072 6573 656e  files are presen
+00010770: 742c 2074 6865 7920 6172 6520 7265 6d6f  t, they are remo
+00010780: 7665 6420 6173 2077 656c 6c2e 0a0a 2020  ved as well...  
+00010790: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000107a0: 7061 7468 2028 5061 7468 4c69 6b65 293a  path (PathLike):
+000107b0: 2074 6865 2066 696c 6520 746f 2072 656d   the file to rem
+000107c0: 6f76 650a 2020 2020 2222 220a 2020 2020  ove.    """.    
+000107d0: 2320 4368 6563 6b20 696e 7075 7420 7061  # Check input pa
+000107e0: 7261 6d65 7465 7273 0a20 2020 2070 6174  rameters.    pat
+000107f0: 6820 3d20 5061 7468 2870 6174 6829 0a20  h = Path(path). 
+00010800: 2020 2067 656f 6669 6c65 7479 7065 203d     geofiletype =
+00010810: 2047 656f 6669 6c65 5479 7065 2870 6174   GeofileType(pat
+00010820: 6829 0a0a 2020 2020 2320 4966 2074 6865  h)..    # If the
+00010830: 7265 2069 7320 6120 6c6f 636b 2066 696c  re is a lock fil
+00010840: 652c 2072 656d 6f76 6520 6974 0a20 2020  e, remove it.   
+00010850: 206c 6f63 6b66 696c 655f 7061 7468 203d   lockfile_path =
+00010860: 2070 6174 682e 7061 7265 6e74 202f 2066   path.parent / f
+00010870: 227b 7061 7468 2e6e 616d 657d 2e6c 6f63  "{path.name}.loc
+00010880: 6b22 0a20 2020 206c 6f63 6b66 696c 655f  k".    lockfile_
+00010890: 7061 7468 2e75 6e6c 696e 6b28 6d69 7373  path.unlink(miss
+000108a0: 696e 675f 6f6b 3d54 7275 6529 0a0a 2020  ing_ok=True)..  
+000108b0: 2020 2320 5265 6d6f 7665 2074 6865 206d    # Remove the m
+000108c0: 6169 6e20 6669 6c65 0a20 2020 2069 6620  ain file.    if 
+000108d0: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
+000108e0: 2020 2020 2020 2070 6174 682e 756e 6c69         path.unli
+000108f0: 6e6b 286d 6973 7369 6e67 5f6f 6b3d 6d69  nk(missing_ok=mi
+00010900: 7373 696e 675f 6f6b 290a 0a20 2020 2023  ssing_ok)..    #
+00010910: 2046 6f72 2073 6f6d 6520 6669 6c65 2074   For some file t
+00010920: 7970 6573 2c20 6578 7472 6120 6669 6c65  ypes, extra file
+00010930: 7320 6e65 6564 2074 6f20 6265 2072 656d  s need to be rem
+00010940: 6f76 6564 0a20 2020 2069 6620 6765 6f66  oved.    if geof
+00010950: 696c 6574 7970 652e 7375 6666 6978 6573  iletype.suffixes
+00010960: 5f65 7874 7261 6669 6c65 7320 6973 206e  _extrafiles is n
+00010970: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00010980: 2066 6f72 2073 7566 6669 7820 696e 2067   for suffix in g
+00010990: 656f 6669 6c65 7479 7065 2e73 7566 6669  eofiletype.suffi
+000109a0: 7865 735f 6578 7472 6166 696c 6573 3a0a  xes_extrafiles:.
+000109b0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+000109c0: 5f70 6174 6820 3d20 7061 7468 2e70 6172  _path = path.par
+000109d0: 656e 7420 2f20 6622 7b70 6174 682e 7374  ent / f"{path.st
+000109e0: 656d 7d7b 7375 6666 6978 7d22 0a20 2020  em}{suffix}".   
+000109f0: 2020 2020 2020 2020 2063 7572 725f 7061           curr_pa
+00010a00: 7468 2e75 6e6c 696e 6b28 6d69 7373 696e  th.unlink(missin
+00010a10: 675f 6f6b 3d54 7275 6529 0a0a 0a64 6566  g_ok=True)...def
+00010a20: 2061 7070 656e 645f 746f 280a 2020 2020   append_to(.    
+00010a30: 7372 633a 2055 6e69 6f6e 5b73 7472 2c20  src: Union[str, 
+00010a40: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00010a50: 5d22 5d2c 0a20 2020 2064 7374 3a20 556e  ]"],.    dst: Un
+00010a60: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
+00010a70: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
+00010a80: 2020 7372 635f 6c61 7965 723a 204f 7074    src_layer: Opt
+00010a90: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00010aa0: 652c 0a20 2020 2064 7374 5f6c 6179 6572  e,.    dst_layer
+00010ab0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00010ac0: 3d20 4e6f 6e65 2c0a 2020 2020 7372 635f  = None,.    src_
+00010ad0: 6372 733a 2055 6e69 6f6e 5b69 6e74 2c20  crs: Union[int, 
+00010ae0: 7374 722c 204e 6f6e 655d 203d 204e 6f6e  str, None] = Non
+00010af0: 652c 0a20 2020 2064 7374 5f63 7273 3a20  e,.    dst_crs: 
+00010b00: 556e 696f 6e5b 696e 742c 2073 7472 2c20  Union[int, str, 
+00010b10: 4e6f 6e65 5d20 3d20 4e6f 6e65 2c0a 2020  None] = None,.  
+00010b20: 2020 7768 6572 653a 204f 7074 696f 6e61    where: Optiona
+00010b30: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00010b40: 2020 2072 6570 726f 6a65 6374 3a20 626f     reproject: bo
+00010b50: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00010b60: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+00010b70: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
+00010b80: 2c0a 2020 2020 666f 7263 655f 6f75 7470  ,.    force_outp
+00010b90: 7574 5f67 656f 6d65 7472 7974 7970 653a  ut_geometrytype:
+00010ba0: 2055 6e69 6f6e 5b47 656f 6d65 7472 7954   Union[GeometryT
+00010bb0: 7970 652c 2073 7472 2c20 4e6f 6e65 5d20  ype, str, None] 
+00010bc0: 3d20 4e6f 6e65 2c0a 2020 2020 6372 6561  = None,.    crea
+00010bd0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+00010be0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00010bf0: 203d 2054 7275 652c 0a20 2020 2061 7070   = True,.    app
+00010c00: 656e 645f 7469 6d65 6f75 745f 733a 2069  end_timeout_s: i
+00010c10: 6e74 203d 2036 3030 2c0a 2020 2020 7472  nt = 600,.    tr
+00010c20: 616e 7361 6374 696f 6e5f 7369 7a65 3a20  ansaction_size: 
+00010c30: 696e 7420 3d20 3530 3030 302c 0a20 2020  int = 50000,.   
+00010c40: 2070 7265 7365 7276 655f 6669 643a 204f   preserve_fid: O
+00010c50: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00010c60: 4e6f 6e65 2c0a 2020 2020 6f70 7469 6f6e  None,.    option
+00010c70: 733a 2064 6963 7420 3d20 7b7d 2c0a 293a  s: dict = {},.):
+00010c80: 0a20 2020 2022 2222 0a20 2020 2041 7070  .    """.    App
+00010c90: 656e 6420 7372 6320 6669 6c65 2074 6f20  end src file to 
+00010ca0: 7468 6520 6473 7420 6669 6c65 2e0a 0a20  the dst file... 
+00010cb0: 2020 2052 656d 6172 6b3a 2061 7070 656e     Remark: appen
+00010cc0: 6420 6973 206e 6f74 2073 7570 706f 7274  d is not support
+00010cd0: 6564 2066 6f72 2061 6c6c 2066 696c 6574  ed for all filet
+00010ce0: 7970 6573 2069 6e20 6669 6f6e 612f 6765  ypes in fiona/ge
+00010cf0: 6f70 616e 6461 7320 2830 2e38 290a 2020  opandas (0.8).  
+00010d00: 2020 736f 2077 6f72 6b61 726f 756e 6420    so workaround 
+00010d10: 7669 6120 6764 616c 206e 6565 6465 642e  via gdal needed.
+00010d20: 0a0a 2020 2020 5468 6520 6f70 7469 6f6e  ..    The option
+00010d30: 7320 7061 7261 6d65 7465 7220 6361 6e20  s parameter can 
+00010d40: 6265 2075 7365 6420 746f 2070 6173 7320  be used to pass 
+00010d50: 616e 7920 7479 7065 206f 6620 6f70 7469  any type of opti
+00010d60: 6f6e 7320 746f 2047 4441 4c20 696e 0a20  ons to GDAL in. 
+00010d70: 2020 2074 6865 2066 6f6c 6c6f 7769 6e67     the following
+00010d80: 2066 6f72 6d3a 0a20 2020 2020 2020 207b   form:.        {
+00010d90: 2022 3c6f 7074 696f 6e5f 7479 7065 3e2e   "<option_type>.
+00010da0: 3c6f 7074 696f 6e5f 6e61 6d65 3e22 3a20  <option_name>": 
+00010db0: 3c6f 7074 696f 6e5f 7661 6c75 653e 207d  <option_value> }
+00010dc0: 0a0a 2020 2020 5468 6520 6f70 7469 6f6e  ..    The option
+00010dd0: 2074 7970 6573 2063 616e 2062 6520 616e   types can be an
+00010de0: 7920 6f66 2074 6865 2066 6f6c 6c6f 7769  y of the followi
+00010df0: 6e67 3a0a 2020 2020 2020 2020 2d20 4c41  ng:.        - LA
+00010e00: 5945 525f 4352 4541 5449 4f4e 3a20 6c61  YER_CREATION: la
+00010e10: 7965 7220 6372 6561 7469 6f6e 206f 7074  yer creation opt
+00010e20: 696f 6e20 286c 636f 290a 2020 2020 2020  ion (lco).      
+00010e30: 2020 2d20 4441 5441 5345 545f 4352 4541    - DATASET_CREA
+00010e40: 5449 4f4e 3a20 6461 7461 7365 7420 6372  TION: dataset cr
+00010e50: 6561 7469 6f6e 206f 7074 696f 6e20 2864  eation option (d
+00010e60: 7363 6f29 0a20 2020 2020 2020 202d 2049  sco).        - I
+00010e70: 4e50 5554 5f4f 5045 4e3a 2069 6e70 7574  NPUT_OPEN: input
+00010e80: 2064 6174 6173 6574 206f 7065 6e20 6f70   dataset open op
+00010e90: 7469 6f6e 2028 6f6f 290a 2020 2020 2020  tion (oo).      
+00010ea0: 2020 2d20 4445 5354 494e 4154 494f 4e5f    - DESTINATION_
+00010eb0: 4f50 454e 3a20 6465 7374 696e 6174 696f  OPEN: destinatio
+00010ec0: 6e20 6461 7461 7365 7420 6f70 656e 206f  n dataset open o
+00010ed0: 7074 696f 6e20 2864 6f6f 290a 2020 2020  ption (doo).    
+00010ee0: 2020 2020 2d20 434f 4e46 4947 3a20 636f      - CONFIG: co
+00010ef0: 6e66 6967 206f 7074 696f 6e20 2863 6f6e  nfig option (con
+00010f00: 6669 6729 0a0a 2020 2020 5468 6520 6f70  fig)..    The op
+00010f10: 7469 6f6e 7320 6361 6e20 6265 2066 6f75  tions can be fou
+00010f20: 6e64 2069 6e20 7468 6520 5b47 4441 4c20  nd in the [GDAL 
+00010f30: 7665 6374 6f72 2064 7269 7665 7220 646f  vector driver do
+00010f40: 6375 6d65 6e74 6174 696f 6e5d 0a20 2020  cumentation].   
+00010f50: 2028 6874 7470 733a 2f2f 6764 616c 2e6f   (https://gdal.o
+00010f60: 7267 2f64 7269 7665 7273 2f76 6563 746f  rg/drivers/vecto
+00010f70: 722f 696e 6465 782e 6874 6d6c 292e 0a0a  r/index.html)...
+00010f80: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00010f90: 2020 7372 6320 2855 6e69 6f6e 5b73 7472    src (Union[str
+00010fa0: 2c29 3a20 736f 7572 6365 2066 696c 6520  ,): source file 
+00010fb0: 7061 7468 2e0a 2020 2020 2020 2020 6473  path..        ds
+00010fc0: 7420 2855 6e69 6f6e 5b73 7472 2c29 3a20  t (Union[str,): 
+00010fd0: 6465 7374 696e 6174 696f 6e20 6669 6c65  destination file
+00010fe0: 2070 6174 682e 0a20 2020 2020 2020 2073   path..        s
+00010ff0: 7263 5f6c 6179 6572 2028 7374 722c 206f  rc_layer (str, o
+00011000: 7074 696f 6e61 6c29 3a20 736f 7572 6365  ptional): source
+00011010: 206c 6179 6572 2e20 4465 6661 756c 7473   layer. Defaults
+00011020: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
+00011030: 2020 6473 745f 6c61 7965 7220 2873 7472    dst_layer (str
+00011040: 2c20 6f70 7469 6f6e 616c 293a 2064 6573  , optional): des
+00011050: 7469 6e61 7469 6f6e 206c 6179 6572 2e20  tination layer. 
+00011060: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
+00011070: 2e0a 2020 2020 2020 2020 7372 635f 6372  ..        src_cr
+00011080: 7320 2873 7472 2c20 6f70 7469 6f6e 616c  s (str, optional
+00011090: 293a 2061 6e20 6570 7367 2069 6e74 206f  ): an epsg int o
+000110a0: 7220 616e 7974 6869 6e67 2073 7570 706f  r anything suppo
+000110b0: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+000110c0: 2062 7920 7468 6520 4f47 5253 7061 7469   by the OGRSpati
+000110d0: 616c 5265 6665 7265 6e63 652e 5365 7446  alReference.SetF
+000110e0: 726f 6d55 7365 7249 6e70 7574 2829 2063  romUserInput() c
+000110f0: 616c 6c2c 2077 6869 6368 2069 6e63 6c75  all, which inclu
+00011100: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
+00011110: 616e 2045 5053 4720 7374 7269 6e67 2028  an EPSG string (
+00011120: 6567 2e20 2245 5053 473a 3433 3236 2229  eg. "EPSG:4326")
+00011130: 2c20 6120 7765 6c6c 206b 6e6f 776e 2074  , a well known t
+00011140: 6578 7420 2857 4b54 2920 4352 530a 2020  ext (WKT) CRS.  
+00011150: 2020 2020 2020 2020 2020 6465 6669 6e69            defini
+00011160: 7469 6f6e 2c2e 2e2e 2044 6566 6175 6c74  tion,... Default
+00011170: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00011180: 2020 2064 7374 5f63 7273 2028 7374 722c     dst_crs (str,
+00011190: 206f 7074 696f 6e61 6c29 3a20 616e 2065   optional): an e
+000111a0: 7073 6720 696e 7420 6f72 2061 6e79 7468  psg int or anyth
+000111b0: 696e 6720 7375 7070 6f72 7465 640a 2020  ing supported.  
+000111c0: 2020 2020 2020 2020 2020 6279 2074 6865            by the
+000111d0: 204f 4752 5370 6174 6961 6c52 6566 6572   OGRSpatialRefer
+000111e0: 656e 6365 2e53 6574 4672 6f6d 5573 6572  ence.SetFromUser
+000111f0: 496e 7075 7428 2920 6361 6c6c 2c20 7768  Input() call, wh
+00011200: 6963 6820 696e 636c 7564 6573 0a20 2020  ich includes.   
+00011210: 2020 2020 2020 2020 2061 6e20 4550 5347           an EPSG
+00011220: 2073 7472 696e 6720 2865 672e 2022 4550   string (eg. "EP
+00011230: 5347 3a34 3332 3622 292c 2061 2077 656c  SG:4326"), a wel
+00011240: 6c20 6b6e 6f77 6e20 7465 7874 2028 574b  l known text (WK
+00011250: 5429 2043 5253 0a20 2020 2020 2020 2020  T) CRS.         
+00011260: 2020 2064 6566 696e 6974 696f 6e2c 2e2e     definition,..
+00011270: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+00011280: 6e65 2e0a 2020 2020 2020 2020 7768 6572  ne..        wher
+00011290: 6520 2873 7472 2c20 6f70 7469 6f6e 616c  e (str, optional
+000112a0: 293a 206f 6e6c 7920 6170 7065 6e64 2074  ): only append t
+000112b0: 6865 2072 6f77 7320 6672 6f6d 2073 7263  he rows from src
+000112c0: 2074 6861 7420 636f 6d70 6c79 2074 6f20   that comply to 
+000112d0: 7468 6520 6669 6c74 6572 0a20 2020 2020  the filter.     
+000112e0: 2020 2020 2020 2073 7065 6369 6669 6564         specified
+000112f0: 2e20 4170 706c 6965 6420 6265 666f 7265  . Applied before
+00011300: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+00011310: 6f6e 732e 2046 696c 7465 7220 7368 6f75  ons. Filter shou
+00011320: 6c64 2062 6520 696e 2073 716c 6974 650a  ld be in sqlite.
+00011330: 2020 2020 2020 2020 2020 2020 5351 4c20              SQL 
+00011340: 5748 4552 4520 7379 6e74 6178 2061 6e64  WHERE syntax and
+00011350: 207c 7370 6174 6961 6c69 7465 5f72 6566   |spatialite_ref
+00011360: 6572 656e 6365 5f6c 696e 6b7c 2066 756e  erence_link| fun
+00011370: 6374 696f 6e73 2063 616e 2062 6520 7573  ctions can be us
+00011380: 6564 2e20 4966 0a20 2020 2020 2020 2020  ed. If.         
+00011390: 2020 2077 6865 7265 2063 6f6e 7461 696e     where contain
+000113a0: 7320 7468 6520 7b67 656f 6d65 7472 7963  s the {geometryc
+000113b0: 6f6c 756d 6e7d 2070 6c61 6365 686f 6c64  olumn} placehold
+000113c0: 6572 2c20 6974 2069 7320 6669 6c6c 6564  er, it is filled
+000113d0: 206f 7574 2077 6974 6820 7468 650a 2020   out with the.  
+000113e0: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
+000113f0: 7279 2063 6f6c 756d 6e20 6e61 6d65 206f  ry column name o
+00011400: 6620 7468 6520 7372 6320 6669 6c65 2e20  f the src file. 
+00011410: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
+00011420: 2e0a 2020 2020 2020 2020 7265 7072 6f6a  ..        reproj
+00011430: 6563 7420 2862 6f6f 6c2c 206f 7074 696f  ect (bool, optio
+00011440: 6e61 6c29 3a20 5472 7565 2074 6f20 7265  nal): True to re
+00011450: 7072 6f6a 6563 7420 7768 696c 6520 636f  project while co
+00011460: 6e76 6572 7469 6e67 2074 6865 0a20 2020  nverting the.   
+00011470: 2020 2020 2020 2020 2066 696c 652e 2044           file. D
+00011480: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
+00011490: 2e0a 2020 2020 2020 2020 6578 706c 6f64  ..        explod
+000114a0: 6563 6f6c 6c65 6374 696f 6e73 2028 626f  ecollections (bo
+000114b0: 6f6c 292c 206f 7074 696f 6e61 6c29 3a20  ol), optional): 
+000114c0: 5472 7565 2074 6f20 6f75 7470 7574 206f  True to output o
+000114d0: 6e6c 7920 7369 6d70 6c65 2067 656f 6d65  nly simple geome
+000114e0: 7472 6965 732e 0a20 2020 2020 2020 2020  tries..         
+000114f0: 2020 2044 6566 6175 6c74 7320 746f 2046     Defaults to F
+00011500: 616c 7365 2e0a 2020 2020 2020 2020 666f  alse..        fo
+00011510: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00011520: 7472 7974 7970 6520 2855 6e69 6f6e 5b47  trytype (Union[G
+00011530: 656f 6d65 7472 7954 7970 652c 2073 7472  eometryType, str
+00011540: 5d2c 206f 7074 696f 6e61 6c29 3a20 4765  ], optional): Ge
+00011550: 6f6d 6574 7279 2074 7970 652e 0a20 2020  ometry type..   
+00011560: 2020 2020 2020 2020 2074 6f20 2874 7279           to (try
+00011570: 2074 6f29 2066 6f72 6365 2074 6865 206f   to) force the o
+00011580: 7574 7075 7420 746f 2e20 4465 6661 756c  utput to. Defaul
+00011590: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
+000115a0: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
+000115b0: 616c 5f69 6e64 6578 2028 626f 6f6c 2c20  al_index (bool, 
+000115c0: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
+000115d0: 746f 2063 7265 6174 6520 6120 7370 6174  to create a spat
+000115e0: 6961 6c20 696e 6465 780a 2020 2020 2020  ial index.      
+000115f0: 2020 2020 2020 6f6e 2074 6865 2064 6573        on the des
+00011600: 7469 6e61 7469 6f6e 2066 696c 652f 6c61  tination file/la
+00011610: 7965 722e 2049 6620 4e6f 6e65 2c20 7468  yer. If None, th
+00011620: 6520 6465 6661 756c 7420 6265 6861 7669  e default behavi
+00011630: 6f75 7220 6279 2067 6461 6c20 666f 720a  our by gdal for.
+00011640: 2020 2020 2020 2020 2020 2020 7468 6174              that
+00011650: 2066 696c 6520 7479 7065 2069 7320 7265   file type is re
+00011660: 7370 6563 7465 642e 2049 6620 7468 6520  spected. If the 
+00011670: 4c41 5945 525f 4352 4541 5449 4f4e 2e53  LAYER_CREATION.S
+00011680: 5041 5449 414c 5f49 4e44 4558 0a20 2020  PATIAL_INDEX.   
+00011690: 2020 2020 2020 2020 2070 6172 616d 6574           paramet
+000116a0: 6572 2069 7320 7370 6563 6966 6965 6420  er is specified 
+000116b0: 696e 206f 7074 696f 6e73 2c20 6372 6561  in options, crea
+000116c0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+000116d0: 2069 7320 6967 6e6f 7265 642e 0a20 2020   is ignored..   
+000116e0: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
+000116f0: 7320 746f 2054 7275 652e 0a20 2020 2020  s to True..     
+00011700: 2020 2061 7070 656e 645f 7469 6d65 6f75     append_timeou
+00011710: 745f 7320 2869 6e74 2c20 6f70 7469 6f6e  t_s (int, option
+00011720: 616c 293a 2074 696d 656f 7574 2074 6f20  al): timeout to 
+00011730: 7573 6520 6966 2074 6865 206f 7574 7075  use if the outpu
+00011740: 7420 6669 6c65 2069 730a 2020 2020 2020  t file is.      
+00011750: 2020 2020 2020 6265 696e 6720 7772 6974        being writ
+00011760: 7465 6e20 746f 2062 7920 616e 6f74 6865  ten to by anothe
+00011770: 7220 7072 6f63 6573 7320 616c 7265 6164  r process alread
+00011780: 792e 2044 6566 6175 6c74 7320 746f 2036  y. Defaults to 6
+00011790: 3030 2e0a 2020 2020 2020 2020 7472 616e  00..        tran
+000117a0: 7361 6374 696f 6e5f 7369 7a65 2028 696e  saction_size (in
+000117b0: 742c 206f 7074 696f 6e61 6c29 3a20 5472  t, optional): Tr
+000117c0: 616e 7361 6374 696f 6e20 7369 7a65 2e20  ansaction size. 
+000117d0: 4465 6661 756c 7473 2074 6f20 3530 3030  Defaults to 5000
+000117e0: 302e 0a20 2020 2020 2020 2070 7265 7365  0..        prese
+000117f0: 7276 655f 6669 6420 2862 6f6f 6c2c 206f  rve_fid (bool, o
+00011800: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
+00011810: 6f20 6d61 6b65 2061 6e20 6578 7472 6120  o make an extra 
+00011820: 6566 666f 7274 2074 6f20 7072 6573 6572  effort to preser
+00011830: 7665 2066 6964 2773 206f 660a 2020 2020  ve fid's of.    
+00011840: 2020 2020 2020 2020 7468 6520 736f 7572          the sour
+00011850: 6365 206c 6179 6572 2074 6f20 7468 6520  ce layer to the 
+00011860: 6465 7374 696e 6174 696f 6e20 6c61 7965  destination laye
+00011870: 722e 2046 616c 7365 206e 6f74 2074 6f20  r. False not to 
+00011880: 646f 2061 6e79 2065 6666 6f72 742e 204e  do any effort. N
+00011890: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000118a0: 746f 2075 7365 2074 6865 2064 6566 6175  to use the defau
+000118b0: 6c74 2062 6568 6176 696f 7572 206f 6620  lt behaviour of 
+000118c0: 6764 616c 2c20 7468 6174 2061 6c72 6561  gdal, that alrea
+000118d0: 6479 2070 7265 7365 7276 6573 2069 6e20  dy preserves in 
+000118e0: 736f 6d65 2063 6173 6573 2e0a 2020 2020  some cases..    
+000118f0: 2020 2020 2020 2020 536f 6d65 2066 696c          Some fil
+00011900: 6520 666f 726d 6174 7320 646f 6e27 7420  e formats don't 
+00011910: 6578 706c 6963 6974 6c79 2073 746f 7265  explicitly store
+00011920: 2074 6865 2066 6964 2028 652e 672e 2073   the fid (e.g. s
+00011930: 6861 7065 6669 6c65 292c 2073 6f20 7468  hapefile), so th
+00011940: 6579 0a20 2020 2020 2020 2020 2020 2077  ey.            w
+00011950: 696c 6c20 6e65 7665 7220 6265 2061 626c  ill never be abl
+00011960: 6520 746f 2070 7265 7365 7276 6520 6669  e to preserve fi
+00011970: 6473 2e20 4465 6661 756c 7473 2074 6f20  ds. Defaults to 
+00011980: 4e6f 6e65 2e0a 2020 2020 2020 2020 6f70  None..        op
+00011990: 7469 6f6e 7320 2864 6963 742c 206f 7074  tions (dict, opt
+000119a0: 696f 6e61 6c29 3a20 6f70 7469 6f6e 7320  ional): options 
+000119b0: 746f 2070 6173 7320 746f 2067 6461 6c2e  to pass to gdal.
+000119c0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+000119d0: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
+000119e0: 3a20 616e 2069 6e76 616c 6964 2070 6172  : an invalid par
+000119f0: 616d 6574 6572 2076 616c 7565 2077 6173  ameter value was
+00011a00: 2070 6173 7365 642e 0a20 2020 2020 2020   passed..       
+00011a10: 2052 756e 7469 6d65 4572 726f 723a 2074   RuntimeError: t
+00011a20: 696d 656f 7574 2077 6173 2072 6561 6368  imeout was reach
+00011a30: 6564 2077 6869 6c65 2074 7279 696e 6720  ed while trying 
+00011a40: 746f 2061 7070 656e 6420 6461 7461 2074  to append data t
+00011a50: 6f20 7061 7468 2e0a 0a20 2020 202e 2e20  o path...    .. 
+00011a60: 7c73 7061 7469 616c 6974 655f 7265 6665  |spatialite_refe
+00011a70: 7265 6e63 655f 6c69 6e6b 7c20 7261 773a  rence_link| raw:
+00011a80: 3a20 6874 6d6c 0a0a 2020 2020 2020 2020  : html..        
+00011a90: 3c61 2068 7265 663d 2268 7474 7073 3a2f  <a href="https:/
+00011aa0: 2f77 7777 2e67 6169 612d 6769 732e 6974  /www.gaia-gis.it
+00011ab0: 2f67 6169 612d 7369 6e73 2f73 7061 7469  /gaia-sins/spati
+00011ac0: 616c 6974 652d 7371 6c2d 6c61 7465 7374  alite-sql-latest
+00011ad0: 2e68 746d 6c22 2074 6172 6765 743d 225f  .html" target="_
+00011ae0: 626c 616e 6b22 3e73 7061 7469 616c 6974  blank">spatialit
+00011af0: 6520 7265 6665 7265 6e63 653c 2f61 3e0a  e reference</a>.
+00011b00: 0a20 2020 2022 2222 2020 2320 6e6f 7161  .    """  # noqa
+00011b10: 3a20 4535 3031 0a20 2020 2023 2043 6865  : E501.    # Che
+00011b20: 636b 2f63 6c65 616e 2069 6e70 7574 2070  ck/clean input p
+00011b30: 6172 616d 730a 2020 2020 7372 6320 3d20  arams.    src = 
+00011b40: 5061 7468 2873 7263 290a 2020 2020 6473  Path(src).    ds
+00011b50: 7420 3d20 5061 7468 2864 7374 290a 2020  t = Path(dst).  
+00011b60: 2020 6966 2066 6f72 6365 5f6f 7574 7075    if force_outpu
+00011b70: 745f 6765 6f6d 6574 7279 7479 7065 2069  t_geometrytype i
+00011b80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00011b90: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+00011ba0: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
+00011bb0: 4765 6f6d 6574 7279 5479 7065 2866 6f72  GeometryType(for
+00011bc0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+00011bd0: 7279 7479 7065 290a 0a20 2020 2023 2046  rytype)..    # F
+00011be0: 696c 6573 2064 6f6e 2774 2074 7970 6963  iles don't typic
+00011bf0: 616c 6c79 2073 7570 706f 7274 2068 6176  ally support hav
+00011c00: 696e 6720 6d75 6c74 6970 6c65 2070 726f  ing multiple pro
+00011c10: 6365 7373 6573 2077 7269 7469 6e67 0a20  cesses writing. 
+00011c20: 2020 2023 2073 696d 756c 7461 6e6f 7573     # simultanous
+00011c30: 6c79 2074 6f20 7468 656d 2c20 736f 2075  ly to them, so u
+00011c40: 7365 206c 6f63 6b20 6669 6c65 2074 6f20  se lock file to 
+00011c50: 7379 6e63 6872 6f6e 697a 6520 6163 6365  synchronize acce
+00011c60: 7373 2e0a 2020 2020 6c6f 636b 6669 6c65  ss..    lockfile
+00011c70: 203d 2050 6174 6828 6622 7b73 7472 2864   = Path(f"{str(d
+00011c80: 7374 297d 2e6c 6f63 6b22 290a 0a20 2020  st)}.lock")..   
+00011c90: 2023 2049 6620 7468 6520 6465 7374 696e   # If the destin
+00011ca0: 6174 696f 6e20 6669 6c65 2064 6f65 736e  ation file doesn
+00011cb0: 2774 2065 7869 7374 2079 6574 2c20 6275  't exist yet, bu
+00011cc0: 7420 7468 6520 6c6f 636b 6669 6c65 2064  t the lockfile d
+00011cd0: 6f65 732c 0a20 2020 2023 2074 7279 2072  oes,.    # try r
+00011ce0: 656d 6f76 696e 6720 7468 6520 6c6f 636b  emoving the lock
+00011cf0: 6669 6c65 2061 7320 6974 206d 6967 6874  file as it might
+00011d00: 2062 6520 6120 6768 6f73 7420 6c6f 636b   be a ghost lock
+00011d10: 6669 6c65 2e0a 2020 2020 6966 206e 6f74  file..    if not
+00011d20: 2064 7374 2e65 7869 7374 7328 2920 616e   dst.exists() an
+00011d30: 6420 6c6f 636b 6669 6c65 2e65 7869 7374  d lockfile.exist
+00011d40: 7328 293a 0a20 2020 2020 2020 2074 7279  s():.        try
+00011d50: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00011d60: 636b 6669 6c65 2e75 6e6c 696e 6b28 290a  ckfile.unlink().
+00011d70: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00011d80: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00011d90: 2020 2020 2020 5f20 3d20 4e6f 6e65 0a0a        _ = None..
+00011da0: 2020 2020 2320 4372 6561 7469 6e67 206c      # Creating l
+00011db0: 6f63 6b66 696c 6520 616e 6420 6170 7065  ockfile and appe
+00011dc0: 6e64 0a20 2020 2073 7461 7274 5f74 696d  nd.    start_tim
+00011dd0: 6520 3d20 6461 7465 7469 6d65 2e64 6174  e = datetime.dat
+00011de0: 6574 696d 652e 6e6f 7728 290a 2020 2020  etime.now().    
+00011df0: 7265 6164 7920 3d20 4661 6c73 650a 2020  ready = False.  
+00011e00: 2020 7768 696c 6520 6e6f 7420 7265 6164    while not read
+00011e10: 793a 0a20 2020 2020 2020 2069 6620 5f69  y:.        if _i
+00011e20: 6f5f 7574 696c 2e63 7265 6174 655f 6669  o_util.create_fi
+00011e30: 6c65 5f61 746f 6d69 6328 6c6f 636b 6669  le_atomic(lockfi
+00011e40: 6c65 2920 6973 2054 7275 653a 0a20 2020  le) is True:.   
+00011e50: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00011e60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00011e70: 6170 7065 6e64 0a20 2020 2020 2020 2020  append.         
+00011e80: 2020 2020 2020 205f 6170 7065 6e64 5f74         _append_t
+00011e90: 6f5f 6e6f 6c6f 636b 280a 2020 2020 2020  o_nolock(.      
+00011ea0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00011eb0: 633d 7372 632c 0a20 2020 2020 2020 2020  c=src,.         
+00011ec0: 2020 2020 2020 2020 2020 2064 7374 3d64             dst=d
+00011ed0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00011ee0: 2020 2020 2020 2020 7372 635f 6c61 7965          src_laye
+00011ef0: 723d 7372 635f 6c61 7965 722c 0a20 2020  r=src_layer,.   
+00011f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f10: 2064 7374 5f6c 6179 6572 3d64 7374 5f6c   dst_layer=dst_l
+00011f20: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
+00011f30: 2020 2020 2020 2020 2020 7372 635f 6372            src_cr
+00011f40: 733d 7372 635f 6372 732c 0a20 2020 2020  s=src_crs,.     
+00011f50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011f60: 7374 5f63 7273 3d64 7374 5f63 7273 2c0a  st_crs=dst_crs,.
+00011f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f80: 2020 2020 7768 6572 653d 7768 6572 652c      where=where,
+00011f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011fa0: 2020 2020 2072 6570 726f 6a65 6374 3d72       reproject=r
+00011fb0: 6570 726f 6a65 6374 2c0a 2020 2020 2020  eproject,.      
+00011fc0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00011fd0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+00011fe0: 3d65 7870 6c6f 6465 636f 6c6c 6563 7469  =explodecollecti
+00011ff0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00012000: 2020 2020 2020 2020 2066 6f72 6365 5f6f           force_o
+00012010: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00012020: 7065 3d66 6f72 6365 5f6f 7574 7075 745f  pe=force_output_
+00012030: 6765 6f6d 6574 7279 7479 7065 2c0a 2020  geometrytype,.  
+00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012050: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+00012060: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
+00012070: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
+00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012090: 2074 7261 6e73 6163 7469 6f6e 5f73 697a   transaction_siz
+000120a0: 653d 7472 616e 7361 6374 696f 6e5f 7369  e=transaction_si
+000120b0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+000120c0: 2020 2020 2020 2020 7072 6573 6572 7665          preserve
+000120d0: 5f66 6964 3d70 7265 7365 7276 655f 6669  _fid=preserve_fi
+000120e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000120f0: 2020 2020 2020 206f 7074 696f 6e73 3d6f         options=o
+00012100: 7074 696f 6e73 2c0a 2020 2020 2020 2020  ptions,.        
+00012110: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00012120: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+00012130: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012140: 6561 6479 203d 2054 7275 650a 2020 2020  eady = True.    
+00012150: 2020 2020 2020 2020 2020 2020 6c6f 636b              lock
+00012160: 6669 6c65 2e75 6e6c 696e 6b28 290a 2020  file.unlink().  
+00012170: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012180: 2020 2020 2020 2020 7469 6d65 5f77 6169          time_wai
+00012190: 7469 6e67 203d 2028 6461 7465 7469 6d65  ting = (datetime
+000121a0: 2e64 6174 6574 696d 652e 6e6f 7728 2920  .datetime.now() 
+000121b0: 2d20 7374 6172 745f 7469 6d65 292e 746f  - start_time).to
+000121c0: 7461 6c5f 7365 636f 6e64 7328 290a 2020  tal_seconds().  
+000121d0: 2020 2020 2020 2020 2020 6966 2074 696d            if tim
+000121e0: 655f 7761 6974 696e 6720 3e20 6170 7065  e_waiting > appe
+000121f0: 6e64 5f74 696d 656f 7574 5f73 3a0a 2020  nd_timeout_s:.  
+00012200: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00012210: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+00012220: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012230: 2020 2020 2020 6622 6170 7065 6e64 5f74        f"append_t
+00012240: 6f20 7469 6d65 6f75 7420 6f66 207b 6170  o timeout of {ap
+00012250: 7065 6e64 5f74 696d 656f 7574 5f73 7d20  pend_timeout_s} 
+00012260: 7265 6163 6865 642c 2073 6f20 7374 6f70  reached, so stop
+00012270: 2077 7269 7465 2022 0a20 2020 2020 2020   write ".       
+00012280: 2020 2020 2020 2020 2020 2020 2066 2274               f"t
+00012290: 6f20 7b64 7374 7d21 220a 2020 2020 2020  o {dst}!".      
+000122a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000122b0: 2020 2020 2023 2053 6c65 6570 2066 6f72       # Sleep for
+000122c0: 2061 2073 6563 6f6e 6420 6265 666f 7265   a second before
+000122d0: 2074 7279 696e 6720 6167 6169 6e0a 2020   trying again.  
+000122e0: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
+000122f0: 2831 290a 0a0a 6465 6620 5f61 7070 656e  (1)...def _appen
+00012300: 645f 746f 5f6e 6f6c 6f63 6b28 0a20 2020  d_to_nolock(.   
+00012310: 2073 7263 3a20 5061 7468 2c0a 2020 2020   src: Path,.    
+00012320: 6473 743a 2050 6174 682c 0a20 2020 2073  dst: Path,.    s
+00012330: 7263 5f6c 6179 6572 3a20 4f70 7469 6f6e  rc_layer: Option
+00012340: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00012350: 2020 2020 6473 745f 6c61 7965 723a 204f      dst_layer: O
+00012360: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00012370: 6f6e 652c 0a20 2020 2073 7263 5f63 7273  one,.    src_crs
+00012380: 3a20 556e 696f 6e5b 696e 742c 2073 7472  : Union[int, str
+00012390: 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65 2c0a  , None] = None,.
+000123a0: 2020 2020 6473 745f 6372 733a 2055 6e69      dst_crs: Uni
+000123b0: 6f6e 5b69 6e74 2c20 7374 722c 204e 6f6e  on[int, str, Non
+000123c0: 655d 203d 204e 6f6e 652c 0a20 2020 2077  e] = None,.    w
+000123d0: 6865 7265 3a20 4f70 7469 6f6e 616c 5b73  here: Optional[s
+000123e0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+000123f0: 7265 7072 6f6a 6563 743a 2062 6f6f 6c20  reproject: bool 
+00012400: 3d20 4661 6c73 652c 0a20 2020 2065 7870  = False,.    exp
+00012410: 6c6f 6465 636f 6c6c 6563 7469 6f6e 733a  lodecollections:
+00012420: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00012430: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
+00012440: 6c5f 696e 6465 783a 204f 7074 696f 6e61  l_index: Optiona
+00012450: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
+00012460: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+00012470: 5f67 656f 6d65 7472 7974 7970 653a 2055  _geometrytype: U
+00012480: 6e69 6f6e 5b47 656f 6d65 7472 7954 7970  nion[GeometryTyp
+00012490: 652c 2073 7472 2c20 4e6f 6e65 5d20 3d20  e, str, None] = 
+000124a0: 4e6f 6e65 2c0a 2020 2020 7472 616e 7361  None,.    transa
+000124b0: 6374 696f 6e5f 7369 7a65 3a20 696e 7420  ction_size: int 
+000124c0: 3d20 3530 3030 302c 0a20 2020 2070 7265  = 50000,.    pre
+000124d0: 7365 7276 655f 6669 643a 204f 7074 696f  serve_fid: Optio
+000124e0: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+000124f0: 2c0a 2020 2020 6f70 7469 6f6e 733a 2064  ,.    options: d
+00012500: 6963 7420 3d20 7b7d 2c0a 293a 0a20 2020  ict = {},.):.   
+00012510: 2023 2043 6865 636b 2f63 6c65 616e 2069   # Check/clean i
+00012520: 6e70 7574 2070 6172 616d 730a 2020 2020  nput params.    
+00012530: 6f70 7469 6f6e 7320 3d20 5f6f 6772 5f75  options = _ogr_u
+00012540: 7469 6c2e 5f70 7265 7061 7265 5f67 6461  til._prepare_gda
+00012550: 6c5f 6f70 7469 6f6e 7328 6f70 7469 6f6e  l_options(option
+00012560: 7329 0a20 2020 2069 6620 280a 2020 2020  s).    if (.    
+00012570: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
+00012580: 616c 5f69 6e64 6578 2069 7320 6e6f 7420  al_index is not 
+00012590: 4e6f 6e65 0a20 2020 2020 2020 2061 6e64  None.        and
+000125a0: 2022 4c41 5945 525f 4352 4541 5449 4f4e   "LAYER_CREATION
+000125b0: 2e53 5041 5449 414c 5f49 4e44 4558 2220  .SPATIAL_INDEX" 
+000125c0: 6e6f 7420 696e 206f 7074 696f 6e73 0a20  not in options. 
+000125d0: 2020 2029 3a0a 2020 2020 2020 2020 6f70     ):.        op
+000125e0: 7469 6f6e 735b 224c 4159 4552 5f43 5245  tions["LAYER_CRE
+000125f0: 4154 494f 4e2e 5350 4154 4941 4c5f 494e  ATION.SPATIAL_IN
+00012600: 4445 5822 5d20 3d20 6372 6561 7465 5f73  DEX"] = create_s
+00012610: 7061 7469 616c 5f69 6e64 6578 0a0a 2020  patial_index..  
+00012620: 2020 7372 635f 6c61 7965 7269 6e66 6f20    src_layerinfo 
+00012630: 3d20 4e6f 6e65 0a20 2020 2069 6620 7768  = None.    if wh
+00012640: 6572 6520 6973 206e 6f74 204e 6f6e 653a  ere is not None:
+00012650: 0a20 2020 2020 2020 2069 6620 7372 635f  .        if src_
+00012660: 6c61 7965 7269 6e66 6f20 6973 204e 6f6e  layerinfo is Non
+00012670: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00012680: 7263 5f6c 6179 6572 696e 666f 203d 2067  rc_layerinfo = g
+00012690: 6574 5f6c 6179 6572 696e 666f 2873 7263  et_layerinfo(src
+000126a0: 2c20 7372 635f 6c61 7965 7229 0a20 2020  , src_layer).   
+000126b0: 2020 2020 2077 6865 7265 203d 2077 6865       where = whe
+000126c0: 7265 2e66 6f72 6d61 7428 6765 6f6d 6574  re.format(geomet
+000126d0: 7279 636f 6c75 6d6e 3d73 7263 5f6c 6179  rycolumn=src_lay
+000126e0: 6572 696e 666f 2e67 656f 6d65 7472 7963  erinfo.geometryc
+000126f0: 6f6c 756d 6e29 0a0a 2020 2020 2320 5768  olumn)..    # Wh
+00012700: 656e 2063 7265 6174 696e 672f 6170 7065  en creating/appe
+00012710: 6e64 696e 6720 746f 2061 2073 6861 7065  nding to a shape
+00012720: 6669 6c65 2c20 736f 6d65 2065 7874 7261  file, some extra
+00012730: 2074 6869 6e67 7320 6e65 6564 2074 6f20   things need to 
+00012740: 6265 2064 6f6e 652f 6368 6563 6b65 642e  be done/checked.
+00012750: 0a20 2020 2073 716c 5f73 746d 7420 3d20  .    sql_stmt = 
+00012760: 4e6f 6e65 0a20 2020 2069 6620 6473 742e  None.    if dst.
+00012770: 7375 6666 6978 2e6c 6f77 6572 2829 203d  suffix.lower() =
+00012780: 3d20 222e 7368 7022 3a0a 2020 2020 2020  = ".shp":.      
+00012790: 2020 2320 4966 2074 6865 2064 6573 7469    # If the desti
+000127a0: 6e61 7469 6f6e 2066 696c 6520 646f 6573  nation file does
+000127b0: 6e27 7420 6578 6973 7420 7965 742c 2061  n't exist yet, a
+000127c0: 6e64 2074 6865 2073 6f75 7263 6520 6669  nd the source fi
+000127d0: 6c65 2068 6173 0a20 2020 2020 2020 2023  le has.        #
+000127e0: 2067 656f 6d65 7472 7974 7970 6520 2247   geometrytype "G
+000127f0: 656f 6d65 7472 7922 2c20 7261 6973 6520  eometry", raise 
+00012800: 6265 6361 7573 6520 7479 7065 2069 7320  because type is 
+00012810: 6e6f 7420 7375 7070 6f72 7465 6420 6279  not supported by
+00012820: 2073 6870 2028 616e 6420 7769 6c6c 0a20   shp (and will. 
+00012830: 2020 2020 2020 2023 2064 6566 6175 6c74         # default
+00012840: 2074 6f20 6c69 6e65 7374 7269 6e67 292e   to linestring).
+00012850: 0a20 2020 2020 2020 2069 6620 7372 635f  .        if src_
+00012860: 6c61 7965 7269 6e66 6f20 6973 204e 6f6e  layerinfo is Non
+00012870: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00012880: 7263 5f6c 6179 6572 696e 666f 203d 2067  rc_layerinfo = g
+00012890: 6574 5f6c 6179 6572 696e 666f 2873 7263  et_layerinfo(src
+000128a0: 2c20 7372 635f 6c61 7965 7229 0a20 2020  , src_layer).   
+000128b0: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
+000128c0: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+000128d0: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+000128e0: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
+000128f0: 2020 2020 616e 6420 7372 635f 6c61 7965      and src_laye
+00012900: 7269 6e66 6f2e 6765 6f6d 6574 7279 7479  rinfo.geometryty
+00012910: 7065 0a20 2020 2020 2020 2020 2020 2069  pe.            i
+00012920: 6e20 5b47 656f 6d65 7472 7954 7970 652e  n [GeometryType.
+00012930: 4745 4f4d 4554 5259 2c20 4765 6f6d 6574  GEOMETRY, Geomet
+00012940: 7279 5479 7065 2e47 454f 4d45 5452 5943  ryType.GEOMETRYC
+00012950: 4f4c 4c45 4354 494f 4e5d 0a20 2020 2020  OLLECTION].     
+00012960: 2020 2020 2020 2061 6e64 206e 6f74 2064         and not d
+00012970: 7374 2e65 7869 7374 7328 290a 2020 2020  st.exists().    
+00012980: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00012990: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000129a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+000129b0: 2020 2020 2066 2273 7263 2066 696c 6520       f"src file 
+000129c0: 7b73 7263 7d20 6861 7320 6765 6f6d 6574  {src} has geomet
+000129d0: 7279 7479 7065 207b 7372 635f 6c61 7965  rytype {src_laye
+000129e0: 7269 6e66 6f2e 6765 6f6d 6574 7279 7479  rinfo.geometryty
+000129f0: 7065 6e61 6d65 7d20 220a 2020 2020 2020  pename} ".      
+00012a00: 2020 2020 2020 2020 2020 2277 6869 6368            "which
+00012a10: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00012a20: 6420 696e 202e 7368 702e 204d 6179 6265  d in .shp. Maybe
+00012a30: 2075 7365 2066 6f72 6365 5f6f 7574 7075   use force_outpu
+00012a40: 745f 6765 6f6d 6574 7279 7479 7065 3f22  t_geometrytype?"
+00012a50: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00012a60: 2020 2020 2020 2020 2320 4c61 756e 6465          # Launde
+00012a70: 7220 7468 6520 636f 6c75 6d6e 7320 6e61  r the columns na
+00012a80: 6d65 7320 7669 6120 6120 7371 6c20 7374  mes via a sql st
+00012a90: 6174 656d 656e 742c 206f 7468 6572 7769  atement, otherwi
+00012aa0: 7365 2077 6865 6e20 6170 7065 6e64 696e  se when appendin
+00012ab0: 6720 7468 650a 2020 2020 2020 2020 2320  g the.        # 
+00012ac0: 6c61 756e 6465 7265 6420 636f 6c75 6d6e  laundered column
+00012ad0: 7320 7769 6c6c 2067 6574 204e 554c 4c20  s will get NULL 
+00012ae0: 7661 6c75 6573 2069 6e73 7465 6164 206f  values instead o
+00012af0: 6620 7468 6520 6461 7461 2e0a 2020 2020  f the data..    
+00012b00: 2020 2020 7372 635f 636f 6c75 6d6e 7320      src_columns 
+00012b10: 3d20 7372 635f 6c61 7965 7269 6e66 6f2e  = src_layerinfo.
+00012b20: 636f 6c75 6d6e 730a 2020 2020 2020 2020  columns.        
+00012b30: 636f 6c75 6d6e 735f 6c61 756e 6465 7265  columns_laundere
+00012b40: 6420 3d20 5f6c 6175 6e64 6572 5f63 6f6c  d = _launder_col
+00012b50: 756d 6e5f 6e61 6d65 7328 7372 635f 636f  umn_names(src_co
+00012b60: 6c75 6d6e 7329 0a20 2020 2020 2020 2063  lumns).        c
+00012b70: 6f6c 756d 6e73 5f61 6c69 6173 6564 203d  olumns_aliased =
+00012b80: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00012b90: 2722 7b63 6f6c 756d 6e7d 2220 4153 2022  '"{column}" AS "
+00012ba0: 7b6c 6175 6e64 6572 6564 7d22 2720 666f  {laundered}"' fo
+00012bb0: 7220 636f 6c75 6d6e 2c20 6c61 756e 6465  r column, launde
+00012bc0: 7265 6420 696e 2063 6f6c 756d 6e73 5f6c  red in columns_l
+00012bd0: 6175 6e64 6572 6564 0a20 2020 2020 2020  aundered.       
+00012be0: 205d 0a20 2020 2020 2020 206c 6179 6572   ].        layer
+00012bf0: 203d 2073 7263 5f6c 6179 6572 2069 6620   = src_layer if 
+00012c00: 7372 635f 6c61 7965 7220 6973 206e 6f74  src_layer is not
+00012c10: 204e 6f6e 6520 656c 7365 2067 6574 5f6f   None else get_o
+00012c20: 6e6c 795f 6c61 7965 7228 7372 6329 0a20  nly_layer(src). 
+00012c30: 2020 2020 2020 2023 2049 6620 7468 6572         # If ther
+00012c40: 6520 6973 2061 2077 6865 7265 2073 7065  e is a where spe
+00012c50: 6369 6669 6564 2c20 696e 7465 6772 6174  cified, integrat
+00012c60: 6520 6974 2e2e 2e0a 2020 2020 2020 2020  e it....        
+00012c70: 7768 6572 655f 636c 6175 7365 203d 2022  where_clause = "
+00012c80: 220a 2020 2020 2020 2020 6966 2077 6865  ".        if whe
+00012c90: 7265 2069 7320 6e6f 7420 4e6f 6e65 3a0a  re is not None:.
+00012ca0: 2020 2020 2020 2020 2020 2020 7768 6572              wher
+00012cb0: 655f 636c 6175 7365 203d 2066 2257 4845  e_clause = f"WHE
+00012cc0: 5245 207b 7768 6572 657d 220a 2020 2020  RE {where}".    
+00012cd0: 2020 2020 2020 2020 7768 6572 6520 3d20          where = 
+00012ce0: 4e6f 6e65 0a20 2020 2020 2020 2073 716c  None.        sql
+00012cf0: 5f73 746d 7420 3d20 6622 2222 0a20 2020  _stmt = f""".   
+00012d00: 2020 2020 2020 2020 2053 454c 4543 5420           SELECT 
+00012d10: 7b73 7263 5f6c 6179 6572 696e 666f 2e67  {src_layerinfo.g
+00012d20: 656f 6d65 7472 7963 6f6c 756d 6e7d 0a20  eometrycolumn}. 
+00012d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d40: 202c 7b22 2c20 222e 6a6f 696e 2863 6f6c   ,{", ".join(col
+00012d50: 756d 6e73 5f61 6c69 6173 6564 297d 0a20  umns_aliased)}. 
+00012d60: 2020 2020 2020 2020 2020 2020 2046 524f               FRO
+00012d70: 4d20 227b 6c61 7965 727d 220a 2020 2020  M "{layer}".    
+00012d80: 2020 2020 2020 2020 207b 7768 6572 655f           {where_
+00012d90: 636c 6175 7365 7d0a 2020 2020 2020 2020  clause}.        
+00012da0: 2222 220a 0a20 2020 2023 2057 6865 6e20  """..    # When 
+00012db0: 6473 7420 6669 6c65 2064 6f65 736e 2774  dst file doesn't
+00012dc0: 2065 7869 7374 2061 6e64 2073 7263 2069   exist and src i
+00012dd0: 7320 656d 7074 7920 666f 7263 655f 6f75  s empty force_ou
+00012de0: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+00012df0: 6520 7368 6f75 6c64 2062 650a 2020 2020  e should be.    
+00012e00: 2320 7370 6563 6966 6965 642c 206f 7468  # specified, oth
+00012e10: 6572 7769 7365 2069 6e76 616c 6964 206f  erwise invalid o
+00012e20: 7574 7075 742e 0a20 2020 2069 6620 666f  utput..    if fo
+00012e30: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00012e40: 7472 7974 7970 6520 6973 204e 6f6e 6520  trytype is None 
+00012e50: 616e 6420 6e6f 7420 6473 742e 6578 6973  and not dst.exis
+00012e60: 7473 2829 3a0a 2020 2020 2020 2020 6966  ts():.        if
+00012e70: 2073 7263 5f6c 6179 6572 696e 666f 2069   src_layerinfo i
+00012e80: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00012e90: 2020 2020 7372 635f 6c61 7965 7269 6e66      src_layerinf
+00012ea0: 6f20 3d20 6765 745f 6c61 7965 7269 6e66  o = get_layerinf
+00012eb0: 6f28 7372 632c 2073 7263 5f6c 6179 6572  o(src, src_layer
+00012ec0: 290a 2020 2020 2020 2020 666f 7263 655f  ).        force_
+00012ed0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00012ee0: 7970 6520 3d20 7372 635f 6c61 7965 7269  ype = src_layeri
+00012ef0: 6e66 6f2e 6765 6f6d 6574 7279 7479 7065  nfo.geometrytype
+00012f00: 0a0a 2020 2020 2320 476f 210a 2020 2020  ..    # Go!.    
+00012f10: 7472 616e 736c 6174 655f 696e 666f 203d  translate_info =
+00012f20: 205f 6f67 725f 7574 696c 2e56 6563 746f   _ogr_util.Vecto
+00012f30: 7254 7261 6e73 6c61 7465 496e 666f 280a  rTranslateInfo(.
+00012f40: 2020 2020 2020 2020 696e 7075 745f 7061          input_pa
+00012f50: 7468 3d73 7263 2c0a 2020 2020 2020 2020  th=src,.        
+00012f60: 6f75 7470 7574 5f70 6174 683d 6473 742c  output_path=dst,
+00012f70: 0a20 2020 2020 2020 2069 6e70 7574 5f6c  .        input_l
+00012f80: 6179 6572 733d 7372 635f 6c61 7965 722c  ayers=src_layer,
+00012f90: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00012fa0: 6c61 7965 723d 6473 745f 6c61 7965 722c  layer=dst_layer,
+00012fb0: 0a20 2020 2020 2020 2069 6e70 7574 5f73  .        input_s
+00012fc0: 7273 3d73 7263 5f63 7273 2c0a 2020 2020  rs=src_crs,.    
+00012fd0: 2020 2020 6f75 7470 7574 5f73 7273 3d64      output_srs=d
+00012fe0: 7374 5f63 7273 2c0a 2020 2020 2020 2020  st_crs,.        
+00012ff0: 7371 6c5f 7374 6d74 3d73 716c 5f73 746d  sql_stmt=sql_stm
+00013000: 742c 0a20 2020 2020 2020 2073 716c 5f64  t,.        sql_d
+00013010: 6961 6c65 6374 3d22 5351 4c49 5445 222c  ialect="SQLITE",
+00013020: 0a20 2020 2020 2020 2077 6865 7265 3d77  .        where=w
+00013030: 6865 7265 2c0a 2020 2020 2020 2020 7265  here,.        re
+00013040: 7072 6f6a 6563 743d 7265 7072 6f6a 6563  project=reprojec
+00013050: 742c 0a20 2020 2020 2020 2074 7261 6e73  t,.        trans
+00013060: 6163 7469 6f6e 5f73 697a 653d 7472 616e  action_size=tran
+00013070: 7361 6374 696f 6e5f 7369 7a65 2c0a 2020  saction_size,.  
+00013080: 2020 2020 2020 6170 7065 6e64 3d54 7275        append=Tru
+00013090: 652c 0a20 2020 2020 2020 2075 7064 6174  e,.        updat
+000130a0: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
+000130b0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+000130c0: 6e73 3d65 7870 6c6f 6465 636f 6c6c 6563  ns=explodecollec
+000130d0: 7469 6f6e 732c 0a20 2020 2020 2020 2066  tions,.        f
+000130e0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+000130f0: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
+00013100: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00013110: 7065 2c0a 2020 2020 2020 2020 6f70 7469  pe,.        opti
+00013120: 6f6e 733d 6f70 7469 6f6e 732c 0a20 2020  ons=options,.   
+00013130: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
+00013140: 643d 7072 6573 6572 7665 5f66 6964 2c0a  d=preserve_fid,.
+00013150: 2020 2020 290a 2020 2020 5f6f 6772 5f75      ).    _ogr_u
+00013160: 7469 6c2e 7665 6374 6f72 5f74 7261 6e73  til.vector_trans
+00013170: 6c61 7465 5f62 795f 696e 666f 2869 6e66  late_by_info(inf
+00013180: 6f3d 7472 616e 736c 6174 655f 696e 666f  o=translate_info
+00013190: 290a 0a0a 6465 6620 636f 6e76 6572 7428  )...def convert(
+000131a0: 0a20 2020 2073 7263 3a20 556e 696f 6e5b  .    src: Union[
+000131b0: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+000131c0: 655b 416e 795d 225d 2c0a 2020 2020 6473  e[Any]"],.    ds
+000131d0: 743a 2055 6e69 6f6e 5b73 7472 2c20 226f  t: Union[str, "o
+000131e0: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
+000131f0: 5d2c 0a20 2020 2073 7263 5f6c 6179 6572  ],.    src_layer
+00013200: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00013210: 3d20 4e6f 6e65 2c0a 2020 2020 6473 745f  = None,.    dst_
+00013220: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
+00013230: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00013240: 2073 7263 5f63 7273 3a20 556e 696f 6e5b   src_crs: Union[
+00013250: 7374 722c 2069 6e74 2c20 4e6f 6e65 5d20  str, int, None] 
+00013260: 3d20 4e6f 6e65 2c0a 2020 2020 6473 745f  = None,.    dst_
+00013270: 6372 733a 2055 6e69 6f6e 5b73 7472 2c20  crs: Union[str, 
+00013280: 696e 742c 204e 6f6e 655d 203d 204e 6f6e  int, None] = Non
+00013290: 652c 0a20 2020 2077 6865 7265 3a20 4f70  e,.    where: Op
+000132a0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+000132b0: 6e65 2c0a 2020 2020 7265 7072 6f6a 6563  ne,.    reprojec
+000132c0: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
+000132d0: 0a20 2020 2065 7870 6c6f 6465 636f 6c6c  .    explodecoll
+000132e0: 6563 7469 6f6e 733a 2062 6f6f 6c20 3d20  ections: bool = 
+000132f0: 4661 6c73 652c 0a20 2020 2066 6f72 6365  False,.    force
+00013300: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+00013310: 7479 7065 3a20 556e 696f 6e5b 4765 6f6d  type: Union[Geom
+00013320: 6574 7279 5479 7065 2c20 7374 722c 204e  etryType, str, N
+00013330: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
+00013340: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+00013350: 696e 6465 783a 204f 7074 696f 6e61 6c5b  index: Optional[
+00013360: 626f 6f6c 5d20 3d20 5472 7565 2c0a 2020  bool] = True,.  
+00013370: 2020 7072 6573 6572 7665 5f66 6964 3a20    preserve_fid: 
+00013380: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00013390: 204e 6f6e 652c 0a20 2020 206f 7074 696f   None,.    optio
+000133a0: 6e73 3a20 6469 6374 203d 207b 7d2c 0a20  ns: dict = {},. 
+000133b0: 2020 2061 7070 656e 643a 2062 6f6f 6c20     append: bool 
+000133c0: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
+000133d0: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
+000133e0: 2c0a 293a 0a20 2020 2022 2222 0a20 2020  ,.):.    """.   
+000133f0: 2044 4550 5245 4341 5445 443a 2070 6c65   DEPRECATED: ple
+00013400: 6173 6520 7573 6520 636f 7079 5f6c 6179  ase use copy_lay
+00013410: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+00013420: 7761 726e 696e 6773 2e77 6172 6e28 2263  warnings.warn("c
+00013430: 6f6e 7665 7274 2069 7320 6465 7072 6563  onvert is deprec
+00013440: 6174 6564 3a20 7573 6520 636f 7079 5f6c  ated: use copy_l
+00013450: 6179 6572 2e22 2c20 4675 7475 7265 5761  ayer.", FutureWa
+00013460: 726e 696e 6729 0a20 2020 2072 6574 7572  rning).    retur
+00013470: 6e20 636f 7079 5f6c 6179 6572 280a 2020  n copy_layer(.  
+00013480: 2020 2020 2020 7372 633d 7372 632c 0a20        src=src,. 
+00013490: 2020 2020 2020 2064 7374 3d64 7374 2c0a         dst=dst,.
+000134a0: 2020 2020 2020 2020 7372 635f 6c61 7965          src_laye
+000134b0: 723d 7372 635f 6c61 7965 722c 0a20 2020  r=src_layer,.   
+000134c0: 2020 2020 2064 7374 5f6c 6179 6572 3d64       dst_layer=d
+000134d0: 7374 5f6c 6179 6572 2c0a 2020 2020 2020  st_layer,.      
+000134e0: 2020 7372 635f 6372 733d 7372 635f 6372    src_crs=src_cr
+000134f0: 732c 0a20 2020 2020 2020 2064 7374 5f63  s,.        dst_c
+00013500: 7273 3d64 7374 5f63 7273 2c0a 2020 2020  rs=dst_crs,.    
+00013510: 2020 2020 7768 6572 653d 7768 6572 652c      where=where,
+00013520: 0a20 2020 2020 2020 2072 6570 726f 6a65  .        reproje
+00013530: 6374 3d72 6570 726f 6a65 6374 2c0a 2020  ct=reproject,.  
+00013540: 2020 2020 2020 6578 706c 6f64 6563 6f6c        explodecol
+00013550: 6c65 6374 696f 6e73 3d65 7870 6c6f 6465  lections=explode
+00013560: 636f 6c6c 6563 7469 6f6e 732c 0a20 2020  collections,.   
+00013570: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
+00013580: 745f 6765 6f6d 6574 7279 7479 7065 3d66  t_geometrytype=f
+00013590: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+000135a0: 6574 7279 7479 7065 2c0a 2020 2020 2020  etrytype,.      
+000135b0: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+000135c0: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
+000135d0: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
+000135e0: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
+000135f0: 643d 7072 6573 6572 7665 5f66 6964 2c0a  d=preserve_fid,.
+00013600: 2020 2020 2020 2020 6f70 7469 6f6e 733d          options=
+00013610: 6f70 7469 6f6e 732c 0a20 2020 2020 2020  options,.       
+00013620: 2061 7070 656e 643d 6170 7065 6e64 2c0a   append=append,.
+00013630: 2020 2020 2020 2020 666f 7263 653d 666f          force=fo
+00013640: 7263 652c 0a20 2020 2029 0a0a 0a64 6566  rce,.    )...def
+00013650: 2063 6f70 795f 6c61 7965 7228 0a20 2020   copy_layer(.   
+00013660: 2073 7263 3a20 556e 696f 6e5b 7374 722c   src: Union[str,
+00013670: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
+00013680: 795d 225d 2c0a 2020 2020 6473 743a 2055  y]"],.    dst: U
+00013690: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+000136a0: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
+000136b0: 2020 2073 7263 5f6c 6179 6572 3a20 4f70     src_layer: Op
+000136c0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+000136d0: 6e65 2c0a 2020 2020 6473 745f 6c61 7965  ne,.    dst_laye
+000136e0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+000136f0: 203d 204e 6f6e 652c 0a20 2020 2073 7263   = None,.    src
+00013700: 5f63 7273 3a20 556e 696f 6e5b 7374 722c  _crs: Union[str,
+00013710: 2069 6e74 2c20 4e6f 6e65 5d20 3d20 4e6f   int, None] = No
+00013720: 6e65 2c0a 2020 2020 6473 745f 6372 733a  ne,.    dst_crs:
+00013730: 2055 6e69 6f6e 5b73 7472 2c20 696e 742c   Union[str, int,
+00013740: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
+00013750: 2020 2077 6865 7265 3a20 4f70 7469 6f6e     where: Option
+00013760: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00013770: 2020 2020 7265 7072 6f6a 6563 743a 2062      reproject: b
+00013780: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00013790: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+000137a0: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
+000137b0: 652c 0a20 2020 2066 6f72 6365 5f6f 7574  e,.    force_out
+000137c0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+000137d0: 3a20 556e 696f 6e5b 4765 6f6d 6574 7279  : Union[Geometry
+000137e0: 5479 7065 2c20 7374 722c 204e 6f6e 655d  Type, str, None]
+000137f0: 203d 204e 6f6e 652c 0a20 2020 2063 7265   = None,.    cre
+00013800: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+00013810: 783a 204f 7074 696f 6e61 6c5b 626f 6f6c  x: Optional[bool
+00013820: 5d20 3d20 5472 7565 2c0a 2020 2020 7072  ] = True,.    pr
+00013830: 6573 6572 7665 5f66 6964 3a20 4f70 7469  eserve_fid: Opti
+00013840: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00013850: 652c 0a20 2020 206f 7074 696f 6e73 3a20  e,.    options: 
+00013860: 6469 6374 203d 207b 7d2c 0a20 2020 2061  dict = {},.    a
+00013870: 7070 656e 643a 2062 6f6f 6c20 3d20 4661  ppend: bool = Fa
+00013880: 6c73 652c 0a20 2020 2066 6f72 6365 3a20  lse,.    force: 
+00013890: 626f 6f6c 203d 2046 616c 7365 2c0a 293a  bool = False,.):
+000138a0: 0a20 2020 2022 2222 0a20 2020 2052 6561  .    """.    Rea
+000138b0: 6420 6120 6c61 7965 7220 6672 6f6d 2061  d a layer from a
+000138c0: 2073 6f75 7263 6520 6669 6c65 2061 6e64   source file and
+000138d0: 2077 7269 7465 2069 7420 746f 2061 206e   write it to a n
+000138e0: 6577 2064 6573 7469 6e61 7469 6f6e 2066  ew destination f
+000138f0: 696c 652e 0a0a 2020 2020 5479 7069 6361  ile...    Typica
+00013900: 6c6c 7920 7573 6564 2074 6f20 636f 6e76  lly used to conv
+00013910: 6572 7420 6672 6f6d 206f 6e65 2066 696c  ert from one fil
+00013920: 6566 6f72 6d61 7420 746f 2061 6e6f 7468  eformat to anoth
+00013930: 6572 206f 7220 746f 2072 6570 726f 6a65  er or to reproje
+00013940: 6374 2e0a 0a20 2020 2054 6865 206f 7074  ct...    The opt
+00013950: 696f 6e73 2070 6172 616d 6574 6572 2063  ions parameter c
+00013960: 616e 2062 6520 7573 6564 2074 6f20 7061  an be used to pa
+00013970: 7373 2061 6e79 2074 7970 6520 6f66 206f  ss any type of o
+00013980: 7074 696f 6e73 2074 6f20 4744 414c 2069  ptions to GDAL i
+00013990: 6e0a 2020 2020 7468 6520 666f 6c6c 6f77  n.    the follow
+000139a0: 696e 6720 666f 726d 3a0a 2020 2020 2020  ing form:.      
+000139b0: 2020 7b20 223c 6f70 7469 6f6e 5f74 7970    { "<option_typ
+000139c0: 653e 2e3c 6f70 7469 6f6e 5f6e 616d 653e  e>.<option_name>
+000139d0: 223a 203c 6f70 7469 6f6e 5f76 616c 7565  ": <option_value
+000139e0: 3e20 7d0a 0a20 2020 2054 6865 206f 7074  > }..    The opt
+000139f0: 696f 6e20 7479 7065 7320 6361 6e20 6265  ion types can be
+00013a00: 2061 6e79 206f 6620 7468 6520 666f 6c6c   any of the foll
+00013a10: 6f77 696e 673a 0a20 2020 2020 2020 202d  owing:.        -
+00013a20: 204c 4159 4552 5f43 5245 4154 494f 4e3a   LAYER_CREATION:
+00013a30: 206c 6179 6572 2063 7265 6174 696f 6e20   layer creation 
+00013a40: 6f70 7469 6f6e 2028 6c63 6f29 0a20 2020  option (lco).   
+00013a50: 2020 2020 202d 2044 4154 4153 4554 5f43       - DATASET_C
+00013a60: 5245 4154 494f 4e3a 2064 6174 6173 6574  REATION: dataset
+00013a70: 2063 7265 6174 696f 6e20 6f70 7469 6f6e   creation option
+00013a80: 2028 6473 636f 290a 2020 2020 2020 2020   (dsco).        
+00013a90: 2d20 494e 5055 545f 4f50 454e 3a20 696e  - INPUT_OPEN: in
+00013aa0: 7075 7420 6461 7461 7365 7420 6f70 656e  put dataset open
+00013ab0: 206f 7074 696f 6e20 286f 6f29 0a20 2020   option (oo).   
+00013ac0: 2020 2020 202d 2044 4553 5449 4e41 5449       - DESTINATI
+00013ad0: 4f4e 5f4f 5045 4e3a 2064 6573 7469 6e61  ON_OPEN: destina
+00013ae0: 7469 6f6e 2064 6174 6173 6574 206f 7065  tion dataset ope
+00013af0: 6e20 6f70 7469 6f6e 2028 646f 6f29 0a20  n option (doo). 
+00013b00: 2020 2020 2020 202d 2043 4f4e 4649 473a         - CONFIG:
+00013b10: 2063 6f6e 6669 6720 6f70 7469 6f6e 2028   config option (
+00013b20: 636f 6e66 6967 290a 0a20 2020 2054 6865  config)..    The
+00013b30: 206f 7074 696f 6e73 2063 616e 2062 6520   options can be 
+00013b40: 666f 756e 6420 696e 2074 6865 205b 4744  found in the [GD
+00013b50: 414c 2076 6563 746f 7220 6472 6976 6572  AL vector driver
+00013b60: 2064 6f63 756d 656e 7461 7469 6f6e 5d0a   documentation].
+00013b70: 2020 2020 2868 7474 7073 3a2f 2f67 6461      (https://gda
+00013b80: 6c2e 6f72 672f 6472 6976 6572 732f 7665  l.org/drivers/ve
+00013b90: 6374 6f72 2f69 6e64 6578 2e68 746d 6c29  ctor/index.html)
+00013ba0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00013bb0: 2020 2020 2073 7263 2028 5061 7468 4c69       src (PathLi
+00013bc0: 6b65 293a 2054 6865 2073 6f75 7263 6520  ke): The source 
+00013bd0: 6669 6c65 2070 6174 682e 0a20 2020 2020  file path..     
+00013be0: 2020 2064 7374 2028 5061 7468 4c69 6b65     dst (PathLike
+00013bf0: 293a 2054 6865 2064 6573 7469 6e61 7469  ): The destinati
+00013c00: 6f6e 2066 696c 6520 7061 7468 2e0a 2020  on file path..  
+00013c10: 2020 2020 2020 7372 635f 6c61 7965 7220        src_layer 
+00013c20: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
+00013c30: 2054 6865 2073 6f75 7263 6520 6c61 7965   The source laye
+00013c40: 722e 2049 6620 4e6f 6e65 2061 6e64 2074  r. If None and t
+00013c50: 6865 7265 2069 7320 6f6e 6c79 0a20 2020  here is only.   
+00013c60: 2020 2020 2020 2020 206f 6e65 206c 6179           one lay
+00013c70: 6572 2069 6e20 7468 6520 7372 6320 6669  er in the src fi
+00013c80: 6c65 2c20 7468 6174 206c 6179 6572 2069  le, that layer i
+00013c90: 7320 7461 6b65 6e2e 2044 6566 6175 6c74  s taken. Default
+00013ca0: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00013cb0: 2020 2064 7374 5f6c 6179 6572 2028 7374     dst_layer (st
+00013cc0: 722c 206f 7074 696f 6e61 6c29 3a20 5468  r, optional): Th
+00013cd0: 6520 6465 7374 696e 6174 696f 6e20 6c61  e destination la
+00013ce0: 7965 722e 2049 6620 4e6f 6e65 2c20 7468  yer. If None, th
+00013cf0: 6520 6669 6c65 0a20 2020 2020 2020 2020  e file.         
+00013d00: 2020 2073 7465 6d20 6973 2074 616b 656e     stem is taken
+00013d10: 2061 7320 6c61 7965 7220 6e61 6d65 2e20   as layer name. 
+00013d20: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
+00013d30: 2e0a 2020 2020 2020 2020 7372 635f 6372  ..        src_cr
+00013d40: 7320 2855 6e69 6f6e 5b73 7472 2c20 696e  s (Union[str, in
+00013d50: 745d 2c20 6f70 7469 6f6e 616c 293a 2061  t], optional): a
+00013d60: 6e20 6570 7367 2069 6e74 206f 7220 616e  n epsg int or an
+00013d70: 7974 6869 6e67 2073 7570 706f 7274 6564  ything supported
+00013d80: 0a20 2020 2020 2020 2020 2020 2062 7920  .            by 
+00013d90: 7468 6520 4f47 5253 7061 7469 616c 5265  the OGRSpatialRe
+00013da0: 6665 7265 6e63 652e 5365 7446 726f 6d55  ference.SetFromU
+00013db0: 7365 7249 6e70 7574 2829 2063 616c 6c2c  serInput() call,
+00013dc0: 2077 6869 6368 2069 6e63 6c75 6465 730a   which includes.
+00013dd0: 2020 2020 2020 2020 2020 2020 616e 2045              an E
+00013de0: 5053 4720 7374 7269 6e67 2028 6567 2e20  PSG string (eg. 
+00013df0: 2245 5053 473a 3433 3236 2229 2c20 6120  "EPSG:4326"), a 
+00013e00: 7765 6c6c 206b 6e6f 776e 2074 6578 7420  well known text 
+00013e10: 2857 4b54 2920 4352 530a 2020 2020 2020  (WKT) CRS.      
+00013e20: 2020 2020 2020 6465 6669 6e69 7469 6f6e        definition
+00013e30: 2c2e 2e2e 2044 6566 6175 6c74 7320 746f  ,... Defaults to
+00013e40: 204e 6f6e 652e 0a20 2020 2020 2020 2064   None..        d
+00013e50: 7374 5f63 7273 2028 556e 696f 6e5b 7374  st_crs (Union[st
+00013e60: 722c 2069 6e74 5d2c 206f 7074 696f 6e61  r, int], optiona
+00013e70: 6c29 3a20 616e 2065 7073 6720 696e 7420  l): an epsg int 
+00013e80: 6f72 2061 6e79 7468 696e 6720 7375 7070  or anything supp
+00013e90: 6f72 7465 640a 2020 2020 2020 2020 2020  orted.          
+00013ea0: 2020 6279 2074 6865 204f 4752 5370 6174    by the OGRSpat
+00013eb0: 6961 6c52 6566 6572 656e 6365 2e53 6574  ialReference.Set
+00013ec0: 4672 6f6d 5573 6572 496e 7075 7428 2920  FromUserInput() 
+00013ed0: 6361 6c6c 2c20 7768 6963 6820 696e 636c  call, which incl
+00013ee0: 7564 6573 0a20 2020 2020 2020 2020 2020  udes.           
+00013ef0: 2061 6e20 4550 5347 2073 7472 696e 6720   an EPSG string 
+00013f00: 2865 672e 2022 4550 5347 3a34 3332 3622  (eg. "EPSG:4326"
+00013f10: 292c 2061 2077 656c 6c20 6b6e 6f77 6e20  ), a well known 
+00013f20: 7465 7874 2028 574b 5429 2043 5253 0a20  text (WKT) CRS. 
+00013f30: 2020 2020 2020 2020 2020 2064 6566 696e             defin
+00013f40: 6974 696f 6e2c 2e2e 2e20 4465 6661 756c  ition,... Defaul
+00013f50: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
+00013f60: 2020 2020 7768 6572 6520 2873 7472 2c20      where (str, 
+00013f70: 6f70 7469 6f6e 616c 293a 206f 6e6c 7920  optional): only 
+00013f80: 6170 7065 6e64 2074 6865 2072 6f77 7320  append the rows 
+00013f90: 6672 6f6d 2073 7263 2074 6861 7420 636f  from src that co
+00013fa0: 6d70 6c79 2074 6f20 7468 6520 6669 6c74  mply to the filt
+00013fb0: 6572 0a20 2020 2020 2020 2020 2020 2073  er.            s
+00013fc0: 7065 6369 6669 6564 2e20 4170 706c 6965  pecified. Applie
+00013fd0: 6420 6265 666f 7265 2065 7870 6c6f 6465  d before explode
+00013fe0: 636f 6c6c 6563 7469 6f6e 732e 2046 696c  collections. Fil
+00013ff0: 7465 7220 7368 6f75 6c64 2062 6520 696e  ter should be in
+00014000: 2073 716c 6974 650a 2020 2020 2020 2020   sqlite.        
+00014010: 2020 2020 5351 4c20 5748 4552 4520 7379      SQL WHERE sy
+00014020: 6e74 6178 2061 6e64 207c 7370 6174 6961  ntax and |spatia
+00014030: 6c69 7465 5f72 6566 6572 656e 6365 5f6c  lite_reference_l
+00014040: 696e 6b7c 2066 756e 6374 696f 6e73 2063  ink| functions c
+00014050: 616e 2062 6520 7573 6564 2e20 4966 0a20  an be used. If. 
+00014060: 2020 2020 2020 2020 2020 2077 6865 7265             where
+00014070: 2063 6f6e 7461 696e 7320 7468 6520 7b67   contains the {g
+00014080: 656f 6d65 7472 7963 6f6c 756d 6e7d 2070  eometrycolumn} p
+00014090: 6c61 6365 686f 6c64 6572 2c20 6974 2069  laceholder, it i
+000140a0: 7320 6669 6c6c 6564 206f 7574 2077 6974  s filled out wit
+000140b0: 6820 7468 650a 2020 2020 2020 2020 2020  h the.          
+000140c0: 2020 6765 6f6d 6574 7279 2063 6f6c 756d    geometry colum
+000140d0: 6e20 6e61 6d65 206f 6620 7468 6520 7372  n name of the sr
+000140e0: 6320 6669 6c65 2e20 4465 6661 756c 7473  c file. Defaults
+000140f0: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
+00014100: 2020 7265 7072 6f6a 6563 7420 2862 6f6f    reproject (boo
+00014110: 6c2c 206f 7074 696f 6e61 6c29 3a20 5472  l, optional): Tr
+00014120: 7565 2074 6f20 7265 7072 6f6a 6563 7420  ue to reproject 
+00014130: 7768 696c 6520 636f 6e76 6572 7469 6e67  while converting
+00014140: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00014150: 2066 696c 652e 2044 6566 6175 6c74 7320   file. Defaults 
+00014160: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
+00014170: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
+00014180: 696f 6e73 2028 626f 6f6c 2c20 6f70 7469  ions (bool, opti
+00014190: 6f6e 616c 293a 2054 7275 6520 746f 206f  onal): True to o
+000141a0: 7574 7075 7420 6f6e 6c79 2073 696d 706c  utput only simpl
+000141b0: 650a 2020 2020 2020 2020 2020 2020 6765  e.            ge
+000141c0: 6f6d 6574 7269 6573 2e20 4465 6661 756c  ometries. Defaul
+000141d0: 7473 2074 6f20 4661 6c73 652e 0a20 2020  ts to False..   
+000141e0: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
+000141f0: 745f 6765 6f6d 6574 7279 7479 7065 2028  t_geometrytype (
+00014200: 556e 696f 6e5b 4765 6f6d 6574 7279 5479  Union[GeometryTy
+00014210: 7065 2c20 7374 725d 2c20 6f70 7469 6f6e  pe, str], option
+00014220: 616c 293a 2047 656f 6d65 7472 7920 7479  al): Geometry ty
+00014230: 7065 2e0a 2020 2020 2020 2020 2020 2020  pe..            
+00014240: 746f 2028 7472 7920 746f 2920 666f 7263  to (try to) forc
+00014250: 6520 7468 6520 6f75 7470 7574 2074 6f2e  e the output to.
+00014260: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00014270: 652e 0a20 2020 2020 2020 2063 7265 6174  e..        creat
+00014280: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
+00014290: 2862 6f6f 6c2c 206f 7074 696f 6e61 6c29  (bool, optional)
+000142a0: 3a20 5472 7565 2074 6f20 6372 6561 7465  : True to create
+000142b0: 2061 2073 7061 7469 616c 2069 6e64 6578   a spatial index
+000142c0: 0a20 2020 2020 2020 2020 2020 206f 6e20  .            on 
+000142d0: 7468 6520 6465 7374 696e 6174 696f 6e20  the destination 
+000142e0: 6669 6c65 2f6c 6179 6572 2e20 4966 204e  file/layer. If N
+000142f0: 6f6e 652c 2074 6865 2064 6566 6175 6c74  one, the default
+00014300: 2062 6568 6176 696f 7572 2062 7920 6764   behaviour by gd
+00014310: 616c 2066 6f72 0a20 2020 2020 2020 2020  al for.         
+00014320: 2020 2074 6861 7420 6669 6c65 2074 7970     that file typ
+00014330: 6520 6973 2072 6573 7065 6374 6564 2e20  e is respected. 
+00014340: 4966 2074 6865 204c 4159 4552 5f43 5245  If the LAYER_CRE
+00014350: 4154 494f 4e2e 5350 4154 4941 4c5f 494e  ATION.SPATIAL_IN
+00014360: 4445 580a 2020 2020 2020 2020 2020 2020  DEX.            
+00014370: 7061 7261 6d65 7465 7220 6973 2073 7065  parameter is spe
+00014380: 6369 6669 6564 2069 6e20 6f70 7469 6f6e  cified in option
+00014390: 732c 2063 7265 6174 655f 7370 6174 6961  s, create_spatia
+000143a0: 6c5f 696e 6465 7820 6973 2069 676e 6f72  l_index is ignor
+000143b0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000143c0: 4465 6661 756c 7473 2074 6f20 5472 7565  Defaults to True
+000143d0: 2e0a 2020 2020 2020 2020 7072 6573 6572  ..        preser
+000143e0: 7665 5f66 6964 2028 626f 6f6c 2c20 6f70  ve_fid (bool, op
+000143f0: 7469 6f6e 616c 293a 2054 7275 6520 746f  tional): True to
+00014400: 206d 616b 6520 616e 2065 7874 7261 2065   make an extra e
+00014410: 6666 6f72 7420 746f 2070 7265 7365 7276  ffort to preserv
+00014420: 6520 6669 6427 7320 6f66 0a20 2020 2020  e fid's of.     
+00014430: 2020 2020 2020 2074 6865 2073 6f75 7263         the sourc
+00014440: 6520 6c61 7965 7220 746f 2074 6865 2064  e layer to the d
+00014450: 6573 7469 6e61 7469 6f6e 206c 6179 6572  estination layer
+00014460: 2e20 4661 6c73 6520 6e6f 7420 746f 2064  . False not to d
+00014470: 6f20 616e 7920 6566 666f 7274 2e20 4e6f  o any effort. No
+00014480: 6e65 0a20 2020 2020 2020 2020 2020 2074  ne.            t
+00014490: 6f20 7573 6520 7468 6520 6465 6661 756c  o use the defaul
+000144a0: 7420 6265 6861 7669 6f75 7220 6f66 2067  t behaviour of g
+000144b0: 6461 6c2c 2074 6861 7420 616c 7265 6164  dal, that alread
+000144c0: 7920 7072 6573 6572 7665 7320 696e 2073  y preserves in s
+000144d0: 6f6d 6520 6361 7365 732e 0a20 2020 2020  ome cases..     
+000144e0: 2020 2020 2020 2053 6f6d 6520 6669 6c65         Some file
+000144f0: 2066 6f72 6d61 7473 2064 6f6e 2774 2065   formats don't e
+00014500: 7870 6c69 6369 746c 7920 7374 6f72 6520  xplicitly store 
+00014510: 7468 6520 6669 6420 2865 2e67 2e20 7368  the fid (e.g. sh
+00014520: 6170 6566 696c 6529 2c20 736f 2074 6865  apefile), so the
+00014530: 790a 2020 2020 2020 2020 2020 2020 7769  y.            wi
+00014540: 6c6c 206e 6576 6572 2062 6520 6162 6c65  ll never be able
+00014550: 2074 6f20 7072 6573 6572 7665 2066 6964   to preserve fid
+00014560: 732e 2044 6566 6175 6c74 7320 746f 204e  s. Defaults to N
+00014570: 6f6e 652e 0a20 2020 2020 2020 206f 7074  one..        opt
+00014580: 696f 6e73 2028 6469 6374 2c20 6f70 7469  ions (dict, opti
+00014590: 6f6e 616c 293a 206f 7074 696f 6e73 2074  onal): options t
+000145a0: 6f20 7061 7373 2074 6f20 6764 616c 2e0a  o pass to gdal..
+000145b0: 2020 2020 2020 2020 6170 7065 6e64 2028          append (
+000145c0: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
+000145d0: 2054 7275 6520 746f 2061 7070 656e 6420   True to append 
+000145e0: 746f 2074 6865 206f 7574 7075 7420 6669  to the output fi
+000145f0: 6c65 2069 6620 6974 2065 7869 7374 732e  le if it exists.
+00014600: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
+00014610: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
+00014620: 2020 2020 2020 2020 666f 7263 6520 2862          force (b
+00014630: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
+00014640: 6f76 6572 7772 6974 6520 6578 6973 7469  overwrite existi
+00014650: 6e67 206f 7574 7075 7420 6669 6c65 2873  ng output file(s
+00014660: 290a 2020 2020 2020 2020 2020 2020 4465  ).            De
+00014670: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
+00014680: 0a0a 2020 2020 2e2e 207c 7370 6174 6961  ..    .. |spatia
+00014690: 6c69 7465 5f72 6566 6572 656e 6365 5f6c  lite_reference_l
+000146a0: 696e 6b7c 2072 6177 3a3a 2068 746d 6c0a  ink| raw:: html.
+000146b0: 0a20 2020 2020 2020 203c 6120 6872 6566  .        <a href
+000146c0: 3d22 6874 7470 733a 2f2f 7777 772e 6761  ="https://www.ga
+000146d0: 6961 2d67 6973 2e69 742f 6761 6961 2d73  ia-gis.it/gaia-s
+000146e0: 696e 732f 7370 6174 6961 6c69 7465 2d73  ins/spatialite-s
+000146f0: 716c 2d6c 6174 6573 742e 6874 6d6c 2220  ql-latest.html" 
+00014700: 7461 7267 6574 3d22 5f62 6c61 6e6b 223e  target="_blank">
+00014710: 7370 6174 6961 6c69 7465 2072 6566 6572  spatialite refer
+00014720: 656e 6365 3c2f 613e 0a0a 2020 2020 2222  ence</a>..    ""
+00014730: 2220 2023 206e 6f71 613a 2045 3530 310a  "  # noqa: E501.
+00014740: 2020 2020 2320 496e 6974 0a20 2020 2073      # Init.    s
+00014750: 7263 203d 2050 6174 6828 7372 6329 0a20  rc = Path(src). 
+00014760: 2020 2064 7374 203d 2050 6174 6828 6473     dst = Path(ds
+00014770: 7429 0a0a 2020 2020 2320 4966 2073 6f75  t)..    # If sou
+00014780: 7263 6520 6669 6c65 2064 6f65 736e 2774  rce file doesn't
+00014790: 2065 7869 7374 2c20 7261 6973 6520 6572   exist, raise er
+000147a0: 726f 720a 2020 2020 6966 206e 6f74 2073  ror.    if not s
+000147b0: 7263 2e65 7869 7374 7328 293a 0a20 2020  rc.exists():.   
+000147c0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000147d0: 4572 726f 7228 6622 7372 6320 6669 6c65  Error(f"src file
+000147e0: 2064 6f65 736e 2774 2065 7869 7374 3a20   doesn't exist: 
+000147f0: 7b73 7263 7d22 290a 2020 2020 2320 4966  {src}").    # If
+00014800: 2064 6573 7420 6669 6c65 2065 7869 7374   dest file exist
+00014810: 7320 616c 7265 6164 7920 616e 6420 6e6f  s already and no
+00014820: 2061 7070 656e 640a 2020 2020 6966 206e   append.    if n
+00014830: 6f74 2061 7070 656e 6420 616e 6420 6473  ot append and ds
+00014840: 742e 6578 6973 7473 2829 3a0a 2020 2020  t.exists():.    
+00014850: 2020 2020 6966 2066 6f72 6365 2069 7320      if force is 
+00014860: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+00014870: 2020 7265 6d6f 7665 2864 7374 290a 2020    remove(dst).  
+00014880: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00014890: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+000148a0: 6e66 6f28 6622 4f75 7470 7574 2066 696c  nfo(f"Output fil
+000148b0: 6520 6578 6973 7473 2061 6c72 6561 6479  e exists already
+000148c0: 2c20 736f 2073 746f 703a 207b 6473 747d  , so stop: {dst}
+000148d0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+000148e0: 6574 7572 6e0a 0a20 2020 2023 2043 6f6e  eturn..    # Con
+000148f0: 7665 7274 0a20 2020 206c 6f67 6765 722e  vert.    logger.
+00014900: 696e 666f 2866 2243 6f6e 7665 7274 207b  info(f"Convert {
+00014910: 7372 637d 2074 6f20 7b64 7374 7d22 290a  src} to {dst}").
+00014920: 2020 2020 5f61 7070 656e 645f 746f 5f6e      _append_to_n
+00014930: 6f6c 6f63 6b28 0a20 2020 2020 2020 2073  olock(.        s
+00014940: 7263 2c0a 2020 2020 2020 2020 6473 742c  rc,.        dst,
+00014950: 0a20 2020 2020 2020 2073 7263 5f6c 6179  .        src_lay
+00014960: 6572 2c0a 2020 2020 2020 2020 6473 745f  er,.        dst_
+00014970: 6c61 7965 722c 0a20 2020 2020 2020 2073  layer,.        s
+00014980: 7263 5f63 7273 3d73 7263 5f63 7273 2c0a  rc_crs=src_crs,.
+00014990: 2020 2020 2020 2020 6473 745f 6372 733d          dst_crs=
+000149a0: 6473 745f 6372 732c 0a20 2020 2020 2020  dst_crs,.       
+000149b0: 2077 6865 7265 3d77 6865 7265 2c0a 2020   where=where,.  
+000149c0: 2020 2020 2020 7265 7072 6f6a 6563 743d        reproject=
+000149d0: 7265 7072 6f6a 6563 742c 0a20 2020 2020  reproject,.     
+000149e0: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+000149f0: 7469 6f6e 733d 6578 706c 6f64 6563 6f6c  tions=explodecol
+00014a00: 6c65 6374 696f 6e73 2c0a 2020 2020 2020  lections,.      
+00014a10: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
+00014a20: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
+00014a30: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00014a40: 7974 7970 652c 0a20 2020 2020 2020 2063  ytype,.        c
+00014a50: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+00014a60: 6465 783d 6372 6561 7465 5f73 7061 7469  dex=create_spati
+00014a70: 616c 5f69 6e64 6578 2c0a 2020 2020 2020  al_index,.      
+00014a80: 2020 7072 6573 6572 7665 5f66 6964 3d70    preserve_fid=p
+00014a90: 7265 7365 7276 655f 6669 642c 0a20 2020  reserve_fid,.   
+00014aa0: 2020 2020 206f 7074 696f 6e73 3d6f 7074       options=opt
+00014ab0: 696f 6e73 2c0a 2020 2020 290a 0a0a 6465  ions,.    )...de
+00014ac0: 6620 5f6c 6175 6e64 6572 5f63 6f6c 756d  f _launder_colum
+00014ad0: 6e5f 6e61 6d65 7328 636f 6c75 6d6e 733a  n_names(columns:
+00014ae0: 2049 7465 7261 626c 6529 202d 3e20 4c69   Iterable) -> Li
+00014af0: 7374 5b54 7570 6c65 5b73 7472 2c20 7374  st[Tuple[str, st
+00014b00: 725d 5d3a 0a20 2020 2022 2222 0a20 2020  r]]:.    """.   
+00014b10: 204c 6175 6e64 6572 7320 7468 6520 636f   Launders the co
+00014b20: 6c75 6d6e 206e 616d 6573 2070 6173 7365  lumn names passe
+00014b30: 6420 746f 2063 6f6d 706c 7920 7769 7468  d to comply with
+00014b40: 2073 6861 7065 6669 6c65 2072 6573 7472   shapefile restr
+00014b50: 6963 7469 6f6e 732e 0a0a 2020 2020 5261  ictions...    Ra
+00014b60: 7469 6f6e 616c 653a 206e 6f72 6d61 6c6c  tionale: normall
+00014b70: 7920 6764 616c 206c 6175 6e64 6572 7320  y gdal launders 
+00014b80: 7468 656d 2069 6620 6e65 6564 6564 2c20  them if needed, 
+00014b90: 6275 7420 7768 656e 2079 6f75 2061 7070  but when you app
+00014ba0: 656e 640a 2020 2020 6d75 6c74 6970 6c65  end.    multiple
+00014bb0: 2066 696c 6573 2074 6f20 6120 7368 6170   files to a shap
+00014bc0: 6566 696c 6520 7769 7468 2063 6f6c 756d  efile with colum
+00014bd0: 6e73 2074 6861 7420 6e65 6564 2074 6f20  ns that need to 
+00014be0: 6265 206c 6175 6e64 6572 6564 0a20 2020  be laundered.   
+00014bf0: 2074 6865 7920 6172 6520 6e6f 7420 6d61   they are not ma
+00014c00: 7463 6865 6420 616e 6420 736f 2061 7265  tched and so are
+00014c10: 2061 7070 656e 6465 6420 7769 7468 204e   appended with N
+00014c20: 554c 4c20 7661 6c75 6573 2066 6f72 2074  ULL values for t
+00014c30: 6865 7365 0a20 2020 2063 6f6c 756d 6e73  hese.    columns
+00014c40: 2e20 4e6f 726d 616c 6c79 2074 6865 202d  . Normally the -
+00014c50: 7265 6c61 7865 6446 6965 6c64 4e61 6d65  relaxedFieldName
+00014c60: 4d61 7463 6820 7061 7261 6d65 7465 7220  Match parameter 
+00014c70: 696e 206f 6772 326f 6772 0a20 2020 2073  in ogr2ogr.    s
+00014c80: 686f 756c 6420 6669 7820 7468 6973 2c20  hould fix this, 
+00014c90: 6275 7420 6974 2073 6565 6d73 2074 6861  but it seems tha
+00014ca0: 7420 7468 6973 2069 736e 2774 2073 7570  t this isn't sup
+00014cb0: 706f 7274 6564 2066 6f72 2073 6861 7065  ported for shape
+00014cc0: 6669 6c65 732e 0a0a 2020 2020 4c61 756e  files...    Laun
+00014cd0: 6465 7269 6e67 2069 7320 6261 7365 6420  dering is based 
+00014ce0: 6f6e 2074 6869 7320 7465 7874 2066 726f  on this text fro
+00014cf0: 6d20 7468 6520 6764 616c 2073 6861 7065  m the gdal shape
+00014d00: 6669 6c65 2064 7269 7665 720a 2020 2020  file driver.    
+00014d10: 646f 6375 6d65 6e74 6174 696f 6e3a 0a0a  documentation:..
+00014d20: 2020 2020 5368 6170 6566 696c 6520 6665      Shapefile fe
+00014d30: 6174 7572 6520 6174 7472 6962 7574 6573  ature attributes
+00014d40: 2061 7265 2073 746f 7265 6420 696e 2061   are stored in a
+00014d50: 6e20 6173 736f 6369 6174 6564 202e 6462  n associated .db
+00014d60: 6620 6669 6c65 2c20 616e 640a 2020 2020  f file, and.    
+00014d70: 736f 2061 7474 7269 6275 7465 7320 7375  so attributes su
+00014d80: 6666 6572 2061 206e 756d 6265 7220 6f66  ffer a number of
+00014d90: 206c 696d 6974 6174 696f 6e73 3a0a 2020   limitations:.  
+00014da0: 2020 2d20 2020 4174 7472 6962 7574 6520    -   Attribute 
+00014db0: 6e61 6d65 7320 6361 6e20 6f6e 6c79 2062  names can only b
+00014dc0: 6520 7570 2074 6f20 3130 2063 6861 7261  e up to 10 chara
+00014dd0: 6374 6572 7320 6c6f 6e67 2e0a 2020 2020  cters long..    
+00014de0: 2020 2020 5468 6520 4f47 5220 5368 6170      The OGR Shap
+00014df0: 6566 696c 6520 6472 6976 6572 2074 7269  efile driver tri
+00014e00: 6573 2074 6f20 6765 6e65 7261 7465 2075  es to generate u
+00014e10: 6e69 7175 6520 6669 656c 640a 2020 2020  nique field.    
+00014e20: 2020 2020 6e61 6d65 732e 2053 7563 6365      names. Succe
+00014e30: 7373 6976 6520 6475 706c 6963 6174 6520  ssive duplicate 
+00014e40: 6669 656c 6420 6e61 6d65 732c 2069 6e63  field names, inc
+00014e50: 6c75 6469 6e67 2074 686f 7365 2063 7265  luding those cre
+00014e60: 6174 6564 2062 790a 2020 2020 2020 2020  ated by.        
+00014e70: 7472 756e 6361 7469 6f6e 2074 6f20 3130  truncation to 10
+00014e80: 2063 6861 7261 6374 6572 732c 2077 696c   characters, wil
+00014e90: 6c20 6265 2074 7275 6e63 6174 6564 2074  l be truncated t
+00014ea0: 6f20 3820 6368 6172 6163 7465 7273 2061  o 8 characters a
+00014eb0: 6e64 0a20 2020 2020 2020 2061 7070 656e  nd.        appen
+00014ec0: 6465 6420 7769 7468 2061 2073 6572 6961  ded with a seria
+00014ed0: 6c20 6e75 6d62 6572 2066 726f 6d20 3120  l number from 1 
+00014ee0: 746f 2039 392e 0a0a 2020 2020 2020 2020  to 99...        
+00014ef0: 466f 7220 6578 616d 706c 653a 0a0a 2020  For example:..  
+00014f00: 2020 2020 2020 2d20 2061 20e2 8692 2061        -  a ... a
+00014f10: 2c20 6120 e286 9220 615f 312c 2041 20e2  , a ... a_1, A .
+00014f20: 8692 2041 5f32 3b0a 2020 2020 2020 2020  .. A_2;.        
+00014f30: 2d20 2061 6263 6465 6667 6869 6a6b 20e2  -  abcdefghijk .
+00014f40: 8692 2061 6263 6465 6667 6869 6a2c 2061  .. abcdefghij, a
+00014f50: 6263 6465 6667 6869 6a6b 6c20 e286 9220  bcdefghijkl ... 
+00014f60: 6162 6364 6566 6768 5f31 0a0a 2020 2020  abcdefgh_1..    
+00014f70: 2d20 2020 4f6e 6c79 2049 6e74 6567 6572  -   Only Integer
+00014f80: 2c20 496e 7465 6765 7236 342c 2052 6561  , Integer64, Rea
+00014f90: 6c2c 2053 7472 696e 6720 616e 6420 4461  l, String and Da
+00014fa0: 7465 2028 6e6f 7420 4461 7465 5469 6d65  te (not DateTime
+00014fb0: 2c20 6a75 7374 0a20 2020 2020 2020 2079  , just.        y
+00014fc0: 6561 722f 6d6f 6e74 682f 6461 7929 2066  ear/month/day) f
+00014fd0: 6965 6c64 2074 7970 6573 2061 7265 2073  ield types are s
+00014fe0: 7570 706f 7274 6564 2e20 5468 6520 7661  upported. The va
+00014ff0: 7269 6f75 7320 6c69 7374 2c20 616e 640a  rious list, and.
+00015000: 2020 2020 2020 2020 6269 6e61 7279 2066          binary f
+00015010: 6965 6c64 2074 7970 6573 2063 616e 6e6f  ield types canno
+00015020: 7420 6265 2063 7265 6174 6564 2e0a 2020  t be created..  
+00015030: 2020 2d20 2020 5468 6520 6669 656c 6420    -   The field 
+00015040: 7769 6474 6820 616e 6420 7072 6563 6973  width and precis
+00015050: 696f 6e20 6172 6520 6469 7265 6374 6c79  ion are directly
+00015060: 2075 7365 6420 746f 2065 7374 6162 6c69   used to establi
+00015070: 7368 2073 746f 7261 6765 0a20 2020 2020  sh storage.     
+00015080: 2020 2073 697a 6520 696e 2074 6865 202e     size in the .
+00015090: 6462 6620 6669 6c65 2e20 5468 6973 206d  dbf file. This m
+000150a0: 6561 6e73 2074 6861 7420 7374 7269 6e67  eans that string
+000150b0: 7320 6c6f 6e67 6572 2074 6861 6e20 7468  s longer than th
+000150c0: 6520 6669 656c 640a 2020 2020 2020 2020  e field.        
+000150d0: 7769 6474 682c 206f 7220 6e75 6d62 6572  width, or number
+000150e0: 7320 7468 6174 2064 6f6e 2774 2066 6974  s that don't fit
+000150f0: 2069 6e74 6f20 7468 6520 696e 6469 6361   into the indica
+00015100: 7465 6420 6669 656c 6420 666f 726d 6174  ted field format
+00015110: 2077 696c 6c0a 2020 2020 2020 2020 7375   will.        su
+00015120: 6666 6572 2074 7275 6e63 6174 696f 6e2e  ffer truncation.
+00015130: 0a20 2020 202d 2020 2049 6e74 6567 6572  .    -   Integer
+00015140: 2066 6965 6c64 7320 7769 7468 6f75 7420   fields without 
+00015150: 616e 2065 7870 6c69 6369 7420 7769 6474  an explicit widt
+00015160: 6820 6172 6520 7472 6561 7465 6420 6173  h are treated as
+00015170: 2077 6964 7468 2039 2c20 616e 640a 2020   width 9, and.  
+00015180: 2020 2020 2020 6578 7465 6e64 6564 2074        extended t
+00015190: 6f20 3130 206f 7220 3131 2069 6620 6e65  o 10 or 11 if ne
+000151a0: 6564 6564 2e0a 2020 2020 2d20 2020 496e  eded..    -   In
+000151b0: 7465 6765 7236 3420 6669 656c 6473 2077  teger64 fields w
+000151c0: 6974 686f 7574 2061 6e20 6578 706c 6963  ithout an explic
+000151d0: 6974 2077 6964 7468 2061 7265 2074 7265  it width are tre
+000151e0: 6174 6564 2061 7320 7769 6474 6820 3138  ated as width 18
+000151f0: 2c0a 2020 2020 2020 2020 616e 6420 6578  ,.        and ex
+00015200: 7465 6e64 6564 2074 6f20 3139 206f 7220  tended to 19 or 
+00015210: 3230 2069 6620 6e65 6564 6564 2e0a 2020  20 if needed..  
+00015220: 2020 2d20 2020 5265 616c 2028 666c 6f61    -   Real (floa
+00015230: 7469 6e67 2070 6f69 6e74 2920 6669 656c  ting point) fiel
+00015240: 6473 2077 6974 686f 7574 2061 6e20 6578  ds without an ex
+00015250: 706c 6963 6974 2077 6964 7468 2061 7265  plicit width are
+00015260: 2074 7265 6174 6564 2061 730a 2020 2020   treated as.    
+00015270: 2020 2020 7769 6474 6820 3234 2077 6974      width 24 wit
+00015280: 6820 3135 2064 6563 696d 616c 2070 6c61  h 15 decimal pla
+00015290: 6365 7320 6f66 2070 7265 6369 7369 6f6e  ces of precision
+000152a0: 2e0a 2020 2020 2d20 2020 5374 7269 6e67  ..    -   String
+000152b0: 2066 6965 6c64 7320 7769 7468 6f75 7420   fields without 
+000152c0: 616e 2061 7373 6967 6e65 6420 7769 6474  an assigned widt
+000152d0: 6820 6172 6520 7472 6561 7465 6420 6173  h are treated as
+000152e0: 2038 3020 6368 6172 6163 7465 7273 2e0a   80 characters..
+000152f0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00015300: 2020 2063 6f6c 756d 6e73 2028 4974 6572     columns (Iter
+00015310: 6162 6c65 293a 2074 6865 2063 6f6c 756d  able): the colum
+00015320: 6e73 2074 6f20 6c61 756e 6465 722e 0a0a  ns to launder...
+00015330: 2020 2020 5265 7475 726e 733a 2061 204c      Returns: a L
+00015340: 6973 7420 6f66 2074 7570 706c 6573 2077  ist of tupples w
+00015350: 6974 6820 7468 6520 6f72 6967 696e 616c  ith the original
+00015360: 2061 6e64 206c 6175 6e64 6572 6564 2063   and laundered c
+00015370: 6f6c 756d 6e20 6e61 6d65 732e 0a20 2020  olumn names..   
+00015380: 2022 2222 0a20 2020 206c 6175 6e64 6572   """.    launder
+00015390: 6564 203d 205b 5d0a 2020 2020 6c61 756e  ed = [].    laun
+000153a0: 6465 7265 645f 7570 7065 7220 3d20 5b5d  dered_upper = []
+000153b0: 0a20 2020 2066 6f72 2063 6f6c 756d 6e20  .    for column 
+000153c0: 696e 2063 6f6c 756d 6e73 3a0a 2020 2020  in columns:.    
+000153d0: 2020 2020 2320 446f 7562 6c65 7320 696e      # Doubles in
+000153e0: 2063 6173 696e 6720 6172 6565 206e 6f74   casing aree not
+000153f0: 2061 6c6c 6f77 6564 2065 6974 6865 720a   allowed either.
+00015400: 2020 2020 2020 2020 6966 206c 656e 2863          if len(c
+00015410: 6f6c 756d 6e29 203c 3d20 3130 3a0a 2020  olumn) <= 10:.  
+00015420: 2020 2020 2020 2020 2020 6966 2063 6f6c            if col
+00015430: 756d 6e2e 7570 7065 7228 2920 6e6f 7420  umn.upper() not 
+00015440: 696e 206c 6175 6e64 6572 6564 5f75 7070  in laundered_upp
+00015450: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00015460: 2020 2020 6c61 756e 6465 7265 645f 7570      laundered_up
+00015470: 7065 722e 6170 7065 6e64 2863 6f6c 756d  per.append(colum
+00015480: 6e2e 7570 7065 7228 2929 0a20 2020 2020  n.upper()).     
+00015490: 2020 2020 2020 2020 2020 206c 6175 6e64             laund
+000154a0: 6572 6564 2e61 7070 656e 6428 2863 6f6c  ered.append((col
+000154b0: 756d 6e2c 2063 6f6c 756d 6e29 290a 2020  umn, column)).  
+000154c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000154d0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+000154e0: 2320 4c61 756e 6465 7269 6e67 2069 7320  # Laundering is 
+000154f0: 6e65 6564 6564 0a20 2020 2020 2020 2063  needed.        c
+00015500: 6f6c 756d 6e5f 6c61 756e 6465 7265 6420  olumn_laundered 
+00015510: 3d20 636f 6c75 6d6e 5b3a 3130 5d0a 2020  = column[:10].  
+00015520: 2020 2020 2020 6966 2063 6f6c 756d 6e5f        if column_
+00015530: 6c61 756e 6465 7265 642e 7570 7065 7228  laundered.upper(
+00015540: 2920 6e6f 7420 696e 206c 6175 6e64 6572  ) not in launder
+00015550: 6564 5f75 7070 6572 3a0a 2020 2020 2020  ed_upper:.      
+00015560: 2020 2020 2020 6c61 756e 6465 7265 645f        laundered_
+00015570: 7570 7065 722e 6170 7065 6e64 2863 6f6c  upper.append(col
+00015580: 756d 6e5f 6c61 756e 6465 7265 642e 7570  umn_laundered.up
+00015590: 7065 7228 2929 0a20 2020 2020 2020 2020  per()).         
+000155a0: 2020 206c 6175 6e64 6572 6564 2e61 7070     laundered.app
+000155b0: 656e 6428 2863 6f6c 756d 6e2c 2063 6f6c  end((column, col
+000155c0: 756d 6e5f 6c61 756e 6465 7265 6429 290a  umn_laundered)).
+000155d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000155e0: 2020 2020 2020 2020 2020 2320 4a75 7374            # Just
+000155f0: 2074 616b 696e 6720 6669 7273 7420 3130   taking first 10
+00015600: 2063 6861 7261 6374 6572 7320 6469 646e   characters didn
+00015610: 2774 2068 656c 700a 2020 2020 2020 2020  't help.        
+00015620: 2020 2020 666f 7220 696e 6465 7820 696e      for index in
+00015630: 2072 616e 6765 2831 2c20 3130 3129 3a0a   range(1, 101):.
+00015640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015650: 6966 2069 6e64 6578 203e 3d20 3130 303a  if index >= 100:
+00015660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015670: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+00015680: 706c 656d 656e 7465 6445 7272 6f72 280a  plementedError(.
+00015690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156a0: 2020 2020 2020 2020 224e 6f74 2073 7570          "Not sup
+000156b0: 706f 7274 6564 2074 6f20 6c61 756e 6465  ported to launde
+000156c0: 7220 3e20 3939 2063 6f6c 756d 6e73 2073  r > 99 columns s
+000156d0: 7461 7274 696e 6720 220a 2020 2020 2020  tarting ".      
+000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156f0: 2020 6622 7769 7468 207b 636f 6c75 6d6e    f"with {column
+00015700: 5f6c 6175 6e64 6572 6564 5b3a 385d 7d22  _laundered[:8]}"
+00015710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015720: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00015730: 2020 2020 2020 2069 6620 696e 6465 7820         if index 
+00015740: 3c3d 2039 3a0a 2020 2020 2020 2020 2020  <= 9:.          
+00015750: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
+00015760: 5f6c 6175 6e64 6572 6564 203d 2066 227b  _laundered = f"{
+00015770: 636f 6c75 6d6e 5f6c 6175 6e64 6572 6564  column_laundered
+00015780: 5b3a 385d 7d5f 7b69 6e64 6578 7d22 0a20  [:8]}_{index}". 
+00015790: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000157a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000157b0: 2020 2020 2020 2020 2063 6f6c 756d 6e5f           column_
+000157c0: 6c61 756e 6465 7265 6420 3d20 6622 7b63  laundered = f"{c
+000157d0: 6f6c 756d 6e5f 6c61 756e 6465 7265 645b  olumn_laundered[
+000157e0: 3a38 5d7d 7b69 6e64 6578 7d22 0a20 2020  :8]}{index}".   
+000157f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00015800: 636f 6c75 6d6e 5f6c 6175 6e64 6572 6564  column_laundered
+00015810: 2e75 7070 6572 2829 206e 6f74 2069 6e20  .upper() not in 
+00015820: 6c61 756e 6465 7265 645f 7570 7065 723a  laundered_upper:
+00015830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015840: 2020 2020 206c 6175 6e64 6572 6564 5f75       laundered_u
+00015850: 7070 6572 2e61 7070 656e 6428 636f 6c75  pper.append(colu
+00015860: 6d6e 5f6c 6175 6e64 6572 6564 2e75 7070  mn_laundered.upp
+00015870: 6572 2829 290a 2020 2020 2020 2020 2020  er()).          
+00015880: 2020 2020 2020 2020 2020 6c61 756e 6465            launde
+00015890: 7265 642e 6170 7065 6e64 2828 636f 6c75  red.append((colu
+000158a0: 6d6e 2c20 636f 6c75 6d6e 5f6c 6175 6e64  mn, column_laund
+000158b0: 6572 6564 2929 0a20 2020 2020 2020 2020  ered)).         
+000158c0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000158d0: 0a0a 2020 2020 7265 7475 726e 206c 6175  ..    return lau
+000158e0: 6e64 6572 6564 0a                        ndered.
```

### Comparing `geofileops-0.8.0a5/geofileops/geoops.py` & `geofileops-0.8.0a6/geofileops/geoops.py`

 * *Files 16% similar despite different names*

```diff
@@ -38,14 +38,16 @@
     only_geom_input: bool = True,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Apply a python lambda function on the geometry column of the input file.
 
@@ -79,35 +81,58 @@
             Defaults to False.
         force_output_geometrytype (GeometryType, optional): The output geometry type to
             force. If None, a best-effort guess is made and will always result in a
             multi-type. Defaults to None.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start apply on {input_path}")
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     return _geoops_gpd.apply(
         input_path=Path(input_path),
         output_path=Path(output_path),
         func=func,
         only_geom_input=only_geom_input,
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def buffer(
@@ -120,14 +145,16 @@
     mitre_limit: float = 5.0,
     single_sided: bool = False,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a buffer operation on geometry column of the input file.
 
@@ -171,23 +198,33 @@
             to specify "fid", a unique index available in all input files. Note that the
             "fid" will be aliased eg. to "fid_1". Defaults to None.
         explodecollections (bool, optional): True to output only simple geometries.
             Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
 
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite</a>  # noqa: E501
+
     **Buffer style options**
 
     Using the different buffer style option parameters you can control how the
     buffer is created:
 
     - **quadrantsegments** *(int)*
 
@@ -257,20 +294,29 @@
         :alt: Buffer with joinstyle=BufferJoinStyle.BEVEL
     .. |buffer_mitre_50| image:: ../_static/images/buffer_mitre_50.png
         :alt: Buffer with mitre=5.0
     .. |buffer_mitre_25| image:: ../_static/images/buffer_mitre_25.png
         :alt: Buffer with mitre=2.5
     .. |buffer_mitre_10| image:: ../_static/images/buffer_mitre_10.png
         :alt: Buffer with mitre=1.0
-
     """
     logger.info(
         f"Start buffer on {input_path} "
         f"(distance: {distance}, quadrantsegments: {quadrantsegments})"
     )
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     if (
         endcap_style == BufferEndCapStyle.ROUND
         and join_style == BufferJoinStyle.ROUND
         and single_sided is False
     ):
         # If default buffer options for spatialite, use the faster sql version
         return _geoops_sql.buffer(
@@ -279,14 +325,16 @@
             distance=distance,
             quadrantsegments=quadrantsegments,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            keep_empty_geoms=keep_empty_geoms,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
         )
     else:
         # If special buffer options, use geopandas version
         return _geoops_gpd.buffer(
@@ -299,14 +347,16 @@
             mitre_limit=mitre_limit,
             single_sided=single_sided,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            keep_empty_geoms=keep_empty_geoms,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
         )
 
 
 def clip_by_geometry(
@@ -356,14 +406,16 @@
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a convexhull operation on the input file.
 
@@ -381,46 +433,71 @@
             to specify "fid", a unique index available in all input files. Note that the
             "fid" will be aliased eg. to "fid_1". Defaults to None.
         explodecollections (bool, optional): True to output only simple geometries.
             Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start convexhull on {input_path}")
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     return _geoops_sql.convexhull(
         input_path=Path(input_path),
         output_path=Path(output_path),
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def delete_duplicate_geometries(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     force: bool = False,
 ):
     """
     Copy all rows to the output file, except for duplicate geometries.
 
     Args:
         input_path (PathLike): the input file
@@ -434,26 +511,49 @@
             to specify "fid", a unique index available in all input files. Note that the
             "fid" will be aliased eg. to "fid_1". Defaults to None.
         explodecollections (bool, optional): True to output only simple geometries.
             Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start delete_duplicate_geometries on {input_path}")
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     return _geoops_sql.delete_duplicate_geometries(
         input_path=Path(input_path),
         output_path=Path(output_path),
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         force=force,
     )
 
 
 def dissolve(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
@@ -461,27 +561,30 @@
     groupby_columns: Union[List[str], str, None] = None,
     agg_columns: Optional[dict] = None,
     tiles_path: Union[str, "os.PathLike[Any]", None] = None,
     nb_squarish_tiles: int = 1,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a dissolve operation on the input file.
 
     If columns are specified with ``groupby_columns``, the data is first grouped
     on those columns before the geometries are merged.
 
     Data in other columns can be retained in the output by specifying the
     ``agg_columns`` parameter.
 
+    Rows with null or empty geometries are ignored.
+
     This is an example of how data in the columns that isn't grouped on can be
     aggregated to be added to the output file:
     ::
 
         import geofileops as gfo
 
         gfo.dissolve(
@@ -588,23 +691,31 @@
         input_layer (str, optional): input layer name. Optional if the
             file only contains one layer.
         output_layer (str, optional): input layer name. Optional if the
             file only contains one layer.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     # Init
     if tiles_path is not None:
         tiles_path = Path(tiles_path)
 
     # Standardize parameter to simplify the rest of the code
     if groupby_columns is not None:
         if isinstance(groupby_columns, str):
@@ -622,14 +733,15 @@
         groupby_columns=groupby_columns,
         agg_columns=agg_columns,
         tiles_path=tiles_path,
         nb_squarish_tiles=nb_squarish_tiles,
         input_layer=input_layer,
         output_layer=output_layer,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def export_by_bounds(
@@ -753,14 +865,16 @@
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     precision: Optional[float] = None,
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
@@ -786,28 +900,50 @@
             Defaults to False.
         force_output_geometrytype (GeometryType, optional): The output geometry type to
             force the output to. If None, the geometry type of the input is used.
             Defaults to None.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         validate_attribute_data (bool, optional): True to validate if all attribute data
             can be read. Raises an exception if an error is found, as this type of error
             cannot be fixed using makevalid. Defaults to False.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
 
     logger.info(f"Start makevalid on {input_path}")
+
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     if gridsize is None:
         gridsize = 0.0
     if precision is not None and gridsize != 0.0:
         raise ValueError(
             "the precision parameter is deprecated and cannot be combined with gridsize"
         )
     if precision is not None:
@@ -823,14 +959,16 @@
         output_path=Path(output_path),
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         validate_attribute_data=validate_attribute_data,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
@@ -900,70 +1038,78 @@
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = "SQLITE",
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Execute an SQL query on the file.
 
     By convention, the sqlite query can contain following placeholders that
     will be automatically replaced for you:
 
       * {geometrycolumn}: the column where the primary geometry is stored.
-      * {columns_to_select_str}: if 'columns' is not None, those columns,
-        otherwise all columns of the layer.
+      * {columns_to_select_str}: if 'columns' is not None, those columns, otherwise all
+        columns of the layer.
       * {input_layer}: the layer name of the input layer.
       * {batch_filter}: the filter used to process in parallel per batch.
 
-    Example: Copy all rows with a certain minimum area to the output file.
+    Hint: often you will want to use f"" formatting on the sql statement to fill out
+    some parameters of your own as well. You can easily escape the placeholders above by
+    doubling the "{" and "}", e.g. use {{geometrycolumn}} for {geometrycolumn}. Also
+    check out the example below.
+
+    Example: buffer all rows with a certain minimum area to the output file.
     ::
 
         import geofileops as gfo
 
         minimum_area = 100
         sql_stmt = f'''
-                SELECT {{geometrycolumn}}
+                SELECT ST_Buffer({{geometrycolumn}}, 1) AS {{geometrycolumn}}
                       {{columns_to_select_str}}
                   FROM "{{input_layer}}" layer
                  WHERE 1=1
                    {{batch_filter}}
                    AND ST_Area({{geometrycolumn}}) > {minimum_area}
                 '''
         gfo.select(
                 input_path=...,
                 output_path=...,
                 sql_stmt=sql_stmt)
 
     Some important remarks:
 
-    * Some sql statements won't give correct results when parallellized/ran in
+    * The name of the geometry column depends on the file format of the input file. E.g.
+      for .shp files the column will be called "geometry", for .gpkg files the default
+      name is "geom". If you use the {geometrycolumn} placeholder, geofileops will
+      replace it with the correct column name for the input file.
+    * If you apply (spatialite) functions on the geometry column always alias them again
+      to its original column name, e.g. with "AS {geometrycolumn}".
+    * Some sql statements won't give correct results when parallelized/ran in
       multiple batches, e.g. when using a group by statement. This is why the default
-      value for nb_parallel is 1. If you want to parallellize or run the query in
+      value for nb_parallel is 1. If you want to parallelize or run the query in
       multiple batches (by specifying nb_parallel != 1 or batchsize > 0), you should
       make sure your query will give correct results if it is executed per batch of
       rows instead of once on the entire layer.
       Additionally, if you do so, make sure to include the placeholder {batch_filter}
       in your sql_stmt. This placeholder will be replaced with a filter of the form
       'AND rowid >= x AND rowid < y' and will ensure every row is only treated once.
     * Table names are best double quoted as in the example, because some
       characters are otherwise not supported in the table name, eg. '-'.
     * It is recommend to give the table you select from "layer" as alias. If
       you use the {batch_filter} placeholder this is even mandatory.
     * When using the (default) "SQLITE" sql dialect, you can also use the spatialite
-      functions as documented here: |spatialite_reference_link|
-
-    .. |spatialite_reference_link| raw:: html
-
-        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>  # noqa: E501
+      functions as documented here: |spatialite_reference_link|.
 
     The result is written to the output file specified.
 
     Args:
         input_path (PathLike): the input file
         output_path (PathLike): the file to write the result to
         sql_stmt (str): the statement to execute
@@ -975,32 +1121,39 @@
             file only contains one layer.
         columns (List[str], optional): list of columns to retain, if
             {columns_to_select_str} is used. If None, all standard
             columns are retained. In addition to standard columns, it is also possible
             to specify "fid", a unique index available in all input files. Note that the
             "fid" will be aliased eg. to "fid_1". Defaults to None.
         explodecollections (bool, optional): True to convert all multi-geometries to
-            singular ones after the dissolve. Defaults to False.
+            singular ones. Defaults to False.
         force_output_geometrytype (GeometryType, optional): The output geometry type to
             force. Defaults to None, and then the geometry type of the input is used
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to True.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to 1. If nb_parallel != 1, make sure your query still returns
             correct results if it is executed per batch of rows instead of in one go
             on the entire layer. To use all available cores, pass -1.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage. If batchsize != -1,
             make sure your query still returns correct results if it is executed per
             batch of rows instead of in one go on the entire layer.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s). Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start select on {input_path}")
 
     # Convert force_output_geometrytype to GeometryType (if necessary)
     if force_output_geometrytype is not None:
         force_output_geometrytype = GeometryType(force_output_geometrytype)
 
     return _geoops_sql.select(
@@ -1009,14 +1162,15 @@
         sql_stmt=sql_stmt,
         sql_dialect=sql_dialect,
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
+        keep_empty_geoms=keep_empty_geoms,
         gridsize=gridsize,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
@@ -1027,14 +1181,16 @@
     algorithm: SimplifyAlgorithm = SimplifyAlgorithm.RAMER_DOUGLAS_PEUCKER,
     lookahead: int = 8,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: Optional[bool] = None,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a simplify operation on geometry column of the input file.
 
@@ -1063,34 +1219,56 @@
             to specify "fid", a unique index available in all input files. Note that the
             "fid" will be aliased eg. to "fid_1". Defaults to None.
         explodecollections (bool, optional): True to output only simple geometries.
             Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        keep_empty_geoms (bool, optional): True to keep rows with empty/null geometries
+            in the output. Defaults to False now, but default becomes True in a future
+            version.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start simplify on {input_path} with tolerance {tolerance}")
+    if keep_empty_geoms is None:
+        keep_empty_geoms = False
+        warnings.warn(
+            "keep_empty_geoms defaults to False now for backwards compatibility, but "
+            "this will change to True in a future version. If keep_empty_geoms is "
+            "specified, this warning isn't shown anymore",
+            FutureWarning,
+            stacklevel=2,
+        )
+
     if algorithm == SimplifyAlgorithm.RAMER_DOUGLAS_PEUCKER:
         return _geoops_sql.simplify(
             input_path=Path(input_path),
             output_path=Path(output_path),
             tolerance=tolerance,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
         )
     else:
         return _geoops_gpd.simplify(
             input_path=Path(input_path),
@@ -1099,14 +1277,15 @@
             algorithm=algorithm,
             lookahead=lookahead,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
         )
 
 
 ################################################################################
@@ -1120,14 +1299,15 @@
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     input_columns: Optional[List[str]] = None,
     clip_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Clip the input layer with the clip layer.
 
@@ -1167,40 +1347,48 @@
         output_layer (str, optional): output layer name. Optional if the
             file only contains one layer.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
 
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
     .. |clip_input| image:: ../_static/images/clip_input.png
         :alt: Clip input
     .. |clip_result| image:: ../_static/images/clip_result.png
         :alt: Clip result
-    """
+    """  # noqa: E501
 
     logger.info(f"Start clip on {input_path} with {clip_path} to {output_path}")
     return _geoops_sql.clip(
         input_path=Path(input_path),
         clip_path=Path(clip_path),
         output_path=Path(output_path),
         input_layer=input_layer,
         input_columns=input_columns,
         clip_layer=clip_layer,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def erase(
@@ -1209,14 +1397,15 @@
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     input_columns: Optional[List[str]] = None,
     erase_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Erase all geometries in the erase layer from the input layer.
 
@@ -1243,35 +1432,44 @@
         output_layer (str, optional): output layer name. Optional if the
             file only contains one layer.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
 
     logger.info(f"Start erase on {input_path} with {erase_path} to {output_path}")
     return _geoops_sql.erase(
         input_path=Path(input_path),
         erase_path=Path(erase_path),
         output_path=Path(output_path),
         input_layer=input_layer,
         input_columns=input_columns,
         erase_layer=erase_layer,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def export_by_location(
@@ -1281,14 +1479,15 @@
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = "area_inters",
     input1_layer: Optional[str] = None,
     input1_columns: Optional[List[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Exports all features in input_to_select_from_path that intersect with any
     features in input_to_compare_with_path.
@@ -1314,23 +1513,31 @@
             file only contains one layer.
         input2_columns (List[str], optional): NA.
         output_layer (str, optional): output layer name. Optional if the
             file only contains one layer.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start export_by_location: select from {input_to_select_from_path} "
         f"interacting with {input_to_compare_with_path} to {output_path}"
     )
     return _geoops_sql.export_by_location(
         input_path=Path(input_to_select_from_path),
         input_to_compare_with_path=Path(input_to_compare_with_path),
@@ -1338,14 +1545,15 @@
         min_area_intersect=min_area_intersect,
         area_inters_column_name=area_inters_column_name,
         input_layer=input1_layer,
         input_columns=input1_columns,
         input_to_compare_with_layer=input2_layer,
         output_layer=output_layer,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def export_by_distance(
@@ -1354,14 +1562,15 @@
     output_path: Union[str, "os.PathLike[Any]"],
     max_distance: float,
     input1_layer: Optional[str] = None,
     input1_columns: Optional[List[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Exports all features in input_to_select_from_path that are within the
     distance specified of any features in input_to_compare_with_path.
@@ -1380,23 +1589,31 @@
         input2_layer (str, optional): input layer name. Optional if the
             file only contains one layer.
         output_layer (str, optional): output layer name. Optional if the
             file only contains one layer.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start export_by_distance: select from {input_to_select_from_path} within "
         f"max_distance of {max_distance} from {input_to_compare_with_path} "
         f"to {output_path}"
     )
     return _geoops_sql.export_by_distance(
         input_to_select_from_path=Path(input_to_select_from_path),
@@ -1404,14 +1621,15 @@
         output_path=Path(output_path),
         max_distance=max_distance,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input2_layer=input2_layer,
         output_layer=output_layer,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def intersect(
@@ -1464,14 +1682,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Calculate the pairwise intersection of alle features in input1 with all
     features in input2.
@@ -1502,23 +1721,31 @@
         output_layer (str, optional): output layer name. If None, the output_path stem
             is used. Defaults to None.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start intersection between {input1_path} and {input2_path} to {output_path}"
     )
     return _geoops_sql.intersection(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
@@ -1527,14 +1754,15 @@
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def join_by_location(
@@ -1549,14 +1777,15 @@
     input1_columns: Optional[List[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Joins all features in input1 with all features in input2.
 
@@ -1613,23 +1842,31 @@
         input2_columns_prefix (str, optional): prefix to use in the column aliases.
             Defaults to "l2_".
         output_layer (str, optional): output layer name. If None, the output_path stem
             is used. Defaults to None.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start join_by_location: select from {input1_path} joined with "
         f"{input2_path} to {output_path}"
     )
     return _geoops_sql.join_by_location(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
@@ -1643,14 +1880,15 @@
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=False,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def join_nearest(
@@ -1745,14 +1983,15 @@
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Executes the sqlite query specified on the 2 input layers specified.
 
@@ -1855,14 +2094,17 @@
             singular ones after the dissolve. Defaults to False.
         force_output_geometrytype (GeometryType, optional): The output geometry
             type to force. Defaults to None, and then the geometry type of the
             input1 layer is used.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
@@ -1872,18 +2114,14 @@
 
     An ideal place to get inspiration to write you own advanced queries
     is in the following source code file: |geofileops_sql_link|.
 
     Additionally, there are some examples listed here that highlight
     other features/possibilities.
 
-    .. |geofileops_sql_link| raw:: html
-
-        <a href="https://github.com/geofileops/geofileops/blob/main/geofileops/util/geofileops_sql.py" target="_blank">geofileops_sql.py</a>
-
     *Join nearest features*
 
     For each feature in layer1, get the nearest feature of layer2 with the
     same values for the column join_id.
 
         .. code-block:: sqlite3
 
@@ -1899,15 +2137,24 @@
                 )
             SELECT *
               FROM join_with_dist jwd
              WHERE distance = (
                    SELECT MIN(distance) FROM join_with_dist jwd_sub
                     WHERE jwd_sub.l1_join_id = jwd.l1_join_id)
              ORDER BY distance DESC
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    .. |geofileops_sql_link| raw:: html
+
+        <a href="https://github.com/geofileops/geofileops/blob/main/geofileops/util/geofileops_sql.py" target="_blank">geofileops_sql.py</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start select_two_layers: select from {input1_path} and {input2_path} "
         f"to {output_path}"
     )
     return _geoops_sql.select_two_layers(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
@@ -1919,14 +2166,15 @@
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def symmetric_difference(
@@ -1938,14 +2186,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Calculates the "symmetric difference" of the two input layers.
 
@@ -1976,24 +2225,32 @@
         output_layer (str, optional): output layer name. If None, the output_path stem
             is used. Defaults to None.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduc
             e the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start symmetric_difference of {input1_path} and {input2_path} "
         f"to {output_path}"
     )
     return _geoops_sql.symmetric_difference(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
@@ -2003,14 +2260,15 @@
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def split(
@@ -2022,14 +2280,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Split the features in input1 with all features in input2.
 
@@ -2063,37 +2322,46 @@
         output_layer (str, optional): output layer name. If None, the output_path stem
             is used. Defaults to None.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(f"Start split between {input1_path} and {input2_path} to {output_path}")
     return _geoops_sql.split(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def union(
@@ -2105,14 +2373,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Calculates the pairwise "union" of the two input layers.
 
@@ -2142,23 +2411,31 @@
         output_layer (str, optional): output layer name. If None, the output_path stem
             is used. Defaults to None.
         explodecollections (bool, optional): True to convert all multi-geometries to
             singular ones after the dissolve. Defaults to False.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available processors.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     logger.info(
         f"Start union: select from {input1_path} and {input2_path} to {output_path}"
     )
     return _geoops_sql.union(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
@@ -2167,11 +2444,12 @@
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
```

### Comparing `geofileops-0.8.0a5/geofileops/helpers/_parameter_helper.py` & `geofileops-0.8.0a6/geofileops/helpers/_parameter_helper.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/helpers/layerstyles.py` & `geofileops-0.8.0a6/geofileops/helpers/layerstyles.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_general_util.py` & `geofileops-0.8.0a6/geofileops/util/_general_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_geoops_gpd.py` & `geofileops-0.8.0a6/geofileops/util/_geoops_gpd.py`

 * *Files 3% similar despite different names*

```diff
@@ -53,4496 +53,4985 @@
 00000340: 656f 7073 2e75 7469 6c20 696d 706f 7274  eops.util import
 00000350: 205f 6765 6e65 7261 6c5f 7574 696c 0a66   _general_util.f
 00000360: 726f 6d20 6765 6f66 696c 656f 7073 2e75  rom geofileops.u
 00000370: 7469 6c20 696d 706f 7274 205f 6765 6f6f  til import _geoo
 00000380: 7073 5f73 716c 0a66 726f 6d20 6765 6f66  ps_sql.from geof
 00000390: 696c 656f 7073 2e75 7469 6c20 696d 706f  ileops.util impo
 000003a0: 7274 205f 696f 5f75 7469 6c0a 6672 6f6d  rt _io_util.from
-000003b0: 2067 656f 6669 6c65 6f70 732e 6865 6c70   geofileops.help
-000003c0: 6572 7320 696d 706f 7274 205f 7061 7261  ers import _para
-000003d0: 6d65 7465 725f 6865 6c70 6572 0a66 726f  meter_helper.fro
-000003e0: 6d20 6765 6f66 696c 656f 7073 2e75 7469  m geofileops.uti
-000003f0: 6c20 696d 706f 7274 205f 7072 6f63 6573  l import _proces
-00000400: 7369 6e67 5f75 7469 6c0a 6672 6f6d 2067  sing_util.from g
-00000410: 656f 6669 6c65 6f70 732e 7574 696c 2e67  eofileops.util.g
-00000420: 656f 6d65 7472 795f 7574 696c 2069 6d70  eometry_util imp
-00000430: 6f72 7420 4765 6f6d 6574 7279 5479 7065  ort GeometryType
-00000440: 2c20 5072 696d 6974 6976 6554 7970 652c  , PrimitiveType,
-00000450: 2053 696d 706c 6966 7941 6c67 6f72 6974   SimplifyAlgorit
-00000460: 686d 0a66 726f 6d20 6765 6f66 696c 656f  hm.from geofileo
-00000470: 7073 2e75 7469 6c2e 6765 6f6d 6574 7279  ps.util.geometry
-00000480: 5f75 7469 6c20 696d 706f 7274 2042 7566  _util import Buf
-00000490: 6665 7245 6e64 4361 7053 7479 6c65 2c20  ferEndCapStyle, 
-000004a0: 4275 6666 6572 4a6f 696e 5374 796c 650a  BufferJoinStyle.
-000004b0: 6672 6f6d 2067 656f 6669 6c65 6f70 732e  from geofileops.
-000004c0: 7574 696c 2069 6d70 6f72 7420 6765 6f73  util import geos
-000004d0: 6572 6965 735f 7574 696c 0a66 726f 6d20  eries_util.from 
-000004e0: 6765 6f66 696c 656f 7073 2e75 7469 6c20  geofileops.util 
-000004f0: 696d 706f 7274 2067 7269 645f 7574 696c  import grid_util
-00000500: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
-00000510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000003b0: 2067 656f 6669 6c65 6f70 732e 7574 696c   geofileops.util
+000003c0: 2069 6d70 6f72 7420 5f6f 6772 5f75 7469   import _ogr_uti
+000003d0: 6c0a 6672 6f6d 2067 656f 6669 6c65 6f70  l.from geofileop
+000003e0: 732e 6865 6c70 6572 7320 696d 706f 7274  s.helpers import
+000003f0: 205f 7061 7261 6d65 7465 725f 6865 6c70   _parameter_help
+00000400: 6572 0a66 726f 6d20 6765 6f66 696c 656f  er.from geofileo
+00000410: 7073 2e75 7469 6c20 696d 706f 7274 205f  ps.util import _
+00000420: 7072 6f63 6573 7369 6e67 5f75 7469 6c0a  processing_util.
+00000430: 6672 6f6d 2067 656f 6669 6c65 6f70 732e  from geofileops.
+00000440: 7574 696c 2e67 656f 6d65 7472 795f 7574  util.geometry_ut
+00000450: 696c 2069 6d70 6f72 7420 4765 6f6d 6574  il import Geomet
+00000460: 7279 5479 7065 2c20 5072 696d 6974 6976  ryType, Primitiv
+00000470: 6554 7970 652c 2053 696d 706c 6966 7941  eType, SimplifyA
+00000480: 6c67 6f72 6974 686d 0a66 726f 6d20 6765  lgorithm.from ge
+00000490: 6f66 696c 656f 7073 2e75 7469 6c2e 6765  ofileops.util.ge
+000004a0: 6f6d 6574 7279 5f75 7469 6c20 696d 706f  ometry_util impo
+000004b0: 7274 2042 7566 6665 7245 6e64 4361 7053  rt BufferEndCapS
+000004c0: 7479 6c65 2c20 4275 6666 6572 4a6f 696e  tyle, BufferJoin
+000004d0: 5374 796c 650a 6672 6f6d 2067 656f 6669  Style.from geofi
+000004e0: 6c65 6f70 732e 7574 696c 2069 6d70 6f72  leops.util impor
+000004f0: 7420 6765 6f73 6572 6965 735f 7574 696c  t geoseries_util
+00000500: 0a66 726f 6d20 6765 6f66 696c 656f 7073  .from geofileops
+00000510: 2e75 7469 6c20 696d 706f 7274 2067 7269  .util import gri
+00000520: 645f 7574 696c 0a0a 2323 2323 2323 2323  d_util..########
 00000530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000550: 2323 0a23 2053 6f6d 6520 696e 6974 0a23  ##.# Some init.#
+00000550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000570: 2323 2323 2323 2323 0a23 2053 6f6d 6520  ########.# Some 
+00000580: 696e 6974 0a23 2323 2323 2323 2323 2323  init.###########
 00000590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000005a0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-000005b0: 0a23 2044 6f6e 2774 2073 686f 7720 7468  .# Don't show th
-000005c0: 6973 2067 656f 7061 6e64 6173 2077 6172  is geopandas war
-000005d0: 6e69 6e67 2e2e 2e0a 7761 726e 696e 6773  ning....warnings
-000005e0: 2e66 696c 7465 7277 6172 6e69 6e67 7328  .filterwarnings(
-000005f0: 2269 676e 6f72 6522 2c20 2247 656f 5365  "ignore", "GeoSe
-00000600: 7269 6573 2e69 736e 6122 2c20 5573 6572  ries.isna", User
-00000610: 5761 726e 696e 6729 0a0a 6c6f 6767 6572  Warning)..logger
-00000620: 203d 206c 6f67 6769 6e67 2e67 6574 4c6f   = logging.getLo
-00000630: 6767 6572 285f 5f6e 616d 655f 5f29 0a0a  gger(__name__)..
-00000640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005d0: 2323 2323 230a 0a23 2044 6f6e 2774 2073  #####..# Don't s
+000005e0: 686f 7720 7468 6973 2067 656f 7061 6e64  how this geopand
+000005f0: 6173 2077 6172 6e69 6e67 2e2e 2e0a 7761  as warning....wa
+00000600: 726e 696e 6773 2e66 696c 7465 7277 6172  rnings.filterwar
+00000610: 6e69 6e67 7328 2269 676e 6f72 6522 2c20  nings("ignore", 
+00000620: 2247 656f 5365 7269 6573 2e69 736e 6122  "GeoSeries.isna"
+00000630: 2c20 5573 6572 5761 726e 696e 6729 0a0a  , UserWarning)..
+00000640: 6c6f 6767 6572 203d 206c 6f67 6769 6e67  logger = logging
+00000650: 2e67 6574 4c6f 6767 6572 285f 5f6e 616d  .getLogger(__nam
+00000660: 655f 5f29 0a0a 2323 2323 2323 2323 2323  e__)..##########
 00000670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000690: 0a23 2053 6f6d 6520 6865 6c70 6572 2066  .# Some helper f
-000006a0: 756e 6374 696f 6e73 0a23 2323 2323 2323  unctions.#######
-000006b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000006c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000006a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000006b0: 2323 2323 2323 0a23 2053 6f6d 6520 6865  ######.# Some he
+000006c0: 6c70 6572 2066 756e 6374 696f 6e73 0a23  lper functions.#
 000006d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000006e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000006f0: 2323 2323 2323 2323 230a 0a0a 636c 6173  #########...clas
-00000700: 7320 5061 7261 6c6c 656c 697a 6174 696f  s Parallelizatio
-00000710: 6e43 6f6e 6669 673a 0a20 2020 2064 6566  nConfig:.    def
-00000720: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
-00000730: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00000740: 2062 7974 6573 5f62 6173 6566 6f6f 7470   bytes_basefootp
-00000750: 7269 6e74 3a20 696e 7420 3d20 3530 202a  rint: int = 50 *
-00000760: 2031 3032 3420 2a20 3130 3234 2c0a 2020   1024 * 1024,.  
-00000770: 2020 2020 2020 6279 7465 735f 7065 725f        bytes_per_
-00000780: 726f 773a 2069 6e74 203d 2031 3030 2c0a  row: int = 100,.
-00000790: 2020 2020 2020 2020 6d69 6e5f 6176 675f          min_avg_
-000007a0: 726f 7773 5f70 6572 5f62 6174 6368 3a20  rows_per_batch: 
-000007b0: 696e 7420 3d20 3130 3030 2c0a 2020 2020  int = 1000,.    
-000007c0: 2020 2020 6d61 785f 6176 675f 726f 7773      max_avg_rows
-000007d0: 5f70 6572 5f62 6174 6368 3a20 696e 7420  _per_batch: int 
-000007e0: 3d20 3130 3030 302c 0a20 2020 2020 2020  = 10000,.       
-000007f0: 2062 7974 6573 5f6d 696e 5f70 6572 5f70   bytes_min_per_p
-00000800: 726f 6365 7373 3d4e 6f6e 652c 0a20 2020  rocess=None,.   
-00000810: 2020 2020 2062 7974 6573 5f75 7361 626c       bytes_usabl
-00000820: 653d 4e6f 6e65 2c0a 2020 2020 293a 0a20  e=None,.    ):. 
-00000830: 2020 2020 2020 2073 656c 662e 6279 7465         self.byte
-00000840: 735f 6261 7365 666f 6f74 7072 696e 7420  s_basefootprint 
-00000850: 3d20 6279 7465 735f 6261 7365 666f 6f74  = bytes_basefoot
-00000860: 7072 696e 740a 2020 2020 2020 2020 7365  print.        se
-00000870: 6c66 2e62 7974 6573 5f70 6572 5f72 6f77  lf.bytes_per_row
-00000880: 203d 2062 7974 6573 5f70 6572 5f72 6f77   = bytes_per_row
-00000890: 0a20 2020 2020 2020 2073 656c 662e 6d69  .        self.mi
-000008a0: 6e5f 6176 675f 726f 7773 5f70 6572 5f62  n_avg_rows_per_b
-000008b0: 6174 6368 203d 206d 696e 5f61 7667 5f72  atch = min_avg_r
-000008c0: 6f77 735f 7065 725f 6261 7463 680a 2020  ows_per_batch.  
-000008d0: 2020 2020 2020 7365 6c66 2e6d 6178 5f61        self.max_a
-000008e0: 7667 5f72 6f77 735f 7065 725f 6261 7463  vg_rows_per_batc
-000008f0: 6820 3d20 6d61 785f 6176 675f 726f 7773  h = max_avg_rows
-00000900: 5f70 6572 5f62 6174 6368 0a20 2020 2020  _per_batch.     
-00000910: 2020 2069 6620 6279 7465 735f 6d69 6e5f     if bytes_min_
-00000920: 7065 725f 7072 6f63 6573 7320 6973 204e  per_process is N
-00000930: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00000940: 2073 656c 662e 6279 7465 735f 6d69 6e5f   self.bytes_min_
-00000950: 7065 725f 7072 6f63 6573 7320 3d20 280a  per_process = (.
-00000960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000970: 6279 7465 735f 6261 7365 666f 6f74 7072  bytes_basefootpr
-00000980: 696e 7420 2b20 6279 7465 735f 7065 725f  int + bytes_per_
-00000990: 726f 7720 2a20 6d69 6e5f 6176 675f 726f  row * min_avg_ro
-000009a0: 7773 5f70 6572 5f62 6174 6368 0a20 2020  ws_per_batch.   
-000009b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000009c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000009d0: 2020 2020 2073 656c 662e 6279 7465 735f       self.bytes_
-000009e0: 6d69 6e5f 7065 725f 7072 6f63 6573 7320  min_per_process 
-000009f0: 3d20 6279 7465 735f 6d69 6e5f 7065 725f  = bytes_min_per_
-00000a00: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-00000a10: 6966 2062 7974 6573 5f75 7361 626c 6520  if bytes_usable 
-00000a20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00000a30: 2020 2020 2073 656c 662e 6279 7465 735f       self.bytes_
-00000a40: 7573 6162 6c65 203d 2070 7375 7469 6c2e  usable = psutil.
-00000a50: 7669 7274 7561 6c5f 6d65 6d6f 7279 2829  virtual_memory()
-00000a60: 2e61 7661 696c 6162 6c65 202a 2030 2e39  .available * 0.9
-00000a70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00000a80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000a90: 6279 7465 735f 7573 6162 6c65 203d 2062  bytes_usable = b
-00000aa0: 7974 6573 5f75 7361 626c 650a 0a0a 7061  ytes_usable...pa
-00000ab0: 7261 6c6c 656c 697a 6174 696f 6e50 6172  rallelizationPar
-00000ac0: 616d 7320 3d20 4e61 6d65 6454 7570 6c65  ams = NamedTuple
-00000ad0: 280a 2020 2020 2272 6573 756c 7422 2c0a  (.    "result",.
-00000ae0: 2020 2020 5b28 226e 625f 7061 7261 6c6c      [("nb_parall
-00000af0: 656c 222c 2069 6e74 292c 2028 226e 625f  el", int), ("nb_
-00000b00: 6261 7463 6865 735f 7265 636f 6d6d 656e  batches_recommen
-00000b10: 6465 6422 2c20 696e 7429 2c20 2822 6e62  ded", int), ("nb
-00000b20: 5f72 6f77 735f 7065 725f 6261 7463 6822  _rows_per_batch"
-00000b30: 2c20 696e 7429 5d2c 0a29 0a0a 0a64 6566  , int)],.)...def
-00000b40: 2067 6574 5f70 6172 616c 6c65 6c69 7a61   get_paralleliza
-00000b50: 7469 6f6e 5f70 6172 616d 7328 0a20 2020  tion_params(.   
-00000b60: 206e 625f 726f 7773 5f74 6f74 616c 3a20   nb_rows_total: 
-00000b70: 696e 742c 0a20 2020 206e 625f 7061 7261  int,.    nb_para
-00000b80: 6c6c 656c 3a20 696e 7420 3d20 2d31 2c0a  llel: int = -1,.
-00000b90: 2020 2020 6e62 5f62 6174 6368 6573 5f70      nb_batches_p
-00000ba0: 7265 7669 6f75 735f 7061 7373 3a20 4f70  revious_pass: Op
-00000bb0: 7469 6f6e 616c 5b69 6e74 5d20 3d20 4e6f  tional[int] = No
-00000bc0: 6e65 2c0a 2020 2020 7061 7261 6c6c 656c  ne,.    parallel
-00000bd0: 697a 6174 696f 6e5f 636f 6e66 6967 3a20  ization_config: 
-00000be0: 4f70 7469 6f6e 616c 5b50 6172 616c 6c65  Optional[Paralle
-00000bf0: 6c69 7a61 7469 6f6e 436f 6e66 6967 5d20  lizationConfig] 
-00000c00: 3d20 4e6f 6e65 2c0a 2920 2d3e 2070 6172  = None,.) -> par
-00000c10: 616c 6c65 6c69 7a61 7469 6f6e 5061 7261  allelizationPara
-00000c20: 6d73 3a0a 2020 2020 2222 220a 2020 2020  ms:.    """.    
-00000c30: 4465 7465 726d 696e 6573 2072 6563 6f6d  Determines recom
-00000c40: 6d65 6e64 6564 2070 6172 616c 6c65 6c69  mended paralleli
-00000c50: 7a61 7469 6f6e 2070 6172 616d 732e 0a0a  zation params...
-00000c60: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00000c70: 2020 6e62 5f72 6f77 735f 746f 7461 6c20    nb_rows_total 
-00000c80: 2869 6e74 293a 2054 6865 2074 6f74 616c  (int): The total
-00000c90: 206e 756d 6265 7220 6f66 2072 6f77 7320   number of rows 
-00000ca0: 7468 6174 2077 696c 6c20 6265 2070 726f  that will be pro
-00000cb0: 6365 7373 6564 0a20 2020 2020 2020 206e  cessed.        n
-00000cc0: 625f 7061 7261 6c6c 656c 2028 696e 742c  b_parallel (int,
-00000cd0: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
-00000ce0: 6c65 7665 6c20 6f66 2070 6172 616c 6c65  level of paralle
-00000cf0: 6c69 7a61 7469 6f6e 2072 6571 7565 7374  lization request
-00000d00: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00000d10: 4966 202d 312c 2074 7269 6573 2074 6f20  If -1, tries to 
-00000d20: 7573 6520 616c 6c20 7265 736f 7572 6365  use all resource
-00000d30: 7320 6176 6169 6c61 626c 652e 2044 6566  s available. Def
-00000d40: 6175 6c74 7320 746f 202d 312e 0a20 2020  aults to -1..   
-00000d50: 2020 2020 206e 625f 6261 7463 6865 735f       nb_batches_
-00000d60: 7072 6576 696f 7573 5f70 6173 7320 2869  previous_pass (i
-00000d70: 6e74 2c20 6f70 7469 6f6e 616c 293a 2049  nt, optional): I
-00000d80: 6620 6170 706c 6963 6162 6c65 2c20 7468  f applicable, th
-00000d90: 6520 6e75 6d62 6572 206f 6620 6261 7463  e number of batc
-00000da0: 6865 730a 2020 2020 2020 2020 2020 2020  hes.            
-00000db0: 7573 6564 2069 6e20 6120 7072 6576 696f  used in a previo
-00000dc0: 7573 2070 6173 7320 6f66 2074 6865 2063  us pass of the c
-00000dd0: 616c 6375 6c61 7469 6f6e 2e20 4465 6661  alculation. Defa
-00000de0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 0a20  ults to None... 
-00000df0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00000e00: 2020 2020 7061 7261 6c6c 656c 697a 6174      parallelizat
-00000e10: 696f 6e50 6172 616d 733a 2054 6865 2072  ionParams: The r
-00000e20: 6563 6f6d 6d65 6e64 6564 2070 6172 616d  ecommended param
-00000e30: 6574 6572 732e 0a20 2020 2022 2222 0a20  eters..    """. 
-00000e40: 2020 2023 2049 6e69 7420 7061 7261 6c6c     # Init parall
-00000e50: 656c 697a 6174 696f 6e20 636f 6e66 6967  elization config
-00000e60: 0a0a 2020 2020 2320 4966 2063 6f6e 6669  ..    # If confi
-00000e70: 6720 6973 204e 6f6e 652c 2073 6574 2074  g is None, set t
-00000e80: 6f20 656d 7074 7920 6469 6374 0a20 2020  o empty dict.   
-00000e90: 2069 6620 7061 7261 6c6c 656c 697a 6174   if parallelizat
-00000ea0: 696f 6e5f 636f 6e66 6967 2069 7320 6e6f  ion_config is no
-00000eb0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00000ec0: 7061 7261 6c6c 656c 697a 6174 696f 6e5f  parallelization_
-00000ed0: 636f 6e66 6967 5f6c 6f63 616c 203d 2070  config_local = p
-00000ee0: 6172 616c 6c65 6c69 7a61 7469 6f6e 5f63  arallelization_c
-00000ef0: 6f6e 6669 670a 2020 2020 656c 7365 3a0a  onfig.    else:.
-00000f00: 2020 2020 2020 2020 7061 7261 6c6c 656c          parallel
-00000f10: 697a 6174 696f 6e5f 636f 6e66 6967 5f6c  ization_config_l
-00000f20: 6f63 616c 203d 2050 6172 616c 6c65 6c69  ocal = Paralleli
-00000f30: 7a61 7469 6f6e 436f 6e66 6967 2829 0a0a  zationConfig()..
-00000f40: 2020 2020 2320 4966 2074 6865 206e 756d      # If the num
-00000f50: 6265 7220 6f66 2072 6f77 7320 6973 2072  ber of rows is r
-00000f60: 6561 6c6c 7920 6c6f 772c 206a 7573 7420  eally low, just 
-00000f70: 7573 6520 6f6e 6520 6261 7463 680a 2020  use one batch.  
-00000f80: 2020 2320 544f 444f 3a20 666f 7220 7665    # TODO: for ve
-00000f90: 7279 2063 6f6d 706c 6578 2066 6561 7475  ry complex featu
-00000fa0: 7265 732c 2070 6f73 7369 626c 7920 7468  res, possibly th
-00000fb0: 6973 206c 696d 6974 2069 7320 6e6f 7420  is limit is not 
-00000fc0: 6120 676f 6f64 2069 6465 610a 2020 2020  a good idea.    
-00000fd0: 6966 206e 625f 726f 7773 5f74 6f74 616c  if nb_rows_total
-00000fe0: 203c 2070 6172 616c 6c65 6c69 7a61 7469   < parallelizati
-00000ff0: 6f6e 5f63 6f6e 6669 675f 6c6f 6361 6c2e  on_config_local.
-00001000: 6d69 6e5f 6176 675f 726f 7773 5f70 6572  min_avg_rows_per
-00001010: 5f62 6174 6368 3a0a 2020 2020 2020 2020  _batch:.        
-00001020: 7265 7475 726e 2070 6172 616c 6c65 6c69  return paralleli
-00001030: 7a61 7469 6f6e 5061 7261 6d73 2831 2c20  zationParams(1, 
-00001040: 312c 206e 625f 726f 7773 5f74 6f74 616c  1, nb_rows_total
-00001050: 290a 0a20 2020 2069 6620 6e62 5f70 6172  )..    if nb_par
-00001060: 616c 6c65 6c20 3d3d 202d 313a 0a20 2020  allel == -1:.   
-00001070: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
-00001080: 203d 206d 756c 7469 7072 6f63 6573 7369   = multiprocessi
-00001090: 6e67 2e63 7075 5f63 6f75 6e74 2829 0a0a  ng.cpu_count()..
-000010a0: 2020 2020 6d65 6d5f 7573 6162 6c65 203d      mem_usable =
-000010b0: 205f 6765 6e65 7261 6c5f 7574 696c 2e66   _general_util.f
-000010c0: 6f72 6d61 7462 7974 6573 2870 6172 616c  ormatbytes(paral
-000010d0: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-000010e0: 675f 6c6f 6361 6c2e 6279 7465 735f 7573  g_local.bytes_us
-000010f0: 6162 6c65 290a 2020 2020 6c6f 6767 6572  able).    logger
-00001100: 2e64 6562 7567 2866 226d 656d 6f72 795f  .debug(f"memory_
-00001110: 7573 6162 6c65 3a20 7b6d 656d 5f75 7361  usable: {mem_usa
-00001120: 626c 657d 2c20 7769 7468 3a22 290a 2020  ble}, with:").  
-00001130: 2020 6d65 6d5f 6176 6169 6c61 626c 6520    mem_available 
-00001140: 3d20 5f67 656e 6572 616c 5f75 7469 6c2e  = _general_util.
-00001150: 666f 726d 6174 6279 7465 7328 7073 7574  formatbytes(psut
-00001160: 696c 2e76 6972 7475 616c 5f6d 656d 6f72  il.virtual_memor
-00001170: 7928 292e 6176 6169 6c61 626c 6529 0a20  y().available). 
-00001180: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00001190: 6622 2020 2d3e 206d 656d 2e61 7661 696c  f"  -> mem.avail
-000011a0: 6162 6c65 3a20 7b6d 656d 5f61 7661 696c  able: {mem_avail
-000011b0: 6162 6c65 7d22 290a 2020 2020 7377 6170  able}").    swap
-000011c0: 5f66 7265 6520 3d20 5f67 656e 6572 616c  _free = _general
-000011d0: 5f75 7469 6c2e 666f 726d 6174 6279 7465  _util.formatbyte
-000011e0: 7328 7073 7574 696c 2e73 7761 705f 6d65  s(psutil.swap_me
-000011f0: 6d6f 7279 2829 2e66 7265 6529 0a20 2020  mory().free).   
-00001200: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
-00001210: 2020 2d3e 2073 7761 702e 6672 6565 3a20    -> swap.free: 
-00001220: 7b73 7761 705f 6672 6565 7d22 290a 0a20  {swap_free}").. 
-00001230: 2020 2023 2049 6620 6e6f 7420 656e 6f75     # If not enou
-00001240: 6768 206d 656d 6f72 7920 666f 7220 7468  gh memory for th
-00001250: 6520 616d 6f75 6e74 206f 6620 7061 7261  e amount of para
-00001260: 6c6c 656c 6c69 736d 2061 736b 6564 2c20  llellism asked, 
-00001270: 7265 6475 6365 0a20 2020 2069 6620 280a  reduce.    if (.
-00001280: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
-00001290: 6c65 6c20 2a20 7061 7261 6c6c 656c 697a  lel * paralleliz
-000012a0: 6174 696f 6e5f 636f 6e66 6967 5f6c 6f63  ation_config_loc
-000012b0: 616c 2e62 7974 6573 5f6d 696e 5f70 6572  al.bytes_min_per
-000012c0: 5f70 726f 6365 7373 0a20 2020 2029 203e  _process.    ) >
-000012d0: 2070 6172 616c 6c65 6c69 7a61 7469 6f6e   parallelization
-000012e0: 5f63 6f6e 6669 675f 6c6f 6361 6c2e 6279  _config_local.by
-000012f0: 7465 735f 7573 6162 6c65 3a0a 2020 2020  tes_usable:.    
-00001300: 2020 2020 6e62 5f70 6172 616c 6c65 6c20      nb_parallel 
-00001310: 3d20 696e 7428 0a20 2020 2020 2020 2020  = int(.         
-00001320: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
-00001330: 6f6e 5f63 6f6e 6669 675f 6c6f 6361 6c2e  on_config_local.
-00001340: 6279 7465 735f 7573 6162 6c65 0a20 2020  bytes_usable.   
-00001350: 2020 2020 2020 2020 202f 2070 6172 616c           / paral
-00001360: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-00001370: 675f 6c6f 6361 6c2e 6279 7465 735f 6d69  g_local.bytes_mi
-00001380: 6e5f 7065 725f 7072 6f63 6573 730a 2020  n_per_process.  
-00001390: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000013a0: 6c6f 6767 6572 2e64 6562 7567 2866 224e  logger.debug(f"N
-000013b0: 625f 7061 7261 6c6c 656c 2072 6564 7563  b_parallel reduc
-000013c0: 6564 2074 6f20 7b6e 625f 7061 7261 6c6c  ed to {nb_parall
-000013d0: 656c 7d20 746f 2072 6564 7563 6520 6d65  el} to reduce me
-000013e0: 6d6f 7279 2075 7361 6765 2229 0a0a 2020  mory usage")..  
-000013f0: 2020 2320 4f70 7469 6d61 6c20 6e75 6d62    # Optimal numb
-00001400: 6572 206f 6620 6261 7463 6865 7320 616e  er of batches an
-00001410: 6420 726f 7773 2070 6572 2062 6174 6368  d rows per batch
-00001420: 2062 6173 6564 206f 6e20 6d65 6d6f 7279   based on memory
-00001430: 2075 7361 6765 0a20 2020 206e 625f 6261   usage.    nb_ba
-00001440: 7463 6865 7320 3d20 6d61 7468 2e63 6569  tches = math.cei
-00001450: 6c28 0a20 2020 2020 2020 2028 6e62 5f72  l(.        (nb_r
-00001460: 6f77 735f 746f 7461 6c20 2a20 7061 7261  ows_total * para
-00001470: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
-00001480: 6967 5f6c 6f63 616c 2e62 7974 6573 5f70  ig_local.bytes_p
-00001490: 6572 5f72 6f77 202a 206e 625f 7061 7261  er_row * nb_para
-000014a0: 6c6c 656c 290a 2020 2020 2020 2020 2f20  llel).        / 
-000014b0: 280a 2020 2020 2020 2020 2020 2020 7061  (.            pa
-000014c0: 7261 6c6c 656c 697a 6174 696f 6e5f 636f  rallelization_co
-000014d0: 6e66 6967 5f6c 6f63 616c 2e62 7974 6573  nfig_local.bytes
-000014e0: 5f75 7361 626c 650a 2020 2020 2020 2020  _usable.        
-000014f0: 2020 2020 2d20 7061 7261 6c6c 656c 697a      - paralleliz
-00001500: 6174 696f 6e5f 636f 6e66 6967 5f6c 6f63  ation_config_loc
-00001510: 616c 2e62 7974 6573 5f62 6173 6566 6f6f  al.bytes_basefoo
-00001520: 7470 7269 6e74 202a 206e 625f 7061 7261  tprint * nb_para
-00001530: 6c6c 656c 0a20 2020 2020 2020 2029 0a20  llel.        ). 
-00001540: 2020 2029 0a0a 2020 2020 2320 4d61 6b65     )..    # Make
-00001550: 2073 7572 6520 7468 6520 6176 6572 6167   sure the averag
-00001560: 6520 6261 7463 6820 646f 6573 6e27 7420  e batch doesn't 
-00001570: 636f 6e74 6169 6e20 3e20 6d61 785f 6176  contain > max_av
-00001580: 675f 726f 7773 5f70 6572 5f62 6174 6368  g_rows_per_batch
-00001590: 0a20 2020 2062 6174 6368 5f73 697a 6520  .    batch_size 
-000015a0: 3d20 6d61 7468 2e63 6569 6c28 6e62 5f72  = math.ceil(nb_r
-000015b0: 6f77 735f 746f 7461 6c20 2f20 6e62 5f62  ows_total / nb_b
-000015c0: 6174 6368 6573 290a 2020 2020 6966 2062  atches).    if b
-000015d0: 6174 6368 5f73 697a 6520 3e20 7061 7261  atch_size > para
-000015e0: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
-000015f0: 6967 5f6c 6f63 616c 2e6d 6178 5f61 7667  ig_local.max_avg
-00001600: 5f72 6f77 735f 7065 725f 6261 7463 683a  _rows_per_batch:
-00001610: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
-00001620: 697a 6520 3d20 7061 7261 6c6c 656c 697a  ize = paralleliz
-00001630: 6174 696f 6e5f 636f 6e66 6967 5f6c 6f63  ation_config_loc
-00001640: 616c 2e6d 6178 5f61 7667 5f72 6f77 735f  al.max_avg_rows_
-00001650: 7065 725f 6261 7463 680a 2020 2020 2020  per_batch.      
-00001660: 2020 6e62 5f62 6174 6368 6573 203d 206d    nb_batches = m
-00001670: 6174 682e 6365 696c 286e 625f 726f 7773  ath.ceil(nb_rows
-00001680: 5f74 6f74 616c 202f 2062 6174 6368 5f73  _total / batch_s
-00001690: 697a 6529 0a0a 2020 2020 6d65 6d5f 7072  ize)..    mem_pr
-000016a0: 6564 6963 7465 6420 3d20 280a 2020 2020  edicted = (.    
-000016b0: 2020 2020 7061 7261 6c6c 656c 697a 6174      parallelizat
-000016c0: 696f 6e5f 636f 6e66 6967 5f6c 6f63 616c  ion_config_local
-000016d0: 2e62 7974 6573 5f62 6173 6566 6f6f 7470  .bytes_basefootp
-000016e0: 7269 6e74 0a20 2020 2020 2020 202b 2062  rint.        + b
-000016f0: 6174 6368 5f73 697a 6520 2a20 7061 7261  atch_size * para
-00001700: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
-00001710: 6967 5f6c 6f63 616c 2e62 7974 6573 5f70  ig_local.bytes_p
-00001720: 6572 5f72 6f77 0a20 2020 2029 202a 206e  er_row.    ) * n
-00001730: 625f 6261 7463 6865 730a 0a20 2020 2023  b_batches..    #
-00001740: 204d 616b 6520 7375 7265 2074 6865 7265   Make sure there
-00001750: 2061 7265 2065 6e6f 7567 6820 6261 7463   are enough batc
-00001760: 6865 7320 746f 2075 7365 2061 7320 6d75  hes to use as mu
-00001770: 6368 2070 6172 616c 6c65 6c69 736d 2061  ch parallelism a
-00001780: 7320 706f 7373 6962 6c65 0a20 2020 2069  s possible.    i
-00001790: 6620 6e62 5f62 6174 6368 6573 203e 2031  f nb_batches > 1
-000017a0: 2061 6e64 206e 625f 6261 7463 6865 7320   and nb_batches 
-000017b0: 3c20 6e62 5f70 6172 616c 6c65 6c3a 0a20  < nb_parallel:. 
-000017c0: 2020 2020 2020 206d 6178 5f70 6172 616c         max_paral
-000017d0: 6c65 6c5f 6261 7463 6873 697a 6520 3d20  lel_batchsize = 
-000017e0: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-000017f0: 2070 6172 616c 6c65 6c69 7a61 7469 6f6e   parallelization
-00001800: 5f63 6f6e 6669 675f 6c6f 6361 6c2e 6d61  _config_local.ma
-00001810: 785f 6176 675f 726f 7773 5f70 6572 5f62  x_avg_rows_per_b
-00001820: 6174 6368 0a20 2020 2020 2020 2020 2020  atch.           
-00001830: 202a 206e 625f 6261 7463 6865 730a 2020   * nb_batches.  
-00001840: 2020 2020 2020 2020 2020 2f20 6261 7463            / batc
-00001850: 685f 7369 7a65 0a20 2020 2020 2020 2029  h_size.        )
-00001860: 0a20 2020 2020 2020 206e 625f 7061 7261  .        nb_para
-00001870: 6c6c 656c 203d 206d 696e 286d 6178 5f70  llel = min(max_p
-00001880: 6172 616c 6c65 6c5f 6261 7463 6873 697a  arallel_batchsiz
-00001890: 652c 206e 625f 7061 7261 6c6c 656c 290a  e, nb_parallel).
-000018a0: 2020 2020 2020 2020 6966 206e 625f 6261          if nb_ba
-000018b0: 7463 6865 735f 7072 6576 696f 7573 5f70  tches_previous_p
-000018c0: 6173 7320 6973 204e 6f6e 653a 0a20 2020  ass is None:.   
-000018d0: 2020 2020 2020 2020 206e 625f 6261 7463           nb_batc
-000018e0: 6865 7320 3d20 726f 756e 6428 6e62 5f70  hes = round(nb_p
-000018f0: 6172 616c 6c65 6c20 2a20 312e 3235 290a  arallel * 1.25).
-00001900: 2020 2020 2020 2020 656c 6966 206e 625f          elif nb_
-00001910: 6261 7463 6865 7320 3c20 6e62 5f62 6174  batches < nb_bat
-00001920: 6368 6573 5f70 7265 7669 6f75 735f 7061  ches_previous_pa
-00001930: 7373 202f 2034 3a0a 2020 2020 2020 2020  ss / 4:.        
-00001940: 2020 2020 6e62 5f62 6174 6368 6573 203d      nb_batches =
-00001950: 2072 6f75 6e64 286e 625f 7061 7261 6c6c   round(nb_parall
-00001960: 656c 202a 2031 2e32 3529 0a0a 2020 2020  el * 1.25)..    
-00001970: 6261 7463 685f 7369 7a65 203d 206d 6174  batch_size = mat
-00001980: 682e 6365 696c 286e 625f 726f 7773 5f74  h.ceil(nb_rows_t
-00001990: 6f74 616c 202f 206e 625f 6261 7463 6865  otal / nb_batche
-000019a0: 7329 0a0a 2020 2020 2320 4c6f 6720 7265  s)..    # Log re
-000019b0: 7375 6c74 0a20 2020 206c 6f67 6765 722e  sult.    logger.
-000019c0: 6465 6275 6728 6622 6e62 5f62 6174 6368  debug(f"nb_batch
-000019d0: 6573 5f72 6563 6f6d 6d65 6e64 6564 3a20  es_recommended: 
-000019e0: 7b6e 625f 6261 7463 6865 737d 2c20 726f  {nb_batches}, ro
-000019f0: 7773 5f70 6572 5f62 6174 6368 3a20 7b62  ws_per_batch: {b
-00001a00: 6174 6368 5f73 697a 657d 2229 0a20 2020  atch_size}").   
-00001a10: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
-00001a20: 202d 3e20 6e62 5f72 6f77 735f 696e 7075   -> nb_rows_inpu
-00001a30: 745f 6c61 7965 723a 207b 6e62 5f72 6f77  t_layer: {nb_row
-00001a40: 735f 746f 7461 6c7d 2229 0a20 2020 206c  s_total}").    l
-00001a50: 6f67 6765 722e 6465 6275 6728 6622 202d  ogger.debug(f" -
-00001a60: 3e20 6d65 6d5f 7072 6564 6963 7465 643a  > mem_predicted:
-00001a70: 207b 5f67 656e 6572 616c 5f75 7469 6c2e   {_general_util.
-00001a80: 666f 726d 6174 6279 7465 7328 6d65 6d5f  formatbytes(mem_
-00001a90: 7072 6564 6963 7465 6429 7d22 290a 0a20  predicted)}").. 
-00001aa0: 2020 2072 6574 7572 6e20 7061 7261 6c6c     return parall
-00001ab0: 656c 697a 6174 696f 6e50 6172 616d 7328  elizationParams(
-00001ac0: 6e62 5f70 6172 616c 6c65 6c2c 206e 625f  nb_parallel, nb_
-00001ad0: 6261 7463 6865 732c 2062 6174 6368 5f73  batches, batch_s
-00001ae0: 697a 6529 0a0a 0a63 6c61 7373 2047 656f  ize)...class Geo
-00001af0: 4f70 6572 6174 696f 6e28 656e 756d 2e45  Operation(enum.E
-00001b00: 6e75 6d29 3a0a 2020 2020 5349 4d50 4c49  num):.    SIMPLI
-00001b10: 4659 203d 2022 7369 6d70 6c69 6679 220a  FY = "simplify".
-00001b20: 2020 2020 4255 4646 4552 203d 2022 6275      BUFFER = "bu
-00001b30: 6666 6572 220a 2020 2020 434f 4e56 4558  ffer".    CONVEX
-00001b40: 4855 4c4c 203d 2022 636f 6e76 6578 6875  HULL = "convexhu
-00001b50: 6c6c 220a 2020 2020 4150 504c 5920 3d20  ll".    APPLY = 
-00001b60: 2261 7070 6c79 220a 0a0a 2323 2323 2323  "apply"...######
-00001b70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001b80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000006f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000710: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00000720: 0a0a 636c 6173 7320 5061 7261 6c6c 656c  ..class Parallel
+00000730: 697a 6174 696f 6e43 6f6e 6669 673a 0a20  izationConfig:. 
+00000740: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00000750: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00000760: 2020 2020 2020 2062 7974 6573 5f62 6173         bytes_bas
+00000770: 6566 6f6f 7470 7269 6e74 3a20 696e 7420  efootprint: int 
+00000780: 3d20 3530 202a 2031 3032 3420 2a20 3130  = 50 * 1024 * 10
+00000790: 3234 2c0a 2020 2020 2020 2020 6279 7465  24,.        byte
+000007a0: 735f 7065 725f 726f 773a 2069 6e74 203d  s_per_row: int =
+000007b0: 2031 3030 2c0a 2020 2020 2020 2020 6d69   100,.        mi
+000007c0: 6e5f 6176 675f 726f 7773 5f70 6572 5f62  n_avg_rows_per_b
+000007d0: 6174 6368 3a20 696e 7420 3d20 3130 3030  atch: int = 1000
+000007e0: 2c0a 2020 2020 2020 2020 6d61 785f 6176  ,.        max_av
+000007f0: 675f 726f 7773 5f70 6572 5f62 6174 6368  g_rows_per_batch
+00000800: 3a20 696e 7420 3d20 3130 3030 302c 0a20  : int = 10000,. 
+00000810: 2020 2020 2020 2062 7974 6573 5f6d 696e         bytes_min
+00000820: 5f70 6572 5f70 726f 6365 7373 3d4e 6f6e  _per_process=Non
+00000830: 652c 0a20 2020 2020 2020 2062 7974 6573  e,.        bytes
+00000840: 5f75 7361 626c 653d 4e6f 6e65 2c0a 2020  _usable=None,.  
+00000850: 2020 293a 0a20 2020 2020 2020 2073 656c    ):.        sel
+00000860: 662e 6279 7465 735f 6261 7365 666f 6f74  f.bytes_basefoot
+00000870: 7072 696e 7420 3d20 6279 7465 735f 6261  print = bytes_ba
+00000880: 7365 666f 6f74 7072 696e 740a 2020 2020  sefootprint.    
+00000890: 2020 2020 7365 6c66 2e62 7974 6573 5f70      self.bytes_p
+000008a0: 6572 5f72 6f77 203d 2062 7974 6573 5f70  er_row = bytes_p
+000008b0: 6572 5f72 6f77 0a20 2020 2020 2020 2073  er_row.        s
+000008c0: 656c 662e 6d69 6e5f 6176 675f 726f 7773  elf.min_avg_rows
+000008d0: 5f70 6572 5f62 6174 6368 203d 206d 696e  _per_batch = min
+000008e0: 5f61 7667 5f72 6f77 735f 7065 725f 6261  _avg_rows_per_ba
+000008f0: 7463 680a 2020 2020 2020 2020 7365 6c66  tch.        self
+00000900: 2e6d 6178 5f61 7667 5f72 6f77 735f 7065  .max_avg_rows_pe
+00000910: 725f 6261 7463 6820 3d20 6d61 785f 6176  r_batch = max_av
+00000920: 675f 726f 7773 5f70 6572 5f62 6174 6368  g_rows_per_batch
+00000930: 0a20 2020 2020 2020 2069 6620 6279 7465  .        if byte
+00000940: 735f 6d69 6e5f 7065 725f 7072 6f63 6573  s_min_per_proces
+00000950: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00000960: 2020 2020 2020 2073 656c 662e 6279 7465         self.byte
+00000970: 735f 6d69 6e5f 7065 725f 7072 6f63 6573  s_min_per_proces
+00000980: 7320 3d20 280a 2020 2020 2020 2020 2020  s = (.          
+00000990: 2020 2020 2020 6279 7465 735f 6261 7365        bytes_base
+000009a0: 666f 6f74 7072 696e 7420 2b20 6279 7465  footprint + byte
+000009b0: 735f 7065 725f 726f 7720 2a20 6d69 6e5f  s_per_row * min_
+000009c0: 6176 675f 726f 7773 5f70 6572 5f62 6174  avg_rows_per_bat
+000009d0: 6368 0a20 2020 2020 2020 2020 2020 2029  ch.            )
+000009e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000009f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000a00: 6279 7465 735f 6d69 6e5f 7065 725f 7072  bytes_min_per_pr
+00000a10: 6f63 6573 7320 3d20 6279 7465 735f 6d69  ocess = bytes_mi
+00000a20: 6e5f 7065 725f 7072 6f63 6573 730a 2020  n_per_process.  
+00000a30: 2020 2020 2020 6966 2062 7974 6573 5f75        if bytes_u
+00000a40: 7361 626c 6520 6973 204e 6f6e 653a 0a20  sable is None:. 
+00000a50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000a60: 6279 7465 735f 7573 6162 6c65 203d 2070  bytes_usable = p
+00000a70: 7375 7469 6c2e 7669 7274 7561 6c5f 6d65  sutil.virtual_me
+00000a80: 6d6f 7279 2829 2e61 7661 696c 6162 6c65  mory().available
+00000a90: 202a 2030 2e39 0a20 2020 2020 2020 2065   * 0.9.        e
+00000aa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00000ab0: 2073 656c 662e 6279 7465 735f 7573 6162   self.bytes_usab
+00000ac0: 6c65 203d 2062 7974 6573 5f75 7361 626c  le = bytes_usabl
+00000ad0: 650a 0a0a 7061 7261 6c6c 656c 697a 6174  e...parallelizat
+00000ae0: 696f 6e50 6172 616d 7320 3d20 4e61 6d65  ionParams = Name
+00000af0: 6454 7570 6c65 280a 2020 2020 2272 6573  dTuple(.    "res
+00000b00: 756c 7422 2c0a 2020 2020 5b28 226e 625f  ult",.    [("nb_
+00000b10: 7061 7261 6c6c 656c 222c 2069 6e74 292c  parallel", int),
+00000b20: 2028 226e 625f 6261 7463 6865 735f 7265   ("nb_batches_re
+00000b30: 636f 6d6d 656e 6465 6422 2c20 696e 7429  commended", int)
+00000b40: 2c20 2822 6e62 5f72 6f77 735f 7065 725f  , ("nb_rows_per_
+00000b50: 6261 7463 6822 2c20 696e 7429 5d2c 0a29  batch", int)],.)
+00000b60: 0a0a 0a64 6566 2067 6574 5f70 6172 616c  ...def get_paral
+00000b70: 6c65 6c69 7a61 7469 6f6e 5f70 6172 616d  lelization_param
+00000b80: 7328 0a20 2020 206e 625f 726f 7773 5f74  s(.    nb_rows_t
+00000b90: 6f74 616c 3a20 696e 742c 0a20 2020 206e  otal: int,.    n
+00000ba0: 625f 7061 7261 6c6c 656c 3a20 696e 7420  b_parallel: int 
+00000bb0: 3d20 2d31 2c0a 2020 2020 6e62 5f62 6174  = -1,.    nb_bat
+00000bc0: 6368 6573 5f70 7265 7669 6f75 735f 7061  ches_previous_pa
+00000bd0: 7373 3a20 4f70 7469 6f6e 616c 5b69 6e74  ss: Optional[int
+00000be0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 7061  ] = None,.    pa
+00000bf0: 7261 6c6c 656c 697a 6174 696f 6e5f 636f  rallelization_co
+00000c00: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b50  nfig: Optional[P
+00000c10: 6172 616c 6c65 6c69 7a61 7469 6f6e 436f  arallelizationCo
+00000c20: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2920  nfig] = None,.) 
+00000c30: 2d3e 2070 6172 616c 6c65 6c69 7a61 7469  -> parallelizati
+00000c40: 6f6e 5061 7261 6d73 3a0a 2020 2020 2222  onParams:.    ""
+00000c50: 220a 2020 2020 4465 7465 726d 696e 6573  ".    Determines
+00000c60: 2072 6563 6f6d 6d65 6e64 6564 2070 6172   recommended par
+00000c70: 616c 6c65 6c69 7a61 7469 6f6e 2070 6172  allelization par
+00000c80: 616d 732e 0a0a 2020 2020 4172 6773 3a0a  ams...    Args:.
+00000c90: 2020 2020 2020 2020 6e62 5f72 6f77 735f          nb_rows_
+00000ca0: 746f 7461 6c20 2869 6e74 293a 2054 6865  total (int): The
+00000cb0: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
+00000cc0: 2072 6f77 7320 7468 6174 2077 696c 6c20   rows that will 
+00000cd0: 6265 2070 726f 6365 7373 6564 0a20 2020  be processed.   
+00000ce0: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
+00000cf0: 2028 696e 742c 206f 7074 696f 6e61 6c29   (int, optional)
+00000d00: 3a20 5468 6520 6c65 7665 6c20 6f66 2070  : The level of p
+00000d10: 6172 616c 6c65 6c69 7a61 7469 6f6e 2072  arallelization r
+00000d20: 6571 7565 7374 6564 2e0a 2020 2020 2020  equested..      
+00000d30: 2020 2020 2020 4966 202d 312c 2074 7269        If -1, tri
+00000d40: 6573 2074 6f20 7573 6520 616c 6c20 7265  es to use all re
+00000d50: 736f 7572 6365 7320 6176 6169 6c61 626c  sources availabl
+00000d60: 652e 2044 6566 6175 6c74 7320 746f 202d  e. Defaults to -
+00000d70: 312e 0a20 2020 2020 2020 206e 625f 6261  1..        nb_ba
+00000d80: 7463 6865 735f 7072 6576 696f 7573 5f70  tches_previous_p
+00000d90: 6173 7320 2869 6e74 2c20 6f70 7469 6f6e  ass (int, option
+00000da0: 616c 293a 2049 6620 6170 706c 6963 6162  al): If applicab
+00000db0: 6c65 2c20 7468 6520 6e75 6d62 6572 206f  le, the number o
+00000dc0: 6620 6261 7463 6865 730a 2020 2020 2020  f batches.      
+00000dd0: 2020 2020 2020 7573 6564 2069 6e20 6120        used in a 
+00000de0: 7072 6576 696f 7573 2070 6173 7320 6f66  previous pass of
+00000df0: 2074 6865 2063 616c 6375 6c61 7469 6f6e   the calculation
+00000e00: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+00000e10: 6e65 2e0a 0a20 2020 2052 6574 7572 6e73  ne...    Returns
+00000e20: 3a0a 2020 2020 2020 2020 7061 7261 6c6c  :.        parall
+00000e30: 656c 697a 6174 696f 6e50 6172 616d 733a  elizationParams:
+00000e40: 2054 6865 2072 6563 6f6d 6d65 6e64 6564   The recommended
+00000e50: 2070 6172 616d 6574 6572 732e 0a20 2020   parameters..   
+00000e60: 2022 2222 0a20 2020 2023 2049 6e69 7420   """.    # Init 
+00000e70: 7061 7261 6c6c 656c 697a 6174 696f 6e20  parallelization 
+00000e80: 636f 6e66 6967 0a0a 2020 2020 2320 4966  config..    # If
+00000e90: 2063 6f6e 6669 6720 6973 204e 6f6e 652c   config is None,
+00000ea0: 2073 6574 2074 6f20 656d 7074 7920 6469   set to empty di
+00000eb0: 6374 0a20 2020 2069 6620 7061 7261 6c6c  ct.    if parall
+00000ec0: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
+00000ed0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00000ee0: 2020 2020 2020 7061 7261 6c6c 656c 697a        paralleliz
+00000ef0: 6174 696f 6e5f 636f 6e66 6967 5f6c 6f63  ation_config_loc
+00000f00: 616c 203d 2070 6172 616c 6c65 6c69 7a61  al = paralleliza
+00000f10: 7469 6f6e 5f63 6f6e 6669 670a 2020 2020  tion_config.    
+00000f20: 656c 7365 3a0a 2020 2020 2020 2020 7061  else:.        pa
+00000f30: 7261 6c6c 656c 697a 6174 696f 6e5f 636f  rallelization_co
+00000f40: 6e66 6967 5f6c 6f63 616c 203d 2050 6172  nfig_local = Par
+00000f50: 616c 6c65 6c69 7a61 7469 6f6e 436f 6e66  allelizationConf
+00000f60: 6967 2829 0a0a 2020 2020 2320 4966 2074  ig()..    # If t
+00000f70: 6865 206e 756d 6265 7220 6f66 2072 6f77  he number of row
+00000f80: 7320 6973 2072 6561 6c6c 7920 6c6f 772c  s is really low,
+00000f90: 206a 7573 7420 7573 6520 6f6e 6520 6261   just use one ba
+00000fa0: 7463 680a 2020 2020 2320 544f 444f 3a20  tch.    # TODO: 
+00000fb0: 666f 7220 7665 7279 2063 6f6d 706c 6578  for very complex
+00000fc0: 2066 6561 7475 7265 732c 2070 6f73 7369   features, possi
+00000fd0: 626c 7920 7468 6973 206c 696d 6974 2069  bly this limit i
+00000fe0: 7320 6e6f 7420 6120 676f 6f64 2069 6465  s not a good ide
+00000ff0: 610a 2020 2020 6966 206e 625f 726f 7773  a.    if nb_rows
+00001000: 5f74 6f74 616c 203c 2070 6172 616c 6c65  _total < paralle
+00001010: 6c69 7a61 7469 6f6e 5f63 6f6e 6669 675f  lization_config_
+00001020: 6c6f 6361 6c2e 6d69 6e5f 6176 675f 726f  local.min_avg_ro
+00001030: 7773 5f70 6572 5f62 6174 6368 3a0a 2020  ws_per_batch:.  
+00001040: 2020 2020 2020 7265 7475 726e 2070 6172        return par
+00001050: 616c 6c65 6c69 7a61 7469 6f6e 5061 7261  allelizationPara
+00001060: 6d73 2831 2c20 312c 206e 625f 726f 7773  ms(1, 1, nb_rows
+00001070: 5f74 6f74 616c 290a 0a20 2020 2069 6620  _total)..    if 
+00001080: 6e62 5f70 6172 616c 6c65 6c20 3d3d 202d  nb_parallel == -
+00001090: 313a 0a20 2020 2020 2020 206e 625f 7061  1:.        nb_pa
+000010a0: 7261 6c6c 656c 203d 206d 756c 7469 7072  rallel = multipr
+000010b0: 6f63 6573 7369 6e67 2e63 7075 5f63 6f75  ocessing.cpu_cou
+000010c0: 6e74 2829 0a0a 2020 2020 6d65 6d5f 7573  nt()..    mem_us
+000010d0: 6162 6c65 203d 205f 6765 6e65 7261 6c5f  able = _general_
+000010e0: 7574 696c 2e66 6f72 6d61 7462 7974 6573  util.formatbytes
+000010f0: 2870 6172 616c 6c65 6c69 7a61 7469 6f6e  (parallelization
+00001100: 5f63 6f6e 6669 675f 6c6f 6361 6c2e 6279  _config_local.by
+00001110: 7465 735f 7573 6162 6c65 290a 2020 2020  tes_usable).    
+00001120: 6c6f 6767 6572 2e64 6562 7567 2866 226d  logger.debug(f"m
+00001130: 656d 6f72 795f 7573 6162 6c65 3a20 7b6d  emory_usable: {m
+00001140: 656d 5f75 7361 626c 657d 2c20 7769 7468  em_usable}, with
+00001150: 3a22 290a 2020 2020 6d65 6d5f 6176 6169  :").    mem_avai
+00001160: 6c61 626c 6520 3d20 5f67 656e 6572 616c  lable = _general
+00001170: 5f75 7469 6c2e 666f 726d 6174 6279 7465  _util.formatbyte
+00001180: 7328 7073 7574 696c 2e76 6972 7475 616c  s(psutil.virtual
+00001190: 5f6d 656d 6f72 7928 292e 6176 6169 6c61  _memory().availa
+000011a0: 626c 6529 0a20 2020 206c 6f67 6765 722e  ble).    logger.
+000011b0: 6465 6275 6728 6622 2020 2d3e 206d 656d  debug(f"  -> mem
+000011c0: 2e61 7661 696c 6162 6c65 3a20 7b6d 656d  .available: {mem
+000011d0: 5f61 7661 696c 6162 6c65 7d22 290a 2020  _available}").  
+000011e0: 2020 7377 6170 5f66 7265 6520 3d20 5f67    swap_free = _g
+000011f0: 656e 6572 616c 5f75 7469 6c2e 666f 726d  eneral_util.form
+00001200: 6174 6279 7465 7328 7073 7574 696c 2e73  atbytes(psutil.s
+00001210: 7761 705f 6d65 6d6f 7279 2829 2e66 7265  wap_memory().fre
+00001220: 6529 0a20 2020 206c 6f67 6765 722e 6465  e).    logger.de
+00001230: 6275 6728 6622 2020 2d3e 2073 7761 702e  bug(f"  -> swap.
+00001240: 6672 6565 3a20 7b73 7761 705f 6672 6565  free: {swap_free
+00001250: 7d22 290a 0a20 2020 2023 2049 6620 6e6f  }")..    # If no
+00001260: 7420 656e 6f75 6768 206d 656d 6f72 7920  t enough memory 
+00001270: 666f 7220 7468 6520 616d 6f75 6e74 206f  for the amount o
+00001280: 6620 7061 7261 6c6c 656c 6c69 736d 2061  f parallellism a
+00001290: 736b 6564 2c20 7265 6475 6365 0a20 2020  sked, reduce.   
+000012a0: 2069 6620 280a 2020 2020 2020 2020 6e62   if (.        nb
+000012b0: 5f70 6172 616c 6c65 6c20 2a20 7061 7261  _parallel * para
+000012c0: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
+000012d0: 6967 5f6c 6f63 616c 2e62 7974 6573 5f6d  ig_local.bytes_m
+000012e0: 696e 5f70 6572 5f70 726f 6365 7373 0a20  in_per_process. 
+000012f0: 2020 2029 203e 2070 6172 616c 6c65 6c69     ) > paralleli
+00001300: 7a61 7469 6f6e 5f63 6f6e 6669 675f 6c6f  zation_config_lo
+00001310: 6361 6c2e 6279 7465 735f 7573 6162 6c65  cal.bytes_usable
+00001320: 3a0a 2020 2020 2020 2020 6e62 5f70 6172  :.        nb_par
+00001330: 616c 6c65 6c20 3d20 696e 7428 0a20 2020  allel = int(.   
+00001340: 2020 2020 2020 2020 2070 6172 616c 6c65           paralle
+00001350: 6c69 7a61 7469 6f6e 5f63 6f6e 6669 675f  lization_config_
+00001360: 6c6f 6361 6c2e 6279 7465 735f 7573 6162  local.bytes_usab
+00001370: 6c65 0a20 2020 2020 2020 2020 2020 202f  le.            /
+00001380: 2070 6172 616c 6c65 6c69 7a61 7469 6f6e   parallelization
+00001390: 5f63 6f6e 6669 675f 6c6f 6361 6c2e 6279  _config_local.by
+000013a0: 7465 735f 6d69 6e5f 7065 725f 7072 6f63  tes_min_per_proc
+000013b0: 6573 730a 2020 2020 2020 2020 290a 2020  ess.        ).  
+000013c0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+000013d0: 7567 2866 224e 625f 7061 7261 6c6c 656c  ug(f"Nb_parallel
+000013e0: 2072 6564 7563 6564 2074 6f20 7b6e 625f   reduced to {nb_
+000013f0: 7061 7261 6c6c 656c 7d20 746f 2072 6564  parallel} to red
+00001400: 7563 6520 6d65 6d6f 7279 2075 7361 6765  uce memory usage
+00001410: 2229 0a0a 2020 2020 2320 4f70 7469 6d61  ")..    # Optima
+00001420: 6c20 6e75 6d62 6572 206f 6620 6261 7463  l number of batc
+00001430: 6865 7320 616e 6420 726f 7773 2070 6572  hes and rows per
+00001440: 2062 6174 6368 2062 6173 6564 206f 6e20   batch based on 
+00001450: 6d65 6d6f 7279 2075 7361 6765 0a20 2020  memory usage.   
+00001460: 206e 625f 6261 7463 6865 7320 3d20 6d61   nb_batches = ma
+00001470: 7468 2e63 6569 6c28 0a20 2020 2020 2020  th.ceil(.       
+00001480: 2028 6e62 5f72 6f77 735f 746f 7461 6c20   (nb_rows_total 
+00001490: 2a20 7061 7261 6c6c 656c 697a 6174 696f  * parallelizatio
+000014a0: 6e5f 636f 6e66 6967 5f6c 6f63 616c 2e62  n_config_local.b
+000014b0: 7974 6573 5f70 6572 5f72 6f77 202a 206e  ytes_per_row * n
+000014c0: 625f 7061 7261 6c6c 656c 290a 2020 2020  b_parallel).    
+000014d0: 2020 2020 2f20 280a 2020 2020 2020 2020      / (.        
+000014e0: 2020 2020 7061 7261 6c6c 656c 697a 6174      parallelizat
+000014f0: 696f 6e5f 636f 6e66 6967 5f6c 6f63 616c  ion_config_local
+00001500: 2e62 7974 6573 5f75 7361 626c 650a 2020  .bytes_usable.  
+00001510: 2020 2020 2020 2020 2020 2d20 7061 7261            - para
+00001520: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
+00001530: 6967 5f6c 6f63 616c 2e62 7974 6573 5f62  ig_local.bytes_b
+00001540: 6173 6566 6f6f 7470 7269 6e74 202a 206e  asefootprint * n
+00001550: 625f 7061 7261 6c6c 656c 0a20 2020 2020  b_parallel.     
+00001560: 2020 2029 0a20 2020 2029 0a0a 2020 2020     ).    )..    
+00001570: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+00001580: 6176 6572 6167 6520 6261 7463 6820 646f  average batch do
+00001590: 6573 6e27 7420 636f 6e74 6169 6e20 3e20  esn't contain > 
+000015a0: 6d61 785f 6176 675f 726f 7773 5f70 6572  max_avg_rows_per
+000015b0: 5f62 6174 6368 0a20 2020 2062 6174 6368  _batch.    batch
+000015c0: 5f73 697a 6520 3d20 6d61 7468 2e63 6569  _size = math.cei
+000015d0: 6c28 6e62 5f72 6f77 735f 746f 7461 6c20  l(nb_rows_total 
+000015e0: 2f20 6e62 5f62 6174 6368 6573 290a 2020  / nb_batches).  
+000015f0: 2020 6966 2062 6174 6368 5f73 697a 6520    if batch_size 
+00001600: 3e20 7061 7261 6c6c 656c 697a 6174 696f  > parallelizatio
+00001610: 6e5f 636f 6e66 6967 5f6c 6f63 616c 2e6d  n_config_local.m
+00001620: 6178 5f61 7667 5f72 6f77 735f 7065 725f  ax_avg_rows_per_
+00001630: 6261 7463 683a 0a20 2020 2020 2020 2062  batch:.        b
+00001640: 6174 6368 5f73 697a 6520 3d20 7061 7261  atch_size = para
+00001650: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
+00001660: 6967 5f6c 6f63 616c 2e6d 6178 5f61 7667  ig_local.max_avg
+00001670: 5f72 6f77 735f 7065 725f 6261 7463 680a  _rows_per_batch.
+00001680: 2020 2020 2020 2020 6e62 5f62 6174 6368          nb_batch
+00001690: 6573 203d 206d 6174 682e 6365 696c 286e  es = math.ceil(n
+000016a0: 625f 726f 7773 5f74 6f74 616c 202f 2062  b_rows_total / b
+000016b0: 6174 6368 5f73 697a 6529 0a0a 2020 2020  atch_size)..    
+000016c0: 6d65 6d5f 7072 6564 6963 7465 6420 3d20  mem_predicted = 
+000016d0: 280a 2020 2020 2020 2020 7061 7261 6c6c  (.        parall
+000016e0: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
+000016f0: 5f6c 6f63 616c 2e62 7974 6573 5f62 6173  _local.bytes_bas
+00001700: 6566 6f6f 7470 7269 6e74 0a20 2020 2020  efootprint.     
+00001710: 2020 202b 2062 6174 6368 5f73 697a 6520     + batch_size 
+00001720: 2a20 7061 7261 6c6c 656c 697a 6174 696f  * parallelizatio
+00001730: 6e5f 636f 6e66 6967 5f6c 6f63 616c 2e62  n_config_local.b
+00001740: 7974 6573 5f70 6572 5f72 6f77 0a20 2020  ytes_per_row.   
+00001750: 2029 202a 206e 625f 6261 7463 6865 730a   ) * nb_batches.
+00001760: 0a20 2020 2023 204d 616b 6520 7375 7265  .    # Make sure
+00001770: 2074 6865 7265 2061 7265 2065 6e6f 7567   there are enoug
+00001780: 6820 6261 7463 6865 7320 746f 2075 7365  h batches to use
+00001790: 2061 7320 6d75 6368 2070 6172 616c 6c65   as much paralle
+000017a0: 6c69 736d 2061 7320 706f 7373 6962 6c65  lism as possible
+000017b0: 0a20 2020 2069 6620 6e62 5f62 6174 6368  .    if nb_batch
+000017c0: 6573 203e 2031 2061 6e64 206e 625f 6261  es > 1 and nb_ba
+000017d0: 7463 6865 7320 3c20 6e62 5f70 6172 616c  tches < nb_paral
+000017e0: 6c65 6c3a 0a20 2020 2020 2020 206d 6178  lel:.        max
+000017f0: 5f70 6172 616c 6c65 6c5f 6261 7463 6873  _parallel_batchs
+00001800: 697a 6520 3d20 696e 7428 0a20 2020 2020  ize = int(.     
+00001810: 2020 2020 2020 2070 6172 616c 6c65 6c69         paralleli
+00001820: 7a61 7469 6f6e 5f63 6f6e 6669 675f 6c6f  zation_config_lo
+00001830: 6361 6c2e 6d61 785f 6176 675f 726f 7773  cal.max_avg_rows
+00001840: 5f70 6572 5f62 6174 6368 0a20 2020 2020  _per_batch.     
+00001850: 2020 2020 2020 202a 206e 625f 6261 7463         * nb_batc
+00001860: 6865 730a 2020 2020 2020 2020 2020 2020  hes.            
+00001870: 2f20 6261 7463 685f 7369 7a65 0a20 2020  / batch_size.   
+00001880: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
+00001890: 625f 7061 7261 6c6c 656c 203d 206d 696e  b_parallel = min
+000018a0: 286d 6178 5f70 6172 616c 6c65 6c5f 6261  (max_parallel_ba
+000018b0: 7463 6873 697a 652c 206e 625f 7061 7261  tchsize, nb_para
+000018c0: 6c6c 656c 290a 2020 2020 2020 2020 6966  llel).        if
+000018d0: 206e 625f 6261 7463 6865 735f 7072 6576   nb_batches_prev
+000018e0: 696f 7573 5f70 6173 7320 6973 204e 6f6e  ious_pass is Non
+000018f0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00001900: 625f 6261 7463 6865 7320 3d20 726f 756e  b_batches = roun
+00001910: 6428 6e62 5f70 6172 616c 6c65 6c20 2a20  d(nb_parallel * 
+00001920: 312e 3235 290a 2020 2020 2020 2020 656c  1.25).        el
+00001930: 6966 206e 625f 6261 7463 6865 7320 3c20  if nb_batches < 
+00001940: 6e62 5f62 6174 6368 6573 5f70 7265 7669  nb_batches_previ
+00001950: 6f75 735f 7061 7373 202f 2034 3a0a 2020  ous_pass / 4:.  
+00001960: 2020 2020 2020 2020 2020 6e62 5f62 6174            nb_bat
+00001970: 6368 6573 203d 2072 6f75 6e64 286e 625f  ches = round(nb_
+00001980: 7061 7261 6c6c 656c 202a 2031 2e32 3529  parallel * 1.25)
+00001990: 0a0a 2020 2020 6261 7463 685f 7369 7a65  ..    batch_size
+000019a0: 203d 206d 6174 682e 6365 696c 286e 625f   = math.ceil(nb_
+000019b0: 726f 7773 5f74 6f74 616c 202f 206e 625f  rows_total / nb_
+000019c0: 6261 7463 6865 7329 0a0a 2020 2020 2320  batches)..    # 
+000019d0: 4c6f 6720 7265 7375 6c74 0a20 2020 206c  Log result.    l
+000019e0: 6f67 6765 722e 6465 6275 6728 6622 6e62  ogger.debug(f"nb
+000019f0: 5f62 6174 6368 6573 5f72 6563 6f6d 6d65  _batches_recomme
+00001a00: 6e64 6564 3a20 7b6e 625f 6261 7463 6865  nded: {nb_batche
+00001a10: 737d 2c20 726f 7773 5f70 6572 5f62 6174  s}, rows_per_bat
+00001a20: 6368 3a20 7b62 6174 6368 5f73 697a 657d  ch: {batch_size}
+00001a30: 2229 0a20 2020 206c 6f67 6765 722e 6465  ").    logger.de
+00001a40: 6275 6728 6622 202d 3e20 6e62 5f72 6f77  bug(f" -> nb_row
+00001a50: 735f 696e 7075 745f 6c61 7965 723a 207b  s_input_layer: {
+00001a60: 6e62 5f72 6f77 735f 746f 7461 6c7d 2229  nb_rows_total}")
+00001a70: 0a20 2020 206c 6f67 6765 722e 6465 6275  .    logger.debu
+00001a80: 6728 6622 202d 3e20 6d65 6d5f 7072 6564  g(f" -> mem_pred
+00001a90: 6963 7465 643a 207b 5f67 656e 6572 616c  icted: {_general
+00001aa0: 5f75 7469 6c2e 666f 726d 6174 6279 7465  _util.formatbyte
+00001ab0: 7328 6d65 6d5f 7072 6564 6963 7465 6429  s(mem_predicted)
+00001ac0: 7d22 290a 0a20 2020 2072 6574 7572 6e20  }")..    return 
+00001ad0: 7061 7261 6c6c 656c 697a 6174 696f 6e50  parallelizationP
+00001ae0: 6172 616d 7328 6e62 5f70 6172 616c 6c65  arams(nb_paralle
+00001af0: 6c2c 206e 625f 6261 7463 6865 732c 2062  l, nb_batches, b
+00001b00: 6174 6368 5f73 697a 6529 0a0a 0a63 6c61  atch_size)...cla
+00001b10: 7373 2047 656f 4f70 6572 6174 696f 6e28  ss GeoOperation(
+00001b20: 656e 756d 2e45 6e75 6d29 3a0a 2020 2020  enum.Enum):.    
+00001b30: 5349 4d50 4c49 4659 203d 2022 7369 6d70  SIMPLIFY = "simp
+00001b40: 6c69 6679 220a 2020 2020 4255 4646 4552  lify".    BUFFER
+00001b50: 203d 2022 6275 6666 6572 220a 2020 2020   = "buffer".    
+00001b60: 434f 4e56 4558 4855 4c4c 203d 2022 636f  CONVEXHULL = "co
+00001b70: 6e76 6578 6875 6c6c 220a 2020 2020 4150  nvexhull".    AP
+00001b80: 504c 5920 3d20 2261 7070 6c79 220a 0a0a  PLY = "apply"...
 00001b90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001ba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001bb0: 2323 2323 2323 2323 2323 0a23 2054 6865  ##########.# The
-00001bc0: 2072 6561 6c20 7374 7566 660a 2323 2323   real stuff.####
+00001bb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001bc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001bd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001be0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001bf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001be0: 0a23 2054 6865 2072 6561 6c20 7374 7566  .# The real stuf
+00001bf0: 660a 2323 2323 2323 2323 2323 2323 2323  f.##############
 00001c00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001c10: 2323 2323 2323 2323 2323 2323 0a0a 0a64  ############...d
-00001c20: 6566 2061 7070 6c79 280a 2020 2020 696e  ef apply(.    in
-00001c30: 7075 745f 7061 7468 3a20 5061 7468 2c0a  put_path: Path,.
-00001c40: 2020 2020 6f75 7470 7574 5f70 6174 683a      output_path:
-00001c50: 2050 6174 682c 0a20 2020 2066 756e 633a   Path,.    func:
-00001c60: 2043 616c 6c61 626c 655b 5b41 6e79 5d2c   Callable[[Any],
-00001c70: 2041 6e79 5d2c 0a20 2020 206f 6e6c 795f   Any],.    only_
-00001c80: 6765 6f6d 5f69 6e70 7574 3a20 626f 6f6c  geom_input: bool
-00001c90: 203d 2054 7275 652c 0a20 2020 2069 6e70   = True,.    inp
-00001ca0: 7574 5f6c 6179 6572 3a20 4f70 7469 6f6e  ut_layer: Option
-00001cb0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00001cc0: 2020 2020 6f75 7470 7574 5f6c 6179 6572      output_layer
-00001cd0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00001ce0: 3d20 4e6f 6e65 2c0a 2020 2020 636f 6c75  = None,.    colu
-00001cf0: 6d6e 733a 204f 7074 696f 6e61 6c5b 4c69  mns: Optional[Li
-00001d00: 7374 5b73 7472 5d5d 203d 204e 6f6e 652c  st[str]] = None,
-00001d10: 0a20 2020 2065 7870 6c6f 6465 636f 6c6c  .    explodecoll
-00001d20: 6563 7469 6f6e 733a 2062 6f6f 6c20 3d20  ections: bool = 
-00001d30: 4661 6c73 652c 0a20 2020 2066 6f72 6365  False,.    force
-00001d40: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-00001d50: 7479 7065 3a20 556e 696f 6e5b 4765 6f6d  type: Union[Geom
-00001d60: 6574 7279 5479 7065 2c20 7374 722c 204e  etryType, str, N
-00001d70: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
-00001d80: 2067 7269 6473 697a 653a 2066 6c6f 6174   gridsize: float
-00001d90: 203d 2030 2e30 2c0a 2020 2020 6e62 5f70   = 0.0,.    nb_p
-00001da0: 6172 616c 6c65 6c3a 2069 6e74 203d 202d  arallel: int = -
-00001db0: 312c 0a20 2020 2062 6174 6368 7369 7a65  1,.    batchsize
-00001dc0: 3a20 696e 7420 3d20 2d31 2c0a 2020 2020  : int = -1,.    
-00001dd0: 666f 7263 653a 2062 6f6f 6c20 3d20 4661  force: bool = Fa
-00001de0: 6c73 652c 0a29 3a0a 2020 2020 2320 496e  lse,.):.    # In
-00001df0: 6974 0a20 2020 206f 7065 7261 7469 6f6e  it.    operation
-00001e00: 5f70 6172 616d 7320 3d20 7b0a 2020 2020  _params = {.    
-00001e10: 2020 2020 226f 6e6c 795f 6765 6f6d 5f69      "only_geom_i
-00001e20: 6e70 7574 223a 206f 6e6c 795f 6765 6f6d  nput": only_geom
-00001e30: 5f69 6e70 7574 2c0a 2020 2020 2020 2020  _input,.        
-00001e40: 2270 6963 6b6c 6564 5f66 756e 6322 3a20  "pickled_func": 
-00001e50: 636c 6f75 6470 6963 6b6c 652e 6475 6d70  cloudpickle.dump
-00001e60: 7328 6675 6e63 292c 0a20 2020 207d 0a0a  s(func),.    }..
-00001e70: 2020 2020 2320 476f 210a 2020 2020 7265      # Go!.    re
-00001e80: 7475 726e 205f 6170 706c 795f 6765 6f6f  turn _apply_geoo
-00001e90: 7065 7261 7469 6f6e 5f74 6f5f 6c61 7965  peration_to_laye
-00001ea0: 7228 0a20 2020 2020 2020 2069 6e70 7574  r(.        input
-00001eb0: 5f70 6174 683d 696e 7075 745f 7061 7468  _path=input_path
-00001ec0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
-00001ed0: 5f70 6174 683d 6f75 7470 7574 5f70 6174  _path=output_pat
-00001ee0: 682c 0a20 2020 2020 2020 206f 7065 7261  h,.        opera
-00001ef0: 7469 6f6e 3d47 656f 4f70 6572 6174 696f  tion=GeoOperatio
-00001f00: 6e2e 4150 504c 592c 0a20 2020 2020 2020  n.APPLY,.       
-00001f10: 206f 7065 7261 7469 6f6e 5f70 6172 616d   operation_param
-00001f20: 733d 6f70 6572 6174 696f 6e5f 7061 7261  s=operation_para
-00001f30: 6d73 2c0a 2020 2020 2020 2020 696e 7075  ms,.        inpu
-00001f40: 745f 6c61 7965 723d 696e 7075 745f 6c61  t_layer=input_la
-00001f50: 7965 722c 0a20 2020 2020 2020 206f 7574  yer,.        out
-00001f60: 7075 745f 6c61 7965 723d 6f75 7470 7574  put_layer=output
-00001f70: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00001f80: 636f 6c75 6d6e 733d 636f 6c75 6d6e 732c  columns=columns,
-00001f90: 0a20 2020 2020 2020 2065 7870 6c6f 6465  .        explode
-00001fa0: 636f 6c6c 6563 7469 6f6e 733d 6578 706c  collections=expl
-00001fb0: 6f64 6563 6f6c 6c65 6374 696f 6e73 2c0a  odecollections,.
-00001fc0: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
-00001fd0: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-00001fe0: 653d 666f 7263 655f 6f75 7470 7574 5f67  e=force_output_g
-00001ff0: 656f 6d65 7472 7974 7970 652c 0a20 2020  eometrytype,.   
-00002000: 2020 2020 2067 7269 6473 697a 653d 6772       gridsize=gr
-00002010: 6964 7369 7a65 2c0a 2020 2020 2020 2020  idsize,.        
-00002020: 6e62 5f70 6172 616c 6c65 6c3d 6e62 5f70  nb_parallel=nb_p
-00002030: 6172 616c 6c65 6c2c 0a20 2020 2020 2020  arallel,.       
-00002040: 2062 6174 6368 7369 7a65 3d62 6174 6368   batchsize=batch
-00002050: 7369 7a65 2c0a 2020 2020 2020 2020 666f  size,.        fo
-00002060: 7263 653d 666f 7263 652c 0a20 2020 2029  rce=force,.    )
-00002070: 0a0a 0a64 6566 2062 7566 6665 7228 0a20  ...def buffer(. 
-00002080: 2020 2069 6e70 7574 5f70 6174 683a 2050     input_path: P
-00002090: 6174 682c 0a20 2020 206f 7574 7075 745f  ath,.    output_
-000020a0: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
-000020b0: 6469 7374 616e 6365 3a20 666c 6f61 742c  distance: float,
-000020c0: 0a20 2020 2071 7561 6472 616e 7473 6567  .    quadrantseg
-000020d0: 6d65 6e74 733a 2069 6e74 203d 2035 2c0a  ments: int = 5,.
-000020e0: 2020 2020 656e 6463 6170 5f73 7479 6c65      endcap_style
-000020f0: 3a20 4275 6666 6572 456e 6443 6170 5374  : BufferEndCapSt
-00002100: 796c 6520 3d20 4275 6666 6572 456e 6443  yle = BufferEndC
-00002110: 6170 5374 796c 652e 524f 554e 442c 0a20  apStyle.ROUND,. 
-00002120: 2020 206a 6f69 6e5f 7374 796c 653a 2042     join_style: B
-00002130: 7566 6665 724a 6f69 6e53 7479 6c65 203d  ufferJoinStyle =
-00002140: 2042 7566 6665 724a 6f69 6e53 7479 6c65   BufferJoinStyle
-00002150: 2e52 4f55 4e44 2c0a 2020 2020 6d69 7472  .ROUND,.    mitr
-00002160: 655f 6c69 6d69 743a 2066 6c6f 6174 203d  e_limit: float =
-00002170: 2035 2e30 2c0a 2020 2020 7369 6e67 6c65   5.0,.    single
-00002180: 5f73 6964 6564 3a20 626f 6f6c 203d 2046  _sided: bool = F
-00002190: 616c 7365 2c0a 2020 2020 696e 7075 745f  alse,.    input_
-000021a0: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
-000021b0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-000021c0: 206f 7574 7075 745f 6c61 7965 723a 204f   output_layer: O
-000021d0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-000021e0: 6f6e 652c 0a20 2020 2063 6f6c 756d 6e73  one,.    columns
-000021f0: 3a20 4f70 7469 6f6e 616c 5b4c 6973 745b  : Optional[List[
-00002200: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-00002210: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
-00002220: 696f 6e73 3a20 626f 6f6c 203d 2046 616c  ions: bool = Fal
-00002230: 7365 2c0a 2020 2020 6772 6964 7369 7a65  se,.    gridsize
-00002240: 3a20 666c 6f61 7420 3d20 302e 302c 0a20  : float = 0.0,. 
-00002250: 2020 206e 625f 7061 7261 6c6c 656c 3a20     nb_parallel: 
-00002260: 696e 7420 3d20 2d31 2c0a 2020 2020 6261  int = -1,.    ba
-00002270: 7463 6873 697a 653a 2069 6e74 203d 202d  tchsize: int = -
-00002280: 312c 0a20 2020 2066 6f72 6365 3a20 626f  1,.    force: bo
-00002290: 6f6c 203d 2046 616c 7365 2c0a 293a 0a20  ol = False,.):. 
-000022a0: 2020 2023 2049 6e69 740a 2020 2020 6f70     # Init.    op
-000022b0: 6572 6174 696f 6e5f 7061 7261 6d73 203d  eration_params =
-000022c0: 207b 0a20 2020 2020 2020 2022 6469 7374   {.        "dist
-000022d0: 616e 6365 223a 2064 6973 7461 6e63 652c  ance": distance,
-000022e0: 0a20 2020 2020 2020 2022 7175 6164 7261  .        "quadra
-000022f0: 6e74 7365 676d 656e 7473 223a 2071 7561  ntsegments": qua
-00002300: 6472 616e 7473 6567 6d65 6e74 732c 0a20  drantsegments,. 
-00002310: 2020 2020 2020 2022 656e 6463 6170 5f73         "endcap_s
-00002320: 7479 6c65 223a 2065 6e64 6361 705f 7374  tyle": endcap_st
-00002330: 796c 652c 0a20 2020 2020 2020 2022 6a6f  yle,.        "jo
-00002340: 696e 5f73 7479 6c65 223a 206a 6f69 6e5f  in_style": join_
-00002350: 7374 796c 652c 0a20 2020 2020 2020 2022  style,.        "
-00002360: 6d69 7472 655f 6c69 6d69 7422 3a20 6d69  mitre_limit": mi
-00002370: 7472 655f 6c69 6d69 742c 0a20 2020 2020  tre_limit,.     
-00002380: 2020 2022 7369 6e67 6c65 5f73 6964 6564     "single_sided
-00002390: 223a 2073 696e 676c 655f 7369 6465 642c  ": single_sided,
-000023a0: 0a20 2020 207d 0a0a 2020 2020 2320 4275  .    }..    # Bu
-000023b0: 6666 6572 206f 7065 7261 7469 6f6e 2061  ffer operation a
-000023c0: 6c77 6179 7320 7265 7375 6c74 7320 696e  lways results in
-000023d0: 2070 6f6c 7967 6f6e 732e 2e2e 0a20 2020   polygons....   
-000023e0: 2069 6620 6578 706c 6f64 6563 6f6c 6c65   if explodecolle
-000023f0: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-00002400: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00002410: 6d65 7472 7974 7970 6520 3d20 4765 6f6d  metrytype = Geom
-00002420: 6574 7279 5479 7065 2e50 4f4c 5947 4f4e  etryType.POLYGON
-00002430: 2e6e 616d 650a 2020 2020 656c 7365 3a0a  .name.    else:.
-00002440: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
-00002450: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-00002460: 6520 3d20 4765 6f6d 6574 7279 5479 7065  e = GeometryType
-00002470: 2e4d 554c 5449 504f 4c59 474f 4e2e 6e61  .MULTIPOLYGON.na
-00002480: 6d65 0a0a 2020 2020 2320 476f 210a 2020  me..    # Go!.  
-00002490: 2020 7265 7475 726e 205f 6170 706c 795f    return _apply_
-000024a0: 6765 6f6f 7065 7261 7469 6f6e 5f74 6f5f  geooperation_to_
-000024b0: 6c61 7965 7228 0a20 2020 2020 2020 2069  layer(.        i
-000024c0: 6e70 7574 5f70 6174 683d 696e 7075 745f  nput_path=input_
-000024d0: 7061 7468 2c0a 2020 2020 2020 2020 6f75  path,.        ou
-000024e0: 7470 7574 5f70 6174 683d 6f75 7470 7574  tput_path=output
-000024f0: 5f70 6174 682c 0a20 2020 2020 2020 206f  _path,.        o
-00002500: 7065 7261 7469 6f6e 3d47 656f 4f70 6572  peration=GeoOper
-00002510: 6174 696f 6e2e 4255 4646 4552 2c0a 2020  ation.BUFFER,.  
-00002520: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
-00002530: 7061 7261 6d73 3d6f 7065 7261 7469 6f6e  params=operation
-00002540: 5f70 6172 616d 732c 0a20 2020 2020 2020  _params,.       
-00002550: 2069 6e70 7574 5f6c 6179 6572 3d69 6e70   input_layer=inp
-00002560: 7574 5f6c 6179 6572 2c0a 2020 2020 2020  ut_layer,.      
-00002570: 2020 6f75 7470 7574 5f6c 6179 6572 3d6f    output_layer=o
-00002580: 7574 7075 745f 6c61 7965 722c 0a20 2020  utput_layer,.   
-00002590: 2020 2020 2063 6f6c 756d 6e73 3d63 6f6c       columns=col
-000025a0: 756d 6e73 2c0a 2020 2020 2020 2020 6578  umns,.        ex
-000025b0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-000025c0: 3d65 7870 6c6f 6465 636f 6c6c 6563 7469  =explodecollecti
-000025d0: 6f6e 732c 0a20 2020 2020 2020 2066 6f72  ons,.        for
-000025e0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-000025f0: 7279 7479 7065 3d66 6f72 6365 5f6f 7574  rytype=force_out
-00002600: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00002610: 2c0a 2020 2020 2020 2020 6772 6964 7369  ,.        gridsi
-00002620: 7a65 3d67 7269 6473 697a 652c 0a20 2020  ze=gridsize,.   
-00002630: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
-00002640: 3d6e 625f 7061 7261 6c6c 656c 2c0a 2020  =nb_parallel,.  
-00002650: 2020 2020 2020 6261 7463 6873 697a 653d        batchsize=
-00002660: 6261 7463 6873 697a 652c 0a20 2020 2020  batchsize,.     
-00002670: 2020 2066 6f72 6365 3d66 6f72 6365 2c0a     force=force,.
-00002680: 2020 2020 290a 0a0a 6465 6620 636f 6e76      )...def conv
-00002690: 6578 6875 6c6c 280a 2020 2020 696e 7075  exhull(.    inpu
-000026a0: 745f 7061 7468 3a20 5061 7468 2c0a 2020  t_path: Path,.  
-000026b0: 2020 6f75 7470 7574 5f70 6174 683a 2050    output_path: P
-000026c0: 6174 682c 0a20 2020 2069 6e70 7574 5f6c  ath,.    input_l
-000026d0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-000026e0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-000026f0: 6f75 7470 7574 5f6c 6179 6572 3a20 4f70  output_layer: Op
-00002700: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00002710: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
-00002720: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00002730: 7472 5d5d 203d 204e 6f6e 652c 0a20 2020  tr]] = None,.   
-00002740: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
-00002750: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-00002760: 652c 0a20 2020 2067 7269 6473 697a 653a  e,.    gridsize:
-00002770: 2066 6c6f 6174 203d 2030 2e30 2c0a 2020   float = 0.0,.  
-00002780: 2020 6e62 5f70 6172 616c 6c65 6c3a 2069    nb_parallel: i
-00002790: 6e74 203d 202d 312c 0a20 2020 2062 6174  nt = -1,.    bat
-000027a0: 6368 7369 7a65 3a20 696e 7420 3d20 2d31  chsize: int = -1
-000027b0: 2c0a 2020 2020 666f 7263 653a 2062 6f6f  ,.    force: boo
-000027c0: 6c20 3d20 4661 6c73 652c 0a29 3a0a 2020  l = False,.):.  
-000027d0: 2020 2320 496e 6974 0a20 2020 206f 7065    # Init.    ope
-000027e0: 7261 7469 6f6e 5f70 6172 616d 7320 3d20  ration_params = 
-000027f0: 7b7d 0a0a 2020 2020 2320 476f 210a 2020  {}..    # Go!.  
-00002800: 2020 7265 7475 726e 205f 6170 706c 795f    return _apply_
-00002810: 6765 6f6f 7065 7261 7469 6f6e 5f74 6f5f  geooperation_to_
-00002820: 6c61 7965 7228 0a20 2020 2020 2020 2069  layer(.        i
-00002830: 6e70 7574 5f70 6174 683d 696e 7075 745f  nput_path=input_
-00002840: 7061 7468 2c0a 2020 2020 2020 2020 6f75  path,.        ou
-00002850: 7470 7574 5f70 6174 683d 6f75 7470 7574  tput_path=output
-00002860: 5f70 6174 682c 0a20 2020 2020 2020 206f  _path,.        o
-00002870: 7065 7261 7469 6f6e 3d47 656f 4f70 6572  peration=GeoOper
-00002880: 6174 696f 6e2e 434f 4e56 4558 4855 4c4c  ation.CONVEXHULL
-00002890: 2c0a 2020 2020 2020 2020 6f70 6572 6174  ,.        operat
-000028a0: 696f 6e5f 7061 7261 6d73 3d6f 7065 7261  ion_params=opera
-000028b0: 7469 6f6e 5f70 6172 616d 732c 0a20 2020  tion_params,.   
-000028c0: 2020 2020 2069 6e70 7574 5f6c 6179 6572       input_layer
-000028d0: 3d69 6e70 7574 5f6c 6179 6572 2c0a 2020  =input_layer,.  
-000028e0: 2020 2020 2020 6f75 7470 7574 5f6c 6179        output_lay
-000028f0: 6572 3d6f 7574 7075 745f 6c61 7965 722c  er=output_layer,
-00002900: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-00002910: 3d63 6f6c 756d 6e73 2c0a 2020 2020 2020  =columns,.      
-00002920: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
-00002930: 696f 6e73 3d65 7870 6c6f 6465 636f 6c6c  ions=explodecoll
-00002940: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
-00002950: 2067 7269 6473 697a 653d 6772 6964 7369   gridsize=gridsi
-00002960: 7a65 2c0a 2020 2020 2020 2020 6e62 5f70  ze,.        nb_p
-00002970: 6172 616c 6c65 6c3d 6e62 5f70 6172 616c  arallel=nb_paral
-00002980: 6c65 6c2c 0a20 2020 2020 2020 2062 6174  lel,.        bat
-00002990: 6368 7369 7a65 3d62 6174 6368 7369 7a65  chsize=batchsize
-000029a0: 2c0a 2020 2020 2020 2020 666f 7263 653d  ,.        force=
-000029b0: 666f 7263 652c 0a20 2020 2029 0a0a 0a64  force,.    )...d
-000029c0: 6566 2073 696d 706c 6966 7928 0a20 2020  ef simplify(.   
-000029d0: 2069 6e70 7574 5f70 6174 683a 2050 6174   input_path: Pat
-000029e0: 682c 0a20 2020 206f 7574 7075 745f 7061  h,.    output_pa
-000029f0: 7468 3a20 5061 7468 2c0a 2020 2020 746f  th: Path,.    to
-00002a00: 6c65 7261 6e63 653a 2066 6c6f 6174 2c0a  lerance: float,.
-00002a10: 2020 2020 616c 676f 7269 7468 6d3a 2053      algorithm: S
-00002a20: 696d 706c 6966 7941 6c67 6f72 6974 686d  implifyAlgorithm
-00002a30: 203d 2053 696d 706c 6966 7941 6c67 6f72   = SimplifyAlgor
-00002a40: 6974 686d 2e52 414d 4552 5f44 4f55 474c  ithm.RAMER_DOUGL
-00002a50: 4153 5f50 4555 434b 4552 2c0a 2020 2020  AS_PEUCKER,.    
-00002a60: 6c6f 6f6b 6168 6561 643a 2069 6e74 203d  lookahead: int =
-00002a70: 2038 2c0a 2020 2020 696e 7075 745f 6c61   8,.    input_la
-00002a80: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00002a90: 725d 203d 204e 6f6e 652c 0a20 2020 206f  r] = None,.    o
-00002aa0: 7574 7075 745f 6c61 7965 723a 204f 7074  utput_layer: Opt
-00002ab0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00002ac0: 652c 0a20 2020 2063 6f6c 756d 6e73 3a20  e,.    columns: 
-00002ad0: 4f70 7469 6f6e 616c 5b4c 6973 745b 7374  Optional[List[st
-00002ae0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-00002af0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-00002b00: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
-00002b10: 2c0a 2020 2020 6772 6964 7369 7a65 3a20  ,.    gridsize: 
-00002b20: 666c 6f61 7420 3d20 302e 302c 0a20 2020  float = 0.0,.   
-00002b30: 206e 625f 7061 7261 6c6c 656c 3a20 696e   nb_parallel: in
-00002b40: 7420 3d20 2d31 2c0a 2020 2020 6261 7463  t = -1,.    batc
-00002b50: 6873 697a 653a 2069 6e74 203d 202d 312c  hsize: int = -1,
-00002b60: 0a20 2020 2066 6f72 6365 3a20 626f 6f6c  .    force: bool
-00002b70: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
-00002b80: 2023 2049 6e69 740a 2020 2020 6f70 6572   # Init.    oper
-00002b90: 6174 696f 6e5f 7061 7261 6d73 203d 207b  ation_params = {
-00002ba0: 0a20 2020 2020 2020 2022 746f 6c65 7261  .        "tolera
-00002bb0: 6e63 6522 3a20 746f 6c65 7261 6e63 652c  nce": tolerance,
-00002bc0: 0a20 2020 2020 2020 2022 616c 676f 7269  .        "algori
-00002bd0: 7468 6d22 3a20 616c 676f 7269 7468 6d2c  thm": algorithm,
-00002be0: 0a20 2020 2020 2020 2022 7374 6570 223a  .        "step":
-00002bf0: 206c 6f6f 6b61 6865 6164 2c0a 2020 2020   lookahead,.    
-00002c00: 7d0a 0a20 2020 2023 2047 6f21 0a20 2020  }..    # Go!.   
-00002c10: 2072 6574 7572 6e20 5f61 7070 6c79 5f67   return _apply_g
-00002c20: 656f 6f70 6572 6174 696f 6e5f 746f 5f6c  eooperation_to_l
-00002c30: 6179 6572 280a 2020 2020 2020 2020 696e  ayer(.        in
-00002c40: 7075 745f 7061 7468 3d69 6e70 7574 5f70  put_path=input_p
-00002c50: 6174 682c 0a20 2020 2020 2020 206f 7574  ath,.        out
-00002c60: 7075 745f 7061 7468 3d6f 7574 7075 745f  put_path=output_
-00002c70: 7061 7468 2c0a 2020 2020 2020 2020 6f70  path,.        op
-00002c80: 6572 6174 696f 6e3d 4765 6f4f 7065 7261  eration=GeoOpera
-00002c90: 7469 6f6e 2e53 494d 504c 4946 592c 0a20  tion.SIMPLIFY,. 
-00002ca0: 2020 2020 2020 206f 7065 7261 7469 6f6e         operation
-00002cb0: 5f70 6172 616d 733d 6f70 6572 6174 696f  _params=operatio
-00002cc0: 6e5f 7061 7261 6d73 2c0a 2020 2020 2020  n_params,.      
-00002cd0: 2020 696e 7075 745f 6c61 7965 723d 696e    input_layer=in
-00002ce0: 7075 745f 6c61 7965 722c 0a20 2020 2020  put_layer,.     
-00002cf0: 2020 206f 7574 7075 745f 6c61 7965 723d     output_layer=
-00002d00: 6f75 7470 7574 5f6c 6179 6572 2c0a 2020  output_layer,.  
-00002d10: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
-00002d20: 6c75 6d6e 732c 0a20 2020 2020 2020 2065  lumns,.        e
-00002d30: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-00002d40: 733d 6578 706c 6f64 6563 6f6c 6c65 6374  s=explodecollect
-00002d50: 696f 6e73 2c0a 2020 2020 2020 2020 6772  ions,.        gr
-00002d60: 6964 7369 7a65 3d67 7269 6473 697a 652c  idsize=gridsize,
-00002d70: 0a20 2020 2020 2020 206e 625f 7061 7261  .        nb_para
-00002d80: 6c6c 656c 3d6e 625f 7061 7261 6c6c 656c  llel=nb_parallel
-00002d90: 2c0a 2020 2020 2020 2020 6261 7463 6873  ,.        batchs
-00002da0: 697a 653d 6261 7463 6873 697a 652c 0a20  ize=batchsize,. 
-00002db0: 2020 2020 2020 2066 6f72 6365 3d66 6f72         force=for
-00002dc0: 6365 2c0a 2020 2020 290a 0a0a 6465 6620  ce,.    )...def 
-00002dd0: 5f61 7070 6c79 5f67 656f 6f70 6572 6174  _apply_geooperat
-00002de0: 696f 6e5f 746f 5f6c 6179 6572 280a 2020  ion_to_layer(.  
-00002df0: 2020 696e 7075 745f 7061 7468 3a20 5061    input_path: Pa
-00002e00: 7468 2c0a 2020 2020 6f75 7470 7574 5f70  th,.    output_p
-00002e10: 6174 683a 2050 6174 682c 0a20 2020 206f  ath: Path,.    o
-00002e20: 7065 7261 7469 6f6e 3a20 4765 6f4f 7065  peration: GeoOpe
-00002e30: 7261 7469 6f6e 2c0a 2020 2020 6f70 6572  ration,.    oper
-00002e40: 6174 696f 6e5f 7061 7261 6d73 3a20 6469  ation_params: di
-00002e50: 6374 2c0a 2020 2020 696e 7075 745f 6c61  ct,.    input_la
-00002e60: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00002e70: 725d 203d 204e 6f6e 652c 0a20 2020 2063  r] = None,.    c
-00002e80: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
-00002e90: 5b4c 6973 745b 7374 725d 5d20 3d20 4e6f  [List[str]] = No
-00002ea0: 6e65 2c0a 2020 2020 6f75 7470 7574 5f6c  ne,.    output_l
-00002eb0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-00002ec0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00002ed0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-00002ee0: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
-00002ef0: 2c0a 2020 2020 666f 7263 655f 6f75 7470  ,.    force_outp
-00002f00: 7574 5f67 656f 6d65 7472 7974 7970 653a  ut_geometrytype:
-00002f10: 2055 6e69 6f6e 5b47 656f 6d65 7472 7954   Union[GeometryT
-00002f20: 7970 652c 2073 7472 2c20 4e6f 6e65 5d20  ype, str, None] 
-00002f30: 3d20 4e6f 6e65 2c0a 2020 2020 6772 6964  = None,.    grid
-00002f40: 7369 7a65 3a20 666c 6f61 7420 3d20 302e  size: float = 0.
-00002f50: 302c 0a20 2020 206e 625f 7061 7261 6c6c  0,.    nb_parall
-00002f60: 656c 3a20 696e 7420 3d20 2d31 2c0a 2020  el: int = -1,.  
-00002f70: 2020 6261 7463 6873 697a 653a 2069 6e74    batchsize: int
-00002f80: 203d 202d 312c 0a20 2020 2066 6f72 6365   = -1,.    force
-00002f90: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00002fa0: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
-00002fb0: 7070 6c69 6573 2061 2067 656f 206f 7065  pplies a geo ope
-00002fc0: 7261 7469 6f6e 206f 6e20 6120 6c61 7965  ration on a laye
-00002fd0: 722e 0a0a 2020 2020 5468 6520 6f70 6572  r...    The oper
-00002fe0: 6174 696f 6e20 746f 2061 7070 6c79 2063  ation to apply c
-00002ff0: 616e 2062 6520 6f6e 6520 6f66 2074 6865  an be one of the
-00003000: 2074 6865 2066 6f6c 6c6f 7769 6e67 3a0a   the following:.
-00003010: 2020 2020 2020 2d20 4255 4646 4552 3a20        - BUFFER: 
-00003020: 6170 706c 7920 6120 6275 6666 6572 2e20  apply a buffer. 
-00003030: 4f70 6572 6174 696f 6e20 7061 7261 6d65  Operation parame
-00003040: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
-00003050: 2d20 6469 7374 616e 6365 3a20 6469 7374  - distance: dist
-00003060: 616e 6365 2074 6f20 6275 6666 6572 0a20  ance to buffer. 
-00003070: 2020 2020 2020 2020 202d 2071 7561 6472           - quadr
-00003080: 616e 7473 6567 6d65 6e74 733a 206e 756d  antsegments: num
-00003090: 6265 7220 6f66 2070 6f69 6e74 7320 7573  ber of points us
-000030a0: 6564 2074 6f20 7265 7072 6573 656e 7420  ed to represent 
-000030b0: 312f 3420 6f66 2061 2063 6972 636c 650a  1/4 of a circle.
-000030c0: 2020 2020 2020 2020 2020 2d20 656e 6463            - endc
-000030d0: 6170 5f73 7479 6c65 3a20 6275 6666 6572  ap_style: buffer
-000030e0: 2073 7479 6c65 2074 6f20 7573 6520 666f   style to use fo
-000030f0: 7220 6120 706f 696e 7420 6f72 2074 6865  r a point or the
-00003100: 2065 6e64 2070 6f69 6e74 7320 6f66 0a20   end points of. 
-00003110: 2020 2020 2020 2020 2020 2061 206c 696e             a lin
-00003120: 653a 0a20 2020 2020 2020 2020 2020 202d  e:.            -
-00003130: 2052 4f55 4e44 3a20 666f 7220 706f 696e   ROUND: for poin
-00003140: 7473 2061 6e64 206c 696e 6573 2074 6865  ts and lines the
-00003150: 2065 6e64 7320 6172 6520 6275 6666 6572   ends are buffer
-00003160: 6564 2072 6f75 6e64 6564 2e0a 2020 2020  ed rounded..    
-00003170: 2020 2020 2020 2020 2d20 464c 4154 3a20          - FLAT: 
-00003180: 6120 706f 696e 7420 7374 6179 7320 6120  a point stays a 
-00003190: 706f 696e 742c 2061 2062 7566 6665 7265  point, a buffere
-000031a0: 6420 6c69 6e65 2077 696c 6c20 656e 6420  d line will end 
-000031b0: 666c 6174 0a20 2020 2020 2020 2020 2020  flat.           
-000031c0: 2020 2061 7420 7468 6520 656e 6420 706f     at the end po
-000031d0: 696e 7473 0a20 2020 2020 2020 2020 2020  ints.           
-000031e0: 202d 2053 5155 4152 453a 2061 2070 6f69   - SQUARE: a poi
-000031f0: 6e74 2062 6563 6f6d 6573 2061 2073 7175  nt becomes a squ
-00003200: 6172 652c 2061 2062 7566 6665 7265 6420  are, a buffered 
-00003210: 6c69 6e65 2077 696c 6c20 656e 640a 2020  line will end.  
-00003220: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00003230: 2061 7420 7468 6520 656e 6420 706f 696e   at the end poin
-00003240: 7473 2c20 6275 7420 656c 6f6e 6761 7465  ts, but elongate
-00003250: 6420 6279 2022 6469 7374 616e 6365 220a  d by "distance".
-00003260: 2020 2020 2020 2020 2d20 6a6f 696e 5f73          - join_s
-00003270: 7479 6c65 3a20 6275 6666 6572 2073 7479  tyle: buffer sty
-00003280: 6c65 2074 6f20 7573 6520 666f 7220 636f  le to use for co
-00003290: 726e 6572 7320 696e 2061 206c 696e 6520  rners in a line 
-000032a0: 6f72 2061 2070 6f6c 7967 6f6e 0a20 2020  or a polygon.   
-000032b0: 2020 2020 2020 2062 6f75 6e64 6172 793a         boundary:
-000032c0: 0a20 2020 2020 2020 2020 2020 202d 2052  .            - R
-000032d0: 4f55 4e44 3a20 636f 726e 6572 7320 696e  OUND: corners in
-000032e0: 2074 6865 2072 6573 756c 7420 6172 6520   the result are 
-000032f0: 726f 756e 6465 640a 2020 2020 2020 2020  rounded.        
-00003300: 2020 2020 2d20 4d49 5452 453a 2063 6f72      - MITRE: cor
-00003310: 6e65 7273 2069 6e20 7468 6520 7265 7375  ners in the resu
-00003320: 6c74 2061 7265 2073 6861 7270 0a20 2020  lt are sharp.   
-00003330: 2020 2020 2020 2020 202d 2042 4556 454c           - BEVEL
-00003340: 3a20 6172 6520 666c 6174 7465 6e65 640a  : are flattened.
-00003350: 2020 2020 2020 2020 2d20 6d69 7472 655f          - mitre_
-00003360: 6c69 6d69 743a 2069 6e20 6361 7365 206f  limit: in case o
-00003370: 6620 6a6f 696e 5f73 7479 6c65 204d 4954  f join_style MIT
-00003380: 5245 2c20 6966 2074 6865 0a20 2020 2020  RE, if the.     
-00003390: 2020 2020 2020 2073 7069 6b79 2072 6573         spiky res
-000033a0: 756c 7420 666f 7220 6120 7368 6172 7020  ult for a sharp 
-000033b0: 616e 676c 6520 6265 636f 6d65 7320 6c6f  angle becomes lo
-000033c0: 6e67 6572 2074 6861 6e20 7468 6973 206c  nger than this l
-000033d0: 696d 6974 2c20 6974 0a20 2020 2020 2020  imit, it.       
-000033e0: 2020 2020 2069 7320 2262 6576 656c 6564       is "beveled
-000033f0: 2220 6174 2074 6869 7320 6469 7374 616e  " at this distan
-00003400: 6365 2e20 4465 6661 756c 7473 2074 6f20  ce. Defaults to 
-00003410: 352e 302e 0a20 2020 2020 2020 202d 2073  5.0..        - s
-00003420: 696e 676c 655f 7369 6465 643a 206f 6e6c  ingle_sided: onl
-00003430: 7920 6f6e 6520 7369 6465 206f 6620 7468  y one side of th
-00003440: 6520 6c69 6e65 2069 7320 6275 6666 6572  e line is buffer
-00003450: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-00003460: 6966 2064 6973 7461 6e63 6520 6973 206e  if distance is n
-00003470: 6567 6174 6976 652c 2074 6865 206c 6566  egative, the lef
-00003480: 7420 7369 6465 2c20 6966 2064 6973 7461  t side, if dista
-00003490: 6e63 6520 6973 2070 6f73 6974 6976 652c  nce is positive,
-000034a0: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-000034b0: 2072 6967 6874 2068 616e 6420 7369 6465   right hand side
-000034c0: 2e20 4f6e 6c79 2072 656c 6576 616e 7420  . Only relevant 
-000034d0: 666f 7220 6c69 6e65 2067 656f 6d65 7472  for line geometr
-000034e0: 6965 732e 0a20 2020 2020 202d 2043 4f4e  ies..      - CON
-000034f0: 5645 5848 554c 4c3a 2061 7070 7920 6120  VEXHULL: appy a 
-00003500: 636f 6e76 6578 2068 756c 6c2e 0a20 2020  convex hull..   
-00003510: 2020 202d 2053 494d 504c 4946 593a 2073     - SIMPLIFY: s
-00003520: 696d 706c 6966 7920 7468 6520 6765 6f6d  implify the geom
-00003530: 6574 7279 2e20 4f70 6572 6174 696f 6e20  etry. Operation 
-00003540: 7061 7261 6d65 7465 7273 3a0a 2020 2020  parameters:.    
-00003550: 2020 2020 2020 2d20 616c 676f 7269 7468        - algorith
-00003560: 6d3a 2076 6563 746f 725f 7574 696c 2e53  m: vector_util.S
-00003570: 696d 706c 6966 7941 6c67 6f72 6974 686d  implifyAlgorithm
-00003580: 0a20 2020 2020 2020 2020 202d 2074 6f6c  .          - tol
-00003590: 6572 616e 6365 3a20 6d61 7869 6d75 6d20  erance: maximum 
-000035a0: 6469 7374 616e 6365 2074 6f20 7369 6d70  distance to simp
-000035b0: 6c69 6679 2e0a 2020 2020 2020 2020 2020  lify..          
-000035c0: 2d20 6c6f 6f6b 6168 6561 643a 2066 6f72  - lookahead: for
-000035d0: 204c 414e 472c 2074 6865 206e 756d 6265   LANG, the numbe
-000035e0: 7220 6f66 2070 6f69 6e74 7320 746f 2066  r of points to f
-000035f0: 6f72 7761 7264 2d6c 6f6f 6b0a 2020 2020  orward-look.    
-00003600: 2020 2d20 4150 504c 593a 2061 7070 6c79    - APPLY: apply
-00003610: 2061 206c 616d 6264 6120 6675 6e63 7469   a lambda functi
-00003620: 6f6e 2e20 4f70 6572 6174 696f 6e20 7061  on. Operation pa
-00003630: 7261 6d65 7465 723a 0a20 2020 2020 2020  rameter:.       
-00003640: 2020 202d 2070 6963 6b6c 6564 5f66 756e     - pickled_fun
-00003650: 633a 206c 616d 6264 6120 6675 6e63 7469  c: lambda functi
-00003660: 6f6e 2074 6f20 6170 706c 792c 2070 6963  on to apply, pic
-00003670: 6b6c 6564 2074 6f20 6279 7465 732e 0a20  kled to bytes.. 
-00003680: 2020 2020 2020 2020 202d 206f 6e6c 795f           - only_
-00003690: 6765 6f6d 5f69 6e70 7574 3a20 6966 2054  geom_input: if T
-000036a0: 7275 652c 206f 6e6c 7920 7468 6520 6765  rue, only the ge
-000036b0: 6f6d 6574 7279 2069 7320 6176 6169 6c61  ometry is availa
-000036c0: 626c 6520 6173 0a20 2020 2020 2020 2020  ble as.         
-000036d0: 2020 2069 6e70 7574 2066 6f72 2074 6865     input for the
-000036e0: 206c 616d 6264 6120 6675 6e63 7469 6f6e   lambda function
-000036f0: 2e20 4966 2066 616c 7365 2c20 7468 6520  . If false, the 
-00003700: 726f 7720 6973 2074 6865 2069 6e70 7574  row is the input
-00003710: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00003720: 2020 2020 2069 6e70 7574 5f70 6174 6820       input_path 
-00003730: 2850 6174 6829 3a20 5b64 6573 6372 6970  (Path): [descrip
-00003740: 7469 6f6e 5d0a 2020 2020 2020 2020 6f75  tion].        ou
-00003750: 7470 7574 5f70 6174 6820 2850 6174 6829  tput_path (Path)
-00003760: 3a20 5b64 6573 6372 6970 7469 6f6e 5d0a  : [description].
-00003770: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
-00003780: 6e20 2847 656f 4f70 6572 6174 696f 6e29  n (GeoOperation)
-00003790: 3a20 7468 6520 6765 6f20 6f70 6572 6174  : the geo operat
-000037a0: 696f 6e20 746f 2061 7070 6c79 2e0a 2020  ion to apply..  
-000037b0: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
-000037c0: 7061 7261 6d73 2028 6469 6374 2c20 6f70  params (dict, op
-000037d0: 7469 6f6e 616c 293a 2074 6865 2070 6172  tional): the par
-000037e0: 616d 6574 6572 7320 666f 7220 7468 6520  ameters for the 
-000037f0: 6765 6f20 6f70 6572 6174 696f 6e2e 0a20  geo operation.. 
-00003800: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-00003810: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00003820: 2020 2020 2069 6e70 7574 5f6c 6179 6572       input_layer
-00003830: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-00003840: 3a20 5b64 6573 6372 6970 7469 6f6e 5d2e  : [description].
-00003850: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00003860: 652e 0a20 2020 2020 2020 206f 7574 7075  e..        outpu
-00003870: 745f 6c61 7965 7220 2873 7472 2c20 6f70  t_layer (str, op
-00003880: 7469 6f6e 616c 293a 205b 6465 7363 7269  tional): [descri
-00003890: 7074 696f 6e5d 2e20 4465 6661 756c 7473  ption]. Defaults
-000038a0: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
-000038b0: 2020 636f 6c75 6d6e 7320 284c 6973 745b    columns (List[
-000038c0: 7374 725d 2c20 6f70 7469 6f6e 616c 293a  str], optional):
-000038d0: 2049 6620 6e6f 7420 4e6f 6e65 2c20 6f6e   If not None, on
-000038e0: 6c79 206f 7574 7075 7420 7468 6520 636f  ly output the co
-000038f0: 6c75 6d6e 730a 2020 2020 2020 2020 2020  lumns.          
-00003900: 2020 7370 6563 6966 6965 642e 2044 6566    specified. Def
-00003910: 6175 6c74 7320 746f 204e 6f6e 652e 0a20  aults to None.. 
-00003920: 2020 2020 2020 2065 7870 6c6f 6465 636f         explodeco
-00003930: 6c6c 6563 7469 6f6e 7320 2862 6f6f 6c2c  llections (bool,
-00003940: 206f 7074 696f 6e61 6c29 3a20 5472 7565   optional): True
-00003950: 2074 6f20 636f 6e76 6572 7420 616c 6c20   to convert all 
-00003960: 6d75 6c74 692d 6765 6f6d 6574 7269 6573  multi-geometries
-00003970: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-00003980: 7369 6e67 756c 6172 206f 6e65 7320 6475  singular ones du
-00003990: 7269 6e67 2074 6865 2067 656f 6f70 6572  ring the geooper
-000039a0: 6174 696f 6e2e 2044 6566 6175 6c74 7320  ation. Defaults 
-000039b0: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
-000039c0: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-000039d0: 656f 6d65 7472 7974 7970 6520 2847 656f  eometrytype (Geo
-000039e0: 6d65 7472 7954 7970 652c 206f 7074 696f  metryType, optio
-000039f0: 6e61 6c29 3a20 5468 6520 6f75 7470 7574  nal): The output
-00003a00: 2067 656f 6d65 7472 7920 7479 7065 2074   geometry type t
-00003a10: 6f0a 2020 2020 2020 2020 2020 2020 666f  o.            fo
-00003a20: 7263 652e 2049 6620 4e6f 6e65 2c20 6120  rce. If None, a 
-00003a30: 6265 7374 2d65 6666 6f72 7420 6775 6573  best-effort gues
-00003a40: 7320 6973 206d 6164 652e 2044 6566 6175  s is made. Defau
-00003a50: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00003a60: 2020 2020 2067 7269 6473 697a 6520 2866       gridsize (f
-00003a70: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
-00003a80: 2074 6865 2073 697a 6520 6f66 2074 6865   the size of the
-00003a90: 2067 7269 6420 7468 6520 636f 6f72 6469   grid the coordi
-00003aa0: 6e61 7465 7320 6f66 2074 6865 206f 7570  nates of the oup
-00003ab0: 7574 0a20 2020 2020 2020 2020 2020 2077  ut.            w
-00003ac0: 696c 6c20 6265 2072 6f75 6e64 6564 2074  ill be rounded t
-00003ad0: 6f2e 2045 672e 2030 2e30 3031 2074 6f20  o. Eg. 0.001 to 
-00003ae0: 6b65 6570 2033 2064 6563 696d 616c 732e  keep 3 decimals.
-00003af0: 2056 616c 7565 2030 2e30 2064 6f65 736e   Value 0.0 doesn
-00003b00: 2774 2063 6861 6e67 650a 2020 2020 2020  't change.      
-00003b10: 2020 2020 2020 7468 6520 7072 6563 6973        the precis
-00003b20: 696f 6e2e 2044 6566 6175 6c74 7320 746f  ion. Defaults to
-00003b30: 2030 2e30 2e0a 2020 2020 2020 2020 6e62   0.0..        nb
-00003b40: 5f70 6172 616c 6c65 6c20 2869 6e74 2c20  _parallel (int, 
-00003b50: 6f70 7469 6f6e 616c 293a 205b 6465 7363  optional): [desc
-00003b60: 7269 7074 696f 6e5d 2e20 4465 6661 756c  ription]. Defaul
-00003b70: 7473 2074 6f20 2d31 2e0a 2020 2020 2020  ts to -1..      
-00003b80: 2020 6261 7463 6873 697a 6520 2869 6e74    batchsize (int
-00003b90: 2c20 6f70 7469 6f6e 616c 293a 2069 6e64  , optional): ind
-00003ba0: 6963 6174 6976 6520 6e75 6d62 6572 206f  icative number o
-00003bb0: 6620 726f 7773 2074 6f20 7072 6f63 6573  f rows to proces
-00003bc0: 7320 7065 720a 2020 2020 2020 2020 2020  s per.          
-00003bd0: 2020 6261 7463 682e 2041 2073 6d61 6c6c    batch. A small
-00003be0: 6572 2062 6174 6368 2073 697a 652c 2070  er batch size, p
-00003bf0: 6f73 7369 626c 7920 696e 2063 6f6d 6269  ossibly in combi
-00003c00: 6e61 7469 6f6e 2077 6974 6820 610a 2020  nation with a.  
-00003c10: 2020 2020 2020 2020 2020 736d 616c 6c65            smalle
-00003c20: 7220 6e62 5f70 6172 616c 6c65 6c2c 2077  r nb_parallel, w
-00003c30: 696c 6c20 7265 6475 6365 2074 6865 206d  ill reduce the m
-00003c40: 656d 6f72 7920 7573 6167 652e 0a20 2020  emory usage..   
-00003c50: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-00003c60: 7320 746f 202d 313a 2028 7472 7920 746f  s to -1: (try to
-00003c70: 2920 6465 7465 726d 696e 6520 6f70 7469  ) determine opti
-00003c80: 6d61 6c20 7369 7a65 2061 7574 6f6d 6174  mal size automat
-00003c90: 6963 616c 6c79 2e0a 2020 2020 2020 2020  ically..        
-00003ca0: 666f 7263 6520 2862 6f6f 6c2c 206f 7074  force (bool, opt
-00003cb0: 696f 6e61 6c29 3a20 5b64 6573 6372 6970  ional): [descrip
-00003cc0: 7469 6f6e 5d2e 2044 6566 6175 6c74 7320  tion]. Defaults 
-00003cd0: 746f 2046 616c 7365 2e0a 2020 2020 2222  to False..    ""
-00003ce0: 220a 2020 2020 2320 496e 6974 0a20 2020  ".    # Init.   
-00003cf0: 2073 7461 7274 5f74 696d 655f 676c 6f62   start_time_glob
-00003d00: 616c 203d 2064 6174 6574 696d 652e 6e6f  al = datetime.no
-00003d10: 7728 290a 0a20 2020 2023 2043 6865 636b  w()..    # Check
-00003d20: 2069 6e70 7574 2070 6172 616d 6574 6572   input parameter
-00003d30: 732e 2e2e 0a20 2020 206f 7065 7261 7469  s....    operati
-00003d40: 6f6e 5f6e 616d 6520 3d20 6f70 6572 6174  on_name = operat
-00003d50: 696f 6e2e 6e61 6d65 2e6c 6f77 6572 2829  ion.name.lower()
-00003d60: 0a20 2020 2069 6620 6e6f 7420 696e 7075  .    if not inpu
-00003d70: 745f 7061 7468 2e65 7869 7374 7328 293a  t_path.exists():
-00003d80: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-00003d90: 616c 7565 4572 726f 7228 6622 7b6f 7065  alueError(f"{ope
-00003da0: 7261 7469 6f6e 5f6e 616d 657d 3a20 696e  ration_name}: in
-00003db0: 7075 745f 7061 7468 2064 6f65 736e 2774  put_path doesn't
-00003dc0: 2065 7869 7374 3a20 7b69 6e70 7574 5f70   exist: {input_p
-00003dd0: 6174 687d 2229 0a20 2020 2069 6620 696e  ath}").    if in
-00003de0: 7075 745f 7061 7468 203d 3d20 6f75 7470  put_path == outp
-00003df0: 7574 5f70 6174 683a 0a20 2020 2020 2020  ut_path:.       
-00003e00: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00003e10: 7228 6622 7b6f 7065 7261 7469 6f6e 5f6e  r(f"{operation_n
-00003e20: 616d 657d 3a20 6f75 7470 7574 5f70 6174  ame}: output_pat
-00003e30: 6820 6d75 7374 206e 6f74 2065 7175 616c  h must not equal
-00003e40: 2069 6e70 7574 5f70 6174 6822 290a 2020   input_path").  
-00003e50: 2020 6966 2069 6e70 7574 5f6c 6179 6572    if input_layer
-00003e60: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00003e70: 2020 696e 7075 745f 6c61 7965 7220 3d20    input_layer = 
-00003e80: 6766 6f2e 6765 745f 6f6e 6c79 5f6c 6179  gfo.get_only_lay
-00003e90: 6572 2869 6e70 7574 5f70 6174 6829 0a20  er(input_path). 
-00003ea0: 2020 2069 6620 6f75 7470 7574 5f70 6174     if output_pat
-00003eb0: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
-00003ec0: 2020 2020 6966 2066 6f72 6365 2069 7320      if force is 
-00003ed0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00003ee0: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-00003ef0: 2253 746f 7020 7b6f 7065 7261 7469 6f6e  "Stop {operation
-00003f00: 5f6e 616d 657d 3a20 6f75 7470 7574 2065  _name}: output e
-00003f10: 7869 7374 7320 616c 7265 6164 7920 7b6f  xists already {o
-00003f20: 7574 7075 745f 7061 7468 7d22 290a 2020  utput_path}").  
-00003f30: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00003f40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00003f50: 2020 2020 2020 2020 2020 2067 666f 2e72             gfo.r
-00003f60: 656d 6f76 6528 6f75 7470 7574 5f70 6174  emove(output_pat
-00003f70: 6829 0a20 2020 2069 6620 696e 7075 745f  h).    if input_
-00003f80: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
-00003f90: 2020 2020 2020 2069 6e70 7574 5f6c 6179         input_lay
-00003fa0: 6572 203d 2067 666f 2e67 6574 5f6f 6e6c  er = gfo.get_onl
-00003fb0: 795f 6c61 7965 7228 696e 7075 745f 7061  y_layer(input_pa
-00003fc0: 7468 290a 2020 2020 6966 206f 7574 7075  th).    if outpu
-00003fd0: 745f 6c61 7965 7220 6973 204e 6f6e 653a  t_layer is None:
-00003fe0: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
-00003ff0: 6c61 7965 7220 3d20 6766 6f2e 6765 745f  layer = gfo.get_
-00004000: 6465 6661 756c 745f 6c61 7965 7228 6f75  default_layer(ou
-00004010: 7470 7574 5f70 6174 6829 0a20 2020 2069  tput_path).    i
-00004020: 6620 6973 696e 7374 616e 6365 2866 6f72  f isinstance(for
-00004030: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00004040: 7279 7479 7065 2c20 4765 6f6d 6574 7279  rytype, Geometry
-00004050: 5479 7065 293a 0a20 2020 2020 2020 2066  Type):.        f
-00004060: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00004070: 6574 7279 7479 7065 203d 2066 6f72 6365  etrytype = force
-00004080: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-00004090: 7479 7065 2e6e 616d 650a 0a20 2020 2023  type.name..    #
-000040a0: 2050 7265 7061 7265 2074 6d70 2066 696c   Prepare tmp fil
-000040b0: 6573 0a20 2020 2074 656d 7064 6972 203d  es.    tempdir =
-000040c0: 205f 696f 5f75 7469 6c2e 6372 6561 7465   _io_util.create
-000040d0: 5f74 656d 7064 6972 2866 2267 656f 6669  _tempdir(f"geofi
-000040e0: 6c65 6f70 732f 7b6f 7065 7261 7469 6f6e  leops/{operation
-000040f0: 2e76 616c 7565 7d22 290a 2020 2020 6c6f  .value}").    lo
-00004100: 6767 6572 2e69 6e66 6f28 6622 5374 6172  gger.info(f"Star
-00004110: 7420 6361 6c63 756c 6174 696f 6e20 746f  t calculation to
-00004120: 2074 656d 7020 6669 6c65 7320 696e 207b   temp files in {
-00004130: 7465 6d70 6469 727d 2229 0a0a 2020 2020  tempdir}")..    
-00004140: 2320 4361 6c63 756c 6174 650a 2020 2020  # Calculate.    
-00004150: 7472 793a 0a20 2020 2020 2020 2023 2052  try:.        # R
-00004160: 656d 6172 6b3a 2063 616c 6375 6c61 7469  emark: calculati
-00004170: 6e67 2063 616e 2062 6520 646f 6e65 2069  ng can be done i
-00004180: 6e20 7061 7261 6c6c 656c 2c20 6275 7420  n parallel, but 
-00004190: 6f6e 6c79 206f 6e65 2070 726f 6365 7373  only one process
-000041a0: 0a20 2020 2020 2020 2023 2063 616e 2077  .        # can w
-000041b0: 7269 7465 2074 6f20 7468 6520 7361 6d65  rite to the same
-000041c0: 206f 7574 7075 7420 6669 6c65 2061 7420   output file at 
-000041d0: 7468 6520 7469 6d65 2e2e 2e0a 0a20 2020  the time.....   
-000041e0: 2020 2020 2023 2043 616c 6375 6c61 7465       # Calculate
-000041f0: 2074 6865 2062 6573 7420 6e75 6d62 6572   the best number
-00004200: 206f 6620 7061 7261 6c6c 656c 2070 726f   of parallel pro
-00004210: 6365 7373 6573 2061 6e64 2062 6174 6368  cesses and batch
-00004220: 6573 2066 6f72 0a20 2020 2020 2020 2023  es for.        #
-00004230: 2074 6865 2061 7661 696c 6162 6c65 2072   the available r
-00004240: 6573 6f75 7263 6573 0a20 2020 2020 2020  esources.       
-00004250: 2069 6e70 7574 5f6c 6179 6572 696e 666f   input_layerinfo
-00004260: 203d 2067 666f 2e67 6574 5f6c 6179 6572   = gfo.get_layer
-00004270: 696e 666f 2869 6e70 7574 5f70 6174 682c  info(input_path,
-00004280: 2069 6e70 7574 5f6c 6179 6572 290a 2020   input_layer).  
-00004290: 2020 2020 2020 6e62 5f72 6f77 735f 746f        nb_rows_to
-000042a0: 7461 6c20 3d20 696e 7075 745f 6c61 7965  tal = input_laye
-000042b0: 7269 6e66 6f2e 6665 6174 7572 6563 6f75  rinfo.featurecou
-000042c0: 6e74 0a20 2020 2020 2020 2069 6620 6261  nt.        if ba
-000042d0: 7463 6873 697a 6520 3e20 303a 0a20 2020  tchsize > 0:.   
-000042e0: 2020 2020 2020 2020 2070 6172 616c 6c65           paralle
-000042f0: 6c6c 697a 6174 696f 6e5f 636f 6e66 6967  llization_config
-00004300: 203d 2050 6172 616c 6c65 6c69 7a61 7469   = Parallelizati
-00004310: 6f6e 436f 6e66 6967 280a 2020 2020 2020  onConfig(.      
-00004320: 2020 2020 2020 2020 2020 6d69 6e5f 6176            min_av
-00004330: 675f 726f 7773 5f70 6572 5f62 6174 6368  g_rows_per_batch
-00004340: 3d6d 6174 682e 6365 696c 2862 6174 6368  =math.ceil(batch
-00004350: 7369 7a65 202f 2032 292c 0a20 2020 2020  size / 2),.     
-00004360: 2020 2020 2020 2020 2020 206d 6178 5f61             max_a
-00004370: 7667 5f72 6f77 735f 7065 725f 6261 7463  vg_rows_per_batc
-00004380: 683d 6261 7463 6873 697a 652c 0a20 2020  h=batchsize,.   
-00004390: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000043a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000043b0: 2020 2020 2070 6172 616c 6c65 6c6c 697a       parallelliz
-000043c0: 6174 696f 6e5f 636f 6e66 6967 203d 2050  ation_config = P
-000043d0: 6172 616c 6c65 6c69 7a61 7469 6f6e 436f  arallelizationCo
-000043e0: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-000043f0: 2020 2020 2020 6d61 785f 6176 675f 726f        max_avg_ro
-00004400: 7773 5f70 6572 5f62 6174 6368 3d35 3030  ws_per_batch=500
-00004410: 3030 0a20 2020 2020 2020 2020 2020 2029  00.            )
-00004420: 0a20 2020 2020 2020 206e 625f 7061 7261  .        nb_para
-00004430: 6c6c 656c 2c20 6e62 5f62 6174 6368 6573  llel, nb_batches
-00004440: 2c20 7265 616c 5f62 6174 6368 7369 7a65  , real_batchsize
-00004450: 203d 2067 6574 5f70 6172 616c 6c65 6c69   = get_paralleli
-00004460: 7a61 7469 6f6e 5f70 6172 616d 7328 0a20  zation_params(. 
-00004470: 2020 2020 2020 2020 2020 206e 625f 726f             nb_ro
-00004480: 7773 5f74 6f74 616c 3d6e 625f 726f 7773  ws_total=nb_rows
-00004490: 5f74 6f74 616c 2c0a 2020 2020 2020 2020  _total,.        
-000044a0: 2020 2020 6e62 5f70 6172 616c 6c65 6c3d      nb_parallel=
-000044b0: 6e62 5f70 6172 616c 6c65 6c2c 0a20 2020  nb_parallel,.   
-000044c0: 2020 2020 2020 2020 2070 6172 616c 6c65           paralle
-000044d0: 6c69 7a61 7469 6f6e 5f63 6f6e 6669 673d  lization_config=
-000044e0: 7061 7261 6c6c 656c 6c69 7a61 7469 6f6e  parallellization
-000044f0: 5f63 6f6e 6669 672c 0a20 2020 2020 2020  _config,.       
-00004500: 2029 0a0a 2020 2020 2020 2020 2320 544f   )..        # TO
-00004510: 444f 3a20 6465 7465 726d 696e 6520 7468  DO: determine th
-00004520: 6520 6f70 7469 6d61 6c20 6261 7463 6820  e optimal batch 
-00004530: 7369 7a65 7320 7769 7468 206d 696e 2061  sizes with min a
-00004540: 6e64 206d 6178 206f 6620 726f 7769 6420  nd max of rowid 
-00004550: 7769 6c6c 0a20 2020 2020 2020 2023 2069  will.        # i
-00004560: 6e20 736f 6d65 2063 6173 6520 696d 7072  n some case impr
-00004570: 6f76 6520 7065 7266 6f72 6d61 6e63 650a  ove performance.
-00004580: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00004590: 2020 2020 7371 6c5f 7374 6d74 203d 2066      sql_stmt = f
-000045a0: 2727 2753 454c 4543 5420 4d49 4e28 726f  '''SELECT MIN(ro
-000045b0: 7769 6429 2061 7320 6d69 6e5f 726f 7769  wid) as min_rowi
-000045c0: 642c 204d 4158 2872 6f77 6964 2920 6173  d, MAX(rowid) as
-000045d0: 206d 6178 5f72 6f77 6964 0a20 2020 2020   max_rowid.     
-000045e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045f0: 2020 2020 4652 4f4d 2022 7b69 6e70 7574      FROM "{input
-00004600: 5f6c 6179 6572 7d22 2727 270a 2020 2020  _layer}"'''.    
-00004610: 2020 2020 7265 7375 6c74 203d 2067 666f      result = gfo
-00004620: 2e72 6561 645f 6669 6c65 280a 2020 2020  .read_file(.    
-00004630: 2020 2020 2020 2020 7061 7468 3d74 656d          path=tem
-00004640: 705f 7061 7468 2c20 6c61 7965 723d 696e  p_path, layer=in
-00004650: 7075 745f 6c61 7965 722c 2073 716c 5f73  put_layer, sql_s
-00004660: 746d 743d 7371 6c5f 7374 6d74 2c20 7371  tmt=sql_stmt, sq
-00004670: 6c5f 6469 616c 6563 743d 2253 514c 4954  l_dialect="SQLIT
-00004680: 4522 0a20 2020 2020 2020 2029 0a20 2020  E".        ).   
-00004690: 2020 2020 2069 6620 6c65 6e28 7265 7375       if len(resu
-000046a0: 6c74 2920 3d3d 2031 3a0a 2020 2020 2020  lt) == 1:.      
-000046b0: 2020 2020 2020 6d69 6e5f 726f 7769 6420        min_rowid 
-000046c0: 3d20 7265 7375 6c74 5b27 6d69 6e5f 726f  = result['min_ro
-000046d0: 7769 6427 5d2e 7661 6c75 6573 5b30 5d0a  wid'].values[0].
-000046e0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-000046f0: 726f 7769 6420 3d20 7265 7375 6c74 5b27  rowid = result['
-00004700: 6d61 785f 726f 7769 6427 5d2e 7661 6c75  max_rowid'].valu
-00004710: 6573 5b30 5d0a 2020 2020 2020 2020 2020  es[0].          
-00004720: 2020 6e62 5f72 6f77 6964 735f 7065 725f    nb_rowids_per_
-00004730: 6261 7463 6820 3d20 286d 6178 5f72 6f77  batch = (max_row
-00004740: 6964 202d 206d 696e 5f72 6f77 6964 292f  id - min_rowid)/
-00004750: 6e62 5f62 6174 6368 6573 0a20 2020 2020  nb_batches.     
-00004760: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004770: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-00004780: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00004790: 2020 2020 2020 6622 4572 726f 7220 6765        f"Error ge
-000047a0: 7474 696e 6720 6d69 6e20 616e 6420 6d61  tting min and ma
-000047b0: 7820 726f 7769 6420 666f 7220 7b74 656d  x rowid for {tem
-000047c0: 705f 7061 7468 7d2c 206c 6179 6572 207b  p_path}, layer {
-000047d0: 696e 7075 745f 6c61 7965 727d 220a 2020  input_layer}".  
-000047e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000047f0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00004800: 2023 2050 726f 6365 7373 696e 6720 696e   # Processing in
-00004810: 2074 6872 6561 6473 2069 7320 3278 2066   threads is 2x f
-00004820: 6173 7465 7220 666f 7220 736d 616c 6c20  aster for small 
-00004830: 6461 7461 7365 7473 2028 6f6e 2057 696e  datasets (on Win
-00004840: 646f 7773 290a 2020 2020 2020 2020 6361  dows).        ca
-00004850: 6c63 756c 6174 655f 696e 5f74 6872 6561  lculate_in_threa
-00004860: 6473 203d 2054 7275 6520 6966 2069 6e70  ds = True if inp
-00004870: 7574 5f6c 6179 6572 696e 666f 2e66 6561  ut_layerinfo.fea
-00004880: 7475 7265 636f 756e 7420 3c3d 2031 3030  turecount <= 100
-00004890: 2065 6c73 6520 4661 6c73 650a 2020 2020   else False.    
-000048a0: 2020 2020 7769 7468 205f 7072 6f63 6573      with _proces
-000048b0: 7369 6e67 5f75 7469 6c2e 506f 6f6c 6564  sing_util.Pooled
-000048c0: 4578 6563 7574 6f72 4661 6374 6f72 7928  ExecutorFactory(
-000048d0: 0a20 2020 2020 2020 2020 2020 2074 6872  .            thr
-000048e0: 6561 6470 6f6f 6c3d 6361 6c63 756c 6174  eadpool=calculat
-000048f0: 655f 696e 5f74 6872 6561 6473 2c0a 2020  e_in_threads,.  
-00004900: 2020 2020 2020 2020 2020 6d61 785f 776f            max_wo
-00004910: 726b 6572 733d 6e62 5f70 6172 616c 6c65  rkers=nb_paralle
-00004920: 6c2c 0a20 2020 2020 2020 2020 2020 2069  l,.            i
-00004930: 6e69 7469 616c 697a 6572 3d5f 7072 6f63  nitializer=_proc
-00004940: 6573 7369 6e67 5f75 7469 6c2e 696e 6974  essing_util.init
-00004950: 6961 6c69 7a65 5f77 6f72 6b65 7228 292c  ialize_worker(),
-00004960: 0a20 2020 2020 2020 2029 2061 7320 6361  .        ) as ca
-00004970: 6c63 756c 6174 655f 706f 6f6c 3a0a 2020  lculate_pool:.  
-00004980: 2020 2020 2020 2020 2020 2320 5072 6570            # Prep
-00004990: 6172 6520 6f75 7470 7574 2066 696c 656e  are output filen
-000049a0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
-000049b0: 746d 705f 6f75 7470 7574 5f70 6174 6820  tmp_output_path 
-000049c0: 3d20 7465 6d70 6469 7220 2f20 6f75 7470  = tempdir / outp
-000049d0: 7574 5f70 6174 682e 6e61 6d65 0a0a 2020  ut_path.name..  
-000049e0: 2020 2020 2020 2020 2020 726f 775f 6f66            row_of
-000049f0: 6673 6574 203d 2030 0a20 2020 2020 2020  fset = 0.       
-00004a00: 2020 2020 2062 6174 6368 6573 203d 207b       batches = {
-00004a10: 7d0a 2020 2020 2020 2020 2020 2020 6675  }.            fu
-00004a20: 7475 7265 5f74 6f5f 6261 7463 685f 6964  ture_to_batch_id
-00004a30: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-00004a40: 2020 6e62 5f64 6f6e 6520 3d20 300a 0a20    nb_done = 0.. 
-00004a50: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
-00004a60: 6174 6368 5f69 6420 696e 2072 616e 6765  atch_id in range
-00004a70: 286e 625f 6261 7463 6865 7329 3a0a 2020  (nb_batches):.  
-00004a80: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00004a90: 7463 6865 735b 6261 7463 685f 6964 5d20  tches[batch_id] 
-00004aa0: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
-00004ab0: 2020 2020 2062 6174 6368 6573 5b62 6174       batches[bat
-00004ac0: 6368 5f69 645d 5b22 6c61 7965 7222 5d20  ch_id]["layer"] 
-00004ad0: 3d20 6f75 7470 7574 5f6c 6179 6572 0a0a  = output_layer..
-00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004af0: 2320 4f75 7470 7574 2065 6163 6820 6261  # Output each ba
-00004b00: 7463 6820 746f 2061 2073 6570 6572 6174  tch to a seperat
-00004b10: 6520 7465 6d70 6f72 6172 7920 6669 6c65  e temporary file
-00004b20: 2c20 6f74 6865 7277 6973 6520 7468 6572  , otherwise ther
-00004b30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00004b40: 2020 2320 6172 6520 7469 6d65 6f75 7420    # are timeout 
-00004b50: 6973 7375 6573 2077 6865 6e20 7072 6f63  issues when proc
-00004b60: 6573 7369 6e67 206c 6172 6765 2066 696c  essing large fil
-00004b70: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00004b80: 2020 206f 7574 7075 745f 746d 705f 7061     output_tmp_pa
-00004b90: 7274 6961 6c5f 7061 7468 203d 2028 0a20  rtial_path = (. 
-00004ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bb0: 2020 2074 656d 7064 6972 202f 2066 227b     tempdir / f"{
-00004bc0: 6f75 7470 7574 5f70 6174 682e 7374 656d  output_path.stem
-00004bd0: 7d5f 7b62 6174 6368 5f69 647d 7b6f 7574  }_{batch_id}{out
-00004be0: 7075 745f 7061 7468 2e73 7566 6669 787d  put_path.suffix}
-00004bf0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00004c00: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00004c10: 2020 2020 6261 7463 6865 735b 6261 7463      batches[batc
-00004c20: 685f 6964 5d5b 2274 6d70 5f70 6172 7469  h_id]["tmp_parti
-00004c30: 616c 5f6f 7574 7075 745f 7061 7468 225d  al_output_path"]
-00004c40: 203d 206f 7574 7075 745f 746d 705f 7061   = output_tmp_pa
-00004c50: 7274 6961 6c5f 7061 7468 0a0a 2020 2020  rtial_path..    
-00004c60: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
-00004c70: 7220 7468 6520 6c61 7374 2074 7261 6e73  r the last trans
-00004c80: 6c61 7465 5f69 642c 2074 616b 6520 616c  late_id, take al
-00004c90: 6c20 726f 7769 6427 7320 6c65 6674 2e2e  l rowid's left..
-00004ca0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00004cb0: 2020 6966 2062 6174 6368 5f69 6420 3c20    if batch_id < 
-00004cc0: 6e62 5f62 6174 6368 6573 202d 2031 3a0a  nb_batches - 1:.
-00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ce0: 2020 2020 726f 7773 203d 2073 6c69 6365      rows = slice
-00004cf0: 2872 6f77 5f6f 6666 7365 742c 2072 6f77  (row_offset, row
-00004d00: 5f6f 6666 7365 7420 2b20 7265 616c 5f62  _offset + real_b
-00004d10: 6174 6368 7369 7a65 290a 2020 2020 2020  atchsize).      
-00004d20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00004d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d40: 2020 2020 726f 7773 203d 2073 6c69 6365      rows = slice
-00004d50: 2872 6f77 5f6f 6666 7365 742c 206e 625f  (row_offset, nb_
-00004d60: 726f 7773 5f74 6f74 616c 290a 0a20 2020  rows_total)..   
-00004d70: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-00004d80: 656d 6172 6b3a 2074 6869 7320 7465 6d70  emark: this temp
-00004d90: 2066 696c 6520 646f 6573 6e27 7420 6e65   file doesn't ne
-00004da0: 6564 2073 7061 7469 616c 2069 6e64 6578  ed spatial index
-00004db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004dc0: 2023 2052 656d 6172 6b3a 2062 6563 6175   # Remark: becau
-00004dd0: 7365 2066 6f72 6365 5f6f 7574 7075 745f  se force_output_
-00004de0: 6765 6f6d 6574 7279 7479 7065 2066 6f72  geometrytype for
-00004df0: 2047 656f 4461 7461 4672 616d 650a 2020   GeoDataFrame.  
-00004e00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00004e10: 6f70 6572 6174 696f 6e73 2069 7320 2861  operations is (a
-00004e20: 206c 6f74 2920 6d6f 7265 206c 696d 6974   lot) more limit
-00004e30: 6564 2074 6861 6e20 6764 616c 2d62 6173  ed than gdal-bas
-00004e40: 6564 2c20 7468 6520 6764 616c 2076 6572  ed, the gdal ver
-00004e50: 7369 6f6e 0a20 2020 2020 2020 2020 2020  sion.           
-00004e60: 2020 2020 2023 2069 7320 7573 6564 206c       # is used l
-00004e70: 6174 6572 206f 6e20 7768 656e 2074 6865  ater on when the
-00004e80: 2072 6573 756c 7473 2061 7265 206d 6572   results are mer
-00004e90: 6765 6420 746f 2074 6865 2072 6573 756c  ged to the resul
-00004ea0: 7420 6669 6c65 2e0a 2020 2020 2020 2020  t file..        
-00004eb0: 2020 2020 2020 2020 6675 7475 7265 203d          future =
-00004ec0: 2063 616c 6375 6c61 7465 5f70 6f6f 6c2e   calculate_pool.
-00004ed0: 7375 626d 6974 280a 2020 2020 2020 2020  submit(.        
-00004ee0: 2020 2020 2020 2020 2020 2020 5f61 7070              _app
-00004ef0: 6c79 5f67 656f 6f70 6572 6174 696f 6e2c  ly_geooperation,
-00004f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004f10: 2020 2020 2069 6e70 7574 5f70 6174 683d       input_path=
-00004f20: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
-00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f40: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
-00004f50: 7574 5f74 6d70 5f70 6172 7469 616c 5f70  ut_tmp_partial_p
-00004f60: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00004f70: 2020 2020 2020 2020 206f 7065 7261 7469           operati
-00004f80: 6f6e 3d6f 7065 7261 7469 6f6e 2c0a 2020  on=operation,.  
-00004f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fa0: 2020 6f70 6572 6174 696f 6e5f 7061 7261    operation_para
-00004fb0: 6d73 3d6f 7065 7261 7469 6f6e 5f70 6172  ms=operation_par
-00004fc0: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-00004fd0: 2020 2020 2020 2020 2069 6e70 7574 5f6c           input_l
-00004fe0: 6179 6572 3d69 6e70 7574 5f6c 6179 6572  ayer=input_layer
-00004ff0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005000: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
-00005010: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
-00005020: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00005030: 745f 6c61 7965 723d 6f75 7470 7574 5f6c  t_layer=output_l
-00005040: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-00005050: 2020 2020 2020 2020 2020 726f 7773 3d72            rows=r
-00005060: 6f77 732c 0a20 2020 2020 2020 2020 2020  ows,.           
-00005070: 2020 2020 2020 2020 2065 7870 6c6f 6465           explode
-00005080: 636f 6c6c 6563 7469 6f6e 733d 6578 706c  collections=expl
-00005090: 6f64 6563 6f6c 6c65 6374 696f 6e73 2c0a  odecollections,.
-000050a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050b0: 2020 2020 6772 6964 7369 7a65 3d67 7269      gridsize=gri
-000050c0: 6473 697a 652c 0a20 2020 2020 2020 2020  dsize,.         
-000050d0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-000050e0: 3d66 6f72 6365 2c0a 2020 2020 2020 2020  =force,.        
-000050f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00005100: 2020 2020 2020 2020 2020 6675 7475 7265            future
-00005110: 5f74 6f5f 6261 7463 685f 6964 5b66 7574  _to_batch_id[fut
-00005120: 7572 655d 203d 2062 6174 6368 5f69 640a  ure] = batch_id.
-00005130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005140: 726f 775f 6f66 6673 6574 202b 3d20 7265  row_offset += re
-00005150: 616c 5f62 6174 6368 7369 7a65 0a0a 2020  al_batchsize..  
-00005160: 2020 2020 2020 2020 2020 2320 4c6f 6f70            # Loop
-00005170: 2074 696c 6c20 616c 6c20 7061 7261 6c6c   till all parall
-00005180: 656c 2070 726f 6365 7373 6573 2061 7265  el processes are
-00005190: 2072 6561 6479 2c20 6275 7420 7072 6f63   ready, but proc
-000051a0: 6573 7320 6561 6368 206f 6e65 0a20 2020  ess each one.   
-000051b0: 2020 2020 2020 2020 2023 2074 6861 7420           # that 
-000051c0: 6973 2072 6561 6479 2061 6c72 6561 6479  is ready already
-000051d0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000051e0: 7274 5f74 696d 6520 3d20 6461 7465 7469  rt_time = dateti
-000051f0: 6d65 2e6e 6f77 2829 0a20 2020 2020 2020  me.now().       
-00005200: 2020 2020 205f 6765 6e65 7261 6c5f 7574       _general_ut
-00005210: 696c 2e72 6570 6f72 745f 7072 6f67 7265  il.report_progre
-00005220: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
-00005230: 2020 2020 7374 6172 745f 7469 6d65 2c20      start_time, 
-00005240: 6e62 5f64 6f6e 652c 206e 625f 6261 7463  nb_done, nb_batc
-00005250: 6865 732c 206f 7065 7261 7469 6f6e 2e76  hes, operation.v
-00005260: 616c 7565 2c20 6e62 5f70 6172 616c 6c65  alue, nb_paralle
-00005270: 6c0a 2020 2020 2020 2020 2020 2020 290a  l.            ).
-00005280: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00005290: 6675 7475 7265 2069 6e20 6675 7475 7265  future in future
-000052a0: 732e 6173 5f63 6f6d 706c 6574 6564 2866  s.as_completed(f
-000052b0: 7574 7572 655f 746f 5f62 6174 6368 5f69  uture_to_batch_i
-000052c0: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
-000052d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000052e0: 2020 2020 2020 2020 2020 2020 206d 6573               mes
-000052f0: 7361 6765 203d 2066 7574 7572 652e 7265  sage = future.re
-00005300: 7375 6c74 2829 0a20 2020 2020 2020 2020  sult().         
-00005310: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00005320: 722e 6465 6275 6728 6d65 7373 6167 6529  r.debug(message)
-00005330: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005340: 2020 2020 2020 2320 4966 2074 6865 2063        # If the c
-00005350: 616c 6375 6c61 7465 2067 6176 6520 7265  alculate gave re
-00005360: 7375 6c74 732c 2063 6f70 7920 746f 206f  sults, copy to o
-00005370: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
-00005380: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
-00005390: 6964 203d 2066 7574 7572 655f 746f 5f62  id = future_to_b
-000053a0: 6174 6368 5f69 645b 6675 7475 7265 5d0a  atch_id[future].
-000053b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053c0: 2020 2020 746d 705f 7061 7274 6961 6c5f      tmp_partial_
-000053d0: 6f75 7470 7574 5f70 6174 6820 3d20 6261  output_path = ba
-000053e0: 7463 6865 735b 6261 7463 685f 6964 5d5b  tches[batch_id][
-000053f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005400: 2020 2020 2020 2020 2022 746d 705f 7061           "tmp_pa
-00005410: 7274 6961 6c5f 6f75 7470 7574 5f70 6174  rtial_output_pat
-00005420: 6822 0a20 2020 2020 2020 2020 2020 2020  h".             
-00005430: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00005440: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00005450: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00005460: 2020 2020 2020 2020 2020 746d 705f 7061            tmp_pa
-00005470: 7274 6961 6c5f 6f75 7470 7574 5f70 6174  rtial_output_pat
-00005480: 682e 6578 6973 7473 2829 0a20 2020 2020  h.exists().     
-00005490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054a0: 2020 2061 6e64 2074 6d70 5f70 6172 7469     and tmp_parti
-000054b0: 616c 5f6f 7574 7075 745f 7061 7468 2e73  al_output_path.s
-000054c0: 7461 7428 292e 7374 5f73 697a 6520 3e20  tat().st_size > 
-000054d0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-000054e0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-000054f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005500: 2023 2052 656d 6172 6b3a 2062 6563 6175   # Remark: becau
-00005510: 7365 2066 6f72 6365 5f6f 7574 7075 745f  se force_output_
-00005520: 6765 6f6d 6574 7279 7479 7065 2066 6f72  geometrytype for
-00005530: 2047 656f 4461 7461 4672 616d 650a 2020   GeoDataFrame.  
-00005540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005550: 2020 2020 2020 2320 6f70 6572 6174 696f        # operatio
-00005560: 6e73 2069 7320 2861 206c 6f74 2920 6d6f  ns is (a lot) mo
-00005570: 7265 206c 696d 6974 6564 2074 6861 6e20  re limited than 
-00005580: 6764 616c 2d62 6173 6564 2c20 7573 6520  gdal-based, use 
-00005590: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-000055a0: 2020 2020 2020 2020 2020 2020 2320 6764              # gd
-000055b0: 616c 2076 6572 7369 6f6e 2076 6961 205f  al version via _
-000055c0: 6170 7065 6e64 5f74 6f5f 6e6f 6c6f 636b  append_to_nolock
-000055d0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000055e0: 2020 2020 2020 2020 2020 6966 206e 625f            if nb_
-000055f0: 6261 7463 6865 7320 3d3d 2031 2061 6e64  batches == 1 and
-00005600: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00005610: 6f6d 6574 7279 7479 7065 2069 7320 4e6f  ometrytype is No
-00005620: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00005630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005640: 6766 6f2e 6d6f 7665 2874 6d70 5f70 6172  gfo.move(tmp_par
-00005650: 7469 616c 5f6f 7574 7075 745f 7061 7468  tial_output_path
-00005660: 2c20 746d 705f 6f75 7470 7574 5f70 6174  , tmp_output_pat
-00005670: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00005680: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00005690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000056a0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-000056b0: 656f 7073 2e5f 6170 7065 6e64 5f74 6f5f  eops._append_to_
-000056c0: 6e6f 6c6f 636b 280a 2020 2020 2020 2020  nolock(.        
-000056d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056e0: 2020 2020 2020 2020 7372 633d 746d 705f          src=tmp_
-000056f0: 7061 7274 6961 6c5f 6f75 7470 7574 5f70  partial_output_p
-00005700: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00005710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005720: 2020 2020 2064 7374 3d74 6d70 5f6f 7574       dst=tmp_out
-00005730: 7075 745f 7061 7468 2c0a 2020 2020 2020  put_path,.      
-00005740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005750: 2020 2020 2020 2020 2020 6578 706c 6f64            explod
-00005760: 6563 6f6c 6c65 6374 696f 6e73 3d65 7870  ecollections=exp
-00005770: 6c6f 6465 636f 6c6c 6563 7469 6f6e 732c  lodecollections,
-00005780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001c10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001c30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001c40: 2323 0a0a 0a64 6566 2061 7070 6c79 280a  ##...def apply(.
+00001c50: 2020 2020 696e 7075 745f 7061 7468 3a20      input_path: 
+00001c60: 5061 7468 2c0a 2020 2020 6f75 7470 7574  Path,.    output
+00001c70: 5f70 6174 683a 2050 6174 682c 0a20 2020  _path: Path,.   
+00001c80: 2066 756e 633a 2043 616c 6c61 626c 655b   func: Callable[
+00001c90: 5b41 6e79 5d2c 2041 6e79 5d2c 0a20 2020  [Any], Any],.   
+00001ca0: 206f 6e6c 795f 6765 6f6d 5f69 6e70 7574   only_geom_input
+00001cb0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00001cc0: 2020 2069 6e70 7574 5f6c 6179 6572 3a20     input_layer: 
+00001cd0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00001ce0: 4e6f 6e65 2c0a 2020 2020 6f75 7470 7574  None,.    output
+00001cf0: 5f6c 6179 6572 3a20 4f70 7469 6f6e 616c  _layer: Optional
+00001d00: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+00001d10: 2020 636f 6c75 6d6e 733a 204f 7074 696f    columns: Optio
+00001d20: 6e61 6c5b 4c69 7374 5b73 7472 5d5d 203d  nal[List[str]] =
+00001d30: 204e 6f6e 652c 0a20 2020 2065 7870 6c6f   None,.    explo
+00001d40: 6465 636f 6c6c 6563 7469 6f6e 733a 2062  decollections: b
+00001d50: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00001d60: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+00001d70: 6f6d 6574 7279 7479 7065 3a20 556e 696f  ometrytype: Unio
+00001d80: 6e5b 4765 6f6d 6574 7279 5479 7065 2c20  n[GeometryType, 
+00001d90: 7374 722c 204e 6f6e 655d 203d 204e 6f6e  str, None] = Non
+00001da0: 652c 0a20 2020 2067 7269 6473 697a 653a  e,.    gridsize:
+00001db0: 2066 6c6f 6174 203d 2030 2e30 2c0a 2020   float = 0.0,.  
+00001dc0: 2020 6b65 6570 5f65 6d70 7479 5f67 656f    keep_empty_geo
+00001dd0: 6d73 3a20 626f 6f6c 203d 2054 7275 652c  ms: bool = True,
+00001de0: 0a20 2020 2077 6865 7265 3a20 4f70 7469  .    where: Opti
+00001df0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00001e00: 2c0a 2020 2020 6e62 5f70 6172 616c 6c65  ,.    nb_paralle
+00001e10: 6c3a 2069 6e74 203d 202d 312c 0a20 2020  l: int = -1,.   
+00001e20: 2062 6174 6368 7369 7a65 3a20 696e 7420   batchsize: int 
+00001e30: 3d20 2d31 2c0a 2020 2020 666f 7263 653a  = -1,.    force:
+00001e40: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
+00001e50: 3a0a 2020 2020 2320 496e 6974 0a20 2020  :.    # Init.   
+00001e60: 206f 7065 7261 7469 6f6e 5f70 6172 616d   operation_param
+00001e70: 7320 3d20 7b0a 2020 2020 2020 2020 226f  s = {.        "o
+00001e80: 6e6c 795f 6765 6f6d 5f69 6e70 7574 223a  nly_geom_input":
+00001e90: 206f 6e6c 795f 6765 6f6d 5f69 6e70 7574   only_geom_input
+00001ea0: 2c0a 2020 2020 2020 2020 2270 6963 6b6c  ,.        "pickl
+00001eb0: 6564 5f66 756e 6322 3a20 636c 6f75 6470  ed_func": cloudp
+00001ec0: 6963 6b6c 652e 6475 6d70 7328 6675 6e63  ickle.dumps(func
+00001ed0: 292c 0a20 2020 207d 0a0a 2020 2020 2320  ),.    }..    # 
+00001ee0: 476f 210a 2020 2020 7265 7475 726e 205f  Go!.    return _
+00001ef0: 6170 706c 795f 6765 6f6f 7065 7261 7469  apply_geooperati
+00001f00: 6f6e 5f74 6f5f 6c61 7965 7228 0a20 2020  on_to_layer(.   
+00001f10: 2020 2020 2069 6e70 7574 5f70 6174 683d       input_path=
+00001f20: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
+00001f30: 2020 2020 6f75 7470 7574 5f70 6174 683d      output_path=
+00001f40: 6f75 7470 7574 5f70 6174 682c 0a20 2020  output_path,.   
+00001f50: 2020 2020 206f 7065 7261 7469 6f6e 3d47       operation=G
+00001f60: 656f 4f70 6572 6174 696f 6e2e 4150 504c  eoOperation.APPL
+00001f70: 592c 0a20 2020 2020 2020 206f 7065 7261  Y,.        opera
+00001f80: 7469 6f6e 5f70 6172 616d 733d 6f70 6572  tion_params=oper
+00001f90: 6174 696f 6e5f 7061 7261 6d73 2c0a 2020  ation_params,.  
+00001fa0: 2020 2020 2020 696e 7075 745f 6c61 7965        input_laye
+00001fb0: 723d 696e 7075 745f 6c61 7965 722c 0a20  r=input_layer,. 
+00001fc0: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
+00001fd0: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
+00001fe0: 2c0a 2020 2020 2020 2020 636f 6c75 6d6e  ,.        column
+00001ff0: 733d 636f 6c75 6d6e 732c 0a20 2020 2020  s=columns,.     
+00002000: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+00002010: 7469 6f6e 733d 6578 706c 6f64 6563 6f6c  tions=explodecol
+00002020: 6c65 6374 696f 6e73 2c0a 2020 2020 2020  lections,.      
+00002030: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
+00002040: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
+00002050: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00002060: 7974 7970 652c 0a20 2020 2020 2020 2067  ytype,.        g
+00002070: 7269 6473 697a 653d 6772 6964 7369 7a65  ridsize=gridsize
+00002080: 2c0a 2020 2020 2020 2020 6b65 6570 5f65  ,.        keep_e
+00002090: 6d70 7479 5f67 656f 6d73 3d6b 6565 705f  mpty_geoms=keep_
+000020a0: 656d 7074 795f 6765 6f6d 732c 0a20 2020  empty_geoms,.   
+000020b0: 2020 2020 2077 6865 7265 3d77 6865 7265       where=where
+000020c0: 2c0a 2020 2020 2020 2020 6e62 5f70 6172  ,.        nb_par
+000020d0: 616c 6c65 6c3d 6e62 5f70 6172 616c 6c65  allel=nb_paralle
+000020e0: 6c2c 0a20 2020 2020 2020 2062 6174 6368  l,.        batch
+000020f0: 7369 7a65 3d62 6174 6368 7369 7a65 2c0a  size=batchsize,.
+00002100: 2020 2020 2020 2020 666f 7263 653d 666f          force=fo
+00002110: 7263 652c 0a20 2020 2029 0a0a 0a64 6566  rce,.    )...def
+00002120: 2062 7566 6665 7228 0a20 2020 2069 6e70   buffer(.    inp
+00002130: 7574 5f70 6174 683a 2050 6174 682c 0a20  ut_path: Path,. 
+00002140: 2020 206f 7574 7075 745f 7061 7468 3a20     output_path: 
+00002150: 5061 7468 2c0a 2020 2020 6469 7374 616e  Path,.    distan
+00002160: 6365 3a20 666c 6f61 742c 0a20 2020 2071  ce: float,.    q
+00002170: 7561 6472 616e 7473 6567 6d65 6e74 733a  uadrantsegments:
+00002180: 2069 6e74 203d 2035 2c0a 2020 2020 656e   int = 5,.    en
+00002190: 6463 6170 5f73 7479 6c65 3a20 4275 6666  dcap_style: Buff
+000021a0: 6572 456e 6443 6170 5374 796c 6520 3d20  erEndCapStyle = 
+000021b0: 4275 6666 6572 456e 6443 6170 5374 796c  BufferEndCapStyl
+000021c0: 652e 524f 554e 442c 0a20 2020 206a 6f69  e.ROUND,.    joi
+000021d0: 6e5f 7374 796c 653a 2042 7566 6665 724a  n_style: BufferJ
+000021e0: 6f69 6e53 7479 6c65 203d 2042 7566 6665  oinStyle = Buffe
+000021f0: 724a 6f69 6e53 7479 6c65 2e52 4f55 4e44  rJoinStyle.ROUND
+00002200: 2c0a 2020 2020 6d69 7472 655f 6c69 6d69  ,.    mitre_limi
+00002210: 743a 2066 6c6f 6174 203d 2035 2e30 2c0a  t: float = 5.0,.
+00002220: 2020 2020 7369 6e67 6c65 5f73 6964 6564      single_sided
+00002230: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00002240: 2020 2020 696e 7075 745f 6c61 7965 723a      input_layer:
+00002250: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00002260: 204e 6f6e 652c 0a20 2020 206f 7574 7075   None,.    outpu
+00002270: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
+00002280: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00002290: 2020 2063 6f6c 756d 6e73 3a20 4f70 7469     columns: Opti
+000022a0: 6f6e 616c 5b4c 6973 745b 7374 725d 5d20  onal[List[str]] 
+000022b0: 3d20 4e6f 6e65 2c0a 2020 2020 6578 706c  = None,.    expl
+000022c0: 6f64 6563 6f6c 6c65 6374 696f 6e73 3a20  odecollections: 
+000022d0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+000022e0: 2020 6772 6964 7369 7a65 3a20 666c 6f61    gridsize: floa
+000022f0: 7420 3d20 302e 302c 0a20 2020 206b 6565  t = 0.0,.    kee
+00002300: 705f 656d 7074 795f 6765 6f6d 733a 2062  p_empty_geoms: b
+00002310: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+00002320: 7768 6572 653a 204f 7074 696f 6e61 6c5b  where: Optional[
+00002330: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00002340: 206e 625f 7061 7261 6c6c 656c 3a20 696e   nb_parallel: in
+00002350: 7420 3d20 2d31 2c0a 2020 2020 6261 7463  t = -1,.    batc
+00002360: 6873 697a 653a 2069 6e74 203d 202d 312c  hsize: int = -1,
+00002370: 0a20 2020 2066 6f72 6365 3a20 626f 6f6c  .    force: bool
+00002380: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
+00002390: 2023 2049 6e69 740a 2020 2020 6f70 6572   # Init.    oper
+000023a0: 6174 696f 6e5f 7061 7261 6d73 203d 207b  ation_params = {
+000023b0: 0a20 2020 2020 2020 2022 6469 7374 616e  .        "distan
+000023c0: 6365 223a 2064 6973 7461 6e63 652c 0a20  ce": distance,. 
+000023d0: 2020 2020 2020 2022 7175 6164 7261 6e74         "quadrant
+000023e0: 7365 676d 656e 7473 223a 2071 7561 6472  segments": quadr
+000023f0: 616e 7473 6567 6d65 6e74 732c 0a20 2020  antsegments,.   
+00002400: 2020 2020 2022 656e 6463 6170 5f73 7479       "endcap_sty
+00002410: 6c65 223a 2065 6e64 6361 705f 7374 796c  le": endcap_styl
+00002420: 652c 0a20 2020 2020 2020 2022 6a6f 696e  e,.        "join
+00002430: 5f73 7479 6c65 223a 206a 6f69 6e5f 7374  _style": join_st
+00002440: 796c 652c 0a20 2020 2020 2020 2022 6d69  yle,.        "mi
+00002450: 7472 655f 6c69 6d69 7422 3a20 6d69 7472  tre_limit": mitr
+00002460: 655f 6c69 6d69 742c 0a20 2020 2020 2020  e_limit,.       
+00002470: 2022 7369 6e67 6c65 5f73 6964 6564 223a   "single_sided":
+00002480: 2073 696e 676c 655f 7369 6465 642c 0a20   single_sided,. 
+00002490: 2020 207d 0a0a 2020 2020 2320 4275 6666     }..    # Buff
+000024a0: 6572 206f 7065 7261 7469 6f6e 2061 6c77  er operation alw
+000024b0: 6179 7320 7265 7375 6c74 7320 696e 2070  ays results in p
+000024c0: 6f6c 7967 6f6e 732e 2e2e 0a20 2020 2069  olygons....    i
+000024d0: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
+000024e0: 696f 6e73 3a0a 2020 2020 2020 2020 666f  ions:.        fo
+000024f0: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00002500: 7472 7974 7970 6520 3d20 4765 6f6d 6574  trytype = Geomet
+00002510: 7279 5479 7065 2e50 4f4c 5947 4f4e 2e6e  ryType.POLYGON.n
+00002520: 616d 650a 2020 2020 656c 7365 3a0a 2020  ame.    else:.  
+00002530: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+00002540: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+00002550: 3d20 4765 6f6d 6574 7279 5479 7065 2e4d  = GeometryType.M
+00002560: 554c 5449 504f 4c59 474f 4e2e 6e61 6d65  ULTIPOLYGON.name
+00002570: 0a0a 2020 2020 2320 476f 210a 2020 2020  ..    # Go!.    
+00002580: 7265 7475 726e 205f 6170 706c 795f 6765  return _apply_ge
+00002590: 6f6f 7065 7261 7469 6f6e 5f74 6f5f 6c61  ooperation_to_la
+000025a0: 7965 7228 0a20 2020 2020 2020 2069 6e70  yer(.        inp
+000025b0: 7574 5f70 6174 683d 696e 7075 745f 7061  ut_path=input_pa
+000025c0: 7468 2c0a 2020 2020 2020 2020 6f75 7470  th,.        outp
+000025d0: 7574 5f70 6174 683d 6f75 7470 7574 5f70  ut_path=output_p
+000025e0: 6174 682c 0a20 2020 2020 2020 206f 7065  ath,.        ope
+000025f0: 7261 7469 6f6e 3d47 656f 4f70 6572 6174  ration=GeoOperat
+00002600: 696f 6e2e 4255 4646 4552 2c0a 2020 2020  ion.BUFFER,.    
+00002610: 2020 2020 6f70 6572 6174 696f 6e5f 7061      operation_pa
+00002620: 7261 6d73 3d6f 7065 7261 7469 6f6e 5f70  rams=operation_p
+00002630: 6172 616d 732c 0a20 2020 2020 2020 2069  arams,.        i
+00002640: 6e70 7574 5f6c 6179 6572 3d69 6e70 7574  nput_layer=input
+00002650: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
+00002660: 6f75 7470 7574 5f6c 6179 6572 3d6f 7574  output_layer=out
+00002670: 7075 745f 6c61 7965 722c 0a20 2020 2020  put_layer,.     
+00002680: 2020 2063 6f6c 756d 6e73 3d63 6f6c 756d     columns=colum
+00002690: 6e73 2c0a 2020 2020 2020 2020 6578 706c  ns,.        expl
+000026a0: 6f64 6563 6f6c 6c65 6374 696f 6e73 3d65  odecollections=e
+000026b0: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+000026c0: 732c 0a20 2020 2020 2020 2066 6f72 6365  s,.        force
+000026d0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+000026e0: 7479 7065 3d66 6f72 6365 5f6f 7574 7075  type=force_outpu
+000026f0: 745f 6765 6f6d 6574 7279 7479 7065 2c0a  t_geometrytype,.
+00002700: 2020 2020 2020 2020 6772 6964 7369 7a65          gridsize
+00002710: 3d67 7269 6473 697a 652c 0a20 2020 2020  =gridsize,.     
+00002720: 2020 206b 6565 705f 656d 7074 795f 6765     keep_empty_ge
+00002730: 6f6d 733d 6b65 6570 5f65 6d70 7479 5f67  oms=keep_empty_g
+00002740: 656f 6d73 2c0a 2020 2020 2020 2020 7768  eoms,.        wh
+00002750: 6572 653d 7768 6572 652c 0a20 2020 2020  ere=where,.     
+00002760: 2020 206e 625f 7061 7261 6c6c 656c 3d6e     nb_parallel=n
+00002770: 625f 7061 7261 6c6c 656c 2c0a 2020 2020  b_parallel,.    
+00002780: 2020 2020 6261 7463 6873 697a 653d 6261      batchsize=ba
+00002790: 7463 6873 697a 652c 0a20 2020 2020 2020  tchsize,.       
+000027a0: 2066 6f72 6365 3d66 6f72 6365 2c0a 2020   force=force,.  
+000027b0: 2020 290a 0a0a 6465 6620 636f 6e76 6578    )...def convex
+000027c0: 6875 6c6c 280a 2020 2020 696e 7075 745f  hull(.    input_
+000027d0: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
+000027e0: 6f75 7470 7574 5f70 6174 683a 2050 6174  output_path: Pat
+000027f0: 682c 0a20 2020 2069 6e70 7574 5f6c 6179  h,.    input_lay
+00002800: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00002810: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6f75  ] = None,.    ou
+00002820: 7470 7574 5f6c 6179 6572 3a20 4f70 7469  tput_layer: Opti
+00002830: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00002840: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
+00002850: 7074 696f 6e61 6c5b 4c69 7374 5b73 7472  ptional[List[str
+00002860: 5d5d 203d 204e 6f6e 652c 0a20 2020 2065  ]] = None,.    e
+00002870: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+00002880: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+00002890: 0a20 2020 2067 7269 6473 697a 653a 2066  .    gridsize: f
+000028a0: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
+000028b0: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
+000028c0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+000028d0: 2020 2077 6865 7265 3a20 4f70 7469 6f6e     where: Option
+000028e0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+000028f0: 2020 2020 6e62 5f70 6172 616c 6c65 6c3a      nb_parallel:
+00002900: 2069 6e74 203d 202d 312c 0a20 2020 2062   int = -1,.    b
+00002910: 6174 6368 7369 7a65 3a20 696e 7420 3d20  atchsize: int = 
+00002920: 2d31 2c0a 2020 2020 666f 7263 653a 2062  -1,.    force: b
+00002930: 6f6f 6c20 3d20 4661 6c73 652c 0a29 3a0a  ool = False,.):.
+00002940: 2020 2020 2320 496e 6974 0a20 2020 206f      # Init.    o
+00002950: 7065 7261 7469 6f6e 5f70 6172 616d 7320  peration_params 
+00002960: 3d20 7b7d 0a0a 2020 2020 2320 476f 210a  = {}..    # Go!.
+00002970: 2020 2020 7265 7475 726e 205f 6170 706c      return _appl
+00002980: 795f 6765 6f6f 7065 7261 7469 6f6e 5f74  y_geooperation_t
+00002990: 6f5f 6c61 7965 7228 0a20 2020 2020 2020  o_layer(.       
+000029a0: 2069 6e70 7574 5f70 6174 683d 696e 7075   input_path=inpu
+000029b0: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
+000029c0: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
+000029d0: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
+000029e0: 206f 7065 7261 7469 6f6e 3d47 656f 4f70   operation=GeoOp
+000029f0: 6572 6174 696f 6e2e 434f 4e56 4558 4855  eration.CONVEXHU
+00002a00: 4c4c 2c0a 2020 2020 2020 2020 6f70 6572  LL,.        oper
+00002a10: 6174 696f 6e5f 7061 7261 6d73 3d6f 7065  ation_params=ope
+00002a20: 7261 7469 6f6e 5f70 6172 616d 732c 0a20  ration_params,. 
+00002a30: 2020 2020 2020 2069 6e70 7574 5f6c 6179         input_lay
+00002a40: 6572 3d69 6e70 7574 5f6c 6179 6572 2c0a  er=input_layer,.
+00002a50: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
+00002a60: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
+00002a70: 722c 0a20 2020 2020 2020 2063 6f6c 756d  r,.        colum
+00002a80: 6e73 3d63 6f6c 756d 6e73 2c0a 2020 2020  ns=columns,.    
+00002a90: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
+00002aa0: 6374 696f 6e73 3d65 7870 6c6f 6465 636f  ctions=explodeco
+00002ab0: 6c6c 6563 7469 6f6e 732c 0a20 2020 2020  llections,.     
+00002ac0: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
+00002ad0: 6765 6f6d 6574 7279 7479 7065 3d4e 6f6e  geometrytype=Non
+00002ae0: 652c 0a20 2020 2020 2020 2067 7269 6473  e,.        grids
+00002af0: 697a 653d 6772 6964 7369 7a65 2c0a 2020  ize=gridsize,.  
+00002b00: 2020 2020 2020 6b65 6570 5f65 6d70 7479        keep_empty
+00002b10: 5f67 656f 6d73 3d6b 6565 705f 656d 7074  _geoms=keep_empt
+00002b20: 795f 6765 6f6d 732c 0a20 2020 2020 2020  y_geoms,.       
+00002b30: 2077 6865 7265 3d77 6865 7265 2c0a 2020   where=where,.  
+00002b40: 2020 2020 2020 6e62 5f70 6172 616c 6c65        nb_paralle
+00002b50: 6c3d 6e62 5f70 6172 616c 6c65 6c2c 0a20  l=nb_parallel,. 
+00002b60: 2020 2020 2020 2062 6174 6368 7369 7a65         batchsize
+00002b70: 3d62 6174 6368 7369 7a65 2c0a 2020 2020  =batchsize,.    
+00002b80: 2020 2020 666f 7263 653d 666f 7263 652c      force=force,
+00002b90: 0a20 2020 2029 0a0a 0a64 6566 2073 696d  .    )...def sim
+00002ba0: 706c 6966 7928 0a20 2020 2069 6e70 7574  plify(.    input
+00002bb0: 5f70 6174 683a 2050 6174 682c 0a20 2020  _path: Path,.   
+00002bc0: 206f 7574 7075 745f 7061 7468 3a20 5061   output_path: Pa
+00002bd0: 7468 2c0a 2020 2020 746f 6c65 7261 6e63  th,.    toleranc
+00002be0: 653a 2066 6c6f 6174 2c0a 2020 2020 616c  e: float,.    al
+00002bf0: 676f 7269 7468 6d3a 2053 696d 706c 6966  gorithm: Simplif
+00002c00: 7941 6c67 6f72 6974 686d 203d 2053 696d  yAlgorithm = Sim
+00002c10: 706c 6966 7941 6c67 6f72 6974 686d 2e52  plifyAlgorithm.R
+00002c20: 414d 4552 5f44 4f55 474c 4153 5f50 4555  AMER_DOUGLAS_PEU
+00002c30: 434b 4552 2c0a 2020 2020 6c6f 6f6b 6168  CKER,.    lookah
+00002c40: 6561 643a 2069 6e74 203d 2038 2c0a 2020  ead: int = 8,.  
+00002c50: 2020 696e 7075 745f 6c61 7965 723a 204f    input_layer: O
+00002c60: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00002c70: 6f6e 652c 0a20 2020 206f 7574 7075 745f  one,.    output_
+00002c80: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
+00002c90: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00002ca0: 2063 6f6c 756d 6e73 3a20 4f70 7469 6f6e   columns: Option
+00002cb0: 616c 5b4c 6973 745b 7374 725d 5d20 3d20  al[List[str]] = 
+00002cc0: 4e6f 6e65 2c0a 2020 2020 6578 706c 6f64  None,.    explod
+00002cd0: 6563 6f6c 6c65 6374 696f 6e73 3a20 626f  ecollections: bo
+00002ce0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00002cf0: 6772 6964 7369 7a65 3a20 666c 6f61 7420  gridsize: float 
+00002d00: 3d20 302e 302c 0a20 2020 206b 6565 705f  = 0.0,.    keep_
+00002d10: 656d 7074 795f 6765 6f6d 733a 2062 6f6f  empty_geoms: boo
+00002d20: 6c20 3d20 5472 7565 2c0a 2020 2020 7768  l = True,.    wh
+00002d30: 6572 653a 204f 7074 696f 6e61 6c5b 7374  ere: Optional[st
+00002d40: 725d 203d 204e 6f6e 652c 0a20 2020 206e  r] = None,.    n
+00002d50: 625f 7061 7261 6c6c 656c 3a20 696e 7420  b_parallel: int 
+00002d60: 3d20 2d31 2c0a 2020 2020 6261 7463 6873  = -1,.    batchs
+00002d70: 697a 653a 2069 6e74 203d 202d 312c 0a20  ize: int = -1,. 
+00002d80: 2020 2066 6f72 6365 3a20 626f 6f6c 203d     force: bool =
+00002d90: 2046 616c 7365 2c0a 293a 0a20 2020 2023   False,.):.    #
+00002da0: 2049 6e69 740a 2020 2020 6f70 6572 6174   Init.    operat
+00002db0: 696f 6e5f 7061 7261 6d73 203d 207b 0a20  ion_params = {. 
+00002dc0: 2020 2020 2020 2022 746f 6c65 7261 6e63         "toleranc
+00002dd0: 6522 3a20 746f 6c65 7261 6e63 652c 0a20  e": tolerance,. 
+00002de0: 2020 2020 2020 2022 616c 676f 7269 7468         "algorith
+00002df0: 6d22 3a20 616c 676f 7269 7468 6d2c 0a20  m": algorithm,. 
+00002e00: 2020 2020 2020 2022 7374 6570 223a 206c         "step": l
+00002e10: 6f6f 6b61 6865 6164 2c0a 2020 2020 7d0a  ookahead,.    }.
+00002e20: 0a20 2020 2023 2047 6f21 0a20 2020 2072  .    # Go!.    r
+00002e30: 6574 7572 6e20 5f61 7070 6c79 5f67 656f  eturn _apply_geo
+00002e40: 6f70 6572 6174 696f 6e5f 746f 5f6c 6179  operation_to_lay
+00002e50: 6572 280a 2020 2020 2020 2020 696e 7075  er(.        inpu
+00002e60: 745f 7061 7468 3d69 6e70 7574 5f70 6174  t_path=input_pat
+00002e70: 682c 0a20 2020 2020 2020 206f 7574 7075  h,.        outpu
+00002e80: 745f 7061 7468 3d6f 7574 7075 745f 7061  t_path=output_pa
+00002e90: 7468 2c0a 2020 2020 2020 2020 6f70 6572  th,.        oper
+00002ea0: 6174 696f 6e3d 4765 6f4f 7065 7261 7469  ation=GeoOperati
+00002eb0: 6f6e 2e53 494d 504c 4946 592c 0a20 2020  on.SIMPLIFY,.   
+00002ec0: 2020 2020 206f 7065 7261 7469 6f6e 5f70       operation_p
+00002ed0: 6172 616d 733d 6f70 6572 6174 696f 6e5f  arams=operation_
+00002ee0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00002ef0: 696e 7075 745f 6c61 7965 723d 696e 7075  input_layer=inpu
+00002f00: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
+00002f10: 206f 7574 7075 745f 6c61 7965 723d 6f75   output_layer=ou
+00002f20: 7470 7574 5f6c 6179 6572 2c0a 2020 2020  tput_layer,.    
+00002f30: 2020 2020 636f 6c75 6d6e 733d 636f 6c75      columns=colu
+00002f40: 6d6e 732c 0a20 2020 2020 2020 2065 7870  mns,.        exp
+00002f50: 6c6f 6465 636f 6c6c 6563 7469 6f6e 733d  lodecollections=
+00002f60: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+00002f70: 6e73 2c0a 2020 2020 2020 2020 666f 7263  ns,.        forc
+00002f80: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00002f90: 7974 7970 653d 4e6f 6e65 2c0a 2020 2020  ytype=None,.    
+00002fa0: 2020 2020 6772 6964 7369 7a65 3d67 7269      gridsize=gri
+00002fb0: 6473 697a 652c 0a20 2020 2020 2020 206b  dsize,.        k
+00002fc0: 6565 705f 656d 7074 795f 6765 6f6d 733d  eep_empty_geoms=
+00002fd0: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
+00002fe0: 2c0a 2020 2020 2020 2020 7768 6572 653d  ,.        where=
+00002ff0: 7768 6572 652c 0a20 2020 2020 2020 206e  where,.        n
+00003000: 625f 7061 7261 6c6c 656c 3d6e 625f 7061  b_parallel=nb_pa
+00003010: 7261 6c6c 656c 2c0a 2020 2020 2020 2020  rallel,.        
+00003020: 6261 7463 6873 697a 653d 6261 7463 6873  batchsize=batchs
+00003030: 697a 652c 0a20 2020 2020 2020 2066 6f72  ize,.        for
+00003040: 6365 3d66 6f72 6365 2c0a 2020 2020 290a  ce=force,.    ).
+00003050: 0a0a 6465 6620 5f61 7070 6c79 5f67 656f  ..def _apply_geo
+00003060: 6f70 6572 6174 696f 6e5f 746f 5f6c 6179  operation_to_lay
+00003070: 6572 280a 2020 2020 696e 7075 745f 7061  er(.    input_pa
+00003080: 7468 3a20 5061 7468 2c0a 2020 2020 6f75  th: Path,.    ou
+00003090: 7470 7574 5f70 6174 683a 2050 6174 682c  tput_path: Path,
+000030a0: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
+000030b0: 4765 6f4f 7065 7261 7469 6f6e 2c0a 2020  GeoOperation,.  
+000030c0: 2020 6f70 6572 6174 696f 6e5f 7061 7261    operation_para
+000030d0: 6d73 3a20 6469 6374 2c0a 2020 2020 696e  ms: dict,.    in
+000030e0: 7075 745f 6c61 7965 723a 204f 7074 696f  put_layer: Optio
+000030f0: 6e61 6c5b 7374 725d 2c20 2023 203d 204e  nal[str],  # = N
+00003100: 6f6e 650a 2020 2020 636f 6c75 6d6e 733a  one.    columns:
+00003110: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
+00003120: 7472 5d5d 2c20 2023 203d 204e 6f6e 650a  tr]],  # = None.
+00003130: 2020 2020 6f75 7470 7574 5f6c 6179 6572      output_layer
+00003140: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
+00003150: 2020 2320 3d20 4e6f 6e65 0a20 2020 2065    # = None.    e
+00003160: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+00003170: 733a 2062 6f6f 6c2c 2020 2320 3d20 4661  s: bool,  # = Fa
+00003180: 6c73 650a 2020 2020 666f 7263 655f 6f75  lse.    force_ou
+00003190: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+000031a0: 653a 2055 6e69 6f6e 5b47 656f 6d65 7472  e: Union[Geometr
+000031b0: 7954 7970 652c 2073 7472 2c20 4e6f 6e65  yType, str, None
+000031c0: 5d2c 2020 2320 3d20 4e6f 6e65 0a20 2020  ],  # = None.   
+000031d0: 2067 7269 6473 697a 653a 2066 6c6f 6174   gridsize: float
+000031e0: 2c20 2023 203d 2030 2e30 0a20 2020 206b  ,  # = 0.0.    k
+000031f0: 6565 705f 656d 7074 795f 6765 6f6d 733a  eep_empty_geoms:
+00003200: 2062 6f6f 6c2c 2020 2320 3d20 5472 7565   bool,  # = True
+00003210: 0a20 2020 2077 6865 7265 3a20 4f70 7469  .    where: Opti
+00003220: 6f6e 616c 5b73 7472 5d2c 2020 2320 3d20  onal[str],  # = 
+00003230: 4e6f 6e65 0a20 2020 206e 625f 7061 7261  None.    nb_para
+00003240: 6c6c 656c 3a20 696e 742c 2020 2320 3d20  llel: int,  # = 
+00003250: 2d31 0a20 2020 2062 6174 6368 7369 7a65  -1.    batchsize
+00003260: 3a20 696e 742c 2020 2320 3d20 2d31 0a20  : int,  # = -1. 
+00003270: 2020 2066 6f72 6365 3a20 626f 6f6c 2c20     force: bool, 
+00003280: 2023 203d 2046 616c 7365 0a29 3a0a 2020   # = False.):.  
+00003290: 2020 2222 220a 2020 2020 4170 706c 6965    """.    Applie
+000032a0: 7320 6120 6765 6f20 6f70 6572 6174 696f  s a geo operatio
+000032b0: 6e20 6f6e 2061 206c 6179 6572 2e0a 0a20  n on a layer... 
+000032c0: 2020 2054 6865 206f 7065 7261 7469 6f6e     The operation
+000032d0: 2074 6f20 6170 706c 7920 6361 6e20 6265   to apply can be
+000032e0: 206f 6e65 206f 6620 7468 6520 7468 6520   one of the the 
+000032f0: 666f 6c6c 6f77 696e 673a 0a20 2020 2020  following:.     
+00003300: 202d 2042 5546 4645 523a 2061 7070 6c79   - BUFFER: apply
+00003310: 2061 2062 7566 6665 722e 204f 7065 7261   a buffer. Opera
+00003320: 7469 6f6e 2070 6172 616d 6574 6572 733a  tion parameters:
+00003330: 0a20 2020 2020 2020 2020 202d 2064 6973  .          - dis
+00003340: 7461 6e63 653a 2064 6973 7461 6e63 6520  tance: distance 
+00003350: 746f 2062 7566 6665 720a 2020 2020 2020  to buffer.      
+00003360: 2020 2020 2d20 7175 6164 7261 6e74 7365      - quadrantse
+00003370: 676d 656e 7473 3a20 6e75 6d62 6572 206f  gments: number o
+00003380: 6620 706f 696e 7473 2075 7365 6420 746f  f points used to
+00003390: 2072 6570 7265 7365 6e74 2031 2f34 206f   represent 1/4 o
+000033a0: 6620 6120 6369 7263 6c65 0a20 2020 2020  f a circle.     
+000033b0: 2020 2020 202d 2065 6e64 6361 705f 7374       - endcap_st
+000033c0: 796c 653a 2062 7566 6665 7220 7374 796c  yle: buffer styl
+000033d0: 6520 746f 2075 7365 2066 6f72 2061 2070  e to use for a p
+000033e0: 6f69 6e74 206f 7220 7468 6520 656e 6420  oint or the end 
+000033f0: 706f 696e 7473 206f 660a 2020 2020 2020  points of.      
+00003400: 2020 2020 2020 6120 6c69 6e65 3a0a 2020        a line:.  
+00003410: 2020 2020 2020 2020 2020 2d20 524f 554e            - ROUN
+00003420: 443a 2066 6f72 2070 6f69 6e74 7320 616e  D: for points an
+00003430: 6420 6c69 6e65 7320 7468 6520 656e 6473  d lines the ends
+00003440: 2061 7265 2062 7566 6665 7265 6420 726f   are buffered ro
+00003450: 756e 6465 642e 0a20 2020 2020 2020 2020  unded..         
+00003460: 2020 202d 2046 4c41 543a 2061 2070 6f69     - FLAT: a poi
+00003470: 6e74 2073 7461 7973 2061 2070 6f69 6e74  nt stays a point
+00003480: 2c20 6120 6275 6666 6572 6564 206c 696e  , a buffered lin
+00003490: 6520 7769 6c6c 2065 6e64 2066 6c61 740a  e will end flat.
+000034a0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+000034b0: 2074 6865 2065 6e64 2070 6f69 6e74 730a   the end points.
+000034c0: 2020 2020 2020 2020 2020 2020 2d20 5351              - SQ
+000034d0: 5541 5245 3a20 6120 706f 696e 7420 6265  UARE: a point be
+000034e0: 636f 6d65 7320 6120 7371 7561 7265 2c20  comes a square, 
+000034f0: 6120 6275 6666 6572 6564 206c 696e 6520  a buffered line 
+00003500: 7769 6c6c 2065 6e64 0a20 2020 2020 2020  will end.       
+00003510: 2020 2020 2020 2066 6c61 7420 6174 2074         flat at t
+00003520: 6865 2065 6e64 2070 6f69 6e74 732c 2062  he end points, b
+00003530: 7574 2065 6c6f 6e67 6174 6564 2062 7920  ut elongated by 
+00003540: 2264 6973 7461 6e63 6522 0a20 2020 2020  "distance".     
+00003550: 2020 202d 206a 6f69 6e5f 7374 796c 653a     - join_style:
+00003560: 2062 7566 6665 7220 7374 796c 6520 746f   buffer style to
+00003570: 2075 7365 2066 6f72 2063 6f72 6e65 7273   use for corners
+00003580: 2069 6e20 6120 6c69 6e65 206f 7220 6120   in a line or a 
+00003590: 706f 6c79 676f 6e0a 2020 2020 2020 2020  polygon.        
+000035a0: 2020 626f 756e 6461 7279 3a0a 2020 2020    boundary:.    
+000035b0: 2020 2020 2020 2020 2d20 524f 554e 443a          - ROUND:
+000035c0: 2063 6f72 6e65 7273 2069 6e20 7468 6520   corners in the 
+000035d0: 7265 7375 6c74 2061 7265 2072 6f75 6e64  result are round
+000035e0: 6564 0a20 2020 2020 2020 2020 2020 202d  ed.            -
+000035f0: 204d 4954 5245 3a20 636f 726e 6572 7320   MITRE: corners 
+00003600: 696e 2074 6865 2072 6573 756c 7420 6172  in the result ar
+00003610: 6520 7368 6172 700a 2020 2020 2020 2020  e sharp.        
+00003620: 2020 2020 2d20 4245 5645 4c3a 2061 7265      - BEVEL: are
+00003630: 2066 6c61 7474 656e 6564 0a20 2020 2020   flattened.     
+00003640: 2020 202d 206d 6974 7265 5f6c 696d 6974     - mitre_limit
+00003650: 3a20 696e 2063 6173 6520 6f66 206a 6f69  : in case of joi
+00003660: 6e5f 7374 796c 6520 4d49 5452 452c 2069  n_style MITRE, i
+00003670: 6620 7468 650a 2020 2020 2020 2020 2020  f the.          
+00003680: 2020 7370 696b 7920 7265 7375 6c74 2066    spiky result f
+00003690: 6f72 2061 2073 6861 7270 2061 6e67 6c65  or a sharp angle
+000036a0: 2062 6563 6f6d 6573 206c 6f6e 6765 7220   becomes longer 
+000036b0: 7468 616e 2074 6869 7320 6c69 6d69 742c  than this limit,
+000036c0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+000036d0: 6973 2022 6265 7665 6c65 6422 2061 7420  is "beveled" at 
+000036e0: 7468 6973 2064 6973 7461 6e63 652e 2044  this distance. D
+000036f0: 6566 6175 6c74 7320 746f 2035 2e30 2e0a  efaults to 5.0..
+00003700: 2020 2020 2020 2020 2d20 7369 6e67 6c65          - single
+00003710: 5f73 6964 6564 3a20 6f6e 6c79 206f 6e65  _sided: only one
+00003720: 2073 6964 6520 6f66 2074 6865 206c 696e   side of the lin
+00003730: 6520 6973 2062 7566 6665 7265 642c 0a20  e is buffered,. 
+00003740: 2020 2020 2020 2020 2020 2069 6620 6469             if di
+00003750: 7374 616e 6365 2069 7320 6e65 6761 7469  stance is negati
+00003760: 7665 2c20 7468 6520 6c65 6674 2073 6964  ve, the left sid
+00003770: 652c 2069 6620 6469 7374 616e 6365 2069  e, if distance i
+00003780: 7320 706f 7369 7469 7665 2c0a 2020 2020  s positive,.    
+00003790: 2020 2020 2020 2020 7468 6520 7269 6768          the righ
+000037a0: 7420 6861 6e64 2073 6964 652e 204f 6e6c  t hand side. Onl
+000037b0: 7920 7265 6c65 7661 6e74 2066 6f72 206c  y relevant for l
+000037c0: 696e 6520 6765 6f6d 6574 7269 6573 2e0a  ine geometries..
+000037d0: 2020 2020 2020 2d20 434f 4e56 4558 4855        - CONVEXHU
+000037e0: 4c4c 3a20 6170 7079 2061 2063 6f6e 7665  LL: appy a conve
+000037f0: 7820 6875 6c6c 2e0a 2020 2020 2020 2d20  x hull..      - 
+00003800: 5349 4d50 4c49 4659 3a20 7369 6d70 6c69  SIMPLIFY: simpli
+00003810: 6679 2074 6865 2067 656f 6d65 7472 792e  fy the geometry.
+00003820: 204f 7065 7261 7469 6f6e 2070 6172 616d   Operation param
+00003830: 6574 6572 733a 0a20 2020 2020 2020 2020  eters:.         
+00003840: 202d 2061 6c67 6f72 6974 686d 3a20 7665   - algorithm: ve
+00003850: 6374 6f72 5f75 7469 6c2e 5369 6d70 6c69  ctor_util.Simpli
+00003860: 6679 416c 676f 7269 7468 6d0a 2020 2020  fyAlgorithm.    
+00003870: 2020 2020 2020 2d20 746f 6c65 7261 6e63        - toleranc
+00003880: 653a 206d 6178 696d 756d 2064 6973 7461  e: maximum dista
+00003890: 6e63 6520 746f 2073 696d 706c 6966 792e  nce to simplify.
+000038a0: 0a20 2020 2020 2020 2020 202d 206c 6f6f  .          - loo
+000038b0: 6b61 6865 6164 3a20 666f 7220 4c41 4e47  kahead: for LANG
+000038c0: 2c20 7468 6520 6e75 6d62 6572 206f 6620  , the number of 
+000038d0: 706f 696e 7473 2074 6f20 666f 7277 6172  points to forwar
+000038e0: 642d 6c6f 6f6b 0a20 2020 2020 202d 2041  d-look.      - A
+000038f0: 5050 4c59 3a20 6170 706c 7920 6120 6c61  PPLY: apply a la
+00003900: 6d62 6461 2066 756e 6374 696f 6e2e 204f  mbda function. O
+00003910: 7065 7261 7469 6f6e 2070 6172 616d 6574  peration paramet
+00003920: 6572 3a0a 2020 2020 2020 2020 2020 2d20  er:.          - 
+00003930: 7069 636b 6c65 645f 6675 6e63 3a20 6c61  pickled_func: la
+00003940: 6d62 6461 2066 756e 6374 696f 6e20 746f  mbda function to
+00003950: 2061 7070 6c79 2c20 7069 636b 6c65 6420   apply, pickled 
+00003960: 746f 2062 7974 6573 2e0a 2020 2020 2020  to bytes..      
+00003970: 2020 2020 2d20 6f6e 6c79 5f67 656f 6d5f      - only_geom_
+00003980: 696e 7075 743a 2069 6620 5472 7565 2c20  input: if True, 
+00003990: 6f6e 6c79 2074 6865 2067 656f 6d65 7472  only the geometr
+000039a0: 7920 6973 2061 7661 696c 6162 6c65 2061  y is available a
+000039b0: 730a 2020 2020 2020 2020 2020 2020 696e  s.            in
+000039c0: 7075 7420 666f 7220 7468 6520 6c61 6d62  put for the lamb
+000039d0: 6461 2066 756e 6374 696f 6e2e 2049 6620  da function. If 
+000039e0: 6661 6c73 652c 2074 6865 2072 6f77 2069  false, the row i
+000039f0: 7320 7468 6520 696e 7075 742e 0a0a 2020  s the input...  
+00003a00: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00003a10: 696e 7075 745f 7061 7468 2028 5061 7468  input_path (Path
+00003a20: 293a 205b 6465 7363 7269 7074 696f 6e5d  ): [description]
+00003a30: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00003a40: 7061 7468 2028 5061 7468 293a 205b 6465  path (Path): [de
+00003a50: 7363 7269 7074 696f 6e5d 0a20 2020 2020  scription].     
+00003a60: 2020 206f 7065 7261 7469 6f6e 2028 4765     operation (Ge
+00003a70: 6f4f 7065 7261 7469 6f6e 293a 2074 6865  oOperation): the
+00003a80: 2067 656f 206f 7065 7261 7469 6f6e 2074   geo operation t
+00003a90: 6f20 6170 706c 792e 0a20 2020 2020 2020  o apply..       
+00003aa0: 206f 7065 7261 7469 6f6e 5f70 6172 616d   operation_param
+00003ab0: 7320 2864 6963 742c 206f 7074 696f 6e61  s (dict, optiona
+00003ac0: 6c29 3a20 7468 6520 7061 7261 6d65 7465  l): the paramete
+00003ad0: 7273 2066 6f72 2074 6865 2067 656f 206f  rs for the geo o
+00003ae0: 7065 7261 7469 6f6e 2e0a 2020 2020 2020  peration..      
+00003af0: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
+00003b00: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
+00003b10: 696e 7075 745f 6c61 7965 7220 2873 7472  input_layer (str
+00003b20: 2c20 6f70 7469 6f6e 616c 293a 205b 6465  , optional): [de
+00003b30: 7363 7269 7074 696f 6e5d 2e20 4465 6661  scription]. Defa
+00003b40: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+00003b50: 2020 2020 2020 6f75 7470 7574 5f6c 6179        output_lay
+00003b60: 6572 2028 7374 722c 206f 7074 696f 6e61  er (str, optiona
+00003b70: 6c29 3a20 5b64 6573 6372 6970 7469 6f6e  l): [description
+00003b80: 5d2e 2044 6566 6175 6c74 7320 746f 204e  ]. Defaults to N
+00003b90: 6f6e 652e 0a20 2020 2020 2020 2063 6f6c  one..        col
+00003ba0: 756d 6e73 2028 4c69 7374 5b73 7472 5d2c  umns (List[str],
+00003bb0: 206f 7074 696f 6e61 6c29 3a20 4966 206e   optional): If n
+00003bc0: 6f74 204e 6f6e 652c 206f 6e6c 7920 6f75  ot None, only ou
+00003bd0: 7470 7574 2074 6865 2063 6f6c 756d 6e73  tput the columns
+00003be0: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
+00003bf0: 6369 6669 6564 2e20 4465 6661 756c 7473  cified. Defaults
+00003c00: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
+00003c10: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
+00003c20: 696f 6e73 2028 626f 6f6c 2c20 6f70 7469  ions (bool, opti
+00003c30: 6f6e 616c 293a 2054 7275 6520 746f 2063  onal): True to c
+00003c40: 6f6e 7665 7274 2061 6c6c 206d 756c 7469  onvert all multi
+00003c50: 2d67 656f 6d65 7472 6965 7320 746f 0a20  -geometries to. 
+00003c60: 2020 2020 2020 2020 2020 2073 696e 6775             singu
+00003c70: 6c61 7220 6f6e 6573 2064 7572 696e 6720  lar ones during 
+00003c80: 7468 6520 6765 6f6f 7065 7261 7469 6f6e  the geooperation
+00003c90: 2e20 4465 6661 756c 7473 2074 6f20 4661  . Defaults to Fa
+00003ca0: 6c73 652e 0a20 2020 2020 2020 2066 6f72  lse..        for
+00003cb0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+00003cc0: 7279 7479 7065 2028 4765 6f6d 6574 7279  rytype (Geometry
+00003cd0: 5479 7065 2c20 6f70 7469 6f6e 616c 293a  Type, optional):
+00003ce0: 2054 6865 206f 7574 7075 7420 6765 6f6d   The output geom
+00003cf0: 6574 7279 2074 7970 6520 746f 0a20 2020  etry type to.   
+00003d00: 2020 2020 2020 2020 2066 6f72 6365 2e20           force. 
+00003d10: 4966 204e 6f6e 652c 2061 2062 6573 742d  If None, a best-
+00003d20: 6566 666f 7274 2067 7565 7373 2069 7320  effort guess is 
+00003d30: 6d61 6465 2e20 4465 6661 756c 7473 2074  made. Defaults t
+00003d40: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
+00003d50: 6772 6964 7369 7a65 2028 666c 6f61 742c  gridsize (float,
+00003d60: 206f 7074 696f 6e61 6c29 3a20 7468 6520   optional): the 
+00003d70: 7369 7a65 206f 6620 7468 6520 6772 6964  size of the grid
+00003d80: 2074 6865 2063 6f6f 7264 696e 6174 6573   the coordinates
+00003d90: 206f 6620 7468 6520 6f75 7075 740a 2020   of the ouput.  
+00003da0: 2020 2020 2020 2020 2020 7769 6c6c 2062            will b
+00003db0: 6520 726f 756e 6465 6420 746f 2e20 4567  e rounded to. Eg
+00003dc0: 2e20 302e 3030 3120 746f 206b 6565 7020  . 0.001 to keep 
+00003dd0: 3320 6465 6369 6d61 6c73 2e20 5661 6c75  3 decimals. Valu
+00003de0: 6520 302e 3020 646f 6573 6e27 7420 6368  e 0.0 doesn't ch
+00003df0: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
+00003e00: 2074 6865 2070 7265 6369 7369 6f6e 2e20   the precision. 
+00003e10: 4465 6661 756c 7473 2074 6f20 302e 302e  Defaults to 0.0.
+00003e20: 0a20 2020 2020 2020 206b 6565 705f 656d  .        keep_em
+00003e30: 7074 795f 6765 6f6d 7320 2862 6f6f 6c2c  pty_geoms (bool,
+00003e40: 206f 7074 696f 6e61 6c29 3a20 5472 7565   optional): True
+00003e50: 2074 6f20 6b65 6570 2072 6f77 7320 7769   to keep rows wi
+00003e60: 7468 2065 6d70 7479 2f6e 756c 6c20 6765  th empty/null ge
+00003e70: 6f6d 6574 7269 6573 0a20 2020 2020 2020  ometries.       
+00003e80: 2020 2020 2069 6e20 7468 6520 6f75 7470       in the outp
+00003e90: 7574 2e20 4465 6661 756c 7473 2074 6f20  ut. Defaults to 
+00003ea0: 5472 7565 2e0a 2020 2020 2020 2020 7768  True..        wh
+00003eb0: 6572 6520 2873 7472 2c20 6f70 7469 6f6e  ere (str, option
+00003ec0: 616c 293a 2066 696c 7465 7220 746f 2061  al): filter to a
+00003ed0: 7070 6c79 2074 6f20 7468 6520 7265 7375  pply to the resu
+00003ee0: 6c74 206f 6620 7468 6520 6f70 6572 6174  lt of the operat
+00003ef0: 696f 6e20 2861 6674 6572 0a20 2020 2020  ion (after.     
+00003f00: 2020 2020 2020 2065 7870 6c6f 6465 636f         explodeco
+00003f10: 6c6c 6563 7469 6f6e 7329 2e20 4974 2073  llections). It s
+00003f20: 686f 756c 6420 6265 2069 6e20 7371 6c69  hould be in sqli
+00003f30: 7465 2053 514c 2057 4845 5245 2073 796e  te SQL WHERE syn
+00003f40: 7461 7820 616e 640a 2020 2020 2020 2020  tax and.        
+00003f50: 2020 2020 7c73 7061 7469 616c 6974 655f      |spatialite_
+00003f60: 7265 6665 7265 6e63 655f 6c69 6e6b 7c20  reference_link| 
+00003f70: 6675 6e63 7469 6f6e 7320 6361 6e20 6265  functions can be
+00003f80: 2075 7365 642e 2044 6566 6175 6c74 7320   used. Defaults 
+00003f90: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
+00003fa0: 206e 625f 7061 7261 6c6c 656c 2028 696e   nb_parallel (in
+00003fb0: 742c 206f 7074 696f 6e61 6c29 3a20 5b64  t, optional): [d
+00003fc0: 6573 6372 6970 7469 6f6e 5d2e 2044 6566  escription]. Def
+00003fd0: 6175 6c74 7320 746f 202d 312e 0a20 2020  aults to -1..   
+00003fe0: 2020 2020 2062 6174 6368 7369 7a65 2028       batchsize (
+00003ff0: 696e 742c 206f 7074 696f 6e61 6c29 3a20  int, optional): 
+00004000: 696e 6469 6361 7469 7665 206e 756d 6265  indicative numbe
+00004010: 7220 6f66 2072 6f77 7320 746f 2070 726f  r of rows to pro
+00004020: 6365 7373 2070 6572 0a20 2020 2020 2020  cess per.       
+00004030: 2020 2020 2062 6174 6368 2e20 4120 736d       batch. A sm
+00004040: 616c 6c65 7220 6261 7463 6820 7369 7a65  aller batch size
+00004050: 2c20 706f 7373 6962 6c79 2069 6e20 636f  , possibly in co
+00004060: 6d62 696e 6174 696f 6e20 7769 7468 2061  mbination with a
+00004070: 0a20 2020 2020 2020 2020 2020 2073 6d61  .            sma
+00004080: 6c6c 6572 206e 625f 7061 7261 6c6c 656c  ller nb_parallel
+00004090: 2c20 7769 6c6c 2072 6564 7563 6520 7468  , will reduce th
+000040a0: 6520 6d65 6d6f 7279 2075 7361 6765 2e0a  e memory usage..
+000040b0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+000040c0: 756c 7473 2074 6f20 2d31 3a20 2874 7279  ults to -1: (try
+000040d0: 2074 6f29 2064 6574 6572 6d69 6e65 206f   to) determine o
+000040e0: 7074 696d 616c 2073 697a 6520 6175 746f  ptimal size auto
+000040f0: 6d61 7469 6361 6c6c 792e 0a20 2020 2020  matically..     
+00004100: 2020 2066 6f72 6365 2028 626f 6f6c 2c20     force (bool, 
+00004110: 6f70 7469 6f6e 616c 293a 205b 6465 7363  optional): [desc
+00004120: 7269 7074 696f 6e5d 2e20 4465 6661 756c  ription]. Defaul
+00004130: 7473 2074 6f20 4661 6c73 652e 0a0a 2020  ts to False...  
+00004140: 2020 5465 6368 6e69 6361 6c20 7265 6d61    Technical rema
+00004150: 726b 733a 0a20 2020 2020 2020 202d 2052  rks:.        - R
+00004160: 6574 6169 6e69 6e67 204e 6f6e 6520 6765  etaining None ge
+00004170: 6f6d 6574 7279 2076 616c 7565 7320 696e  ometry values in
+00004180: 2074 6865 206f 7574 7075 7420 6669 6c65   the output file
+00004190: 7320 6973 2068 6172 642c 2062 6563 6175  s is hard, becau
+000041a0: 7365 2077 6865 6e0a 2020 2020 2020 2020  se when.        
+000041b0: 2020 6361 6c63 756c 6174 696e 6720 7061    calculating pa
+000041c0: 7274 6961 6c20 6669 6c65 732c 2061 2070  rtial files, a p
+000041d0: 6172 7469 616c 2066 696c 6520 6361 6e20  artial file can 
+000041e0: 6861 7665 206f 6e6c 7920 4e6f 6e65 2067  have only None g
+000041f0: 656f 6d65 7472 6965 7320 7768 6963 680a  eometries which.
+00004200: 2020 2020 2020 2020 2020 6d61 6b65 7320            makes 
+00004210: 6974 2069 6d70 6f73 7369 626c 6520 746f  it impossible to
+00004220: 206b 6e6f 7720 7468 6520 6765 6f6d 6574   know the geomet
+00004230: 7279 2074 7970 652e 204f 6e63 6520 616e  ry type. Once an
+00004240: 206f 7574 7075 7420 6669 6c65 2069 7320   output file is 
+00004250: 6372 6561 7465 642c 0a20 2020 2020 2020  created,.       
+00004260: 2020 2069 7420 6973 2061 6c73 6f20 696d     it is also im
+00004270: 706f 7373 6962 6c65 2074 6f20 6368 616e  possible to chan
+00004280: 6765 2074 6865 2074 7970 6520 6166 7465  ge the type afte
+00004290: 7277 6172 6473 2028 7769 7468 6f75 7420  rwards (without 
+000042a0: 6d61 6b69 6e67 2061 2063 6f70 7929 2e0a  making a copy)..
+000042b0: 2020 2020 2020 2020 2020 4966 2066 6f72            If for
+000042c0: 6365 5f6f 7574 7075 745f 7479 7065 2069  ce_output_type i
+000042d0: 7320 7370 6563 6966 6965 642c 2074 6865  s specified, the
+000042e0: 2070 726f 626c 656d 2069 7320 676f 6e65   problem is gone
+000042f0: 2e0a 0a20 2020 202e 2e20 7c73 7061 7469  ...    .. |spati
+00004300: 616c 6974 655f 7265 6665 7265 6e63 655f  alite_reference_
+00004310: 6c69 6e6b 7c20 7261 773a 3a20 6874 6d6c  link| raw:: html
+00004320: 0a0a 2020 2020 2020 2020 3c61 2068 7265  ..        <a hre
+00004330: 663d 2268 7474 7073 3a2f 2f77 7777 2e67  f="https://www.g
+00004340: 6169 612d 6769 732e 6974 2f67 6169 612d  aia-gis.it/gaia-
+00004350: 7369 6e73 2f73 7061 7469 616c 6974 652d  sins/spatialite-
+00004360: 7371 6c2d 6c61 7465 7374 2e68 746d 6c22  sql-latest.html"
+00004370: 2074 6172 6765 743d 225f 626c 616e 6b22   target="_blank"
+00004380: 3e73 7061 7469 616c 6974 6520 7265 6665  >spatialite refe
+00004390: 7265 6e63 653c 2f61 3e0a 0a20 2020 2022  rence</a>..    "
+000043a0: 2222 2020 2320 6e6f 7161 3a20 4535 3031  ""  # noqa: E501
+000043b0: 0a20 2020 2023 2049 6e69 740a 2020 2020  .    # Init.    
+000043c0: 7374 6172 745f 7469 6d65 5f67 6c6f 6261  start_time_globa
+000043d0: 6c20 3d20 6461 7465 7469 6d65 2e6e 6f77  l = datetime.now
+000043e0: 2829 0a0a 2020 2020 2320 4368 6563 6b20  ()..    # Check 
+000043f0: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
+00004400: 2e2e 2e0a 2020 2020 6f70 6572 6174 696f  ....    operatio
+00004410: 6e5f 6e61 6d65 203d 206f 7065 7261 7469  n_name = operati
+00004420: 6f6e 2e6e 616d 652e 6c6f 7765 7228 290a  on.name.lower().
+00004430: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
+00004440: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
+00004450: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00004460: 6c75 6545 7272 6f72 2866 227b 6f70 6572  lueError(f"{oper
+00004470: 6174 696f 6e5f 6e61 6d65 7d3a 2069 6e70  ation_name}: inp
+00004480: 7574 5f70 6174 6820 646f 6573 6e27 7420  ut_path doesn't 
+00004490: 6578 6973 743a 207b 696e 7075 745f 7061  exist: {input_pa
+000044a0: 7468 7d22 290a 2020 2020 6966 2069 6e70  th}").    if inp
+000044b0: 7574 5f70 6174 6820 3d3d 206f 7574 7075  ut_path == outpu
+000044c0: 745f 7061 7468 3a0a 2020 2020 2020 2020  t_path:.        
+000044d0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000044e0: 2866 227b 6f70 6572 6174 696f 6e5f 6e61  (f"{operation_na
+000044f0: 6d65 7d3a 206f 7574 7075 745f 7061 7468  me}: output_path
+00004500: 206d 7573 7420 6e6f 7420 6571 7561 6c20   must not equal 
+00004510: 696e 7075 745f 7061 7468 2229 0a20 2020  input_path").   
+00004520: 2069 6620 696e 7075 745f 6c61 7965 7220   if input_layer 
+00004530: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00004540: 2069 6e70 7574 5f6c 6179 6572 203d 2067   input_layer = g
+00004550: 666f 2e67 6574 5f6f 6e6c 795f 6c61 7965  fo.get_only_laye
+00004560: 7228 696e 7075 745f 7061 7468 290a 2020  r(input_path).  
+00004570: 2020 6966 206f 7574 7075 745f 7061 7468    if output_path
+00004580: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
+00004590: 2020 2069 6620 666f 7263 6520 6973 2046     if force is F
+000045a0: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
+000045b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+000045c0: 5374 6f70 207b 6f70 6572 6174 696f 6e5f  Stop {operation_
+000045d0: 6e61 6d65 7d3a 206f 7574 7075 7420 6578  name}: output ex
+000045e0: 6973 7473 2061 6c72 6561 6479 207b 6f75  ists already {ou
+000045f0: 7470 7574 5f70 6174 687d 2229 0a20 2020  tput_path}").   
+00004600: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00004610: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00004620: 2020 2020 2020 2020 2020 6766 6f2e 7265            gfo.re
+00004630: 6d6f 7665 286f 7574 7075 745f 7061 7468  move(output_path
+00004640: 290a 2020 2020 6966 2069 6e70 7574 5f6c  ).    if input_l
+00004650: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
+00004660: 2020 2020 2020 696e 7075 745f 6c61 7965        input_laye
+00004670: 7220 3d20 6766 6f2e 6765 745f 6f6e 6c79  r = gfo.get_only
+00004680: 5f6c 6179 6572 2869 6e70 7574 5f70 6174  _layer(input_pat
+00004690: 6829 0a20 2020 2069 6620 6f75 7470 7574  h).    if output
+000046a0: 5f6c 6179 6572 2069 7320 4e6f 6e65 3a0a  _layer is None:.
+000046b0: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
+000046c0: 6179 6572 203d 2067 666f 2e67 6574 5f64  ayer = gfo.get_d
+000046d0: 6566 6175 6c74 5f6c 6179 6572 286f 7574  efault_layer(out
+000046e0: 7075 745f 7061 7468 290a 2020 2020 6966  put_path).    if
+000046f0: 2069 7369 6e73 7461 6e63 6528 666f 7263   isinstance(forc
+00004700: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00004710: 7974 7970 652c 2047 656f 6d65 7472 7954  ytype, GeometryT
+00004720: 7970 6529 3a0a 2020 2020 2020 2020 666f  ype):.        fo
+00004730: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00004740: 7472 7974 7970 6520 3d20 666f 7263 655f  trytype = force_
+00004750: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00004760: 7970 652e 6e61 6d65 0a0a 2020 2020 2320  ype.name..    # 
+00004770: 5072 6570 6172 6520 7768 6572 655f 746f  Prepare where_to
+00004780: 5f61 7070 6c79 2061 6e64 2066 696c 7465  _apply and filte
+00004790: 725f 6e75 6c6c 5f67 656f 6d73 0a20 2020  r_null_geoms.   
+000047a0: 2069 6e70 7574 5f6c 6179 6572 696e 666f   input_layerinfo
+000047b0: 203d 2067 666f 2e67 6574 5f6c 6179 6572   = gfo.get_layer
+000047c0: 696e 666f 2869 6e70 7574 5f70 6174 682c  info(input_path,
+000047d0: 2069 6e70 7574 5f6c 6179 6572 290a 2020   input_layer).  
+000047e0: 2020 6966 2077 6865 7265 2069 7320 6e6f    if where is no
+000047f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00004800: 6966 2077 6865 7265 203d 3d20 2222 3a0a  if where == "":.
+00004810: 2020 2020 2020 2020 2020 2020 7768 6572              wher
+00004820: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+00004830: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00004840: 2020 2023 2041 6c77 6179 7320 7365 7420     # Always set 
+00004850: 6765 6f6d 6574 7279 636f 6c75 6d6e 2074  geometrycolumn t
+00004860: 6f20 2267 656f 6d22 2c20 6265 6361 7573  o "geom", becaus
+00004870: 6520 7768 6572 6520 7061 7261 6d65 7465  e where paramete
+00004880: 7220 666f 7220 7368 700a 2020 2020 2020  r for shp.      
+00004890: 2020 2020 2020 2320 646f 6573 6e27 7420        # doesn't 
+000048a0: 7365 656d 2074 6f20 776f 726b 2e2e 2e20  seem to work... 
+000048b0: 736f 2063 7265 6174 6520 7465 6d70 2070  so create temp p
+000048c0: 6172 7469 616c 2066 696c 6573 2061 6c77  artial files alw
+000048d0: 6179 7320 6173 2067 706b 672e 0a20 2020  ays as gpkg..   
+000048e0: 2020 2020 2020 2020 2077 6865 7265 203d           where =
+000048f0: 2077 6865 7265 2e66 6f72 6d61 7428 6765   where.format(ge
+00004900: 6f6d 6574 7279 636f 6c75 6d6e 3d22 6765  ometrycolumn="ge
+00004910: 6f6d 2229 0a0a 2020 2020 2320 5072 6570  om")..    # Prep
+00004920: 6172 6520 746d 7020 6669 6c65 730a 2020  are tmp files.  
+00004930: 2020 7465 6d70 6469 7220 3d20 5f69 6f5f    tempdir = _io_
+00004940: 7574 696c 2e63 7265 6174 655f 7465 6d70  util.create_temp
+00004950: 6469 7228 6622 6765 6f66 696c 656f 7073  dir(f"geofileops
+00004960: 2f7b 6f70 6572 6174 696f 6e2e 7661 6c75  /{operation.valu
+00004970: 657d 2229 0a20 2020 206c 6f67 6765 722e  e}").    logger.
+00004980: 696e 666f 2866 2253 7461 7274 2063 616c  info(f"Start cal
+00004990: 6375 6c61 7469 6f6e 2074 6f20 7465 6d70  culation to temp
+000049a0: 2066 696c 6573 2069 6e20 7b74 656d 7064   files in {tempd
+000049b0: 6972 7d22 290a 0a20 2020 2023 2043 616c  ir}")..    # Cal
+000049c0: 6375 6c61 7465 0a20 2020 2074 7279 3a0a  culate.    try:.
+000049d0: 2020 2020 2020 2020 2320 5265 6d61 726b          # Remark
+000049e0: 3a20 6361 6c63 756c 6174 696e 6720 6361  : calculating ca
+000049f0: 6e20 6265 2064 6f6e 6520 696e 2070 6172  n be done in par
+00004a00: 616c 6c65 6c2c 2062 7574 206f 6e6c 7920  allel, but only 
+00004a10: 6f6e 6520 7072 6f63 6573 730a 2020 2020  one process.    
+00004a20: 2020 2020 2320 6361 6e20 7772 6974 6520      # can write 
+00004a30: 746f 2074 6865 2073 616d 6520 6f75 7470  to the same outp
+00004a40: 7574 2066 696c 6520 6174 2074 6865 2074  ut file at the t
+00004a50: 696d 652e 2e2e 0a0a 2020 2020 2020 2020  ime.....        
+00004a60: 2320 4361 6c63 756c 6174 6520 7468 6520  # Calculate the 
+00004a70: 6265 7374 206e 756d 6265 7220 6f66 2070  best number of p
+00004a80: 6172 616c 6c65 6c20 7072 6f63 6573 7365  arallel processe
+00004a90: 7320 616e 6420 6261 7463 6865 7320 666f  s and batches fo
+00004aa0: 720a 2020 2020 2020 2020 2320 7468 6520  r.        # the 
+00004ab0: 6176 6169 6c61 626c 6520 7265 736f 7572  available resour
+00004ac0: 6365 730a 2020 2020 2020 2020 6e62 5f72  ces.        nb_r
+00004ad0: 6f77 735f 746f 7461 6c20 3d20 696e 7075  ows_total = inpu
+00004ae0: 745f 6c61 7965 7269 6e66 6f2e 6665 6174  t_layerinfo.feat
+00004af0: 7572 6563 6f75 6e74 0a20 2020 2020 2020  urecount.       
+00004b00: 2069 6620 6261 7463 6873 697a 6520 3e20   if batchsize > 
+00004b10: 303a 0a20 2020 2020 2020 2020 2020 2070  0:.            p
+00004b20: 6172 616c 6c65 6c6c 697a 6174 696f 6e5f  arallellization_
+00004b30: 636f 6e66 6967 203d 2050 6172 616c 6c65  config = Paralle
+00004b40: 6c69 7a61 7469 6f6e 436f 6e66 6967 280a  lizationConfig(.
+00004b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b60: 6d69 6e5f 6176 675f 726f 7773 5f70 6572  min_avg_rows_per
+00004b70: 5f62 6174 6368 3d6d 6174 682e 6365 696c  _batch=math.ceil
+00004b80: 2862 6174 6368 7369 7a65 202f 2032 292c  (batchsize / 2),
+00004b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004ba0: 206d 6178 5f61 7667 5f72 6f77 735f 7065   max_avg_rows_pe
+00004bb0: 725f 6261 7463 683d 6261 7463 6873 697a  r_batch=batchsiz
+00004bc0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00004bd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00004be0: 2020 2020 2020 2020 2020 2070 6172 616c             paral
+00004bf0: 6c65 6c6c 697a 6174 696f 6e5f 636f 6e66  lellization_conf
+00004c00: 6967 203d 2050 6172 616c 6c65 6c69 7a61  ig = Paralleliza
+00004c10: 7469 6f6e 436f 6e66 6967 280a 2020 2020  tionConfig(.    
+00004c20: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00004c30: 6176 675f 726f 7773 5f70 6572 5f62 6174  avg_rows_per_bat
+00004c40: 6368 3d35 3030 3030 0a20 2020 2020 2020  ch=50000.       
+00004c50: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
+00004c60: 625f 7061 7261 6c6c 656c 2c20 6e62 5f62  b_parallel, nb_b
+00004c70: 6174 6368 6573 2c20 7265 616c 5f62 6174  atches, real_bat
+00004c80: 6368 7369 7a65 203d 2067 6574 5f70 6172  chsize = get_par
+00004c90: 616c 6c65 6c69 7a61 7469 6f6e 5f70 6172  allelization_par
+00004ca0: 616d 7328 0a20 2020 2020 2020 2020 2020  ams(.           
+00004cb0: 206e 625f 726f 7773 5f74 6f74 616c 3d6e   nb_rows_total=n
+00004cc0: 625f 726f 7773 5f74 6f74 616c 2c0a 2020  b_rows_total,.  
+00004cd0: 2020 2020 2020 2020 2020 6e62 5f70 6172            nb_par
+00004ce0: 616c 6c65 6c3d 6e62 5f70 6172 616c 6c65  allel=nb_paralle
+00004cf0: 6c2c 0a20 2020 2020 2020 2020 2020 2070  l,.            p
+00004d00: 6172 616c 6c65 6c69 7a61 7469 6f6e 5f63  arallelization_c
+00004d10: 6f6e 6669 673d 7061 7261 6c6c 656c 6c69  onfig=parallelli
+00004d20: 7a61 7469 6f6e 5f63 6f6e 6669 672c 0a20  zation_config,. 
+00004d30: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00004d40: 2020 2320 544f 444f 3a20 6465 7465 726d    # TODO: determ
+00004d50: 696e 6520 7468 6520 6f70 7469 6d61 6c20  ine the optimal 
+00004d60: 6261 7463 6820 7369 7a65 7320 7769 7468  batch sizes with
+00004d70: 206d 696e 2061 6e64 206d 6178 206f 6620   min and max of 
+00004d80: 726f 7769 6420 7769 6c6c 0a20 2020 2020  rowid will.     
+00004d90: 2020 2023 2069 6e20 736f 6d65 2063 6173     # in some cas
+00004da0: 6520 696d 7072 6f76 6520 7065 7266 6f72  e improve perfor
+00004db0: 6d61 6e63 650a 2020 2020 2020 2020 2222  mance.        ""
+00004dc0: 220a 2020 2020 2020 2020 7371 6c5f 7374  ".        sql_st
+00004dd0: 6d74 203d 2066 2727 2753 454c 4543 5420  mt = f'''SELECT 
+00004de0: 4d49 4e28 726f 7769 6429 2061 7320 6d69  MIN(rowid) as mi
+00004df0: 6e5f 726f 7769 642c 204d 4158 2872 6f77  n_rowid, MAX(row
+00004e00: 6964 2920 6173 206d 6178 5f72 6f77 6964  id) as max_rowid
+00004e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004e20: 2020 2020 2020 2020 2020 4652 4f4d 2022            FROM "
+00004e30: 7b69 6e70 7574 5f6c 6179 6572 7d22 2727  {input_layer}"''
+00004e40: 270a 2020 2020 2020 2020 7265 7375 6c74  '.        result
+00004e50: 203d 2067 666f 2e72 6561 645f 6669 6c65   = gfo.read_file
+00004e60: 280a 2020 2020 2020 2020 2020 2020 7061  (.            pa
+00004e70: 7468 3d74 656d 705f 7061 7468 2c20 6c61  th=temp_path, la
+00004e80: 7965 723d 696e 7075 745f 6c61 7965 722c  yer=input_layer,
+00004e90: 2073 716c 5f73 746d 743d 7371 6c5f 7374   sql_stmt=sql_st
+00004ea0: 6d74 2c20 7371 6c5f 6469 616c 6563 743d  mt, sql_dialect=
+00004eb0: 2253 514c 4954 4522 0a20 2020 2020 2020  "SQLITE".       
+00004ec0: 2029 0a20 2020 2020 2020 2069 6620 6c65   ).        if le
+00004ed0: 6e28 7265 7375 6c74 2920 3d3d 2031 3a0a  n(result) == 1:.
+00004ee0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00004ef0: 726f 7769 6420 3d20 7265 7375 6c74 5b27  rowid = result['
+00004f00: 6d69 6e5f 726f 7769 6427 5d2e 7661 6c75  min_rowid'].valu
+00004f10: 6573 5b30 5d0a 2020 2020 2020 2020 2020  es[0].          
+00004f20: 2020 6d61 785f 726f 7769 6420 3d20 7265    max_rowid = re
+00004f30: 7375 6c74 5b27 6d61 785f 726f 7769 6427  sult['max_rowid'
+00004f40: 5d2e 7661 6c75 6573 5b30 5d0a 2020 2020  ].values[0].    
+00004f50: 2020 2020 2020 2020 6e62 5f72 6f77 6964          nb_rowid
+00004f60: 735f 7065 725f 6261 7463 6820 3d20 286d  s_per_batch = (m
+00004f70: 6178 5f72 6f77 6964 202d 206d 696e 5f72  ax_rowid - min_r
+00004f80: 6f77 6964 292f 6e62 5f62 6174 6368 6573  owid)/nb_batches
+00004f90: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00004fa0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00004fb0: 2045 7863 6570 7469 6f6e 280a 2020 2020   Exception(.    
+00004fc0: 2020 2020 2020 2020 2020 2020 6622 4572              f"Er
+00004fd0: 726f 7220 6765 7474 696e 6720 6d69 6e20  ror getting min 
+00004fe0: 616e 6420 6d61 7820 726f 7769 6420 666f  and max rowid fo
+00004ff0: 7220 7b74 656d 705f 7061 7468 7d2c 206c  r {temp_path}, l
+00005000: 6179 6572 207b 696e 7075 745f 6c61 7965  ayer {input_laye
+00005010: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+00005020: 290a 2020 2020 2020 2020 2222 220a 0a20  ).        """.. 
+00005030: 2020 2020 2020 2023 2050 726f 6365 7373         # Process
+00005040: 696e 6720 696e 2074 6872 6561 6473 2069  ing in threads i
+00005050: 7320 3278 2066 6173 7465 7220 666f 7220  s 2x faster for 
+00005060: 736d 616c 6c20 6461 7461 7365 7473 2028  small datasets (
+00005070: 6f6e 2057 696e 646f 7773 290a 2020 2020  on Windows).    
+00005080: 2020 2020 6361 6c63 756c 6174 655f 696e      calculate_in
+00005090: 5f74 6872 6561 6473 203d 2054 7275 6520  _threads = True 
+000050a0: 6966 2069 6e70 7574 5f6c 6179 6572 696e  if input_layerin
+000050b0: 666f 2e66 6561 7475 7265 636f 756e 7420  fo.featurecount 
+000050c0: 3c3d 2031 3030 2065 6c73 6520 4661 6c73  <= 100 else Fals
+000050d0: 650a 2020 2020 2020 2020 7769 7468 205f  e.        with _
+000050e0: 7072 6f63 6573 7369 6e67 5f75 7469 6c2e  processing_util.
+000050f0: 506f 6f6c 6564 4578 6563 7574 6f72 4661  PooledExecutorFa
+00005100: 6374 6f72 7928 0a20 2020 2020 2020 2020  ctory(.         
+00005110: 2020 2074 6872 6561 6470 6f6f 6c3d 6361     threadpool=ca
+00005120: 6c63 756c 6174 655f 696e 5f74 6872 6561  lculate_in_threa
+00005130: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00005140: 6d61 785f 776f 726b 6572 733d 6e62 5f70  max_workers=nb_p
+00005150: 6172 616c 6c65 6c2c 0a20 2020 2020 2020  arallel,.       
+00005160: 2020 2020 2069 6e69 7469 616c 697a 6572       initializer
+00005170: 3d5f 7072 6f63 6573 7369 6e67 5f75 7469  =_processing_uti
+00005180: 6c2e 696e 6974 6961 6c69 7a65 5f77 6f72  l.initialize_wor
+00005190: 6b65 7228 292c 0a20 2020 2020 2020 2029  ker(),.        )
+000051a0: 2061 7320 6361 6c63 756c 6174 655f 706f   as calculate_po
+000051b0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
+000051c0: 2320 5072 6570 6172 6520 6f75 7470 7574  # Prepare output
+000051d0: 2066 696c 656e 616d 650a 2020 2020 2020   filename.      
+000051e0: 2020 2020 2020 746d 705f 6f75 7470 7574        tmp_output
+000051f0: 5f70 6174 6820 3d20 7465 6d70 6469 7220  _path = tempdir 
+00005200: 2f20 6f75 7470 7574 5f70 6174 682e 6e61  / output_path.na
+00005210: 6d65 0a0a 2020 2020 2020 2020 2020 2020  me..            
+00005220: 726f 775f 6f66 6673 6574 203d 2030 0a20  row_offset = 0. 
+00005230: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+00005240: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
+00005250: 2020 2020 6675 7475 7265 5f74 6f5f 6261      future_to_ba
+00005260: 7463 685f 6964 203d 207b 7d0a 2020 2020  tch_id = {}.    
+00005270: 2020 2020 2020 2020 6e62 5f64 6f6e 6520          nb_done 
+00005280: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
+00005290: 2066 6f72 2062 6174 6368 5f69 6420 696e   for batch_id in
+000052a0: 2072 616e 6765 286e 625f 6261 7463 6865   range(nb_batche
+000052b0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+000052c0: 2020 2020 6261 7463 6865 735b 6261 7463      batches[batc
+000052d0: 685f 6964 5d20 3d20 7b7d 0a20 2020 2020  h_id] = {}.     
+000052e0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+000052f0: 6573 5b62 6174 6368 5f69 645d 5b22 6c61  es[batch_id]["la
+00005300: 7965 7222 5d20 3d20 6f75 7470 7574 5f6c  yer"] = output_l
+00005310: 6179 6572 0a0a 2020 2020 2020 2020 2020  ayer..          
+00005320: 2020 2020 2020 2320 4f75 7470 7574 2065        # Output e
+00005330: 6163 6820 6261 7463 6820 746f 2061 2073  ach batch to a s
+00005340: 6570 6572 6174 6520 7465 6d70 6f72 6172  eperate temporar
+00005350: 7920 6669 6c65 2c20 6f74 6865 7277 6973  y file, otherwis
+00005360: 6520 7468 6572 650a 2020 2020 2020 2020  e there.        
+00005370: 2020 2020 2020 2020 2320 6172 6520 7469          # are ti
+00005380: 6d65 6f75 7420 6973 7375 6573 2077 6865  meout issues whe
+00005390: 6e20 7072 6f63 6573 7369 6e67 206c 6172  n processing lar
+000053a0: 6765 2066 696c 6573 0a20 2020 2020 2020  ge files.       
+000053b0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+000053c0: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
+000053d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000053e0: 2020 2020 2020 2020 2074 656d 7064 6972           tempdir
+000053f0: 202f 2066 227b 6f75 7470 7574 5f70 6174   / f"{output_pat
+00005400: 682e 7374 656d 7d5f 7b62 6174 6368 5f69  h.stem}_{batch_i
+00005410: 647d 2e67 706b 6722 0a20 2020 2020 2020  d}.gpkg".       
+00005420: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00005430: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+00005440: 6573 5b62 6174 6368 5f69 645d 5b22 746d  es[batch_id]["tm
+00005450: 705f 7061 7274 6961 6c5f 6f75 7470 7574  p_partial_output
+00005460: 5f70 6174 6822 5d20 3d20 6f75 7470 7574  _path"] = output
+00005470: 5f74 6d70 5f70 6172 7469 616c 5f70 6174  _tmp_partial_pat
+00005480: 680a 0a20 2020 2020 2020 2020 2020 2020  h..             
+00005490: 2020 2023 2046 6f72 2074 6865 206c 6173     # For the las
+000054a0: 7420 7472 616e 736c 6174 655f 6964 2c20  t translate_id, 
+000054b0: 7461 6b65 2061 6c6c 2072 6f77 6964 2773  take all rowid's
+000054c0: 206c 6566 742e 2e2e 0a20 2020 2020 2020   left....       
+000054d0: 2020 2020 2020 2020 2069 6620 6261 7463           if batc
+000054e0: 685f 6964 203c 206e 625f 6261 7463 6865  h_id < nb_batche
+000054f0: 7320 2d20 313a 0a20 2020 2020 2020 2020  s - 1:.         
+00005500: 2020 2020 2020 2020 2020 2072 6f77 7320             rows 
+00005510: 3d20 736c 6963 6528 726f 775f 6f66 6673  = slice(row_offs
+00005520: 6574 2c20 726f 775f 6f66 6673 6574 202b  et, row_offset +
+00005530: 2072 6561 6c5f 6261 7463 6873 697a 6529   real_batchsize)
+00005540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005550: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00005560: 2020 2020 2020 2020 2020 2072 6f77 7320             rows 
+00005570: 3d20 736c 6963 6528 726f 775f 6f66 6673  = slice(row_offs
+00005580: 6574 2c20 6e62 5f72 6f77 735f 746f 7461  et, nb_rows_tota
+00005590: 6c29 0a0a 2020 2020 2020 2020 2020 2020  l)..            
+000055a0: 2020 2020 2320 5265 6d61 726b 3a20 7468      # Remark: th
+000055b0: 6973 2074 656d 7020 6669 6c65 2064 6f65  is temp file doe
+000055c0: 736e 2774 206e 6565 6420 7370 6174 6961  sn't need spatia
+000055d0: 6c20 696e 6465 780a 2020 2020 2020 2020  l index.        
+000055e0: 2020 2020 2020 2020 2320 5265 6d61 726b          # Remark
+000055f0: 3a20 6265 6361 7573 6520 666f 7263 655f  : because force_
+00005600: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00005610: 7970 6520 666f 7220 4765 6f44 6174 6146  ype for GeoDataF
+00005620: 7261 6d65 0a20 2020 2020 2020 2020 2020  rame.           
+00005630: 2020 2020 2023 206f 7065 7261 7469 6f6e       # operation
+00005640: 7320 6973 2028 6120 6c6f 7429 206d 6f72  s is (a lot) mor
+00005650: 6520 6c69 6d69 7465 6420 7468 616e 2067  e limited than g
+00005660: 6461 6c2d 6261 7365 642c 2074 6865 2067  dal-based, the g
+00005670: 6461 6c20 7665 7273 696f 6e0a 2020 2020  dal version.    
+00005680: 2020 2020 2020 2020 2020 2020 2320 6973              # is
+00005690: 2075 7365 6420 6c61 7465 7220 6f6e 2077   used later on w
+000056a0: 6865 6e20 7468 6520 7265 7375 6c74 7320  hen the results 
+000056b0: 6172 6520 6d65 7267 6564 2074 6f20 7468  are merged to th
+000056c0: 6520 7265 7375 6c74 2066 696c 652e 0a20  e result file.. 
+000056d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000056e0: 7574 7572 6520 3d20 6361 6c63 756c 6174  uture = calculat
+000056f0: 655f 706f 6f6c 2e73 7562 6d69 7428 0a20  e_pool.submit(. 
+00005700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005710: 2020 205f 6170 706c 795f 6765 6f6f 7065     _apply_geoope
+00005720: 7261 7469 6f6e 2c0a 2020 2020 2020 2020  ration,.        
+00005730: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00005740: 745f 7061 7468 3d69 6e70 7574 5f70 6174  t_path=input_pat
+00005750: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+00005760: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
+00005770: 7468 3d6f 7574 7075 745f 746d 705f 7061  th=output_tmp_pa
+00005780: 7274 6961 6c5f 7061 7468 2c0a 2020 2020  rtial_path,.    
 00005790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057a0: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
-000057b0: 696e 6465 783d 4661 6c73 652c 0a20 2020  index=False,.   
-000057c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000057e0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-000057f0: 7279 7479 7065 3d66 6f72 6365 5f6f 7574  rytype=force_out
-00005800: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00005810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005820: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00005830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005840: 2020 2020 2020 2020 2020 2020 6766 6f2e              gfo.
-00005850: 7265 6d6f 7665 2874 6d70 5f70 6172 7469  remove(tmp_parti
-00005860: 616c 5f6f 7574 7075 745f 7061 7468 290a  al_output_path).
-00005870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005880: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00005890: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-000058a0: 2020 2020 2020 2062 6174 6368 5f69 6420         batch_id 
-000058b0: 3d20 6675 7475 7265 5f74 6f5f 6261 7463  = future_to_batc
-000058c0: 685f 6964 5b66 7574 7572 655d 0a20 2020  h_id[future].   
-000058d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058e0: 2023 2063 616c 6375 6c61 7465 5f70 6f6f   # calculate_poo
-000058f0: 6c2e 7368 7574 646f 776e 2829 0a20 2020  l.shutdown().   
-00005900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005910: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
-00005920: 6e28 6622 4572 726f 7220 6578 6563 7574  n(f"Error execut
-00005930: 696e 6720 7b62 6174 6368 6573 5b62 6174  ing {batches[bat
-00005940: 6368 5f69 645d 7d22 290a 0a20 2020 2020  ch_id]}")..     
-00005950: 2020 2020 2020 2020 2020 2023 204c 6f67             # Log
-00005960: 2074 6865 2070 726f 6772 6573 7320 616e   the progress an
-00005970: 6420 7072 6564 6963 7469 6f6e 2073 7065  d prediction spe
-00005980: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-00005990: 2020 206e 625f 646f 6e65 202b 3d20 310a     nb_done += 1.
-000059a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059b0: 5f67 656e 6572 616c 5f75 7469 6c2e 7265  _general_util.re
-000059c0: 706f 7274 5f70 726f 6772 6573 7328 0a20  port_progress(. 
-000059d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059e0: 2020 2073 7461 7274 5f74 696d 652c 206e     start_time, n
-000059f0: 625f 646f 6e65 2c20 6e62 5f62 6174 6368  b_done, nb_batch
-00005a00: 6573 2c20 6f70 6572 6174 696f 6e2e 7661  es, operation.va
-00005a10: 6c75 652c 206e 625f 7061 7261 6c6c 656c  lue, nb_parallel
-00005a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005a30: 2029 0a0a 2020 2020 2020 2020 2320 526f   )..        # Ro
-00005a40: 756e 6420 7570 2061 6e64 2063 6c65 616e  und up and clean
-00005a50: 2075 700a 2020 2020 2020 2020 2320 4e6f   up.        # No
-00005a60: 7720 6372 6561 7465 2073 7061 7469 616c  w create spatial
-00005a70: 2069 6e64 6578 2061 6e64 206d 6f76 6520   index and move 
-00005a80: 746f 206f 7574 7075 7420 6c6f 6361 7469  to output locati
-00005a90: 6f6e 0a20 2020 2020 2020 2069 6620 746d  on.        if tm
-00005aa0: 705f 6f75 7470 7574 5f70 6174 682e 6578  p_output_path.ex
-00005ab0: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
-00005ac0: 2020 2020 6766 6f2e 6372 6561 7465 5f73      gfo.create_s
-00005ad0: 7061 7469 616c 5f69 6e64 6578 2870 6174  patial_index(pat
-00005ae0: 683d 746d 705f 6f75 7470 7574 5f70 6174  h=tmp_output_pat
-00005af0: 682c 206c 6179 6572 3d6f 7574 7075 745f  h, layer=output_
-00005b00: 6c61 7965 7229 0a20 2020 2020 2020 2020  layer).         
-00005b10: 2020 2067 666f 2e6d 6f76 6528 746d 705f     gfo.move(tmp_
-00005b20: 6f75 7470 7574 5f70 6174 682c 206f 7574  output_path, out
-00005b30: 7075 745f 7061 7468 290a 2020 2020 2020  put_path).      
-00005b40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005b50: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00005b60: 2866 2252 6573 756c 7420 6f66 207b 6f70  (f"Result of {op
-00005b70: 6572 6174 696f 6e7d 2077 6173 2065 6d70  eration} was emp
-00005b80: 7479 2122 290a 0a20 2020 2066 696e 616c  ty!")..    final
-00005b90: 6c79 3a0a 2020 2020 2020 2020 2320 436c  ly:.        # Cl
-00005ba0: 6561 6e20 746d 7020 6469 720a 2020 2020  ean tmp dir.    
-00005bb0: 2020 2020 7368 7574 696c 2e72 6d74 7265      shutil.rmtre
-00005bc0: 6528 7465 6d70 6469 7229 0a20 2020 2020  e(tempdir).     
-00005bd0: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-00005be0: 227b 6f70 6572 6174 696f 6e7d 2072 6561  "{operation} rea
-00005bf0: 6479 2c20 746f 6f6b 207b 6461 7465 7469  dy, took {dateti
-00005c00: 6d65 2e6e 6f77 2829 2d73 7461 7274 5f74  me.now()-start_t
-00005c10: 696d 655f 676c 6f62 616c 7d21 2229 0a0a  ime_global}!")..
-00005c20: 0a64 6566 205f 6170 706c 795f 6765 6f6f  .def _apply_geoo
-00005c30: 7065 7261 7469 6f6e 280a 2020 2020 696e  peration(.    in
-00005c40: 7075 745f 7061 7468 3a20 5061 7468 2c0a  put_path: Path,.
-00005c50: 2020 2020 6f75 7470 7574 5f70 6174 683a      output_path:
-00005c60: 2050 6174 682c 0a20 2020 206f 7065 7261   Path,.    opera
-00005c70: 7469 6f6e 3a20 4765 6f4f 7065 7261 7469  tion: GeoOperati
-00005c80: 6f6e 2c0a 2020 2020 6f70 6572 6174 696f  on,.    operatio
-00005c90: 6e5f 7061 7261 6d73 3a20 6469 6374 2c0a  n_params: dict,.
-00005ca0: 2020 2020 696e 7075 745f 6c61 7965 723a      input_layer:
-00005cb0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00005cc0: 204e 6f6e 652c 0a20 2020 206f 7574 7075   None,.    outpu
-00005cd0: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
-00005ce0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00005cf0: 2020 2063 6f6c 756d 6e73 3a20 4f70 7469     columns: Opti
-00005d00: 6f6e 616c 5b4c 6973 745b 7374 725d 5d20  onal[List[str]] 
-00005d10: 3d20 4e6f 6e65 2c0a 2020 2020 726f 7773  = None,.    rows
-00005d20: 3d4e 6f6e 652c 0a20 2020 2065 7870 6c6f  =None,.    explo
-00005d30: 6465 636f 6c6c 6563 7469 6f6e 733a 2062  decollections: b
-00005d40: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00005d50: 2067 7269 6473 697a 653a 2066 6c6f 6174   gridsize: float
-00005d60: 203d 2030 2e30 2c0a 2020 2020 666f 7263   = 0.0,.    forc
-00005d70: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
-00005d80: 0a29 202d 3e20 7374 723a 0a20 2020 2023  .) -> str:.    #
-00005d90: 2049 6e69 740a 2020 2020 6966 206f 7574   Init.    if out
-00005da0: 7075 745f 7061 7468 2e65 7869 7374 7328  put_path.exists(
-00005db0: 293a 0a20 2020 2020 2020 2069 6620 666f  ):.        if fo
-00005dc0: 7263 6520 6973 2046 616c 7365 3a0a 2020  rce is False:.  
-00005dd0: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
-00005de0: 6520 3d20 6622 5374 6f70 207b 6f70 6572  e = f"Stop {oper
-00005df0: 6174 696f 6e7d 3a20 6f75 7470 7574 2065  ation}: output e
-00005e00: 7869 7374 7320 616c 7265 6164 7920 7b6f  xists already {o
-00005e10: 7574 7075 745f 7061 7468 7d22 0a20 2020  utput_path}".   
-00005e20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00005e30: 6d65 7373 6167 650a 2020 2020 2020 2020  message.        
-00005e40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005e50: 2020 6766 6f2e 7265 6d6f 7665 286f 7574    gfo.remove(out
-00005e60: 7075 745f 7061 7468 290a 0a20 2020 2023  put_path)..    #
-00005e70: 204e 6f77 2067 6f21 0a20 2020 2073 7461   Now go!.    sta
-00005e80: 7274 5f74 696d 6520 3d20 6461 7465 7469  rt_time = dateti
-00005e90: 6d65 2e6e 6f77 2829 0a20 2020 2064 6174  me.now().    dat
-00005ea0: 615f 6764 6620 3d20 6766 6f2e 7265 6164  a_gdf = gfo.read
-00005eb0: 5f66 696c 6528 0a20 2020 2020 2020 2070  _file(.        p
-00005ec0: 6174 683d 696e 7075 745f 7061 7468 2c20  ath=input_path, 
-00005ed0: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
-00005ee0: 722c 2063 6f6c 756d 6e73 3d63 6f6c 756d  r, columns=colum
-00005ef0: 6e73 2c20 726f 7773 3d72 6f77 730a 2020  ns, rows=rows.  
-00005f00: 2020 290a 0a20 2020 2023 2052 756e 206f    )..    # Run o
-00005f10: 7065 7261 7469 6f6e 730a 2020 2020 6966  perations.    if
-00005f20: 206f 7065 7261 7469 6f6e 2069 7320 4765   operation is Ge
-00005f30: 6f4f 7065 7261 7469 6f6e 2e42 5546 4645  oOperation.BUFFE
-00005f40: 523a 0a20 2020 2020 2020 2064 6174 615f  R:.        data_
-00005f50: 6764 662e 6765 6f6d 6574 7279 203d 2064  gdf.geometry = d
-00005f60: 6174 615f 6764 662e 6765 6f6d 6574 7279  ata_gdf.geometry
-00005f70: 2e62 7566 6665 7228 0a20 2020 2020 2020  .buffer(.       
-00005f80: 2020 2020 2064 6973 7461 6e63 653d 6f70       distance=op
-00005f90: 6572 6174 696f 6e5f 7061 7261 6d73 5b22  eration_params["
-00005fa0: 6469 7374 616e 6365 225d 2c0a 2020 2020  distance"],.    
-00005fb0: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
-00005fc0: 6f6e 3d6f 7065 7261 7469 6f6e 5f70 6172  on=operation_par
-00005fd0: 616d 735b 2271 7561 6472 616e 7473 6567  ams["quadrantseg
-00005fe0: 6d65 6e74 7322 5d2c 0a20 2020 2020 2020  ments"],.       
-00005ff0: 2020 2020 2063 6170 5f73 7479 6c65 3d6f       cap_style=o
-00006000: 7065 7261 7469 6f6e 5f70 6172 616d 735b  peration_params[
-00006010: 2265 6e64 6361 705f 7374 796c 6522 5d2e  "endcap_style"].
-00006020: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
-00006030: 2020 206a 6f69 6e5f 7374 796c 653d 6f70     join_style=op
-00006040: 6572 6174 696f 6e5f 7061 7261 6d73 5b22  eration_params["
-00006050: 6a6f 696e 5f73 7479 6c65 225d 2e76 616c  join_style"].val
-00006060: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00006070: 6d69 7472 655f 6c69 6d69 743d 6f70 6572  mitre_limit=oper
-00006080: 6174 696f 6e5f 7061 7261 6d73 5b22 6d69  ation_params["mi
-00006090: 7472 655f 6c69 6d69 7422 5d2c 0a20 2020  tre_limit"],.   
-000060a0: 2020 2020 2020 2020 2073 696e 676c 655f           single_
-000060b0: 7369 6465 643d 6f70 6572 6174 696f 6e5f  sided=operation_
-000060c0: 7061 7261 6d73 5b22 7369 6e67 6c65 5f73  params["single_s
-000060d0: 6964 6564 225d 2c0a 2020 2020 2020 2020  ided"],.        
-000060e0: 290a 2020 2020 656c 6966 206f 7065 7261  ).    elif opera
-000060f0: 7469 6f6e 2069 7320 4765 6f4f 7065 7261  tion is GeoOpera
-00006100: 7469 6f6e 2e43 4f4e 5645 5848 554c 4c3a  tion.CONVEXHULL:
-00006110: 0a20 2020 2020 2020 2064 6174 615f 6764  .        data_gd
-00006120: 662e 6765 6f6d 6574 7279 203d 2064 6174  f.geometry = dat
-00006130: 615f 6764 662e 6765 6f6d 6574 7279 2e63  a_gdf.geometry.c
-00006140: 6f6e 7665 785f 6875 6c6c 0a20 2020 2065  onvex_hull.    e
-00006150: 6c69 6620 6f70 6572 6174 696f 6e20 6973  lif operation is
-00006160: 2047 656f 4f70 6572 6174 696f 6e2e 5349   GeoOperation.SI
-00006170: 4d50 4c49 4659 3a0a 2020 2020 2020 2020  MPLIFY:.        
-00006180: 6461 7461 5f67 6466 2e67 656f 6d65 7472  data_gdf.geometr
-00006190: 7920 3d20 6765 6f73 6572 6965 735f 7574  y = geoseries_ut
-000061a0: 696c 2e73 696d 706c 6966 795f 6578 7428  il.simplify_ext(
-000061b0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000061c0: 615f 6764 662e 6765 6f6d 6574 7279 2c0a  a_gdf.geometry,.
-000061d0: 2020 2020 2020 2020 2020 2020 616c 676f              algo
-000061e0: 7269 7468 6d3d 6f70 6572 6174 696f 6e5f  rithm=operation_
-000061f0: 7061 7261 6d73 5b22 616c 676f 7269 7468  params["algorith
-00006200: 6d22 5d2c 0a20 2020 2020 2020 2020 2020  m"],.           
-00006210: 2074 6f6c 6572 616e 6365 3d6f 7065 7261   tolerance=opera
-00006220: 7469 6f6e 5f70 6172 616d 735b 2274 6f6c  tion_params["tol
-00006230: 6572 616e 6365 225d 2c0a 2020 2020 2020  erance"],.      
-00006240: 2020 2020 2020 6c6f 6f6b 6168 6561 643d        lookahead=
-00006250: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
-00006260: 5b22 7374 6570 225d 2c0a 2020 2020 2020  ["step"],.      
-00006270: 2020 290a 2020 2020 656c 6966 206f 7065    ).    elif ope
-00006280: 7261 7469 6f6e 2069 7320 4765 6f4f 7065  ration is GeoOpe
-00006290: 7261 7469 6f6e 2e41 5050 4c59 3a0a 2020  ration.APPLY:.  
-000062a0: 2020 2020 2020 6675 6e63 203d 2070 6963        func = pic
-000062b0: 6b6c 652e 6c6f 6164 7328 6f70 6572 6174  kle.loads(operat
-000062c0: 696f 6e5f 7061 7261 6d73 5b22 7069 636b  ion_params["pick
-000062d0: 6c65 645f 6675 6e63 225d 290a 2020 2020  led_func"]).    
-000062e0: 2020 2020 6966 206f 7065 7261 7469 6f6e      if operation
-000062f0: 5f70 6172 616d 735b 226f 6e6c 795f 6765  _params["only_ge
-00006300: 6f6d 5f69 6e70 7574 225d 2069 7320 5472  om_input"] is Tr
-00006310: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-00006320: 6461 7461 5f67 6466 2e67 656f 6d65 7472  data_gdf.geometr
-00006330: 7920 3d20 6461 7461 5f67 6466 2e67 656f  y = data_gdf.geo
-00006340: 6d65 7472 792e 6170 706c 7928 6675 6e63  metry.apply(func
-00006350: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00006360: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00006370: 5f67 6466 2e67 656f 6d65 7472 7920 3d20  _gdf.geometry = 
-00006380: 6461 7461 5f67 6466 2e61 7070 6c79 2866  data_gdf.apply(f
-00006390: 756e 632c 2061 7869 733d 3129 0a20 2020  unc, axis=1).   
-000063a0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-000063b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000063c0: 6622 6f70 6572 6174 696f 6e20 6e6f 7420  f"operation not 
-000063d0: 7375 7070 6f72 7465 643a 207b 6f70 6572  supported: {oper
-000063e0: 6174 696f 6e7d 2229 0a0a 2020 2020 2320  ation}")..    # 
-000063f0: 5265 6d6f 7665 2072 6f77 7320 7768 6572  Remove rows wher
-00006400: 6520 6765 6f6d 2069 7320 656d 7074 790a  e geom is empty.
-00006410: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00006420: 7461 6e63 6528 6461 7461 5f67 6466 2c20  tance(data_gdf, 
-00006430: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-00006440: 290a 2020 2020 6173 7365 7274 2064 6174  ).    assert dat
-00006450: 615f 6764 662e 6765 6f6d 6574 7279 2069  a_gdf.geometry i
-00006460: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2064  s not None.    d
-00006470: 6174 615f 6764 6620 3d20 6461 7461 5f67  ata_gdf = data_g
-00006480: 6466 5b7e 6461 7461 5f67 6466 2e67 656f  df[~data_gdf.geo
-00006490: 6d65 7472 792e 6973 5f65 6d70 7479 5d0a  metry.is_empty].
-000064a0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-000064b0: 7461 6e63 6528 6461 7461 5f67 6466 2c20  tance(data_gdf, 
-000064c0: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-000064d0: 290a 2020 2020 6461 7461 5f67 6466 203d  ).    data_gdf =
-000064e0: 2064 6174 615f 6764 665b 7e64 6174 615f   data_gdf[~data_
-000064f0: 6764 662e 6765 6f6d 6574 7279 2e69 736e  gdf.geometry.isn
-00006500: 6128 295d 0a0a 2020 2020 2320 4966 2074  a()]..    # If t
-00006510: 6865 7265 2069 7320 616e 2066 6964 2063  here is an fid c
-00006520: 6f6c 756d 6e20 696e 2074 6865 2064 6174  olumn in the dat
-00006530: 6173 6574 2c20 7265 6e61 6d65 2069 742c  aset, rename it,
-00006540: 2062 6563 6175 7365 2074 6865 2066 6964   because the fid
-00006550: 2063 6f6c 756d 6e20 6973 2061 0a20 2020   column is a.   
-00006560: 2023 2022 7370 6563 6961 6c20 6361 7365   # "special case
-00006570: 2220 696e 2067 6461 6c20 7468 6174 2073  " in gdal that s
-00006580: 686f 756c 6420 6e6f 7420 6265 2077 7269  hould not be wri
-00006590: 7474 656e 2e0a 2020 2020 636f 6c75 6d6e  tten..    column
-000065a0: 735f 6c6f 7765 725f 6c6f 6f6b 7570 203d  s_lower_lookup =
-000065b0: 207b 636f 6c75 6d6e 2e6c 6f77 6572 2829   {column.lower()
-000065c0: 3a20 636f 6c75 6d6e 2066 6f72 2063 6f6c  : column for col
-000065d0: 756d 6e20 696e 2064 6174 615f 6764 662e  umn in data_gdf.
-000065e0: 636f 6c75 6d6e 737d 0a20 2020 2069 6620  columns}.    if 
-000065f0: 2266 6964 2220 696e 2063 6f6c 756d 6e73  "fid" in columns
-00006600: 5f6c 6f77 6572 5f6c 6f6f 6b75 703a 0a20  _lower_lookup:. 
-00006610: 2020 2020 2020 2066 6964 5f63 6f6c 756d         fid_colum
-00006620: 6e20 3d20 636f 6c75 6d6e 735f 6c6f 7765  n = columns_lowe
-00006630: 725f 6c6f 6f6b 7570 5b22 6669 6422 5d0a  r_lookup["fid"].
-00006640: 2020 2020 2020 2020 666f 7220 6669 645f          for fid_
-00006650: 6e75 6d62 6572 2069 6e20 7261 6e67 6528  number in range(
-00006660: 312c 2031 3030 293a 0a20 2020 2020 2020  1, 100):.       
-00006670: 2020 2020 206e 6577 5f6e 616d 6520 3d20       new_name = 
-00006680: 6622 7b66 6964 5f63 6f6c 756d 6e7d 5f7b  f"{fid_column}_{
-00006690: 6669 645f 6e75 6d62 6572 7d22 0a20 2020  fid_number}".   
-000066a0: 2020 2020 2020 2020 2069 6620 6e65 775f           if new_
-000066b0: 6e61 6d65 206e 6f74 2069 6e20 636f 6c75  name not in colu
-000066c0: 6d6e 735f 6c6f 7765 725f 6c6f 6f6b 7570  mns_lower_lookup
-000066d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000066e0: 2020 6461 7461 5f67 6466 203d 2064 6174    data_gdf = dat
-000066f0: 615f 6764 662e 7265 6e61 6d65 280a 2020  a_gdf.rename(.  
-00006700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006710: 2020 636f 6c75 6d6e 733d 7b66 6964 5f63    columns={fid_c
-00006720: 6f6c 756d 6e3a 206e 6577 5f6e 616d 657d  olumn: new_name}
-00006730: 2c20 636f 7079 3d46 616c 7365 2020 2320  , copy=False  # 
-00006740: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00006750: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00006760: 2020 2069 6620 6578 706c 6f64 6563 6f6c     if explodecol
-00006770: 6c65 6374 696f 6e73 3a0a 2020 2020 2020  lections:.      
-00006780: 2020 6461 7461 5f67 6466 203d 2064 6174    data_gdf = dat
-00006790: 615f 6764 662e 6578 706c 6f64 6528 6967  a_gdf.explode(ig
-000067a0: 6e6f 7265 5f69 6e64 6578 3d54 7275 6529  nore_index=True)
-000067b0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-000067c0: 0a0a 2020 2020 6966 2067 7269 6473 697a  ..    if gridsiz
-000067d0: 6520 213d 2030 2e30 3a0a 2020 2020 2020  e != 0.0:.      
-000067e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000067f0: 6e63 6528 6461 7461 5f67 6466 2c20 6770  nce(data_gdf, gp
-00006800: 642e 4765 6f44 6174 6146 7261 6d65 290a  d.GeoDataFrame).
-00006810: 2020 2020 2020 2020 6461 7461 5f67 6466          data_gdf
-00006820: 2e67 656f 6d65 7472 7920 3d20 7368 6170  .geometry = shap
-00006830: 656c 7932 5f6f 725f 7079 6765 6f73 2e73  ely2_or_pygeos.s
-00006840: 6574 5f70 7265 6369 7369 6f6e 280a 2020  et_precision(.  
-00006850: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
-00006860: 6466 2e67 656f 6d65 7472 792e 6172 7261  df.geometry.arra
-00006870: 792e 6461 7461 2c20 6772 6964 5f73 697a  y.data, grid_siz
-00006880: 653d 6772 6964 7369 7a65 0a20 2020 2020  e=gridsize.     
-00006890: 2020 2029 0a0a 2020 2020 2320 4966 2074     )..    # If t
-000068a0: 6865 2072 6573 756c 7420 6973 2065 6d70  he result is emp
-000068b0: 7479 2c20 616e 6420 6e6f 206f 7574 7075  ty, and no outpu
-000068c0: 7420 6765 6f6d 6574 7279 7479 7065 2073  t geometrytype s
-000068d0: 7065 6369 6669 6564 2c20 7573 6520 696e  pecified, use in
-000068e0: 7075 740a 2020 2020 2320 6765 6f6d 6574  put.    # geomet
-000068f0: 7279 7479 7065 0a20 2020 2066 6f72 6365  rytype.    force
-00006900: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-00006910: 7479 7065 203d 204e 6f6e 650a 2020 2020  type = None.    
-00006920: 6966 206c 656e 2864 6174 615f 6764 6629  if len(data_gdf)
-00006930: 203d 3d20 303a 0a20 2020 2020 2020 2069   == 0:.        i
-00006940: 6e70 7574 5f6c 6179 6572 696e 666f 203d  nput_layerinfo =
-00006950: 2067 666f 2e67 6574 5f6c 6179 6572 696e   gfo.get_layerin
-00006960: 666f 2869 6e70 7574 5f70 6174 682c 2069  fo(input_path, i
-00006970: 6e70 7574 5f6c 6179 6572 290a 2020 2020  nput_layer).    
-00006980: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-00006990: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
-000069a0: 696e 7075 745f 6c61 7965 7269 6e66 6f2e  input_layerinfo.
-000069b0: 6765 6f6d 6574 7279 7479 7065 2e74 6f5f  geometrytype.to_
-000069c0: 6d75 6c74 6974 7970 652e 6e61 6d65 0a0a  multitype.name..
-000069d0: 2020 2020 2320 6173 7365 7274 2074 6f20      # assert to 
-000069e0: 6576 6164 6520 7079 4c61 6e63 6520 7761  evade pyLance wa
-000069f0: 726e 696e 670a 2020 2020 6173 7365 7274  rning.    assert
-00006a00: 2069 7369 6e73 7461 6e63 6528 6461 7461   isinstance(data
-00006a10: 5f67 6466 2c20 6770 642e 4765 6f44 6174  _gdf, gpd.GeoDat
-00006a20: 6146 7261 6d65 290a 2020 2020 2320 5573  aFrame).    # Us
-00006a30: 6520 666f 7263 655f 6d75 6c74 6974 7970  e force_multityp
-00006a40: 652c 2074 6f20 6576 6164 6520 7761 726e  e, to evade warn
-00006a50: 696e 6773 2077 6865 6e20 736f 6d65 2062  ings when some b
-00006a60: 6174 6368 6573 2063 6f6e 7461 696e 0a20  atches contain. 
-00006a70: 2020 2023 2073 696e 676c 6574 7970 6520     # singletype 
-00006a80: 616e 6420 736f 6d65 2063 6f6e 7461 696e  and some contain
-00006a90: 206d 756c 7469 7479 7065 2067 656f 6d65   multitype geome
-00006aa0: 7472 6965 730a 2020 2020 6766 6f2e 746f  tries.    gfo.to
-00006ab0: 5f66 696c 6528 0a20 2020 2020 2020 2067  _file(.        g
-00006ac0: 6466 3d64 6174 615f 6764 662c 0a20 2020  df=data_gdf,.   
-00006ad0: 2020 2020 2070 6174 683d 6f75 7470 7574       path=output
-00006ae0: 5f70 6174 682c 0a20 2020 2020 2020 206c  _path,.        l
-00006af0: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
-00006b00: 722c 0a20 2020 2020 2020 2069 6e64 6578  r,.        index
-00006b10: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00006b20: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00006b30: 6d65 7472 7974 7970 653d 666f 7263 655f  metrytype=force_
-00006b40: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-00006b50: 7970 652c 0a20 2020 2020 2020 2066 6f72  ype,.        for
-00006b60: 6365 5f6d 756c 7469 7479 7065 3d54 7275  ce_multitype=Tru
-00006b70: 652c 0a20 2020 2020 2020 2063 7265 6174  e,.        creat
-00006b80: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
-00006b90: 4661 6c73 652c 0a20 2020 2029 0a0a 2020  False,.    )..  
-00006ba0: 2020 6d65 7373 6167 6520 3d20 6622 546f    message = f"To
-00006bb0: 6f6b 207b 6461 7465 7469 6d65 2e6e 6f77  ok {datetime.now
-00006bc0: 2829 2d73 7461 7274 5f74 696d 657d 2066  ()-start_time} f
-00006bd0: 6f72 207b 6c65 6e28 6461 7461 5f67 6466  or {len(data_gdf
-00006be0: 297d 2072 6f77 7320 287b 726f 7773 7d29  )} rows ({rows})
-00006bf0: 2122 0a20 2020 2072 6574 7572 6e20 6d65  !".    return me
-00006c00: 7373 6167 650a 0a0a 6465 6620 6469 7373  ssage...def diss
-00006c10: 6f6c 7665 280a 2020 2020 696e 7075 745f  olve(.    input_
-00006c20: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
-00006c30: 6f75 7470 7574 5f70 6174 683a 2050 6174  output_path: Pat
-00006c40: 682c 0a20 2020 2067 726f 7570 6279 5f63  h,.    groupby_c
-00006c50: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
-00006c60: 5b49 7465 7261 626c 655b 7374 725d 5d20  [Iterable[str]] 
-00006c70: 3d20 4e6f 6e65 2c0a 2020 2020 6167 675f  = None,.    agg_
-00006c80: 636f 6c75 6d6e 733a 204f 7074 696f 6e61  columns: Optiona
-00006c90: 6c5b 6469 6374 5d20 3d20 4e6f 6e65 2c0a  l[dict] = None,.
-00006ca0: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-00006cb0: 6374 696f 6e73 3a20 626f 6f6c 203d 2054  ctions: bool = T
-00006cc0: 7275 652c 0a20 2020 2074 696c 6573 5f70  rue,.    tiles_p
-00006cd0: 6174 683a 204f 7074 696f 6e61 6c5b 5061  ath: Optional[Pa
-00006ce0: 7468 5d20 3d20 4e6f 6e65 2c0a 2020 2020  th] = None,.    
-00006cf0: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
-00006d00: 733a 2069 6e74 203d 2031 2c0a 2020 2020  s: int = 1,.    
-00006d10: 696e 7075 745f 6c61 7965 723a 204f 7074  input_layer: Opt
-00006d20: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00006d30: 652c 0a20 2020 206f 7574 7075 745f 6c61  e,.    output_la
-00006d40: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00006d50: 725d 203d 204e 6f6e 652c 0a20 2020 2067  r] = None,.    g
-00006d60: 7269 6473 697a 653a 2066 6c6f 6174 203d  ridsize: float =
-00006d70: 2030 2e30 2c0a 2020 2020 6e62 5f70 6172   0.0,.    nb_par
-00006d80: 616c 6c65 6c3a 2069 6e74 203d 202d 312c  allel: int = -1,
-00006d90: 0a20 2020 2062 6174 6368 7369 7a65 3a20  .    batchsize: 
-00006da0: 696e 7420 3d20 2d31 2c0a 2020 2020 666f  int = -1,.    fo
-00006db0: 7263 653a 2062 6f6f 6c20 3d20 4661 6c73  rce: bool = Fals
-00006dc0: 652c 0a29 202d 3e20 6469 6374 3a0a 2020  e,.) -> dict:.  
-00006dd0: 2020 2222 220a 2020 2020 4675 6e63 7469    """.    Functi
-00006de0: 6f6e 2074 6861 7420 6170 706c 6965 7320  on that applies 
-00006df0: 6120 6469 7373 6f6c 7665 2e0a 0a20 2020  a dissolve...   
-00006e00: 204d 6f72 6520 6465 7461 696c 6564 2064   More detailed d
-00006e10: 6f63 756d 656e 7461 7469 6f6e 2069 6e20  ocumentation in 
-00006e20: 6d6f 6475 6c65 2067 656f 6f70 7321 0a20  module geoops!. 
-00006e30: 2020 2022 2222 0a0a 2020 2020 2320 496e     """..    # In
-00006e40: 6974 2061 6e64 2076 616c 6964 6174 6520  it and validate 
-00006e50: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
-00006e60: 0a20 2020 2023 202d 2d2d 2d2d 2d2d 2d2d  .    # ---------
-00006e70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00006e80: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7374  ---------.    st
-00006e90: 6172 745f 7469 6d65 203d 2064 6174 6574  art_time = datet
-00006ea0: 696d 652e 6e6f 7728 290a 2020 2020 6f70  ime.now().    op
-00006eb0: 6572 6174 696f 6e20 3d20 2264 6973 736f  eration = "disso
-00006ec0: 6c76 6522 0a20 2020 2072 6573 756c 745f  lve".    result_
-00006ed0: 696e 666f 203d 207b 7d0a 0a20 2020 2023  info = {}..    #
-00006ee0: 2043 6865 636b 2069 6e70 7574 2070 6172   Check input par
-00006ef0: 616d 6574 6572 730a 2020 2020 6966 2067  ameters.    if g
-00006f00: 726f 7570 6279 5f63 6f6c 756d 6e73 2069  roupby_columns i
-00006f10: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206c  s not None and l
-00006f20: 656e 286c 6973 7428 6772 6f75 7062 795f  en(list(groupby_
-00006f30: 636f 6c75 6d6e 7329 2920 3d3d 2030 3a0a  columns)) == 0:.
-00006f40: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00006f50: 6c75 6545 7272 6f72 2822 6772 6f75 7062  lueError("groupb
-00006f60: 795f 636f 6c75 6d6e 733d 5b5d 2069 7320  y_columns=[] is 
-00006f70: 6e6f 7420 7375 7070 6f72 7465 642e 2055  not supported. U
-00006f80: 7365 204e 6f6e 652e 2229 0a20 2020 2069  se None.").    i
-00006f90: 6620 6e6f 7420 696e 7075 745f 7061 7468  f not input_path
-00006fa0: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
-00006fb0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00006fc0: 726f 7228 6622 696e 7075 745f 7061 7468  ror(f"input_path
-00006fd0: 2064 6f65 736e 2774 2065 7869 7374 3a20   doesn't exist: 
-00006fe0: 7b69 6e70 7574 5f70 6174 687d 2229 0a20  {input_path}"). 
-00006ff0: 2020 2069 6620 696e 7075 745f 7061 7468     if input_path
-00007000: 203d 3d20 6f75 7470 7574 5f70 6174 683a   == output_path:
-00007010: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-00007020: 616c 7565 4572 726f 7228 226f 7574 7075  alueError("outpu
-00007030: 745f 7061 7468 206d 7573 7420 6e6f 7420  t_path must not 
-00007040: 6571 7561 6c20 696e 7075 745f 7061 7468  equal input_path
-00007050: 2229 0a0a 2020 2020 696e 7075 745f 6c61  ")..    input_la
-00007060: 7965 7269 6e66 6f20 3d20 6766 6f2e 6765  yerinfo = gfo.ge
-00007070: 745f 6c61 7965 7269 6e66 6f28 696e 7075  t_layerinfo(inpu
-00007080: 745f 7061 7468 2c20 696e 7075 745f 6c61  t_path, input_la
-00007090: 7965 7229 0a20 2020 2069 6620 696e 7075  yer).    if inpu
-000070a0: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
-000070b0: 6574 7279 7479 7065 2e74 6f5f 7072 696d  etrytype.to_prim
-000070c0: 6974 6976 6574 7970 6520 696e 205b 0a20  itivetype in [. 
-000070d0: 2020 2020 2020 2050 7269 6d69 7469 7665         Primitive
-000070e0: 5479 7065 2e50 4f49 4e54 2c0a 2020 2020  Type.POINT,.    
-000070f0: 2020 2020 5072 696d 6974 6976 6554 7970      PrimitiveTyp
-00007100: 652e 4c49 4e45 5354 5249 4e47 2c0a 2020  e.LINESTRING,.  
-00007110: 2020 5d3a 0a20 2020 2020 2020 2069 6620    ]:.        if 
-00007120: 7469 6c65 735f 7061 7468 2069 7320 6e6f  tiles_path is no
-00007130: 7420 4e6f 6e65 206f 7220 6e62 5f73 7175  t None or nb_squ
-00007140: 6172 6973 685f 7469 6c65 7320 3e20 313a  arish_tiles > 1:
-00007150: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00007160: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-00007170: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00007180: 2244 6973 736f 6c76 6520 746f 2074 696c  "Dissolve to til
-00007190: 6573 2069 7320 6e6f 7420 7375 7070 6f72  es is not suppor
-000071a0: 7465 6420 666f 7220 7b69 6e70 7574 5f6c  ted for {input_l
-000071b0: 6179 6572 696e 666f 2e67 656f 6d65 7472  ayerinfo.geometr
-000071c0: 7974 7970 657d 220a 2020 2020 2020 2020  ytype}".        
-000071d0: 2020 2020 2020 2020 222c 2073 6f20 7469          ", so ti
-000071e0: 6c65 735f 7061 7468 2073 686f 756c 6420  les_path should 
-000071f0: 6265 204e 6f6e 6520 616e 6420 6e62 5f73  be None and nb_s
-00007200: 7175 6172 6973 685f 7469 6c65 7320 7368  quarish_tiles sh
-00007210: 6f75 6c64 2062 6520 3129 220a 2020 2020  ould be 1)".    
-00007220: 2020 2020 2020 2020 290a 0a20 2020 2023          )..    #
-00007230: 2043 6865 636b 2063 6f6c 756d 6e73 2069   Check columns i
-00007240: 6e20 6772 6f75 7062 795f 636f 6c75 6d6e  n groupby_column
-00007250: 730a 2020 2020 6966 2067 726f 7570 6279  s.    if groupby
-00007260: 5f63 6f6c 756d 6e73 2069 7320 6e6f 7420  _columns is not 
-00007270: 4e6f 6e65 3a0a 2020 2020 2020 2020 636f  None:.        co
-00007280: 6c75 6d6e 735f 696e 5f6c 6179 6572 5f75  lumns_in_layer_u
-00007290: 7070 6572 203d 205b 0a20 2020 2020 2020  pper = [.       
-000072a0: 2020 2020 2063 6f6c 756d 6e2e 7570 7065       column.uppe
-000072b0: 7228 2920 666f 7220 636f 6c75 6d6e 2069  r() for column i
-000072c0: 6e20 6c69 7374 2869 6e70 7574 5f6c 6179  n list(input_lay
-000072d0: 6572 696e 666f 2e63 6f6c 756d 6e73 2920  erinfo.columns) 
-000072e0: 2b20 5b22 6669 6422 5d0a 2020 2020 2020  + ["fid"].      
-000072f0: 2020 5d0a 2020 2020 2020 2020 666f 7220    ].        for 
-00007300: 636f 6c75 6d6e 2069 6e20 6772 6f75 7062  column in groupb
-00007310: 795f 636f 6c75 6d6e 733a 0a20 2020 2020  y_columns:.     
-00007320: 2020 2020 2020 2069 6620 636f 6c75 6d6e         if column
-00007330: 2e75 7070 6572 2829 206e 6f74 2069 6e20  .upper() not in 
-00007340: 636f 6c75 6d6e 735f 696e 5f6c 6179 6572  columns_in_layer
-00007350: 5f75 7070 6572 3a0a 2020 2020 2020 2020  _upper:.        
-00007360: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00007370: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00007380: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007390: 636f 6c75 6d6e 2069 6e20 6772 6f75 7062  column in groupb
-000073a0: 795f 636f 6c75 6d6e 7320 6e6f 7420 6176  y_columns not av
-000073b0: 6169 6c61 626c 6520 696e 206c 6179 6572  ailable in layer
-000073c0: 3a20 7b63 6f6c 756d 6e7d 220a 2020 2020  : {column}".    
-000073d0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-000073e0: 2020 2023 2043 6865 636b 2061 6767 5f63     # Check agg_c
-000073f0: 6f6c 756d 6e73 2070 6172 616d 0a20 2020  olumns param.   
-00007400: 2069 6620 6167 675f 636f 6c75 6d6e 7320   if agg_columns 
-00007410: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00007420: 2020 2020 2023 2056 616c 6964 6174 6520       # Validate 
-00007430: 7468 6520 6469 6374 2073 7472 7563 7475  the dict structu
-00007440: 7265 2c20 736f 2077 6520 6361 6e20 6173  re, so we can as
-00007450: 7375 6d65 2065 7665 7279 7468 696e 6720  sume everything 
-00007460: 6973 204f 4b20 6675 7274 6865 7220 6f6e  is OK further on
-00007470: 0a20 2020 2020 2020 205f 7061 7261 6d65  .        _parame
-00007480: 7465 725f 6865 6c70 6572 2e76 616c 6964  ter_helper.valid
-00007490: 6174 655f 6167 675f 636f 6c75 6d6e 7328  ate_agg_columns(
-000074a0: 6167 675f 636f 6c75 6d6e 7329 0a0a 2020  agg_columns)..  
-000074b0: 2020 2020 2020 2320 4669 7273 7420 7461        # First ta
-000074c0: 6b65 2061 2064 6565 7020 636f 7079 2c20  ke a deep copy, 
-000074d0: 6173 2076 616c 7565 7320 6361 6e20 6265  as values can be
-000074e0: 2063 6861 6e67 6564 2066 7572 7468 6572   changed further
-000074f0: 206f 6e20 746f 2074 7265 6174 2063 6f6c   on to treat col
-00007500: 756d 6e73 0a20 2020 2020 2020 2023 2063  umns.        # c
-00007510: 6173 6520 696e 7365 6e73 6974 6976 650a  ase insensitive.
-00007520: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
-00007530: 6d6e 7320 3d20 6a73 6f6e 2e6c 6f61 6473  mns = json.loads
-00007540: 286a 736f 6e2e 6475 6d70 7328 6167 675f  (json.dumps(agg_
-00007550: 636f 6c75 6d6e 7329 290a 2020 2020 2020  columns)).      
-00007560: 2020 6173 7365 7274 2061 6767 5f63 6f6c    assert agg_col
-00007570: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
-00007580: 0a20 2020 2020 2020 2069 6620 226a 736f  .        if "jso
-00007590: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
-000075a0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-000075b0: 6620 6167 675f 636f 6c75 6d6e 735b 226a  f agg_columns["j
-000075c0: 736f 6e22 5d20 6973 204e 6f6e 653a 0a20  son"] is None:. 
-000075d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000075e0: 6767 5f63 6f6c 756d 6e73 5b22 6a73 6f6e  gg_columns["json
-000075f0: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
-00007600: 2020 2020 2020 2020 2020 2063 6f6c 2066             col f
-00007610: 6f72 2063 6f6c 2069 6e20 696e 7075 745f  or col in input_
-00007620: 6c61 7965 7269 6e66 6f2e 636f 6c75 6d6e  layerinfo.column
-00007630: 7320 6966 2063 6f6c 2e75 7070 6572 2829  s if col.upper()
-00007640: 2021 3d20 2249 4e44 4558 220a 2020 2020   != "INDEX".    
-00007650: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00007660: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00007670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007680: 2320 416c 6967 6e20 6361 7369 6e67 206f  # Align casing o
-00007690: 6620 636f 6c75 6d6e 206e 616d 6573 2074  f column names t
-000076a0: 6f20 6461 7461 0a20 2020 2020 2020 2020  o data.         
-000076b0: 2020 2020 2020 2061 6767 5f63 6f6c 756d         agg_colum
-000076c0: 6e73 5b22 6a73 6f6e 225d 203d 205f 6765  ns["json"] = _ge
-000076d0: 6e65 7261 6c5f 7574 696c 2e61 6c69 676e  neral_util.align
-000076e0: 5f63 6173 696e 675f 6c69 7374 280a 2020  _casing_list(.  
-000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007700: 2020 6167 675f 636f 6c75 6d6e 735b 226a    agg_columns["j
-00007710: 736f 6e22 5d2c 206c 6973 7428 696e 7075  son"], list(inpu
-00007720: 745f 6c61 7965 7269 6e66 6f2e 636f 6c75  t_layerinfo.colu
-00007730: 6d6e 7329 202b 205b 2266 6964 225d 0a20  mns) + ["fid"]. 
-00007740: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00007750: 0a20 2020 2020 2020 2065 6c69 6620 2263  .        elif "c
-00007760: 6f6c 756d 6e73 2220 696e 2061 6767 5f63  olumns" in agg_c
-00007770: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
-00007780: 2020 2020 2320 4c6f 6f70 2074 6872 6f75      # Loop throu
-00007790: 6768 2061 6c6c 2072 6f77 730a 2020 2020  gh all rows.    
-000077a0: 2020 2020 2020 2020 666f 7220 6167 675f          for agg_
-000077b0: 636f 6c75 6d6e 2069 6e20 6167 675f 636f  column in agg_co
-000077c0: 6c75 6d6e 735b 2263 6f6c 756d 6e73 225d  lumns["columns"]
-000077d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000077e0: 2020 2320 4368 6563 6b20 6966 2063 6f6c    # Check if col
-000077f0: 756d 6e20 6578 6973 7473 202b 2073 6574  umn exists + set
-00007800: 2063 6173 696e 6720 7361 6d65 2061 7320   casing same as 
-00007810: 696e 2064 6174 610a 2020 2020 2020 2020  in data.        
-00007820: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
-00007830: 6d6e 5b22 636f 6c75 6d6e 225d 203d 205f  mn["column"] = _
-00007840: 6765 6e65 7261 6c5f 7574 696c 2e61 6c69  general_util.ali
-00007850: 676e 5f63 6173 696e 6728 0a20 2020 2020  gn_casing(.     
-00007860: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00007870: 6767 5f63 6f6c 756d 6e5b 2263 6f6c 756d  gg_column["colum
-00007880: 6e22 5d2c 206c 6973 7428 696e 7075 745f  n"], list(input_
-00007890: 6c61 7965 7269 6e66 6f2e 636f 6c75 6d6e  layerinfo.column
-000078a0: 7329 202b 205b 2266 6964 225d 0a20 2020  s) + ["fid"].   
-000078b0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-000078c0: 2020 2020 2320 4e6f 7720 696e 7075 7420      # Now input 
-000078d0: 7061 7261 6d65 7465 7273 2061 7265 2063  parameters are c
-000078e0: 6865 636b 6564 2c20 6368 6563 6b20 6966  hecked, check if
-000078f0: 2077 6520 6e65 6564 2074 6f20 6361 6c63   we need to calc
-00007900: 616c 6174 6520 616e 7977 6179 0a20 2020  alate anyway.   
-00007910: 2069 6620 6f75 7470 7574 5f70 6174 682e   if output_path.
-00007920: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
-00007930: 2020 6966 2066 6f72 6365 2069 7320 4661    if force is Fa
-00007940: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00007950: 2072 6573 756c 745f 696e 666f 5b0a 2020   result_info[.  
-00007960: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00007970: 6573 7361 6765 220a 2020 2020 2020 2020  essage".        
-00007980: 2020 2020 5d20 3d20 6622 6f75 7470 7574      ] = f"output
-00007990: 2065 7869 7374 7320 616c 7265 6164 7920   exists already 
-000079a0: 7b6f 7574 7075 745f 7061 7468 7d20 616e  {output_path} an
-000079b0: 6420 666f 7263 6520 6973 2066 616c 7365  d force is false
-000079c0: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
-000079d0: 6767 6572 2e69 6e66 6f28 7265 7375 6c74  gger.info(result
-000079e0: 5f69 6e66 6f5b 226d 6573 7361 6765 225d  _info["message"]
-000079f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00007a00: 7475 726e 2072 6573 756c 745f 696e 666f  turn result_info
-00007a10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00007a20: 2020 2020 2020 2020 2020 2067 666f 2e72             gfo.r
-00007a30: 656d 6f76 6528 6f75 7470 7574 5f70 6174  emove(output_pat
-00007a40: 6829 0a0a 2020 2020 2320 4e6f 7720 7374  h)..    # Now st
-00007a50: 6172 7420 6469 7373 6f6c 7669 6e67 0a20  art dissolving. 
-00007a60: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d     # -----------
-00007a70: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2320  ---------.    # 
-00007a80: 456d 7074 7920 6f72 204c 696e 6520 616e  Empty or Line an
-00007a90: 6420 706f 696e 7420 6c61 7965 7273 2061  d point layers a
-00007aa0: 7265 3a0a 2020 2020 2320 2020 2a20 6e6f  re:.    #   * no
-00007ab0: 7420 736f 206c 6172 6765 2028 6d65 6d6f  t so large (memo
-00007ac0: 7279 2d77 6973 6529 0a20 2020 2023 2020  ry-wise).    #  
-00007ad0: 202a 2061 7265 6e27 7420 636f 6d70 7574   * aren't comput
-00007ae0: 6174 696f 6e61 6c6c 7920 6865 6176 790a  ationally heavy.
-00007af0: 2020 2020 2320 4164 6469 7469 6f6e 616c      # Additional
-00007b00: 6c79 206c 696e 6520 6c61 7965 7273 2061  ly line layers a
-00007b10: 7265 2061 2070 6169 6e20 746f 2068 616e  re a pain to han
-00007b20: 646c 6520 636f 7272 6563 746c 7920 6265  dle correctly be
-00007b30: 6361 7573 6520 6f66 0a20 2020 2023 2072  cause of.    # r
-00007b40: 6f75 6e64 696e 6720 6973 7375 6573 2061  ounding issues a
-00007b50: 7420 7468 6520 626f 7264 6572 7320 6f66  t the borders of
-00007b60: 2074 696c 6573 2e2e 2e20 736f 206a 7573   tiles... so jus
-00007b70: 7420 6469 7373 6f6c 7665 2074 6865 6d20  t dissolve them 
-00007b80: 696e 206f 6e65 2067 6f2e 0a20 2020 2069  in one go..    i
-00007b90: 6620 280a 2020 2020 2020 2020 696e 7075  f (.        inpu
-00007ba0: 745f 6c61 7965 7269 6e66 6f2e 6665 6174  t_layerinfo.feat
-00007bb0: 7572 6563 6f75 6e74 203d 3d20 300a 2020  urecount == 0.  
-00007bc0: 2020 2020 2020 6f72 2069 6e70 7574 5f6c        or input_l
-00007bd0: 6179 6572 696e 666f 2e67 656f 6d65 7472  ayerinfo.geometr
-00007be0: 7974 7970 652e 746f 5f70 7269 6d69 7469  ytype.to_primiti
-00007bf0: 7665 7479 7065 0a20 2020 2020 2020 2069  vetype.        i
-00007c00: 6e20 5b0a 2020 2020 2020 2020 2020 2020  n [.            
-00007c10: 5072 696d 6974 6976 6554 7970 652e 504f  PrimitiveType.PO
-00007c20: 494e 542c 0a20 2020 2020 2020 2020 2020  INT,.           
-00007c30: 2050 7269 6d69 7469 7665 5479 7065 2e4c   PrimitiveType.L
-00007c40: 494e 4553 5452 494e 472c 0a20 2020 2020  INESTRING,.     
-00007c50: 2020 205d 0a20 2020 2029 3a0a 2020 2020     ].    ):.    
-00007c60: 2020 2020 5f67 656f 6f70 735f 7371 6c2e      _geoops_sql.
-00007c70: 6469 7373 6f6c 7665 5f73 696e 676c 6574  dissolve_singlet
-00007c80: 6872 6561 6428 0a20 2020 2020 2020 2020  hread(.         
-00007c90: 2020 2069 6e70 7574 5f70 6174 683d 696e     input_path=in
-00007ca0: 7075 745f 7061 7468 2c0a 2020 2020 2020  put_path,.      
-00007cb0: 2020 2020 2020 6f75 7470 7574 5f70 6174        output_pat
-00007cc0: 683d 6f75 7470 7574 5f70 6174 682c 0a20  h=output_path,. 
-00007cd0: 2020 2020 2020 2020 2020 2065 7870 6c6f             explo
-00007ce0: 6465 636f 6c6c 6563 7469 6f6e 733d 6578  decollections=ex
-00007cf0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-00007d00: 2c0a 2020 2020 2020 2020 2020 2020 6772  ,.            gr
-00007d10: 6f75 7062 795f 636f 6c75 6d6e 733d 6772  oupby_columns=gr
-00007d20: 6f75 7062 795f 636f 6c75 6d6e 732c 0a20  oupby_columns,. 
-00007d30: 2020 2020 2020 2020 2020 2061 6767 5f63             agg_c
-00007d40: 6f6c 756d 6e73 3d61 6767 5f63 6f6c 756d  olumns=agg_colum
-00007d50: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00007d60: 696e 7075 745f 6c61 7965 723d 696e 7075  input_layer=inpu
-00007d70: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
-00007d80: 2020 2020 206f 7574 7075 745f 6c61 7965       output_laye
-00007d90: 723d 6f75 7470 7574 5f6c 6179 6572 2c0a  r=output_layer,.
-00007da0: 2020 2020 2020 2020 2020 2020 6772 6964              grid
-00007db0: 7369 7a65 3d67 7269 6473 697a 652c 0a20  size=gridsize,. 
-00007dc0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-00007dd0: 3d66 6f72 6365 2c0a 2020 2020 2020 2020  =force,.        
-00007de0: 290a 0a20 2020 2065 6c69 6620 696e 7075  )..    elif inpu
-00007df0: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
-00007e00: 6574 7279 7479 7065 2e74 6f5f 7072 696d  etrytype.to_prim
-00007e10: 6974 6976 6574 7970 6520 6973 2050 7269  itivetype is Pri
-00007e20: 6d69 7469 7665 5479 7065 2e50 4f4c 5947  mitiveType.POLYG
-00007e30: 4f4e 3a0a 2020 2020 2020 2020 2320 4966  ON:.        # If
-00007e40: 2061 2074 696c 6573 5f70 6174 6820 6973   a tiles_path is
-00007e50: 2073 7065 6369 6669 6564 2c20 7265 6164   specified, read
-00007e60: 2074 686f 7365 2074 696c 6573 2e2e 2e0a   those tiles....
-00007e70: 2020 2020 2020 2020 7265 7375 6c74 5f74          result_t
-00007e80: 696c 6573 5f67 6466 203d 204e 6f6e 650a  iles_gdf = None.
-00007e90: 2020 2020 2020 2020 6966 2074 696c 6573          if tiles
-00007ea0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
-00007eb0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00007ec0: 6573 756c 745f 7469 6c65 735f 6764 6620  esult_tiles_gdf 
-00007ed0: 3d20 6766 6f2e 7265 6164 5f66 696c 6528  = gfo.read_file(
-00007ee0: 7469 6c65 735f 7061 7468 290a 2020 2020  tiles_path).    
-00007ef0: 2020 2020 2020 2020 6966 206e 625f 7061          if nb_pa
-00007f00: 7261 6c6c 656c 203d 3d20 2d31 3a0a 2020  rallel == -1:.  
-00007f10: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-00007f20: 5f63 7075 203d 206d 756c 7469 7072 6f63  _cpu = multiproc
-00007f30: 6573 7369 6e67 2e63 7075 5f63 6f75 6e74  essing.cpu_count
-00007f40: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00007f50: 2020 206e 625f 7061 7261 6c6c 656c 203d     nb_parallel =
-00007f60: 206e 625f 6370 7520 2023 2069 6e74 2831   nb_cpu  # int(1
-00007f70: 2e32 3520 2a20 6e62 5f63 7075 290a 2020  .25 * nb_cpu).  
-00007f80: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00007f90: 6767 6572 2e64 6562 7567 2866 224e 6220  gger.debug(f"Nb 
-00007fa0: 6370 7573 2066 6f75 6e64 3a20 7b6e 625f  cpus found: {nb_
-00007fb0: 6370 757d 2c20 6e62 5f70 6172 616c 6c65  cpu}, nb_paralle
-00007fc0: 6c3a 207b 6e62 5f70 6172 616c 6c65 6c7d  l: {nb_parallel}
-00007fd0: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-00007fe0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00007ff0: 6c73 652c 2063 7265 6174 6520 6120 6772  lse, create a gr
-00008000: 6964 2062 6173 6564 206f 6e20 7468 6520  id based on the 
-00008010: 6e75 6d62 6572 206f 6620 7469 6c65 7320  number of tiles 
-00008020: 7761 6e74 6564 2061 7320 7265 7375 6c74  wanted as result
-00008030: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00008040: 756c 745f 7469 6c65 735f 6764 6620 3d20  ult_tiles_gdf = 
-00008050: 6772 6964 5f75 7469 6c2e 6372 6561 7465  grid_util.create
-00008060: 5f67 7269 6432 280a 2020 2020 2020 2020  _grid2(.        
-00008070: 2020 2020 2020 2020 696e 7075 745f 6c61          input_la
-00008080: 7965 7269 6e66 6f2e 746f 7461 6c5f 626f  yerinfo.total_bo
-00008090: 756e 6473 2c20 6e62 5f73 7175 6172 6973  unds, nb_squaris
-000080a0: 685f 7469 6c65 732c 2069 6e70 7574 5f6c  h_tiles, input_l
-000080b0: 6179 6572 696e 666f 2e63 7273 0a20 2020  ayerinfo.crs.   
-000080c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000080d0: 2020 2020 2020 2069 6620 6c65 6e28 7265         if len(re
-000080e0: 7375 6c74 5f74 696c 6573 5f67 6466 2920  sult_tiles_gdf) 
-000080f0: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00008100: 2020 2020 2067 666f 2e74 6f5f 6669 6c65       gfo.to_file
-00008110: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008120: 2020 2020 2020 7265 7375 6c74 5f74 696c        result_til
-00008130: 6573 5f67 6466 2c0a 2020 2020 2020 2020  es_gdf,.        
-00008140: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-00008150: 7574 5f70 6174 682e 7061 7265 6e74 202f  ut_path.parent /
-00008160: 2066 227b 6f75 7470 7574 5f70 6174 682e   f"{output_path.
-00008170: 7374 656d 7d5f 7469 6c65 732e 6770 6b67  stem}_tiles.gpkg
-00008180: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00008190: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-000081a0: 4966 2061 2074 696c 6564 2072 6573 756c  If a tiled resul
-000081b0: 7420 6973 2061 736b 6564 2c20 6164 6420  t is asked, add 
-000081c0: 7469 6c65 5f69 6420 746f 2067 726f 7570  tile_id to group
-000081d0: 206f 6e20 666f 7220 7468 6520 7265 7375   on for the resu
-000081e0: 6c74 0a20 2020 2020 2020 2069 6620 6c65  lt.        if le
-000081f0: 6e28 7265 7375 6c74 5f74 696c 6573 5f67  n(result_tiles_g
-00008200: 6466 2920 3e20 313a 0a20 2020 2020 2020  df) > 1:.       
-00008210: 2020 2020 2072 6573 756c 745f 7469 6c65       result_tile
-00008220: 735f 6764 665b 2274 696c 655f 6964 225d  s_gdf["tile_id"]
-00008230: 203d 2072 6573 756c 745f 7469 6c65 735f   = result_tiles_
-00008240: 6764 662e 7265 7365 745f 696e 6465 7828  gdf.reset_index(
-00008250: 292e 696e 6465 780a 0a20 2020 2020 2020  ).index..       
-00008260: 2023 2054 6865 2064 6973 736f 6c76 6520   # The dissolve 
-00008270: 666f 7220 706f 6c79 676f 6e73 2069 7320  for polygons is 
-00008280: 646f 6e65 2069 6e20 7365 7665 7261 6c20  done in several 
-00008290: 7061 7373 6573 2c20 616e 6420 6166 7465  passes, and afte
-000082a0: 7220 7468 6520 6669 7273 740a 2020 2020  r the first.    
-000082b0: 2020 2020 2320 7061 7373 2c20 6f6e 6c79      # pass, only
-000082c0: 2074 6865 2027 6f6e 626f 7264 6572 2720   the 'onborder' 
-000082d0: 6665 6174 7572 6573 2061 7265 2066 7572  features are fur
-000082e0: 7468 6572 2064 6973 736f 6c76 6564 2c20  ther dissolved, 
-000082f0: 6173 2074 6865 0a20 2020 2020 2020 2023  as the.        #
-00008300: 2027 6e6f 746f 6e62 6f72 6465 7227 2066   'notonborder' f
-00008310: 6561 7475 7265 7320 6172 6520 616c 7265  eatures are alre
-00008320: 6164 7920 4f4b 2e0a 2020 2020 2020 2020  ady OK..        
-00008330: 7465 6d70 6469 7220 3d20 5f69 6f5f 7574  tempdir = _io_ut
-00008340: 696c 2e63 7265 6174 655f 7465 6d70 6469  il.create_tempdi
-00008350: 7228 6622 6765 6f66 696c 656f 7073 2f7b  r(f"geofileops/{
-00008360: 6f70 6572 6174 696f 6e7d 2229 0a20 2020  operation}").   
-00008370: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00008380: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
-00008390: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
-000083a0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000083b0: 7574 7075 745f 6c61 7965 7220 3d20 6766  utput_layer = gf
-000083c0: 6f2e 6765 745f 6465 6661 756c 745f 6c61  o.get_default_la
-000083d0: 7965 7228 6f75 7470 7574 5f70 6174 6829  yer(output_path)
-000083e0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-000083f0: 7075 745f 746d 705f 7061 7468 203d 2074  put_tmp_path = t
-00008400: 656d 7064 6972 202f 2066 227b 6f75 7470  empdir / f"{outp
-00008410: 7574 5f70 6174 682e 7374 656d 7d2e 6770  ut_path.stem}.gp
-00008420: 6b67 220a 2020 2020 2020 2020 2020 2020  kg".            
-00008430: 7072 6576 5f6e 625f 6261 7463 6865 7320  prev_nb_batches 
-00008440: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00008450: 2020 206c 6173 745f 7061 7373 203d 2046     last_pass = F
-00008460: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00008470: 2070 6173 735f 6964 203d 2030 0a20 2020   pass_id = 0.   
-00008480: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00008490: 696e 666f 2866 2253 7461 7274 2064 6973  info(f"Start dis
-000084a0: 736f 6c76 6520 6f6e 2066 696c 6520 7b69  solve on file {i
-000084b0: 6e70 7574 5f70 6174 687d 2229 0a20 2020  nput_path}").   
-000084c0: 2020 2020 2020 2020 2077 6869 6c65 2054           while T
-000084d0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-000084e0: 2020 2020 2023 2047 6574 2069 6e66 6f20       # Get info 
-000084f0: 6f66 2074 6865 2063 7572 7265 6e74 2066  of the current f
-00008500: 696c 6520 7468 6174 206e 6565 6473 2074  ile that needs t
-00008510: 6f20 6265 2064 6973 736f 6c76 6564 0a20  o be dissolved. 
-00008520: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00008530: 6173 735f 696e 7075 745f 6c61 7965 7269  ass_input_layeri
-00008540: 6e66 6f20 3d20 6766 6f2e 6765 745f 6c61  nfo = gfo.get_la
-00008550: 7965 7269 6e66 6f28 696e 7075 745f 7061  yerinfo(input_pa
-00008560: 7468 2c20 696e 7075 745f 6c61 7965 7229  th, input_layer)
-00008570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008580: 206e 625f 726f 7773 5f74 6f74 616c 203d   nb_rows_total =
-00008590: 2070 6173 735f 696e 7075 745f 6c61 7965   pass_input_laye
-000085a0: 7269 6e66 6f2e 6665 6174 7572 6563 6f75  rinfo.featurecou
-000085b0: 6e74 0a0a 2020 2020 2020 2020 2020 2020  nt..            
-000085c0: 2020 2020 2320 4361 6c63 756c 6174 6520      # Calculate 
-000085d0: 7468 6520 6265 7374 206e 756d 6265 7220  the best number 
-000085e0: 6f66 2070 6172 616c 6c65 6c20 7072 6f63  of parallel proc
-000085f0: 6573 7365 7320 616e 6420 6261 7463 6865  esses and batche
-00008600: 7320 666f 720a 2020 2020 2020 2020 2020  s for.          
-00008610: 2020 2020 2020 2320 7468 6520 6176 6169        # the avai
-00008620: 6c61 626c 6520 7265 736f 7572 6365 7320  lable resources 
-00008630: 666f 7220 7468 6520 6375 7272 656e 7420  for the current 
-00008640: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00008650: 2020 2020 2069 6620 6261 7463 6873 697a       if batchsiz
-00008660: 6520 3e20 303a 0a20 2020 2020 2020 2020  e > 0:.         
-00008670: 2020 2020 2020 2020 2020 2070 6172 616c             paral
-00008680: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-00008690: 6720 3d20 5061 7261 6c6c 656c 697a 6174  g = Parallelizat
-000086a0: 696f 6e43 6f6e 6669 6728 0a20 2020 2020  ionConfig(.     
-000086b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086c0: 2020 206d 696e 5f61 7667 5f72 6f77 735f     min_avg_rows_
-000086d0: 7065 725f 6261 7463 683d 696e 7428 6d61  per_batch=int(ma
-000086e0: 7468 2e63 6569 6c28 6261 7463 6873 697a  th.ceil(batchsiz
-000086f0: 6520 2f20 3229 292c 0a20 2020 2020 2020  e / 2)),.       
-00008700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008710: 206d 6178 5f61 7667 5f72 6f77 735f 7065   max_avg_rows_pe
-00008720: 725f 6261 7463 683d 6261 7463 6873 697a  r_batch=batchsiz
-00008730: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00008740: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008750: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00008760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008770: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
-00008780: 6f6e 5f63 6f6e 6669 6720 3d20 5061 7261  on_config = Para
-00008790: 6c6c 656c 697a 6174 696f 6e43 6f6e 6669  llelizationConfi
-000087a0: 6728 290a 2020 2020 2020 2020 2020 2020  g().            
-000087b0: 2020 2020 6e62 5f70 6172 616c 6c65 6c2c      nb_parallel,
-000087c0: 206e 625f 6261 7463 6865 735f 7265 636f   nb_batches_reco
-000087d0: 6d6d 656e 6465 642c 205f 203d 2067 6574  mmended, _ = get
-000087e0: 5f70 6172 616c 6c65 6c69 7a61 7469 6f6e  _parallelization
-000087f0: 5f70 6172 616d 7328 0a20 2020 2020 2020  _params(.       
-00008800: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
-00008810: 726f 7773 5f74 6f74 616c 3d6e 625f 726f  rows_total=nb_ro
-00008820: 7773 5f74 6f74 616c 2c0a 2020 2020 2020  ws_total,.      
-00008830: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-00008840: 5f70 6172 616c 6c65 6c3d 6e62 5f70 6172  _parallel=nb_par
-00008850: 616c 6c65 6c2c 0a20 2020 2020 2020 2020  allel,.         
-00008860: 2020 2020 2020 2020 2020 206e 625f 6261             nb_ba
-00008870: 7463 6865 735f 7072 6576 696f 7573 5f70  tches_previous_p
-00008880: 6173 733d 7072 6576 5f6e 625f 6261 7463  ass=prev_nb_batc
-00008890: 6865 732c 0a20 2020 2020 2020 2020 2020  hes,.           
-000088a0: 2020 2020 2020 2020 2070 6172 616c 6c65           paralle
-000088b0: 6c69 7a61 7469 6f6e 5f63 6f6e 6669 673d  lization_config=
-000088c0: 7061 7261 6c6c 656c 697a 6174 696f 6e5f  parallelization_
-000088d0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-000088e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000088f0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00008900: 7468 6520 6964 6561 6c20 6e75 6d62 6572  the ideal number
-00008910: 206f 6620 6261 7463 6865 7320 6973 2063   of batches is c
-00008920: 6c6f 7365 2074 6f20 7468 6520 6e62 2e20  lose to the nb. 
-00008930: 7265 7375 6c74 2074 696c 6573 2061 736b  result tiles ask
-00008940: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-00008950: 2020 2020 2320 6469 7373 6f6c 7665 2074      # dissolve t
-00008960: 6f77 6172 6473 2074 6865 2061 736b 6564  owards the asked
-00008970: 2072 6573 756c 7421 0a20 2020 2020 2020   result!.       
-00008980: 2020 2020 2020 2020 2023 2049 6620 6e6f           # If no
-00008990: 742c 2061 2074 656d 706f 7261 7279 2072  t, a temporary r
-000089a0: 6573 756c 7420 6973 2063 7265 6174 6564  esult is created
-000089b0: 2075 7369 6e67 2073 6d61 6c6c 6572 2074   using smaller t
-000089c0: 696c 6573 0a20 2020 2020 2020 2020 2020  iles.           
-000089d0: 2020 2020 2069 6620 6e62 5f62 6174 6368       if nb_batch
-000089e0: 6573 5f72 6563 6f6d 6d65 6e64 6564 203c  es_recommended <
-000089f0: 3d20 6c65 6e28 7265 7375 6c74 5f74 696c  = len(result_til
-00008a00: 6573 5f67 6466 2920 2a20 312e 313a 0a20  es_gdf) * 1.1:. 
-00008a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a20: 2020 2074 696c 6573 5f67 6466 203d 2072     tiles_gdf = r
-00008a30: 6573 756c 745f 7469 6c65 735f 6764 660a  esult_tiles_gdf.
-00008a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a50: 2020 2020 6c61 7374 5f70 6173 7320 3d20      last_pass = 
-00008a60: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00008a70: 2020 2020 2020 2020 206e 625f 7061 7261           nb_para
-00008a80: 6c6c 656c 203d 206d 696e 286c 656e 2872  llel = min(len(r
-00008a90: 6573 756c 745f 7469 6c65 735f 6764 6629  esult_tiles_gdf)
-00008aa0: 2c20 6e62 5f70 6172 616c 6c65 6c29 0a20  , nb_parallel). 
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00008ac0: 6c69 6620 6c65 6e28 7265 7375 6c74 5f74  lif len(result_t
-00008ad0: 696c 6573 5f67 6466 2920 3d3d 2031 3a0a  iles_gdf) == 1:.
-00008ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008af0: 2020 2020 2320 4372 6561 7465 2061 2067      # Create a g
-00008b00: 7269 6420 6261 7365 6420 6f6e 2074 6865  rid based on the
-00008b10: 2069 6465 616c 206e 756d 6265 7220 6f66   ideal number of
-00008b20: 2062 6174 6368 6573 2c20 6275 7420 6d61   batches, but ma
-00008b30: 6b65 0a20 2020 2020 2020 2020 2020 2020  ke.             
-00008b40: 2020 2020 2020 2023 2073 7572 6520 7468         # sure th
-00008b50: 6520 6e75 6d62 6572 2069 7320 736d 616c  e number is smal
-00008b60: 6c65 7220 7468 616e 2074 6865 206d 6178  ler than the max
-00008b70: 696d 756d 2e2e 2e0a 2020 2020 2020 2020  imum....        
-00008b80: 2020 2020 2020 2020 2020 2020 6e62 5f73              nb_s
-00008b90: 7175 6172 6973 685f 7469 6c65 735f 6d61  quarish_tiles_ma
-00008ba0: 7820 3d20 4e6f 6e65 0a20 2020 2020 2020  x = None.       
-00008bb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008bc0: 7072 6576 5f6e 625f 6261 7463 6865 7320  prev_nb_batches 
-00008bd0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bf0: 2020 2020 206e 625f 7371 7561 7269 7368       nb_squarish
-00008c00: 5f74 696c 6573 5f6d 6178 203d 206d 6178  _tiles_max = max
-00008c10: 2870 7265 765f 6e62 5f62 6174 6368 6573  (prev_nb_batches
-00008c20: 202d 2031 2c20 3129 0a20 2020 2020 2020   - 1, 1).       
-00008c30: 2020 2020 2020 2020 2020 2020 2074 696c               til
-00008c40: 6573 5f67 6466 203d 2067 7269 645f 7574  es_gdf = grid_ut
-00008c50: 696c 2e63 7265 6174 655f 6772 6964 3228  il.create_grid2(
-00008c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008c70: 2020 2020 2020 2020 2074 6f74 616c 5f62           total_b
-00008c80: 6f75 6e64 733d 7061 7373 5f69 6e70 7574  ounds=pass_input
-00008c90: 5f6c 6179 6572 696e 666f 2e74 6f74 616c  _layerinfo.total
-00008ca0: 5f62 6f75 6e64 732c 0a20 2020 2020 2020  _bounds,.       
-00008cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008cc0: 206e 625f 7371 7561 7269 7368 5f74 696c   nb_squarish_til
-00008cd0: 6573 3d6e 625f 6261 7463 6865 735f 7265  es=nb_batches_re
-00008ce0: 636f 6d6d 656e 6465 642c 0a20 2020 2020  commended,.     
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d00: 2020 206e 625f 7371 7561 7269 7368 5f74     nb_squarish_t
-00008d10: 696c 6573 5f6d 6178 3d6e 625f 7371 7561  iles_max=nb_squa
-00008d20: 7269 7368 5f74 696c 6573 5f6d 6178 2c0a  rish_tiles_max,.
-00008d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d40: 2020 2020 2020 2020 6372 733d 7061 7373          crs=pass
-00008d50: 5f69 6e70 7574 5f6c 6179 6572 696e 666f  _input_layerinfo
-00008d60: 2e63 7273 2c0a 2020 2020 2020 2020 2020  .crs,.          
-00008d70: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00008d80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00008d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008da0: 2020 2020 2020 2320 4966 2061 2067 7269        # If a gri
-00008db0: 6420 6973 2073 7065 6369 6669 6564 2061  d is specified a
-00008dc0: 6c72 6561 6479 2c20 6164 6420 6578 7472  lready, add extr
-00008dd0: 6120 636f 6c75 6d6e 732f 726f 7773 2069  a columns/rows i
-00008de0: 6e73 7465 6164 206f 660a 2020 2020 2020  nstead of.      
-00008df0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00008e00: 6372 6561 7469 6e67 206e 6577 206f 6e65  creating new one
-00008e10: 2e2e 2e0a 2020 2020 2020 2020 2020 2020  ....            
-00008e20: 2020 2020 2020 2020 7469 6c65 735f 6764          tiles_gd
-00008e30: 6620 3d20 6772 6964 5f75 7469 6c2e 7370  f = grid_util.sp
-00008e40: 6c69 745f 7469 6c65 7328 0a20 2020 2020  lit_tiles(.     
-00008e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e60: 2020 2072 6573 756c 745f 7469 6c65 735f     result_tiles_
-00008e70: 6764 662c 206e 625f 6261 7463 6865 735f  gdf, nb_batches_
-00008e80: 7265 636f 6d6d 656e 6465 640a 2020 2020  recommended.    
-00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008eb0: 2020 6766 6f2e 746f 5f66 696c 6528 0a20    gfo.to_file(. 
-00008ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ed0: 2020 2074 696c 6573 5f67 6466 2c20 7465     tiles_gdf, te
-00008ee0: 6d70 6469 7220 2f20 6622 7b6f 7574 7075  mpdir / f"{outpu
-00008ef0: 745f 7061 7468 2e73 7465 6d7d 5f7b 7061  t_path.stem}_{pa
-00008f00: 7373 5f69 647d 5f74 696c 6573 2e67 706b  ss_id}_tiles.gpk
-00008f10: 6722 0a20 2020 2020 2020 2020 2020 2020  g".             
-00008f20: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00008f30: 2020 2020 2020 2320 4966 2074 6865 206e        # If the n
-00008f40: 756d 6265 7220 6f66 2074 696c 6573 2065  umber of tiles e
-00008f50: 6e64 7320 7570 2061 7320 312c 2069 7420  nds up as 1, it 
-00008f60: 6973 2074 6865 206c 6173 7420 7061 7373  is the last pass
-00008f70: 2061 6e79 7761 792e 2e2e 0a20 2020 2020   anyway....     
-00008f80: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00008f90: 6e28 7469 6c65 735f 6764 6629 203d 3d20  n(tiles_gdf) == 
-00008fa0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00008fb0: 2020 2020 2020 206c 6173 745f 7061 7373         last_pass
-00008fc0: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-00008fd0: 2020 2020 2020 2020 2023 2049 6620 7765           # If we
-00008fe0: 2061 7265 206e 6f74 2069 6e20 7468 6520   are not in the 
-00008ff0: 6c61 7374 2070 6173 732c 206f 6e62 6f72  last pass, onbor
-00009000: 6465 7220 7061 7263 656c 7320 7769 6c6c  der parcels will
-00009010: 206e 6565 6420 6578 7472 610a 2020 2020   need extra.    
-00009020: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00009030: 6f63 6573 7369 6e67 2073 7469 6c6c 2069  ocessing still i
-00009040: 6e20 6675 7274 6865 7220 7061 7373 6573  n further passes
-00009050: 2c20 736f 2061 7265 2073 6176 6564 2069  , so are saved i
-00009060: 6e20 6120 7365 7065 7261 7465 0a20 2020  n a seperate.   
-00009070: 2020 2020 2020 2020 2020 2020 2023 2067               # g
-00009080: 666f 2e20 5468 6520 6e6f 746f 6e62 6f72  fo. The notonbor
-00009090: 6465 7220 726f 7773 2061 7265 2066 696e  der rows are fin
-000090a0: 616c 2069 6d6d 6564 6961 7465 6c79 0a20  al immediately. 
-000090b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000090c0: 6620 6c61 7374 5f70 6173 7320 6973 206e  f last_pass is n
-000090d0: 6f74 2054 7275 653a 0a20 2020 2020 2020  ot True:.       
-000090e0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-000090f0: 7075 745f 746d 705f 6f6e 626f 7264 6572  put_tmp_onborder
-00009100: 5f70 6174 6820 3d20 280a 2020 2020 2020  _path = (.      
-00009110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009120: 2020 7465 6d70 6469 7220 2f20 6622 7b6f    tempdir / f"{o
-00009130: 7574 7075 745f 7061 7468 2e73 7465 6d7d  utput_path.stem}
-00009140: 5f7b 7061 7373 5f69 647d 5f6f 6e62 6f72  _{pass_id}_onbor
-00009150: 6465 722e 6770 6b67 220a 2020 2020 2020  der.gpkg".      
-00009160: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00009170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009180: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009190: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-000091a0: 5f74 6d70 5f6f 6e62 6f72 6465 725f 7061  _tmp_onborder_pa
-000091b0: 7468 203d 206f 7574 7075 745f 746d 705f  th = output_tmp_
-000091c0: 7061 7468 0a0a 2020 2020 2020 2020 2020  path..          
-000091d0: 2020 2020 2020 2320 4e6f 7720 676f 210a        # Now go!.
-000091e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091f0: 6c6f 6767 6572 2e69 6e66 6f28 6622 5374  logger.info(f"St
-00009200: 6172 7420 6469 7373 6f6c 7665 2070 6173  art dissolve pas
-00009210: 7320 7b70 6173 735f 6964 7d20 746f 207b  s {pass_id} to {
-00009220: 6c65 6e28 7469 6c65 735f 6764 6629 7d20  len(tiles_gdf)} 
-00009230: 7469 6c65 7322 290a 2020 2020 2020 2020  tiles").        
-00009240: 2020 2020 2020 2020 5f20 3d20 5f64 6973          _ = _dis
-00009250: 736f 6c76 655f 706f 6c79 676f 6e73 5f70  solve_polygons_p
-00009260: 6173 7328 0a20 2020 2020 2020 2020 2020  ass(.           
-00009270: 2020 2020 2020 2020 2069 6e70 7574 5f70           input_p
-00009280: 6174 683d 696e 7075 745f 7061 7468 2c0a  ath=input_path,.
-00009290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092a0: 2020 2020 6f75 7470 7574 5f6e 6f74 6f6e      output_noton
-000092b0: 626f 7264 6572 5f70 6174 683d 6f75 7470  border_path=outp
-000092c0: 7574 5f74 6d70 5f70 6174 682c 0a20 2020  ut_tmp_path,.   
-000092d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092e0: 206f 7574 7075 745f 6f6e 626f 7264 6572   output_onborder
-000092f0: 5f70 6174 683d 6f75 7470 7574 5f74 6d70  _path=output_tmp
-00009300: 5f6f 6e62 6f72 6465 725f 7061 7468 2c0a  _onborder_path,.
-00009310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009320: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-00009330: 6374 696f 6e73 3d65 7870 6c6f 6465 636f  ctions=explodeco
-00009340: 6c6c 6563 7469 6f6e 732c 0a20 2020 2020  llections,.     
-00009350: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00009360: 726f 7570 6279 5f63 6f6c 756d 6e73 3d67  roupby_columns=g
-00009370: 726f 7570 6279 5f63 6f6c 756d 6e73 2c0a  roupby_columns,.
-00009380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009390: 2020 2020 6167 675f 636f 6c75 6d6e 733d      agg_columns=
-000093a0: 6167 675f 636f 6c75 6d6e 732c 0a20 2020  agg_columns,.   
-000093b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093c0: 2074 696c 6573 5f67 6466 3d74 696c 6573   tiles_gdf=tiles
-000093d0: 5f67 6466 2c0a 2020 2020 2020 2020 2020  _gdf,.          
-000093e0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-000093f0: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
-00009400: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00009410: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
-00009420: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
-00009430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009440: 2020 2020 2020 6772 6964 7369 7a65 3d67        gridsize=g
-00009450: 7269 6473 697a 652c 0a20 2020 2020 2020  ridsize,.       
-00009460: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
-00009470: 7061 7261 6c6c 656c 3d6e 625f 7061 7261  parallel=nb_para
-00009480: 6c6c 656c 2c0a 2020 2020 2020 2020 2020  llel,.          
-00009490: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000094a0: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
-000094b0: 7265 2074 6865 206e 6578 7420 7061 7373  re the next pass
-000094c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000094d0: 2023 2054 6865 2069 6e70 7574 2070 6174   # The input pat
-000094e0: 6820 6973 2074 6865 206f 6e62 6f72 6465  h is the onborde
-000094f0: 7220 6669 6c65 0a20 2020 2020 2020 2020  r file.         
-00009500: 2020 2020 2020 2070 7265 765f 6e62 5f62         prev_nb_b
-00009510: 6174 6368 6573 203d 206c 656e 2874 696c  atches = len(til
-00009520: 6573 5f67 6466 290a 2020 2020 2020 2020  es_gdf).        
-00009530: 2020 2020 2020 2020 696e 7075 745f 7061          input_pa
-00009540: 7468 203d 206f 7574 7075 745f 746d 705f  th = output_tmp_
-00009550: 6f6e 626f 7264 6572 5f70 6174 680a 2020  onborder_path.  
-00009560: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00009570: 7373 5f69 6420 2b3d 2031 0a0a 2020 2020  ss_id += 1..    
-00009580: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00009590: 2077 6520 6172 6520 7265 6164 792e 2e2e   we are ready...
-000095a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000095b0: 2069 6620 6c61 7374 5f70 6173 7320 6973   if last_pass is
-000095c0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-000095d0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-000095e0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000095f0: 4361 6c63 756c 6174 696f 6e20 7265 6164  Calculation read
-00009600: 7921 204e 6f77 2066 696e 616c 6973 6520  y! Now finalise 
-00009610: 6f75 7470 7574 210a 2020 2020 2020 2020  output!.        
-00009620: 2020 2020 2320 4966 2074 6865 7265 2069      # If there i
-00009630: 7320 6120 7265 7375 6c74 206f 6e20 626f  s a result on bo
-00009640: 7264 6572 2c20 6170 7065 6e64 2069 7420  rder, append it 
-00009650: 746f 2074 6865 2072 6573 740a 2020 2020  to the rest.    
-00009660: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
-00009670: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00009680: 286f 7574 7075 745f 746d 705f 6f6e 626f  (output_tmp_onbo
-00009690: 7264 6572 5f70 6174 6829 2021 3d20 7374  rder_path) != st
-000096a0: 7228 6f75 7470 7574 5f74 6d70 5f70 6174  r(output_tmp_pat
-000096b0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-000096c0: 2020 2061 6e64 206f 7574 7075 745f 746d     and output_tm
-000096d0: 705f 6f6e 626f 7264 6572 5f70 6174 682e  p_onborder_path.
-000096e0: 6578 6973 7473 2829 0a20 2020 2020 2020  exists().       
-000096f0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00009700: 2020 2020 2020 2020 6766 6f2e 6170 7065          gfo.appe
-00009710: 6e64 5f74 6f28 0a20 2020 2020 2020 2020  nd_to(.         
-00009720: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00009730: 745f 746d 705f 6f6e 626f 7264 6572 5f70  t_tmp_onborder_p
-00009740: 6174 682c 206f 7574 7075 745f 746d 705f  ath, output_tmp_
-00009750: 7061 7468 2c20 6473 745f 6c61 7965 723d  path, dst_layer=
-00009760: 6f75 7470 7574 5f6c 6179 6572 0a20 2020  output_layer.   
-00009770: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00009780: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00009790: 2074 6865 7265 2069 7320 6120 7265 7375   there is a resu
-000097a0: 6c74 2e2e 2e0a 2020 2020 2020 2020 2020  lt....          
-000097b0: 2020 6966 206f 7574 7075 745f 746d 705f    if output_tmp_
-000097c0: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
-000097d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000097e0: 2049 6620 7469 6c65 6420 6f75 7470 7574   If tiled output
-000097f0: 2061 736b 6564 2c20 6164 6420 2274 696c   asked, add "til
-00009800: 655f 6964 2220 746f 2067 726f 7570 6279  e_id" to groupby
-00009810: 5f63 6f6c 756d 6e73 0a20 2020 2020 2020  _columns.       
-00009820: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00009830: 7265 7375 6c74 5f74 696c 6573 5f67 6466  result_tiles_gdf
-00009840: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-00009850: 2020 2020 2020 2020 2020 2069 6620 6772             if gr
-00009860: 6f75 7062 795f 636f 6c75 6d6e 7320 6973  oupby_columns is
-00009870: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00009880: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00009890: 726f 7570 6279 5f63 6f6c 756d 6e73 203d  roupby_columns =
-000098a0: 205b 2274 696c 655f 6964 225d 0a20 2020   ["tile_id"].   
-000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000098d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000098e0: 726f 7570 6279 5f63 6f6c 756d 6e73 203d  roupby_columns =
-000098f0: 206c 6973 7428 6772 6f75 7062 795f 636f   list(groupby_co
-00009900: 6c75 6d6e 7329 2e63 6f70 7928 290a 2020  lumns).copy().  
-00009910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009920: 2020 2020 2020 6772 6f75 7062 795f 636f        groupby_co
-00009930: 6c75 6d6e 732e 6170 7065 6e64 2822 7469  lumns.append("ti
-00009940: 6c65 5f69 6422 290a 0a20 2020 2020 2020  le_id")..       
-00009950: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
-00009960: 7265 2073 7472 696e 6773 2074 6f20 7573  re strings to us
-00009970: 6520 696e 2073 656c 6563 7420 6261 7365  e in select base
-00009980: 6420 6f6e 2067 726f 7570 6279 5f63 6f6c  d on groupby_col
-00009990: 756d 6e73 0a20 2020 2020 2020 2020 2020  umns.           
-000099a0: 2020 2020 2069 6620 6772 6f75 7062 795f       if groupby_
-000099b0: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
-000099c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000099d0: 2020 2020 2020 2020 2067 726f 7570 6279           groupby
-000099e0: 5f70 7265 6669 7865 645f 6c69 7374 203d  _prefixed_list =
-000099f0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00009a00: 2020 2020 2020 2020 2020 2066 277b 7b70             f'{{p
-00009a10: 7265 6669 787d 7d22 7b63 6f6c 756d 6e7d  refix}}"{column}
-00009a20: 2227 2066 6f72 2063 6f6c 756d 6e20 696e  "' for column in
-00009a30: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
-00009a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009a50: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00009a60: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00009a70: 6279 5f73 656c 6563 745f 7072 6566 6978  by_select_prefix
-00009a80: 6564 5f73 7472 203d 2028 0a20 2020 2020  ed_str = (.     
-00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009aa0: 2020 2066 222c 207b 272c 2027 2e6a 6f69     f", {', '.joi
-00009ab0: 6e28 6772 6f75 7062 795f 7072 6566 6978  n(groupby_prefix
-00009ac0: 6564 5f6c 6973 7429 7d22 0a20 2020 2020  ed_list)}".     
-00009ad0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00009ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009af0: 2020 2020 2067 726f 7570 6279 5f67 726f       groupby_gro
-00009b00: 7570 6279 5f70 7265 6669 7865 645f 7374  upby_prefixed_st
-00009b10: 7220 3d20 280a 2020 2020 2020 2020 2020  r = (.          
-00009b20: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00009b30: 4752 4f55 5020 4259 207b 272c 2027 2e6a  GROUP BY {', '.j
-00009b40: 6f69 6e28 6772 6f75 7062 795f 7072 6566  oin(groupby_pref
-00009b50: 6978 6564 5f6c 6973 7429 7d22 0a20 2020  ixed_list)}".   
-00009b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b70: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00009b80: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
-00009b90: 6669 6c74 6572 5f6c 6973 7420 3d20 5b0a  filter_list = [.
-00009ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bb0: 2020 2020 2020 2020 6627 2041 4e44 2067          f' AND g
-00009bc0: 656f 5f64 6174 612e 227b 636f 6c75 6d6e  eo_data."{column
-00009bd0: 7d22 203d 206a 736f 6e5f 6461 7461 2e22  }" = json_data."
-00009be0: 7b63 6f6c 756d 6e7d 2227 0a20 2020 2020  {column}"'.     
-00009bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c00: 2020 2066 6f72 2063 6f6c 756d 6e20 696e     for column in
-00009c10: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
-00009c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009c30: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00009c40: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00009c50: 6279 5f66 696c 7465 725f 7374 7220 3d20  by_filter_str = 
-00009c60: 2220 222e 6a6f 696e 2867 726f 7570 6279  " ".join(groupby
-00009c70: 5f66 696c 7465 725f 6c69 7374 290a 2020  _filter_list).  
-00009c80: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00009c90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009ca0: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
-00009cb0: 7365 6c65 6374 5f70 7265 6669 7865 645f  select_prefixed_
-00009cc0: 7374 7220 3d20 2222 0a20 2020 2020 2020  str = "".       
-00009cd0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00009ce0: 7570 6279 5f67 726f 7570 6279 5f70 7265  upby_groupby_pre
-00009cf0: 6669 7865 645f 7374 7220 3d20 2222 0a20  fixed_str = "". 
-00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d10: 2020 2067 726f 7570 6279 5f66 696c 7465     groupby_filte
-00009d20: 725f 7374 7220 3d20 2222 0a0a 2020 2020  r_str = ""..    
-00009d30: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
-00009d40: 6570 6172 6520 7374 7269 6e67 7320 746f  epare strings to
-00009d50: 2075 7365 2069 6e20 7365 6c65 6374 2062   use in select b
-00009d60: 6173 6564 206f 6e20 6167 675f 636f 6c75  ased on agg_colu
-00009d70: 6d6e 730a 2020 2020 2020 2020 2020 2020  mns.            
-00009d80: 2020 2020 6167 675f 636f 6c75 6d6e 735f      agg_columns_
-00009d90: 7374 7220 3d20 2222 0a20 2020 2020 2020  str = "".       
-00009da0: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
-00009db0: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
-00009dc0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00009dd0: 2020 2020 2020 2020 2069 6620 226a 736f           if "jso
-00009de0: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
-00009df0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00009e00: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00009e10: 2061 6767 7265 6761 7469 6f6e 2069 7320   aggregation is 
-00009e20: 746f 2061 206a 736f 6e20 636f 6c75 6d6e  to a json column
-00009e30: 2c20 736f 2061 6464 0a20 2020 2020 2020  , so add.       
-00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e50: 2061 6767 5f63 6f6c 756d 6e73 5f73 7472   agg_columns_str
-00009e60: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e80: 2020 222c 6a73 6f6e 5f67 726f 7570 5f61    ",json_group_a
-00009e90: 7272 6179 2844 4953 5449 4e43 5420 6a73  rray(DISTINCT js
-00009ea0: 6f6e 5f64 6174 612e 6a73 6f6e 5f72 6f77  on_data.json_row
-00009eb0: 2920 6173 206a 736f 6e22 0a20 2020 2020  ) as json".     
-00009ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ed0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00009ee0: 2020 2020 2020 2020 2065 6c69 6620 2263           elif "c
-00009ef0: 6f6c 756d 6e73 2220 696e 2061 6767 5f63  olumns" in agg_c
-00009f00: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
-00009f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f20: 666f 7220 6167 675f 636f 6c75 6d6e 2069  for agg_column i
-00009f30: 6e20 6167 675f 636f 6c75 6d6e 735b 2263  n agg_columns["c
-00009f40: 6f6c 756d 6e73 225d 3a0a 2020 2020 2020  olumns"]:.      
-00009f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f60: 2020 2020 2020 2320 496e 6974 0a20 2020        # Init.   
-00009f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f80: 2020 2020 2020 2020 2064 6973 7469 6e63           distinc
-00009f90: 745f 7374 7220 3d20 2222 0a20 2020 2020  t_str = "".     
-00009fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fb0: 2020 2020 2020 2065 7874 7261 5f70 6172         extra_par
-00009fc0: 616d 5f73 7472 203d 2022 220a 0a20 2020  am_str = ""..   
-00009fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fe0: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
-00009ff0: 7265 2061 6767 7265 6761 7469 6f6e 206b  re aggregation k
-0000a000: 6579 776f 7264 2e0a 2020 2020 2020 2020  eyword..        
-0000a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a020: 2020 2020 6966 2061 6767 5f63 6f6c 756d      if agg_colum
-0000a030: 6e5b 2261 6767 225d 2e6c 6f77 6572 2829  n["agg"].lower()
-0000a040: 2069 6e20 5b0a 2020 2020 2020 2020 2020   in [.          
+000057a0: 6f70 6572 6174 696f 6e3d 6f70 6572 6174  operation=operat
+000057b0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+000057c0: 2020 2020 2020 2020 206f 7065 7261 7469           operati
+000057d0: 6f6e 5f70 6172 616d 733d 6f70 6572 6174  on_params=operat
+000057e0: 696f 6e5f 7061 7261 6d73 2c0a 2020 2020  ion_params,.    
+000057f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005800: 696e 7075 745f 6c61 7965 723d 696e 7075  input_layer=inpu
+00005810: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
+00005820: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00005830: 756d 6e73 3d63 6f6c 756d 6e73 2c0a 2020  umns=columns,.  
+00005840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005850: 2020 6f75 7470 7574 5f6c 6179 6572 3d6f    output_layer=o
+00005860: 7574 7075 745f 6c61 7965 722c 0a20 2020  utput_layer,.   
+00005870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005880: 2072 6f77 733d 726f 7773 2c0a 2020 2020   rows=rows,.    
+00005890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058a0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+000058b0: 6e73 3d65 7870 6c6f 6465 636f 6c6c 6563  ns=explodecollec
+000058c0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+000058d0: 2020 2020 2020 2020 2020 2067 7269 6473             grids
+000058e0: 697a 653d 6772 6964 7369 7a65 2c0a 2020  ize=gridsize,.  
+000058f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005900: 2020 6b65 6570 5f65 6d70 7479 5f67 656f    keep_empty_geo
+00005910: 6d73 3d6b 6565 705f 656d 7074 795f 6765  ms=keep_empty_ge
+00005920: 6f6d 732c 0a20 2020 2020 2020 2020 2020  oms,.           
+00005930: 2020 2020 2020 2020 2066 6f72 6365 3d66           force=f
+00005940: 6f72 6365 2c0a 2020 2020 2020 2020 2020  orce,.          
+00005950: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00005960: 2020 2020 2020 2020 6675 7475 7265 5f74          future_t
+00005970: 6f5f 6261 7463 685f 6964 5b66 7574 7572  o_batch_id[futur
+00005980: 655d 203d 2062 6174 6368 5f69 640a 2020  e] = batch_id.  
+00005990: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+000059a0: 775f 6f66 6673 6574 202b 3d20 7265 616c  w_offset += real
+000059b0: 5f62 6174 6368 7369 7a65 0a0a 2020 2020  _batchsize..    
+000059c0: 2020 2020 2020 2020 2320 4c6f 6f70 2074          # Loop t
+000059d0: 696c 6c20 616c 6c20 7061 7261 6c6c 656c  ill all parallel
+000059e0: 2070 726f 6365 7373 6573 2061 7265 2072   processes are r
+000059f0: 6561 6479 2c20 6275 7420 7072 6f63 6573  eady, but proces
+00005a00: 7320 6561 6368 206f 6e65 0a20 2020 2020  s each one.     
+00005a10: 2020 2020 2020 2023 2074 6861 7420 6973         # that is
+00005a20: 2072 6561 6479 2061 6c72 6561 6479 0a20   ready already. 
+00005a30: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00005a40: 5f74 696d 6520 3d20 6461 7465 7469 6d65  _time = datetime
+00005a50: 2e6e 6f77 2829 0a20 2020 2020 2020 2020  .now().         
+00005a60: 2020 205f 6765 6e65 7261 6c5f 7574 696c     _general_util
+00005a70: 2e72 6570 6f72 745f 7072 6f67 7265 7373  .report_progress
+00005a80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005a90: 2020 7374 6172 745f 7469 6d65 2c20 6e62    start_time, nb
+00005aa0: 5f64 6f6e 652c 206e 625f 6261 7463 6865  _done, nb_batche
+00005ab0: 732c 206f 7065 7261 7469 6f6e 2e76 616c  s, operation.val
+00005ac0: 7565 2c20 6e62 5f70 6172 616c 6c65 6c0a  ue, nb_parallel.
+00005ad0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00005ae0: 2020 2020 2020 2020 2020 666f 7220 6675            for fu
+00005af0: 7475 7265 2069 6e20 6675 7475 7265 732e  ture in futures.
+00005b00: 6173 5f63 6f6d 706c 6574 6564 2866 7574  as_completed(fut
+00005b10: 7572 655f 746f 5f62 6174 6368 5f69 6429  ure_to_batch_id)
+00005b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005b30: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00005b40: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+00005b50: 6765 203d 2066 7574 7572 652e 7265 7375  ge = future.resu
+00005b60: 6c74 2829 0a20 2020 2020 2020 2020 2020  lt().           
+00005b70: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00005b80: 6465 6275 6728 6d65 7373 6167 6529 0a0a  debug(message)..
+00005b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ba0: 2020 2020 2320 4966 2074 6865 2063 616c      # If the cal
+00005bb0: 6375 6c61 7465 2067 6176 6520 7265 7375  culate gave resu
+00005bc0: 6c74 732c 2063 6f70 7920 746f 206f 7574  lts, copy to out
+00005bd0: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
+00005be0: 2020 2020 2020 2020 6261 7463 685f 6964          batch_id
+00005bf0: 203d 2066 7574 7572 655f 746f 5f62 6174   = future_to_bat
+00005c00: 6368 5f69 645b 6675 7475 7265 5d0a 2020  ch_id[future].  
+00005c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c20: 2020 746d 705f 7061 7274 6961 6c5f 6f75    tmp_partial_ou
+00005c30: 7470 7574 5f70 6174 6820 3d20 6261 7463  tput_path = batc
+00005c40: 6865 735b 6261 7463 685f 6964 5d5b 0a20  hes[batch_id][. 
+00005c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c60: 2020 2020 2020 2022 746d 705f 7061 7274         "tmp_part
+00005c70: 6961 6c5f 6f75 7470 7574 5f70 6174 6822  ial_output_path"
+00005c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005c90: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+00005ca0: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+00005cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005cc0: 2020 2020 2020 2020 746d 705f 7061 7274          tmp_part
+00005cd0: 6961 6c5f 6f75 7470 7574 5f70 6174 682e  ial_output_path.
+00005ce0: 6578 6973 7473 2829 0a20 2020 2020 2020  exists().       
+00005cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d00: 2061 6e64 2074 6d70 5f70 6172 7469 616c   and tmp_partial
+00005d10: 5f6f 7574 7075 745f 7061 7468 2e73 7461  _output_path.sta
+00005d20: 7428 292e 7374 5f73 697a 6520 3e20 300a  t().st_size > 0.
+00005d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d40: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00005d50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00005d60: 2052 656d 6172 6b3a 2062 6563 6175 7365   Remark: because
+00005d70: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+00005d80: 6f6d 6574 7279 7479 7065 2066 6f72 2047  ometrytype for G
+00005d90: 656f 4461 7461 4672 616d 650a 2020 2020  eoDataFrame.    
+00005da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005db0: 2020 2020 2320 6f70 6572 6174 696f 6e73      # operations
+00005dc0: 2069 7320 2861 206c 6f74 2920 6d6f 7265   is (a lot) more
+00005dd0: 206c 696d 6974 6564 2074 6861 6e20 6764   limited than gd
+00005de0: 616c 2d62 6173 6564 2c20 7573 6520 7468  al-based, use th
+00005df0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00005e00: 2020 2020 2020 2020 2020 2320 6764 616c            # gdal
+00005e10: 2076 6572 7369 6f6e 2076 6961 205f 6170   version via _ap
+00005e20: 7065 6e64 5f74 6f5f 6e6f 6c6f 636b 2e0a  pend_to_nolock..
+00005e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e40: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+00005e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e60: 2020 2020 2020 2020 206e 625f 6261 7463           nb_batc
+00005e70: 6865 7320 3d3d 2031 0a20 2020 2020 2020  hes == 1.       
+00005e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e90: 2020 2020 2061 6e64 2066 6f72 6365 5f6f       and force_o
+00005ea0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00005eb0: 7065 2069 7320 4e6f 6e65 0a20 2020 2020  pe is None.     
+00005ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ed0: 2020 2020 2020 2061 6e64 2074 6d70 5f70         and tmp_p
+00005ee0: 6172 7469 616c 5f6f 7574 7075 745f 7061  artial_output_pa
+00005ef0: 7468 2e73 7566 6669 7820 3d3d 2074 6d70  th.suffix == tmp
+00005f00: 5f6f 7574 7075 745f 7061 7468 2e73 7566  _output_path.suf
+00005f10: 6669 780a 2020 2020 2020 2020 2020 2020  fix.            
+00005f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f30: 616e 6420 7768 6572 6520 6973 204e 6f6e  and where is Non
+00005f40: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00005f50: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+00005f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f70: 2020 2020 2020 2020 2067 666f 2e6d 6f76           gfo.mov
+00005f80: 6528 746d 705f 7061 7274 6961 6c5f 6f75  e(tmp_partial_ou
+00005f90: 7470 7574 5f70 6174 682c 2074 6d70 5f6f  tput_path, tmp_o
+00005fa0: 7574 7075 745f 7061 7468 290a 2020 2020  utput_path).    
+00005fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00005fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fe0: 2020 2020 2020 6669 6c65 6f70 732e 5f61        fileops._a
+00005ff0: 7070 656e 645f 746f 5f6e 6f6c 6f63 6b28  ppend_to_nolock(
+00006000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006020: 2073 7263 3d74 6d70 5f70 6172 7469 616c   src=tmp_partial
+00006030: 5f6f 7574 7075 745f 7061 7468 2c0a 2020  _output_path,.  
+00006040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006050: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00006060: 743d 746d 705f 6f75 7470 7574 5f70 6174  t=tmp_output_pat
+00006070: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+00006080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006090: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+000060a0: 7469 6f6e 733d 6578 706c 6f64 6563 6f6c  tions=explodecol
+000060b0: 6c65 6374 696f 6e73 2c0a 2020 2020 2020  lections,.      
+000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060d0: 2020 2020 2020 2020 2020 6372 6561 7465            create
+000060e0: 5f73 7061 7469 616c 5f69 6e64 6578 3d46  _spatial_index=F
+000060f0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00006100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006110: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+00006120: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
+00006130: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+00006140: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
+00006150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006160: 2020 2020 2020 2020 2020 2077 6865 7265             where
+00006170: 3d77 6865 7265 2c0a 2020 2020 2020 2020  =where,.        
+00006180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006190: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000061a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061b0: 2020 6766 6f2e 7265 6d6f 7665 2874 6d70    gfo.remove(tmp
+000061c0: 5f70 6172 7469 616c 5f6f 7574 7075 745f  _partial_output_
+000061d0: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
+000061e0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+000061f0: 6365 7074 696f 6e20 6173 2065 783a 0a20  ception as ex:. 
+00006200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006210: 2020 2062 6174 6368 5f69 6420 3d20 6675     batch_id = fu
+00006220: 7475 7265 5f74 6f5f 6261 7463 685f 6964  ture_to_batch_id
+00006230: 5b66 7574 7572 655d 0a20 2020 2020 2020  [future].       
+00006240: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+00006250: 7361 6765 203d 2066 2245 7272 6f72 207b  sage = f"Error {
+00006260: 6578 7d20 6578 6563 7574 696e 6720 7b62  ex} executing {b
+00006270: 6174 6368 6573 5b62 6174 6368 5f69 645d  atches[batch_id]
+00006280: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00006290: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+000062a0: 6365 7074 696f 6e28 6d65 7373 6167 6529  ception(message)
+000062b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000062c0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+000062d0: 6d65 4572 726f 7228 6d65 7373 6167 6529  meError(message)
+000062e0: 2066 726f 6d20 6578 0a0a 2020 2020 2020   from ex..      
+000062f0: 2020 2020 2020 2020 2020 2320 4c6f 6720            # Log 
+00006300: 7468 6520 7072 6f67 7265 7373 2061 6e64  the progress and
+00006310: 2070 7265 6469 6374 696f 6e20 7370 6565   prediction spee
+00006320: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00006330: 2020 6e62 5f64 6f6e 6520 2b3d 2031 0a20    nb_done += 1. 
+00006340: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00006350: 6765 6e65 7261 6c5f 7574 696c 2e72 6570  general_util.rep
+00006360: 6f72 745f 7072 6f67 7265 7373 280a 2020  ort_progress(.  
+00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006380: 2020 7374 6172 745f 7469 6d65 2c20 6e62    start_time, nb
+00006390: 5f64 6f6e 652c 206e 625f 6261 7463 6865  _done, nb_batche
+000063a0: 732c 206f 7065 7261 7469 6f6e 2e76 616c  s, operation.val
+000063b0: 7565 2c20 6e62 5f70 6172 616c 6c65 6c0a  ue, nb_parallel.
+000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063d0: 290a 0a20 2020 2020 2020 2023 2052 6f75  )..        # Rou
+000063e0: 6e64 2075 7020 616e 6420 636c 6561 6e20  nd up and clean 
+000063f0: 7570 0a20 2020 2020 2020 2023 204e 6f77  up.        # Now
+00006400: 2063 7265 6174 6520 7370 6174 6961 6c20   create spatial 
+00006410: 696e 6465 7820 616e 6420 6d6f 7665 2074  index and move t
+00006420: 6f20 6f75 7470 7574 206c 6f63 6174 696f  o output locatio
+00006430: 6e0a 2020 2020 2020 2020 6966 2074 6d70  n.        if tmp
+00006440: 5f6f 7574 7075 745f 7061 7468 2e65 7869  _output_path.exi
+00006450: 7374 7328 293a 0a20 2020 2020 2020 2020  sts():.         
+00006460: 2020 2067 666f 2e63 7265 6174 655f 7370     gfo.create_sp
+00006470: 6174 6961 6c5f 696e 6465 7828 7061 7468  atial_index(path
+00006480: 3d74 6d70 5f6f 7574 7075 745f 7061 7468  =tmp_output_path
+00006490: 2c20 6c61 7965 723d 6f75 7470 7574 5f6c  , layer=output_l
+000064a0: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
+000064b0: 2020 6766 6f2e 6d6f 7665 2874 6d70 5f6f    gfo.move(tmp_o
+000064c0: 7574 7075 745f 7061 7468 2c20 6f75 7470  utput_path, outp
+000064d0: 7574 5f70 6174 6829 0a20 2020 2020 2020  ut_path).       
+000064e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000064f0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00006500: 6622 5265 7375 6c74 206f 6620 7b6f 7065  f"Result of {ope
+00006510: 7261 7469 6f6e 7d20 7761 7320 656d 7074  ration} was empt
+00006520: 7921 2229 0a0a 2020 2020 6669 6e61 6c6c  y!")..    finall
+00006530: 793a 0a20 2020 2020 2020 2073 6875 7469  y:.        shuti
+00006540: 6c2e 726d 7472 6565 2874 656d 7064 6972  l.rmtree(tempdir
+00006550: 2c20 6967 6e6f 7265 5f65 7272 6f72 733d  , ignore_errors=
+00006560: 5472 7565 290a 0a20 2020 206c 6f67 6765  True)..    logge
+00006570: 722e 696e 666f 2866 227b 6f70 6572 6174  r.info(f"{operat
+00006580: 696f 6e7d 2072 6561 6479 2c20 746f 6f6b  ion} ready, took
+00006590: 207b 6461 7465 7469 6d65 2e6e 6f77 2829   {datetime.now()
+000065a0: 2d73 7461 7274 5f74 696d 655f 676c 6f62  -start_time_glob
+000065b0: 616c 7d21 2229 0a0a 0a64 6566 205f 6170  al}!")...def _ap
+000065c0: 706c 795f 6765 6f6f 7065 7261 7469 6f6e  ply_geooperation
+000065d0: 280a 2020 2020 696e 7075 745f 7061 7468  (.    input_path
+000065e0: 3a20 5061 7468 2c0a 2020 2020 6f75 7470  : Path,.    outp
+000065f0: 7574 5f70 6174 683a 2050 6174 682c 0a20  ut_path: Path,. 
+00006600: 2020 206f 7065 7261 7469 6f6e 3a20 4765     operation: Ge
+00006610: 6f4f 7065 7261 7469 6f6e 2c0a 2020 2020  oOperation,.    
+00006620: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
+00006630: 3a20 6469 6374 2c0a 2020 2020 696e 7075  : dict,.    inpu
+00006640: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
+00006650: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00006660: 2020 206f 7574 7075 745f 6c61 7965 723a     output_layer:
+00006670: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00006680: 204e 6f6e 652c 0a20 2020 2063 6f6c 756d   None,.    colum
+00006690: 6e73 3a20 4f70 7469 6f6e 616c 5b4c 6973  ns: Optional[Lis
+000066a0: 745b 7374 725d 5d20 3d20 4e6f 6e65 2c0a  t[str]] = None,.
+000066b0: 2020 2020 726f 7773 3d4e 6f6e 652c 0a20      rows=None,. 
+000066c0: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+000066d0: 7469 6f6e 733a 2062 6f6f 6c20 3d20 4661  tions: bool = Fa
+000066e0: 6c73 652c 0a20 2020 2067 7269 6473 697a  lse,.    gridsiz
+000066f0: 653a 2066 6c6f 6174 203d 2030 2e30 2c0a  e: float = 0.0,.
+00006700: 2020 2020 6b65 6570 5f65 6d70 7479 5f67      keep_empty_g
+00006710: 656f 6d73 3a20 626f 6f6c 203d 2054 7275  eoms: bool = Tru
+00006720: 652c 0a20 2020 2066 6f72 6365 3a20 626f  e,.    force: bo
+00006730: 6f6c 203d 2046 616c 7365 2c0a 2920 2d3e  ol = False,.) ->
+00006740: 2073 7472 3a0a 2020 2020 2320 496e 6974   str:.    # Init
+00006750: 0a20 2020 2069 6620 6f75 7470 7574 5f70  .    if output_p
+00006760: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
+00006770: 2020 2020 2020 6966 2066 6f72 6365 2069        if force i
+00006780: 7320 4661 6c73 653a 0a20 2020 2020 2020  s False:.       
+00006790: 2020 2020 206d 6573 7361 6765 203d 2066       message = f
+000067a0: 2253 746f 7020 7b6f 7065 7261 7469 6f6e  "Stop {operation
+000067b0: 7d3a 206f 7574 7075 7420 6578 6973 7473  }: output exists
+000067c0: 2061 6c72 6561 6479 207b 6f75 7470 7574   already {output
+000067d0: 5f70 6174 687d 220a 2020 2020 2020 2020  _path}".        
+000067e0: 2020 2020 7265 7475 726e 206d 6573 7361      return messa
+000067f0: 6765 0a20 2020 2020 2020 2065 6c73 653a  ge.        else:
+00006800: 0a20 2020 2020 2020 2020 2020 2067 666f  .            gfo
+00006810: 2e72 656d 6f76 6528 6f75 7470 7574 5f70  .remove(output_p
+00006820: 6174 6829 0a0a 2020 2020 2320 4e6f 7720  ath)..    # Now 
+00006830: 676f 210a 2020 2020 7374 6172 745f 7469  go!.    start_ti
+00006840: 6d65 203d 2064 6174 6574 696d 652e 6e6f  me = datetime.no
+00006850: 7728 290a 2020 2020 6461 7461 5f67 6466  w().    data_gdf
+00006860: 203d 2067 666f 2e72 6561 645f 6669 6c65   = gfo.read_file
+00006870: 280a 2020 2020 2020 2020 7061 7468 3d69  (.        path=i
+00006880: 6e70 7574 5f70 6174 682c 206c 6179 6572  nput_path, layer
+00006890: 3d69 6e70 7574 5f6c 6179 6572 2c20 636f  =input_layer, co
+000068a0: 6c75 6d6e 733d 636f 6c75 6d6e 732c 2072  lumns=columns, r
+000068b0: 6f77 733d 726f 7773 0a20 2020 2029 0a0a  ows=rows.    )..
+000068c0: 2020 2020 2320 5275 6e20 6f70 6572 6174      # Run operat
+000068d0: 696f 6e73 0a20 2020 2069 6620 6f70 6572  ions.    if oper
+000068e0: 6174 696f 6e20 6973 2047 656f 4f70 6572  ation is GeoOper
+000068f0: 6174 696f 6e2e 4255 4646 4552 3a0a 2020  ation.BUFFER:.  
+00006900: 2020 2020 2020 6461 7461 5f67 6466 2e67        data_gdf.g
+00006910: 656f 6d65 7472 7920 3d20 6461 7461 5f67  eometry = data_g
+00006920: 6466 2e67 656f 6d65 7472 792e 6275 6666  df.geometry.buff
+00006930: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00006940: 6469 7374 616e 6365 3d6f 7065 7261 7469  distance=operati
+00006950: 6f6e 5f70 6172 616d 735b 2264 6973 7461  on_params["dista
+00006960: 6e63 6522 5d2c 0a20 2020 2020 2020 2020  nce"],.         
+00006970: 2020 2072 6573 6f6c 7574 696f 6e3d 6f70     resolution=op
+00006980: 6572 6174 696f 6e5f 7061 7261 6d73 5b22  eration_params["
+00006990: 7175 6164 7261 6e74 7365 676d 656e 7473  quadrantsegments
+000069a0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+000069b0: 6361 705f 7374 796c 653d 6f70 6572 6174  cap_style=operat
+000069c0: 696f 6e5f 7061 7261 6d73 5b22 656e 6463  ion_params["endc
+000069d0: 6170 5f73 7479 6c65 225d 2e76 616c 7565  ap_style"].value
+000069e0: 2c0a 2020 2020 2020 2020 2020 2020 6a6f  ,.            jo
+000069f0: 696e 5f73 7479 6c65 3d6f 7065 7261 7469  in_style=operati
+00006a00: 6f6e 5f70 6172 616d 735b 226a 6f69 6e5f  on_params["join_
+00006a10: 7374 796c 6522 5d2e 7661 6c75 652c 0a20  style"].value,. 
+00006a20: 2020 2020 2020 2020 2020 206d 6974 7265             mitre
+00006a30: 5f6c 696d 6974 3d6f 7065 7261 7469 6f6e  _limit=operation
+00006a40: 5f70 6172 616d 735b 226d 6974 7265 5f6c  _params["mitre_l
+00006a50: 696d 6974 225d 2c0a 2020 2020 2020 2020  imit"],.        
+00006a60: 2020 2020 7369 6e67 6c65 5f73 6964 6564      single_sided
+00006a70: 3d6f 7065 7261 7469 6f6e 5f70 6172 616d  =operation_param
+00006a80: 735b 2273 696e 676c 655f 7369 6465 6422  s["single_sided"
+00006a90: 5d2c 0a20 2020 2020 2020 2029 0a20 2020  ],.        ).   
+00006aa0: 2065 6c69 6620 6f70 6572 6174 696f 6e20   elif operation 
+00006ab0: 6973 2047 656f 4f70 6572 6174 696f 6e2e  is GeoOperation.
+00006ac0: 434f 4e56 4558 4855 4c4c 3a0a 2020 2020  CONVEXHULL:.    
+00006ad0: 2020 2020 6461 7461 5f67 6466 2e67 656f      data_gdf.geo
+00006ae0: 6d65 7472 7920 3d20 6461 7461 5f67 6466  metry = data_gdf
+00006af0: 2e67 656f 6d65 7472 792e 636f 6e76 6578  .geometry.convex
+00006b00: 5f68 756c 6c0a 2020 2020 656c 6966 206f  _hull.    elif o
+00006b10: 7065 7261 7469 6f6e 2069 7320 4765 6f4f  peration is GeoO
+00006b20: 7065 7261 7469 6f6e 2e53 494d 504c 4946  peration.SIMPLIF
+00006b30: 593a 0a20 2020 2020 2020 2064 6174 615f  Y:.        data_
+00006b40: 6764 662e 6765 6f6d 6574 7279 203d 2067  gdf.geometry = g
+00006b50: 656f 7365 7269 6573 5f75 7469 6c2e 7369  eoseries_util.si
+00006b60: 6d70 6c69 6679 5f65 7874 280a 2020 2020  mplify_ext(.    
+00006b70: 2020 2020 2020 2020 6461 7461 5f67 6466          data_gdf
+00006b80: 2e67 656f 6d65 7472 792c 0a20 2020 2020  .geometry,.     
+00006b90: 2020 2020 2020 2061 6c67 6f72 6974 686d         algorithm
+00006ba0: 3d6f 7065 7261 7469 6f6e 5f70 6172 616d  =operation_param
+00006bb0: 735b 2261 6c67 6f72 6974 686d 225d 2c0a  s["algorithm"],.
+00006bc0: 2020 2020 2020 2020 2020 2020 746f 6c65              tole
+00006bd0: 7261 6e63 653d 6f70 6572 6174 696f 6e5f  rance=operation_
+00006be0: 7061 7261 6d73 5b22 746f 6c65 7261 6e63  params["toleranc
+00006bf0: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
+00006c00: 206c 6f6f 6b61 6865 6164 3d6f 7065 7261   lookahead=opera
+00006c10: 7469 6f6e 5f70 6172 616d 735b 2273 7465  tion_params["ste
+00006c20: 7022 5d2c 0a20 2020 2020 2020 2029 0a20  p"],.        ). 
+00006c30: 2020 2065 6c69 6620 6f70 6572 6174 696f     elif operatio
+00006c40: 6e20 6973 2047 656f 4f70 6572 6174 696f  n is GeoOperatio
+00006c50: 6e2e 4150 504c 593a 0a20 2020 2020 2020  n.APPLY:.       
+00006c60: 2066 756e 6320 3d20 7069 636b 6c65 2e6c   func = pickle.l
+00006c70: 6f61 6473 286f 7065 7261 7469 6f6e 5f70  oads(operation_p
+00006c80: 6172 616d 735b 2270 6963 6b6c 6564 5f66  arams["pickled_f
+00006c90: 756e 6322 5d29 0a20 2020 2020 2020 2069  unc"]).        i
+00006ca0: 6620 6f70 6572 6174 696f 6e5f 7061 7261  f operation_para
+00006cb0: 6d73 5b22 6f6e 6c79 5f67 656f 6d5f 696e  ms["only_geom_in
+00006cc0: 7075 7422 5d20 6973 2054 7275 653a 0a20  put"] is True:. 
+00006cd0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00006ce0: 6764 662e 6765 6f6d 6574 7279 203d 2064  gdf.geometry = d
+00006cf0: 6174 615f 6764 662e 6765 6f6d 6574 7279  ata_gdf.geometry
+00006d00: 2e61 7070 6c79 2866 756e 6329 0a20 2020  .apply(func).   
+00006d10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00006d20: 2020 2020 2020 2064 6174 615f 6764 662e         data_gdf.
+00006d30: 6765 6f6d 6574 7279 203d 2064 6174 615f  geometry = data_
+00006d40: 6764 662e 6170 706c 7928 6675 6e63 2c20  gdf.apply(func, 
+00006d50: 6178 6973 3d31 290a 2020 2020 656c 7365  axis=1).    else
+00006d60: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00006d70: 5661 6c75 6545 7272 6f72 2866 226f 7065  ValueError(f"ope
+00006d80: 7261 7469 6f6e 206e 6f74 2073 7570 706f  ration not suppo
+00006d90: 7274 6564 3a20 7b6f 7065 7261 7469 6f6e  rted: {operation
+00006da0: 7d22 290a 0a20 2020 2023 2053 6574 2065  }")..    # Set e
+00006db0: 6d70 7479 2067 656f 6d65 7472 6965 7320  mpty geometries 
+00006dc0: 746f 206e 756c 6c2f 4e6f 6e65 0a20 2020  to null/None.   
+00006dd0: 2061 7373 6572 7420 6461 7461 5f67 6466   assert data_gdf
+00006de0: 2e67 656f 6d65 7472 7920 6973 206e 6f74  .geometry is not
+00006df0: 204e 6f6e 650a 2020 2020 6461 7461 5f67   None.    data_g
+00006e00: 6466 2e6c 6f63 5b64 6174 615f 6764 662e  df.loc[data_gdf.
+00006e10: 6765 6f6d 6574 7279 2e69 735f 656d 7074  geometry.is_empt
+00006e20: 792c 205b 2267 656f 6d65 7472 7922 5d5d  y, ["geometry"]]
+00006e30: 203d 204e 6f6e 650a 0a20 2020 2023 2052   = None..    # R
+00006e40: 656d 6f76 6520 726f 7773 2077 6865 7265  emove rows where
+00006e50: 2067 656f 6d20 6973 204e 6f6e 652f 6e75   geom is None/nu
+00006e60: 6c6c 2f65 6d70 7479 0a20 2020 2069 6620  ll/empty.    if 
+00006e70: 6e6f 7420 6b65 6570 5f65 6d70 7479 5f67  not keep_empty_g
+00006e80: 656f 6d73 3a0a 2020 2020 2020 2020 6173  eoms:.        as
+00006e90: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00006ea0: 6461 7461 5f67 6466 2c20 6770 642e 4765  data_gdf, gpd.Ge
+00006eb0: 6f44 6174 6146 7261 6d65 290a 2020 2020  oDataFrame).    
+00006ec0: 2020 2020 6461 7461 5f67 6466 203d 2064      data_gdf = d
+00006ed0: 6174 615f 6764 665b 7e64 6174 615f 6764  ata_gdf[~data_gd
+00006ee0: 662e 6765 6f6d 6574 7279 2e69 736e 6128  f.geometry.isna(
+00006ef0: 295d 0a0a 2020 2020 2320 4966 2074 6865  )]..    # If the
+00006f00: 7265 2069 7320 616e 2066 6964 2063 6f6c  re is an fid col
+00006f10: 756d 6e20 696e 2074 6865 2064 6174 6173  umn in the datas
+00006f20: 6574 2c20 7265 6e61 6d65 2069 742c 2062  et, rename it, b
+00006f30: 6563 6175 7365 2074 6865 2066 6964 2063  ecause the fid c
+00006f40: 6f6c 756d 6e20 6973 2061 0a20 2020 2023  olumn is a.    #
+00006f50: 2022 7370 6563 6961 6c20 6361 7365 2220   "special case" 
+00006f60: 696e 2067 6461 6c20 7468 6174 2073 686f  in gdal that sho
+00006f70: 756c 6420 6e6f 7420 6265 2077 7269 7474  uld not be writt
+00006f80: 656e 2e0a 2020 2020 6173 7365 7274 2069  en..    assert i
+00006f90: 7369 6e73 7461 6e63 6528 6461 7461 5f67  sinstance(data_g
+00006fa0: 6466 2c20 6770 642e 4765 6f44 6174 6146  df, gpd.GeoDataF
+00006fb0: 7261 6d65 290a 2020 2020 636f 6c75 6d6e  rame).    column
+00006fc0: 735f 6c6f 7765 725f 6c6f 6f6b 7570 203d  s_lower_lookup =
+00006fd0: 207b 636f 6c75 6d6e 2e6c 6f77 6572 2829   {column.lower()
+00006fe0: 3a20 636f 6c75 6d6e 2066 6f72 2063 6f6c  : column for col
+00006ff0: 756d 6e20 696e 2064 6174 615f 6764 662e  umn in data_gdf.
+00007000: 636f 6c75 6d6e 737d 0a20 2020 2069 6620  columns}.    if 
+00007010: 2266 6964 2220 696e 2063 6f6c 756d 6e73  "fid" in columns
+00007020: 5f6c 6f77 6572 5f6c 6f6f 6b75 703a 0a20  _lower_lookup:. 
+00007030: 2020 2020 2020 2066 6964 5f63 6f6c 756d         fid_colum
+00007040: 6e20 3d20 636f 6c75 6d6e 735f 6c6f 7765  n = columns_lowe
+00007050: 725f 6c6f 6f6b 7570 5b22 6669 6422 5d0a  r_lookup["fid"].
+00007060: 2020 2020 2020 2020 666f 7220 6669 645f          for fid_
+00007070: 6e75 6d62 6572 2069 6e20 7261 6e67 6528  number in range(
+00007080: 312c 2031 3030 293a 0a20 2020 2020 2020  1, 100):.       
+00007090: 2020 2020 206e 6577 5f6e 616d 6520 3d20       new_name = 
+000070a0: 6622 7b66 6964 5f63 6f6c 756d 6e7d 5f7b  f"{fid_column}_{
+000070b0: 6669 645f 6e75 6d62 6572 7d22 0a20 2020  fid_number}".   
+000070c0: 2020 2020 2020 2020 2069 6620 6e65 775f           if new_
+000070d0: 6e61 6d65 206e 6f74 2069 6e20 636f 6c75  name not in colu
+000070e0: 6d6e 735f 6c6f 7765 725f 6c6f 6f6b 7570  mns_lower_lookup
+000070f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007100: 2020 6461 7461 5f67 6466 203d 2064 6174    data_gdf = dat
+00007110: 615f 6764 662e 7265 6e61 6d65 280a 2020  a_gdf.rename(.  
+00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007130: 2020 636f 6c75 6d6e 733d 7b66 6964 5f63    columns={fid_c
+00007140: 6f6c 756d 6e3a 206e 6577 5f6e 616d 657d  olumn: new_name}
+00007150: 2c20 636f 7079 3d46 616c 7365 2020 2320  , copy=False  # 
+00007160: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+00007170: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00007180: 2020 2069 6620 6578 706c 6f64 6563 6f6c     if explodecol
+00007190: 6c65 6374 696f 6e73 3a0a 2020 2020 2020  lections:.      
+000071a0: 2020 6461 7461 5f67 6466 203d 2064 6174    data_gdf = dat
+000071b0: 615f 6764 662e 6578 706c 6f64 6528 6967  a_gdf.explode(ig
+000071c0: 6e6f 7265 5f69 6e64 6578 3d54 7275 6529  nore_index=True)
+000071d0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+000071e0: 0a0a 2020 2020 6966 2067 7269 6473 697a  ..    if gridsiz
+000071f0: 6520 213d 2030 2e30 3a0a 2020 2020 2020  e != 0.0:.      
+00007200: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00007210: 6e63 6528 6461 7461 5f67 6466 2c20 6770  nce(data_gdf, gp
+00007220: 642e 4765 6f44 6174 6146 7261 6d65 290a  d.GeoDataFrame).
+00007230: 2020 2020 2020 2020 6461 7461 5f67 6466          data_gdf
+00007240: 2e67 656f 6d65 7472 7920 3d20 7368 6170  .geometry = shap
+00007250: 656c 7932 5f6f 725f 7079 6765 6f73 2e73  ely2_or_pygeos.s
+00007260: 6574 5f70 7265 6369 7369 6f6e 280a 2020  et_precision(.  
+00007270: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
+00007280: 6466 2e67 656f 6d65 7472 792e 6172 7261  df.geometry.arra
+00007290: 792e 6461 7461 2c20 6772 6964 5f73 697a  y.data, grid_siz
+000072a0: 653d 6772 6964 7369 7a65 0a20 2020 2020  e=gridsize.     
+000072b0: 2020 2029 0a0a 2020 2020 2320 4966 2074     )..    # If t
+000072c0: 6865 2072 6573 756c 7420 6973 2065 6d70  he result is emp
+000072d0: 7479 2c20 616e 6420 6e6f 206f 7574 7075  ty, and no outpu
+000072e0: 7420 6765 6f6d 6574 7279 7479 7065 2073  t geometrytype s
+000072f0: 7065 6369 6669 6564 2c20 7573 6520 696e  pecified, use in
+00007300: 7075 740a 2020 2020 2320 6765 6f6d 6574  put.    # geomet
+00007310: 7279 7479 7065 0a20 2020 2066 6f72 6365  rytype.    force
+00007320: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+00007330: 7479 7065 203d 204e 6f6e 650a 2020 2020  type = None.    
+00007340: 6966 206c 656e 2864 6174 615f 6764 6629  if len(data_gdf)
+00007350: 203d 3d20 303a 0a20 2020 2020 2020 2069   == 0:.        i
+00007360: 6e70 7574 5f6c 6179 6572 696e 666f 203d  nput_layerinfo =
+00007370: 2067 666f 2e67 6574 5f6c 6179 6572 696e   gfo.get_layerin
+00007380: 666f 2869 6e70 7574 5f70 6174 682c 2069  fo(input_path, i
+00007390: 6e70 7574 5f6c 6179 6572 290a 2020 2020  nput_layer).    
+000073a0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+000073b0: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
+000073c0: 696e 7075 745f 6c61 7965 7269 6e66 6f2e  input_layerinfo.
+000073d0: 6765 6f6d 6574 7279 7479 7065 2e74 6f5f  geometrytype.to_
+000073e0: 6d75 6c74 6974 7970 652e 6e61 6d65 0a0a  multitype.name..
+000073f0: 2020 2020 2320 6173 7365 7274 2074 6f20      # assert to 
+00007400: 6576 6164 6520 7079 4c61 6e63 6520 7761  evade pyLance wa
+00007410: 726e 696e 670a 2020 2020 6173 7365 7274  rning.    assert
+00007420: 2069 7369 6e73 7461 6e63 6528 6461 7461   isinstance(data
+00007430: 5f67 6466 2c20 6770 642e 4765 6f44 6174  _gdf, gpd.GeoDat
+00007440: 6146 7261 6d65 290a 2020 2020 2320 5573  aFrame).    # Us
+00007450: 6520 666f 7263 655f 6d75 6c74 6974 7970  e force_multityp
+00007460: 652c 2074 6f20 6576 6164 6520 7761 726e  e, to evade warn
+00007470: 696e 6773 2077 6865 6e20 736f 6d65 2062  ings when some b
+00007480: 6174 6368 6573 2063 6f6e 7461 696e 0a20  atches contain. 
+00007490: 2020 2023 2073 696e 676c 6574 7970 6520     # singletype 
+000074a0: 616e 6420 736f 6d65 2063 6f6e 7461 696e  and some contain
+000074b0: 206d 756c 7469 7479 7065 2067 656f 6d65   multitype geome
+000074c0: 7472 6965 730a 2020 2020 6766 6f2e 746f  tries.    gfo.to
+000074d0: 5f66 696c 6528 0a20 2020 2020 2020 2067  _file(.        g
+000074e0: 6466 3d64 6174 615f 6764 662c 0a20 2020  df=data_gdf,.   
+000074f0: 2020 2020 2070 6174 683d 6f75 7470 7574       path=output
+00007500: 5f70 6174 682c 0a20 2020 2020 2020 206c  _path,.        l
+00007510: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
+00007520: 722c 0a20 2020 2020 2020 2069 6e64 6578  r,.        index
+00007530: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00007540: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+00007550: 6d65 7472 7974 7970 653d 666f 7263 655f  metrytype=force_
+00007560: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00007570: 7970 652c 0a20 2020 2020 2020 2066 6f72  ype,.        for
+00007580: 6365 5f6d 756c 7469 7479 7065 3d54 7275  ce_multitype=Tru
+00007590: 652c 0a20 2020 2020 2020 2063 7265 6174  e,.        creat
+000075a0: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
+000075b0: 4661 6c73 652c 0a20 2020 2029 0a0a 2020  False,.    )..  
+000075c0: 2020 6d65 7373 6167 6520 3d20 6622 546f    message = f"To
+000075d0: 6f6b 207b 6461 7465 7469 6d65 2e6e 6f77  ok {datetime.now
+000075e0: 2829 2d73 7461 7274 5f74 696d 657d 2066  ()-start_time} f
+000075f0: 6f72 207b 6c65 6e28 6461 7461 5f67 6466  or {len(data_gdf
+00007600: 297d 2072 6f77 7320 287b 726f 7773 7d29  )} rows ({rows})
+00007610: 2122 0a20 2020 2072 6574 7572 6e20 6d65  !".    return me
+00007620: 7373 6167 650a 0a0a 6465 6620 6469 7373  ssage...def diss
+00007630: 6f6c 7665 280a 2020 2020 696e 7075 745f  olve(.    input_
+00007640: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
+00007650: 6f75 7470 7574 5f70 6174 683a 2050 6174  output_path: Pat
+00007660: 682c 0a20 2020 2067 726f 7570 6279 5f63  h,.    groupby_c
+00007670: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
+00007680: 5b49 7465 7261 626c 655b 7374 725d 5d20  [Iterable[str]] 
+00007690: 3d20 4e6f 6e65 2c0a 2020 2020 6167 675f  = None,.    agg_
+000076a0: 636f 6c75 6d6e 733a 204f 7074 696f 6e61  columns: Optiona
+000076b0: 6c5b 6469 6374 5d20 3d20 4e6f 6e65 2c0a  l[dict] = None,.
+000076c0: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
+000076d0: 6374 696f 6e73 3a20 626f 6f6c 203d 2054  ctions: bool = T
+000076e0: 7275 652c 0a20 2020 2074 696c 6573 5f70  rue,.    tiles_p
+000076f0: 6174 683a 204f 7074 696f 6e61 6c5b 5061  ath: Optional[Pa
+00007700: 7468 5d20 3d20 4e6f 6e65 2c0a 2020 2020  th] = None,.    
+00007710: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
+00007720: 733a 2069 6e74 203d 2031 2c0a 2020 2020  s: int = 1,.    
+00007730: 696e 7075 745f 6c61 7965 723a 204f 7074  input_layer: Opt
+00007740: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00007750: 652c 0a20 2020 206f 7574 7075 745f 6c61  e,.    output_la
+00007760: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
+00007770: 725d 203d 204e 6f6e 652c 0a20 2020 2067  r] = None,.    g
+00007780: 7269 6473 697a 653a 2066 6c6f 6174 203d  ridsize: float =
+00007790: 2030 2e30 2c0a 2020 2020 7768 6572 653a   0.0,.    where:
+000077a0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000077b0: 204e 6f6e 652c 0a20 2020 206e 625f 7061   None,.    nb_pa
+000077c0: 7261 6c6c 656c 3a20 696e 7420 3d20 2d31  rallel: int = -1
+000077d0: 2c0a 2020 2020 6261 7463 6873 697a 653a  ,.    batchsize:
+000077e0: 2069 6e74 203d 202d 312c 0a20 2020 2066   int = -1,.    f
+000077f0: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
+00007800: 7365 2c0a 2920 2d3e 2064 6963 743a 0a20  se,.) -> dict:. 
+00007810: 2020 2022 2222 0a20 2020 2046 756e 6374     """.    Funct
+00007820: 696f 6e20 7468 6174 2061 7070 6c69 6573  ion that applies
+00007830: 2061 2064 6973 736f 6c76 652e 0a0a 2020   a dissolve...  
+00007840: 2020 4d6f 7265 2064 6574 6169 6c65 6420    More detailed 
+00007850: 646f 6375 6d65 6e74 6174 696f 6e20 696e  documentation in
+00007860: 206d 6f64 756c 6520 6765 6f6f 7073 210a   module geoops!.
+00007870: 0a20 2020 2052 656d 6172 6b3a 206b 6565  .    Remark: kee
+00007880: 705f 656d 7074 795f 6765 6f6d 7320 6973  p_empty_geoms is
+00007890: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+000078a0: 2062 6563 6175 7365 2074 6869 7320 6973   because this is
+000078b0: 206e 6f74 2073 6f20 6561 7379 2062 6563   not so easy bec
+000078c0: 6175 7365 0a20 2020 2028 666f 7220 706f  ause.    (for po
+000078d0: 6c79 676f 6e20 6469 7373 6f6c 7665 2920  lygon dissolve) 
+000078e0: 7468 6520 6261 7463 6865 7320 6172 6520  the batches are 
+000078f0: 6c6f 6361 7469 6f6e 2062 6173 6564 2c20  location based, 
+00007900: 616e 6420 6e75 6c6c 2f65 6d70 7479 2067  and null/empty g
+00007910: 656f 6d65 7472 6965 730a 2020 2020 646f  eometries.    do
+00007920: 6e27 7420 6861 7665 2061 206c 6f63 6174  n't have a locat
+00007930: 696f 6e2e 2049 7420 636f 756c 6420 6265  ion. It could be
+00007940: 2069 6d70 6c65 6d65 6e74 6564 2c20 6275   implemented, bu
+00007950: 7420 6173 206c 6f6e 6720 6173 206e 6f62  t as long as nob
+00007960: 6f64 7920 6e65 6564 7320 6974 2e2e 2e0a  ody needs it....
+00007970: 2020 2020 2222 220a 0a20 2020 2023 2049      """..    # I
+00007980: 6e69 7420 616e 6420 7661 6c69 6461 7465  nit and validate
+00007990: 2069 6e70 7574 2070 6172 616d 6574 6572   input parameter
+000079a0: 730a 2020 2020 2320 2d2d 2d2d 2d2d 2d2d  s.    # --------
+000079b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000079c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
+000079d0: 7461 7274 5f74 696d 6520 3d20 6461 7465  tart_time = date
+000079e0: 7469 6d65 2e6e 6f77 2829 0a20 2020 206f  time.now().    o
+000079f0: 7065 7261 7469 6f6e 203d 2022 6469 7373  peration = "diss
+00007a00: 6f6c 7665 220a 2020 2020 7265 7375 6c74  olve".    result
+00007a10: 5f69 6e66 6f20 3d20 7b7d 0a0a 2020 2020  _info = {}..    
+00007a20: 2320 4368 6563 6b20 696e 7075 7420 7061  # Check input pa
+00007a30: 7261 6d65 7465 7273 0a20 2020 2069 6620  rameters.    if 
+00007a40: 6772 6f75 7062 795f 636f 6c75 6d6e 7320  groupby_columns 
+00007a50: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00007a60: 6c65 6e28 6c69 7374 2867 726f 7570 6279  len(list(groupby
+00007a70: 5f63 6f6c 756d 6e73 2929 203d 3d20 303a  _columns)) == 0:
+00007a80: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00007a90: 616c 7565 4572 726f 7228 2267 726f 7570  alueError("group
+00007aa0: 6279 5f63 6f6c 756d 6e73 3d5b 5d20 6973  by_columns=[] is
+00007ab0: 206e 6f74 2073 7570 706f 7274 6564 2e20   not supported. 
+00007ac0: 5573 6520 4e6f 6e65 2e22 290a 2020 2020  Use None.").    
+00007ad0: 6966 206e 6f74 2069 6e70 7574 5f70 6174  if not input_pat
+00007ae0: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
+00007af0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00007b00: 7272 6f72 2866 2269 6e70 7574 5f70 6174  rror(f"input_pat
+00007b10: 6820 646f 6573 6e27 7420 6578 6973 743a  h doesn't exist:
+00007b20: 207b 696e 7075 745f 7061 7468 7d22 290a   {input_path}").
+00007b30: 2020 2020 6966 2069 6e70 7574 5f70 6174      if input_pat
+00007b40: 6820 3d3d 206f 7574 7075 745f 7061 7468  h == output_path
+00007b50: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007b60: 5661 6c75 6545 7272 6f72 2822 6f75 7470  ValueError("outp
+00007b70: 7574 5f70 6174 6820 6d75 7374 206e 6f74  ut_path must not
+00007b80: 2065 7175 616c 2069 6e70 7574 5f70 6174   equal input_pat
+00007b90: 6822 290a 0a20 2020 2069 6e70 7574 5f6c  h")..    input_l
+00007ba0: 6179 6572 696e 666f 203d 2067 666f 2e67  ayerinfo = gfo.g
+00007bb0: 6574 5f6c 6179 6572 696e 666f 2869 6e70  et_layerinfo(inp
+00007bc0: 7574 5f70 6174 682c 2069 6e70 7574 5f6c  ut_path, input_l
+00007bd0: 6179 6572 290a 2020 2020 6966 2069 6e70  ayer).    if inp
+00007be0: 7574 5f6c 6179 6572 696e 666f 2e67 656f  ut_layerinfo.geo
+00007bf0: 6d65 7472 7974 7970 652e 746f 5f70 7269  metrytype.to_pri
+00007c00: 6d69 7469 7665 7479 7065 2069 6e20 5b0a  mitivetype in [.
+00007c10: 2020 2020 2020 2020 5072 696d 6974 6976          Primitiv
+00007c20: 6554 7970 652e 504f 494e 542c 0a20 2020  eType.POINT,.   
+00007c30: 2020 2020 2050 7269 6d69 7469 7665 5479       PrimitiveTy
+00007c40: 7065 2e4c 494e 4553 5452 494e 472c 0a20  pe.LINESTRING,. 
+00007c50: 2020 205d 3a0a 2020 2020 2020 2020 6966     ]:.        if
+00007c60: 2074 696c 6573 5f70 6174 6820 6973 206e   tiles_path is n
+00007c70: 6f74 204e 6f6e 6520 6f72 206e 625f 7371  ot None or nb_sq
+00007c80: 7561 7269 7368 5f74 696c 6573 203e 2031  uarish_tiles > 1
+00007c90: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00007ca0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00007cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cc0: 6622 4469 7373 6f6c 7665 2074 6f20 7469  f"Dissolve to ti
+00007cd0: 6c65 7320 6973 206e 6f74 2073 7570 706f  les is not suppo
+00007ce0: 7274 6564 2066 6f72 207b 696e 7075 745f  rted for {input_
+00007cf0: 6c61 7965 7269 6e66 6f2e 6765 6f6d 6574  layerinfo.geomet
+00007d00: 7279 7479 7065 7d22 0a20 2020 2020 2020  rytype}".       
+00007d10: 2020 2020 2020 2020 2022 2c20 736f 2074           ", so t
+00007d20: 696c 6573 5f70 6174 6820 7368 6f75 6c64  iles_path should
+00007d30: 2062 6520 4e6f 6e65 2061 6e64 206e 625f   be None and nb_
+00007d40: 7371 7561 7269 7368 5f74 696c 6573 2073  squarish_tiles s
+00007d50: 686f 756c 6420 6265 2031 2922 0a20 2020  hould be 1)".   
+00007d60: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00007d70: 6966 2069 6e70 7574 5f6c 6179 6572 2069  if input_layer i
+00007d80: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00007d90: 696e 7075 745f 6c61 7965 7220 3d20 6766  input_layer = gf
+00007da0: 6f2e 6765 745f 6f6e 6c79 5f6c 6179 6572  o.get_only_layer
+00007db0: 2869 6e70 7574 5f70 6174 6829 0a20 2020  (input_path).   
+00007dc0: 2069 6620 6f75 7470 7574 5f6c 6179 6572   if output_layer
+00007dd0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00007de0: 2020 6f75 7470 7574 5f6c 6179 6572 203d    output_layer =
+00007df0: 2067 666f 2e67 6574 5f64 6566 6175 6c74   gfo.get_default
+00007e00: 5f6c 6179 6572 286f 7574 7075 745f 7061  _layer(output_pa
+00007e10: 7468 290a 0a20 2020 2023 2043 6865 636b  th)..    # Check
+00007e20: 2063 6f6c 756d 6e73 2069 6e20 6772 6f75   columns in grou
+00007e30: 7062 795f 636f 6c75 6d6e 730a 2020 2020  pby_columns.    
+00007e40: 6966 2067 726f 7570 6279 5f63 6f6c 756d  if groupby_colum
+00007e50: 6e73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ns is not None:.
+00007e60: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+00007e70: 696e 5f6c 6179 6572 5f75 7070 6572 203d  in_layer_upper =
+00007e80: 205b 0a20 2020 2020 2020 2020 2020 2063   [.            c
+00007e90: 6f6c 756d 6e2e 7570 7065 7228 2920 666f  olumn.upper() fo
+00007ea0: 7220 636f 6c75 6d6e 2069 6e20 6c69 7374  r column in list
+00007eb0: 2869 6e70 7574 5f6c 6179 6572 696e 666f  (input_layerinfo
+00007ec0: 2e63 6f6c 756d 6e73 2920 2b20 5b22 6669  .columns) + ["fi
+00007ed0: 6422 5d0a 2020 2020 2020 2020 5d0a 2020  d"].        ].  
+00007ee0: 2020 2020 2020 666f 7220 636f 6c75 6d6e        for column
+00007ef0: 2069 6e20 6772 6f75 7062 795f 636f 6c75   in groupby_colu
+00007f00: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
+00007f10: 2069 6620 636f 6c75 6d6e 2e75 7070 6572   if column.upper
+00007f20: 2829 206e 6f74 2069 6e20 636f 6c75 6d6e  () not in column
+00007f30: 735f 696e 5f6c 6179 6572 5f75 7070 6572  s_in_layer_upper
+00007f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007f50: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00007f60: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00007f70: 2020 2020 2020 2020 6622 636f 6c75 6d6e          f"column
+00007f80: 2069 6e20 6772 6f75 7062 795f 636f 6c75   in groupby_colu
+00007f90: 6d6e 7320 6e6f 7420 6176 6169 6c61 626c  mns not availabl
+00007fa0: 6520 696e 206c 6179 6572 3a20 7b63 6f6c  e in layer: {col
+00007fb0: 756d 6e7d 220a 2020 2020 2020 2020 2020  umn}".          
+00007fc0: 2020 2020 2020 290a 0a20 2020 2023 2043        )..    # C
+00007fd0: 6865 636b 2061 6767 5f63 6f6c 756d 6e73  heck agg_columns
+00007fe0: 2070 6172 616d 0a20 2020 2069 6620 6167   param.    if ag
+00007ff0: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
+00008000: 204e 6f6e 653a 0a20 2020 2020 2020 2023   None:.        #
+00008010: 2056 616c 6964 6174 6520 7468 6520 6469   Validate the di
+00008020: 6374 2073 7472 7563 7475 7265 2c20 736f  ct structure, so
+00008030: 2077 6520 6361 6e20 6173 7375 6d65 2065   we can assume e
+00008040: 7665 7279 7468 696e 6720 6973 204f 4b20  verything is OK 
+00008050: 6675 7274 6865 7220 6f6e 0a20 2020 2020  further on.     
+00008060: 2020 205f 7061 7261 6d65 7465 725f 6865     _parameter_he
+00008070: 6c70 6572 2e76 616c 6964 6174 655f 6167  lper.validate_ag
+00008080: 675f 636f 6c75 6d6e 7328 6167 675f 636f  g_columns(agg_co
+00008090: 6c75 6d6e 7329 0a0a 2020 2020 2020 2020  lumns)..        
+000080a0: 2320 4669 7273 7420 7461 6b65 2061 2064  # First take a d
+000080b0: 6565 7020 636f 7079 2c20 6173 2076 616c  eep copy, as val
+000080c0: 7565 7320 6361 6e20 6265 2063 6861 6e67  ues can be chang
+000080d0: 6564 2066 7572 7468 6572 206f 6e20 746f  ed further on to
+000080e0: 2074 7265 6174 2063 6f6c 756d 6e73 0a20   treat columns. 
+000080f0: 2020 2020 2020 2023 2063 6173 6520 696e         # case in
+00008100: 7365 6e73 6974 6976 650a 2020 2020 2020  sensitive.      
+00008110: 2020 6167 675f 636f 6c75 6d6e 7320 3d20    agg_columns = 
+00008120: 6a73 6f6e 2e6c 6f61 6473 286a 736f 6e2e  json.loads(json.
+00008130: 6475 6d70 7328 6167 675f 636f 6c75 6d6e  dumps(agg_column
+00008140: 7329 290a 2020 2020 2020 2020 6173 7365  s)).        asse
+00008150: 7274 2061 6767 5f63 6f6c 756d 6e73 2069  rt agg_columns i
+00008160: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+00008170: 2020 2069 6620 226a 736f 6e22 2069 6e20     if "json" in 
+00008180: 6167 675f 636f 6c75 6d6e 733a 0a20 2020  agg_columns:.   
+00008190: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
+000081a0: 636f 6c75 6d6e 735b 226a 736f 6e22 5d20  columns["json"] 
+000081b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000081c0: 2020 2020 2020 2020 2061 6767 5f63 6f6c           agg_col
+000081d0: 756d 6e73 5b22 6a73 6f6e 225d 203d 205b  umns["json"] = [
+000081e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000081f0: 2020 2020 2063 6f6c 2066 6f72 2063 6f6c       col for col
+00008200: 2069 6e20 696e 7075 745f 6c61 7965 7269   in input_layeri
+00008210: 6e66 6f2e 636f 6c75 6d6e 7320 6966 2063  nfo.columns if c
+00008220: 6f6c 2e75 7070 6572 2829 2021 3d20 2249  ol.upper() != "I
+00008230: 4e44 4558 220a 2020 2020 2020 2020 2020  NDEX".          
+00008240: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00008250: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008260: 2020 2020 2020 2020 2020 2320 416c 6967            # Alig
+00008270: 6e20 6361 7369 6e67 206f 6620 636f 6c75  n casing of colu
+00008280: 6d6e 206e 616d 6573 2074 6f20 6461 7461  mn names to data
+00008290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000082a0: 2061 6767 5f63 6f6c 756d 6e73 5b22 6a73   agg_columns["js
+000082b0: 6f6e 225d 203d 205f 6765 6e65 7261 6c5f  on"] = _general_
+000082c0: 7574 696c 2e61 6c69 676e 5f63 6173 696e  util.align_casin
+000082d0: 675f 6c69 7374 280a 2020 2020 2020 2020  g_list(.        
+000082e0: 2020 2020 2020 2020 2020 2020 6167 675f              agg_
+000082f0: 636f 6c75 6d6e 735b 226a 736f 6e22 5d2c  columns["json"],
+00008300: 206c 6973 7428 696e 7075 745f 6c61 7965   list(input_laye
+00008310: 7269 6e66 6f2e 636f 6c75 6d6e 7329 202b  rinfo.columns) +
+00008320: 205b 2266 6964 225d 0a20 2020 2020 2020   ["fid"].       
+00008330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00008340: 2020 2065 6c69 6620 2263 6f6c 756d 6e73     elif "columns
+00008350: 2220 696e 2061 6767 5f63 6f6c 756d 6e73  " in agg_columns
+00008360: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00008370: 4c6f 6f70 2074 6872 6f75 6768 2061 6c6c  Loop through all
+00008380: 2072 6f77 730a 2020 2020 2020 2020 2020   rows.          
+00008390: 2020 666f 7220 6167 675f 636f 6c75 6d6e    for agg_column
+000083a0: 2069 6e20 6167 675f 636f 6c75 6d6e 735b   in agg_columns[
+000083b0: 2263 6f6c 756d 6e73 225d 3a0a 2020 2020  "columns"]:.    
+000083c0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+000083d0: 6563 6b20 6966 2063 6f6c 756d 6e20 6578  eck if column ex
+000083e0: 6973 7473 202b 2073 6574 2063 6173 696e  ists + set casin
+000083f0: 6720 7361 6d65 2061 7320 696e 2064 6174  g same as in dat
+00008400: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00008410: 2020 6167 675f 636f 6c75 6d6e 5b22 636f    agg_column["co
+00008420: 6c75 6d6e 225d 203d 205f 6765 6e65 7261  lumn"] = _genera
+00008430: 6c5f 7574 696c 2e61 6c69 676e 5f63 6173  l_util.align_cas
+00008440: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00008450: 2020 2020 2020 2020 2061 6767 5f63 6f6c           agg_col
+00008460: 756d 6e5b 2263 6f6c 756d 6e22 5d2c 206c  umn["column"], l
+00008470: 6973 7428 696e 7075 745f 6c61 7965 7269  ist(input_layeri
+00008480: 6e66 6f2e 636f 6c75 6d6e 7329 202b 205b  nfo.columns) + [
+00008490: 2266 6964 225d 0a20 2020 2020 2020 2020  "fid"].         
+000084a0: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
+000084b0: 4e6f 7720 696e 7075 7420 7061 7261 6d65  Now input parame
+000084c0: 7465 7273 2061 7265 2063 6865 636b 6564  ters are checked
+000084d0: 2c20 6368 6563 6b20 6966 2077 6520 6e65  , check if we ne
+000084e0: 6564 2074 6f20 6361 6c63 756c 6174 6520  ed to calculate 
+000084f0: 616e 7977 6179 0a20 2020 2069 6620 6f75  anyway.    if ou
+00008500: 7470 7574 5f70 6174 682e 6578 6973 7473  tput_path.exists
+00008510: 2829 3a0a 2020 2020 2020 2020 6966 2066  ():.        if f
+00008520: 6f72 6365 2069 7320 4661 6c73 653a 0a20  orce is False:. 
+00008530: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00008540: 745f 696e 666f 5b0a 2020 2020 2020 2020  t_info[.        
+00008550: 2020 2020 2020 2020 226d 6573 7361 6765          "message
+00008560: 220a 2020 2020 2020 2020 2020 2020 5d20  ".            ] 
+00008570: 3d20 6622 6f75 7470 7574 2065 7869 7374  = f"output exist
+00008580: 7320 616c 7265 6164 7920 7b6f 7574 7075  s already {outpu
+00008590: 745f 7061 7468 7d20 616e 6420 666f 7263  t_path} and forc
+000085a0: 6520 6973 2066 616c 7365 220a 2020 2020  e is false".    
+000085b0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+000085c0: 6e66 6f28 7265 7375 6c74 5f69 6e66 6f5b  nfo(result_info[
+000085d0: 226d 6573 7361 6765 225d 290a 2020 2020  "message"]).    
+000085e0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000085f0: 6573 756c 745f 696e 666f 0a20 2020 2020  esult_info.     
+00008600: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00008610: 2020 2020 2067 666f 2e72 656d 6f76 6528       gfo.remove(
+00008620: 6f75 7470 7574 5f70 6174 6829 0a0a 2020  output_path)..  
+00008630: 2020 2320 4e6f 7720 7374 6172 7420 6469    # Now start di
+00008640: 7373 6f6c 7669 6e67 0a20 2020 2023 202d  ssolving.    # -
+00008650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008660: 2d2d 2d0a 2020 2020 2320 456d 7074 7920  ---.    # Empty 
+00008670: 6f72 204c 696e 6520 616e 6420 706f 696e  or Line and poin
+00008680: 7420 6c61 7965 7273 2061 7265 3a0a 2020  t layers are:.  
+00008690: 2020 2320 2020 2a20 6e6f 7420 736f 206c    #   * not so l
+000086a0: 6172 6765 2028 6d65 6d6f 7279 2d77 6973  arge (memory-wis
+000086b0: 6529 0a20 2020 2023 2020 202a 2061 7265  e).    #   * are
+000086c0: 6e27 7420 636f 6d70 7574 6174 696f 6e61  n't computationa
+000086d0: 6c6c 7920 6865 6176 790a 2020 2020 2320  lly heavy.    # 
+000086e0: 4164 6469 7469 6f6e 616c 6c79 206c 696e  Additionally lin
+000086f0: 6520 6c61 7965 7273 2061 7265 2061 2070  e layers are a p
+00008700: 6169 6e20 746f 2068 616e 646c 6520 636f  ain to handle co
+00008710: 7272 6563 746c 7920 6265 6361 7573 6520  rrectly because 
+00008720: 6f66 0a20 2020 2023 2072 6f75 6e64 696e  of.    # roundin
+00008730: 6720 6973 7375 6573 2061 7420 7468 6520  g issues at the 
+00008740: 626f 7264 6572 7320 6f66 2074 696c 6573  borders of tiles
+00008750: 2e2e 2e20 736f 206a 7573 7420 6469 7373  ... so just diss
+00008760: 6f6c 7665 2074 6865 6d20 696e 206f 6e65  olve them in one
+00008770: 2067 6f2e 0a20 2020 2069 6620 280a 2020   go..    if (.  
+00008780: 2020 2020 2020 696e 7075 745f 6c61 7965        input_laye
+00008790: 7269 6e66 6f2e 6665 6174 7572 6563 6f75  rinfo.featurecou
+000087a0: 6e74 203d 3d20 300a 2020 2020 2020 2020  nt == 0.        
+000087b0: 6f72 2069 6e70 7574 5f6c 6179 6572 696e  or input_layerin
+000087c0: 666f 2e67 656f 6d65 7472 7974 7970 652e  fo.geometrytype.
+000087d0: 746f 5f70 7269 6d69 7469 7665 7479 7065  to_primitivetype
+000087e0: 0a20 2020 2020 2020 2069 6e20 5b0a 2020  .        in [.  
+000087f0: 2020 2020 2020 2020 2020 5072 696d 6974            Primit
+00008800: 6976 6554 7970 652e 504f 494e 542c 0a20  iveType.POINT,. 
+00008810: 2020 2020 2020 2020 2020 2050 7269 6d69             Primi
+00008820: 7469 7665 5479 7065 2e4c 494e 4553 5452  tiveType.LINESTR
+00008830: 494e 472c 0a20 2020 2020 2020 205d 0a20  ING,.        ]. 
+00008840: 2020 2029 3a0a 2020 2020 2020 2020 5f67     ):.        _g
+00008850: 656f 6f70 735f 7371 6c2e 6469 7373 6f6c  eoops_sql.dissol
+00008860: 7665 5f73 696e 676c 6574 6872 6561 6428  ve_singlethread(
+00008870: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00008880: 7574 5f70 6174 683d 696e 7075 745f 7061  ut_path=input_pa
+00008890: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+000088a0: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
+000088b0: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
+000088c0: 2020 2020 2065 7870 6c6f 6465 636f 6c6c       explodecoll
+000088d0: 6563 7469 6f6e 733d 6578 706c 6f64 6563  ections=explodec
+000088e0: 6f6c 6c65 6374 696f 6e73 2c0a 2020 2020  ollections,.    
+000088f0: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
+00008900: 636f 6c75 6d6e 733d 6772 6f75 7062 795f  columns=groupby_
+00008910: 636f 6c75 6d6e 732c 0a20 2020 2020 2020  columns,.       
+00008920: 2020 2020 2061 6767 5f63 6f6c 756d 6e73       agg_columns
+00008930: 3d61 6767 5f63 6f6c 756d 6e73 2c0a 2020  =agg_columns,.  
+00008940: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00008950: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
+00008960: 722c 0a20 2020 2020 2020 2020 2020 206f  r,.            o
+00008970: 7574 7075 745f 6c61 7965 723d 6f75 7470  utput_layer=outp
+00008980: 7574 5f6c 6179 6572 2c0a 2020 2020 2020  ut_layer,.      
+00008990: 2020 2020 2020 6772 6964 7369 7a65 3d67        gridsize=g
+000089a0: 7269 6473 697a 652c 0a20 2020 2020 2020  ridsize,.       
+000089b0: 2020 2020 206b 6565 705f 656d 7074 795f       keep_empty_
+000089c0: 6765 6f6d 733d 4661 6c73 652c 0a20 2020  geoms=False,.   
+000089d0: 2020 2020 2020 2020 2077 6865 7265 3d77           where=w
+000089e0: 6865 7265 2c0a 2020 2020 2020 2020 2020  here,.          
+000089f0: 2020 666f 7263 653d 666f 7263 652c 0a20    force=force,. 
+00008a00: 2020 2020 2020 2029 0a0a 2020 2020 656c         )..    el
+00008a10: 6966 2069 6e70 7574 5f6c 6179 6572 696e  if input_layerin
+00008a20: 666f 2e67 656f 6d65 7472 7974 7970 652e  fo.geometrytype.
+00008a30: 746f 5f70 7269 6d69 7469 7665 7479 7065  to_primitivetype
+00008a40: 2069 7320 5072 696d 6974 6976 6554 7970   is PrimitiveTyp
+00008a50: 652e 504f 4c59 474f 4e3a 0a20 2020 2020  e.POLYGON:.     
+00008a60: 2020 2023 2050 7265 7061 7265 2077 6865     # Prepare whe
+00008a70: 7265 0a20 2020 2020 2020 2069 6620 7768  re.        if wh
+00008a80: 6572 6520 6973 206e 6f74 204e 6f6e 653a  ere is not None:
+00008a90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008aa0: 7768 6572 6520 3d3d 2022 223a 0a20 2020  where == "":.   
+00008ab0: 2020 2020 2020 2020 2020 2020 2077 6865               whe
+00008ac0: 7265 203d 204e 6f6e 650a 2020 2020 2020  re = None.      
+00008ad0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00008ae0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+00008af0: 7420 6765 6f6d 6574 7279 636f 6c75 6d6e  t geometrycolumn
+00008b00: 2074 6f20 2267 656f 6d22 2c20 6265 6361   to "geom", beca
+00008b10: 7573 6520 7465 6d70 2066 696c 6573 2061  use temp files a
+00008b20: 7265 2073 6176 6564 2061 7320 6770 6b67  re saved as gpkg
+00008b30: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008b40: 2020 7768 6572 6520 3d20 7768 6572 652e    where = where.
+00008b50: 666f 726d 6174 2867 656f 6d65 7472 7963  format(geometryc
+00008b60: 6f6c 756d 6e3d 2267 656f 6d22 290a 0a20  olumn="geom").. 
+00008b70: 2020 2020 2020 2023 2049 6620 6120 7469         # If a ti
+00008b80: 6c65 735f 7061 7468 2069 7320 7370 6563  les_path is spec
+00008b90: 6966 6965 642c 2072 6561 6420 7468 6f73  ified, read thos
+00008ba0: 6520 7469 6c65 732e 2e2e 0a20 2020 2020  e tiles....     
+00008bb0: 2020 2072 6573 756c 745f 7469 6c65 735f     result_tiles_
+00008bc0: 6764 6620 3d20 4e6f 6e65 0a20 2020 2020  gdf = None.     
+00008bd0: 2020 2069 6620 7469 6c65 735f 7061 7468     if tiles_path
+00008be0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00008bf0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00008c00: 5f74 696c 6573 5f67 6466 203d 2067 666f  _tiles_gdf = gfo
+00008c10: 2e72 6561 645f 6669 6c65 2874 696c 6573  .read_file(tiles
+00008c20: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+00008c30: 2020 2069 6620 6e62 5f70 6172 616c 6c65     if nb_paralle
+00008c40: 6c20 3d3d 202d 313a 0a20 2020 2020 2020  l == -1:.       
+00008c50: 2020 2020 2020 2020 206e 625f 6370 7520           nb_cpu 
+00008c60: 3d20 6d75 6c74 6970 726f 6365 7373 696e  = multiprocessin
+00008c70: 672e 6370 755f 636f 756e 7428 290a 2020  g.cpu_count().  
+00008c80: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+00008c90: 5f70 6172 616c 6c65 6c20 3d20 6e62 5f63  _parallel = nb_c
+00008ca0: 7075 2020 2320 696e 7428 312e 3235 202a  pu  # int(1.25 *
+00008cb0: 206e 625f 6370 7529 0a20 2020 2020 2020   nb_cpu).       
+00008cc0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00008cd0: 6465 6275 6728 6622 4e62 2063 7075 7320  debug(f"Nb cpus 
+00008ce0: 666f 756e 643a 207b 6e62 5f63 7075 7d2c  found: {nb_cpu},
+00008cf0: 206e 625f 7061 7261 6c6c 656c 3a20 7b6e   nb_parallel: {n
+00008d00: 625f 7061 7261 6c6c 656c 7d22 290a 2020  b_parallel}").  
+00008d10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00008d20: 2020 2020 2020 2020 2320 456c 7365 2c20          # Else, 
+00008d30: 6372 6561 7465 2061 2067 7269 6420 6261  create a grid ba
+00008d40: 7365 6420 6f6e 2074 6865 206e 756d 6265  sed on the numbe
+00008d50: 7220 6f66 2074 696c 6573 2077 616e 7465  r of tiles wante
+00008d60: 6420 6173 2072 6573 756c 740a 2020 2020  d as result.    
+00008d70: 2020 2020 2020 2020 2320 5573 6520 6120          # Use a 
+00008d80: 6d61 7267 696e 206f 6620 3120 6d65 7465  margin of 1 mete
+00008d90: 7220 6172 6f75 6e64 2074 6865 2062 6f75  r around the bou
+00008da0: 6e64 730a 2020 2020 2020 2020 2020 2020  nds.            
+00008db0: 6d61 7267 696e 203d 2031 2e30 0a20 2020  margin = 1.0.   
+00008dc0: 2020 2020 2020 2020 2069 6620 696e 7075           if inpu
+00008dd0: 745f 6c61 7965 7269 6e66 6f2e 6372 7320  t_layerinfo.crs 
+00008de0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00008df0: 6e6f 7420 696e 7075 745f 6c61 7965 7269  not input_layeri
+00008e00: 6e66 6f2e 6372 732e 6973 5f70 726f 6a65  nfo.crs.is_proje
+00008e10: 6374 6564 3a0a 2020 2020 2020 2020 2020  cted:.          
+00008e20: 2020 2020 2020 2320 4966 2067 656f 6772        # If geogr
+00008e30: 6170 6869 6320 6372 732c 2031 2064 6567  aphic crs, 1 deg
+00008e40: 7265 6520 3d20 3131 3120 6b6d 206f 7220  ree = 111 km or 
+00008e50: 3131 3130 3030 206d 0a20 2020 2020 2020  111000 m.       
+00008e60: 2020 2020 2020 2020 206d 6172 6769 6e20           margin 
+00008e70: 2f3d 2031 3131 3030 300a 2020 2020 2020  /= 111000.      
+00008e80: 2020 2020 2020 626f 756e 6473 203d 2069        bounds = i
+00008e90: 6e70 7574 5f6c 6179 6572 696e 666f 2e74  nput_layerinfo.t
+00008ea0: 6f74 616c 5f62 6f75 6e64 730a 2020 2020  otal_bounds.    
+00008eb0: 2020 2020 2020 2020 626f 756e 6473 203d          bounds =
+00008ec0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00008ed0: 2020 2062 6f75 6e64 735b 305d 202d 206d     bounds[0] - m
+00008ee0: 6172 6769 6e2c 0a20 2020 2020 2020 2020  argin,.         
+00008ef0: 2020 2020 2020 2062 6f75 6e64 735b 315d         bounds[1]
+00008f00: 202d 206d 6172 6769 6e2c 0a20 2020 2020   - margin,.     
+00008f10: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
+00008f20: 735b 325d 202b 206d 6172 6769 6e2c 0a20  s[2] + margin,. 
+00008f30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00008f40: 6f75 6e64 735b 335d 202b 206d 6172 6769  ounds[3] + margi
+00008f50: 6e2c 0a20 2020 2020 2020 2020 2020 2029  n,.            )
+00008f60: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00008f70: 756c 745f 7469 6c65 735f 6764 6620 3d20  ult_tiles_gdf = 
+00008f80: 6772 6964 5f75 7469 6c2e 6372 6561 7465  grid_util.create
+00008f90: 5f67 7269 6432 280a 2020 2020 2020 2020  _grid2(.        
+00008fa0: 2020 2020 2020 2020 626f 756e 6473 2c20          bounds, 
+00008fb0: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
+00008fc0: 732c 2069 6e70 7574 5f6c 6179 6572 696e  s, input_layerin
+00008fd0: 666f 2e63 7273 0a20 2020 2020 2020 2020  fo.crs.         
+00008fe0: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
+00008ff0: 4170 706c 7920 6772 6964 7369 7a65 2074  Apply gridsize t
+00009000: 6f6c 6572 616e 6365 206f 6e20 7469 6c65  olerance on tile
+00009010: 732c 206f 7468 6572 7769 7365 2074 6865  s, otherwise the
+00009020: 2062 6f72 6465 7220 706f 6c79 676f 6e73   border polygons
+00009030: 2063 616e 2774 2062 650a 2020 2020 2020   can't be.      
+00009040: 2020 2320 756e 696f 6e65 6420 7072 6f70    # unioned prop
+00009050: 6572 6c79 2062 6563 6175 7365 2067 6170  erly because gap
+00009060: 7320 6170 7065 6172 2061 6674 6572 2072  s appear after r
+00009070: 6f75 6e64 696e 6720 636f 6f72 6469 6e61  ounding coordina
+00009080: 7465 732e 0a20 2020 2020 2020 2069 6620  tes..        if 
+00009090: 6772 6964 7369 7a65 2021 3d20 302e 303a  gridsize != 0.0:
+000090a0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+000090b0: 756c 745f 7469 6c65 735f 6764 662e 6765  ult_tiles_gdf.ge
+000090c0: 6f6d 6574 7279 203d 2073 6861 7065 6c79  ometry = shapely
+000090d0: 325f 6f72 5f70 7967 656f 732e 7365 745f  2_or_pygeos.set_
+000090e0: 7072 6563 6973 696f 6e28 0a20 2020 2020  precision(.     
+000090f0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00009100: 745f 7469 6c65 735f 6764 662e 6765 6f6d  t_tiles_gdf.geom
+00009110: 6574 7279 2e61 7272 6179 2e64 6174 612c  etry.array.data,
+00009120: 2067 7269 645f 7369 7a65 3d67 7269 6473   grid_size=grids
+00009130: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
+00009140: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
+00009150: 2872 6573 756c 745f 7469 6c65 735f 6764  (result_tiles_gd
+00009160: 6629 203e 2031 3a0a 2020 2020 2020 2020  f) > 1:.        
+00009170: 2020 2020 6766 6f2e 746f 5f66 696c 6528      gfo.to_file(
+00009180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009190: 2072 6573 756c 745f 7469 6c65 735f 6764   result_tiles_gd
+000091a0: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+000091b0: 2020 206f 7574 7075 745f 7061 7468 2e70     output_path.p
+000091c0: 6172 656e 7420 2f20 6622 7b6f 7574 7075  arent / f"{outpu
+000091d0: 745f 7061 7468 2e73 7465 6d7d 5f74 696c  t_path.stem}_til
+000091e0: 6573 2e67 706b 6722 2c0a 2020 2020 2020  es.gpkg",.      
+000091f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00009200: 2023 2049 6620 6120 7469 6c65 6420 7265   # If a tiled re
+00009210: 7375 6c74 2069 7320 6173 6b65 642c 2061  sult is asked, a
+00009220: 6464 2074 696c 655f 6964 2074 6f20 6772  dd tile_id to gr
+00009230: 6f75 7020 6f6e 2066 6f72 2074 6865 2072  oup on for the r
+00009240: 6573 756c 740a 2020 2020 2020 2020 6966  esult.        if
+00009250: 206c 656e 2872 6573 756c 745f 7469 6c65   len(result_tile
+00009260: 735f 6764 6629 203e 2031 3a0a 2020 2020  s_gdf) > 1:.    
+00009270: 2020 2020 2020 2020 7265 7375 6c74 5f74          result_t
+00009280: 696c 6573 5f67 6466 5b22 7469 6c65 5f69  iles_gdf["tile_i
+00009290: 6422 5d20 3d20 7265 7375 6c74 5f74 696c  d"] = result_til
+000092a0: 6573 5f67 6466 2e72 6573 6574 5f69 6e64  es_gdf.reset_ind
+000092b0: 6578 2829 2e69 6e64 6578 0a0a 2020 2020  ex().index..    
+000092c0: 2020 2020 2320 5468 6520 6469 7373 6f6c      # The dissol
+000092d0: 7665 2066 6f72 2070 6f6c 7967 6f6e 7320  ve for polygons 
+000092e0: 6973 2064 6f6e 6520 696e 2073 6576 6572  is done in sever
+000092f0: 616c 2070 6173 7365 732c 2061 6e64 2061  al passes, and a
+00009300: 6674 6572 2074 6865 2066 6972 7374 0a20  fter the first. 
+00009310: 2020 2020 2020 2023 2070 6173 732c 206f         # pass, o
+00009320: 6e6c 7920 7468 6520 276f 6e62 6f72 6465  nly the 'onborde
+00009330: 7227 2066 6561 7475 7265 7320 6172 6520  r' features are 
+00009340: 6675 7274 6865 7220 6469 7373 6f6c 7665  further dissolve
+00009350: 642c 2061 7320 7468 650a 2020 2020 2020  d, as the.      
+00009360: 2020 2320 276e 6f74 6f6e 626f 7264 6572    # 'notonborder
+00009370: 2720 6665 6174 7572 6573 2061 7265 2061  ' features are a
+00009380: 6c72 6561 6479 204f 4b2e 0a20 2020 2020  lready OK..     
+00009390: 2020 2074 656d 7064 6972 203d 205f 696f     tempdir = _io
+000093a0: 5f75 7469 6c2e 6372 6561 7465 5f74 656d  _util.create_tem
+000093b0: 7064 6972 2866 2267 656f 6669 6c65 6f70  pdir(f"geofileop
+000093c0: 732f 7b6f 7065 7261 7469 6f6e 7d22 290a  s/{operation}").
+000093d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000093e0: 2020 2020 2020 2020 2069 6620 6f75 7470           if outp
+000093f0: 7574 5f6c 6179 6572 2069 7320 4e6f 6e65  ut_layer is None
+00009400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009410: 2020 6f75 7470 7574 5f6c 6179 6572 203d    output_layer =
+00009420: 2067 666f 2e67 6574 5f64 6566 6175 6c74   gfo.get_default
+00009430: 5f6c 6179 6572 286f 7574 7075 745f 7061  _layer(output_pa
+00009440: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00009450: 6f75 7470 7574 5f74 6d70 5f70 6174 6820  output_tmp_path 
+00009460: 3d20 7465 6d70 6469 7220 2f20 226f 7574  = tempdir / "out
+00009470: 7075 745f 746d 702e 6770 6b67 220a 2020  put_tmp.gpkg".  
+00009480: 2020 2020 2020 2020 2020 7072 6576 5f6e            prev_n
+00009490: 625f 6261 7463 6865 7320 3d20 4e6f 6e65  b_batches = None
+000094a0: 0a20 2020 2020 2020 2020 2020 206c 6173  .            las
+000094b0: 745f 7061 7373 203d 2046 616c 7365 0a20  t_pass = False. 
+000094c0: 2020 2020 2020 2020 2020 2070 6173 735f             pass_
+000094d0: 6964 203d 2030 0a20 2020 2020 2020 2020  id = 0.         
+000094e0: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
+000094f0: 2253 7461 7274 2064 6973 736f 6c76 6520  "Start dissolve 
+00009500: 6f6e 2066 696c 6520 7b69 6e70 7574 5f70  on file {input_p
+00009510: 6174 687d 2229 0a20 2020 2020 2020 2020  ath}").         
+00009520: 2020 2069 6e70 7574 5f70 6173 735f 6c61     input_pass_la
+00009530: 7965 7220 3d20 696e 7075 745f 6c61 7965  yer = input_laye
+00009540: 720a 2020 2020 2020 2020 2020 2020 7768  r.            wh
+00009550: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
+00009560: 2020 2020 2020 2020 2020 2320 4765 7420            # Get 
+00009570: 696e 666f 206f 6620 7468 6520 6375 7272  info of the curr
+00009580: 656e 7420 6669 6c65 2074 6861 7420 6e65  ent file that ne
+00009590: 6564 7320 746f 2062 6520 6469 7373 6f6c  eds to be dissol
+000095a0: 7665 640a 2020 2020 2020 2020 2020 2020  ved.            
+000095b0: 2020 2020 696e 7075 745f 7061 7373 5f6c      input_pass_l
+000095c0: 6179 6572 696e 666f 203d 2067 666f 2e67  ayerinfo = gfo.g
+000095d0: 6574 5f6c 6179 6572 696e 666f 2869 6e70  et_layerinfo(inp
+000095e0: 7574 5f70 6174 682c 2069 6e70 7574 5f70  ut_path, input_p
+000095f0: 6173 735f 6c61 7965 7229 0a20 2020 2020  ass_layer).     
+00009600: 2020 2020 2020 2020 2020 206e 625f 726f             nb_ro
+00009610: 7773 5f74 6f74 616c 203d 2069 6e70 7574  ws_total = input
+00009620: 5f70 6173 735f 6c61 7965 7269 6e66 6f2e  _pass_layerinfo.
+00009630: 6665 6174 7572 6563 6f75 6e74 0a0a 2020  featurecount..  
+00009640: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009650: 4361 6c63 756c 6174 6520 7468 6520 6265  Calculate the be
+00009660: 7374 206e 756d 6265 7220 6f66 2070 6172  st number of par
+00009670: 616c 6c65 6c20 7072 6f63 6573 7365 7320  allel processes 
+00009680: 616e 6420 6261 7463 6865 7320 666f 720a  and batches for.
+00009690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096a0: 2320 7468 6520 6176 6169 6c61 626c 6520  # the available 
+000096b0: 7265 736f 7572 6365 7320 666f 7220 7468  resources for th
+000096c0: 6520 6375 7272 656e 7420 7061 7373 0a20  e current pass. 
+000096d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000096e0: 6620 6261 7463 6873 697a 6520 3e20 303a  f batchsize > 0:
+000096f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009700: 2020 2020 2070 6172 616c 6c65 6c69 7a61       paralleliza
+00009710: 7469 6f6e 5f63 6f6e 6669 6720 3d20 5061  tion_config = Pa
+00009720: 7261 6c6c 656c 697a 6174 696f 6e43 6f6e  rallelizationCon
+00009730: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
+00009740: 2020 2020 2020 2020 2020 2020 206d 696e               min
+00009750: 5f61 7667 5f72 6f77 735f 7065 725f 6261  _avg_rows_per_ba
+00009760: 7463 683d 696e 7428 6d61 7468 2e63 6569  tch=int(math.cei
+00009770: 6c28 6261 7463 6873 697a 6520 2f20 3229  l(batchsize / 2)
+00009780: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00009790: 2020 2020 2020 2020 2020 206d 6178 5f61             max_a
+000097a0: 7667 5f72 6f77 735f 7065 725f 6261 7463  vg_rows_per_batc
+000097b0: 683d 6261 7463 6873 697a 652c 0a20 2020  h=batchsize,.   
+000097c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000097e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000097f0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+00009800: 616c 6c65 6c69 7a61 7469 6f6e 5f63 6f6e  allelization_con
+00009810: 6669 6720 3d20 5061 7261 6c6c 656c 697a  fig = Paralleliz
+00009820: 6174 696f 6e43 6f6e 6669 6728 290a 2020  ationConfig().  
+00009830: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+00009840: 5f70 6172 616c 6c65 6c2c 206e 625f 6261  _parallel, nb_ba
+00009850: 7463 6865 735f 7265 636f 6d6d 656e 6465  tches_recommende
+00009860: 642c 205f 203d 2067 6574 5f70 6172 616c  d, _ = get_paral
+00009870: 6c65 6c69 7a61 7469 6f6e 5f70 6172 616d  lelization_param
+00009880: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00009890: 2020 2020 2020 206e 625f 726f 7773 5f74         nb_rows_t
+000098a0: 6f74 616c 3d6e 625f 726f 7773 5f74 6f74  otal=nb_rows_tot
+000098b0: 616c 2c0a 2020 2020 2020 2020 2020 2020  al,.            
+000098c0: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
+000098d0: 6c65 6c3d 6e62 5f70 6172 616c 6c65 6c2c  lel=nb_parallel,
+000098e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000098f0: 2020 2020 206e 625f 6261 7463 6865 735f       nb_batches_
+00009900: 7072 6576 696f 7573 5f70 6173 733d 7072  previous_pass=pr
+00009910: 6576 5f6e 625f 6261 7463 6865 732c 0a20  ev_nb_batches,. 
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
+00009940: 6f6e 5f63 6f6e 6669 673d 7061 7261 6c6c  on_config=parall
+00009950: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
+00009960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009970: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00009980: 2020 2020 2023 2049 6620 7468 6520 6964       # If the id
+00009990: 6561 6c20 6e75 6d62 6572 206f 6620 6261  eal number of ba
+000099a0: 7463 6865 7320 6973 2063 6c6f 7365 2074  tches is close t
+000099b0: 6f20 7468 6520 6e62 2e20 7265 7375 6c74  o the nb. result
+000099c0: 2074 696c 6573 2061 736b 6564 2c0a 2020   tiles asked,.  
+000099d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000099e0: 6469 7373 6f6c 7665 2074 6f77 6172 6473  dissolve towards
+000099f0: 2074 6865 2061 736b 6564 2072 6573 756c   the asked resul
+00009a00: 7421 0a20 2020 2020 2020 2020 2020 2020  t!.             
+00009a10: 2020 2023 2049 6620 6e6f 742c 2061 2074     # If not, a t
+00009a20: 656d 706f 7261 7279 2072 6573 756c 7420  emporary result 
+00009a30: 6973 2063 7265 6174 6564 2075 7369 6e67  is created using
+00009a40: 2073 6d61 6c6c 6572 2074 696c 6573 0a20   smaller tiles. 
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00009a60: 6620 6e62 5f62 6174 6368 6573 5f72 6563  f nb_batches_rec
+00009a70: 6f6d 6d65 6e64 6564 203c 3d20 6c65 6e28  ommended <= len(
+00009a80: 7265 7375 6c74 5f74 696c 6573 5f67 6466  result_tiles_gdf
+00009a90: 2920 2a20 312e 313a 0a20 2020 2020 2020  ) * 1.1:.       
+00009aa0: 2020 2020 2020 2020 2020 2020 2074 696c               til
+00009ab0: 6573 5f67 6466 203d 2072 6573 756c 745f  es_gdf = result_
+00009ac0: 7469 6c65 735f 6764 660a 2020 2020 2020  tiles_gdf.      
+00009ad0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00009ae0: 7374 5f70 6173 7320 3d20 5472 7565 0a20  st_pass = True. 
+00009af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b00: 2020 206e 625f 7061 7261 6c6c 656c 203d     nb_parallel =
+00009b10: 206d 696e 286c 656e 2872 6573 756c 745f   min(len(result_
+00009b20: 7469 6c65 735f 6764 6629 2c20 6e62 5f70  tiles_gdf), nb_p
+00009b30: 6172 616c 6c65 6c29 0a20 2020 2020 2020  arallel).       
+00009b40: 2020 2020 2020 2020 2065 6c69 6620 6c65           elif le
+00009b50: 6e28 7265 7375 6c74 5f74 696c 6573 5f67  n(result_tiles_g
+00009b60: 6466 2920 3d3d 2031 3a0a 2020 2020 2020  df) == 1:.      
+00009b70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009b80: 4372 6561 7465 2061 2067 7269 6420 6261  Create a grid ba
+00009b90: 7365 6420 6f6e 2074 6865 2069 6465 616c  sed on the ideal
+00009ba0: 206e 756d 6265 7220 6f66 2062 6174 6368   number of batch
+00009bb0: 6573 2c20 6275 7420 6d61 6b65 0a20 2020  es, but make.   
+00009bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bd0: 2023 2073 7572 6520 7468 6520 6e75 6d62   # sure the numb
+00009be0: 6572 2069 7320 736d 616c 6c65 7220 7468  er is smaller th
+00009bf0: 616e 2074 6865 206d 6178 696d 756d 2e2e  an the maximum..
+00009c00: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009c10: 2020 2020 2020 6e62 5f73 7175 6172 6973        nb_squaris
+00009c20: 685f 7469 6c65 735f 6d61 7820 3d20 4e6f  h_tiles_max = No
+00009c30: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00009c40: 2020 2020 2020 2069 6620 7072 6576 5f6e         if prev_n
+00009c50: 625f 6261 7463 6865 7320 6973 206e 6f74  b_batches is not
+00009c60: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00009c70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00009c80: 625f 7371 7561 7269 7368 5f74 696c 6573  b_squarish_tiles
+00009c90: 5f6d 6178 203d 206d 6178 2870 7265 765f  _max = max(prev_
+00009ca0: 6e62 5f62 6174 6368 6573 202d 2031 2c20  nb_batches - 1, 
+00009cb0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+00009cc0: 2020 2020 2020 2074 696c 6573 5f67 6466         tiles_gdf
+00009cd0: 203d 2067 7269 645f 7574 696c 2e63 7265   = grid_util.cre
+00009ce0: 6174 655f 6772 6964 3228 0a20 2020 2020  ate_grid2(.     
+00009cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d00: 2020 2074 6f74 616c 5f62 6f75 6e64 733d     total_bounds=
+00009d10: 696e 7075 745f 7061 7373 5f6c 6179 6572  input_pass_layer
+00009d20: 696e 666f 2e74 6f74 616c 5f62 6f75 6e64  info.total_bound
+00009d30: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00009d40: 2020 2020 2020 2020 2020 206e 625f 7371             nb_sq
+00009d50: 7561 7269 7368 5f74 696c 6573 3d6e 625f  uarish_tiles=nb_
+00009d60: 6261 7463 6865 735f 7265 636f 6d6d 656e  batches_recommen
+00009d70: 6465 642c 0a20 2020 2020 2020 2020 2020  ded,.           
+00009d80: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
+00009d90: 7371 7561 7269 7368 5f74 696c 6573 5f6d  squarish_tiles_m
+00009da0: 6178 3d6e 625f 7371 7561 7269 7368 5f74  ax=nb_squarish_t
+00009db0: 696c 6573 5f6d 6178 2c0a 2020 2020 2020  iles_max,.      
+00009dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009dd0: 2020 6372 733d 696e 7075 745f 7061 7373    crs=input_pass
+00009de0: 5f6c 6179 6572 696e 666f 2e63 7273 2c0a  _layerinfo.crs,.
+00009df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00009e10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e30: 2320 4966 2061 2067 7269 6420 6973 2073  # If a grid is s
+00009e40: 7065 6369 6669 6564 2061 6c72 6561 6479  pecified already
+00009e50: 2c20 6164 6420 6578 7472 6120 636f 6c75  , add extra colu
+00009e60: 6d6e 732f 726f 7773 2069 6e73 7465 6164  mns/rows instead
+00009e70: 206f 660a 2020 2020 2020 2020 2020 2020   of.            
+00009e80: 2020 2020 2020 2020 2320 6372 6561 7469          # creati
+00009e90: 6e67 206e 6577 206f 6e65 2e2e 2e0a 2020  ng new one....  
+00009ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009eb0: 2020 7469 6c65 735f 6764 6620 3d20 6772    tiles_gdf = gr
+00009ec0: 6964 5f75 7469 6c2e 7370 6c69 745f 7469  id_util.split_ti
+00009ed0: 6c65 7328 0a20 2020 2020 2020 2020 2020  les(.           
+00009ee0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00009ef0: 756c 745f 7469 6c65 735f 6764 662c 206e  ult_tiles_gdf, n
+00009f00: 625f 6261 7463 6865 735f 7265 636f 6d6d  b_batches_recomm
+00009f10: 656e 6465 640a 2020 2020 2020 2020 2020  ended.          
+00009f20: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00009f30: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+00009f40: 7070 6c79 2067 7269 6473 697a 6520 746f  pply gridsize to
+00009f50: 6c65 7261 6e63 6520 6f6e 2074 696c 6573  lerance on tiles
+00009f60: 2c20 6f74 6865 7277 6973 6520 7468 6520  , otherwise the 
+00009f70: 626f 7264 6572 2070 6f6c 7967 6f6e 7320  border polygons 
+00009f80: 6361 6e27 740a 2020 2020 2020 2020 2020  can't.          
+00009f90: 2020 2020 2020 2320 6265 2075 6e69 6f6e        # be union
+00009fa0: 6564 2070 726f 7065 726c 7920 6265 6361  ed properly beca
+00009fb0: 7573 6520 6761 7073 2061 7070 6561 7220  use gaps appear 
+00009fc0: 6166 7465 7220 726f 756e 6469 6e67 2063  after rounding c
+00009fd0: 6f6f 7264 696e 6174 6573 2e0a 2020 2020  oordinates..    
+00009fe0: 2020 2020 2020 2020 2020 2020 6966 2067              if g
+00009ff0: 7269 6473 697a 6520 213d 2030 2e30 3a0a  ridsize != 0.0:.
+0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a010: 2020 2020 7469 6c65 735f 6764 662e 6765      tiles_gdf.ge
+0000a020: 6f6d 6574 7279 203d 2073 6861 7065 6c79  ometry = shapely
+0000a030: 325f 6f72 5f70 7967 656f 732e 7365 745f  2_or_pygeos.set_
+0000a040: 7072 6563 6973 696f 6e28 0a20 2020 2020  precision(.     
 0000a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a060: 2020 2020 2020 2263 6f75 6e74 222c 0a20        "count",. 
-0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a080: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000a090: 7375 6d22 2c0a 2020 2020 2020 2020 2020  sum",.          
-0000a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0b0: 2020 2020 2020 226d 696e 222c 0a20 2020        "min",.   
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0d0: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
-0000a0e0: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
-0000a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a100: 2020 2020 226d 6564 6961 6e22 2c0a 2020      "median",.  
-0000a110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a120: 2020 2020 2020 2020 2020 5d3a 0a20 2020            ]:.   
-0000a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a140: 2020 2020 2020 2020 2020 2020 2061 6767               agg
-0000a150: 7265 6761 7469 6f6e 5f73 7472 203d 2061  regation_str = a
-0000a160: 6767 5f63 6f6c 756d 6e5b 2261 6767 225d  gg_column["agg"]
-0000a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a180: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0000a190: 6620 6167 675f 636f 6c75 6d6e 5b22 6167  f agg_column["ag
-0000a1a0: 6722 5d2e 6c6f 7765 7228 2920 696e 205b  g"].lower() in [
-0000a1b0: 226d 6561 6e22 2c20 2261 7667 225d 3a0a  "mean", "avg"]:.
-0000a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1e0: 6167 6772 6567 6174 696f 6e5f 7374 7220  aggregation_str 
-0000a1f0: 3d20 2261 7667 220a 2020 2020 2020 2020  = "avg".        
-0000a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a210: 2020 2020 656c 6966 2061 6767 5f63 6f6c      elif agg_col
-0000a220: 756d 6e5b 2261 6767 225d 2e6c 6f77 6572  umn["agg"].lower
-0000a230: 2829 203d 3d20 2263 6f6e 6361 7422 3a0a  () == "concat":.
-0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a260: 6167 6772 6567 6174 696f 6e5f 7374 7220  aggregation_str 
-0000a270: 3d20 2267 726f 7570 5f63 6f6e 6361 7422  = "group_concat"
-0000a280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2a0: 2069 6620 2273 6570 2220 696e 2061 6767   if "sep" in agg
-0000a2b0: 5f63 6f6c 756d 6e3a 0a20 2020 2020 2020  _column:.       
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-0000a2e0: 7261 5f70 6172 616d 5f73 7472 203d 2066  ra_param_str = f
-0000a2f0: 222c 2027 7b61 6767 5f63 6f6c 756d 6e5b  ", '{agg_column[
-0000a300: 2773 6570 275d 7d27 220a 2020 2020 2020  'sep']}'".      
-0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a320: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a340: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000a350: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 6622 6167 6772 6567 6174 696f 6e20    f"aggregation 
-0000a390: 7b61 6767 5f63 6f6c 756d 6e5b 2761 6767  {agg_column['agg
-0000a3a0: 275d 7d20 6973 206e 6f74 2073 7570 706f  ']} is not suppo
-0000a3b0: 7274 6564 220a 2020 2020 2020 2020 2020  rted".          
-0000a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3f0: 2020 2020 2023 2049 6620 6469 7374 696e       # If distin
-0000a400: 6374 2069 7320 7370 6563 6966 6965 642c  ct is specified,
-0000a410: 2061 6464 2074 6865 2064 6973 7469 6e63   add the distinc
-0000a420: 7420 6b65 7977 6f72 640a 2020 2020 2020  t keyword.      
+0000a060: 2020 2074 696c 6573 5f67 6466 2e67 656f     tiles_gdf.geo
+0000a070: 6d65 7472 792e 6172 7261 792e 6461 7461  metry.array.data
+0000a080: 2c20 6772 6964 5f73 697a 653d 6772 6964  , grid_size=grid
+0000a090: 7369 7a65 0a20 2020 2020 2020 2020 2020  size.           
+0000a0a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000a0b0: 2020 2020 2020 2020 2020 2067 666f 2e74             gfo.t
+0000a0c0: 6f5f 6669 6c65 2874 696c 6573 5f67 6466  o_file(tiles_gdf
+0000a0d0: 2c20 7465 6d70 6469 7220 2f20 6622 6f75  , tempdir / f"ou
+0000a0e0: 7470 7574 5f7b 7061 7373 5f69 647d 5f74  tput_{pass_id}_t
+0000a0f0: 696c 6573 2e67 706b 6722 290a 0a20 2020  iles.gpkg")..   
+0000a100: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000a110: 6620 7468 6520 6e75 6d62 6572 206f 6620  f the number of 
+0000a120: 7469 6c65 7320 656e 6473 2075 7020 6173  tiles ends up as
+0000a130: 2031 2c20 6974 2069 7320 7468 6520 6c61   1, it is the la
+0000a140: 7374 2070 6173 7320 616e 7977 6179 2e2e  st pass anyway..
+0000a150: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000a160: 2020 6966 206c 656e 2874 696c 6573 5f67    if len(tiles_g
+0000a170: 6466 2920 3d3d 2031 3a0a 2020 2020 2020  df) == 1:.      
+0000a180: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0000a190: 7374 5f70 6173 7320 3d20 5472 7565 0a0a  st_pass = True..
+0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1b0: 2320 4966 2077 6520 6172 6520 6e6f 7420  # If we are not 
+0000a1c0: 696e 2074 6865 206c 6173 7420 7061 7373  in the last pass
+0000a1d0: 2c20 6f6e 626f 7264 6572 2070 6172 6365  , onborder parce
+0000a1e0: 6c73 2077 696c 6c20 6e65 6564 2065 7874  ls will need ext
+0000a1f0: 7261 0a20 2020 2020 2020 2020 2020 2020  ra.             
+0000a200: 2020 2023 2070 726f 6365 7373 696e 6720     # processing 
+0000a210: 7374 696c 6c20 696e 2066 7572 7468 6572  still in further
+0000a220: 2070 6173 7365 732c 2073 6f20 6172 6520   passes, so are 
+0000a230: 7361 7665 6420 696e 2061 2073 6570 6572  saved in a seper
+0000a240: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+0000a250: 2020 2020 2320 6766 6f2e 2054 6865 206e      # gfo. The n
+0000a260: 6f74 6f6e 626f 7264 6572 2072 6f77 7320  otonborder rows 
+0000a270: 6172 6520 6669 6e61 6c20 696d 6d65 6469  are final immedi
+0000a280: 6174 656c 790a 2020 2020 2020 2020 2020  ately.          
+0000a290: 2020 2020 2020 6966 206c 6173 745f 7061        if last_pa
+0000a2a0: 7373 2069 7320 6e6f 7420 5472 7565 3a0a  ss is not True:.
+0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2c0: 2020 2020 6f75 7470 7574 5f74 6d70 5f6f      output_tmp_o
+0000a2d0: 6e62 6f72 6465 725f 7061 7468 203d 2028  nborder_path = (
+0000a2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a2f0: 2020 2020 2020 2020 2074 656d 7064 6972           tempdir
+0000a300: 202f 2066 226f 7574 7075 745f 7b70 6173   / f"output_{pas
+0000a310: 735f 6964 7d5f 6f6e 626f 7264 6572 2e67  s_id}_onborder.g
+0000a320: 706b 6722 0a20 2020 2020 2020 2020 2020  pkg".           
+0000a330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000a340: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000a350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a360: 2020 2020 206f 7574 7075 745f 746d 705f       output_tmp_
+0000a370: 6f6e 626f 7264 6572 5f70 6174 6820 3d20  onborder_path = 
+0000a380: 6f75 7470 7574 5f74 6d70 5f70 6174 680a  output_tmp_path.
+0000a390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a3a0: 2023 204e 6f77 2067 6f21 0a20 2020 2020   # Now go!.     
+0000a3b0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000a3c0: 722e 696e 666f 2866 2253 7461 7274 2064  r.info(f"Start d
+0000a3d0: 6973 736f 6c76 6520 7061 7373 207b 7061  issolve pass {pa
+0000a3e0: 7373 5f69 647d 2074 6f20 7b6c 656e 2874  ss_id} to {len(t
+0000a3f0: 696c 6573 5f67 6466 297d 2074 696c 6573  iles_gdf)} tiles
+0000a400: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0000a410: 2020 205f 203d 205f 6469 7373 6f6c 7665     _ = _dissolve
+0000a420: 5f70 6f6c 7967 6f6e 735f 7061 7373 280a  _polygons_pass(.
 0000a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a440: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a460: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-0000a470: 696e 6374 2220 696e 2061 6767 5f63 6f6c  inct" in agg_col
-0000a480: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
-0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4a0: 2020 2020 616e 6420 6167 675f 636f 6c75      and agg_colu
-0000a4b0: 6d6e 5b22 6469 7374 696e 6374 225d 2069  mn["distinct"] i
-0000a4c0: 7320 5472 7565 0a20 2020 2020 2020 2020  s True.         
-0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4e0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0000a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a500: 2020 2020 2020 6469 7374 696e 6374 5f73        distinct_s
-0000a510: 7472 203d 2022 4449 5354 494e 4354 2022  tr = "DISTINCT "
-0000a520: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000a530: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000a540: 5072 6570 6172 6520 636f 6c75 6d6e 206e  Prepare column n
-0000a550: 616d 6520 7374 7269 6e67 2e0a 2020 2020  ame string..    
-0000a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a570: 2020 2020 2020 2020 636f 6c75 6d6e 5f73          column_s
-0000a580: 7472 203d 2028 0a20 2020 2020 2020 2020  tr = (.         
-0000a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5a0: 2020 2020 2020 2022 6a73 6f6e 5f65 7874         "json_ext
-0000a5b0: 7261 6374 286a 736f 6e5f 6461 7461 2e6a  ract(json_data.j
-0000a5c0: 736f 6e5f 726f 772c 2022 0a20 2020 2020  son_row, ".     
-0000a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5e0: 2020 2020 2020 2020 2020 2066 2722 242e             f'"$.
-0000a5f0: 7b61 6767 5f63 6f6c 756d 6e5b 2263 6f6c  {agg_column["col
-0000a600: 756d 6e22 5d7d 2229 270a 2020 2020 2020  umn"]}")'.      
-0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a620: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a640: 2020 2020 2023 204e 6f77 2070 7574 2065       # Now put e
-0000a650: 7665 7279 7468 696e 6720 746f 6765 7468  verything togeth
-0000a660: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0000a670: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000a680: 6767 5f63 6f6c 756d 6e73 5f73 7472 202b  gg_columns_str +
-0000a690: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0000a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6b0: 2020 2020 6622 2c20 7b61 6767 7265 6761      f", {aggrega
-0000a6c0: 7469 6f6e 5f73 7472 7d28 7b64 6973 7469  tion_str}({disti
-0000a6d0: 6e63 745f 7374 727d 7b63 6f6c 756d 6e5f  nct_str}{column_
-0000a6e0: 7374 727d 220a 2020 2020 2020 2020 2020  str}".          
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a700: 2020 2020 2020 6627 7b65 7874 7261 5f70        f'{extra_p
-0000a710: 6172 616d 5f73 7472 7d29 2041 5320 227b  aram_str}) AS "{
-0000a720: 6167 675f 636f 6c75 6d6e 5b22 6173 225d  agg_column["as"]
-0000a730: 7d22 270a 2020 2020 2020 2020 2020 2020  }"'.            
-0000a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a750: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000a760: 2020 2023 2041 6464 2061 2063 6f6c 756d     # Add a colum
-0000a770: 6e20 746f 206f 7264 6572 2074 6865 2072  n to order the r
-0000a780: 6573 756c 7420 6279 2074 6f20 6576 6164  esult by to evad
-0000a790: 6520 6861 7669 6e67 2061 6c6c 0a20 2020  e having all.   
-0000a7a0: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-0000a7b0: 6f6d 706c 6578 2067 656f 6d65 7472 6965  omplex geometrie
-0000a7c0: 7320 746f 6765 7468 6572 2069 6e20 7468  s together in th
-0000a7d0: 6520 6f75 7470 7574 2066 696c 652e 0a20  e output file.. 
-0000a7e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000a7f0: 7264 6572 6279 5f63 6f6c 756d 6e20 3d20  rderby_column = 
-0000a800: 2274 656d 705f 6f72 6465 7263 6f6c 756d  "temp_ordercolum
-0000a810: 6e5f 6765 6f68 6173 6822 0a20 2020 2020  n_geohash".     
-0000a820: 2020 2020 2020 2020 2020 205f 6164 645f             _add_
-0000a830: 6f72 6465 7262 795f 636f 6c75 6d6e 280a  orderby_column(.
-0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a850: 2020 2020 7061 7468 3d6f 7574 7075 745f      path=output_
-0000a860: 746d 705f 7061 7468 2c20 6c61 7965 723d  tmp_path, layer=
-0000a870: 6f75 7470 7574 5f6c 6179 6572 2c20 6e61  output_layer, na
-0000a880: 6d65 3d6f 7264 6572 6279 5f63 6f6c 756d  me=orderby_colum
-0000a890: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0000a8a0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0000a8b0: 2020 2020 2023 2050 7265 7061 7265 2053       # Prepare S
-0000a8c0: 514c 2073 7461 7465 6d65 6e74 2066 6f72  QL statement for
-0000a8d0: 2066 696e 616c 206f 7574 7075 7420 6669   final output fi
-0000a8e0: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
-0000a8f0: 2020 2020 2320 416c 6c20 7469 6c65 7320      # All tiles 
-0000a900: 6172 6520 616c 7265 6164 7920 6469 7373  are already diss
-0000a910: 6f6c 7665 6420 746f 2067 726f 7570 732c  olved to groups,
-0000a920: 2062 7574 206e 6f77 2074 6865 0a20 2020   but now the.   
-0000a930: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-0000a940: 6573 756c 7473 2066 726f 6d20 616c 6c20  esults from all 
-0000a950: 7469 6c65 7320 7374 696c 6c20 6e65 6564  tiles still need
-0000a960: 2074 6f20 6265 0a20 2020 2020 2020 2020   to be.         
-0000a970: 2020 2020 2020 2023 2067 726f 7570 6564         # grouped
-0000a980: 2f63 6f6c 6c65 6374 6564 2074 6f67 6574  /collected toget
-0000a990: 6865 722e 0a20 2020 2020 2020 2020 2020  her..           
-0000a9a0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0000a9b0: 2822 506f 7374 7072 6f63 6573 7320 7072  ("Postprocess pr
-0000a9c0: 6570 6172 6564 2066 6561 7475 7265 732e  epared features.
-0000a9d0: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
-0000a9e0: 2020 2020 2069 6620 6167 675f 636f 6c75       if agg_colu
-0000a9f0: 6d6e 7320 6973 204e 6f6e 653a 0a20 2020  mns is None:.   
-0000aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa10: 2023 2049 6620 7468 6572 6520 6172 6520   # If there are 
-0000aa20: 6e6f 2061 6767 7265 6761 7469 6f6e 2063  no aggregation c
-0000aa30: 6f6c 756d 6e73 2c20 7468 696e 6773 2061  olumns, things a
-0000aa40: 7265 206e 6f74 2074 6f6f 0a20 2020 2020  re not too.     
-0000aa50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000aa60: 2063 6f6d 706c 6963 6174 6564 2e0a 2020   complicated..  
-0000aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa80: 2020 6966 2065 7870 6c6f 6465 636f 6c6c    if explodecoll
-0000aa90: 6563 7469 6f6e 7320 6973 2054 7275 653a  ections is True:
-0000aaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aab0: 2020 2020 2020 2020 2023 2049 6620 6578           # If ex
-0000aac0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-0000aad0: 2069 7320 7472 7565 2c20 6974 2069 7320   is true, it is 
-0000aae0: 7573 656c 6573 7320 746f 0a20 2020 2020  useless to.     
+0000a440: 2020 2020 696e 7075 745f 7061 7468 3d69      input_path=i
+0000a450: 6e70 7574 5f70 6174 682c 0a20 2020 2020  nput_path,.     
+0000a460: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000a470: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
+0000a480: 725f 7061 7468 3d6f 7574 7075 745f 746d  r_path=output_tm
+0000a490: 705f 7061 7468 2c0a 2020 2020 2020 2020  p_path,.        
+0000a4a0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000a4b0: 7574 5f6f 6e62 6f72 6465 725f 7061 7468  ut_onborder_path
+0000a4c0: 3d6f 7574 7075 745f 746d 705f 6f6e 626f  =output_tmp_onbo
+0000a4d0: 7264 6572 5f70 6174 682c 0a20 2020 2020  rder_path,.     
+0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000a4f0: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+0000a500: 733d 6578 706c 6f64 6563 6f6c 6c65 6374  s=explodecollect
+0000a510: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0000a520: 2020 2020 2020 2020 2020 6772 6f75 7062            groupb
+0000a530: 795f 636f 6c75 6d6e 733d 6772 6f75 7062  y_columns=groupb
+0000a540: 795f 636f 6c75 6d6e 732c 0a20 2020 2020  y_columns,.     
+0000a550: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000a560: 6767 5f63 6f6c 756d 6e73 3d61 6767 5f63  gg_columns=agg_c
+0000a570: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
+0000a580: 2020 2020 2020 2020 2020 2020 7469 6c65              tile
+0000a590: 735f 6764 663d 7469 6c65 735f 6764 662c  s_gdf=tiles_gdf,
+0000a5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a5b0: 2020 2020 2069 6e70 7574 5f6c 6179 6572       input_layer
+0000a5c0: 3d69 6e70 7574 5f70 6173 735f 6c61 7965  =input_pass_laye
+0000a5d0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000a5e0: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
+0000a5f0: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
+0000a600: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a610: 2020 2020 2020 6772 6964 7369 7a65 3d67        gridsize=g
+0000a620: 7269 6473 697a 652c 0a20 2020 2020 2020  ridsize,.       
+0000a630: 2020 2020 2020 2020 2020 2020 206b 6565               kee
+0000a640: 705f 656d 7074 795f 6765 6f6d 733d 4661  p_empty_geoms=Fa
+0000a650: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+0000a660: 2020 2020 2020 2020 206e 625f 7061 7261           nb_para
+0000a670: 6c6c 656c 3d6e 625f 7061 7261 6c6c 656c  llel=nb_parallel
+0000a680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a690: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000a6a0: 2020 2020 2023 2050 7265 7061 7265 2074       # Prepare t
+0000a6b0: 6865 206e 6578 7420 7061 7373 0a20 2020  he next pass.   
+0000a6c0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0000a6d0: 6865 2069 6e70 7574 2070 6174 6820 6973  he input path is
+0000a6e0: 2074 6865 206f 6e62 6f72 6465 7220 6669   the onborder fi
+0000a6f0: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+0000a700: 2020 2070 7265 765f 6e62 5f62 6174 6368     prev_nb_batch
+0000a710: 6573 203d 206c 656e 2874 696c 6573 5f67  es = len(tiles_g
+0000a720: 6466 290a 2020 2020 2020 2020 2020 2020  df).            
+0000a730: 2020 2020 696e 7075 745f 7061 7468 203d      input_path =
+0000a740: 206f 7574 7075 745f 746d 705f 6f6e 626f   output_tmp_onbo
+0000a750: 7264 6572 5f70 6174 680a 2020 2020 2020  rder_path.      
+0000a760: 2020 2020 2020 2020 2020 7061 7373 5f69            pass_i
+0000a770: 6420 2b3d 2031 0a20 2020 2020 2020 2020  d += 1.         
+0000a780: 2020 2020 2020 2069 6e70 7574 5f70 6173         input_pas
+0000a790: 735f 6c61 7965 7220 3d20 4e6f 6e65 0a0a  s_layer = None..
+0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7b0: 2320 4966 2077 6520 6172 6520 7265 6164  # If we are read
+0000a7c0: 792e 2e2e 0a20 2020 2020 2020 2020 2020  y....           
+0000a7d0: 2020 2020 2069 6620 6c61 7374 5f70 6173       if last_pas
+0000a7e0: 7320 6973 2054 7275 653a 0a20 2020 2020  s is True:.     
+0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000a800: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
+0000a810: 2020 2320 4361 6c63 756c 6174 696f 6e20    # Calculation 
+0000a820: 7265 6164 7921 204e 6f77 2066 696e 616c  ready! Now final
+0000a830: 6973 6520 6f75 7470 7574 210a 2020 2020  ise output!.    
+0000a840: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+0000a850: 7265 2069 7320 6120 7265 7375 6c74 206f  re is a result o
+0000a860: 6e20 626f 7264 6572 2c20 6170 7065 6e64  n border, append
+0000a870: 2069 7420 746f 2074 6865 2072 6573 740a   it to the rest.
+0000a880: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0000a890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a8a0: 2073 7472 286f 7574 7075 745f 746d 705f   str(output_tmp_
+0000a8b0: 6f6e 626f 7264 6572 5f70 6174 6829 2021  onborder_path) !
+0000a8c0: 3d20 7374 7228 6f75 7470 7574 5f74 6d70  = str(output_tmp
+0000a8d0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000a8e0: 2020 2020 2020 2061 6e64 206f 7574 7075         and outpu
+0000a8f0: 745f 746d 705f 6f6e 626f 7264 6572 5f70  t_tmp_onborder_p
+0000a900: 6174 682e 6578 6973 7473 2829 0a20 2020  ath.exists().   
+0000a910: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+0000a920: 2020 2020 2020 2020 2020 2020 6766 6f2e              gfo.
+0000a930: 6170 7065 6e64 5f74 6f28 0a20 2020 2020  append_to(.     
+0000a940: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000a950: 7574 7075 745f 746d 705f 6f6e 626f 7264  utput_tmp_onbord
+0000a960: 6572 5f70 6174 682c 206f 7574 7075 745f  er_path, output_
+0000a970: 746d 705f 7061 7468 2c20 6473 745f 6c61  tmp_path, dst_la
+0000a980: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
+0000a990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a9a0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000a9b0: 2320 4966 2074 6865 7265 2069 7320 6120  # If there is a 
+0000a9c0: 7265 7375 6c74 2e2e 2e0a 2020 2020 2020  result....      
+0000a9d0: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+0000a9e0: 746d 705f 7061 7468 2e65 7869 7374 7328  tmp_path.exists(
+0000a9f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000aa00: 2020 2023 2049 6620 7469 6c65 6420 6f75     # If tiled ou
+0000aa10: 7470 7574 2061 736b 6564 2c20 6164 6420  tput asked, add 
+0000aa20: 2274 696c 655f 6964 2220 746f 2067 726f  "tile_id" to gro
+0000aa30: 7570 6279 5f63 6f6c 756d 6e73 0a20 2020  upby_columns.   
+0000aa40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000aa50: 6c65 6e28 7265 7375 6c74 5f74 696c 6573  len(result_tiles
+0000aa60: 5f67 6466 2920 3e20 313a 0a20 2020 2020  _gdf) > 1:.     
+0000aa70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000aa80: 6620 6772 6f75 7062 795f 636f 6c75 6d6e  f groupby_column
+0000aa90: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0000aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aab0: 2020 2067 726f 7570 6279 5f63 6f6c 756d     groupby_colum
+0000aac0: 6e73 203d 205b 2274 696c 655f 6964 225d  ns = ["tile_id"]
+0000aad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aae0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
 0000aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab00: 2020 2023 2066 6972 7374 2067 726f 7570     # first group
-0000ab10: 2074 6865 6d20 6865 7265 2c20 6173 2074   them here, as t
-0000ab20: 6865 7920 7769 6c6c 2062 6520 6578 706c  hey will be expl
-0000ab30: 6f64 6564 2061 6761 696e 0a20 2020 2020  oded again.     
-0000ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab50: 2020 2023 2069 6e20 7468 6520 7365 6c65     # in the sele
-0000ab60: 6374 2829 2063 616c 6c20 6c61 7465 7220  ct() call later 
-0000ab70: 6f6e 2e2e 2e20 736f 206a 7573 7420 6f72  on... so just or
-0000ab80: 6465 7220 7468 656d 2e0a 2020 2020 2020  der them..      
-0000ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aba0: 2020 2320 4966 2061 2074 696c 6564 2072    # If a tiled r
-0000abb0: 6573 756c 7420 6973 2061 736b 6564 2c20  esult is asked, 
-0000abc0: 616c 736f 2064 6f6e 2774 2063 6f6c 6c65  also don't colle
-0000abd0: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
-0000abe0: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
-0000abf0: 7374 6d74 203d 2066 2222 220a 2020 2020  stmt = f""".    
-0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac10: 2020 2020 2020 2020 5345 4c45 4354 207b          SELECT {
-0000ac20: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
-0000ac30: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac50: 2020 2020 7b67 726f 7570 6279 5f73 656c      {groupby_sel
-0000ac60: 6563 745f 7072 6566 6978 6564 5f73 7472  ect_prefixed_str
-0000ac70: 2e66 6f72 6d61 7428 7072 6566 6978 3d22  .format(prefix="
-0000ac80: 6c61 7965 722e 2229 7d0a 2020 2020 2020  layer.")}.      
-0000ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aca0: 2020 2020 2020 2020 4652 4f4d 2022 7b7b          FROM "{{
-0000acb0: 696e 7075 745f 6c61 7965 727d 7d22 206c  input_layer}}" l
-0000acc0: 6179 6572 0a20 2020 2020 2020 2020 2020  ayer.           
-0000acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ace0: 2020 4f52 4445 5220 4259 206c 6179 6572    ORDER BY layer
-0000acf0: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
-0000ad00: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0000ad10: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
-0000ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000ab00: 2020 2067 726f 7570 6279 5f63 6f6c 756d     groupby_colum
+0000ab10: 6e73 203d 206c 6973 7428 6772 6f75 7062  ns = list(groupb
+0000ab20: 795f 636f 6c75 6d6e 7329 2e63 6f70 7928  y_columns).copy(
+0000ab30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ab40: 2020 2020 2020 2020 2020 6772 6f75 7062            groupb
+0000ab50: 795f 636f 6c75 6d6e 732e 6170 7065 6e64  y_columns.append
+0000ab60: 2822 7469 6c65 5f69 6422 290a 0a20 2020  ("tile_id")..   
+0000ab70: 2020 2020 2020 2020 2020 2020 2023 2050               # P
+0000ab80: 7265 7061 7265 2073 7472 696e 6773 2074  repare strings t
+0000ab90: 6f20 7573 6520 696e 2073 656c 6563 7420  o use in select 
+0000aba0: 6261 7365 6420 6f6e 2067 726f 7570 6279  based on groupby
+0000abb0: 5f63 6f6c 756d 6e73 0a20 2020 2020 2020  _columns.       
+0000abc0: 2020 2020 2020 2020 2069 6620 6772 6f75           if grou
+0000abd0: 7062 795f 636f 6c75 6d6e 7320 6973 206e  pby_columns is n
+0000abe0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000abf0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+0000ac00: 7570 6279 5f70 7265 6669 7865 645f 6c69  upby_prefixed_li
+0000ac10: 7374 203d 205b 0a20 2020 2020 2020 2020  st = [.         
+0000ac20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ac30: 277b 7b70 7265 6669 787d 7d22 7b63 6f6c  '{{prefix}}"{col
+0000ac40: 756d 6e7d 2227 2066 6f72 2063 6f6c 756d  umn}"' for colum
+0000ac50: 6e20 696e 2067 726f 7570 6279 5f63 6f6c  n in groupby_col
+0000ac60: 756d 6e73 0a20 2020 2020 2020 2020 2020  umns.           
+0000ac70: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0000ac80: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000ac90: 726f 7570 6279 5f73 656c 6563 745f 7072  roupby_select_pr
+0000aca0: 6566 6978 6564 5f73 7472 203d 2028 0a20  efixed_str = (. 
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acc0: 2020 2020 2020 2066 222c 207b 272c 2027         f", {', '
+0000acd0: 2e6a 6f69 6e28 6772 6f75 7062 795f 7072  .join(groupby_pr
+0000ace0: 6566 6978 6564 5f6c 6973 7429 7d22 0a20  efixed_list)}". 
+0000acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad00: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000ad10: 2020 2020 2020 2020 2067 726f 7570 6279           groupby
+0000ad20: 5f67 726f 7570 6279 5f70 7265 6669 7865  _groupby_prefixe
+0000ad30: 645f 7374 7220 3d20 280a 2020 2020 2020  d_str = (.      
 0000ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad50: 2320 4e6f 2065 7870 6c6f 6465 636f 6c6c  # No explodecoll
-0000ad60: 6563 7469 6f6e 732c 2073 6f20 636f 6c6c  ections, so coll
-0000ad70: 6563 7420 746f 206f 6e65 2067 656f 6d65  ect to one geome
-0000ad80: 7472 790a 2020 2020 2020 2020 2020 2020  try.            
-0000ad90: 2020 2020 2020 2020 2020 2020 2320 2870              # (p
-0000ada0: 6572 2067 726f 7570 6279 2069 6620 6170  er groupby if ap
-0000adb0: 706c 6963 6162 6c65 292e 0a20 2020 2020  plicable)..     
-0000adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000add0: 2020 2073 716c 5f73 746d 7420 3d20 6622     sql_stmt = f"
-0000ade0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-0000adf0: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-0000ae00: 454c 4543 5420 5354 5f43 6f6c 6c65 6374  ELECT ST_Collect
-0000ae10: 287b 7b67 656f 6d65 7472 7963 6f6c 756d  ({{geometrycolum
-0000ae20: 6e7d 7d29 2041 5320 7b7b 6765 6f6d 6574  n}}) AS {{geomet
-0000ae30: 7279 636f 6c75 6d6e 7d7d 0a20 2020 2020  rycolumn}}.     
-0000ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae50: 2020 2020 2020 2020 2020 2020 207b 6772               {gr
-0000ae60: 6f75 7062 795f 7365 6c65 6374 5f70 7265  oupby_select_pre
-0000ae70: 6669 7865 645f 7374 722e 666f 726d 6174  fixed_str.format
-0000ae80: 2870 7265 6669 783d 226c 6179 6572 2e22  (prefix="layer."
-0000ae90: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
-0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aeb0: 2046 524f 4d20 227b 7b69 6e70 7574 5f6c   FROM "{{input_l
-0000aec0: 6179 6572 7d7d 2220 6c61 7965 720a 2020  ayer}}" layer.  
-0000aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aee0: 2020 2020 2020 2020 2020 2020 7b67 726f              {gro
-0000aef0: 7570 6279 5f67 726f 7570 6279 5f70 7265  upby_groupby_pre
-0000af00: 6669 7865 645f 7374 722e 666f 726d 6174  fixed_str.format
-0000af10: 2870 7265 6669 783d 226c 6179 6572 2e22  (prefix="layer."
-0000af20: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
-0000af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af40: 4f52 4445 5220 4259 204d 494e 286c 6179  ORDER BY MIN(lay
-0000af50: 6572 2e7b 6f72 6465 7262 795f 636f 6c75  er.{orderby_colu
-0000af60: 6d6e 7d29 0a20 2020 2020 2020 2020 2020  mn}).           
-0000af70: 2020 2020 2020 2020 2020 2020 2022 2222               """
-0000af80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000afa0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0000afb0: 6167 675f 636f 6c75 6d6e 7320 7370 6563  agg_columns spec
-0000afc0: 6966 6965 642c 2070 6f73 7470 726f 6365  ified, postproce
-0000afd0: 7373 696e 6720 6973 2061 2062 6974 206d  ssing is a bit m
-0000afe0: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-0000aff0: 2020 2020 2020 2020 2320 636f 6d70 6c69          # compli
-0000b000: 6361 7465 642e 0a20 2020 2020 2020 2020  cated..         
-0000b010: 2020 2020 2020 2020 2020 2073 716c 5f73             sql_s
-0000b020: 746d 7420 3d20 6622 2222 0a20 2020 2020  tmt = f""".     
-0000b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b040: 2020 2053 454c 4543 5420 6765 6f5f 6461     SELECT geo_da
-0000b050: 7461 2e7b 7b67 656f 6d65 7472 7963 6f6c  ta.{{geometrycol
-0000b060: 756d 6e7d 7d0a 2020 2020 2020 2020 2020  umn}}.          
-0000b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b080: 2020 2020 7b67 726f 7570 6279 5f73 656c      {groupby_sel
-0000b090: 6563 745f 7072 6566 6978 6564 5f73 7472  ect_prefixed_str
-0000b0a0: 2e66 6f72 6d61 7428 7072 6566 6978 3d22  .format(prefix="
-0000b0b0: 6765 6f5f 6461 7461 2e22 297d 0a20 2020  geo_data.")}.   
-0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0d0: 2020 2020 2020 2020 2020 207b 6167 675f             {agg_
-0000b0e0: 636f 6c75 6d6e 735f 7374 727d 0a20 2020  columns_str}.   
-0000b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b100: 2020 2020 2020 2046 524f 4d20 280a 2020         FROM (.  
-0000b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b120: 2020 2020 2020 2020 2020 5345 4c45 4354            SELECT
-0000b130: 2053 545f 436f 6c6c 6563 7428 6c61 7965   ST_Collect(laye
-0000b140: 725f 6765 6f2e 7b7b 6765 6f6d 6574 7279  r_geo.{{geometry
-0000b150: 636f 6c75 6d6e 7d7d 0a20 2020 2020 2020  column}}.       
-0000b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b170: 2020 2020 2020 2020 2020 2020 2920 4153              ) AS
-0000b180: 207b 7b67 656f 6d65 7472 7963 6f6c 756d   {{geometrycolum
-0000b190: 6e7d 7d0a 2020 2020 2020 2020 2020 2020  n}}.            
-0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1b0: 2020 2020 2020 7b67 726f 7570 6279 5f73        {groupby_s
-0000b1c0: 656c 6563 745f 7072 6566 6978 6564 5f73  elect_prefixed_s
-0000b1d0: 7472 2e66 6f72 6d61 7428 7072 6566 6978  tr.format(prefix
-0000b1e0: 3d22 6c61 7965 725f 6765 6f2e 2229 7d0a  ="layer_geo.")}.
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b210: 2020 2c4d 494e 286c 6179 6572 5f67 656f    ,MIN(layer_geo
-0000b220: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
-0000b230: 7d29 2061 7320 7b6f 7264 6572 6279 5f63  }) as {orderby_c
-0000b240: 6f6c 756d 6e7d 0a20 2020 2020 2020 2020  olumn}.         
-0000b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b260: 2020 2020 2046 524f 4d20 227b 7b69 6e70       FROM "{{inp
-0000b270: 7574 5f6c 6179 6572 7d7d 2220 6c61 7965  ut_layer}}" laye
-0000b280: 725f 6765 6f0a 2020 2020 2020 2020 2020  r_geo.          
-0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2a0: 2020 2020 7b67 726f 7570 6279 5f67 726f      {groupby_gro
-0000b2b0: 7570 6279 5f70 7265 6669 7865 645f 7374  upby_prefixed_st
-0000b2c0: 722e 666f 726d 6174 2870 7265 6669 783d  r.format(prefix=
-0000b2d0: 226c 6179 6572 5f67 656f 2e22 297d 0a20  "layer_geo.")}. 
-0000b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2f0: 2020 2020 2020 2020 2020 2029 2067 656f             ) geo
-0000b300: 5f64 6174 610a 2020 2020 2020 2020 2020  _data.          
+0000ad50: 2020 6622 4752 4f55 5020 4259 207b 272c    f"GROUP BY {',
+0000ad60: 2027 2e6a 6f69 6e28 6772 6f75 7062 795f   '.join(groupby_
+0000ad70: 7072 6566 6978 6564 5f6c 6973 7429 7d22  prefixed_list)}"
+0000ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ad90: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000ada0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000adb0: 7062 795f 6669 6c74 6572 5f6c 6973 7420  pby_filter_list 
+0000adc0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0000add0: 2020 2020 2020 2020 2020 2020 6627 2041              f' A
+0000ade0: 4e44 2067 656f 5f64 6174 612e 227b 636f  ND geo_data."{co
+0000adf0: 6c75 6d6e 7d22 203d 206a 736f 6e5f 6461  lumn}" = json_da
+0000ae00: 7461 2e22 7b63 6f6c 756d 6e7d 2227 0a20  ta."{column}"'. 
+0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae20: 2020 2020 2020 2066 6f72 2063 6f6c 756d         for colum
+0000ae30: 6e20 696e 2067 726f 7570 6279 5f63 6f6c  n in groupby_col
+0000ae40: 756d 6e73 0a20 2020 2020 2020 2020 2020  umns.           
+0000ae50: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0000ae60: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000ae70: 726f 7570 6279 5f66 696c 7465 725f 7374  roupby_filter_st
+0000ae80: 7220 3d20 2220 222e 6a6f 696e 2867 726f  r = " ".join(gro
+0000ae90: 7570 6279 5f66 696c 7465 725f 6c69 7374  upby_filter_list
+0000aea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000aeb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000aec0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000aed0: 7062 795f 7365 6c65 6374 5f70 7265 6669  pby_select_prefi
+0000aee0: 7865 645f 7374 7220 3d20 2222 0a20 2020  xed_str = "".   
+0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af00: 2067 726f 7570 6279 5f67 726f 7570 6279   groupby_groupby
+0000af10: 5f70 7265 6669 7865 645f 7374 7220 3d20  _prefixed_str = 
+0000af20: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+0000af30: 2020 2020 2020 2067 726f 7570 6279 5f66         groupby_f
+0000af40: 696c 7465 725f 7374 7220 3d20 2222 0a0a  ilter_str = ""..
+0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af60: 2320 5072 6570 6172 6520 7374 7269 6e67  # Prepare string
+0000af70: 7320 746f 2075 7365 2069 6e20 7365 6c65  s to use in sele
+0000af80: 6374 2062 6173 6564 206f 6e20 6167 675f  ct based on agg_
+0000af90: 636f 6c75 6d6e 730a 2020 2020 2020 2020  columns.        
+0000afa0: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
+0000afb0: 6d6e 735f 7374 7220 3d20 2222 0a20 2020  mns_str = "".   
+0000afc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000afd0: 6167 675f 636f 6c75 6d6e 7320 6973 206e  agg_columns is n
+0000afe0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000aff0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b000: 226a 736f 6e22 2069 6e20 6167 675f 636f  "json" in agg_co
+0000b010: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+0000b020: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000b030: 2054 6865 2061 6767 7265 6761 7469 6f6e   The aggregation
+0000b040: 2069 7320 746f 2061 206a 736f 6e20 636f   is to a json co
+0000b050: 6c75 6d6e 2c20 736f 2061 6464 0a20 2020  lumn, so add.   
+0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b070: 2020 2020 2061 6767 5f63 6f6c 756d 6e73       agg_columns
+0000b080: 5f73 7472 202b 3d20 280a 2020 2020 2020  _str += (.      
+0000b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0a0: 2020 2020 2020 222c 6a73 6f6e 5f67 726f        ",json_gro
+0000b0b0: 7570 5f61 7272 6179 2844 4953 5449 4e43  up_array(DISTINC
+0000b0c0: 5420 6a73 6f6e 5f64 6174 612e 6a73 6f6e  T json_data.json
+0000b0d0: 5f72 6f77 2920 6173 206a 736f 6e22 0a20  _row) as json". 
+0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000b100: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0000b110: 6620 2263 6f6c 756d 6e73 2220 696e 2061  f "columns" in a
+0000b120: 6767 5f63 6f6c 756d 6e73 3a0a 2020 2020  gg_columns:.    
+0000b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b140: 2020 2020 666f 7220 6167 675f 636f 6c75      for agg_colu
+0000b150: 6d6e 2069 6e20 6167 675f 636f 6c75 6d6e  mn in agg_column
+0000b160: 735b 2263 6f6c 756d 6e73 225d 3a0a 2020  s["columns"]:.  
+0000b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b180: 2020 2020 2020 2020 2020 2320 496e 6974            # Init
+0000b190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1a0: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+0000b1b0: 7469 6e63 745f 7374 7220 3d20 2222 0a20  tinct_str = "". 
+0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1d0: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+0000b1e0: 5f70 6172 616d 5f73 7472 203d 2022 220a  _param_str = "".
+0000b1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b200: 2020 2020 2020 2020 2020 2020 2023 2050               # P
+0000b210: 7265 7061 7265 2061 6767 7265 6761 7469  repare aggregati
+0000b220: 6f6e 206b 6579 776f 7264 2e0a 2020 2020  on keyword..    
+0000b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b240: 2020 2020 2020 2020 6966 2061 6767 5f63          if agg_c
+0000b250: 6f6c 756d 6e5b 2261 6767 225d 2e6c 6f77  olumn["agg"].low
+0000b260: 6572 2829 2069 6e20 5b0a 2020 2020 2020  er() in [.      
+0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b280: 2020 2020 2020 2020 2020 2263 6f75 6e74            "count
+0000b290: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2b0: 2020 2022 7375 6d22 2c0a 2020 2020 2020     "sum",.      
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2d0: 2020 2020 2020 2020 2020 226d 696e 222c            "min",
+0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b300: 2022 6d61 7822 2c0a 2020 2020 2020 2020   "max",.        
 0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b320: 4a4f 494e 2028 0a20 2020 2020 2020 2020  JOIN (.         
-0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b340: 2020 2053 454c 4543 5420 4449 5354 494e     SELECT DISTIN
-0000b350: 4354 206a 736f 6e5f 726f 7773 5f74 6162  CT json_rows_tab
-0000b360: 6c65 2e76 616c 7565 2061 7320 6a73 6f6e  le.value as json
-0000b370: 5f72 6f77 0a20 2020 2020 2020 2020 2020  _row.           
-0000b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b390: 2020 2020 207b 6772 6f75 7062 795f 7365       {groupby_se
-0000b3a0: 6c65 6374 5f70 7265 6669 7865 645f 7374  lect_prefixed_st
-0000b3b0: 722e 666f 726d 6174 2870 7265 6669 783d  r.format(prefix=
-0000b3c0: 226c 6179 6572 5f66 6f72 5f6a 736f 6e2e  "layer_for_json.
-0000b3d0: 2229 7d0a 2020 2020 2020 2020 2020 2020  ")}.            
-0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3f0: 2020 4652 4f4d 2022 7b7b 696e 7075 745f    FROM "{{input_
-0000b400: 6c61 7965 727d 7d22 206c 6179 6572 5f66  layer}}" layer_f
-0000b410: 6f72 5f6a 736f 6e0a 2020 2020 2020 2020  or_json.        
+0000b320: 2020 2020 2020 2020 226d 6564 6961 6e22          "median"
+0000b330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b340: 2020 2020 2020 2020 2020 2020 2020 5d3a                ]:
+0000b350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b370: 2061 6767 7265 6761 7469 6f6e 5f73 7472   aggregation_str
+0000b380: 203d 2061 6767 5f63 6f6c 756d 6e5b 2261   = agg_column["a
+0000b390: 6767 225d 0a20 2020 2020 2020 2020 2020  gg"].           
+0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3b0: 2065 6c69 6620 6167 675f 636f 6c75 6d6e   elif agg_column
+0000b3c0: 5b22 6167 6722 5d2e 6c6f 7765 7228 2920  ["agg"].lower() 
+0000b3d0: 696e 205b 226d 6561 6e22 2c20 2261 7667  in ["mean", "avg
+0000b3e0: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+0000b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b400: 2020 2020 6167 6772 6567 6174 696f 6e5f      aggregation_
+0000b410: 7374 7220 3d20 2261 7667 220a 2020 2020  str = "avg".    
 0000b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b430: 2020 2020 2020 4352 4f53 5320 4a4f 494e        CROSS JOIN
-0000b440: 206a 736f 6e5f 6561 6368 280a 2020 2020   json_each(.    
-0000b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b460: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0000b470: 7965 725f 666f 725f 6a73 6f6e 2e5f 5f44  yer_for_json.__D
-0000b480: 4953 534f 4c56 455f 544f 4a53 4f4e 2c20  ISSOLVE_TOJSON, 
-0000b490: 2224 2229 206a 736f 6e5f 726f 7773 5f74  "$") json_rows_t
-0000b4a0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+0000b430: 2020 2020 2020 2020 656c 6966 2061 6767          elif agg
+0000b440: 5f63 6f6c 756d 6e5b 2261 6767 225d 2e6c  _column["agg"].l
+0000b450: 6f77 6572 2829 203d 3d20 2263 6f6e 6361  ower() == "conca
+0000b460: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+0000b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b480: 2020 2020 6167 6772 6567 6174 696f 6e5f      aggregation_
+0000b490: 7374 7220 3d20 2267 726f 7570 5f63 6f6e  str = "group_con
+0000b4a0: 6361 7422 0a20 2020 2020 2020 2020 2020  cat".           
 0000b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4c0: 2029 206a 736f 6e5f 6461 7461 0a20 2020   ) json_data.   
-0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4e0: 2020 2020 2020 5748 4552 4520 313d 310a        WHERE 1=1.
+0000b4c0: 2020 2020 2069 6620 2273 6570 2220 696e       if "sep" in
+0000b4d0: 2061 6767 5f63 6f6c 756d 6e3a 0a20 2020   agg_column:.   
+0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b500: 2020 2020 2020 2020 2020 2020 7b67 726f              {gro
-0000b510: 7570 6279 5f66 696c 7465 725f 7374 727d  upby_filter_str}
-0000b520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b530: 2020 2020 2020 2020 2020 207b 6772 6f75             {grou
-0000b540: 7062 795f 6772 6f75 7062 795f 7072 6566  pby_groupby_pref
-0000b550: 6978 6564 5f73 7472 2e66 6f72 6d61 7428  ixed_str.format(
-0000b560: 7072 6566 6978 3d22 6765 6f5f 6461 7461  prefix="geo_data
-0000b570: 2e22 297d 0a20 2020 2020 2020 2020 2020  .")}.           
-0000b580: 2020 2020 2020 2020 2020 2020 2020 204f                 O
-0000b590: 5244 4552 2042 5920 6765 6f5f 6461 7461  RDER BY geo_data
-0000b5a0: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
-0000b5b0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0000b5c0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-0000b5d0: 2020 2020 2020 2020 2020 2023 2047 6f21             # Go!
-0000b5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b5f0: 205f 6765 6f6f 7073 5f73 716c 2e73 656c   _geoops_sql.sel
-0000b600: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-0000b610: 2020 2020 2020 2020 2069 6e70 7574 5f70           input_p
-0000b620: 6174 683d 6f75 7470 7574 5f74 6d70 5f70  ath=output_tmp_p
-0000b630: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-0000b640: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-0000b650: 7061 7468 3d6f 7574 7075 745f 7061 7468  path=output_path
-0000b660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b670: 2020 2020 2020 7371 6c5f 7374 6d74 3d73        sql_stmt=s
-0000b680: 716c 5f73 746d 742c 0a20 2020 2020 2020  ql_stmt,.       
-0000b690: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0000b6a0: 7075 745f 6c61 7965 723d 6f75 7470 7574  put_layer=output
-0000b6b0: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-0000b6c0: 2020 2020 2020 2020 2020 2020 6578 706c              expl
-0000b6d0: 6f64 6563 6f6c 6c65 6374 696f 6e73 3d65  odecollections=e
-0000b6e0: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-0000b6f0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0000b700: 2020 2029 0a0a 2020 2020 2020 2020 6669     )..        fi
-0000b710: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-0000b720: 2020 2023 2043 6c65 616e 2074 6d70 2064     # Clean tmp d
-0000b730: 6972 2069 6620 6974 2065 7869 7374 732e  ir if it exists.
-0000b740: 2e2e 0a20 2020 2020 2020 2020 2020 2069  ...            i
-0000b750: 6620 7465 6d70 6469 722e 6578 6973 7473  f tempdir.exists
-0000b760: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000b770: 2020 2020 7368 7574 696c 2e72 6d74 7265      shutil.rmtre
-0000b780: 6528 7465 6d70 6469 7229 0a20 2020 2065  e(tempdir).    e
-0000b790: 6c73 653a 0a20 2020 2020 2020 2072 6169  lse:.        rai
-0000b7a0: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-0000b7b0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-0000b7c0: 2020 2020 6622 556e 7375 7070 6f72 7465      f"Unsupporte
-0000b7d0: 6420 696e 7075 7420 6765 6f6d 6574 7279  d input geometry
-0000b7e0: 7479 7065 3a20 7b69 6e70 7574 5f6c 6179  type: {input_lay
-0000b7f0: 6572 696e 666f 2e67 656f 6d65 7472 7974  erinfo.geometryt
-0000b800: 7970 657d 220a 2020 2020 2020 2020 290a  ype}".        ).
-0000b810: 0a20 2020 2023 2052 6574 7572 6e20 7265  .    # Return re
-0000b820: 7375 6c74 2069 6e66 6f0a 2020 2020 7265  sult info.    re
-0000b830: 7375 6c74 5f69 6e66 6f5b 0a20 2020 2020  sult_info[.     
-0000b840: 2020 2022 6d65 7373 6167 6522 0a20 2020     "message".   
-0000b850: 205d 203d 2066 2244 6973 736f 6c76 6520   ] = f"Dissolve 
-0000b860: 636f 6d70 6c65 7465 6c79 2072 6561 6479  completely ready
-0000b870: 2c20 746f 6f6b 207b 6461 7465 7469 6d65  , took {datetime
-0000b880: 2e6e 6f77 2829 2d73 7461 7274 5f74 696d  .now()-start_tim
-0000b890: 657d 2122 0a20 2020 206c 6f67 6765 722e  e}!".    logger.
-0000b8a0: 696e 666f 2872 6573 756c 745f 696e 666f  info(result_info
-0000b8b0: 5b22 6d65 7373 6167 6522 5d29 0a20 2020  ["message"]).   
-0000b8c0: 2072 6574 7572 6e20 7265 7375 6c74 5f69   return result_i
-0000b8d0: 6e66 6f0a 0a0a 6465 6620 5f64 6973 736f  nfo...def _disso
-0000b8e0: 6c76 655f 706f 6c79 676f 6e73 5f70 6173  lve_polygons_pas
-0000b8f0: 7328 0a20 2020 2069 6e70 7574 5f70 6174  s(.    input_pat
-0000b900: 683a 2050 6174 682c 0a20 2020 206f 7574  h: Path,.    out
-0000b910: 7075 745f 6e6f 746f 6e62 6f72 6465 725f  put_notonborder_
-0000b920: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
-0000b930: 6f75 7470 7574 5f6f 6e62 6f72 6465 725f  output_onborder_
-0000b940: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
-0000b950: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-0000b960: 6e73 3a20 626f 6f6c 2c0a 2020 2020 6772  ns: bool,.    gr
-0000b970: 6f75 7062 795f 636f 6c75 6d6e 733a 204f  oupby_columns: O
-0000b980: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
-0000b990: 5b73 7472 5d5d 2c0a 2020 2020 6167 675f  [str]],.    agg_
-0000b9a0: 636f 6c75 6d6e 733a 204f 7074 696f 6e61  columns: Optiona
-0000b9b0: 6c5b 6469 6374 5d2c 0a20 2020 2074 696c  l[dict],.    til
-0000b9c0: 6573 5f67 6466 3a20 6770 642e 4765 6f44  es_gdf: gpd.GeoD
-0000b9d0: 6174 6146 7261 6d65 2c0a 2020 2020 696e  ataFrame,.    in
-0000b9e0: 7075 745f 6c61 7965 723a 204f 7074 696f  put_layer: Optio
-0000b9f0: 6e61 6c5b 7374 725d 2c0a 2020 2020 6f75  nal[str],.    ou
-0000ba00: 7470 7574 5f6c 6179 6572 3a20 4f70 7469  tput_layer: Opti
-0000ba10: 6f6e 616c 5b73 7472 5d2c 0a20 2020 2067  onal[str],.    g
-0000ba20: 7269 6473 697a 653a 2066 6c6f 6174 2c0a  ridsize: float,.
-0000ba30: 2020 2020 6e62 5f70 6172 616c 6c65 6c3a      nb_parallel:
-0000ba40: 2069 6e74 2c0a 2920 2d3e 2064 6963 743a   int,.) -> dict:
-0000ba50: 0a20 2020 2023 204d 616b 6520 7375 7265  .    # Make sure
-0000ba60: 2074 6865 2069 6e70 7574 2066 696c 6520   the input file 
-0000ba70: 6861 7320 6120 7370 6174 6961 6c20 696e  has a spatial in
-0000ba80: 6465 780a 2020 2020 6766 6f2e 6372 6561  dex.    gfo.crea
-0000ba90: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000baa0: 2869 6e70 7574 5f70 6174 682c 2065 7869  (input_path, exi
-0000bab0: 7374 5f6f 6b3d 5472 7565 290a 0a20 2020  st_ok=True)..   
-0000bac0: 2023 2053 7461 7274 2063 616c 6375 6c61   # Start calcula
-0000bad0: 7469 6f6e 2069 6e20 7061 7261 6c6c 656c  tion in parallel
-0000bae0: 0a20 2020 2073 7461 7274 5f74 696d 6520  .    start_time 
-0000baf0: 3d20 6461 7465 7469 6d65 2e6e 6f77 2829  = datetime.now()
-0000bb00: 0a20 2020 2072 6573 756c 745f 696e 666f  .    result_info
-0000bb10: 203d 207b 7d0a 2020 2020 7374 6172 745f   = {}.    start_
-0000bb20: 7469 6d65 203d 2064 6174 6574 696d 652e  time = datetime.
-0000bb30: 6e6f 7728 290a 2020 2020 696e 7075 745f  now().    input_
-0000bb40: 6c61 7965 7269 6e66 6f20 3d20 6766 6f2e  layerinfo = gfo.
-0000bb50: 6765 745f 6c61 7965 7269 6e66 6f28 696e  get_layerinfo(in
-0000bb60: 7075 745f 7061 7468 2c20 696e 7075 745f  put_path, input_
-0000bb70: 6c61 7965 7229 0a0a 2020 2020 2320 5072  layer)..    # Pr
-0000bb80: 6f63 6573 7369 6e67 2069 6e20 7468 7265  ocessing in thre
-0000bb90: 6164 7320 6973 2032 7820 6661 7374 6572  ads is 2x faster
-0000bba0: 2066 6f72 2073 6d61 6c6c 2064 6174 6173   for small datas
-0000bbb0: 6574 7320 286f 6e20 5769 6e64 6f77 7329  ets (on Windows)
-0000bbc0: 0a20 2020 2063 616c 6375 6c61 7465 5f69  .    calculate_i
-0000bbd0: 6e5f 7468 7265 6164 7320 3d20 5472 7565  n_threads = True
-0000bbe0: 2069 6620 696e 7075 745f 6c61 7965 7269   if input_layeri
-0000bbf0: 6e66 6f2e 6665 6174 7572 6563 6f75 6e74  nfo.featurecount
-0000bc00: 203c 3d20 3130 3020 656c 7365 2046 616c   <= 100 else Fal
-0000bc10: 7365 0a20 2020 2077 6974 6820 5f70 726f  se.    with _pro
-0000bc20: 6365 7373 696e 675f 7574 696c 2e50 6f6f  cessing_util.Poo
-0000bc30: 6c65 6445 7865 6375 746f 7246 6163 746f  ledExecutorFacto
-0000bc40: 7279 280a 2020 2020 2020 2020 7468 7265  ry(.        thre
-0000bc50: 6164 706f 6f6c 3d63 616c 6375 6c61 7465  adpool=calculate
-0000bc60: 5f69 6e5f 7468 7265 6164 732c 0a20 2020  _in_threads,.   
-0000bc70: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
-0000bc80: 3d6e 625f 7061 7261 6c6c 656c 2c0a 2020  =nb_parallel,.  
-0000bc90: 2020 2020 2020 696e 6974 6961 6c69 7a65        initialize
-0000bca0: 723d 5f70 726f 6365 7373 696e 675f 7574  r=_processing_ut
-0000bcb0: 696c 2e69 6e69 7469 616c 697a 655f 776f  il.initialize_wo
-0000bcc0: 726b 6572 2829 2c0a 2020 2020 2920 6173  rker(),.    ) as
-0000bcd0: 2063 616c 6375 6c61 7465 5f70 6f6f 6c3a   calculate_pool:
-0000bce0: 0a20 2020 2020 2020 2023 2050 7265 7061  .        # Prepa
-0000bcf0: 7265 206f 7574 7075 7420 6669 6c65 6e61  re output filena
-0000bd00: 6d65 0a20 2020 2020 2020 2074 656d 7064  me.        tempd
-0000bd10: 6972 203d 206f 7574 7075 745f 6f6e 626f  ir = output_onbo
-0000bd20: 7264 6572 5f70 6174 682e 7061 7265 6e74  rder_path.parent
-0000bd30: 0a0a 2020 2020 2020 2020 6261 7463 6865  ..        batche
-0000bd40: 7320 3d20 7b7d 0a20 2020 2020 2020 206e  s = {}.        n
-0000bd50: 625f 6261 7463 6865 7320 3d20 6c65 6e28  b_batches = len(
-0000bd60: 7469 6c65 735f 6764 6629 0a20 2020 2020  tiles_gdf).     
-0000bd70: 2020 206e 625f 6261 7463 6865 735f 646f     nb_batches_do
-0000bd80: 6e65 203d 2030 0a20 2020 2020 2020 2066  ne = 0.        f
-0000bd90: 7574 7572 655f 746f 5f62 6174 6368 5f69  uture_to_batch_i
-0000bda0: 6420 3d20 7b7d 0a20 2020 2020 2020 206e  d = {}.        n
-0000bdb0: 625f 726f 7773 5f64 6f6e 6520 3d20 300a  b_rows_done = 0.
-0000bdc0: 2020 2020 2020 2020 666f 7220 6261 7463          for batc
-0000bdd0: 685f 6964 2c20 7469 6c65 5f72 6f77 2069  h_id, tile_row i
-0000bde0: 6e20 656e 756d 6572 6174 6528 7469 6c65  n enumerate(tile
-0000bdf0: 735f 6764 662e 6974 6572 7475 706c 6573  s_gdf.itertuples
-0000be00: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-0000be10: 2062 6174 6368 6573 5b62 6174 6368 5f69   batches[batch_i
-0000be20: 645d 203d 207b 7d0a 2020 2020 2020 2020  d] = {}.        
-0000be30: 2020 2020 6261 7463 6865 735b 6261 7463      batches[batc
-0000be40: 685f 6964 5d5b 226c 6179 6572 225d 203d  h_id]["layer"] =
-0000be50: 206f 7574 7075 745f 6c61 7965 720a 2020   output_layer.  
-0000be60: 2020 2020 2020 2020 2020 6261 7463 6865            batche
-0000be70: 735b 6261 7463 685f 6964 5d5b 2262 6f75  s[batch_id]["bou
-0000be80: 6e64 7322 5d20 3d20 7469 6c65 5f72 6f77  nds"] = tile_row
-0000be90: 2e67 656f 6d65 7472 792e 626f 756e 6473  .geometry.bounds
-0000bea0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000beb0: 4f75 7470 7574 2065 6163 6820 6261 7463  Output each batc
-0000bec0: 6820 746f 2061 2073 6570 6572 6174 6520  h to a seperate 
-0000bed0: 7465 6d70 6f72 6172 7920 6669 6c65 2c20  temporary file, 
-0000bee0: 6f74 6865 7277 6973 6520 7468 6572 650a  otherwise there.
-0000bef0: 2020 2020 2020 2020 2020 2020 2320 6172              # ar
-0000bf00: 6520 7469 6d65 6f75 7420 6973 7375 6573  e timeout issues
-0000bf10: 2077 6865 6e20 7072 6f63 6573 7369 6e67   when processing
-0000bf20: 206c 6172 6765 2066 696c 6573 0a20 2020   large files.   
-0000bf30: 2020 2020 2020 2020 2073 7566 6669 7820           suffix 
-0000bf40: 3d20 6f75 7470 7574 5f6e 6f74 6f6e 626f  = output_notonbo
-0000bf50: 7264 6572 5f70 6174 682e 7375 6666 6978  rder_path.suffix
-0000bf60: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0000bf70: 6520 3d20 6622 7b6f 7574 7075 745f 6e6f  e = f"{output_no
-0000bf80: 746f 6e62 6f72 6465 725f 7061 7468 2e73  tonborder_path.s
-0000bf90: 7465 6d7d 5f7b 6261 7463 685f 6964 7d7b  tem}_{batch_id}{
-0000bfa0: 7375 6666 6978 7d22 0a20 2020 2020 2020  suffix}".       
-0000bfb0: 2020 2020 206f 7574 7075 745f 6e6f 746f       output_noto
-0000bfc0: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
-0000bfd0: 6961 6c5f 7061 7468 203d 2074 656d 7064  ial_path = tempd
-0000bfe0: 6972 202f 206e 616d 650a 2020 2020 2020  ir / name.      
-0000bff0: 2020 2020 2020 6261 7463 6865 735b 6261        batches[ba
-0000c000: 7463 685f 6964 5d5b 0a20 2020 2020 2020  tch_id][.       
-0000c010: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
-0000c020: 5f6e 6f74 6f6e 626f 7264 6572 5f74 6d70  _notonborder_tmp
-0000c030: 5f70 6172 7469 616c 5f70 6174 6822 0a20  _partial_path". 
-0000c040: 2020 2020 2020 2020 2020 205d 203d 206f             ] = o
-0000c050: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
-0000c060: 725f 746d 705f 7061 7274 6961 6c5f 7061  r_tmp_partial_pa
-0000c070: 7468 0a20 2020 2020 2020 2020 2020 206e  th.            n
-0000c080: 616d 6520 3d20 6622 7b6f 7574 7075 745f  ame = f"{output_
-0000c090: 6f6e 626f 7264 6572 5f70 6174 682e 7374  onborder_path.st
-0000c0a0: 656d 7d5f 7b62 6174 6368 5f69 647d 7b73  em}_{batch_id}{s
-0000c0b0: 7566 6669 787d 220a 2020 2020 2020 2020  uffix}".        
-0000c0c0: 2020 2020 6f75 7470 7574 5f6f 6e62 6f72      output_onbor
-0000c0d0: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
-0000c0e0: 7061 7468 203d 2074 656d 7064 6972 202f  path = tempdir /
-0000c0f0: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
-0000c100: 2020 6261 7463 6865 735b 6261 7463 685f    batches[batch_
-0000c110: 6964 5d5b 0a20 2020 2020 2020 2020 2020  id][.           
-0000c120: 2020 2020 2022 6f75 7470 7574 5f6f 6e62       "output_onb
-0000c130: 6f72 6465 725f 746d 705f 7061 7274 6961  order_tmp_partia
-0000c140: 6c5f 7061 7468 220a 2020 2020 2020 2020  l_path".        
-0000c150: 2020 2020 5d20 3d20 6f75 7470 7574 5f6f      ] = output_o
-0000c160: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
-0000c170: 6961 6c5f 7061 7468 0a0a 2020 2020 2020  ial_path..      
-0000c180: 2020 2020 2020 2320 4765 7420 7469 6c65        # Get tile
-0000c190: 5f69 6420 6966 2070 7265 7365 6e74 0a20  _id if present. 
-0000c1a0: 2020 2020 2020 2020 2020 2074 696c 655f             tile_
-0000c1b0: 6964 203d 2074 696c 655f 726f 772e 7469  id = tile_row.ti
-0000c1c0: 6c65 5f69 6420 6966 2022 7469 6c65 5f69  le_id if "tile_i
-0000c1d0: 6422 2069 6e20 7469 6c65 5f72 6f77 2e5f  d" in tile_row._
-0000c1e0: 6669 656c 6473 2065 6c73 6520 4e6f 6e65  fields else None
-0000c1f0: 0a0a 2020 2020 2020 2020 2020 2020 6675  ..            fu
-0000c200: 7475 7265 203d 2063 616c 6375 6c61 7465  ture = calculate
-0000c210: 5f70 6f6f 6c2e 7375 626d 6974 280a 2020  _pool.submit(.  
-0000c220: 2020 2020 2020 2020 2020 2020 2020 5f64                _d
-0000c230: 6973 736f 6c76 655f 706f 6c79 676f 6e73  issolve_polygons
-0000c240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c250: 2020 696e 7075 745f 7061 7468 3d69 6e70    input_path=inp
-0000c260: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
-0000c270: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-0000c280: 6e6f 746f 6e62 6f72 6465 725f 7061 7468  notonborder_path
-0000c290: 3d6f 7574 7075 745f 6e6f 746f 6e62 6f72  =output_notonbor
-0000c2a0: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
-0000c2b0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000c2c0: 2020 2020 2020 6f75 7470 7574 5f6f 6e62        output_onb
-0000c2d0: 6f72 6465 725f 7061 7468 3d6f 7574 7075  order_path=outpu
-0000c2e0: 745f 6f6e 626f 7264 6572 5f74 6d70 5f70  t_onborder_tmp_p
-0000c2f0: 6172 7469 616c 5f70 6174 682c 0a20 2020  artial_path,.   
-0000c300: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-0000c310: 6c6f 6465 636f 6c6c 6563 7469 6f6e 733d  lodecollections=
-0000c320: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-0000c330: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0000c340: 2020 2020 6772 6f75 7062 795f 636f 6c75      groupby_colu
-0000c350: 6d6e 733d 6772 6f75 7062 795f 636f 6c75  mns=groupby_colu
-0000c360: 6d6e 732c 0a20 2020 2020 2020 2020 2020  mns,.           
-0000c370: 2020 2020 2061 6767 5f63 6f6c 756d 6e73       agg_columns
-0000c380: 3d61 6767 5f63 6f6c 756d 6e73 2c0a 2020  =agg_columns,.  
-0000c390: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000c3a0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000c3b0: 3d69 6e70 7574 5f6c 6179 6572 696e 666f  =input_layerinfo
-0000c3c0: 2e67 656f 6d65 7472 7974 7970 652c 0a20  .geometrytype,. 
-0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c3e0: 6e70 7574 5f6c 6179 6572 3d69 6e70 7574  nput_layer=input
-0000c3f0: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-0000c400: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
-0000c410: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
-0000c420: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000c430: 2020 2062 626f 783d 7469 6c65 5f72 6f77     bbox=tile_row
-0000c440: 2e67 656f 6d65 7472 792e 626f 756e 6473  .geometry.bounds
-0000c450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c460: 2020 7469 6c65 5f69 643d 7469 6c65 5f69    tile_id=tile_i
-0000c470: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000c480: 2020 2067 7269 6473 697a 653d 6772 6964     gridsize=grid
-0000c490: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
-0000c4a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000c4b0: 6675 7475 7265 5f74 6f5f 6261 7463 685f  future_to_batch_
-0000c4c0: 6964 5b66 7574 7572 655d 203d 2062 6174  id[future] = bat
-0000c4d0: 6368 5f69 640a 0a20 2020 2020 2020 2023  ch_id..        #
-0000c4e0: 204c 6f6f 7020 7469 6c6c 2061 6c6c 2070   Loop till all p
-0000c4f0: 6172 616c 6c65 6c20 7072 6f63 6573 7365  arallel processe
-0000c500: 7320 6172 6520 7265 6164 792c 2062 7574  s are ready, but
-0000c510: 2070 726f 6365 7373 2065 6163 6820 6f6e   process each on
-0000c520: 650a 2020 2020 2020 2020 2320 7468 6174  e.        # that
-0000c530: 2069 7320 7265 6164 7920 616c 7265 6164   is ready alread
-0000c540: 790a 2020 2020 2020 2020 5f67 656e 6572  y.        _gener
-0000c550: 616c 5f75 7469 6c2e 7265 706f 7274 5f70  al_util.report_p
-0000c560: 726f 6772 6573 7328 0a20 2020 2020 2020  rogress(.       
-0000c570: 2020 2020 2073 7461 7274 5f74 696d 652c       start_time,
-0000c580: 206e 625f 6261 7463 6865 735f 646f 6e65   nb_batches_done
-0000c590: 2c20 6e62 5f62 6174 6368 6573 2c20 2264  , nb_batches, "d
-0000c5a0: 6973 736f 6c76 6522 0a20 2020 2020 2020  issolve".       
-0000c5b0: 2029 0a20 2020 2020 2020 2066 6f72 2066   ).        for f
-0000c5c0: 7574 7572 6520 696e 2066 7574 7572 6573  uture in futures
-0000c5d0: 2e61 735f 636f 6d70 6c65 7465 6428 6675  .as_completed(fu
-0000c5e0: 7475 7265 5f74 6f5f 6261 7463 685f 6964  ture_to_batch_id
-0000c5f0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-0000c600: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000c610: 2020 2020 2320 4966 2074 6865 2063 616c      # If the cal
-0000c620: 6375 6c61 7465 2067 6176 6520 7265 7375  culate gave resu
-0000c630: 6c74 730a 2020 2020 2020 2020 2020 2020  lts.            
-0000c640: 2020 2020 6e62 5f62 6174 6368 6573 5f64      nb_batches_d
-0000c650: 6f6e 6520 2b3d 2031 0a20 2020 2020 2020  one += 1.       
-0000c660: 2020 2020 2020 2020 2062 6174 6368 5f69           batch_i
-0000c670: 6420 3d20 6675 7475 7265 5f74 6f5f 6261  d = future_to_ba
-0000c680: 7463 685f 6964 5b66 7574 7572 655d 0a20  tch_id[future]. 
-0000c690: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c6a0: 6573 756c 7420 3d20 6675 7475 7265 2e72  esult = future.r
-0000c6b0: 6573 756c 7428 290a 0a20 2020 2020 2020  esult()..       
-0000c6c0: 2020 2020 2020 2020 2069 6620 7265 7375           if resu
-0000c6d0: 6c74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  lt is not None:.
-0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6f0: 2020 2020 6e62 5f72 6f77 735f 646f 6e65      nb_rows_done
-0000c700: 202b 3d20 7265 7375 6c74 5b22 6e62 5f72   += result["nb_r
-0000c710: 6f77 735f 646f 6e65 225d 0a20 2020 2020  ows_done"].     
-0000c720: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c730: 6620 7265 7375 6c74 5b22 6e62 5f72 6f77  f result["nb_row
-0000c740: 735f 646f 6e65 225d 203e 2030 2061 6e64  s_done"] > 0 and
-0000c750: 2072 6573 756c 745b 2274 6f74 616c 5f74   result["total_t
-0000c760: 696d 6522 5d20 3e20 303a 0a20 2020 2020  ime"] > 0:.     
-0000c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c780: 2020 2072 6f77 735f 7065 725f 7365 6320     rows_per_sec 
-0000c790: 3d20 726f 756e 6428 0a20 2020 2020 2020  = round(.       
+0000b500: 2065 7874 7261 5f70 6172 616d 5f73 7472   extra_param_str
+0000b510: 203d 2066 222c 2027 7b61 6767 5f63 6f6c   = f", '{agg_col
+0000b520: 756d 6e5b 2773 6570 275d 7d27 220a 2020  umn['sep']}'".  
+0000b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b540: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b570: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000b580: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5a0: 2020 2020 2020 6622 6167 6772 6567 6174        f"aggregat
+0000b5b0: 696f 6e20 7b61 6767 5f63 6f6c 756d 6e5b  ion {agg_column[
+0000b5c0: 2761 6767 275d 7d20 6973 206e 6f74 2073  'agg']} is not s
+0000b5d0: 7570 706f 7274 6564 220a 2020 2020 2020  upported".      
+0000b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b610: 2020 2020 2020 2020 2023 2049 6620 6469           # If di
+0000b620: 7374 696e 6374 2069 7320 7370 6563 6966  stinct is specif
+0000b630: 6965 642c 2061 6464 2074 6865 2064 6973  ied, add the dis
+0000b640: 7469 6e63 7420 6b65 7977 6f72 640a 2020  tinct keyword.  
+0000b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b660: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b680: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000b690: 6469 7374 696e 6374 2220 696e 2061 6767  distinct" in agg
+0000b6a0: 5f63 6f6c 756d 6e0a 2020 2020 2020 2020  _column.        
+0000b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6c0: 2020 2020 2020 2020 616e 6420 6167 675f          and agg_
+0000b6d0: 636f 6c75 6d6e 5b22 6469 7374 696e 6374  column["distinct
+0000b6e0: 225d 2069 7320 5472 7565 0a20 2020 2020  "] is True.     
+0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b700: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b720: 2020 2020 2020 2020 2020 6469 7374 696e            distin
+0000b730: 6374 5f73 7472 203d 2022 4449 5354 494e  ct_str = "DISTIN
+0000b740: 4354 2022 0a0a 2020 2020 2020 2020 2020  CT "..          
+0000b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b760: 2020 2320 5072 6570 6172 6520 636f 6c75    # Prepare colu
+0000b770: 6d6e 206e 616d 6520 7374 7269 6e67 2e0a  mn name string..
+0000b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b790: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+0000b7a0: 6d6e 5f73 7472 203d 2028 0a20 2020 2020  mn_str = (.     
+0000b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7c0: 2020 2020 2020 2020 2020 2022 6a73 6f6e             "json
+0000b7d0: 5f65 7874 7261 6374 286a 736f 6e5f 6461  _extract(json_da
+0000b7e0: 7461 2e6a 736f 6e5f 726f 772c 2022 0a20  ta.json_row, ". 
+0000b7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000b810: 2722 242e 7b61 6767 5f63 6f6c 756d 6e5b  '"$.{agg_column[
+0000b820: 2263 6f6c 756d 6e22 5d7d 2229 270a 2020  "column"]}")'.  
+0000b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b840: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b860: 2020 2020 2020 2020 2023 204e 6f77 2070           # Now p
+0000b870: 7574 2065 7665 7279 7468 696e 6720 746f  ut everything to
+0000b880: 6765 7468 6572 0a20 2020 2020 2020 2020  gether.         
+0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8a0: 2020 2061 6767 5f63 6f6c 756d 6e73 5f73     agg_columns_s
+0000b8b0: 7472 202b 3d20 280a 2020 2020 2020 2020  tr += (.        
+0000b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8d0: 2020 2020 2020 2020 6622 2c20 7b61 6767          f", {agg
+0000b8e0: 7265 6761 7469 6f6e 5f73 7472 7d28 7b64  regation_str}({d
+0000b8f0: 6973 7469 6e63 745f 7374 727d 7b63 6f6c  istinct_str}{col
+0000b900: 756d 6e5f 7374 727d 220a 2020 2020 2020  umn_str}".      
+0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b920: 2020 2020 2020 2020 2020 6627 7b65 7874            f'{ext
+0000b930: 7261 5f70 6172 616d 5f73 7472 7d29 2041  ra_param_str}) A
+0000b940: 5320 227b 6167 675f 636f 6c75 6d6e 5b22  S "{agg_column["
+0000b950: 6173 225d 7d22 270a 2020 2020 2020 2020  as"]}"'.        
+0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b970: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000b980: 2020 2020 2020 2023 2041 6464 2061 2063         # Add a c
+0000b990: 6f6c 756d 6e20 746f 206f 7264 6572 2074  olumn to order t
+0000b9a0: 6865 2072 6573 756c 7420 6279 2074 6f20  he result by to 
+0000b9b0: 6576 6164 6520 6861 7669 6e67 2061 6c6c  evade having all
+0000b9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b9d0: 2023 2063 6f6d 706c 6578 2067 656f 6d65   # complex geome
+0000b9e0: 7472 6965 7320 746f 6765 7468 6572 2069  tries together i
+0000b9f0: 6e20 7468 6520 6f75 7470 7574 2066 696c  n the output fil
+0000ba00: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000ba10: 2020 206f 7264 6572 6279 5f63 6f6c 756d     orderby_colum
+0000ba20: 6e20 3d20 2274 656d 705f 6f72 6465 7263  n = "temp_orderc
+0000ba30: 6f6c 756d 6e5f 6765 6f68 6173 6822 0a20  olumn_geohash". 
+0000ba40: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000ba50: 6164 645f 6f72 6465 7262 795f 636f 6c75  add_orderby_colu
+0000ba60: 6d6e 280a 2020 2020 2020 2020 2020 2020  mn(.            
+0000ba70: 2020 2020 2020 2020 7061 7468 3d6f 7574          path=out
+0000ba80: 7075 745f 746d 705f 7061 7468 2c20 6c61  put_tmp_path, la
+0000ba90: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
+0000baa0: 2c20 6e61 6d65 3d6f 7264 6572 6279 5f63  , name=orderby_c
+0000bab0: 6f6c 756d 6e0a 2020 2020 2020 2020 2020  olumn.          
+0000bac0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000bad0: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
+0000bae0: 7265 2053 514c 2073 7461 7465 6d65 6e74  re SQL statement
+0000baf0: 2066 6f72 2066 696e 616c 206f 7574 7075   for final outpu
+0000bb00: 7420 6669 6c65 2e0a 2020 2020 2020 2020  t file..        
+0000bb10: 2020 2020 2020 2020 2320 416c 6c20 7469          # All ti
+0000bb20: 6c65 7320 6172 6520 616c 7265 6164 7920  les are already 
+0000bb30: 6469 7373 6f6c 7665 6420 746f 2067 726f  dissolved to gro
+0000bb40: 7570 732c 2062 7574 206e 6f77 2074 6865  ups, but now the
+0000bb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bb60: 2023 2072 6573 756c 7473 2066 726f 6d20   # results from 
+0000bb70: 616c 6c20 7469 6c65 7320 7374 696c 6c20  all tiles still 
+0000bb80: 6e65 6564 2074 6f20 6265 0a20 2020 2020  need to be.     
+0000bb90: 2020 2020 2020 2020 2020 2023 2067 726f             # gro
+0000bba0: 7570 6564 2f63 6f6c 6c65 6374 6564 2074  uped/collected t
+0000bbb0: 6f67 6574 6865 722e 0a20 2020 2020 2020  ogether..       
+0000bbc0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000bbd0: 696e 666f 2822 506f 7374 7072 6f63 6573  info("Postproces
+0000bbe0: 7320 7072 6570 6172 6564 2066 6561 7475  s prepared featu
+0000bbf0: 7265 732e 2e2e 2229 0a20 2020 2020 2020  res...").       
+0000bc00: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
+0000bc10: 636f 6c75 6d6e 7320 6973 204e 6f6e 653a  columns is None:
+0000bc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc30: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
+0000bc40: 6172 6520 6e6f 2061 6767 7265 6761 7469  are no aggregati
+0000bc50: 6f6e 2063 6f6c 756d 6e73 2c20 7468 696e  on columns, thin
+0000bc60: 6773 2061 7265 206e 6f74 2074 6f6f 0a20  gs are not too. 
+0000bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc80: 2020 2023 2063 6f6d 706c 6963 6174 6564     # complicated
+0000bc90: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000bca0: 2020 2020 2020 6966 2065 7870 6c6f 6465        if explode
+0000bcb0: 636f 6c6c 6563 7469 6f6e 7320 6973 2054  collections is T
+0000bcc0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+0000bcd0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000bce0: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
+0000bcf0: 696f 6e73 2069 7320 7472 7565 2c20 6974  ions is true, it
+0000bd00: 2069 7320 7573 656c 6573 7320 746f 0a20   is useless to. 
+0000bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd20: 2020 2020 2020 2023 2066 6972 7374 2067         # first g
+0000bd30: 726f 7570 2074 6865 6d20 6865 7265 2c20  roup them here, 
+0000bd40: 6173 2074 6865 7920 7769 6c6c 2062 6520  as they will be 
+0000bd50: 6578 706c 6f64 6564 2061 6761 696e 0a20  exploded again. 
+0000bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd70: 2020 2020 2020 2023 2069 6e20 7468 6520         # in the 
+0000bd80: 7365 6c65 6374 2829 2063 616c 6c20 6c61  select() call la
+0000bd90: 7465 7220 6f6e 2e2e 2e20 736f 206a 7573  ter on... so jus
+0000bda0: 7420 6f72 6465 7220 7468 656d 2e0a 2020  t order them..  
+0000bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdc0: 2020 2020 2020 2320 4966 2061 2074 696c        # If a til
+0000bdd0: 6564 2072 6573 756c 7420 6973 2061 736b  ed result is ask
+0000bde0: 6564 2c20 616c 736f 2064 6f6e 2774 2063  ed, also don't c
+0000bdf0: 6f6c 6c65 6374 2e0a 2020 2020 2020 2020  ollect..        
+0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be10: 7371 6c5f 7374 6d74 203d 2066 2222 220a  sql_stmt = f""".
+0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be30: 2020 2020 2020 2020 2020 2020 5345 4c45              SELE
+0000be40: 4354 207b 7b67 656f 6d65 7472 7963 6f6c  CT {{geometrycol
+0000be50: 756d 6e7d 7d0a 2020 2020 2020 2020 2020  umn}}.          
+0000be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be70: 2020 2020 2020 2020 7b67 726f 7570 6279          {groupby
+0000be80: 5f73 656c 6563 745f 7072 6566 6978 6564  _select_prefixed
+0000be90: 5f73 7472 2e66 6f72 6d61 7428 7072 6566  _str.format(pref
+0000bea0: 6978 3d22 6c61 7965 722e 2229 7d0a 2020  ix="layer.")}.  
+0000beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bec0: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
+0000bed0: 2022 7b7b 696e 7075 745f 6c61 7965 727d   "{{input_layer}
+0000bee0: 7d22 206c 6179 6572 0a20 2020 2020 2020  }" layer.       
+0000bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf00: 2020 2020 2020 4f52 4445 5220 4259 206c        ORDER BY l
+0000bf10: 6179 6572 2e7b 6f72 6465 7262 795f 636f  ayer.{orderby_co
+0000bf20: 6c75 6d6e 7d0a 2020 2020 2020 2020 2020  lumn}.          
+0000bf30: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+0000bf40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000bf50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf70: 2020 2020 2320 4e6f 2065 7870 6c6f 6465      # No explode
+0000bf80: 636f 6c6c 6563 7469 6f6e 732c 2073 6f20  collections, so 
+0000bf90: 636f 6c6c 6563 7420 746f 206f 6e65 2067  collect to one g
+0000bfa0: 656f 6d65 7472 790a 2020 2020 2020 2020  eometry.        
+0000bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfc0: 2320 2870 6572 2067 726f 7570 6279 2069  # (per groupby i
+0000bfd0: 6620 6170 706c 6963 6162 6c65 292e 0a20  f applicable).. 
+0000bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bff0: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
+0000c000: 3d20 6622 2222 0a20 2020 2020 2020 2020  = f""".         
+0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c020: 2020 2053 454c 4543 5420 5354 5f43 6f6c     SELECT ST_Col
+0000c030: 6c65 6374 287b 7b67 656f 6d65 7472 7963  lect({{geometryc
+0000c040: 6f6c 756d 6e7d 7d29 2041 5320 7b7b 6765  olumn}}) AS {{ge
+0000c050: 6f6d 6574 7279 636f 6c75 6d6e 7d7d 0a20  ometrycolumn}}. 
+0000c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c080: 207b 6772 6f75 7062 795f 7365 6c65 6374   {groupby_select
+0000c090: 5f70 7265 6669 7865 645f 7374 722e 666f  _prefixed_str.fo
+0000c0a0: 726d 6174 2870 7265 6669 783d 226c 6179  rmat(prefix="lay
+0000c0b0: 6572 2e22 297d 0a20 2020 2020 2020 2020  er.")}.         
+0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0d0: 2020 2020 2046 524f 4d20 227b 7b69 6e70       FROM "{{inp
+0000c0e0: 7574 5f6c 6179 6572 7d7d 2220 6c61 7965  ut_layer}}" laye
+0000c0f0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0000c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c110: 7b67 726f 7570 6279 5f67 726f 7570 6279  {groupby_groupby
+0000c120: 5f70 7265 6669 7865 645f 7374 722e 666f  _prefixed_str.fo
+0000c130: 726d 6174 2870 7265 6669 783d 226c 6179  rmat(prefix="lay
+0000c140: 6572 2e22 297d 0a20 2020 2020 2020 2020  er.")}.         
+0000c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c160: 2020 2020 4f52 4445 5220 4259 204d 494e      ORDER BY MIN
+0000c170: 286c 6179 6572 2e7b 6f72 6465 7262 795f  (layer.{orderby_
+0000c180: 636f 6c75 6d6e 7d29 0a20 2020 2020 2020  column}).       
+0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1a0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+0000c1b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000c1d0: 2049 6620 6167 675f 636f 6c75 6d6e 7320   If agg_columns 
+0000c1e0: 7370 6563 6966 6965 642c 2070 6f73 7470  specified, postp
+0000c1f0: 726f 6365 7373 696e 6720 6973 2061 2062  rocessing is a b
+0000c200: 6974 206d 6f72 650a 2020 2020 2020 2020  it more.        
+0000c210: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0000c220: 6d70 6c69 6361 7465 642e 0a20 2020 2020  mplicated..     
+0000c230: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000c240: 716c 5f73 746d 7420 3d20 6622 2222 0a20  ql_stmt = f""". 
+0000c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c260: 2020 2020 2020 2053 454c 4543 5420 6765         SELECT ge
+0000c270: 6f5f 6461 7461 2e7b 7b67 656f 6d65 7472  o_data.{{geometr
+0000c280: 7963 6f6c 756d 6e7d 7d0a 2020 2020 2020  ycolumn}}.      
+0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2a0: 2020 2020 2020 2020 7b67 726f 7570 6279          {groupby
+0000c2b0: 5f73 656c 6563 745f 7072 6566 6978 6564  _select_prefixed
+0000c2c0: 5f73 7472 2e66 6f72 6d61 7428 7072 6566  _str.format(pref
+0000c2d0: 6978 3d22 6765 6f5f 6461 7461 2e22 297d  ix="geo_data.")}
+0000c2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c2f0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0000c300: 6167 675f 636f 6c75 6d6e 735f 7374 727d  agg_columns_str}
+0000c310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c320: 2020 2020 2020 2020 2020 2046 524f 4d20             FROM 
+0000c330: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c340: 2020 2020 2020 2020 2020 2020 2020 5345                SE
+0000c350: 4c45 4354 2053 545f 436f 6c6c 6563 7428  LECT ST_Collect(
+0000c360: 6c61 7965 725f 6765 6f2e 7b7b 6765 6f6d  layer_geo.{{geom
+0000c370: 6574 7279 636f 6c75 6d6e 7d7d 0a20 2020  etrycolumn}}.   
+0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3a0: 2920 4153 207b 7b67 656f 6d65 7472 7963  ) AS {{geometryc
+0000c3b0: 6f6c 756d 6e7d 7d0a 2020 2020 2020 2020  olumn}}.        
+0000c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3d0: 2020 2020 2020 2020 2020 7b67 726f 7570            {group
+0000c3e0: 6279 5f73 656c 6563 745f 7072 6566 6978  by_select_prefix
+0000c3f0: 6564 5f73 7472 2e66 6f72 6d61 7428 7072  ed_str.format(pr
+0000c400: 6566 6978 3d22 6c61 7965 725f 6765 6f2e  efix="layer_geo.
+0000c410: 2229 7d0a 2020 2020 2020 2020 2020 2020  ")}.            
+0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c430: 2020 2020 2020 2c4d 494e 286c 6179 6572        ,MIN(layer
+0000c440: 5f67 656f 2e7b 6f72 6465 7262 795f 636f  _geo.{orderby_co
+0000c450: 6c75 6d6e 7d29 2061 7320 7b6f 7264 6572  lumn}) as {order
+0000c460: 6279 5f63 6f6c 756d 6e7d 0a20 2020 2020  by_column}.     
+0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c480: 2020 2020 2020 2020 2046 524f 4d20 227b           FROM "{
+0000c490: 7b69 6e70 7574 5f6c 6179 6572 7d7d 2220  {input_layer}}" 
+0000c4a0: 6c61 7965 725f 6765 6f0a 2020 2020 2020  layer_geo.      
+0000c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4c0: 2020 2020 2020 2020 7b67 726f 7570 6279          {groupby
+0000c4d0: 5f67 726f 7570 6279 5f70 7265 6669 7865  _groupby_prefixe
+0000c4e0: 645f 7374 722e 666f 726d 6174 2870 7265  d_str.format(pre
+0000c4f0: 6669 783d 226c 6179 6572 5f67 656f 2e22  fix="layer_geo."
+0000c500: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c520: 2067 656f 5f64 6174 610a 2020 2020 2020   geo_data.      
+0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c540: 2020 2020 4a4f 494e 2028 0a20 2020 2020      JOIN (.     
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c560: 2020 2020 2020 2053 454c 4543 5420 4449         SELECT DI
+0000c570: 5354 494e 4354 206a 736f 6e5f 726f 7773  STINCT json_rows
+0000c580: 5f74 6162 6c65 2e76 616c 7565 2061 7320  _table.value as 
+0000c590: 6a73 6f6e 5f72 6f77 0a20 2020 2020 2020  json_row.       
+0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5b0: 2020 2020 2020 2020 207b 6772 6f75 7062           {groupb
+0000c5c0: 795f 7365 6c65 6374 5f70 7265 6669 7865  y_select_prefixe
+0000c5d0: 645f 7374 722e 666f 726d 6174 2870 7265  d_str.format(pre
+0000c5e0: 6669 783d 226c 6179 6572 5f66 6f72 5f6a  fix="layer_for_j
+0000c5f0: 736f 6e2e 2229 7d0a 2020 2020 2020 2020  son.")}.        
+0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c610: 2020 2020 2020 4652 4f4d 2022 7b7b 696e        FROM "{{in
+0000c620: 7075 745f 6c61 7965 727d 7d22 206c 6179  put_layer}}" lay
+0000c630: 6572 5f66 6f72 5f6a 736f 6e0a 2020 2020  er_for_json.    
+0000c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c650: 2020 2020 2020 2020 2020 4352 4f53 5320            CROSS 
+0000c660: 4a4f 494e 206a 736f 6e5f 6561 6368 280a  JOIN json_each(.
+0000c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c690: 2020 6c61 7965 725f 666f 725f 6a73 6f6e    layer_for_json
+0000c6a0: 2e5f 5f44 4953 534f 4c56 455f 544f 4a53  .__DISSOLVE_TOJS
+0000c6b0: 4f4e 2c20 2224 2229 206a 736f 6e5f 726f  ON, "$") json_ro
+0000c6c0: 7773 5f74 6162 6c65 0a20 2020 2020 2020  ws_table.       
+0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6e0: 2020 2020 2029 206a 736f 6e5f 6461 7461       ) json_data
+0000c6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c700: 2020 2020 2020 2020 2020 5748 4552 4520            WHERE 
+0000c710: 313d 310a 2020 2020 2020 2020 2020 2020  1=1.            
+0000c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c730: 7b67 726f 7570 6279 5f66 696c 7465 725f  {groupby_filter_
+0000c740: 7374 727d 0a20 2020 2020 2020 2020 2020  str}.           
+0000c750: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0000c760: 6772 6f75 7062 795f 6772 6f75 7062 795f  groupby_groupby_
+0000c770: 7072 6566 6978 6564 5f73 7472 2e66 6f72  prefixed_str.for
+0000c780: 6d61 7428 7072 6566 6978 3d22 6765 6f5f  mat(prefix="geo_
+0000c790: 6461 7461 2e22 297d 0a20 2020 2020 2020  data.")}.       
 0000c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7b0: 2020 2020 2072 6573 756c 745b 226e 625f       result["nb_
-0000c7c0: 726f 7773 5f64 6f6e 6522 5d20 2f20 7265  rows_done"] / re
-0000c7d0: 7375 6c74 5b22 746f 7461 6c5f 7469 6d65  sult["total_time
-0000c7e0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0000c7f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c810: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-0000c820: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0000c830: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000c840: 2242 6174 6368 207b 6261 7463 685f 6964  "Batch {batch_id
-0000c850: 7d20 7072 6f63 6573 7365 6420 7b72 6573  } processed {res
-0000c860: 756c 745b 276e 625f 726f 7773 5f64 6f6e  ult['nb_rows_don
-0000c870: 6527 5d7d 2072 6f77 7320 220a 2020 2020  e']} rows ".    
-0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c890: 2020 2020 2020 2020 6622 287b 726f 7773          f"({rows
-0000c8a0: 5f70 6572 5f73 6563 7d2f 7365 6329 220a  _per_sec}/sec)".
-0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8e0: 2020 6966 2022 7065 7266 7374 7269 6e67    if "perfstring
-0000c8f0: 2220 696e 2072 6573 756c 743a 0a20 2020  " in result:.   
-0000c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c910: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000c920: 6465 6275 6728 6622 5065 7266 7374 7269  debug(f"Perfstri
-0000c930: 6e67 3a20 7b72 6573 756c 745b 2770 6572  ng: {result['per
-0000c940: 6673 7472 696e 6727 5d7d 2229 0a0a 2020  fstring']}")..  
-0000c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c960: 2020 2320 5374 6172 7420 636f 7079 206f    # Start copy o
-0000c970: 6620 7468 6520 7265 7375 6c74 2074 6f20  f the result to 
-0000c980: 6120 636f 6d6d 6f6e 2066 696c 650a 2020  a common file.  
-0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9a0: 2020 6261 7463 685f 6964 203d 2066 7574    batch_id = fut
-0000c9b0: 7572 655f 746f 5f62 6174 6368 5f69 645b  ure_to_batch_id[
-0000c9c0: 6675 7475 7265 5d0a 0a20 2020 2020 2020  future]..       
-0000c9d0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0000c9e0: 6620 6361 6c63 756c 6174 6520 6761 7665  f calculate gave
-0000c9f0: 206e 6f74 6f6e 626f 7264 6572 2072 6573   notonborder res
-0000ca00: 756c 7473 2c20 6170 7065 6e64 2074 6f20  ults, append to 
-0000ca10: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
-0000ca20: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0000ca30: 745f 6e6f 746f 6e62 6f72 6465 725f 746d  t_notonborder_tm
-0000ca40: 705f 7061 7274 6961 6c5f 7061 7468 203d  p_partial_path =
-0000ca50: 2062 6174 6368 6573 5b62 6174 6368 5f69   batches[batch_i
-0000ca60: 645d 5b0a 2020 2020 2020 2020 2020 2020  d][.            
-0000ca70: 2020 2020 2020 2020 2020 2020 226f 7574              "out
-0000ca80: 7075 745f 6e6f 746f 6e62 6f72 6465 725f  put_notonborder_
-0000ca90: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
-0000caa0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000cab0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0000cac0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0000cad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cae0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-0000caf0: 6e6f 746f 6e62 6f72 6465 725f 746d 705f  notonborder_tmp_
-0000cb00: 7061 7274 6961 6c5f 7061 7468 2e65 7869  partial_path.exi
-0000cb10: 7374 7328 290a 2020 2020 2020 2020 2020  sts().          
-0000cb20: 2020 2020 2020 2020 2020 2020 2020 616e                an
-0000cb30: 6420 6f75 7470 7574 5f6e 6f74 6f6e 626f  d output_notonbo
-0000cb40: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
-0000cb50: 5f70 6174 682e 7374 6174 2829 2e73 745f  _path.stat().st_
-0000cb60: 7369 7a65 203e 2030 0a20 2020 2020 2020  size > 0.       
-0000cb70: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+0000c7b0: 2020 204f 5244 4552 2042 5920 6765 6f5f     ORDER BY geo_
+0000c7c0: 6461 7461 2e7b 6f72 6465 7262 795f 636f  data.{orderby_co
+0000c7d0: 6c75 6d6e 7d0a 2020 2020 2020 2020 2020  lumn}.          
+0000c7e0: 2020 2020 2020 2020 2020 2222 220a 0a20            """.. 
+0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000c800: 2041 7070 6c79 2077 6865 7265 2070 6172   Apply where par
+0000c810: 616d 6574 6572 2069 6620 6e65 6564 6564  ameter if needed
+0000c820: 2f70 6f73 7369 626c 650a 2020 2020 2020  /possible.      
+0000c830: 2020 2020 2020 2020 2020 6966 2077 6865            if whe
+0000c840: 7265 2069 7320 6e6f 7420 4e6f 6e65 2061  re is not None a
+0000c850: 6e64 206e 6f74 206e 6f74 2065 7870 6c6f  nd not not explo
+0000c860: 6465 636f 6c6c 6563 7469 6f6e 733a 0a20  decollections:. 
+0000c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c880: 2020 2023 2065 7870 6c6f 6465 636f 6c6c     # explodecoll
+0000c890: 6563 7469 6f6e 7320 6973 206e 6f74 2054  ections is not T
+0000c8a0: 7275 652c 2073 6f20 7765 2063 616e 2061  rue, so we can a
+0000c8b0: 6464 2069 7420 746f 2073 716c 5f73 746d  dd it to sql_stm
+0000c8c0: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+0000c8d0: 2020 2020 2020 2023 2049 6620 6578 706c         # If expl
+0000c8e0: 6f64 6563 6f6c 6c65 6374 696f 6e73 2077  odecollections w
+0000c8f0: 6f75 6c64 2062 6520 5472 7565 2c20 7765  ould be True, we
+0000c900: 206e 6565 6420 746f 2077 6169 7420 746f   need to wait to
+0000c910: 2061 7070 6c79 2074 6865 0a20 2020 2020   apply the.     
+0000c920: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000c930: 2077 6865 7265 2074 696c 6c20 6166 7465   where till afte
+0000c940: 7220 6578 706c 6f64 6563 6f6c 6c65 6374  r explodecollect
+0000c950: 696f 6e73 2069 7320 6170 706c 6965 642c  ions is applied,
+0000c960: 2073 6f20 7768 656e 2061 7070 656e 6469   so when appendi
+0000c970: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0000c980: 2020 2020 2020 2023 2074 6865 2070 6172         # the par
+0000c990: 7469 616c 2072 6573 756c 7473 2074 6f20  tial results to 
+0000c9a0: 7468 6520 6f75 7470 7574 2066 696c 652e  the output file.
+0000c9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c9c0: 2020 2020 2077 6865 7265 203d 2077 6865       where = whe
+0000c9d0: 7265 2e66 6f72 6d61 7428 6765 6f6d 6574  re.format(geomet
+0000c9e0: 7279 636f 6c75 6d6e 3d22 6765 6f6d 2229  rycolumn="geom")
+0000c9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ca00: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
+0000ca10: 6622 2222 0a20 2020 2020 2020 2020 2020  f""".           
+0000ca20: 2020 2020 2020 2020 2020 2020 2053 454c               SEL
+0000ca30: 4543 5420 2a20 4652 4f4d 0a20 2020 2020  ECT * FROM.     
+0000ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca50: 2020 2020 2020 2028 207b 7371 6c5f 7374         ( {sql_st
+0000ca60: 6d74 7d0a 2020 2020 2020 2020 2020 2020  mt}.            
+0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ca90: 2020 2020 2020 2020 2020 5748 4552 4520            WHERE 
+0000caa0: 7b77 6865 7265 7d0a 2020 2020 2020 2020  {where}.        
+0000cab0: 2020 2020 2020 2020 2020 2020 2222 220a              """.
+0000cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cad0: 2020 2020 2320 5768 6572 6520 6861 7320      # Where has 
+0000cae0: 6265 656e 2061 7070 6c69 6564 2061 6c72  been applied alr
+0000caf0: 6561 6479 2073 6f20 7365 7420 746f 204e  eady so set to N
+0000cb00: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
+0000cb10: 2020 2020 2020 2020 2077 6865 7265 203d           where =
+0000cb20: 204e 6f6e 650a 0a20 2020 2020 2020 2020   None..         
+0000cb30: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0000cb40: 666f 2822 506f 7374 7072 6f63 6573 7320  fo("Postprocess 
+0000cb50: 6f75 7470 7574 2066 696c 6522 290a 2020  output file").  
+0000cb60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000cb70: 2077 6865 7265 2069 7320 4e6f 6e65 3a0a   where is None:.
 0000cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb90: 2020 2020 2020 2020 6669 6c65 6f70 732e          fileops.
-0000cba0: 5f61 7070 656e 645f 746f 5f6e 6f6c 6f63  _append_to_noloc
-0000cbb0: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
-0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000cbd0: 7263 3d6f 7574 7075 745f 6e6f 746f 6e62  rc=output_notonb
-0000cbe0: 6f72 6465 725f 746d 705f 7061 7274 6961  order_tmp_partia
-0000cbf0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-0000cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc10: 2020 2020 6473 743d 6f75 7470 7574 5f6e      dst=output_n
-0000cc20: 6f74 6f6e 626f 7264 6572 5f70 6174 682c  otonborder_path,
-0000cc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cc40: 2020 2020 2020 2020 2020 2020 2063 7265               cre
-0000cc50: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-0000cc60: 783d 4661 6c73 652c 0a20 2020 2020 2020  x=False,.       
-0000cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc80: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000cc90: 2020 2020 2020 2020 2020 2067 666f 2e72             gfo.r
-0000cca0: 656d 6f76 6528 6f75 7470 7574 5f6e 6f74  emove(output_not
-0000ccb0: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
-0000ccc0: 7469 616c 5f70 6174 6829 0a0a 2020 2020  tial_path)..    
-0000ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cce0: 2320 4966 2063 616c 6375 6c61 7465 2067  # If calculate g
-0000ccf0: 6176 6520 6f6e 626f 7264 6572 2072 6573  ave onborder res
-0000cd00: 756c 7473 2c20 6170 7065 6e64 2074 6f20  ults, append to 
-0000cd10: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
-0000cd20: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0000cd30: 745f 6f6e 626f 7264 6572 5f74 6d70 5f70  t_onborder_tmp_p
-0000cd40: 6172 7469 616c 5f70 6174 6820 3d20 6261  artial_path = ba
-0000cd50: 7463 6865 735b 6261 7463 685f 6964 5d5b  tches[batch_id][
-0000cd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd70: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
-0000cd80: 5f6f 6e62 6f72 6465 725f 746d 705f 7061  _onborder_tmp_pa
-0000cd90: 7274 6961 6c5f 7061 7468 220a 2020 2020  rtial_path".    
-0000cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cdb0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000cdc0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0000cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cde0: 2020 206f 7574 7075 745f 6f6e 626f 7264     output_onbord
-0000cdf0: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
-0000ce00: 6174 682e 6578 6973 7473 2829 0a20 2020  ath.exists().   
+0000cb90: 2020 2020 6e61 6d65 203d 2066 226f 7574      name = f"out
+0000cba0: 7075 745f 746d 7032 5f66 696e 616c 7b6f  put_tmp2_final{o
+0000cbb0: 7574 7075 745f 7061 7468 2e73 7566 6669  utput_path.suffi
+0000cbc0: 787d 220a 2020 2020 2020 2020 2020 2020  x}".            
+0000cbd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000cbe0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0000cbf0: 6d65 203d 2066 226f 7574 7075 745f 746d  me = f"output_tm
+0000cc00: 7032 5f66 696e 616c 7b6f 7574 7075 745f  p2_final{output_
+0000cc10: 746d 705f 7061 7468 2e73 7566 6669 787d  tmp_path.suffix}
+0000cc20: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000cc30: 2020 6f75 7470 7574 5f74 6d70 325f 6669    output_tmp2_fi
+0000cc40: 6e61 6c5f 7061 7468 203d 2074 656d 7064  nal_path = tempd
+0000cc50: 6972 202f 206e 616d 650a 2020 2020 2020  ir / name.      
+0000cc60: 2020 2020 2020 2020 2020 7371 6c5f 7374            sql_st
+0000cc70: 6d74 203d 2073 716c 5f73 746d 742e 666f  mt = sql_stmt.fo
+0000cc80: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+0000cc90: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
+0000cca0: 7279 636f 6c75 6d6e 3d22 6765 6f6d 222c  rycolumn="geom",
+0000ccb0: 2069 6e70 7574 5f6c 6179 6572 3d6f 7574   input_layer=out
+0000ccc0: 7075 745f 6c61 7965 720a 2020 2020 2020  put_layer.      
+0000ccd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000cce0: 2020 2020 2020 2020 2020 2020 6372 6561              crea
+0000ccf0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+0000cd00: 203d 2054 7275 6520 6966 2077 6865 7265   = True if where
+0000cd10: 2069 7320 4e6f 6e65 2065 6c73 6520 4661   is None else Fa
+0000cd20: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0000cd30: 2020 2020 5f6f 6772 5f75 7469 6c2e 7665      _ogr_util.ve
+0000cd40: 6374 6f72 5f74 7261 6e73 6c61 7465 280a  ctor_translate(.
+0000cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd60: 2020 2020 696e 7075 745f 7061 7468 3d6f      input_path=o
+0000cd70: 7574 7075 745f 746d 705f 7061 7468 2c0a  utput_tmp_path,.
+0000cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd90: 2020 2020 6f75 7470 7574 5f70 6174 683d      output_path=
+0000cda0: 6f75 7470 7574 5f74 6d70 325f 6669 6e61  output_tmp2_fina
+0000cdb0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
+0000cdc0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000cdd0: 7574 5f6c 6179 6572 3d6f 7574 7075 745f  ut_layer=output_
+0000cde0: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
+0000cdf0: 2020 2020 2020 2020 2020 2073 716c 5f73             sql_s
+0000ce00: 746d 743d 7371 6c5f 7374 6d74 2c0a 2020  tmt=sql_stmt,.  
 0000ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce20: 2020 2020 2061 6e64 206f 7574 7075 745f       and output_
-0000ce30: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
-0000ce40: 7469 616c 5f70 6174 682e 7374 6174 2829  tial_path.stat()
-0000ce50: 2e73 745f 7369 7a65 203e 2030 0a20 2020  .st_size > 0.   
-0000ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce70: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0000ce80: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0000ce90: 6f70 732e 5f61 7070 656e 645f 746f 5f6e  ops._append_to_n
-0000cea0: 6f6c 6f63 6b28 0a20 2020 2020 2020 2020  olock(.         
-0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cec0: 2020 2073 7263 3d6f 7574 7075 745f 6f6e     src=output_on
-0000ced0: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
-0000cee0: 616c 5f70 6174 682c 0a20 2020 2020 2020  al_path,.       
-0000cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf00: 2020 2020 2064 7374 3d6f 7574 7075 745f       dst=output_
-0000cf10: 6f6e 626f 7264 6572 5f70 6174 682c 0a20  onborder_path,. 
-0000cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf30: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-0000cf40: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
-0000cf50: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-0000cf60: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000cf70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cf80: 2020 2020 2020 2020 2067 666f 2e72 656d           gfo.rem
-0000cf90: 6f76 6528 6f75 7470 7574 5f6f 6e62 6f72  ove(output_onbor
-0000cfa0: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
-0000cfb0: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
-0000cfc0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0000cfd0: 696f 6e20 6173 2065 783a 0a20 2020 2020  ion as ex:.     
-0000cfe0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
-0000cff0: 5f69 6420 3d20 6675 7475 7265 5f74 6f5f  _id = future_to_
-0000d000: 6261 7463 685f 6964 5b66 7574 7572 655d  batch_id[future]
-0000d010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d020: 206d 6573 7361 6765 203d 2066 2245 7272   message = f"Err
-0000d030: 6f72 2065 7865 6375 7469 6e67 207b 6261  or executing {ba
-0000d040: 7463 6865 735b 6261 7463 685f 6964 5d7d  tches[batch_id]}
-0000d050: 3a20 7b65 787d 220a 2020 2020 2020 2020  : {ex}".        
-0000d060: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-0000d070: 7863 6570 7469 6f6e 286d 6573 7361 6765  xception(message
-0000d080: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000d090: 2020 6361 6c63 756c 6174 655f 706f 6f6c    calculate_pool
-0000d0a0: 2e73 6875 7464 6f77 6e28 290a 2020 2020  .shutdown().    
-0000d0b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000d0c0: 6520 4578 6365 7074 696f 6e28 6d65 7373  e Exception(mess
-0000d0d0: 6167 6529 2066 726f 6d20 6578 0a0a 2020  age) from ex..  
-0000d0e0: 2020 2020 2020 2020 2020 2320 4c6f 6720            # Log 
-0000d0f0: 7468 6520 7072 6f67 7265 7373 2061 6e64  the progress and
-0000d100: 2070 7265 6469 6374 696f 6e20 7370 6565   prediction spee
-0000d110: 640a 2020 2020 2020 2020 2020 2020 5f67  d.            _g
-0000d120: 656e 6572 616c 5f75 7469 6c2e 7265 706f  eneral_util.repo
-0000d130: 7274 5f70 726f 6772 6573 7328 0a20 2020  rt_progress(.   
-0000d140: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0000d150: 7274 5f74 696d 652c 206e 625f 6261 7463  rt_time, nb_batc
-0000d160: 6865 735f 646f 6e65 2c20 6e62 5f62 6174  hes_done, nb_bat
-0000d170: 6368 6573 2c20 2264 6973 736f 6c76 6522  ches, "dissolve"
-0000d180: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0000d190: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0000d1a0: 6622 4469 7373 6f6c 7665 2070 6173 7320  f"Dissolve pass 
-0000d1b0: 7265 6164 792c 2074 6f6f 6b20 7b64 6174  ready, took {dat
-0000d1c0: 6574 696d 652e 6e6f 7728 292d 7374 6172  etime.now()-star
-0000d1d0: 745f 7469 6d65 7d21 2229 0a0a 2020 2020  t_time}!")..    
-0000d1e0: 7265 7475 726e 2072 6573 756c 745f 696e  return result_in
-0000d1f0: 666f 0a0a 0a64 6566 205f 6469 7373 6f6c  fo...def _dissol
-0000d200: 7665 5f70 6f6c 7967 6f6e 7328 0a20 2020  ve_polygons(.   
-0000d210: 2069 6e70 7574 5f70 6174 683a 2050 6174   input_path: Pat
-0000d220: 682c 0a20 2020 206f 7574 7075 745f 6e6f  h,.    output_no
-0000d230: 746f 6e62 6f72 6465 725f 7061 7468 3a20  tonborder_path: 
-0000d240: 5061 7468 2c0a 2020 2020 6f75 7470 7574  Path,.    output
-0000d250: 5f6f 6e62 6f72 6465 725f 7061 7468 3a20  _onborder_path: 
-0000d260: 5061 7468 2c0a 2020 2020 6578 706c 6f64  Path,.    explod
-0000d270: 6563 6f6c 6c65 6374 696f 6e73 3a20 626f  ecollections: bo
-0000d280: 6f6c 2c0a 2020 2020 6772 6f75 7062 795f  ol,.    groupby_
-0000d290: 636f 6c75 6d6e 733a 204f 7074 696f 6e61  columns: Optiona
-0000d2a0: 6c5b 4974 6572 6162 6c65 5b73 7472 5d5d  l[Iterable[str]]
-0000d2b0: 2c0a 2020 2020 6167 675f 636f 6c75 6d6e  ,.    agg_column
-0000d2c0: 733a 204f 7074 696f 6e61 6c5b 6469 6374  s: Optional[dict
-0000d2d0: 5d2c 0a20 2020 2069 6e70 7574 5f67 656f  ],.    input_geo
-0000d2e0: 6d65 7472 7974 7970 653a 2047 656f 6d65  metrytype: Geome
-0000d2f0: 7472 7954 7970 652c 0a20 2020 2069 6e70  tryType,.    inp
-0000d300: 7574 5f6c 6179 6572 3a20 4f70 7469 6f6e  ut_layer: Option
-0000d310: 616c 5b73 7472 5d2c 0a20 2020 206f 7574  al[str],.    out
-0000d320: 7075 745f 6c61 7965 723a 204f 7074 696f  put_layer: Optio
-0000d330: 6e61 6c5b 7374 725d 2c0a 2020 2020 6262  nal[str],.    bb
-0000d340: 6f78 3a20 5475 706c 655b 666c 6f61 742c  ox: Tuple[float,
-0000d350: 2066 6c6f 6174 2c20 666c 6f61 742c 2066   float, float, f
-0000d360: 6c6f 6174 5d2c 0a20 2020 2074 696c 655f  loat],.    tile_
-0000d370: 6964 3a20 4f70 7469 6f6e 616c 5b69 6e74  id: Optional[int
-0000d380: 5d2c 0a20 2020 2067 7269 6473 697a 653a  ],.    gridsize:
-0000d390: 2066 6c6f 6174 2c0a 2920 2d3e 2064 6963   float,.) -> dic
-0000d3a0: 743a 0a20 2020 2023 2049 6e69 740a 2020  t:.    # Init.  
-0000d3b0: 2020 7065 7266 696e 666f 203d 207b 7d0a    perfinfo = {}.
-0000d3c0: 2020 2020 7374 6172 745f 7469 6d65 203d      start_time =
-0000d3d0: 2064 6174 6574 696d 652e 6e6f 7728 290a   datetime.now().
-0000d3e0: 2020 2020 7265 7475 726e 5f69 6e66 6f20      return_info 
-0000d3f0: 3d20 7b0a 2020 2020 2020 2020 2269 6e70  = {.        "inp
-0000d400: 7574 5f70 6174 6822 3a20 696e 7075 745f  ut_path": input_
-0000d410: 7061 7468 2c0a 2020 2020 2020 2020 226f  path,.        "o
-0000d420: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
-0000d430: 725f 7061 7468 223a 206f 7574 7075 745f  r_path": output_
-0000d440: 6e6f 746f 6e62 6f72 6465 725f 7061 7468  notonborder_path
-0000d450: 2c0a 2020 2020 2020 2020 226f 7574 7075  ,.        "outpu
-0000d460: 745f 6f6e 626f 7264 6572 5f70 6174 6822  t_onborder_path"
-0000d470: 3a20 6f75 7470 7574 5f6f 6e62 6f72 6465  : output_onborde
-0000d480: 725f 7061 7468 2c0a 2020 2020 2020 2020  r_path,.        
-0000d490: 2262 626f 7822 3a20 6262 6f78 2c0a 2020  "bbox": bbox,.  
-0000d4a0: 2020 2020 2020 2274 696c 655f 6964 223a        "tile_id":
-0000d4b0: 2074 696c 655f 6964 2c0a 2020 2020 2020   tile_id,.      
-0000d4c0: 2020 2267 7269 6473 697a 6522 3a20 6772    "gridsize": gr
-0000d4d0: 6964 7369 7a65 2c0a 2020 2020 2020 2020  idsize,.        
-0000d4e0: 226e 625f 726f 7773 5f64 6f6e 6522 3a20  "nb_rows_done": 
-0000d4f0: 302c 0a20 2020 2020 2020 2022 746f 7461  0,.        "tota
-0000d500: 6c5f 7469 6d65 223a 2030 2c0a 2020 2020  l_time": 0,.    
-0000d510: 2020 2020 2270 6572 6669 6e66 6f22 3a20      "perfinfo": 
-0000d520: 2222 2c0a 2020 2020 7d0a 0a20 2020 2023  "",.    }..    #
-0000d530: 2052 6561 6420 616c 6c20 7265 636f 7264   Read all record
-0000d540: 7320 7468 6174 2061 7265 2069 6e20 7468  s that are in th
-0000d550: 6520 6262 6f78 0a20 2020 2072 6574 7279  e bbox.    retry
-0000d560: 5f63 6f75 6e74 203d 2030 0a20 2020 2073  _count = 0.    s
-0000d570: 7461 7274 5f72 6561 6420 3d20 6461 7465  tart_read = date
-0000d580: 7469 6d65 2e6e 6f77 2829 0a20 2020 2061  time.now().    a
-0000d590: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
-0000d5a0: 6420 3d20 4e6f 6e65 0a20 2020 2077 6869  d = None.    whi
-0000d5b0: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
-0000d5c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000d5d0: 2020 636f 6c75 6d6e 735f 746f 5f72 6561    columns_to_rea
-0000d5e0: 6420 3d20 7365 7428 290a 2020 2020 2020  d = set().      
-0000d5f0: 2020 2020 2020 696e 666f 203d 2067 666f        info = gfo
-0000d600: 2e67 6574 5f6c 6179 6572 696e 666f 2869  .get_layerinfo(i
-0000d610: 6e70 7574 5f70 6174 682c 2069 6e70 7574  nput_path, input
-0000d620: 5f6c 6179 6572 290a 2020 2020 2020 2020  _layer).        
-0000d630: 2020 2020 6966 2067 726f 7570 6279 5f63      if groupby_c
-0000d640: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
-0000d650: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000d660: 2020 2020 636f 6c75 6d6e 735f 746f 5f72      columns_to_r
-0000d670: 6561 642e 7570 6461 7465 2867 726f 7570  ead.update(group
-0000d680: 6279 5f63 6f6c 756d 6e73 290a 2020 2020  by_columns).    
-0000d690: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
-0000d6a0: 6e64 6578 203d 2046 616c 7365 0a20 2020  ndex = False.   
-0000d6b0: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
-0000d6c0: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
-0000d6d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000d6e0: 2020 2020 2066 6964 5f61 735f 696e 6465       fid_as_inde
-0000d6f0: 7820 3d20 5472 7565 0a20 2020 2020 2020  x = True.       
-0000d700: 2020 2020 2020 2020 2069 6620 225f 5f44           if "__D
-0000d710: 4953 534f 4c56 455f 544f 4a53 4f4e 2220  ISSOLVE_TOJSON" 
-0000d720: 696e 2069 6e66 6f2e 636f 6c75 6d6e 733a  in info.columns:
-0000d730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d740: 2020 2020 2023 2049 6620 7765 2061 7265       # If we are
-0000d750: 206e 6f74 2069 6e20 7468 6520 6669 7273   not in the firs
-0000d760: 7420 7061 7373 2c20 7468 6520 636f 6c75  t pass, the colu
-0000d770: 6d6e 7320 746f 2062 6520 7265 6164 0a20  mns to be read. 
-0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d790: 2020 2023 2061 7265 2061 6c72 6561 6479     # are already
-0000d7a0: 2069 6e20 7468 6520 6a73 6f6e 2063 6f6c   in the json col
-0000d7b0: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
-0000d7c0: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
-0000d7d0: 746f 5f72 6561 642e 6164 6428 225f 5f44  to_read.add("__D
-0000d7e0: 4953 534f 4c56 455f 544f 4a53 4f4e 2229  ISSOLVE_TOJSON")
-0000d7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d800: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000d810: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-0000d820: 2066 6972 7374 2070 6173 732c 2073 6f20   first pass, so 
-0000d830: 7265 6164 2061 6c6c 2072 656c 6576 616e  read all relevan
-0000d840: 7420 636f 6c75 6d6e 7320 746f 2063 6f64  t columns to cod
-0000d850: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000d860: 2020 2020 2020 2320 7468 656d 2069 6e20        # them in 
-0000d870: 6a73 6f6e 0a20 2020 2020 2020 2020 2020  json.           
-0000d880: 2020 2020 2020 2020 2069 6620 226a 736f           if "jso
-0000d890: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
-0000d8a0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000d8b0: 2020 2020 2020 2020 2020 2061 6767 5f63             agg_c
-0000d8c0: 6f6c 756d 6e73 5f6e 6565 6465 6420 3d20  olumns_needed = 
-0000d8d0: 6167 675f 636f 6c75 6d6e 735b 226a 736f  agg_columns["jso
-0000d8e0: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
-0000d8f0: 2020 2020 2020 2020 656c 6966 2022 636f          elif "co
-0000d900: 6c75 6d6e 7322 2069 6e20 6167 675f 636f  lumns" in agg_co
-0000d910: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
-0000d920: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000d930: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
-0000d940: 6420 3d20 5b0a 2020 2020 2020 2020 2020  d = [.          
-0000d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d960: 2020 6167 675f 636f 6c75 6d6e 5b22 636f    agg_column["co
-0000d970: 6c75 6d6e 225d 0a20 2020 2020 2020 2020  lumn"].         
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2066 6f72 2061 6767 5f63 6f6c 756d     for agg_colum
-0000d9a0: 6e20 696e 2061 6767 5f63 6f6c 756d 6e73  n in agg_columns
-0000d9b0: 5b22 636f 6c75 6d6e 7322 5d0a 2020 2020  ["columns"].    
-0000d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9d0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-0000d9e0: 2020 2020 2020 2020 2020 6966 2061 6767            if agg
-0000d9f0: 5f63 6f6c 756d 6e73 5f6e 6565 6465 6420  _columns_needed 
-0000da00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da20: 2020 2020 2063 6f6c 756d 6e73 5f74 6f5f       columns_to_
-0000da30: 7265 6164 2e75 7064 6174 6528 6167 675f  read.update(agg_
-0000da40: 636f 6c75 6d6e 735f 6e65 6564 6564 290a  columns_needed).
-0000da50: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
-0000da60: 7574 5f67 6466 203d 2067 666f 2e72 6561  ut_gdf = gfo.rea
-0000da70: 645f 6669 6c65 280a 2020 2020 2020 2020  d_file(.        
-0000da80: 2020 2020 2020 2020 7061 7468 3d69 6e70          path=inp
-0000da90: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
-0000daa0: 2020 2020 2020 2020 206c 6179 6572 3d69           layer=i
-0000dab0: 6e70 7574 5f6c 6179 6572 2c0a 2020 2020  nput_layer,.    
-0000dac0: 2020 2020 2020 2020 2020 2020 6262 6f78              bbox
-0000dad0: 3d62 626f 782c 0a20 2020 2020 2020 2020  =bbox,.         
-0000dae0: 2020 2020 2020 2063 6f6c 756d 6e73 3d63         columns=c
-0000daf0: 6f6c 756d 6e73 5f74 6f5f 7265 6164 2c0a  olumns_to_read,.
-0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db10: 6669 645f 6173 5f69 6e64 6578 3d66 6964  fid_as_index=fid
-0000db20: 5f61 735f 696e 6465 782c 0a20 2020 2020  _as_index,.     
-0000db30: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000db40: 2020 2020 2020 6966 2061 6767 5f63 6f6c        if agg_col
-0000db50: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
-0000db60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000db70: 2020 696e 7075 745f 6764 665b 2266 6964    input_gdf["fid
-0000db80: 5f6f 7269 6722 5d20 3d20 696e 7075 745f  _orig"] = input_
-0000db90: 6764 662e 696e 6465 780a 2020 2020 2020  gdf.index.      
-0000dba0: 2020 2020 2020 2020 2020 6966 2061 6767            if agg
-0000dbb0: 5f63 6f6c 756d 6e73 5f6e 6565 6465 6420  _columns_needed 
-0000dbc0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbe0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
-0000dbf0: 6465 642e 6170 7065 6e64 2822 6669 645f  ded.append("fid_
-0000dc00: 6f72 6967 2229 0a0a 2020 2020 2020 2020  orig")..        
-0000dc10: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-0000dc20: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000dc30: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
-0000dc40: 2020 2020 2020 6966 2073 7472 2865 7829        if str(ex)
-0000dc50: 203d 3d20 2264 6174 6162 6173 6520 6973   == "database is
-0000dc60: 206c 6f63 6b65 6422 3a0a 2020 2020 2020   locked":.      
-0000dc70: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
-0000dc80: 7279 5f63 6f75 6e74 203c 2031 303a 0a20  ry_count < 10:. 
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dca0: 2020 2072 6574 7279 5f63 6f75 6e74 202b     retry_count +
-0000dcb0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0000dcc0: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-0000dcd0: 6570 2831 290a 2020 2020 2020 2020 2020  ep(1).          
-0000dce0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd00: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0000dd10: 2272 6574 7269 6564 2031 3020 7469 6d65  "retried 10 time
-0000dd20: 732c 2064 6174 6162 6173 6520 7374 696c  s, database stil
-0000dd30: 6c20 6c6f 636b 6564 2229 2066 726f 6d20  l locked") from 
-0000dd40: 6578 0a20 2020 2020 2020 2020 2020 2065  ex.            e
-0000dd50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000dd60: 2020 2020 2072 6169 7365 2065 780a 0a20       raise ex.. 
-0000dd70: 2020 2023 2043 6865 636b 2072 6573 756c     # Check resul
-0000dd80: 740a 2020 2020 7065 7266 696e 666f 5b22  t.    perfinfo["
-0000dd90: 7469 6d65 5f72 6561 6422 5d20 3d20 2864  time_read"] = (d
-0000dda0: 6174 6574 696d 652e 6e6f 7728 2920 2d20  atetime.now() - 
-0000ddb0: 7374 6172 745f 7265 6164 292e 746f 7461  start_read).tota
-0000ddc0: 6c5f 7365 636f 6e64 7328 290a 2020 2020  l_seconds().    
-0000ddd0: 7265 7475 726e 5f69 6e66 6f5b 226e 625f  return_info["nb_
-0000dde0: 726f 7773 5f64 6f6e 6522 5d20 3d20 6c65  rows_done"] = le
-0000ddf0: 6e28 696e 7075 745f 6764 6629 0a20 2020  n(input_gdf).   
-0000de00: 2069 6620 7265 7475 726e 5f69 6e66 6f5b   if return_info[
-0000de10: 226e 625f 726f 7773 5f64 6f6e 6522 5d20  "nb_rows_done"] 
-0000de20: 3d3d 2030 3a0a 2020 2020 2020 2020 6d65  == 0:.        me
-0000de30: 7373 6167 6520 3d20 6622 4e6f 2069 6e70  ssage = f"No inp
-0000de40: 7574 2067 656f 6d65 7472 6965 7320 666f  ut geometries fo
-0000de50: 756e 6420 696e 207b 696e 7075 745f 7061  und in {input_pa
-0000de60: 7468 7d22 0a20 2020 2020 2020 206c 6f67  th}".        log
-0000de70: 6765 722e 696e 666f 286d 6573 7361 6765  ger.info(message
-0000de80: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000de90: 5f69 6e66 6f5b 226d 6573 7361 6765 225d  _info["message"]
-0000dea0: 203d 206d 6573 7361 6765 0a20 2020 2020   = message.     
-0000deb0: 2020 2072 6574 7572 6e5f 696e 666f 5b22     return_info["
-0000dec0: 746f 7461 6c5f 7469 6d65 225d 203d 2028  total_time"] = (
-0000ded0: 6461 7465 7469 6d65 2e6e 6f77 2829 202d  datetime.now() -
-0000dee0: 2073 7461 7274 5f74 696d 6529 2e74 6f74   start_time).tot
-0000def0: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
-0000df00: 2020 2020 2072 6574 7572 6e20 7265 7475       return retu
-0000df10: 726e 5f69 6e66 6f0a 0a20 2020 2023 204e  rn_info..    # N
-0000df20: 6f77 2074 6865 2072 6561 6c20 7072 6f63  ow the real proc
-0000df30: 6573 7369 6e67 0a20 2020 2069 6620 6167  essing.    if ag
-0000df40: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
-0000df50: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-0000df60: 6620 225f 5f44 4953 534f 4c56 455f 544f  f "__DISSOLVE_TO
-0000df70: 4a53 4f4e 2220 6e6f 7420 696e 2069 6e70  JSON" not in inp
-0000df80: 7574 5f67 6466 2e63 6f6c 756d 6e73 3a0a  ut_gdf.columns:.
-0000df90: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
-0000dfa0: 7273 7420 7061 7373 202d 3e20 7075 7420  rst pass -> put 
-0000dfb0: 7265 6c65 7661 6e74 2063 6f6c 756d 6e73  relevant columns
-0000dfc0: 2069 6e20 6a73 6f6e 2066 6965 6c64 0a20   in json field. 
-0000dfd0: 2020 2020 2020 2020 2020 2061 6767 6675             aggfu
-0000dfe0: 6e63 203d 207b 2274 6f5f 6a73 6f6e 223a  nc = {"to_json":
-0000dff0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
-0000e000: 6465 647d 0a20 2020 2020 2020 2065 6c73  ded}.        els
-0000e010: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0000e020: 2043 6f6c 756d 6e73 2061 6c72 6561 6479   Columns already
-0000e030: 2063 6f64 6564 2069 6e20 6120 6a73 6f6e   coded in a json
-0000e040: 2063 6f6c 756d 6e2c 2073 6f20 6d65 7267   column, so merg
-0000e050: 6520 6a73 6f6e 206c 6973 7473 0a20 2020  e json lists.   
-0000e060: 2020 2020 2020 2020 2061 6767 6675 6e63           aggfunc
-0000e070: 203d 2022 6d65 7267 655f 6a73 6f6e 5f6c   = "merge_json_l
-0000e080: 6973 7473 220a 2020 2020 656c 7365 3a0a  ists".    else:.
-0000e090: 2020 2020 2020 2020 6167 6766 756e 6320          aggfunc 
-0000e0a0: 3d20 2266 6972 7374 220a 2020 2020 7374  = "first".    st
-0000e0b0: 6172 745f 6469 7373 6f6c 7665 203d 2064  art_dissolve = d
-0000e0c0: 6174 6574 696d 652e 6e6f 7728 290a 2020  atetime.now().  
-0000e0d0: 2020 6469 7373 5f67 6466 203d 205f 6469    diss_gdf = _di
-0000e0e0: 7373 6f6c 7665 280a 2020 2020 2020 2020  ssolve(.        
-0000e0f0: 6466 3d69 6e70 7574 5f67 6466 2c20 6279  df=input_gdf, by
-0000e100: 3d67 726f 7570 6279 5f63 6f6c 756d 6e73  =groupby_columns
-0000e110: 2c20 6167 6766 756e 633d 6167 6766 756e  , aggfunc=aggfun
-0000e120: 632c 2061 735f 696e 6465 783d 4661 6c73  c, as_index=Fals
-0000e130: 652c 2064 726f 706e 613d 4661 6c73 650a  e, dropna=False.
-0000e140: 2020 2020 290a 2020 2020 7065 7266 696e      ).    perfin
-0000e150: 666f 5b22 7469 6d65 5f64 6973 736f 6c76  fo["time_dissolv
-0000e160: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
-0000e170: 6e6f 7728 2920 2d20 7374 6172 745f 6469  now() - start_di
-0000e180: 7373 6f6c 7665 292e 746f 7461 6c5f 7365  ssolve).total_se
-0000e190: 636f 6e64 7328 290a 0a20 2020 2023 2049  conds()..    # I
-0000e1a0: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
-0000e1b0: 696f 6e73 2069 7320 5472 7565 2061 6e64  ions is True and
-0000e1c0: 2046 6f72 2070 6f6c 7967 6f6e 732c 2065   For polygons, e
-0000e1d0: 7870 6c6f 6465 206d 756c 7469 2d67 656f  xplode multi-geo
-0000e1e0: 6d65 7472 6965 732e 0a20 2020 2023 2049  metries..    # I
-0000e1f0: 6620 6e65 6564 6564 2074 6865 7920 7769  f needed they wi
-0000e200: 6c6c 2062 6520 2763 6f6c 6c65 6374 6564  ll be 'collected
-0000e210: 2720 6166 7465 7277 6172 6473 2074 6f20  ' afterwards to 
-0000e220: 6d75 6c74 6970 6f6c 7967 6f6e 7320 6167  multipolygons ag
-0000e230: 6169 6e2e 0a20 2020 2069 6620 6578 706c  ain..    if expl
-0000e240: 6f64 6563 6f6c 6c65 6374 696f 6e73 2069  odecollections i
-0000e250: 7320 5472 7565 206f 7220 696e 7075 745f  s True or input_
-0000e260: 6765 6f6d 6574 7279 7479 7065 2069 6e20  geometrytype in 
-0000e270: 5b0a 2020 2020 2020 2020 4765 6f6d 6574  [.        Geomet
-0000e280: 7279 5479 7065 2e50 4f4c 5947 4f4e 2c0a  ryType.POLYGON,.
-0000e290: 2020 2020 2020 2020 4765 6f6d 6574 7279          Geometry
-0000e2a0: 5479 7065 2e4d 554c 5449 504f 4c59 474f  Type.MULTIPOLYGO
-0000e2b0: 4e2c 0a20 2020 205d 3a0a 2020 2020 2020  N,.    ]:.      
-0000e2c0: 2020 2320 6173 7365 7274 2074 6f20 6576    # assert to ev
-0000e2d0: 6164 6520 7079 4c61 6e63 6520 7761 726e  ade pyLance warn
-0000e2e0: 696e 670a 2020 2020 2020 2020 6173 7365  ing.        asse
-0000e2f0: 7274 2069 7369 6e73 7461 6e63 6528 6469  rt isinstance(di
-0000e300: 7373 5f67 6466 2c20 6770 642e 4765 6f44  ss_gdf, gpd.GeoD
-0000e310: 6174 6146 7261 6d65 290a 2020 2020 2020  ataFrame).      
-0000e320: 2020 6469 7373 5f67 6466 203d 2064 6973    diss_gdf = dis
-0000e330: 735f 6764 662e 6578 706c 6f64 6528 6967  s_gdf.explode(ig
-0000e340: 6e6f 7265 5f69 6e64 6578 3d54 7275 6529  nore_index=True)
-0000e350: 0a0a 2020 2020 2320 436c 6970 2074 6865  ..    # Clip the
-0000e360: 2072 6573 756c 7420 6f6e 2074 6865 2062   result on the b
-0000e370: 6f72 6465 7273 206f 6620 7468 6520 6262  orders of the bb
-0000e380: 6f78 206e 6f74 2074 6f20 6861 7665 206f  ox not to have o
-0000e390: 7665 726c 6170 730a 2020 2020 2320 6265  verlaps.    # be
-0000e3a0: 7477 6565 6e20 7468 6520 6469 6666 6572  tween the differ
-0000e3b0: 656e 7420 7469 6c65 732e 0a20 2020 2023  ent tiles..    #
-0000e3c0: 2049 6620 7468 6973 2069 7320 6e6f 7420   If this is not 
-0000e3d0: 6170 706c 6965 642c 2074 6869 7320 7265  applied, this re
-0000e3e0: 7375 6c74 7320 696e 2073 6f6d 6520 6765  sults in some ge
-0000e3f0: 6f6d 6574 7269 6573 206e 6f74 2062 6569  ometries not bei
-0000e400: 6e67 206d 6572 6765 640a 2020 2020 2320  ng merged.    # 
-0000e410: 6f72 2069 6e20 6475 706c 6963 6174 6573  or in duplicates
-0000e420: 2e0a 2020 2020 2320 5245 4d41 524b 3a20  ..    # REMARK: 
-0000e430: 666f 7220 286d 756c 7469 296c 696e 6573  for (multi)lines
-0000e440: 7472 696e 6773 2c20 7468 6520 656e 6470  trings, the endp
-0000e450: 6f69 6e74 7320 6372 6561 7465 6420 6279  oints created by
-0000e460: 2074 6865 2063 6c69 7020 6172 6520 6e6f   the clip are no
-0000e470: 740a 2020 2020 2320 616c 7761 7973 2074  t.    # always t
-0000e480: 6865 2073 616d 6520 6475 6520 746f 2072  he same due to r
-0000e490: 6f75 6e64 696e 672c 2073 6f20 6469 7373  ounding, so diss
-0000e4a0: 6f6c 7669 6e67 2069 6e20 6120 6e65 7874  olving in a next
-0000e4b0: 2070 6173 7320 646f 6573 6e27 740a 2020   pass doesn't.  
-0000e4c0: 2020 2320 616c 7761 7973 2072 6573 756c    # always resul
-0000e4d0: 7420 696e 206c 696e 6573 7472 696e 6773  t in linestrings
-0000e4e0: 2062 6569 6e67 2072 652d 636f 6e6e 6563   being re-connec
-0000e4f0: 7465 642e 2e2e 2042 6563 6175 7365 2064  ted... Because d
-0000e500: 6973 736f 6c76 696e 670a 2020 2020 2320  issolving.    # 
-0000e510: 6c69 6e65 7320 6973 6e27 7420 736f 2063  lines isn't so c
-0000e520: 6f6d 7075 7461 7469 6f6e 616c 6c79 2068  omputationally h
-0000e530: 6561 7679 2061 6e79 7761 792c 2064 726f  eavy anyway, dro
-0000e540: 7020 7375 7070 6f72 7420 6865 7265 2e0a  p support here..
-0000e550: 2020 2020 6966 2062 626f 7820 6973 206e      if bbox is n
-0000e560: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0000e570: 2073 7461 7274 5f63 6c69 7020 3d20 6461   start_clip = da
-0000e580: 7465 7469 6d65 2e6e 6f77 2829 0a20 2020  tetime.now().   
-0000e590: 2020 2020 2062 626f 785f 706f 6c79 676f       bbox_polygo
-0000e5a0: 6e20 3d20 7368 5f67 656f 6d2e 506f 6c79  n = sh_geom.Poly
-0000e5b0: 676f 6e28 0a20 2020 2020 2020 2020 2020  gon(.           
-0000e5c0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0000e5d0: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
-0000e5e0: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
-0000e5f0: 2020 2020 2020 2028 6262 6f78 5b30 5d2c         (bbox[0],
-0000e600: 2062 626f 785b 335d 292c 0a20 2020 2020   bbox[3]),.     
-0000e610: 2020 2020 2020 2020 2020 2028 6262 6f78             (bbox
-0000e620: 5b32 5d2c 2062 626f 785b 335d 292c 0a20  [2], bbox[3]),. 
-0000e630: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0000e640: 6262 6f78 5b32 5d2c 2062 626f 785b 315d  bbox[2], bbox[1]
-0000e650: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0000e660: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
-0000e670: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
-0000e680: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
-0000e690: 2020 2020 2020 2062 626f 785f 6764 6620         bbox_gdf 
-0000e6a0: 3d20 6770 642e 4765 6f44 6174 6146 7261  = gpd.GeoDataFra
-0000e6b0: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-0000e6c0: 6461 7461 3d5b 315d 2c20 6765 6f6d 6574  data=[1], geomet
-0000e6d0: 7279 3d5b 6262 6f78 5f70 6f6c 7967 6f6e  ry=[bbox_polygon
-0000e6e0: 5d2c 2063 7273 3d69 6e70 7574 5f67 6466  ], crs=input_gdf
-0000e6f0: 2e63 7273 2020 2320 7479 7065 3a20 6967  .crs  # type: ig
-0000e700: 6e6f 7265 0a20 2020 2020 2020 2029 0a0a  nore.        )..
-0000e710: 2020 2020 2020 2020 2320 4361 7463 6820          # Catch 
-0000e720: 6972 7265 6c65 7661 6e74 2070 616e 6461  irrelevant panda
-0000e730: 7320 6675 7475 7265 2077 6172 6e69 6e67  s future warning
-0000e740: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-0000e750: 2077 6865 6e20 7265 6d6f 7665 6420 696e   when removed in
-0000e760: 206c 6174 6572 2076 6572 7369 6f6e 206f   later version o
-0000e770: 6620 7061 6e64 6173 2c20 6361 6e20 6265  f pandas, can be
-0000e780: 2072 656d 6f76 6564 2068 6572 650a 2020   removed here.  
-0000e790: 2020 2020 2020 7769 7468 2077 6172 6e69        with warni
-0000e7a0: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
-0000e7b0: 6773 2829 3a0a 2020 2020 2020 2020 2020  gs():.          
-0000e7c0: 2020 6d65 7373 6167 6520 3d20 280a 2020    message = (.  
-0000e7d0: 2020 2020 2020 2020 2020 2020 2020 2249                "I
-0000e7e0: 6e20 6120 6675 7475 7265 2076 6572 7369  n a future versi
-0000e7f0: 6f6e 2c20 6064 662e 696c 6f63 5b3a 2c20  on, `df.iloc[:, 
-0000e800: 695d 203d 206e 6577 7661 6c73 6020 7769  i] = newvals` wi
-0000e810: 6c6c 2061 7474 656d 7074 2074 6f20 220a  ll attempt to ".
+0000ce20: 2020 7371 6c5f 6469 616c 6563 743d 2253    sql_dialect="S
+0000ce30: 514c 4954 4522 2c0a 2020 2020 2020 2020  QLITE",.        
+0000ce40: 2020 2020 2020 2020 2020 2020 666f 7263              forc
+0000ce50: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+0000ce60: 7974 7970 653d 696e 7075 745f 6c61 7965  ytype=input_laye
+0000ce70: 7269 6e66 6f2e 6765 6f6d 6574 7279 7479  rinfo.geometryty
+0000ce80: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0000ce90: 2020 2020 2020 2020 6578 706c 6f64 6563          explodec
+0000cea0: 6f6c 6c65 6374 696f 6e73 3d65 7870 6c6f  ollections=explo
+0000ceb0: 6465 636f 6c6c 6563 7469 6f6e 732c 0a20  decollections,. 
+0000cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ced0: 2020 206f 7074 696f 6e73 3d7b 224c 4159     options={"LAY
+0000cee0: 4552 5f43 5245 4154 494f 4e2e 5350 4154  ER_CREATION.SPAT
+0000cef0: 4941 4c5f 494e 4445 5822 3a20 6372 6561  IAL_INDEX": crea
+0000cf00: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+0000cf10: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000cf20: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0000cf30: 2020 2020 2020 2320 5765 2073 7469 6c6c        # We still
+0000cf40: 206e 6565 6420 746f 2061 7070 6c79 2074   need to apply t
+0000cf50: 6865 2077 6865 7265 2066 696c 7465 720a  he where filter.
+0000cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf70: 6966 2077 6865 7265 2069 7320 6e6f 7420  if where is not 
+0000cf80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000cf90: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
+0000cfa0: 2066 226f 7574 7075 745f 746d 7033 5f77   f"output_tmp3_w
+0000cfb0: 6865 7265 7b6f 7574 7075 745f 7061 7468  here{output_path
+0000cfc0: 2e73 7566 6669 787d 220a 2020 2020 2020  .suffix}".      
+0000cfd0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+0000cfe0: 7470 7574 5f74 6d70 335f 7768 6572 655f  tput_tmp3_where_
+0000cff0: 7061 7468 203d 2074 656d 7064 6972 202f  path = tempdir /
+0000d000: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
+0000d010: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000d020: 5f74 6d70 325f 696e 666f 203d 2067 666f  _tmp2_info = gfo
+0000d030: 2e67 6574 5f6c 6179 6572 696e 666f 286f  .get_layerinfo(o
+0000d040: 7574 7075 745f 746d 7032 5f66 696e 616c  utput_tmp2_final
+0000d050: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000d060: 2020 2020 2020 2020 2020 2077 6865 7265             where
+0000d070: 203d 2077 6865 7265 2e66 6f72 6d61 7428   = where.format(
+0000d080: 6765 6f6d 6574 7279 636f 6c75 6d6e 3d6f  geometrycolumn=o
+0000d090: 7574 7075 745f 746d 7032 5f69 6e66 6f2e  utput_tmp2_info.
+0000d0a0: 6765 6f6d 6574 7279 636f 6c75 6d6e 290a  geometrycolumn).
+0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0c0: 2020 2020 7371 6c5f 7374 6d74 203d 2066      sql_stmt = f
+0000d0d0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+0000d0e0: 2020 2020 2020 2020 2020 2020 5345 4c45              SELE
+0000d0f0: 4354 202a 2046 524f 4d20 227b 6f75 7470  CT * FROM "{outp
+0000d100: 7574 5f6c 6179 6572 7d22 0a20 2020 2020  ut_layer}".     
+0000d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d120: 2020 2020 5748 4552 4520 7b77 6865 7265      WHERE {where
+0000d130: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0000d140: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000d150: 2020 2020 2020 2020 2020 2020 2020 746d                tm
+0000d160: 705f 696e 666f 203d 2067 666f 2e67 6574  p_info = gfo.get
+0000d170: 5f6c 6179 6572 696e 666f 286f 7574 7075  _layerinfo(outpu
+0000d180: 745f 746d 7032 5f66 696e 616c 5f70 6174  t_tmp2_final_pat
+0000d190: 682c 206f 7574 7075 745f 6c61 7965 7229  h, output_layer)
+0000d1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d1b0: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
+0000d1c0: 7371 6c5f 7374 6d74 2e66 6f72 6d61 7428  sql_stmt.format(
+0000d1d0: 6765 6f6d 6574 7279 636f 6c75 6d6e 3d74  geometrycolumn=t
+0000d1e0: 6d70 5f69 6e66 6f2e 6765 6f6d 6574 7279  mp_info.geometry
+0000d1f0: 636f 6c75 6d6e 290a 2020 2020 2020 2020  column).        
+0000d200: 2020 2020 2020 2020 2020 2020 5f6f 6772              _ogr
+0000d210: 5f75 7469 6c2e 7665 6374 6f72 5f74 7261  _util.vector_tra
+0000d220: 6e73 6c61 7465 280a 2020 2020 2020 2020  nslate(.        
+0000d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d240: 696e 7075 745f 7061 7468 3d6f 7574 7075  input_path=outpu
+0000d250: 745f 746d 7032 5f66 696e 616c 5f70 6174  t_tmp2_final_pat
+0000d260: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+0000d270: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+0000d280: 745f 7061 7468 3d6f 7574 7075 745f 746d  t_path=output_tm
+0000d290: 7033 5f77 6865 7265 5f70 6174 682c 0a20  p3_where_path,. 
+0000d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2b0: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
+0000d2c0: 7965 723d 6f75 7470 7574 5f6c 6179 6572  yer=output_layer
+0000d2d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d2e0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+0000d2f0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+0000d300: 7970 653d 696e 7075 745f 6c61 7965 7269  ype=input_layeri
+0000d310: 6e66 6f2e 6765 6f6d 6574 7279 7479 7065  nfo.geometrytype
+0000d320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d330: 2020 2020 2020 2020 2020 7371 6c5f 7374            sql_st
+0000d340: 6d74 3d73 716c 5f73 746d 742c 0a20 2020  mt=sql_stmt,.   
+0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d360: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
+0000d370: 3d22 5351 4c49 5445 222c 0a20 2020 2020  ="SQLITE",.     
+0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d390: 2020 206f 7074 696f 6e73 3d7b 224c 4159     options={"LAY
+0000d3a0: 4552 5f43 5245 4154 494f 4e2e 5350 4154  ER_CREATION.SPAT
+0000d3b0: 4941 4c5f 494e 4445 5822 3a20 5472 7565  IAL_INDEX": True
+0000d3c0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000d3d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000d3e0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+0000d3f0: 7075 745f 746d 7032 5f66 696e 616c 5f70  put_tmp2_final_p
+0000d400: 6174 6820 3d20 6f75 7470 7574 5f74 6d70  ath = output_tmp
+0000d410: 335f 7768 6572 655f 7061 7468 0a0a 2020  3_where_path..  
+0000d420: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000d430: 4e6f 7720 7765 2061 7265 2072 6561 6479  Now we are ready
+0000d440: 2074 6f20 6d6f 7665 2074 6865 2072 6573   to move the res
+0000d450: 756c 7420 746f 2074 6865 2066 696e 616c  ult to the final
+0000d460: 2073 706f 742e 2e2e 0a20 2020 2020 2020   spot....       
+0000d470: 2020 2020 2020 2020 2067 666f 2e6d 6f76           gfo.mov
+0000d480: 6528 6f75 7470 7574 5f74 6d70 325f 6669  e(output_tmp2_fi
+0000d490: 6e61 6c5f 7061 7468 2c20 6f75 7470 7574  nal_path, output
+0000d4a0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+0000d4b0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+0000d4c0: 2020 2020 2073 6875 7469 6c2e 726d 7472       shutil.rmtr
+0000d4d0: 6565 2874 656d 7064 6972 2c20 6967 6e6f  ee(tempdir, igno
+0000d4e0: 7265 5f65 7272 6f72 733d 5472 7565 290a  re_errors=True).
+0000d4f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000d500: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+0000d510: 6d65 6e74 6564 4572 726f 7228 0a20 2020  mentedError(.   
+0000d520: 2020 2020 2020 2020 2066 2255 6e73 7570           f"Unsup
+0000d530: 706f 7274 6564 2069 6e70 7574 2067 656f  ported input geo
+0000d540: 6d65 7472 7974 7970 653a 207b 696e 7075  metrytype: {inpu
+0000d550: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
+0000d560: 6574 7279 7479 7065 7d22 0a20 2020 2020  etrytype}".     
+0000d570: 2020 2029 0a0a 2020 2020 2320 5265 7475     )..    # Retu
+0000d580: 726e 2072 6573 756c 7420 696e 666f 0a20  rn result info. 
+0000d590: 2020 2072 6573 756c 745f 696e 666f 5b0a     result_info[.
+0000d5a0: 2020 2020 2020 2020 226d 6573 7361 6765          "message
+0000d5b0: 220a 2020 2020 5d20 3d20 6622 4469 7373  ".    ] = f"Diss
+0000d5c0: 6f6c 7665 2063 6f6d 706c 6574 656c 7920  olve completely 
+0000d5d0: 7265 6164 792c 2074 6f6f 6b20 7b64 6174  ready, took {dat
+0000d5e0: 6574 696d 652e 6e6f 7728 292d 7374 6172  etime.now()-star
+0000d5f0: 745f 7469 6d65 7d21 220a 2020 2020 6c6f  t_time}!".    lo
+0000d600: 6767 6572 2e69 6e66 6f28 7265 7375 6c74  gger.info(result
+0000d610: 5f69 6e66 6f5b 226d 6573 7361 6765 225d  _info["message"]
+0000d620: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
+0000d630: 756c 745f 696e 666f 0a0a 0a64 6566 205f  ult_info...def _
+0000d640: 6469 7373 6f6c 7665 5f70 6f6c 7967 6f6e  dissolve_polygon
+0000d650: 735f 7061 7373 280a 2020 2020 696e 7075  s_pass(.    inpu
+0000d660: 745f 7061 7468 3a20 5061 7468 2c0a 2020  t_path: Path,.  
+0000d670: 2020 6f75 7470 7574 5f6e 6f74 6f6e 626f    output_notonbo
+0000d680: 7264 6572 5f70 6174 683a 2050 6174 682c  rder_path: Path,
+0000d690: 0a20 2020 206f 7574 7075 745f 6f6e 626f  .    output_onbo
+0000d6a0: 7264 6572 5f70 6174 683a 2050 6174 682c  rder_path: Path,
+0000d6b0: 0a20 2020 2065 7870 6c6f 6465 636f 6c6c  .    explodecoll
+0000d6c0: 6563 7469 6f6e 733a 2062 6f6f 6c2c 0a20  ections: bool,. 
+0000d6d0: 2020 2067 726f 7570 6279 5f63 6f6c 756d     groupby_colum
+0000d6e0: 6e73 3a20 4f70 7469 6f6e 616c 5b49 7465  ns: Optional[Ite
+0000d6f0: 7261 626c 655b 7374 725d 5d2c 0a20 2020  rable[str]],.   
+0000d700: 2061 6767 5f63 6f6c 756d 6e73 3a20 4f70   agg_columns: Op
+0000d710: 7469 6f6e 616c 5b64 6963 745d 2c0a 2020  tional[dict],.  
+0000d720: 2020 7469 6c65 735f 6764 663a 2067 7064    tiles_gdf: gpd
+0000d730: 2e47 656f 4461 7461 4672 616d 652c 0a20  .GeoDataFrame,. 
+0000d740: 2020 2069 6e70 7574 5f6c 6179 6572 3a20     input_layer: 
+0000d750: 4f70 7469 6f6e 616c 5b73 7472 5d2c 0a20  Optional[str],. 
+0000d760: 2020 206f 7574 7075 745f 6c61 7965 723a     output_layer:
+0000d770: 204f 7074 696f 6e61 6c5b 7374 725d 2c0a   Optional[str],.
+0000d780: 2020 2020 6772 6964 7369 7a65 3a20 666c      gridsize: fl
+0000d790: 6f61 742c 0a20 2020 206b 6565 705f 656d  oat,.    keep_em
+0000d7a0: 7074 795f 6765 6f6d 733a 2062 6f6f 6c2c  pty_geoms: bool,
+0000d7b0: 0a20 2020 206e 625f 7061 7261 6c6c 656c  .    nb_parallel
+0000d7c0: 3a20 696e 742c 0a29 202d 3e20 6469 6374  : int,.) -> dict
+0000d7d0: 3a0a 2020 2020 2320 4d61 6b65 2073 7572  :.    # Make sur
+0000d7e0: 6520 7468 6520 696e 7075 7420 6669 6c65  e the input file
+0000d7f0: 2068 6173 2061 2073 7061 7469 616c 2069   has a spatial i
+0000d800: 6e64 6578 0a20 2020 2067 666f 2e63 7265  ndex.    gfo.cre
+0000d810: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+0000d820: 7828 696e 7075 745f 7061 7468 2c20 6578  x(input_path, ex
+0000d830: 6973 745f 6f6b 3d54 7275 6529 0a0a 2020  ist_ok=True)..  
+0000d840: 2020 2320 5374 6172 7420 6361 6c63 756c    # Start calcul
+0000d850: 6174 696f 6e20 696e 2070 6172 616c 6c65  ation in paralle
+0000d860: 6c0a 2020 2020 7374 6172 745f 7469 6d65  l.    start_time
+0000d870: 203d 2064 6174 6574 696d 652e 6e6f 7728   = datetime.now(
+0000d880: 290a 2020 2020 7265 7375 6c74 5f69 6e66  ).    result_inf
+0000d890: 6f20 3d20 7b7d 0a20 2020 2073 7461 7274  o = {}.    start
+0000d8a0: 5f74 696d 6520 3d20 6461 7465 7469 6d65  _time = datetime
+0000d8b0: 2e6e 6f77 2829 0a20 2020 2069 6e70 7574  .now().    input
+0000d8c0: 5f6c 6179 6572 696e 666f 203d 2067 666f  _layerinfo = gfo
+0000d8d0: 2e67 6574 5f6c 6179 6572 696e 666f 2869  .get_layerinfo(i
+0000d8e0: 6e70 7574 5f70 6174 682c 2069 6e70 7574  nput_path, input
+0000d8f0: 5f6c 6179 6572 290a 0a20 2020 2023 2050  _layer)..    # P
+0000d900: 726f 6365 7373 696e 6720 696e 2074 6872  rocessing in thr
+0000d910: 6561 6473 2069 7320 3278 2066 6173 7465  eads is 2x faste
+0000d920: 7220 666f 7220 736d 616c 6c20 6461 7461  r for small data
+0000d930: 7365 7473 2028 6f6e 2057 696e 646f 7773  sets (on Windows
+0000d940: 290a 2020 2020 6361 6c63 756c 6174 655f  ).    calculate_
+0000d950: 696e 5f74 6872 6561 6473 203d 2054 7275  in_threads = Tru
+0000d960: 6520 6966 2069 6e70 7574 5f6c 6179 6572  e if input_layer
+0000d970: 696e 666f 2e66 6561 7475 7265 636f 756e  info.featurecoun
+0000d980: 7420 3c3d 2031 3030 2065 6c73 6520 4661  t <= 100 else Fa
+0000d990: 6c73 650a 2020 2020 7769 7468 205f 7072  lse.    with _pr
+0000d9a0: 6f63 6573 7369 6e67 5f75 7469 6c2e 506f  ocessing_util.Po
+0000d9b0: 6f6c 6564 4578 6563 7574 6f72 4661 6374  oledExecutorFact
+0000d9c0: 6f72 7928 0a20 2020 2020 2020 2074 6872  ory(.        thr
+0000d9d0: 6561 6470 6f6f 6c3d 6361 6c63 756c 6174  eadpool=calculat
+0000d9e0: 655f 696e 5f74 6872 6561 6473 2c0a 2020  e_in_threads,.  
+0000d9f0: 2020 2020 2020 6d61 785f 776f 726b 6572        max_worker
+0000da00: 733d 6e62 5f70 6172 616c 6c65 6c2c 0a20  s=nb_parallel,. 
+0000da10: 2020 2020 2020 2069 6e69 7469 616c 697a         initializ
+0000da20: 6572 3d5f 7072 6f63 6573 7369 6e67 5f75  er=_processing_u
+0000da30: 7469 6c2e 696e 6974 6961 6c69 7a65 5f77  til.initialize_w
+0000da40: 6f72 6b65 7228 292c 0a20 2020 2029 2061  orker(),.    ) a
+0000da50: 7320 6361 6c63 756c 6174 655f 706f 6f6c  s calculate_pool
+0000da60: 3a0a 2020 2020 2020 2020 2320 5072 6570  :.        # Prep
+0000da70: 6172 6520 6f75 7470 7574 2066 696c 656e  are output filen
+0000da80: 616d 650a 2020 2020 2020 2020 7465 6d70  ame.        temp
+0000da90: 6469 7220 3d20 6f75 7470 7574 5f6f 6e62  dir = output_onb
+0000daa0: 6f72 6465 725f 7061 7468 2e70 6172 656e  order_path.paren
+0000dab0: 740a 0a20 2020 2020 2020 2062 6174 6368  t..        batch
+0000dac0: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
+0000dad0: 6e62 5f62 6174 6368 6573 203d 206c 656e  nb_batches = len
+0000dae0: 2874 696c 6573 5f67 6466 290a 2020 2020  (tiles_gdf).    
+0000daf0: 2020 2020 6e62 5f62 6174 6368 6573 5f64      nb_batches_d
+0000db00: 6f6e 6520 3d20 300a 2020 2020 2020 2020  one = 0.        
+0000db10: 6675 7475 7265 5f74 6f5f 6261 7463 685f  future_to_batch_
+0000db20: 6964 203d 207b 7d0a 2020 2020 2020 2020  id = {}.        
+0000db30: 6e62 5f72 6f77 735f 646f 6e65 203d 2030  nb_rows_done = 0
+0000db40: 0a20 2020 2020 2020 2066 6f72 2062 6174  .        for bat
+0000db50: 6368 5f69 642c 2074 696c 655f 726f 7720  ch_id, tile_row 
+0000db60: 696e 2065 6e75 6d65 7261 7465 2874 696c  in enumerate(til
+0000db70: 6573 5f67 6466 2e69 7465 7274 7570 6c65  es_gdf.itertuple
+0000db80: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0000db90: 2020 6261 7463 6865 735b 6261 7463 685f    batches[batch_
+0000dba0: 6964 5d20 3d20 7b7d 0a20 2020 2020 2020  id] = {}.       
+0000dbb0: 2020 2020 2062 6174 6368 6573 5b62 6174       batches[bat
+0000dbc0: 6368 5f69 645d 5b22 6c61 7965 7222 5d20  ch_id]["layer"] 
+0000dbd0: 3d20 6f75 7470 7574 5f6c 6179 6572 0a20  = output_layer. 
+0000dbe0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+0000dbf0: 6573 5b62 6174 6368 5f69 645d 5b22 626f  es[batch_id]["bo
+0000dc00: 756e 6473 225d 203d 2074 696c 655f 726f  unds"] = tile_ro
+0000dc10: 772e 6765 6f6d 6574 7279 2e62 6f75 6e64  w.geometry.bound
+0000dc20: 730a 0a20 2020 2020 2020 2020 2020 2023  s..            #
+0000dc30: 204f 7574 7075 7420 6561 6368 2062 6174   Output each bat
+0000dc40: 6368 2074 6f20 6120 7365 7065 7261 7465  ch to a seperate
+0000dc50: 2074 656d 706f 7261 7279 2066 696c 652c   temporary file,
+0000dc60: 206f 7468 6572 7769 7365 2074 6865 7265   otherwise there
+0000dc70: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+0000dc80: 7265 2074 696d 656f 7574 2069 7373 7565  re timeout issue
+0000dc90: 7320 7768 656e 2070 726f 6365 7373 696e  s when processin
+0000dca0: 6720 6c61 7267 6520 6669 6c65 730a 2020  g large files.  
+0000dcb0: 2020 2020 2020 2020 2020 7375 6666 6978            suffix
+0000dcc0: 203d 206f 7574 7075 745f 6e6f 746f 6e62   = output_notonb
+0000dcd0: 6f72 6465 725f 7061 7468 2e73 7566 6669  order_path.suffi
+0000dce0: 780a 2020 2020 2020 2020 2020 2020 6e61  x.            na
+0000dcf0: 6d65 203d 2066 227b 6f75 7470 7574 5f6e  me = f"{output_n
+0000dd00: 6f74 6f6e 626f 7264 6572 5f70 6174 682e  otonborder_path.
+0000dd10: 7374 656d 7d5f 7b62 6174 6368 5f69 647d  stem}_{batch_id}
+0000dd20: 7b73 7566 6669 787d 220a 2020 2020 2020  {suffix}".      
+0000dd30: 2020 2020 2020 6f75 7470 7574 5f6e 6f74        output_not
+0000dd40: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
+0000dd50: 7469 616c 5f70 6174 6820 3d20 7465 6d70  tial_path = temp
+0000dd60: 6469 7220 2f20 6e61 6d65 0a20 2020 2020  dir / name.     
+0000dd70: 2020 2020 2020 2062 6174 6368 6573 5b62         batches[b
+0000dd80: 6174 6368 5f69 645d 5b0a 2020 2020 2020  atch_id][.      
+0000dd90: 2020 2020 2020 2020 2020 226f 7574 7075            "outpu
+0000dda0: 745f 6e6f 746f 6e62 6f72 6465 725f 746d  t_notonborder_tm
+0000ddb0: 705f 7061 7274 6961 6c5f 7061 7468 220a  p_partial_path".
+0000ddc0: 2020 2020 2020 2020 2020 2020 5d20 3d20              ] = 
+0000ddd0: 6f75 7470 7574 5f6e 6f74 6f6e 626f 7264  output_notonbord
+0000dde0: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
+0000ddf0: 6174 680a 2020 2020 2020 2020 2020 2020  ath.            
+0000de00: 6e61 6d65 203d 2066 227b 6f75 7470 7574  name = f"{output
+0000de10: 5f6f 6e62 6f72 6465 725f 7061 7468 2e73  _onborder_path.s
+0000de20: 7465 6d7d 5f7b 6261 7463 685f 6964 7d7b  tem}_{batch_id}{
+0000de30: 7375 6666 6978 7d22 0a20 2020 2020 2020  suffix}".       
+0000de40: 2020 2020 206f 7574 7075 745f 6f6e 626f       output_onbo
+0000de50: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
+0000de60: 5f70 6174 6820 3d20 7465 6d70 6469 7220  _path = tempdir 
+0000de70: 2f20 6e61 6d65 0a20 2020 2020 2020 2020  / name.         
+0000de80: 2020 2062 6174 6368 6573 5b62 6174 6368     batches[batch
+0000de90: 5f69 645d 5b0a 2020 2020 2020 2020 2020  _id][.          
+0000dea0: 2020 2020 2020 226f 7574 7075 745f 6f6e        "output_on
+0000deb0: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
+0000dec0: 616c 5f70 6174 6822 0a20 2020 2020 2020  al_path".       
+0000ded0: 2020 2020 205d 203d 206f 7574 7075 745f       ] = output_
+0000dee0: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
+0000def0: 7469 616c 5f70 6174 680a 0a20 2020 2020  tial_path..     
+0000df00: 2020 2020 2020 2023 2047 6574 2074 696c         # Get til
+0000df10: 655f 6964 2069 6620 7072 6573 656e 740a  e_id if present.
+0000df20: 2020 2020 2020 2020 2020 2020 7469 6c65              tile
+0000df30: 5f69 6420 3d20 7469 6c65 5f72 6f77 2e74  _id = tile_row.t
+0000df40: 696c 655f 6964 2069 6620 2274 696c 655f  ile_id if "tile_
+0000df50: 6964 2220 696e 2074 696c 655f 726f 772e  id" in tile_row.
+0000df60: 5f66 6965 6c64 7320 656c 7365 204e 6f6e  _fields else Non
+0000df70: 650a 0a20 2020 2020 2020 2020 2020 2066  e..            f
+0000df80: 7574 7572 6520 3d20 6361 6c63 756c 6174  uture = calculat
+0000df90: 655f 706f 6f6c 2e73 7562 6d69 7428 0a20  e_pool.submit(. 
+0000dfa0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000dfb0: 6469 7373 6f6c 7665 5f70 6f6c 7967 6f6e  dissolve_polygon
+0000dfc0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000dfd0: 2020 2069 6e70 7574 5f70 6174 683d 696e     input_path=in
+0000dfe0: 7075 745f 7061 7468 2c0a 2020 2020 2020  put_path,.      
+0000dff0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000e000: 5f6e 6f74 6f6e 626f 7264 6572 5f70 6174  _notonborder_pat
+0000e010: 683d 6f75 7470 7574 5f6e 6f74 6f6e 626f  h=output_notonbo
+0000e020: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
+0000e030: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+0000e040: 2020 2020 2020 206f 7574 7075 745f 6f6e         output_on
+0000e050: 626f 7264 6572 5f70 6174 683d 6f75 7470  border_path=outp
+0000e060: 7574 5f6f 6e62 6f72 6465 725f 746d 705f  ut_onborder_tmp_
+0000e070: 7061 7274 6961 6c5f 7061 7468 2c0a 2020  partial_path,.  
+0000e080: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000e090: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+0000e0a0: 3d65 7870 6c6f 6465 636f 6c6c 6563 7469  =explodecollecti
+0000e0b0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000e0c0: 2020 2020 2067 726f 7570 6279 5f63 6f6c       groupby_col
+0000e0d0: 756d 6e73 3d67 726f 7570 6279 5f63 6f6c  umns=groupby_col
+0000e0e0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
+0000e0f0: 2020 2020 2020 6167 675f 636f 6c75 6d6e        agg_column
+0000e100: 733d 6167 675f 636f 6c75 6d6e 732c 0a20  s=agg_columns,. 
+0000e110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000e120: 6e70 7574 5f67 656f 6d65 7472 7974 7970  nput_geometrytyp
+0000e130: 653d 696e 7075 745f 6c61 7965 7269 6e66  e=input_layerinf
+0000e140: 6f2e 6765 6f6d 6574 7279 7479 7065 2c0a  o.geometrytype,.
+0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e160: 696e 7075 745f 6c61 7965 723d 696e 7075  input_layer=inpu
+0000e170: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
+0000e180: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+0000e190: 6c61 7965 723d 6f75 7470 7574 5f6c 6179  layer=output_lay
+0000e1a0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0000e1b0: 2020 2020 6262 6f78 3d74 696c 655f 726f      bbox=tile_ro
+0000e1c0: 772e 6765 6f6d 6574 7279 2e62 6f75 6e64  w.geometry.bound
+0000e1d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000e1e0: 2020 2074 696c 655f 6964 3d74 696c 655f     tile_id=tile_
+0000e1f0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000e200: 2020 2020 6772 6964 7369 7a65 3d67 7269      gridsize=gri
+0000e210: 6473 697a 652c 0a20 2020 2020 2020 2020  dsize,.         
+0000e220: 2020 2020 2020 206b 6565 705f 656d 7074         keep_empt
+0000e230: 795f 6765 6f6d 733d 6b65 6570 5f65 6d70  y_geoms=keep_emp
+0000e240: 7479 5f67 656f 6d73 2c0a 2020 2020 2020  ty_geoms,.      
+0000e250: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000e260: 2020 2020 6675 7475 7265 5f74 6f5f 6261      future_to_ba
+0000e270: 7463 685f 6964 5b66 7574 7572 655d 203d  tch_id[future] =
+0000e280: 2062 6174 6368 5f69 640a 0a20 2020 2020   batch_id..     
+0000e290: 2020 2023 204c 6f6f 7020 7469 6c6c 2061     # Loop till a
+0000e2a0: 6c6c 2070 6172 616c 6c65 6c20 7072 6f63  ll parallel proc
+0000e2b0: 6573 7365 7320 6172 6520 7265 6164 792c  esses are ready,
+0000e2c0: 2062 7574 2070 726f 6365 7373 2065 6163   but process eac
+0000e2d0: 6820 6f6e 650a 2020 2020 2020 2020 2320  h one.        # 
+0000e2e0: 7468 6174 2069 7320 7265 6164 7920 616c  that is ready al
+0000e2f0: 7265 6164 790a 2020 2020 2020 2020 5f67  ready.        _g
+0000e300: 656e 6572 616c 5f75 7469 6c2e 7265 706f  eneral_util.repo
+0000e310: 7274 5f70 726f 6772 6573 7328 0a20 2020  rt_progress(.   
+0000e320: 2020 2020 2020 2020 2073 7461 7274 5f74           start_t
+0000e330: 696d 652c 206e 625f 6261 7463 6865 735f  ime, nb_batches_
+0000e340: 646f 6e65 2c20 6e62 5f62 6174 6368 6573  done, nb_batches
+0000e350: 2c20 2264 6973 736f 6c76 6522 0a20 2020  , "dissolve".   
+0000e360: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+0000e370: 6f72 2066 7574 7572 6520 696e 2066 7574  or future in fut
+0000e380: 7572 6573 2e61 735f 636f 6d70 6c65 7465  ures.as_complete
+0000e390: 6428 6675 7475 7265 5f74 6f5f 6261 7463  d(future_to_batc
+0000e3a0: 685f 6964 293a 0a20 2020 2020 2020 2020  h_id):.         
+0000e3b0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000e3c0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+0000e3d0: 2063 616c 6375 6c61 7465 2067 6176 6520   calculate gave 
+0000e3e0: 7265 7375 6c74 730a 2020 2020 2020 2020  results.        
+0000e3f0: 2020 2020 2020 2020 6e62 5f62 6174 6368          nb_batch
+0000e400: 6573 5f64 6f6e 6520 2b3d 2031 0a20 2020  es_done += 1.   
+0000e410: 2020 2020 2020 2020 2020 2020 2062 6174               bat
+0000e420: 6368 5f69 6420 3d20 6675 7475 7265 5f74  ch_id = future_t
+0000e430: 6f5f 6261 7463 685f 6964 5b66 7574 7572  o_batch_id[futur
+0000e440: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
+0000e450: 2020 2072 6573 756c 7420 3d20 6675 7475     result = futu
+0000e460: 7265 2e72 6573 756c 7428 290a 0a20 2020  re.result()..   
+0000e470: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000e480: 7265 7375 6c74 2069 7320 6e6f 7420 4e6f  result is not No
+0000e490: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000e4a0: 2020 2020 2020 2020 6e62 5f72 6f77 735f          nb_rows_
+0000e4b0: 646f 6e65 202b 3d20 7265 7375 6c74 5b22  done += result["
+0000e4c0: 6e62 5f72 6f77 735f 646f 6e65 225d 0a20  nb_rows_done"]. 
+0000e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4e0: 2020 2069 6620 7265 7375 6c74 5b22 6e62     if result["nb
+0000e4f0: 5f72 6f77 735f 646f 6e65 225d 203e 2030  _rows_done"] > 0
+0000e500: 2061 6e64 2072 6573 756c 745b 2274 6f74   and result["tot
+0000e510: 616c 5f74 696d 6522 5d20 3e20 303a 0a20  al_time"] > 0:. 
+0000e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e530: 2020 2020 2020 2072 6f77 735f 7065 725f         rows_per_
+0000e540: 7365 6320 3d20 726f 756e 6428 0a20 2020  sec = round(.   
+0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e560: 2020 2020 2020 2020 2072 6573 756c 745b           result[
+0000e570: 226e 625f 726f 7773 5f64 6f6e 6522 5d20  "nb_rows_done"] 
+0000e580: 2f20 7265 7375 6c74 5b22 746f 7461 6c5f  / result["total_
+0000e590: 7469 6d65 225d 0a20 2020 2020 2020 2020  time"].         
+0000e5a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000e5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e5c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000e5d0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5f0: 2020 2066 2242 6174 6368 207b 6261 7463     f"Batch {batc
+0000e600: 685f 6964 7d20 7072 6f63 6573 7365 6420  h_id} processed 
+0000e610: 7b72 6573 756c 745b 276e 625f 726f 7773  {result['nb_rows
+0000e620: 5f64 6f6e 6527 5d7d 2072 6f77 7320 220a  _done']} rows ".
+0000e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e640: 2020 2020 2020 2020 2020 2020 6622 287b              f"({
+0000e650: 726f 7773 5f70 6572 5f73 6563 7d2f 7365  rows_per_sec}/se
+0000e660: 6329 220a 2020 2020 2020 2020 2020 2020  c)".            
+0000e670: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e690: 2020 2020 2020 6966 2022 7065 7266 7374        if "perfst
+0000e6a0: 7269 6e67 2220 696e 2072 6573 756c 743a  ring" in result:
+0000e6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e6c0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000e6d0: 6765 722e 6465 6275 6728 6622 5065 7266  ger.debug(f"Perf
+0000e6e0: 7374 7269 6e67 3a20 7b72 6573 756c 745b  string: {result[
+0000e6f0: 2770 6572 6673 7472 696e 6727 5d7d 2229  'perfstring']}")
+0000e700: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e710: 2020 2020 2020 2320 5374 6172 7420 636f        # Start co
+0000e720: 7079 206f 6620 7468 6520 7265 7375 6c74  py of the result
+0000e730: 2074 6f20 6120 636f 6d6d 6f6e 2066 696c   to a common fil
+0000e740: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000e750: 2020 2020 2020 6261 7463 685f 6964 203d        batch_id =
+0000e760: 2066 7574 7572 655f 746f 5f62 6174 6368   future_to_batch
+0000e770: 5f69 645b 6675 7475 7265 5d0a 0a20 2020  _id[future]..   
+0000e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e790: 2023 2049 6620 6361 6c63 756c 6174 6520   # If calculate 
+0000e7a0: 6761 7665 206e 6f74 6f6e 626f 7264 6572  gave notonborder
+0000e7b0: 2072 6573 756c 7473 2c20 6170 7065 6e64   results, append
+0000e7c0: 2074 6f20 6f75 7470 7574 0a20 2020 2020   to output.     
+0000e7d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000e7e0: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
+0000e7f0: 725f 746d 705f 7061 7274 6961 6c5f 7061  r_tmp_partial_pa
+0000e800: 7468 203d 2062 6174 6368 6573 5b62 6174  th = batches[bat
+0000e810: 6368 5f69 645d 5b0a 2020 2020 2020 2020  ch_id][.        
 0000e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e830: 2273 6574 2074 6865 2076 616c 7565 7320  "set the values 
-0000e840: 696e 706c 6163 6520 696e 7374 6561 6420  inplace instead 
-0000e850: 6f66 2061 6c77 6179 7320 7365 7474 696e  of always settin
-0000e860: 6720 6120 6e65 7720 6172 7261 792e 220a  g a new array.".
-0000e870: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000e880: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
-0000e890: 6773 2e66 696c 7465 7277 6172 6e69 6e67  gs.filterwarning
-0000e8a0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0000e8b0: 2020 2061 6374 696f 6e3d 2269 676e 6f72     action="ignor
-0000e8c0: 6522 2c20 6361 7465 676f 7279 3d46 7574  e", category=Fut
-0000e8d0: 7572 6557 6172 6e69 6e67 2c20 6d65 7373  ureWarning, mess
-0000e8e0: 6167 653d 7265 2e65 7363 6170 6528 6d65  age=re.escape(me
-0000e8f0: 7373 6167 6529 0a20 2020 2020 2020 2020  ssage).         
-0000e900: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000e910: 2023 206b 6565 705f 6765 6f6d 5f74 7970   # keep_geom_typ
-0000e920: 653d 5472 7565 2067 6176 6520 736f 6d65  e=True gave some
-0000e930: 7469 6d65 7320 6572 726f 722c 2061 6e64  times error, and
-0000e940: 2073 7469 6c6c 2064 6f65 7320 696e 2030   still does in 0
-0000e950: 2e39 2e30 0a20 2020 2020 2020 2020 2020  .9.0.           
-0000e960: 2023 2073 6f20 7573 6520 6f77 6e20 696d   # so use own im
-0000e970: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
-0000e980: 6b65 6570 5f67 656f 6d5f 7479 7065 0a20  keep_geom_type. 
-0000e990: 2020 2020 2020 2020 2020 2064 6973 735f             diss_
-0000e9a0: 6764 6620 3d20 6770 642e 636c 6970 2864  gdf = gpd.clip(d
-0000e9b0: 6973 735f 6764 662c 2062 626f 785f 6764  iss_gdf, bbox_gd
-0000e9c0: 6629 2020 2320 2c20 6b65 6570 5f67 656f  f)  # , keep_geo
-0000e9d0: 6d5f 7479 7065 3d54 7275 6529 0a20 2020  m_type=True).   
-0000e9e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000e9f0: 6973 696e 7374 616e 6365 2864 6973 735f  isinstance(diss_
-0000ea00: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000ea10: 4672 616d 6529 0a0a 2020 2020 2020 2020  Frame)..        
-0000ea20: 2320 4f6e 6c79 206b 6565 7020 6765 6f6d  # Only keep geom
-0000ea30: 6574 7269 6573 206f 6620 7468 6520 7072  etries of the pr
-0000ea40: 696d 6974 6976 6520 7479 7065 2073 7065  imitive type spe
-0000ea50: 6369 6669 6564 2061 6674 6572 2063 6c69  cified after cli
-0000ea60: 702e 2e2e 0a20 2020 2020 2020 2061 7373  p....        ass
-0000ea70: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-0000ea80: 6973 735f 6764 662c 2067 7064 2e47 656f  iss_gdf, gpd.Geo
-0000ea90: 4461 7461 4672 616d 6529 0a20 2020 2020  DataFrame).     
-0000eaa0: 2020 2064 6973 735f 6764 662e 6765 6f6d     diss_gdf.geom
-0000eab0: 6574 7279 203d 2067 656f 7365 7269 6573  etry = geoseries
-0000eac0: 5f75 7469 6c2e 6765 6f6d 6574 7279 5f63  _util.geometry_c
-0000ead0: 6f6c 6c65 6374 696f 6e5f 6578 7472 6163  ollection_extrac
-0000eae0: 7428 0a20 2020 2020 2020 2020 2020 2064  t(.            d
-0000eaf0: 6973 735f 6764 662e 6765 6f6d 6574 7279  iss_gdf.geometry
-0000eb00: 2c20 696e 7075 745f 6765 6f6d 6574 7279  , input_geometry
-0000eb10: 7479 7065 2e74 6f5f 7072 696d 6974 6976  type.to_primitiv
-0000eb20: 6574 7970 650a 2020 2020 2020 2020 290a  etype.        ).
-0000eb30: 0a20 2020 2020 2020 2070 6572 6669 6e66  .        perfinf
-0000eb40: 6f5b 2274 696d 655f 636c 6970 225d 203d  o["time_clip"] =
-0000eb50: 2028 6461 7465 7469 6d65 2e6e 6f77 2829   (datetime.now()
-0000eb60: 202d 2073 7461 7274 5f63 6c69 7029 2e74   - start_clip).t
-0000eb70: 6f74 616c 5f73 6563 6f6e 6473 2829 0a0a  otal_seconds()..
-0000eb80: 2020 2020 2320 4472 6f70 2072 6f77 7320      # Drop rows 
-0000eb90: 7769 7468 204e 6f6e 652f 656d 7074 7920  with None/empty 
-0000eba0: 6765 6f6d 6574 7269 6573 0a20 2020 2064  geometries.    d
-0000ebb0: 6973 735f 6764 6620 3d20 6469 7373 5f67  iss_gdf = diss_g
-0000ebc0: 6466 5b7e 6469 7373 5f67 6466 2e67 656f  df[~diss_gdf.geo
-0000ebd0: 6d65 7472 792e 6973 6e61 2829 5d0a 2020  metry.isna()].  
-0000ebe0: 2020 6469 7373 5f67 6466 203d 2064 6973    diss_gdf = dis
-0000ebf0: 735f 6764 665b 7e64 6973 735f 6764 662e  s_gdf[~diss_gdf.
-0000ec00: 6765 6f6d 6574 7279 2e69 735f 656d 7074  geometry.is_empt
-0000ec10: 795d 0a0a 2020 2020 2320 4966 2074 6865  y]..    # If the
-0000ec20: 7265 2069 7320 6e6f 2072 6573 756c 742c  re is no result,
-0000ec30: 2072 6574 7572 6e0a 2020 2020 6966 206c   return.    if l
-0000ec40: 656e 2864 6973 735f 6764 6629 203d 3d20  en(diss_gdf) == 
-0000ec50: 303a 0a20 2020 2020 2020 206d 6573 7361  0:.        messa
-0000ec60: 6765 203d 2066 2252 6573 756c 7420 6973  ge = f"Result is
-0000ec70: 2065 6d70 7479 2066 6f72 207b 696e 7075   empty for {inpu
-0000ec80: 745f 7061 7468 7d22 0a20 2020 2020 2020  t_path}".       
-0000ec90: 2072 6574 7572 6e5f 696e 666f 5b22 6d65   return_info["me
-0000eca0: 7373 6167 6522 5d20 3d20 6d65 7373 6167  ssage"] = messag
-0000ecb0: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-0000ecc0: 5f69 6e66 6f5b 2270 6572 6669 6e66 6f22  _info["perfinfo"
-0000ecd0: 5d20 3d20 7065 7266 696e 666f 0a20 2020  ] = perfinfo.   
-0000ece0: 2020 2020 2072 6574 7572 6e5f 696e 666f       return_info
-0000ecf0: 5b22 746f 7461 6c5f 7469 6d65 225d 203d  ["total_time"] =
-0000ed00: 2028 6461 7465 7469 6d65 2e6e 6f77 2829   (datetime.now()
-0000ed10: 202d 2073 7461 7274 5f74 696d 6529 2e74   - start_time).t
-0000ed20: 6f74 616c 5f73 6563 6f6e 6473 2829 0a20  otal_seconds(). 
-0000ed30: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0000ed40: 7475 726e 5f69 6e66 6f0a 0a20 2020 2023  turn_info..    #
-0000ed50: 2041 6464 2063 6f6c 756d 6e20 7769 7468   Add column with
-0000ed60: 2074 696c 655f 6964 0a20 2020 2061 7373   tile_id.    ass
-0000ed70: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-0000ed80: 6973 735f 6764 662c 2067 7064 2e47 656f  iss_gdf, gpd.Geo
-0000ed90: 4461 7461 4672 616d 6529 0a20 2020 2069  DataFrame).    i
-0000eda0: 6620 7469 6c65 5f69 6420 6973 206e 6f74  f tile_id is not
-0000edb0: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
-0000edc0: 6973 735f 6764 665b 2274 696c 655f 6964  iss_gdf["tile_id
-0000edd0: 225d 203d 2074 696c 655f 6964 0a0a 2020  "] = tile_id..  
-0000ede0: 2020 6966 2067 7269 6473 697a 6520 213d    if gridsize !=
-0000edf0: 2030 2e30 3a0a 2020 2020 2020 2020 6469   0.0:.        di
-0000ee00: 7373 5f67 6466 2e67 656f 6d65 7472 7920  ss_gdf.geometry 
-0000ee10: 3d20 7368 6170 656c 7932 5f6f 725f 7079  = shapely2_or_py
-0000ee20: 6765 6f73 2e73 6574 5f70 7265 6369 7369  geos.set_precisi
-0000ee30: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0000ee40: 6469 7373 5f67 6466 2e67 656f 6d65 7472  diss_gdf.geometr
-0000ee50: 792e 6172 7261 792e 6461 7461 2c20 6772  y.array.data, gr
-0000ee60: 6964 5f73 697a 653d 6772 6964 7369 7a65  id_size=gridsize
-0000ee70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000ee80: 2320 5361 7665 2074 6865 2072 6573 756c  # Save the resul
-0000ee90: 7420 746f 2064 6573 7469 6e61 7469 6f6e  t to destination
-0000eea0: 2066 696c 6528 7329 0a20 2020 2073 7461   file(s).    sta
-0000eeb0: 7274 5f74 6f5f 6669 6c65 203d 2064 6174  rt_to_file = dat
-0000eec0: 6574 696d 652e 6e6f 7728 290a 0a20 2020  etime.now()..   
-0000eed0: 2023 2049 6620 7468 6520 7469 6c65 7320   # If the tiles 
-0000eee0: 646f 6e27 7420 6e65 6564 2074 6f20 6265  don't need to be
-0000eef0: 206d 6572 6765 6420 6166 7465 7277 6172   merged afterwar
-0000ef00: 6473 2c20 7765 2063 616e 206a 7573 7420  ds, we can just 
-0000ef10: 7361 7665 2074 6865 2072 6573 756c 7420  save the result 
-0000ef20: 6173 0a20 2020 2023 2069 7420 6973 2e0a  as.    # it is..
-0000ef30: 2020 2020 6966 2073 7472 286f 7574 7075      if str(outpu
-0000ef40: 745f 6e6f 746f 6e62 6f72 6465 725f 7061  t_notonborder_pa
-0000ef50: 7468 2920 3d3d 2073 7472 286f 7574 7075  th) == str(outpu
-0000ef60: 745f 6f6e 626f 7264 6572 5f70 6174 6829  t_onborder_path)
-0000ef70: 3a0a 2020 2020 2020 2020 2320 6173 7365  :.        # asse
-0000ef80: 7274 2074 6f20 6576 6164 6520 7079 4c61  rt to evade pyLa
-0000ef90: 6e63 6520 7761 726e 696e 670a 2020 2020  nce warning.    
-0000efa0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000efb0: 7461 6e63 6528 6469 7373 5f67 6466 2c20  tance(diss_gdf, 
-0000efc0: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000efd0: 290a 2020 2020 2020 2020 2320 5573 6520  ).        # Use 
-0000efe0: 666f 7263 655f 6d75 6c74 6974 7970 652c  force_multitype,
-0000eff0: 2074 6f20 6576 6164 6520 7761 726e 696e   to evade warnin
-0000f000: 6773 2077 6865 6e20 736f 6d65 2062 6174  gs when some bat
-0000f010: 6368 6573 2063 6f6e 7461 696e 0a20 2020  ches contain.   
-0000f020: 2020 2020 2023 2073 696e 676c 6574 7970       # singletyp
-0000f030: 6520 616e 6420 736f 6d65 2063 6f6e 7461  e and some conta
-0000f040: 696e 206d 756c 7469 7479 7065 2067 656f  in multitype geo
-0000f050: 6d65 7472 6965 730a 2020 2020 2020 2020  metries.        
-0000f060: 6766 6f2e 746f 5f66 696c 6528 0a20 2020  gfo.to_file(.   
-0000f070: 2020 2020 2020 2020 2064 6973 735f 6764           diss_gd
-0000f080: 662c 0a20 2020 2020 2020 2020 2020 206f  f,.            o
-0000f090: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
-0000f0a0: 725f 7061 7468 2c0a 2020 2020 2020 2020  r_path,.        
-0000f0b0: 2020 2020 6c61 7965 723d 6f75 7470 7574      layer=output
-0000f0c0: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-0000f0d0: 2020 2020 666f 7263 655f 6d75 6c74 6974      force_multit
-0000f0e0: 7970 653d 5472 7565 2c0a 2020 2020 2020  ype=True,.      
-0000f0f0: 2020 2020 2020 696e 6465 783d 4661 6c73        index=Fals
-0000f100: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
-0000f110: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-0000f120: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
-0000f130: 2020 2029 0a20 2020 2065 6c73 653a 0a20     ).    else:. 
-0000f140: 2020 2020 2020 2023 2049 6620 6e6f 742c         # If not,
-0000f150: 2073 6176 6520 7468 6520 706f 6c79 676f   save the polygo
-0000f160: 6e73 206f 6e20 7468 6520 626f 7264 6572  ns on the border
-0000f170: 2073 6570 6572 6174 656c 790a 2020 2020   seperately.    
-0000f180: 2020 2020 6262 6f78 5f6c 696e 6573 5f67      bbox_lines_g
-0000f190: 6466 203d 2067 7064 2e47 656f 4461 7461  df = gpd.GeoData
-0000f1a0: 4672 616d 6528 0a20 2020 2020 2020 2020  Frame(.         
-0000f1b0: 2020 2067 656f 6d65 7472 793d 6765 6f73     geometry=geos
-0000f1c0: 6572 6965 735f 7574 696c 2e70 6f6c 7967  eries_util.polyg
-0000f1d0: 6f6e 735f 746f 5f6c 696e 6573 2820 2023  ons_to_lines(  #
-0000f1e0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-0000f1f0: 2020 2020 2020 2020 2020 2020 2020 6770                gp
-0000f200: 642e 4765 6f53 6572 6965 7328 5b73 685f  d.GeoSeries([sh_
-0000f210: 6765 6f6d 2e62 6f78 2862 626f 785b 305d  geom.box(bbox[0]
-0000f220: 2c20 6262 6f78 5b31 5d2c 2062 626f 785b  , bbox[1], bbox[
-0000f230: 325d 2c20 6262 6f78 5b33 5d29 5d29 0a20  2], bbox[3])]). 
-0000f240: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0000f250: 2020 2020 2020 2020 2020 6372 733d 696e            crs=in
-0000f260: 7075 745f 6764 662e 6372 732c 2020 2320  put_gdf.crs,  # 
-0000f270: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-0000f280: 2020 2020 2029 0a20 2020 2020 2020 206f       ).        o
-0000f290: 6e62 6f72 6465 725f 6764 6620 3d20 6770  nborder_gdf = gp
-0000f2a0: 642e 736a 6f69 6e28 6469 7373 5f67 6466  d.sjoin(diss_gdf
-0000f2b0: 2c20 6262 6f78 5f6c 696e 6573 5f67 6466  , bbox_lines_gdf
-0000f2c0: 2c20 7072 6564 6963 6174 653d 2269 6e74  , predicate="int
-0000f2d0: 6572 7365 6374 7322 290a 2020 2020 2020  ersects").      
-0000f2e0: 2020 6f6e 626f 7264 6572 5f67 6466 2e64    onborder_gdf.d
-0000f2f0: 726f 7028 2269 6e64 6578 5f72 6967 6874  rop("index_right
-0000f300: 222c 2061 7869 733d 312c 2069 6e70 6c61  ", axis=1, inpla
-0000f310: 6365 3d54 7275 6529 0a20 2020 2020 2020  ce=True).       
-0000f320: 2069 6620 6c65 6e28 6f6e 626f 7264 6572   if len(onborder
-0000f330: 5f67 6466 2920 3e20 303a 0a20 2020 2020  _gdf) > 0:.     
-0000f340: 2020 2020 2020 2023 2061 7373 6572 7420         # assert 
-0000f350: 746f 2065 7661 6465 2070 794c 616e 6365  to evade pyLance
-0000f360: 2077 6172 6e69 6e67 0a20 2020 2020 2020   warning.       
-0000f370: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0000f380: 7374 616e 6365 286f 6e62 6f72 6465 725f  stance(onborder_
-0000f390: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000f3a0: 4672 616d 6529 0a20 2020 2020 2020 2020  Frame).         
-0000f3b0: 2020 2023 2055 7365 2066 6f72 6365 5f6d     # Use force_m
-0000f3c0: 756c 7469 7479 7065 2c20 746f 2065 7661  ultitype, to eva
-0000f3d0: 6465 2077 6172 6e69 6e67 7320 7768 656e  de warnings when
-0000f3e0: 2073 6f6d 6520 6261 7463 6865 7320 636f   some batches co
-0000f3f0: 6e74 6169 6e0a 2020 2020 2020 2020 2020  ntain.          
-0000f400: 2020 2320 7369 6e67 6c65 7479 7065 2061    # singletype a
-0000f410: 6e64 2073 6f6d 6520 636f 6e74 6169 6e20  nd some contain 
-0000f420: 6d75 6c74 6974 7970 6520 6765 6f6d 6574  multitype geomet
-0000f430: 7269 6573 0a20 2020 2020 2020 2020 2020  ries.           
-0000f440: 2067 666f 2e74 6f5f 6669 6c65 280a 2020   gfo.to_file(.  
-0000f450: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-0000f460: 626f 7264 6572 5f67 6466 2c0a 2020 2020  border_gdf,.    
-0000f470: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0000f480: 7574 5f6f 6e62 6f72 6465 725f 7061 7468  ut_onborder_path
-0000f490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f4a0: 2020 6c61 7965 723d 6f75 7470 7574 5f6c    layer=output_l
-0000f4b0: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-0000f4c0: 2020 2020 2020 666f 7263 655f 6d75 6c74        force_mult
-0000f4d0: 6974 7970 653d 5472 7565 2c0a 2020 2020  itype=True,.    
-0000f4e0: 2020 2020 2020 2020 2020 2020 6372 6561              crea
-0000f4f0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000f500: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0000f510: 2020 2020 290a 0a20 2020 2020 2020 206e      )..        n
-0000f520: 6f74 6f6e 626f 7264 6572 5f67 6466 203d  otonborder_gdf =
-0000f530: 2064 6973 735f 6764 665b 7e64 6973 735f   diss_gdf[~diss_
-0000f540: 6764 662e 696e 6465 782e 6973 696e 286f  gdf.index.isin(o
-0000f550: 6e62 6f72 6465 725f 6764 662e 696e 6465  nborder_gdf.inde
-0000f560: 7829 5d0a 2020 2020 2020 2020 6966 206c  x)].        if l
-0000f570: 656e 286e 6f74 6f6e 626f 7264 6572 5f67  en(notonborder_g
-0000f580: 6466 2920 3e20 303a 0a20 2020 2020 2020  df) > 0:.       
-0000f590: 2020 2020 2023 2061 7373 6572 7420 746f       # assert to
-0000f5a0: 2065 7661 6465 2070 794c 616e 6365 2077   evade pyLance w
-0000f5b0: 6172 6e69 6e67 0a20 2020 2020 2020 2020  arning.         
-0000f5c0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0000f5d0: 616e 6365 286e 6f74 6f6e 626f 7264 6572  ance(notonborder
-0000f5e0: 5f67 6466 2c20 6770 642e 4765 6f44 6174  _gdf, gpd.GeoDat
-0000f5f0: 6146 7261 6d65 290a 2020 2020 2020 2020  aFrame).        
-0000f600: 2020 2020 2320 5573 6520 666f 7263 655f      # Use force_
-0000f610: 6d75 6c74 6974 7970 652c 2074 6f20 6576  multitype, to ev
-0000f620: 6164 6520 7761 726e 696e 6773 2077 6865  ade warnings whe
-0000f630: 6e20 736f 6d65 2062 6174 6368 6573 2063  n some batches c
-0000f640: 6f6e 7461 696e 0a20 2020 2020 2020 2020  ontain.         
-0000f650: 2020 2023 2073 696e 676c 6574 7970 6520     # singletype 
-0000f660: 616e 6420 736f 6d65 2063 6f6e 7461 696e  and some contain
-0000f670: 206d 756c 7469 7479 7065 2067 656f 6d65   multitype geome
-0000f680: 7472 6965 730a 2020 2020 2020 2020 2020  tries.          
-0000f690: 2020 6766 6f2e 746f 5f66 696c 6528 0a20    gfo.to_file(. 
-0000f6a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000f6b0: 6f74 6f6e 626f 7264 6572 5f67 6466 2c0a  otonborder_gdf,.
-0000f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6d0: 6f75 7470 7574 5f6e 6f74 6f6e 626f 7264  output_notonbord
-0000f6e0: 6572 5f70 6174 682c 0a20 2020 2020 2020  er_path,.       
-0000f6f0: 2020 2020 2020 2020 206c 6179 6572 3d6f           layer=o
-0000f700: 7574 7075 745f 6c61 7965 722c 0a20 2020  utput_layer,.   
-0000f710: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000f720: 6365 5f6d 756c 7469 7479 7065 3d54 7275  ce_multitype=Tru
-0000f730: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000f740: 2020 2069 6e64 6578 3d46 616c 7365 2c0a     index=False,.
+0000e830: 226f 7574 7075 745f 6e6f 746f 6e62 6f72  "output_notonbor
+0000e840: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
+0000e850: 7061 7468 220a 2020 2020 2020 2020 2020  path".          
+0000e860: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0000e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e880: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+0000e890: 2020 2020 2020 2020 2020 2020 206f 7574               out
+0000e8a0: 7075 745f 6e6f 746f 6e62 6f72 6465 725f  put_notonborder_
+0000e8b0: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
+0000e8c0: 2e65 7869 7374 7328 290a 2020 2020 2020  .exists().      
+0000e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8e0: 2020 616e 6420 6f75 7470 7574 5f6e 6f74    and output_not
+0000e8f0: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
+0000e900: 7469 616c 5f70 6174 682e 7374 6174 2829  tial_path.stat()
+0000e910: 2e73 745f 7369 7a65 203e 2030 0a20 2020  .st_size > 0.   
+0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e930: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0000e940: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0000e950: 6f70 732e 5f61 7070 656e 645f 746f 5f6e  ops._append_to_n
+0000e960: 6f6c 6f63 6b28 0a20 2020 2020 2020 2020  olock(.         
+0000e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e980: 2020 2073 7263 3d6f 7574 7075 745f 6e6f     src=output_no
+0000e990: 746f 6e62 6f72 6465 725f 746d 705f 7061  tonborder_tmp_pa
+0000e9a0: 7274 6961 6c5f 7061 7468 2c0a 2020 2020  rtial_path,.    
+0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9c0: 2020 2020 2020 2020 6473 743d 6f75 7470          dst=outp
+0000e9d0: 7574 5f6e 6f74 6f6e 626f 7264 6572 5f70  ut_notonborder_p
+0000e9e0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea00: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+0000ea10: 696e 6465 783d 4661 6c73 652c 0a20 2020  index=False,.   
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea30: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000ea40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000ea50: 666f 2e72 656d 6f76 6528 6f75 7470 7574  fo.remove(output
+0000ea60: 5f6e 6f74 6f6e 626f 7264 6572 5f74 6d70  _notonborder_tmp
+0000ea70: 5f70 6172 7469 616c 5f70 6174 6829 0a0a  _partial_path)..
+0000ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea90: 2020 2020 2320 4966 2063 616c 6375 6c61      # If calcula
+0000eaa0: 7465 2067 6176 6520 6f6e 626f 7264 6572  te gave onborder
+0000eab0: 2072 6573 756c 7473 2c20 6170 7065 6e64   results, append
+0000eac0: 2074 6f20 6f75 7470 7574 0a20 2020 2020   to output.     
+0000ead0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000eae0: 7574 7075 745f 6f6e 626f 7264 6572 5f74  utput_onborder_t
+0000eaf0: 6d70 5f70 6172 7469 616c 5f70 6174 6820  mp_partial_path 
+0000eb00: 3d20 6261 7463 6865 735b 6261 7463 685f  = batches[batch_
+0000eb10: 6964 5d5b 0a20 2020 2020 2020 2020 2020  id][.           
+0000eb20: 2020 2020 2020 2020 2020 2020 2022 6f75               "ou
+0000eb30: 7470 7574 5f6f 6e62 6f72 6465 725f 746d  tput_onborder_tm
+0000eb40: 705f 7061 7274 6961 6c5f 7061 7468 220a  p_partial_path".
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0000eb70: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb90: 2020 2020 2020 206f 7574 7075 745f 6f6e         output_on
+0000eba0: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
+0000ebb0: 616c 5f70 6174 682e 6578 6973 7473 2829  al_path.exists()
+0000ebc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ebd0: 2020 2020 2020 2020 2061 6e64 206f 7574           and out
+0000ebe0: 7075 745f 6f6e 626f 7264 6572 5f74 6d70  put_onborder_tmp
+0000ebf0: 5f70 6172 7469 616c 5f70 6174 682e 7374  _partial_path.st
+0000ec00: 6174 2829 2e73 745f 7369 7a65 203e 2030  at().st_size > 0
+0000ec10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ec20: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+0000ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec40: 6669 6c65 6f70 732e 5f61 7070 656e 645f  fileops._append_
+0000ec50: 746f 5f6e 6f6c 6f63 6b28 0a20 2020 2020  to_nolock(.     
+0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec70: 2020 2020 2020 2073 7263 3d6f 7574 7075         src=outpu
+0000ec80: 745f 6f6e 626f 7264 6572 5f74 6d70 5f70  t_onborder_tmp_p
+0000ec90: 6172 7469 616c 5f70 6174 682c 0a20 2020  artial_path,.   
+0000eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecb0: 2020 2020 2020 2020 2064 7374 3d6f 7574           dst=out
+0000ecc0: 7075 745f 6f6e 626f 7264 6572 5f70 6174  put_onborder_pat
+0000ecd0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+0000ece0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000ecf0: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+0000ed00: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
+0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000ed30: 2020 2020 2020 2020 2020 2020 2067 666f               gfo
+0000ed40: 2e72 656d 6f76 6528 6f75 7470 7574 5f6f  .remove(output_o
+0000ed50: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
+0000ed60: 6961 6c5f 7061 7468 290a 0a20 2020 2020  ial_path)..     
+0000ed70: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0000ed80: 6365 7074 696f 6e20 6173 2065 783a 0a20  ception as ex:. 
+0000ed90: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000eda0: 6174 6368 5f69 6420 3d20 6675 7475 7265  atch_id = future
+0000edb0: 5f74 6f5f 6261 7463 685f 6964 5b66 7574  _to_batch_id[fut
+0000edc0: 7572 655d 0a20 2020 2020 2020 2020 2020  ure].           
+0000edd0: 2020 2020 206d 6573 7361 6765 203d 2066       message = f
+0000ede0: 2245 7272 6f72 2065 7865 6375 7469 6e67  "Error executing
+0000edf0: 207b 6261 7463 6865 735b 6261 7463 685f   {batches[batch_
+0000ee00: 6964 5d7d 3a20 7b65 787d 220a 2020 2020  id]}: {ex}".    
+0000ee10: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000ee20: 6572 2e65 7863 6570 7469 6f6e 286d 6573  er.exception(mes
+0000ee30: 7361 6765 290a 2020 2020 2020 2020 2020  sage).          
+0000ee40: 2020 2020 2020 6361 6c63 756c 6174 655f        calculate_
+0000ee50: 706f 6f6c 2e73 6875 7464 6f77 6e28 290a  pool.shutdown().
+0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee70: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0000ee80: 6d65 7373 6167 6529 2066 726f 6d20 6578  message) from ex
+0000ee90: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000eea0: 4c6f 6720 7468 6520 7072 6f67 7265 7373  Log the progress
+0000eeb0: 2061 6e64 2070 7265 6469 6374 696f 6e20   and prediction 
+0000eec0: 7370 6565 640a 2020 2020 2020 2020 2020  speed.          
+0000eed0: 2020 5f67 656e 6572 616c 5f75 7469 6c2e    _general_util.
+0000eee0: 7265 706f 7274 5f70 726f 6772 6573 7328  report_progress(
+0000eef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef00: 2073 7461 7274 5f74 696d 652c 206e 625f   start_time, nb_
+0000ef10: 6261 7463 6865 735f 646f 6e65 2c20 6e62  batches_done, nb
+0000ef20: 5f62 6174 6368 6573 2c20 2264 6973 736f  _batches, "disso
+0000ef30: 6c76 6522 0a20 2020 2020 2020 2020 2020  lve".           
+0000ef40: 2029 0a0a 2020 2020 6c6f 6767 6572 2e69   )..    logger.i
+0000ef50: 6e66 6f28 6622 4469 7373 6f6c 7665 2070  nfo(f"Dissolve p
+0000ef60: 6173 7320 7265 6164 792c 2074 6f6f 6b20  ass ready, took 
+0000ef70: 7b64 6174 6574 696d 652e 6e6f 7728 292d  {datetime.now()-
+0000ef80: 7374 6172 745f 7469 6d65 7d21 2229 0a0a  start_time}!")..
+0000ef90: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0000efa0: 745f 696e 666f 0a0a 0a64 6566 205f 6469  t_info...def _di
+0000efb0: 7373 6f6c 7665 5f70 6f6c 7967 6f6e 7328  ssolve_polygons(
+0000efc0: 0a20 2020 2069 6e70 7574 5f70 6174 683a  .    input_path:
+0000efd0: 2050 6174 682c 0a20 2020 206f 7574 7075   Path,.    outpu
+0000efe0: 745f 6e6f 746f 6e62 6f72 6465 725f 7061  t_notonborder_pa
+0000eff0: 7468 3a20 5061 7468 2c0a 2020 2020 6f75  th: Path,.    ou
+0000f000: 7470 7574 5f6f 6e62 6f72 6465 725f 7061  tput_onborder_pa
+0000f010: 7468 3a20 5061 7468 2c0a 2020 2020 6578  th: Path,.    ex
+0000f020: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+0000f030: 3a20 626f 6f6c 2c0a 2020 2020 6772 6f75  : bool,.    grou
+0000f040: 7062 795f 636f 6c75 6d6e 733a 204f 7074  pby_columns: Opt
+0000f050: 696f 6e61 6c5b 4974 6572 6162 6c65 5b73  ional[Iterable[s
+0000f060: 7472 5d5d 2c0a 2020 2020 6167 675f 636f  tr]],.    agg_co
+0000f070: 6c75 6d6e 733a 204f 7074 696f 6e61 6c5b  lumns: Optional[
+0000f080: 6469 6374 5d2c 0a20 2020 2069 6e70 7574  dict],.    input
+0000f090: 5f67 656f 6d65 7472 7974 7970 653a 2047  _geometrytype: G
+0000f0a0: 656f 6d65 7472 7954 7970 652c 0a20 2020  eometryType,.   
+0000f0b0: 2069 6e70 7574 5f6c 6179 6572 3a20 4f70   input_layer: Op
+0000f0c0: 7469 6f6e 616c 5b73 7472 5d2c 0a20 2020  tional[str],.   
+0000f0d0: 206f 7574 7075 745f 6c61 7965 723a 204f   output_layer: O
+0000f0e0: 7074 696f 6e61 6c5b 7374 725d 2c0a 2020  ptional[str],.  
+0000f0f0: 2020 6262 6f78 3a20 5475 706c 655b 666c    bbox: Tuple[fl
+0000f100: 6f61 742c 2066 6c6f 6174 2c20 666c 6f61  oat, float, floa
+0000f110: 742c 2066 6c6f 6174 5d2c 0a20 2020 2074  t, float],.    t
+0000f120: 696c 655f 6964 3a20 4f70 7469 6f6e 616c  ile_id: Optional
+0000f130: 5b69 6e74 5d2c 0a20 2020 2067 7269 6473  [int],.    grids
+0000f140: 697a 653a 2066 6c6f 6174 2c0a 2020 2020  ize: float,.    
+0000f150: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
+0000f160: 3a20 626f 6f6c 2c0a 2920 2d3e 2064 6963  : bool,.) -> dic
+0000f170: 743a 0a20 2020 2023 2049 6e69 740a 2020  t:.    # Init.  
+0000f180: 2020 7065 7266 696e 666f 203d 207b 7d0a    perfinfo = {}.
+0000f190: 2020 2020 7374 6172 745f 7469 6d65 203d      start_time =
+0000f1a0: 2064 6174 6574 696d 652e 6e6f 7728 290a   datetime.now().
+0000f1b0: 2020 2020 7265 7475 726e 5f69 6e66 6f20      return_info 
+0000f1c0: 3d20 7b0a 2020 2020 2020 2020 2269 6e70  = {.        "inp
+0000f1d0: 7574 5f70 6174 6822 3a20 696e 7075 745f  ut_path": input_
+0000f1e0: 7061 7468 2c0a 2020 2020 2020 2020 226f  path,.        "o
+0000f1f0: 7574 7075 745f 6e6f 746f 6e62 6f72 6465  utput_notonborde
+0000f200: 725f 7061 7468 223a 206f 7574 7075 745f  r_path": output_
+0000f210: 6e6f 746f 6e62 6f72 6465 725f 7061 7468  notonborder_path
+0000f220: 2c0a 2020 2020 2020 2020 226f 7574 7075  ,.        "outpu
+0000f230: 745f 6f6e 626f 7264 6572 5f70 6174 6822  t_onborder_path"
+0000f240: 3a20 6f75 7470 7574 5f6f 6e62 6f72 6465  : output_onborde
+0000f250: 725f 7061 7468 2c0a 2020 2020 2020 2020  r_path,.        
+0000f260: 2262 626f 7822 3a20 6262 6f78 2c0a 2020  "bbox": bbox,.  
+0000f270: 2020 2020 2020 2274 696c 655f 6964 223a        "tile_id":
+0000f280: 2074 696c 655f 6964 2c0a 2020 2020 2020   tile_id,.      
+0000f290: 2020 2267 7269 6473 697a 6522 3a20 6772    "gridsize": gr
+0000f2a0: 6964 7369 7a65 2c0a 2020 2020 2020 2020  idsize,.        
+0000f2b0: 226e 625f 726f 7773 5f64 6f6e 6522 3a20  "nb_rows_done": 
+0000f2c0: 302c 0a20 2020 2020 2020 2022 746f 7461  0,.        "tota
+0000f2d0: 6c5f 7469 6d65 223a 2030 2c0a 2020 2020  l_time": 0,.    
+0000f2e0: 2020 2020 2270 6572 6669 6e66 6f22 3a20      "perfinfo": 
+0000f2f0: 2222 2c0a 2020 2020 7d0a 0a20 2020 2023  "",.    }..    #
+0000f300: 2052 6561 6420 616c 6c20 7265 636f 7264   Read all record
+0000f310: 7320 7468 6174 2061 7265 2069 6e20 7468  s that are in th
+0000f320: 6520 6262 6f78 0a20 2020 2072 6574 7279  e bbox.    retry
+0000f330: 5f63 6f75 6e74 203d 2030 0a20 2020 2073  _count = 0.    s
+0000f340: 7461 7274 5f72 6561 6420 3d20 6461 7465  tart_read = date
+0000f350: 7469 6d65 2e6e 6f77 2829 0a20 2020 2061  time.now().    a
+0000f360: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
+0000f370: 6420 3d20 4e6f 6e65 0a20 2020 2077 6869  d = None.    whi
+0000f380: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+0000f390: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000f3a0: 2020 636f 6c75 6d6e 735f 746f 5f72 6561    columns_to_rea
+0000f3b0: 6420 3d20 7365 7428 290a 2020 2020 2020  d = set().      
+0000f3c0: 2020 2020 2020 696e 666f 203d 2067 666f        info = gfo
+0000f3d0: 2e67 6574 5f6c 6179 6572 696e 666f 2869  .get_layerinfo(i
+0000f3e0: 6e70 7574 5f70 6174 682c 2069 6e70 7574  nput_path, input
+0000f3f0: 5f6c 6179 6572 290a 2020 2020 2020 2020  _layer).        
+0000f400: 2020 2020 6966 2067 726f 7570 6279 5f63      if groupby_c
+0000f410: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
+0000f420: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000f430: 2020 2020 636f 6c75 6d6e 735f 746f 5f72      columns_to_r
+0000f440: 6561 642e 7570 6461 7465 2867 726f 7570  ead.update(group
+0000f450: 6279 5f63 6f6c 756d 6e73 290a 2020 2020  by_columns).    
+0000f460: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
+0000f470: 6e64 6578 203d 2046 616c 7365 0a20 2020  ndex = False.   
+0000f480: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
+0000f490: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
+0000f4a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000f4b0: 2020 2020 2066 6964 5f61 735f 696e 6465       fid_as_inde
+0000f4c0: 7820 3d20 5472 7565 0a20 2020 2020 2020  x = True.       
+0000f4d0: 2020 2020 2020 2020 2069 6620 225f 5f44           if "__D
+0000f4e0: 4953 534f 4c56 455f 544f 4a53 4f4e 2220  ISSOLVE_TOJSON" 
+0000f4f0: 696e 2069 6e66 6f2e 636f 6c75 6d6e 733a  in info.columns:
+0000f500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f510: 2020 2020 2023 2049 6620 7765 2061 7265       # If we are
+0000f520: 206e 6f74 2069 6e20 7468 6520 6669 7273   not in the firs
+0000f530: 7420 7061 7373 2c20 7468 6520 636f 6c75  t pass, the colu
+0000f540: 6d6e 7320 746f 2062 6520 7265 6164 0a20  mns to be read. 
+0000f550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f560: 2020 2023 2061 7265 2061 6c72 6561 6479     # are already
+0000f570: 2069 6e20 7468 6520 6a73 6f6e 2063 6f6c   in the json col
+0000f580: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
+0000f590: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+0000f5a0: 746f 5f72 6561 642e 6164 6428 225f 5f44  to_read.add("__D
+0000f5b0: 4953 534f 4c56 455f 544f 4a53 4f4e 2229  ISSOLVE_TOJSON")
+0000f5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f5d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000f5e0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+0000f5f0: 2066 6972 7374 2070 6173 732c 2073 6f20   first pass, so 
+0000f600: 7265 6164 2061 6c6c 2072 656c 6576 616e  read all relevan
+0000f610: 7420 636f 6c75 6d6e 7320 746f 2063 6f64  t columns to cod
+0000f620: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000f630: 2020 2020 2020 2320 7468 656d 2069 6e20        # them in 
+0000f640: 6a73 6f6e 0a20 2020 2020 2020 2020 2020  json.           
+0000f650: 2020 2020 2020 2020 2069 6620 226a 736f           if "jso
+0000f660: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
+0000f670: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000f680: 2020 2020 2020 2020 2020 2061 6767 5f63             agg_c
+0000f690: 6f6c 756d 6e73 5f6e 6565 6465 6420 3d20  olumns_needed = 
+0000f6a0: 6167 675f 636f 6c75 6d6e 735b 226a 736f  agg_columns["jso
+0000f6b0: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
+0000f6c0: 2020 2020 2020 2020 656c 6966 2022 636f          elif "co
+0000f6d0: 6c75 6d6e 7322 2069 6e20 6167 675f 636f  lumns" in agg_co
+0000f6e0: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000f700: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
+0000f710: 6420 3d20 5b0a 2020 2020 2020 2020 2020  d = [.          
+0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f730: 2020 6167 675f 636f 6c75 6d6e 5b22 636f    agg_column["co
+0000f740: 6c75 6d6e 225d 0a20 2020 2020 2020 2020  lumn"].         
 0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f760: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-0000f770: 6e64 6578 3d46 616c 7365 2c0a 2020 2020  ndex=False,.    
-0000f780: 2020 2020 2020 2020 290a 2020 2020 7065          ).    pe
-0000f790: 7266 696e 666f 5b22 7469 6d65 5f74 6f5f  rfinfo["time_to_
-0000f7a0: 6669 6c65 225d 203d 2028 6461 7465 7469  file"] = (dateti
-0000f7b0: 6d65 2e6e 6f77 2829 202d 2073 7461 7274  me.now() - start
-0000f7c0: 5f74 6f5f 6669 6c65 292e 746f 7461 6c5f  _to_file).total_
-0000f7d0: 7365 636f 6e64 7328 290a 0a20 2020 2023  seconds()..    #
-0000f7e0: 2046 696e 616c 6973 652e 2e2e 0a20 2020   Finalise....   
-0000f7f0: 206d 6573 7361 6765 203d 2066 2264 6973   message = f"dis
-0000f800: 736f 6c76 6520 7265 6164 7920 696e 207b  solve ready in {
-0000f810: 6461 7465 7469 6d65 2e6e 6f77 2829 2d73  datetime.now()-s
-0000f820: 7461 7274 5f74 696d 657d 206f 6e20 7b69  tart_time} on {i
-0000f830: 6e70 7574 5f70 6174 687d 2122 0a20 2020  nput_path}!".   
-0000f840: 206c 6f67 6765 722e 6465 6275 6728 6d65   logger.debug(me
-0000f850: 7373 6167 6529 0a0a 2020 2020 2320 436f  ssage)..    # Co
-0000f860: 6c6c 6563 7420 7065 7266 696e 666f 0a20  llect perfinfo. 
-0000f870: 2020 2074 6f74 616c 5f70 6572 665f 7469     total_perf_ti
-0000f880: 6d65 203d 2030 0a20 2020 2070 6572 6673  me = 0.    perfs
-0000f890: 7472 696e 6720 3d20 2222 0a20 2020 2066  tring = "".    f
-0000f8a0: 6f72 2070 6572 6663 6f64 6520 696e 2070  or perfcode in p
-0000f8b0: 6572 6669 6e66 6f3a 0a20 2020 2020 2020  erfinfo:.       
-0000f8c0: 2074 6f74 616c 5f70 6572 665f 7469 6d65   total_perf_time
-0000f8d0: 202b 3d20 7065 7266 696e 666f 5b70 6572   += perfinfo[per
-0000f8e0: 6663 6f64 655d 0a20 2020 2020 2020 2070  fcode].        p
-0000f8f0: 6572 6673 7472 696e 6720 2b3d 2066 227b  erfstring += f"{
-0000f900: 7065 7266 636f 6465 7d3a 207b 7065 7266  perfcode}: {perf
-0000f910: 696e 666f 5b70 6572 6663 6f64 655d 3a2e  info[perfcode]:.
-0000f920: 3266 7d2c 2022 0a20 2020 2072 6574 7572  2f}, ".    retur
-0000f930: 6e5f 696e 666f 5b22 746f 7461 6c5f 7469  n_info["total_ti
-0000f940: 6d65 225d 203d 2028 6461 7465 7469 6d65  me"] = (datetime
-0000f950: 2e6e 6f77 2829 202d 2073 7461 7274 5f74  .now() - start_t
-0000f960: 696d 6529 2e74 6f74 616c 5f73 6563 6f6e  ime).total_secon
-0000f970: 6473 2829 0a20 2020 2070 6572 6669 6e66  ds().    perfinf
-0000f980: 6f5b 2275 6e61 6363 6f75 6e74 6564 225d  o["unaccounted"]
-0000f990: 203d 2072 6574 7572 6e5f 696e 666f 5b22   = return_info["
-0000f9a0: 746f 7461 6c5f 7469 6d65 225d 202d 2074  total_time"] - t
-0000f9b0: 6f74 616c 5f70 6572 665f 7469 6d65 0a20  otal_perf_time. 
-0000f9c0: 2020 2070 6572 6673 7472 696e 6720 2b3d     perfstring +=
-0000f9d0: 2066 2275 6e61 6363 6f75 6e74 6564 3a20   f"unaccounted: 
-0000f9e0: 7b70 6572 6669 6e66 6f5b 2775 6e61 6363  {perfinfo['unacc
-0000f9f0: 6f75 6e74 6564 275d 3a2e 3266 7d22 0a0a  ounted']:.2f}"..
-0000fa00: 2020 2020 2320 5265 7475 726e 0a20 2020      # Return.   
-0000fa10: 2072 6574 7572 6e5f 696e 666f 5b22 7065   return_info["pe
-0000fa20: 7266 696e 666f 225d 203d 2070 6572 6669  rfinfo"] = perfi
-0000fa30: 6e66 6f0a 2020 2020 7265 7475 726e 5f69  nfo.    return_i
-0000fa40: 6e66 6f5b 2270 6572 6673 7472 696e 6722  nfo["perfstring"
-0000fa50: 5d20 3d20 7065 7266 7374 7269 6e67 0a20  ] = perfstring. 
-0000fa60: 2020 2072 6574 7572 6e5f 696e 666f 5b22     return_info["
-0000fa70: 6d65 7373 6167 6522 5d20 3d20 6d65 7373  message"] = mess
-0000fa80: 6167 650a 2020 2020 7265 7475 726e 2072  age.    return r
-0000fa90: 6574 7572 6e5f 696e 666f 0a0a 0a64 6566  eturn_info...def
-0000faa0: 205f 6469 7373 6f6c 7665 280a 2020 2020   _dissolve(.    
-0000fab0: 6466 3a20 6770 642e 4765 6f44 6174 6146  df: gpd.GeoDataF
-0000fac0: 7261 6d65 2c0a 2020 2020 6279 3d4e 6f6e  rame,.    by=Non
-0000fad0: 652c 0a20 2020 2061 6767 6675 6e63 3a20  e,.    aggfunc: 
-0000fae0: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b73  Optional[Union[s
-0000faf0: 7472 2c20 6469 6374 5d5d 203d 2022 6669  tr, dict]] = "fi
-0000fb00: 7273 7422 2c0a 2020 2020 6173 5f69 6e64  rst",.    as_ind
-0000fb10: 6578 3d54 7275 652c 0a20 2020 206c 6576  ex=True,.    lev
-0000fb20: 656c 3d4e 6f6e 652c 0a20 2020 2073 6f72  el=None,.    sor
-0000fb30: 743d 5472 7565 2c0a 2020 2020 6f62 7365  t=True,.    obse
-0000fb40: 7276 6564 3d46 616c 7365 2c0a 2020 2020  rved=False,.    
-0000fb50: 6472 6f70 6e61 3d54 7275 652c 0a29 202d  dropna=True,.) -
-0000fb60: 3e20 6770 642e 4765 6f44 6174 6146 7261  > gpd.GeoDataFra
-0000fb70: 6d65 3a0a 2020 2020 2222 220a 2020 2020  me:.    """.    
-0000fb80: 4469 7373 6f6c 7665 2067 656f 6d65 7472  Dissolve geometr
-0000fb90: 6965 7320 7769 7468 696e 2060 6772 6f75  ies within `grou
-0000fba0: 7062 7960 2069 6e74 6f20 7369 6e67 6c65  pby` into single
-0000fbb0: 206f 6273 6572 7661 7469 6f6e 2e0a 2020   observation..  
-0000fbc0: 2020 5468 6973 2069 7320 6163 636f 6d70    This is accomp
-0000fbd0: 6c69 7368 6564 2062 7920 6170 706c 7969  lished by applyi
-0000fbe0: 6e67 2074 6865 2060 756e 6172 795f 756e  ng the `unary_un
-0000fbf0: 696f 6e60 206d 6574 686f 640a 2020 2020  ion` method.    
-0000fc00: 746f 2061 6c6c 2067 656f 6d65 7472 6965  to all geometrie
-0000fc10: 7320 7769 7468 696e 2061 2067 726f 7570  s within a group
-0000fc20: 7365 6c66 2e0a 2020 2020 4f62 7365 7276  self..    Observ
-0000fc30: 6174 696f 6e73 2061 7373 6f63 6961 7465  ations associate
-0000fc40: 6420 7769 7468 2065 6163 6820 6067 726f  d with each `gro
-0000fc50: 7570 6279 6020 6772 6f75 7020 7769 6c6c  upby` group will
-0000fc60: 2062 6520 6167 6772 6567 6174 6564 0a20   be aggregated. 
-0000fc70: 2020 2075 7369 6e67 2074 6865 2060 6167     using the `ag
-0000fc80: 6766 756e 6360 2e0a 2020 2020 5061 7261  gfunc`..    Para
-0000fc90: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-0000fca0: 2d2d 2d2d 2d0a 2020 2020 6279 203a 2073  -----.    by : s
-0000fcb0: 7472 696e 672c 2064 6566 6175 6c74 204e  tring, default N
-0000fcc0: 6f6e 650a 2020 2020 2020 2020 436f 6c75  one.        Colu
-0000fcd0: 6d6e 2077 686f 7365 2076 616c 7565 7320  mn whose values 
-0000fce0: 6465 6669 6e65 2067 726f 7570 7320 746f  define groups to
-0000fcf0: 2062 6520 6469 7373 6f6c 7665 642e 2049   be dissolved. I
-0000fd00: 6620 4e6f 6e65 2c0a 2020 2020 2020 2020  f None,.        
-0000fd10: 7768 6f6c 6520 4765 6f44 6174 6146 7261  whole GeoDataFra
-0000fd20: 6d65 2069 7320 636f 6e73 6964 6572 6564  me is considered
-0000fd30: 2061 2073 696e 676c 6520 6772 6f75 702e   a single group.
-0000fd40: 0a20 2020 2061 6767 6675 6e63 203a 2066  .    aggfunc : f
-0000fd50: 756e 6374 696f 6e2c 2073 7472 696e 6720  unction, string 
-0000fd60: 6f72 2064 6963 742c 2064 6566 6175 6c74  or dict, default
-0000fd70: 2022 6669 7273 7422 0a20 2020 2020 2020   "first".       
-0000fd80: 2041 6767 7265 6761 7469 6f6e 2066 756e   Aggregation fun
-0000fd90: 6374 696f 6e20 666f 7220 6d61 6e69 7075  ction for manipu
-0000fda0: 6c61 7469 6f6e 206f 6620 6461 7461 2061  lation of data a
-0000fdb0: 7373 6f63 6961 7465 640a 2020 2020 2020  ssociated.      
-0000fdc0: 2020 7769 7468 2065 6163 6820 6772 6f75    with each grou
-0000fdd0: 702e 2050 6173 7365 6420 746f 2070 616e  p. Passed to pan
-0000fde0: 6461 7320 6067 726f 7570 6279 2e61 6767  das `groupby.agg
-0000fdf0: 6020 6d65 7468 6f64 2e0a 2020 2020 6173  ` method..    as
-0000fe00: 5f69 6e64 6578 203a 2062 6f6f 6c65 616e  _index : boolean
-0000fe10: 2c20 6465 6661 756c 7420 5472 7565 0a20  , default True. 
-0000fe20: 2020 2020 2020 2049 6620 7472 7565 2c20         If true, 
-0000fe30: 6772 6f75 7062 7920 636f 6c75 6d6e 7320  groupby columns 
-0000fe40: 6265 636f 6d65 2069 6e64 6578 206f 6620  become index of 
-0000fe50: 7265 7375 6c74 2e0a 2020 2020 6c65 7665  result..    leve
-0000fe60: 6c20 3a20 696e 7420 6f72 2073 7472 206f  l : int or str o
-0000fe70: 7220 7365 7175 656e 6365 206f 6620 696e  r sequence of in
-0000fe80: 7420 6f72 2073 6571 7565 6e63 6520 6f66  t or sequence of
-0000fe90: 2073 7472 2c20 6465 6661 756c 7420 4e6f   str, default No
-0000fea0: 6e65 0a20 2020 2020 2020 2049 6620 7468  ne.        If th
-0000feb0: 6520 6178 6973 2069 7320 6120 4d75 6c74  e axis is a Mult
-0000fec0: 6949 6e64 6578 2028 6869 6572 6172 6368  iIndex (hierarch
-0000fed0: 6963 616c 292c 2067 726f 7570 2062 7920  ical), group by 
-0000fee0: 610a 2020 2020 2020 2020 7061 7274 6963  a.        partic
-0000fef0: 756c 6172 206c 6576 656c 206f 7220 6c65  ular level or le
-0000ff00: 7665 6c73 2e0a 2020 2020 2020 2020 2e2e  vels..        ..
-0000ff10: 2076 6572 7369 6f6e 6164 6465 643a 3a20   versionadded:: 
-0000ff20: 302e 392e 300a 2020 2020 736f 7274 203a  0.9.0.    sort :
-0000ff30: 2062 6f6f 6c2c 2064 6566 6175 6c74 2054   bool, default T
-0000ff40: 7275 650a 2020 2020 2020 2020 536f 7274  rue.        Sort
-0000ff50: 2067 726f 7570 206b 6579 732e 2047 6574   group keys. Get
-0000ff60: 2062 6574 7465 7220 7065 7266 6f72 6d61   better performa
-0000ff70: 6e63 6520 6279 2074 7572 6e69 6e67 2074  nce by turning t
-0000ff80: 6869 7320 6f66 662e 0a20 2020 2020 2020  his off..       
-0000ff90: 204e 6f74 6520 7468 6973 2064 6f65 7320   Note this does 
-0000ffa0: 6e6f 7420 696e 666c 7565 6e63 6520 7468  not influence th
-0000ffb0: 6520 6f72 6465 7220 6f66 206f 6273 6572  e order of obser
-0000ffc0: 7661 7469 6f6e 7320 7769 7468 696e 0a20  vations within. 
-0000ffd0: 2020 2020 2020 2065 6163 6820 6772 6f75         each grou
-0000ffe0: 702e 2047 726f 7570 6279 2070 7265 7365  p. Groupby prese
-0000fff0: 7276 6573 2074 6865 206f 7264 6572 206f  rves the order o
-00010000: 6620 726f 7773 2077 6974 6869 6e20 6561  f rows within ea
-00010010: 6368 2067 726f 7570 2e0a 2020 2020 2020  ch group..      
-00010020: 2020 2e2e 2076 6572 7369 6f6e 6164 6465    .. versionadde
-00010030: 643a 3a20 302e 392e 300a 2020 2020 6f62  d:: 0.9.0.    ob
-00010040: 7365 7276 6564 203a 2062 6f6f 6c2c 2064  served : bool, d
-00010050: 6566 6175 6c74 2046 616c 7365 0a20 2020  efault False.   
-00010060: 2020 2020 2054 6869 7320 6f6e 6c79 2061       This only a
-00010070: 7070 6c69 6573 2069 6620 616e 7920 6f66  pplies if any of
-00010080: 2074 6865 2067 726f 7570 6572 7320 6172   the groupers ar
-00010090: 6520 4361 7465 676f 7269 6361 6c73 2e0a  e Categoricals..
-000100a0: 2020 2020 2020 2020 4966 2054 7275 653a          If True:
-000100b0: 206f 6e6c 7920 7368 6f77 206f 6273 6572   only show obser
-000100c0: 7665 6420 7661 6c75 6573 2066 6f72 2063  ved values for c
-000100d0: 6174 6567 6f72 6963 616c 2067 726f 7570  ategorical group
-000100e0: 6572 732e 0a20 2020 2020 2020 2049 6620  ers..        If 
-000100f0: 4661 6c73 653a 2073 686f 7720 616c 6c20  False: show all 
-00010100: 7661 6c75 6573 2066 6f72 2063 6174 6567  values for categ
-00010110: 6f72 6963 616c 2067 726f 7570 6572 732e  orical groupers.
-00010120: 0a20 2020 2020 2020 202e 2e20 7665 7273  .        .. vers
-00010130: 696f 6e61 6464 6564 3a3a 2030 2e39 2e30  ionadded:: 0.9.0
-00010140: 0a20 2020 2064 726f 706e 6120 3a20 626f  .    dropna : bo
-00010150: 6f6c 2c20 6465 6661 756c 7420 5472 7565  ol, default True
-00010160: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
-00010170: 2c20 616e 6420 6966 2067 726f 7570 206b  , and if group k
-00010180: 6579 7320 636f 6e74 6169 6e20 4e41 2076  eys contain NA v
-00010190: 616c 7565 732c 204e 4120 7661 6c75 6573  alues, NA values
-000101a0: 0a20 2020 2020 2020 2074 6f67 6574 6865  .        togethe
-000101b0: 7220 7769 7468 2072 6f77 2f63 6f6c 756d  r with row/colum
-000101c0: 6e20 7769 6c6c 2062 6520 6472 6f70 7065  n will be droppe
-000101d0: 642e 2049 6620 4661 6c73 652c 204e 410a  d. If False, NA.
-000101e0: 2020 2020 2020 2020 7661 6c75 6573 2077          values w
-000101f0: 696c 6c20 616c 736f 2062 6520 7472 6561  ill also be trea
-00010200: 7465 6420 6173 2074 6865 206b 6579 2069  ted as the key i
-00010210: 6e20 6772 6f75 7073 2e0a 2020 2020 2020  n groups..      
-00010220: 2020 5468 6973 2070 6172 616d 6574 6572    This parameter
-00010230: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-00010240: 6420 666f 7220 7061 6e64 6173 203c 2031  d for pandas < 1
-00010250: 2e31 2e30 2e0a 2020 2020 2020 2020 4120  .1.0..        A 
-00010260: 7761 726e 696e 6720 7769 6c6c 2062 6520  warning will be 
-00010270: 656d 6974 7465 6420 666f 7220 6561 726c  emitted for earl
-00010280: 6965 7220 7061 6e64 6173 2076 6572 7369  ier pandas versi
-00010290: 6f6e 730a 2020 2020 2020 2020 6966 2061  ons.        if a
-000102a0: 206e 6f6e 2d64 6566 6175 6c74 2076 616c   non-default val
-000102b0: 7565 2069 7320 6769 7665 6e20 666f 7220  ue is given for 
-000102c0: 7468 6973 2070 6172 616d 6574 6572 2e0a  this parameter..
-000102d0: 2020 2020 2020 2020 2e2e 2076 6572 7369          .. versi
-000102e0: 6f6e 6164 6465 643a 3a20 302e 392e 300a  onadded:: 0.9.0.
-000102f0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00010300: 2d2d 2d2d 2d2d 2d0a 2020 2020 4765 6f44  -------.    GeoD
-00010310: 6174 6146 7261 6d65 0a20 2020 2045 7861  ataFrame.    Exa
-00010320: 6d70 6c65 730a 2020 2020 2d2d 2d2d 2d2d  mples.    ------
-00010330: 2d2d 0a20 2020 203e 3e3e 2066 726f 6d20  --.    >>> from 
-00010340: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
-00010350: 2069 6d70 6f72 7420 506f 696e 740a 2020   import Point.  
-00010360: 2020 3e3e 3e20 6420 3d20 7b0a 2020 2020    >>> d = {.    
-00010370: 2e2e 2e20 2020 2020 2263 6f6c 3122 3a20  ...     "col1": 
-00010380: 5b22 6e61 6d65 3122 2c20 226e 616d 6532  ["name1", "name2
-00010390: 222c 2022 6e61 6d65 3122 5d2c 0a20 2020  ", "name1"],.   
-000103a0: 202e 2e2e 2020 2020 2022 6765 6f6d 6574   ...     "geomet
-000103b0: 7279 223a 205b 506f 696e 7428 312c 2032  ry": [Point(1, 2
-000103c0: 292c 2050 6f69 6e74 2832 2c20 3129 2c20  ), Point(2, 1), 
-000103d0: 506f 696e 7428 302c 2031 295d 2c0a 2020  Point(0, 1)],.  
-000103e0: 2020 2e2e 2e20 7d0a 2020 2020 3e3e 3e20    ... }.    >>> 
-000103f0: 6764 6620 3d20 6765 6f70 616e 6461 732e  gdf = geopandas.
-00010400: 4765 6f44 6174 6146 7261 6d65 2864 2c20  GeoDataFrame(d, 
-00010410: 6372 733d 3433 3236 290a 2020 2020 3e3e  crs=4326).    >>
-00010420: 3e20 6764 660a 2020 2020 2020 2020 636f  > gdf.        co
-00010430: 6c31 2020 2020 2020 2020 2020 2020 2020  l1              
-00010440: 2020 2067 656f 6d65 7472 790a 2020 2020     geometry.    
-00010450: 3020 206e 616d 6531 2020 504f 494e 5420  0  name1  POINT 
-00010460: 2831 2e30 3030 3030 2032 2e30 3030 3030  (1.00000 2.00000
-00010470: 290a 2020 2020 3120 206e 616d 6532 2020  ).    1  name2  
-00010480: 504f 494e 5420 2832 2e30 3030 3030 2031  POINT (2.00000 1
-00010490: 2e30 3030 3030 290a 2020 2020 3220 206e  .00000).    2  n
-000104a0: 616d 6531 2020 504f 494e 5420 2830 2e30  ame1  POINT (0.0
-000104b0: 3030 3030 2031 2e30 3030 3030 290a 2020  0000 1.00000).  
-000104c0: 2020 3e3e 3e20 6469 7373 6f6c 7665 6420    >>> dissolved 
-000104d0: 3d20 6764 662e 6469 7373 6f6c 7665 2827  = gdf.dissolve('
-000104e0: 636f 6c31 2729 0a20 2020 203e 3e3e 2064  col1').    >>> d
-000104f0: 6973 736f 6c76 6564 2020 2320 646f 6374  issolved  # doct
-00010500: 6573 743a 202b 534b 4950 0a20 2020 2020  est: +SKIP.     
-00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010530: 2020 2020 2020 2020 2020 2067 656f 6d65             geome
-00010540: 7472 790a 2020 2020 636f 6c31 0a20 2020  try.    col1.   
-00010550: 206e 616d 6531 2020 4d55 4c54 4950 4f49   name1  MULTIPOI
-00010560: 4e54 2028 302e 3030 3030 3020 312e 3030  NT (0.00000 1.00
-00010570: 3030 302c 2031 2e30 3030 3030 2032 2e30  000, 1.00000 2.0
-00010580: 3030 3030 290a 2020 2020 6e61 6d65 3220  0000).    name2 
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2020 2020 2020 2050 4f49 4e54 2028 322e         POINT (2.
-000105b0: 3030 3030 3020 312e 3030 3030 3029 0a20  00000 1.00000). 
-000105c0: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-000105d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2047 656f  --------.    Geo
-000105e0: 4461 7461 4672 616d 652e 6578 706c 6f64  DataFrame.explod
-000105f0: 6520 3a20 6578 706c 6f64 6520 6d75 6c74  e : explode mult
-00010600: 692d 7061 7274 2067 656f 6d65 7472 6965  i-part geometrie
-00010610: 7320 696e 746f 2073 696e 676c 6520 6765  s into single ge
-00010620: 6f6d 6574 7269 6573 0a20 2020 2022 2222  ometries.    """
-00010630: 0a0a 2020 2020 6966 2062 7920 6973 204e  ..    if by is N
-00010640: 6f6e 6520 616e 6420 6c65 7665 6c20 6973  one and level is
-00010650: 204e 6f6e 653a 0a20 2020 2020 2020 2062   None:.        b
-00010660: 795f 6c6f 6361 6c20 3d20 6e70 2e7a 6572  y_local = np.zer
-00010670: 6f73 286c 656e 2864 6629 2c20 6474 7970  os(len(df), dtyp
-00010680: 653d 2269 6e74 3634 2229 0a20 2020 2065  e="int64").    e
-00010690: 6c73 653a 0a20 2020 2020 2020 2062 795f  lse:.        by_
-000106a0: 6c6f 6361 6c20 3d20 6279 0a0a 2020 2020  local = by..    
-000106b0: 6772 6f75 7062 795f 6b77 6172 6773 203d  groupby_kwargs =
-000106c0: 2064 6963 7428 0a20 2020 2020 2020 2062   dict(.        b
-000106d0: 793d 6279 5f6c 6f63 616c 2c20 6c65 7665  y=by_local, leve
-000106e0: 6c3d 6c65 7665 6c2c 2073 6f72 743d 736f  l=level, sort=so
-000106f0: 7274 2c20 6f62 7365 7276 6564 3d6f 6273  rt, observed=obs
-00010700: 6572 7665 642c 2064 726f 706e 613d 6472  erved, dropna=dr
-00010710: 6f70 6e61 0a20 2020 2029 0a20 2020 2022  opna.    ).    "
-00010720: 2222 0a20 2020 2069 6620 6e6f 7420 636f  "".    if not co
-00010730: 6d70 6174 2e50 414e 4441 535f 4745 5f31  mpat.PANDAS_GE_1
-00010740: 313a 0a20 2020 2020 2020 2067 726f 7570  1:.        group
-00010750: 6279 5f6b 7761 7267 732e 706f 7028 2264  by_kwargs.pop("d
-00010760: 726f 706e 6122 290a 0a20 2020 2020 2020  ropna")..       
-00010770: 2069 6620 6e6f 7420 6472 6f70 6e61 3a20   if not dropna: 
-00010780: 2023 2049 6620 7468 6579 2070 6173 7365   # If they passe
-00010790: 6420 6120 6e6f 6e2d 6465 6661 756c 7420  d a non-default 
-000107a0: 6472 6f70 6e61 2076 616c 7565 0a20 2020  dropna value.   
-000107b0: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-000107c0: 732e 7761 726e 2822 6472 6f70 6e61 206b  s.warn("dropna k
-000107d0: 7761 7267 2069 7320 6e6f 7420 7375 7070  warg is not supp
-000107e0: 6f72 7465 6420 666f 7220 7061 6e64 6173  orted for pandas
-000107f0: 203c 2031 2e31 2e30 2229 0a20 2020 2022   < 1.1.0").    "
-00010800: 2222 0a0a 2020 2020 2320 5072 6f63 6573  ""..    # Proces
-00010810: 7320 6e6f 6e2d 7370 6174 6961 6c20 636f  s non-spatial co
-00010820: 6d70 6f6e 656e 740a 2020 2020 6461 7461  mponent.    data
-00010830: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-00010840: 6466 2e64 726f 7028 636f 6c75 6d6e 733d  df.drop(columns=
-00010850: 6466 2e67 656f 6d65 7472 792e 6e61 6d65  df.geometry.name
-00010860: 2929 0a0a 2020 2020 6966 2061 6767 6675  ))..    if aggfu
-00010870: 6e63 2069 7320 6e6f 7420 4e6f 6e65 2061  nc is not None a
-00010880: 6e64 2069 7369 6e73 7461 6e63 6528 6167  nd isinstance(ag
-00010890: 6766 756e 632c 2064 6963 7429 2061 6e64  gfunc, dict) and
-000108a0: 2022 746f 5f6a 736f 6e22 2069 6e20 6167   "to_json" in ag
-000108b0: 6766 756e 633a 0a20 2020 2020 2020 2061  gfunc:.        a
-000108c0: 6767 5f63 6f6c 756d 6e73 203d 206c 6973  gg_columns = lis
-000108d0: 7428 7365 7428 6167 6766 756e 635b 2274  t(set(aggfunc["t
-000108e0: 6f5f 6a73 6f6e 225d 2929 0a20 2020 2020  o_json"])).     
-000108f0: 2020 2061 6767 7265 6761 7465 645f 6461     aggregated_da
-00010900: 7461 203d 2028 0a20 2020 2020 2020 2020  ta = (.         
-00010910: 2020 2064 6174 612e 6772 6f75 7062 7928     data.groupby(
-00010920: 2a2a 6772 6f75 7062 795f 6b77 6172 6773  **groupby_kwargs
-00010930: 290a 2020 2020 2020 2020 2020 2020 2e61  ).            .a
-00010940: 7070 6c79 286c 616d 6264 6120 673a 2067  pply(lambda g: g
-00010950: 5b61 6767 5f63 6f6c 756d 6e73 5d2e 746f  [agg_columns].to
-00010960: 5f6a 736f 6e28 6f72 6965 6e74 3d22 7265  _json(orient="re
-00010970: 636f 7264 7322 2929 0a20 2020 2020 2020  cords")).       
-00010980: 2020 2020 202e 746f 5f66 7261 6d65 286e       .to_frame(n
-00010990: 616d 653d 225f 5f44 4953 534f 4c56 455f  ame="__DISSOLVE_
-000109a0: 544f 4a53 4f4e 2229 0a20 2020 2020 2020  TOJSON").       
-000109b0: 2029 0a20 2020 2065 6c69 6620 6973 696e   ).    elif isin
-000109c0: 7374 616e 6365 2861 6767 6675 6e63 2c20  stance(aggfunc, 
-000109d0: 7374 7229 2061 6e64 2061 6767 6675 6e63  str) and aggfunc
-000109e0: 203d 3d20 226d 6572 6765 5f6a 736f 6e5f   == "merge_json_
-000109f0: 6c69 7374 7322 3a0a 2020 2020 2020 2020  lists":.        
-00010a00: 2320 4d65 7267 6520 616e 6420 666c 6174  # Merge and flat
-00010a10: 7465 6e20 7468 6520 6a73 6f6e 206c 6973  ten the json lis
-00010a20: 7473 2069 6e20 7468 6520 6772 6f75 7073  ts in the groups
-00010a30: 0a20 2020 2020 2020 2064 6566 2067 726f  .        def gro
-00010a40: 7570 5f66 6c61 7474 656e 5f6a 736f 6e5f  up_flatten_json_
-00010a50: 6c69 7374 2867 293a 0a20 2020 2020 2020  list(g):.       
-00010a60: 2020 2020 2023 2045 7661 6c75 6174 6520       # Evaluate 
-00010a70: 616c 6c20 6772 6f75 7065 6420 726f 7773  all grouped rows
-00010a80: 2074 6f20 6a73 6f6e 206f 626a 6563 7473   to json objects
-00010a90: 2e20 5468 6973 2072 6573 756c 7473 2069  . This results i
-00010aa0: 6e20 6120 6c69 7374 206f 660a 2020 2020  n a list of.    
-00010ab0: 2020 2020 2020 2020 2320 6c69 7374 7320          # lists 
-00010ac0: 6f66 206a 736f 6e20 6f62 6a65 6374 732e  of json objects.
-00010ad0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00010ae0: 6e5f 6e65 7374 6564 5f6c 6973 7473 203d  n_nested_lists =
-00010af0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00010b00: 2020 206a 736f 6e2e 6c6f 6164 7328 6a73     json.loads(js
-00010b10: 6f6e 5f76 616c 7565 7329 2066 6f72 206a  on_values) for j
-00010b20: 736f 6e5f 7661 6c75 6573 2069 6e20 675b  son_values in g[
-00010b30: 225f 5f44 4953 534f 4c56 455f 544f 4a53  "__DISSOLVE_TOJS
-00010b40: 4f4e 225d 0a20 2020 2020 2020 2020 2020  ON"].           
-00010b50: 205d 0a0a 2020 2020 2020 2020 2020 2020   ]..            
-00010b60: 2320 4578 7472 6163 7420 7468 6520 726f  # Extract the ro
-00010b70: 7773 2066 726f 6d20 7468 6520 6e65 7374  ws from the nest
-00010b80: 6564 206c 6973 7473 202b 2070 7574 2069  ed lists + put i
-00010b90: 6e20 6120 666c 6174 206c 6973 7420 6173  n a flat list as
-00010ba0: 2073 7472 696e 6773 0a20 2020 2020 2020   strings.       
-00010bb0: 2020 2020 206a 736f 6e73 7472 5f66 6c61       jsonstr_fla
-00010bc0: 7420 3d20 5b0a 2020 2020 2020 2020 2020  t = [.          
-00010bd0: 2020 2020 2020 6a73 6f6e 2e64 756d 7073        json.dumps
-00010be0: 286a 736f 6e5f 7661 6c75 6529 0a20 2020  (json_value).   
-00010bf0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00010c00: 206a 736f 6e5f 7661 6c75 6573 2069 6e20   json_values in 
-00010c10: 6a73 6f6e 5f6e 6573 7465 645f 6c69 7374  json_nested_list
-00010c20: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00010c30: 2020 666f 7220 6a73 6f6e 5f76 616c 7565    for json_value
-00010c40: 2069 6e20 6a73 6f6e 5f76 616c 7565 730a   in json_values.
-00010c50: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
-00010c60: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
-00010c70: 6f76 6520 6475 706c 6963 6174 6573 0a20  ove duplicates. 
-00010c80: 2020 2020 2020 2020 2020 206a 736f 6e73             jsons
-00010c90: 7374 725f 6469 7374 696e 6374 203d 2073  str_distinct = s
-00010ca0: 6574 286a 736f 6e73 7472 5f66 6c61 7429  et(jsonstr_flat)
-00010cb0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00010cc0: 436f 6e76 6572 7420 7468 6520 6461 7461  Convert the data
-00010cd0: 2061 6761 696e 2074 6f20 6120 6c69 7374   again to a list
-00010ce0: 206f 6620 6a73 6f6e 206f 626a 6563 7473   of json objects
-00010cf0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00010d00: 6e5f 6469 7374 696e 6374 203d 205b 6a73  n_distinct = [js
-00010d10: 6f6e 2e6c 6f61 6473 286a 736f 6e5f 7661  on.loads(json_va
-00010d20: 6c75 6529 2066 6f72 206a 736f 6e5f 7661  lue) for json_va
-00010d30: 6c75 6520 696e 206a 736f 6e73 7374 725f  lue in jsonsstr_
-00010d40: 6469 7374 696e 6374 5d0a 0a20 2020 2020  distinct]..     
-00010d50: 2020 2020 2020 2023 2052 6574 7572 6e20         # Return 
-00010d60: 6173 206a 736f 6e20 7374 7269 6e67 0a20  as json string. 
-00010d70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010d80: 6e20 6a73 6f6e 2e64 756d 7073 286a 736f  n json.dumps(jso
-00010d90: 6e5f 6469 7374 696e 6374 290a 0a20 2020  n_distinct)..   
-00010da0: 2020 2020 2061 6767 7265 6761 7465 645f       aggregated_
-00010db0: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
-00010dc0: 2020 2020 2064 6174 612e 6772 6f75 7062       data.groupb
-00010dd0: 7928 2a2a 6772 6f75 7062 795f 6b77 6172  y(**groupby_kwar
-00010de0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00010df0: 2e61 7070 6c79 286c 616d 6264 6120 673a  .apply(lambda g:
-00010e00: 2067 726f 7570 5f66 6c61 7474 656e 5f6a   group_flatten_j
-00010e10: 736f 6e5f 6c69 7374 2867 2929 0a20 2020  son_list(g)).   
-00010e20: 2020 2020 2020 2020 202e 746f 5f66 7261           .to_fra
-00010e30: 6d65 286e 616d 653d 225f 5f44 4953 534f  me(name="__DISSO
-00010e40: 4c56 455f 544f 4a53 4f4e 2229 0a20 2020  LVE_TOJSON").   
-00010e50: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-00010e60: 0a20 2020 2020 2020 2061 6767 7265 6761  .        aggrega
-00010e70: 7465 645f 6461 7461 203d 2064 6174 612e  ted_data = data.
-00010e80: 6772 6f75 7062 7928 2a2a 6772 6f75 7062  groupby(**groupb
-00010e90: 795f 6b77 6172 6773 292e 6167 6728 6167  y_kwargs).agg(ag
-00010ea0: 6766 756e 6329 2020 2320 7479 7065 3a20  gfunc)  # type: 
-00010eb0: 6967 6e6f 7265 0a20 2020 2020 2020 2023  ignore.        #
-00010ec0: 2043 6865 636b 2069 6620 616c 6c20 636f   Check if all co
-00010ed0: 6c75 6d6e 7320 7765 7265 2070 726f 7065  lumns were prope
-00010ee0: 726c 7920 6167 6772 6567 6174 6564 0a20  rly aggregated. 
-00010ef0: 2020 2020 2020 2061 7373 6572 7420 6279         assert by
-00010f00: 5f6c 6f63 616c 2069 7320 6e6f 7420 4e6f  _local is not No
-00010f10: 6e65 0a20 2020 2020 2020 2063 6f6c 756d  ne.        colum
-00010f20: 6e73 5f74 6f5f 6167 6720 3d20 5b63 6f6c  ns_to_agg = [col
-00010f30: 756d 6e20 666f 7220 636f 6c75 6d6e 2069  umn for column i
-00010f40: 6e20 6461 7461 2e63 6f6c 756d 6e73 2069  n data.columns i
-00010f50: 6620 636f 6c75 6d6e 206e 6f74 2069 6e20  f column not in 
-00010f60: 6279 5f6c 6f63 616c 5d0a 2020 2020 2020  by_local].      
-00010f70: 2020 6966 206c 656e 2863 6f6c 756d 6e73    if len(columns
-00010f80: 5f74 6f5f 6167 6729 2021 3d20 6c65 6e28  _to_agg) != len(
-00010f90: 6167 6772 6567 6174 6564 5f64 6174 612e  aggregated_data.
-00010fa0: 636f 6c75 6d6e 7329 3a0a 2020 2020 2020  columns):.      
-00010fb0: 2020 2020 2020 6472 6f70 7065 645f 636f        dropped_co
-00010fc0: 6c75 6d6e 7320 3d20 5b0a 2020 2020 2020  lumns = [.      
-00010fd0: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00010fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ff0: 2066 6f72 2063 6f6c 756d 6e20 696e 2063   for column in c
-00011000: 6f6c 756d 6e73 5f74 6f5f 6167 670a 2020  olumns_to_agg.  
-00011010: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00011020: 2063 6f6c 756d 6e20 6e6f 7420 696e 2061   column not in a
-00011030: 6767 7265 6761 7465 645f 6461 7461 2e63  ggregated_data.c
-00011040: 6f6c 756d 6e73 0a20 2020 2020 2020 2020  olumns.         
-00011050: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
-00011060: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-00011070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011080: 2020 6622 436f 6c75 6d6e 2873 2920 7b64    f"Column(s) {d
-00011090: 726f 7070 6564 5f63 6f6c 756d 6e73 7d20  ropped_columns} 
-000110a0: 6172 6520 6e6f 7420 7375 7070 6f72 7465  are not supporte
-000110b0: 6420 666f 7220 6167 6772 6567 6174 696f  d for aggregatio
-000110c0: 6e2c 2073 746f 7022 0a20 2020 2020 2020  n, stop".       
-000110d0: 2020 2020 2029 0a0a 2020 2020 2320 5072       )..    # Pr
-000110e0: 6f63 6573 7320 7370 6174 6961 6c20 636f  ocess spatial co
-000110f0: 6d70 6f6e 656e 740a 2020 2020 6465 6620  mponent.    def 
-00011100: 6d65 7267 655f 6765 6f6d 6574 7269 6573  merge_geometries
-00011110: 2862 6c6f 636b 293a 0a20 2020 2020 2020  (block):.       
-00011120: 206d 6572 6765 645f 6765 6f6d 203d 2062   merged_geom = b
-00011130: 6c6f 636b 2e75 6e61 7279 5f75 6e69 6f6e  lock.unary_union
-00011140: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011150: 6d65 7267 6564 5f67 656f 6d0a 0a20 2020  merged_geom..   
-00011160: 2067 203d 2064 662e 6772 6f75 7062 7928   g = df.groupby(
-00011170: 6772 6f75 705f 6b65 7973 3d46 616c 7365  group_keys=False
-00011180: 2c20 2a2a 6772 6f75 7062 795f 6b77 6172  , **groupby_kwar
-00011190: 6773 295b 6466 2e67 656f 6d65 7472 792e  gs)[df.geometry.
-000111a0: 6e61 6d65 5d2e 6167 6728 0a20 2020 2020  name].agg(.     
-000111b0: 2020 206d 6572 6765 5f67 656f 6d65 7472     merge_geometr
-000111c0: 6965 730a 2020 2020 290a 0a20 2020 2023  ies.    )..    #
-000111d0: 2041 6767 7265 6761 7465 0a20 2020 2061   Aggregate.    a
-000111e0: 6767 7265 6761 7465 645f 6765 6f6d 6574  ggregated_geomet
-000111f0: 7279 203d 2067 7064 2e47 656f 4461 7461  ry = gpd.GeoData
-00011200: 4672 616d 6528 0a20 2020 2020 2020 2064  Frame(.        d
-00011210: 6174 613d 672c 2067 656f 6d65 7472 793d  ata=g, geometry=
-00011220: 6466 2e67 656f 6d65 7472 792e 6e61 6d65  df.geometry.name
-00011230: 2c20 6372 733d 6466 2e63 7273 2020 2320  , crs=df.crs  # 
-00011240: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00011250: 2029 0a20 2020 2023 2052 6563 6f6d 6269   ).    # Recombi
-00011260: 6e65 0a20 2020 2061 6767 7265 6761 7465  ne.    aggregate
-00011270: 6420 3d20 6167 6772 6567 6174 6564 5f67  d = aggregated_g
-00011280: 656f 6d65 7472 792e 6a6f 696e 2861 6767  eometry.join(agg
-00011290: 7265 6761 7465 645f 6461 7461 290a 0a20  regated_data).. 
-000112a0: 2020 2023 2052 6573 6574 2069 6620 7265     # Reset if re
-000112b0: 7175 6573 7465 640a 2020 2020 6966 206e  quested.    if n
-000112c0: 6f74 2061 735f 696e 6465 783a 0a20 2020  ot as_index:.   
-000112d0: 2020 2020 2061 6767 7265 6761 7465 6420       aggregated 
-000112e0: 3d20 6167 6772 6567 6174 6564 2e72 6573  = aggregated.res
-000112f0: 6574 5f69 6e64 6578 2829 0a0a 2020 2020  et_index()..    
-00011300: 2320 4d61 6b65 2073 7572 6520 6f75 7470  # Make sure outp
-00011310: 7574 2074 7970 6573 206f 6620 6772 6f75  ut types of grou
-00011320: 7065 6420 636f 6c75 6d6e 7320 6172 6520  ped columns are 
-00011330: 7468 6520 7361 6d65 2061 7320 696e 7075  the same as inpu
-00011340: 7420 7479 7065 732e 0a20 2020 2023 2045  t types..    # E
-00011350: 2e67 2e20 6f62 6a65 6374 2063 6f6c 756d  .g. object colum
-00011360: 6e73 2062 6563 6f6d 6520 666c 6f61 7420  ns become float 
-00011370: 6966 2061 6c6c 2076 616c 7565 7320 6172  if all values ar
-00011380: 6520 4e6f 6e65 2e0a 2020 2020 6966 2062  e None..    if b
-00011390: 7920 6973 206e 6f74 204e 6f6e 653a 0a20  y is not None:. 
-000113a0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000113b0: 616e 6365 2862 792c 2073 7472 293a 0a20  ance(by, str):. 
-000113c0: 2020 2020 2020 2020 2020 2069 6620 6279             if by
-000113d0: 2069 6e20 6167 6772 6567 6174 6564 2e63   in aggregated.c
-000113e0: 6f6c 756d 6e73 2061 6e64 2064 665b 6279  olumns and df[by
-000113f0: 5d2e 6474 7970 6520 213d 2061 6767 7265  ].dtype != aggre
-00011400: 6761 7465 645b 6279 5d2e 6474 7970 653a  gated[by].dtype:
-00011410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011420: 2061 6767 7265 6761 7465 645b 6279 5d20   aggregated[by] 
-00011430: 3d20 6167 6772 6567 6174 6564 5b62 795d  = aggregated[by]
-00011440: 2e61 7374 7970 6528 6466 5b62 795d 2e64  .astype(df[by].d
-00011450: 7479 7065 2920 2023 2074 7970 653a 2069  type)  # type: i
-00011460: 676e 6f72 650a 2020 2020 2020 2020 656c  gnore.        el
-00011470: 6966 2069 7369 6e73 7461 6e63 6528 6279  if isinstance(by
-00011480: 2c20 4974 6572 6162 6c65 293a 0a20 2020  , Iterable):.   
-00011490: 2020 2020 2020 2020 2066 6f72 2063 6f6c           for col
-000114a0: 2069 6e20 6279 3a0a 2020 2020 2020 2020   in by:.        
-000114b0: 2020 2020 2020 2020 6966 2063 6f6c 2069          if col i
-000114c0: 6e20 6167 6772 6567 6174 6564 2e63 6f6c  n aggregated.col
-000114d0: 756d 6e73 2061 6e64 2064 665b 636f 6c5d  umns and df[col]
-000114e0: 2e64 7479 7065 2021 3d20 6167 6772 6567  .dtype != aggreg
-000114f0: 6174 6564 5b63 6f6c 5d2e 6474 7970 653a  ated[col].dtype:
-00011500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011510: 2020 2020 2061 6767 7265 6761 7465 645b       aggregated[
-00011520: 636f 6c5d 203d 2061 6767 7265 6761 7465  col] = aggregate
-00011530: 645b 636f 6c5d 2e61 7374 7970 6528 6466  d[col].astype(df
-00011540: 5b63 6f6c 5d2e 6474 7970 6529 0a0a 2020  [col].dtype)..  
-00011550: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00011560: 6e63 6528 6167 6772 6567 6174 6564 2c20  nce(aggregated, 
-00011570: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-00011580: 290a 2020 2020 7265 7475 726e 2061 6767  ).    return agg
-00011590: 7265 6761 7465 640a 0a0a 6465 6620 5f61  regated...def _a
-000115a0: 6464 5f6f 7264 6572 6279 5f63 6f6c 756d  dd_orderby_colum
-000115b0: 6e28 7061 7468 3a20 5061 7468 2c20 6c61  n(path: Path, la
-000115c0: 7965 723a 2073 7472 2c20 6e61 6d65 3a20  yer: str, name: 
-000115d0: 7374 7229 3a0a 2020 2020 2320 5072 6570  str):.    # Prep
-000115e0: 6172 6520 7468 6520 6578 7072 6573 7369  are the expressi
-000115f0: 6f6e 2074 6f20 6361 6c63 756c 6174 6520  on to calculate 
-00011600: 7468 6520 6f72 6465 7262 7920 636f 6c75  the orderby colu
-00011610: 6d6e 2e0a 2020 2020 2320 496e 2061 2073  mn..    # In a s
-00011620: 7061 7469 616c 2066 696c 652c 2061 2073  patial file, a s
-00011630: 7061 7469 616c 206f 7264 6572 2077 696c  patial order wil
-00011640: 6c20 6d61 6b65 206c 6174 6572 2075 7365  l make later use
-00011650: 206d 6f72 6520 6566 6669 6369 c3ab 6e74   more effici..nt
-00011660: 2c0a 2020 2020 2320 736f 2075 7365 2061  ,.    # so use a
-00011670: 2067 656f 6861 7368 2e0a 2020 2020 6c61   geohash..    la
-00011680: 7965 7269 6e66 6f20 3d20 6766 6f2e 6765  yerinfo = gfo.ge
-00011690: 745f 6c61 7965 7269 6e66 6f28 7061 7468  t_layerinfo(path
-000116a0: 290a 2020 2020 6966 206c 6179 6572 696e  ).    if layerin
-000116b0: 666f 2e63 7273 2069 7320 6e6f 7420 4e6f  fo.crs is not No
-000116c0: 6e65 2061 6e64 206c 6179 6572 696e 666f  ne and layerinfo
-000116d0: 2e63 7273 2e69 735f 6765 6f67 7261 7068  .crs.is_geograph
-000116e0: 6963 3a0a 2020 2020 2020 2020 2320 4966  ic:.        # If
-000116f0: 2074 6865 2063 6f6f 7264 696e 6174 6573   the coordinates
-00011700: 2061 7265 2067 656f 6772 6170 6869 6320   are geographic 
-00011710: 2869 6e20 6c61 742f 6c6f 6e20 6465 6772  (in lat/lon degr
-00011720: 6565 7329 2c20 6f6b 0a20 2020 2020 2020  ees), ok.       
-00011730: 2065 7870 7265 7373 696f 6e20 3d20 6622   expression = f"
-00011740: 5354 5f47 656f 4861 7368 287b 6c61 7965  ST_GeoHash({laye
-00011750: 7269 6e66 6f2e 6765 6f6d 6574 7279 636f  rinfo.geometryco
-00011760: 6c75 6d6e 7d2c 2031 3029 220a 2020 2020  lumn}, 10)".    
-00011770: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00011780: 4966 2074 6865 7920 6172 6520 6e6f 7420  If they are not 
-00011790: 6765 6f67 7261 7068 6963 2028 696e 206c  geographic (in l
-000117a0: 6174 2f6c 6f6e 2064 6567 7265 6573 292c  at/lon degrees),
-000117b0: 2074 6865 7920 6e65 6564 2074 6f20 6265   they need to be
-000117c0: 0a20 2020 2020 2020 2023 2063 6f6e 7665  .        # conve
-000117d0: 7274 6564 2074 6f20 7e20 6465 6772 6565  rted to ~ degree
-000117e0: 7320 746f 2062 6520 6162 6c65 2074 6f20  s to be able to 
-000117f0: 6361 6c63 756c 6174 6520 6120 6765 6f68  calculate a geoh
-00011800: 6173 682e 0a0a 2020 2020 2020 2020 2320  ash...        # 
-00011810: 5072 6f70 6572 6c79 2063 616c 6375 6c61  Properly calcula
-00011820: 7469 6e67 2074 6865 2074 7261 6e73 666f  ting the transfo
-00011830: 726d 6174 696f 6e20 746f 2065 672e 2057  rmation to eg. W
-00011840: 4753 2069 7320 7465 7272 6962 6c79 2073  GS is terribly s
-00011850: 6c6f 772e 2e2e 0a20 2020 2020 2020 2023  low....        #
-00011860: 2065 7870 7265 7373 696f 6e20 3d20 6622   expression = f"
-00011870: 2222 5354 5f47 656f 4861 7368 2853 545f  ""ST_GeoHash(ST_
-00011880: 5472 616e 7366 6f72 6d28 4d61 6b65 506f  Transform(MakePo
-00011890: 696e 7428 0a20 2020 2020 2020 2023 2020  int(.        #  
-000118a0: 2020 2020 2028 4d62 724d 6178 5828 6765       (MbrMaxX(ge
-000118b0: 6f6d 292b 4d62 724d 696e 5828 6765 6f6d  om)+MbrMinX(geom
-000118c0: 2929 2f32 2c0a 2020 2020 2020 2020 2320  ))/2,.        # 
-000118d0: 2020 2020 2020 284d 6272 4d69 6e59 2867        (MbrMinY(g
-000118e0: 656f 6d29 2b4d 6272 4d61 7859 2867 656f  eom)+MbrMaxY(geo
-000118f0: 6d29 292f 322c 2053 545f 5352 4944 2867  m))/2, ST_SRID(g
-00011900: 656f 6d29 292c 2034 3332 3629 2c20 3130  eom)), 4326), 10
-00011910: 2922 2222 0a20 2020 2020 2020 2023 2053  )""".        # S
-00011920: 6f2c 2064 6f20 736f 6d65 7468 696e 6720  o, do something 
-00011930: 656c 7365 2074 6861 7427 7320 6661 7374  else that's fast
-00011940: 6572 2061 6e64 2073 7469 6c6c 2067 6976  er and still giv
-00011950: 6573 2061 2067 6f6f 640a 2020 2020 2020  es a good.      
-00011960: 2020 2320 6765 6f67 7261 7068 6963 2063    # geographic c
-00011970: 6c75 7374 6572 696e 672e 0a20 2020 2020  lustering..     
-00011980: 2020 2074 6f5f 6765 6f67 7261 7068 6963     to_geographic
-00011990: 5f66 6163 746f 725f 6170 7072 6f78 203d  _factor_approx =
-000119a0: 2039 3020 2f20 6d61 7828 6c61 7965 7269   90 / max(layeri
-000119b0: 6e66 6f2e 746f 7461 6c5f 626f 756e 6473  nfo.total_bounds
-000119c0: 290a 2020 2020 2020 2020 6578 7072 6573  ).        expres
-000119d0: 7369 6f6e 203d 2066 2222 2253 545f 4765  sion = f"""ST_Ge
-000119e0: 6f48 6173 6828 4d61 6b65 506f 696e 7428  oHash(MakePoint(
-000119f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011a00: 2028 284d 6272 4d61 7858 287b 6c61 7965   ((MbrMaxX({laye
-00011a10: 7269 6e66 6f2e 6765 6f6d 6574 7279 636f  rinfo.geometryco
-00011a20: 6c75 6d6e 7d29 0a20 2020 2020 2020 2020  lumn}).         
-00011a30: 2020 2020 2020 2020 202b 4d62 724d 696e           +MbrMin
-00011a40: 5828 7b6c 6179 6572 696e 666f 2e67 656f  X({layerinfo.geo
-00011a50: 6d65 7472 7963 6f6c 756d 6e7d 2929 2f32  metrycolumn}))/2
-00011a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011a70: 2029 2a7b 746f 5f67 656f 6772 6170 6869   )*{to_geographi
-00011a80: 635f 6661 6374 6f72 5f61 7070 726f 787d  c_factor_approx}
-00011a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011aa0: 2020 2828 4d62 724d 696e 5928 7b6c 6179    ((MbrMinY({lay
-00011ab0: 6572 696e 666f 2e67 656f 6d65 7472 7963  erinfo.geometryc
-00011ac0: 6f6c 756d 6e7d 290a 2020 2020 2020 2020  olumn}).        
-00011ad0: 2020 2020 2020 2020 2020 2b4d 6272 4d61            +MbrMa
-00011ae0: 7859 287b 6c61 7965 7269 6e66 6f2e 6765  xY({layerinfo.ge
-00011af0: 6f6d 6574 7279 636f 6c75 6d6e 7d29 292f  ometrycolumn}))/
-00011b00: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-00011b10: 2020 292a 7b74 6f5f 6765 6f67 7261 7068    )*{to_geograph
-00011b20: 6963 5f66 6163 746f 725f 6170 7072 6f78  ic_factor_approx
-00011b30: 7d2c 2034 3332 3629 2c20 3130 2922 2222  }, 4326), 10)"""
-00011b40: 0a0a 2020 2020 2320 4e6f 7720 7765 2063  ..    # Now we c
-00011b50: 616e 2061 6374 7561 6c6c 7920 6164 6420  an actually add 
-00011b60: 7468 6520 636f 6c75 6d6e 2e0a 2020 2020  the column..    
-00011b70: 6766 6f2e 6164 645f 636f 6c75 6d6e 2870  gfo.add_column(p
-00011b80: 6174 683d 7061 7468 2c20 6e61 6d65 3d6e  ath=path, name=n
-00011b90: 616d 652c 2074 7970 653d 6766 6f2e 4461  ame, type=gfo.Da
-00011ba0: 7461 5479 7065 2e54 4558 542c 2065 7870  taType.TEXT, exp
-00011bb0: 7265 7373 696f 6e3d 6578 7072 6573 7369  ression=expressi
-00011bc0: 6f6e 290a 2020 2020 7371 6c69 7465 5f73  on).    sqlite_s
-00011bd0: 746d 7420 3d20 6627 4352 4541 5445 2049  tmt = f'CREATE I
-00011be0: 4e44 4558 207b 6e61 6d65 7d5f 6964 7820  NDEX {name}_idx 
-00011bf0: 4f4e 2022 7b6c 6179 6572 7d22 287b 6e61  ON "{layer}"({na
-00011c00: 6d65 7d29 270a 2020 2020 6766 6f2e 6578  me})'.    gfo.ex
-00011c10: 6563 7574 655f 7371 6c28 7061 7468 3d70  ecute_sql(path=p
-00011c20: 6174 682c 2073 716c 5f73 746d 743d 7371  ath, sql_stmt=sq
-00011c30: 6c69 7465 5f73 746d 7429 0a              lite_stmt).
+0000f760: 2020 2066 6f72 2061 6767 5f63 6f6c 756d     for agg_colum
+0000f770: 6e20 696e 2061 6767 5f63 6f6c 756d 6e73  n in agg_columns
+0000f780: 5b22 636f 6c75 6d6e 7322 5d0a 2020 2020  ["columns"].    
+0000f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7a0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0000f7b0: 2020 2020 2020 2020 2020 6966 2061 6767            if agg
+0000f7c0: 5f63 6f6c 756d 6e73 5f6e 6565 6465 6420  _columns_needed 
+0000f7d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7f0: 2020 2020 2063 6f6c 756d 6e73 5f74 6f5f       columns_to_
+0000f800: 7265 6164 2e75 7064 6174 6528 6167 675f  read.update(agg_
+0000f810: 636f 6c75 6d6e 735f 6e65 6564 6564 290a  columns_needed).
+0000f820: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0000f830: 7574 5f67 6466 203d 2067 666f 2e72 6561  ut_gdf = gfo.rea
+0000f840: 645f 6669 6c65 280a 2020 2020 2020 2020  d_file(.        
+0000f850: 2020 2020 2020 2020 7061 7468 3d69 6e70          path=inp
+0000f860: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
+0000f870: 2020 2020 2020 2020 206c 6179 6572 3d69           layer=i
+0000f880: 6e70 7574 5f6c 6179 6572 2c0a 2020 2020  nput_layer,.    
+0000f890: 2020 2020 2020 2020 2020 2020 6262 6f78              bbox
+0000f8a0: 3d62 626f 782c 0a20 2020 2020 2020 2020  =bbox,.         
+0000f8b0: 2020 2020 2020 2063 6f6c 756d 6e73 3d63         columns=c
+0000f8c0: 6f6c 756d 6e73 5f74 6f5f 7265 6164 2c0a  olumns_to_read,.
+0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8e0: 6669 645f 6173 5f69 6e64 6578 3d66 6964  fid_as_index=fid
+0000f8f0: 5f61 735f 696e 6465 782c 0a20 2020 2020  _as_index,.     
+0000f900: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000f910: 2020 2020 2020 6966 2061 6767 5f63 6f6c        if agg_col
+0000f920: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
+0000f930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f940: 2020 696e 7075 745f 6764 665b 2266 6964    input_gdf["fid
+0000f950: 5f6f 7269 6722 5d20 3d20 696e 7075 745f  _orig"] = input_
+0000f960: 6764 662e 696e 6465 780a 2020 2020 2020  gdf.index.      
+0000f970: 2020 2020 2020 2020 2020 6966 2061 6767            if agg
+0000f980: 5f63 6f6c 756d 6e73 5f6e 6565 6465 6420  _columns_needed 
+0000f990: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9b0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
+0000f9c0: 6465 642e 6170 7065 6e64 2822 6669 645f  ded.append("fid_
+0000f9d0: 6f72 6967 2229 0a0a 2020 2020 2020 2020  orig")..        
+0000f9e0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+0000f9f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0000fa00: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+0000fa10: 2020 2020 2020 6966 2073 7472 2865 7829        if str(ex)
+0000fa20: 203d 3d20 2264 6174 6162 6173 6520 6973   == "database is
+0000fa30: 206c 6f63 6b65 6422 3a0a 2020 2020 2020   locked":.      
+0000fa40: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
+0000fa50: 7279 5f63 6f75 6e74 203c 2031 303a 0a20  ry_count < 10:. 
+0000fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa70: 2020 2072 6574 7279 5f63 6f75 6e74 202b     retry_count +
+0000fa80: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0000fa90: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+0000faa0: 6570 2831 290a 2020 2020 2020 2020 2020  ep(1).          
+0000fab0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fad0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0000fae0: 2272 6574 7269 6564 2031 3020 7469 6d65  "retried 10 time
+0000faf0: 732c 2064 6174 6162 6173 6520 7374 696c  s, database stil
+0000fb00: 6c20 6c6f 636b 6564 2229 2066 726f 6d20  l locked") from 
+0000fb10: 6578 0a20 2020 2020 2020 2020 2020 2065  ex.            e
+0000fb20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000fb30: 2020 2020 2072 6169 7365 2065 780a 0a20       raise ex.. 
+0000fb40: 2020 2023 2043 6865 636b 2072 6573 756c     # Check resul
+0000fb50: 740a 2020 2020 7065 7266 696e 666f 5b22  t.    perfinfo["
+0000fb60: 7469 6d65 5f72 6561 6422 5d20 3d20 2864  time_read"] = (d
+0000fb70: 6174 6574 696d 652e 6e6f 7728 2920 2d20  atetime.now() - 
+0000fb80: 7374 6172 745f 7265 6164 292e 746f 7461  start_read).tota
+0000fb90: 6c5f 7365 636f 6e64 7328 290a 2020 2020  l_seconds().    
+0000fba0: 7265 7475 726e 5f69 6e66 6f5b 226e 625f  return_info["nb_
+0000fbb0: 726f 7773 5f64 6f6e 6522 5d20 3d20 6c65  rows_done"] = le
+0000fbc0: 6e28 696e 7075 745f 6764 6629 0a20 2020  n(input_gdf).   
+0000fbd0: 2069 6620 7265 7475 726e 5f69 6e66 6f5b   if return_info[
+0000fbe0: 226e 625f 726f 7773 5f64 6f6e 6522 5d20  "nb_rows_done"] 
+0000fbf0: 3d3d 2030 3a0a 2020 2020 2020 2020 6d65  == 0:.        me
+0000fc00: 7373 6167 6520 3d20 6622 4e6f 2069 6e70  ssage = f"No inp
+0000fc10: 7574 2067 656f 6d65 7472 6965 7320 666f  ut geometries fo
+0000fc20: 756e 6420 696e 207b 696e 7075 745f 7061  und in {input_pa
+0000fc30: 7468 7d22 0a20 2020 2020 2020 206c 6f67  th}".        log
+0000fc40: 6765 722e 696e 666f 286d 6573 7361 6765  ger.info(message
+0000fc50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000fc60: 5f69 6e66 6f5b 226d 6573 7361 6765 225d  _info["message"]
+0000fc70: 203d 206d 6573 7361 6765 0a20 2020 2020   = message.     
+0000fc80: 2020 2072 6574 7572 6e5f 696e 666f 5b22     return_info["
+0000fc90: 746f 7461 6c5f 7469 6d65 225d 203d 2028  total_time"] = (
+0000fca0: 6461 7465 7469 6d65 2e6e 6f77 2829 202d  datetime.now() -
+0000fcb0: 2073 7461 7274 5f74 696d 6529 2e74 6f74   start_time).tot
+0000fcc0: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
+0000fcd0: 2020 2020 2072 6574 7572 6e20 7265 7475       return retu
+0000fce0: 726e 5f69 6e66 6f0a 0a20 2020 2023 204e  rn_info..    # N
+0000fcf0: 6f77 2074 6865 2072 6561 6c20 7072 6f63  ow the real proc
+0000fd00: 6573 7369 6e67 0a20 2020 2069 6620 6167  essing.    if ag
+0000fd10: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
+0000fd20: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0000fd30: 6620 225f 5f44 4953 534f 4c56 455f 544f  f "__DISSOLVE_TO
+0000fd40: 4a53 4f4e 2220 6e6f 7420 696e 2069 6e70  JSON" not in inp
+0000fd50: 7574 5f67 6466 2e63 6f6c 756d 6e73 3a0a  ut_gdf.columns:.
+0000fd60: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+0000fd70: 7273 7420 7061 7373 202d 3e20 7075 7420  rst pass -> put 
+0000fd80: 7265 6c65 7661 6e74 2063 6f6c 756d 6e73  relevant columns
+0000fd90: 2069 6e20 6a73 6f6e 2066 6965 6c64 0a20   in json field. 
+0000fda0: 2020 2020 2020 2020 2020 2061 6767 6675             aggfu
+0000fdb0: 6e63 203d 207b 2274 6f5f 6a73 6f6e 223a  nc = {"to_json":
+0000fdc0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
+0000fdd0: 6465 647d 0a20 2020 2020 2020 2065 6c73  ded}.        els
+0000fde0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0000fdf0: 2043 6f6c 756d 6e73 2061 6c72 6561 6479   Columns already
+0000fe00: 2063 6f64 6564 2069 6e20 6120 6a73 6f6e   coded in a json
+0000fe10: 2063 6f6c 756d 6e2c 2073 6f20 6d65 7267   column, so merg
+0000fe20: 6520 6a73 6f6e 206c 6973 7473 0a20 2020  e json lists.   
+0000fe30: 2020 2020 2020 2020 2061 6767 6675 6e63           aggfunc
+0000fe40: 203d 2022 6d65 7267 655f 6a73 6f6e 5f6c   = "merge_json_l
+0000fe50: 6973 7473 220a 2020 2020 656c 7365 3a0a  ists".    else:.
+0000fe60: 2020 2020 2020 2020 6167 6766 756e 6320          aggfunc 
+0000fe70: 3d20 2266 6972 7374 220a 2020 2020 7374  = "first".    st
+0000fe80: 6172 745f 6469 7373 6f6c 7665 203d 2064  art_dissolve = d
+0000fe90: 6174 6574 696d 652e 6e6f 7728 290a 2020  atetime.now().  
+0000fea0: 2020 6469 7373 5f67 6466 203d 205f 6469    diss_gdf = _di
+0000feb0: 7373 6f6c 7665 280a 2020 2020 2020 2020  ssolve(.        
+0000fec0: 6466 3d69 6e70 7574 5f67 6466 2c20 6279  df=input_gdf, by
+0000fed0: 3d67 726f 7570 6279 5f63 6f6c 756d 6e73  =groupby_columns
+0000fee0: 2c20 6167 6766 756e 633d 6167 6766 756e  , aggfunc=aggfun
+0000fef0: 632c 2061 735f 696e 6465 783d 4661 6c73  c, as_index=Fals
+0000ff00: 652c 2064 726f 706e 613d 4661 6c73 650a  e, dropna=False.
+0000ff10: 2020 2020 290a 2020 2020 7065 7266 696e      ).    perfin
+0000ff20: 666f 5b22 7469 6d65 5f64 6973 736f 6c76  fo["time_dissolv
+0000ff30: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
+0000ff40: 6e6f 7728 2920 2d20 7374 6172 745f 6469  now() - start_di
+0000ff50: 7373 6f6c 7665 292e 746f 7461 6c5f 7365  ssolve).total_se
+0000ff60: 636f 6e64 7328 290a 0a20 2020 2023 2049  conds()..    # I
+0000ff70: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
+0000ff80: 696f 6e73 2069 7320 5472 7565 2061 6e64  ions is True and
+0000ff90: 2046 6f72 2070 6f6c 7967 6f6e 732c 2065   For polygons, e
+0000ffa0: 7870 6c6f 6465 206d 756c 7469 2d67 656f  xplode multi-geo
+0000ffb0: 6d65 7472 6965 732e 0a20 2020 2023 2049  metries..    # I
+0000ffc0: 6620 6e65 6564 6564 2074 6865 7920 7769  f needed they wi
+0000ffd0: 6c6c 2062 6520 2763 6f6c 6c65 6374 6564  ll be 'collected
+0000ffe0: 2720 6166 7465 7277 6172 6473 2074 6f20  ' afterwards to 
+0000fff0: 6d75 6c74 6970 6f6c 7967 6f6e 7320 6167  multipolygons ag
+00010000: 6169 6e2e 0a20 2020 2069 6620 6578 706c  ain..    if expl
+00010010: 6f64 6563 6f6c 6c65 6374 696f 6e73 2069  odecollections i
+00010020: 7320 5472 7565 206f 7220 696e 7075 745f  s True or input_
+00010030: 6765 6f6d 6574 7279 7479 7065 2069 6e20  geometrytype in 
+00010040: 5b0a 2020 2020 2020 2020 4765 6f6d 6574  [.        Geomet
+00010050: 7279 5479 7065 2e50 4f4c 5947 4f4e 2c0a  ryType.POLYGON,.
+00010060: 2020 2020 2020 2020 4765 6f6d 6574 7279          Geometry
+00010070: 5479 7065 2e4d 554c 5449 504f 4c59 474f  Type.MULTIPOLYGO
+00010080: 4e2c 0a20 2020 205d 3a0a 2020 2020 2020  N,.    ]:.      
+00010090: 2020 2320 6173 7365 7274 2074 6f20 6576    # assert to ev
+000100a0: 6164 6520 7079 4c61 6e63 6520 7761 726e  ade pyLance warn
+000100b0: 696e 670a 2020 2020 2020 2020 6173 7365  ing.        asse
+000100c0: 7274 2069 7369 6e73 7461 6e63 6528 6469  rt isinstance(di
+000100d0: 7373 5f67 6466 2c20 6770 642e 4765 6f44  ss_gdf, gpd.GeoD
+000100e0: 6174 6146 7261 6d65 290a 2020 2020 2020  ataFrame).      
+000100f0: 2020 6469 7373 5f67 6466 203d 2064 6973    diss_gdf = dis
+00010100: 735f 6764 662e 6578 706c 6f64 6528 6967  s_gdf.explode(ig
+00010110: 6e6f 7265 5f69 6e64 6578 3d54 7275 6529  nore_index=True)
+00010120: 0a0a 2020 2020 2320 436c 6970 2074 6865  ..    # Clip the
+00010130: 2072 6573 756c 7420 6f6e 2074 6865 2062   result on the b
+00010140: 6f72 6465 7273 206f 6620 7468 6520 6262  orders of the bb
+00010150: 6f78 206e 6f74 2074 6f20 6861 7665 206f  ox not to have o
+00010160: 7665 726c 6170 730a 2020 2020 2320 6265  verlaps.    # be
+00010170: 7477 6565 6e20 7468 6520 6469 6666 6572  tween the differ
+00010180: 656e 7420 7469 6c65 732e 0a20 2020 2023  ent tiles..    #
+00010190: 2049 6620 7468 6973 2069 7320 6e6f 7420   If this is not 
+000101a0: 6170 706c 6965 642c 2074 6869 7320 7265  applied, this re
+000101b0: 7375 6c74 7320 696e 2073 6f6d 6520 6765  sults in some ge
+000101c0: 6f6d 6574 7269 6573 206e 6f74 2062 6569  ometries not bei
+000101d0: 6e67 206d 6572 6765 640a 2020 2020 2320  ng merged.    # 
+000101e0: 6f72 2069 6e20 6475 706c 6963 6174 6573  or in duplicates
+000101f0: 2e0a 2020 2020 2320 5245 4d41 524b 3a20  ..    # REMARK: 
+00010200: 666f 7220 286d 756c 7469 296c 696e 6573  for (multi)lines
+00010210: 7472 696e 6773 2c20 7468 6520 656e 6470  trings, the endp
+00010220: 6f69 6e74 7320 6372 6561 7465 6420 6279  oints created by
+00010230: 2074 6865 2063 6c69 7020 6172 6520 6e6f   the clip are no
+00010240: 740a 2020 2020 2320 616c 7761 7973 2074  t.    # always t
+00010250: 6865 2073 616d 6520 6475 6520 746f 2072  he same due to r
+00010260: 6f75 6e64 696e 672c 2073 6f20 6469 7373  ounding, so diss
+00010270: 6f6c 7669 6e67 2069 6e20 6120 6e65 7874  olving in a next
+00010280: 2070 6173 7320 646f 6573 6e27 740a 2020   pass doesn't.  
+00010290: 2020 2320 616c 7761 7973 2072 6573 756c    # always resul
+000102a0: 7420 696e 206c 696e 6573 7472 696e 6773  t in linestrings
+000102b0: 2062 6569 6e67 2072 652d 636f 6e6e 6563   being re-connec
+000102c0: 7465 642e 2e2e 2042 6563 6175 7365 2064  ted... Because d
+000102d0: 6973 736f 6c76 696e 670a 2020 2020 2320  issolving.    # 
+000102e0: 6c69 6e65 7320 6973 6e27 7420 736f 2063  lines isn't so c
+000102f0: 6f6d 7075 7461 7469 6f6e 616c 6c79 2068  omputationally h
+00010300: 6561 7679 2061 6e79 7761 792c 2064 726f  eavy anyway, dro
+00010310: 7020 7375 7070 6f72 7420 6865 7265 2e0a  p support here..
+00010320: 2020 2020 6966 2062 626f 7820 6973 206e      if bbox is n
+00010330: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00010340: 2073 7461 7274 5f63 6c69 7020 3d20 6461   start_clip = da
+00010350: 7465 7469 6d65 2e6e 6f77 2829 0a20 2020  tetime.now().   
+00010360: 2020 2020 2062 626f 785f 706f 6c79 676f       bbox_polygo
+00010370: 6e20 3d20 7368 5f67 656f 6d2e 506f 6c79  n = sh_geom.Poly
+00010380: 676f 6e28 0a20 2020 2020 2020 2020 2020  gon(.           
+00010390: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+000103a0: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
+000103b0: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
+000103c0: 2020 2020 2020 2028 6262 6f78 5b30 5d2c         (bbox[0],
+000103d0: 2062 626f 785b 335d 292c 0a20 2020 2020   bbox[3]),.     
+000103e0: 2020 2020 2020 2020 2020 2028 6262 6f78             (bbox
+000103f0: 5b32 5d2c 2062 626f 785b 335d 292c 0a20  [2], bbox[3]),. 
+00010400: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00010410: 6262 6f78 5b32 5d2c 2062 626f 785b 315d  bbox[2], bbox[1]
+00010420: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00010430: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
+00010440: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
+00010450: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
+00010460: 2020 2020 2020 2062 626f 785f 6764 6620         bbox_gdf 
+00010470: 3d20 6770 642e 4765 6f44 6174 6146 7261  = gpd.GeoDataFra
+00010480: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
+00010490: 6461 7461 3d5b 315d 2c20 6765 6f6d 6574  data=[1], geomet
+000104a0: 7279 3d5b 6262 6f78 5f70 6f6c 7967 6f6e  ry=[bbox_polygon
+000104b0: 5d2c 2063 7273 3d69 6e70 7574 5f67 6466  ], crs=input_gdf
+000104c0: 2e63 7273 2020 2320 7479 7065 3a20 6967  .crs  # type: ig
+000104d0: 6e6f 7265 0a20 2020 2020 2020 2029 0a0a  nore.        )..
+000104e0: 2020 2020 2020 2020 2320 4361 7463 6820          # Catch 
+000104f0: 6972 7265 6c65 7661 6e74 2070 616e 6461  irrelevant panda
+00010500: 7320 6675 7475 7265 2077 6172 6e69 6e67  s future warning
+00010510: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
+00010520: 2077 6865 6e20 7265 6d6f 7665 6420 696e   when removed in
+00010530: 206c 6174 6572 2076 6572 7369 6f6e 206f   later version o
+00010540: 6620 7061 6e64 6173 2c20 6361 6e20 6265  f pandas, can be
+00010550: 2072 656d 6f76 6564 2068 6572 650a 2020   removed here.  
+00010560: 2020 2020 2020 7769 7468 2077 6172 6e69        with warni
+00010570: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
+00010580: 6773 2829 3a0a 2020 2020 2020 2020 2020  gs():.          
+00010590: 2020 6d65 7373 6167 6520 3d20 280a 2020    message = (.  
+000105a0: 2020 2020 2020 2020 2020 2020 2020 2249                "I
+000105b0: 6e20 6120 6675 7475 7265 2076 6572 7369  n a future versi
+000105c0: 6f6e 2c20 6064 662e 696c 6f63 5b3a 2c20  on, `df.iloc[:, 
+000105d0: 695d 203d 206e 6577 7661 6c73 6020 7769  i] = newvals` wi
+000105e0: 6c6c 2061 7474 656d 7074 2074 6f20 220a  ll attempt to ".
+000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010600: 2273 6574 2074 6865 2076 616c 7565 7320  "set the values 
+00010610: 696e 706c 6163 6520 696e 7374 6561 6420  inplace instead 
+00010620: 6f66 2061 6c77 6179 7320 7365 7474 696e  of always settin
+00010630: 6720 6120 6e65 7720 6172 7261 792e 220a  g a new array.".
+00010640: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00010650: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
+00010660: 6773 2e66 696c 7465 7277 6172 6e69 6e67  gs.filterwarning
+00010670: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00010680: 2020 2061 6374 696f 6e3d 2269 676e 6f72     action="ignor
+00010690: 6522 2c20 6361 7465 676f 7279 3d46 7574  e", category=Fut
+000106a0: 7572 6557 6172 6e69 6e67 2c20 6d65 7373  ureWarning, mess
+000106b0: 6167 653d 7265 2e65 7363 6170 6528 6d65  age=re.escape(me
+000106c0: 7373 6167 6529 0a20 2020 2020 2020 2020  ssage).         
+000106d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000106e0: 2023 206b 6565 705f 6765 6f6d 5f74 7970   # keep_geom_typ
+000106f0: 653d 5472 7565 2067 6176 6520 736f 6d65  e=True gave some
+00010700: 7469 6d65 7320 6572 726f 722c 2061 6e64  times error, and
+00010710: 2073 7469 6c6c 2064 6f65 7320 696e 2030   still does in 0
+00010720: 2e39 2e30 0a20 2020 2020 2020 2020 2020  .9.0.           
+00010730: 2023 2073 6f20 7573 6520 6f77 6e20 696d   # so use own im
+00010740: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
+00010750: 6b65 6570 5f67 656f 6d5f 7479 7065 0a20  keep_geom_type. 
+00010760: 2020 2020 2020 2020 2020 2064 6973 735f             diss_
+00010770: 6764 6620 3d20 6770 642e 636c 6970 2864  gdf = gpd.clip(d
+00010780: 6973 735f 6764 662c 2062 626f 785f 6764  iss_gdf, bbox_gd
+00010790: 6629 2020 2320 2c20 6b65 6570 5f67 656f  f)  # , keep_geo
+000107a0: 6d5f 7479 7065 3d54 7275 6529 0a20 2020  m_type=True).   
+000107b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000107c0: 6973 696e 7374 616e 6365 2864 6973 735f  isinstance(diss_
+000107d0: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
+000107e0: 4672 616d 6529 0a0a 2020 2020 2020 2020  Frame)..        
+000107f0: 2320 4f6e 6c79 206b 6565 7020 6765 6f6d  # Only keep geom
+00010800: 6574 7269 6573 206f 6620 7468 6520 7072  etries of the pr
+00010810: 696d 6974 6976 6520 7479 7065 2073 7065  imitive type spe
+00010820: 6369 6669 6564 2061 6674 6572 2063 6c69  cified after cli
+00010830: 702e 2e2e 0a20 2020 2020 2020 2061 7373  p....        ass
+00010840: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
+00010850: 6973 735f 6764 662c 2067 7064 2e47 656f  iss_gdf, gpd.Geo
+00010860: 4461 7461 4672 616d 6529 0a20 2020 2020  DataFrame).     
+00010870: 2020 2064 6973 735f 6764 662e 6765 6f6d     diss_gdf.geom
+00010880: 6574 7279 203d 2067 656f 7365 7269 6573  etry = geoseries
+00010890: 5f75 7469 6c2e 6765 6f6d 6574 7279 5f63  _util.geometry_c
+000108a0: 6f6c 6c65 6374 696f 6e5f 6578 7472 6163  ollection_extrac
+000108b0: 7428 0a20 2020 2020 2020 2020 2020 2064  t(.            d
+000108c0: 6973 735f 6764 662e 6765 6f6d 6574 7279  iss_gdf.geometry
+000108d0: 2c20 696e 7075 745f 6765 6f6d 6574 7279  , input_geometry
+000108e0: 7479 7065 2e74 6f5f 7072 696d 6974 6976  type.to_primitiv
+000108f0: 6574 7970 650a 2020 2020 2020 2020 290a  etype.        ).
+00010900: 0a20 2020 2020 2020 2070 6572 6669 6e66  .        perfinf
+00010910: 6f5b 2274 696d 655f 636c 6970 225d 203d  o["time_clip"] =
+00010920: 2028 6461 7465 7469 6d65 2e6e 6f77 2829   (datetime.now()
+00010930: 202d 2073 7461 7274 5f63 6c69 7029 2e74   - start_clip).t
+00010940: 6f74 616c 5f73 6563 6f6e 6473 2829 0a0a  otal_seconds()..
+00010950: 2020 2020 2320 5365 7420 656d 7074 7920      # Set empty 
+00010960: 6765 6f6d 6574 7269 6573 2074 6f20 6e75  geometries to nu
+00010970: 6c6c 2f4e 6f6e 650a 2020 2020 6173 7365  ll/None.    asse
+00010980: 7274 2064 6973 735f 6764 662e 6765 6f6d  rt diss_gdf.geom
+00010990: 6574 7279 2069 7320 6e6f 7420 4e6f 6e65  etry is not None
+000109a0: 0a20 2020 2064 6973 735f 6764 662e 6c6f  .    diss_gdf.lo
+000109b0: 635b 6469 7373 5f67 6466 2e67 656f 6d65  c[diss_gdf.geome
+000109c0: 7472 792e 6973 5f65 6d70 7479 2c20 5b22  try.is_empty, ["
+000109d0: 6765 6f6d 6574 7279 225d 5d20 3d20 4e6f  geometry"]] = No
+000109e0: 6e65 0a0a 2020 2020 2320 5265 6d6f 7665  ne..    # Remove
+000109f0: 2072 6f77 7320 7768 6572 6520 6765 6f6d   rows where geom
+00010a00: 2069 7320 4e6f 6e65 2f6e 756c 6c2f 656d   is None/null/em
+00010a10: 7074 790a 2020 2020 6966 206e 6f74 206b  pty.    if not k
+00010a20: 6565 705f 656d 7074 795f 6765 6f6d 733a  eep_empty_geoms:
+00010a30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00010a40: 6973 696e 7374 616e 6365 2864 6973 735f  isinstance(diss_
+00010a50: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
+00010a60: 4672 616d 6529 0a20 2020 2020 2020 2064  Frame).        d
+00010a70: 6973 735f 6764 6620 3d20 6469 7373 5f67  iss_gdf = diss_g
+00010a80: 6466 5b7e 6469 7373 5f67 6466 2e67 656f  df[~diss_gdf.geo
+00010a90: 6d65 7472 792e 6973 6e61 2829 5d0a 0a20  metry.isna()].. 
+00010aa0: 2020 2023 2049 6620 7468 6572 6520 6973     # If there is
+00010ab0: 206e 6f20 7265 7375 6c74 2c20 7265 7475   no result, retu
+00010ac0: 726e 0a20 2020 2069 6620 6c65 6e28 6469  rn.    if len(di
+00010ad0: 7373 5f67 6466 2920 3d3d 2030 3a0a 2020  ss_gdf) == 0:.  
+00010ae0: 2020 2020 2020 6d65 7373 6167 6520 3d20        message = 
+00010af0: 6622 5265 7375 6c74 2069 7320 656d 7074  f"Result is empt
+00010b00: 7920 666f 7220 7b69 6e70 7574 5f70 6174  y for {input_pat
+00010b10: 687d 220a 2020 2020 2020 2020 7265 7475  h}".        retu
+00010b20: 726e 5f69 6e66 6f5b 226d 6573 7361 6765  rn_info["message
+00010b30: 225d 203d 206d 6573 7361 6765 0a20 2020  "] = message.   
+00010b40: 2020 2020 2072 6574 7572 6e5f 696e 666f       return_info
+00010b50: 5b22 7065 7266 696e 666f 225d 203d 2070  ["perfinfo"] = p
+00010b60: 6572 6669 6e66 6f0a 2020 2020 2020 2020  erfinfo.        
+00010b70: 7265 7475 726e 5f69 6e66 6f5b 2274 6f74  return_info["tot
+00010b80: 616c 5f74 696d 6522 5d20 3d20 2864 6174  al_time"] = (dat
+00010b90: 6574 696d 652e 6e6f 7728 2920 2d20 7374  etime.now() - st
+00010ba0: 6172 745f 7469 6d65 292e 746f 7461 6c5f  art_time).total_
+00010bb0: 7365 636f 6e64 7328 290a 2020 2020 2020  seconds().      
+00010bc0: 2020 7265 7475 726e 2072 6574 7572 6e5f    return return_
+00010bd0: 696e 666f 0a0a 2020 2020 2320 4164 6420  info..    # Add 
+00010be0: 636f 6c75 6d6e 2077 6974 6820 7469 6c65  column with tile
+00010bf0: 5f69 640a 2020 2020 6173 7365 7274 2069  _id.    assert i
+00010c00: 7369 6e73 7461 6e63 6528 6469 7373 5f67  sinstance(diss_g
+00010c10: 6466 2c20 6770 642e 4765 6f44 6174 6146  df, gpd.GeoDataF
+00010c20: 7261 6d65 290a 2020 2020 6966 2074 696c  rame).    if til
+00010c30: 655f 6964 2069 7320 6e6f 7420 4e6f 6e65  e_id is not None
+00010c40: 3a0a 2020 2020 2020 2020 6469 7373 5f67  :.        diss_g
+00010c50: 6466 5b22 7469 6c65 5f69 6422 5d20 3d20  df["tile_id"] = 
+00010c60: 7469 6c65 5f69 640a 0a20 2020 2069 6620  tile_id..    if 
+00010c70: 6772 6964 7369 7a65 2021 3d20 302e 303a  gridsize != 0.0:
+00010c80: 0a20 2020 2020 2020 2064 6973 735f 6764  .        diss_gd
+00010c90: 662e 6765 6f6d 6574 7279 203d 2073 6861  f.geometry = sha
+00010ca0: 7065 6c79 325f 6f72 5f70 7967 656f 732e  pely2_or_pygeos.
+00010cb0: 7365 745f 7072 6563 6973 696f 6e28 0a20  set_precision(. 
+00010cc0: 2020 2020 2020 2020 2020 2064 6973 735f             diss_
+00010cd0: 6764 662e 6765 6f6d 6574 7279 2e61 7272  gdf.geometry.arr
+00010ce0: 6179 2e64 6174 612c 2067 7269 645f 7369  ay.data, grid_si
+00010cf0: 7a65 3d67 7269 6473 697a 650a 2020 2020  ze=gridsize.    
+00010d00: 2020 2020 290a 0a20 2020 2023 2053 6176      )..    # Sav
+00010d10: 6520 7468 6520 7265 7375 6c74 2074 6f20  e the result to 
+00010d20: 6465 7374 696e 6174 696f 6e20 6669 6c65  destination file
+00010d30: 2873 290a 2020 2020 7374 6172 745f 746f  (s).    start_to
+00010d40: 5f66 696c 6520 3d20 6461 7465 7469 6d65  _file = datetime
+00010d50: 2e6e 6f77 2829 0a0a 2020 2020 2320 4966  .now()..    # If
+00010d60: 2074 6865 2074 696c 6573 2064 6f6e 2774   the tiles don't
+00010d70: 206e 6565 6420 746f 2062 6520 6d65 7267   need to be merg
+00010d80: 6564 2061 6674 6572 7761 7264 732c 2077  ed afterwards, w
+00010d90: 6520 6361 6e20 6a75 7374 2073 6176 6520  e can just save 
+00010da0: 7468 6520 7265 7375 6c74 2061 730a 2020  the result as.  
+00010db0: 2020 2320 6974 2069 732e 0a20 2020 2069    # it is..    i
+00010dc0: 6620 7374 7228 6f75 7470 7574 5f6e 6f74  f str(output_not
+00010dd0: 6f6e 626f 7264 6572 5f70 6174 6829 203d  onborder_path) =
+00010de0: 3d20 7374 7228 6f75 7470 7574 5f6f 6e62  = str(output_onb
+00010df0: 6f72 6465 725f 7061 7468 293a 0a20 2020  order_path):.   
+00010e00: 2020 2020 2023 2061 7373 6572 7420 746f       # assert to
+00010e10: 2065 7661 6465 2070 794c 616e 6365 2077   evade pyLance w
+00010e20: 6172 6e69 6e67 0a20 2020 2020 2020 2061  arning.        a
+00010e30: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00010e40: 2864 6973 735f 6764 662c 2067 7064 2e47  (diss_gdf, gpd.G
+00010e50: 656f 4461 7461 4672 616d 6529 0a20 2020  eoDataFrame).   
+00010e60: 2020 2020 2023 2055 7365 2066 6f72 6365       # Use force
+00010e70: 5f6d 756c 7469 7479 7065 2c20 746f 2065  _multitype, to e
+00010e80: 7661 6465 2077 6172 6e69 6e67 7320 7768  vade warnings wh
+00010e90: 656e 2073 6f6d 6520 6261 7463 6865 7320  en some batches 
+00010ea0: 636f 6e74 6169 6e0a 2020 2020 2020 2020  contain.        
+00010eb0: 2320 7369 6e67 6c65 7479 7065 2061 6e64  # singletype and
+00010ec0: 2073 6f6d 6520 636f 6e74 6169 6e20 6d75   some contain mu
+00010ed0: 6c74 6974 7970 6520 6765 6f6d 6574 7269  ltitype geometri
+00010ee0: 6573 0a20 2020 2020 2020 2067 666f 2e74  es.        gfo.t
+00010ef0: 6f5f 6669 6c65 280a 2020 2020 2020 2020  o_file(.        
+00010f00: 2020 2020 6469 7373 5f67 6466 2c0a 2020      diss_gdf,.  
+00010f10: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00010f20: 5f6e 6f74 6f6e 626f 7264 6572 5f70 6174  _notonborder_pat
+00010f30: 682c 0a20 2020 2020 2020 2020 2020 206c  h,.            l
+00010f40: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
+00010f50: 722c 0a20 2020 2020 2020 2020 2020 2066  r,.            f
+00010f60: 6f72 6365 5f6d 756c 7469 7479 7065 3d54  orce_multitype=T
+00010f70: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00010f80: 2069 6e64 6578 3d46 616c 7365 2c0a 2020   index=False,.  
+00010f90: 2020 2020 2020 2020 2020 6372 6561 7465            create
+00010fa0: 5f73 7061 7469 616c 5f69 6e64 6578 3d46  _spatial_index=F
+00010fb0: 616c 7365 2c0a 2020 2020 2020 2020 290a  alse,.        ).
+00010fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010fd0: 2020 2320 4966 206e 6f74 2c20 7361 7665    # If not, save
+00010fe0: 2074 6865 2070 6f6c 7967 6f6e 7320 6f6e   the polygons on
+00010ff0: 2074 6865 2062 6f72 6465 7220 7365 7065   the border sepe
+00011000: 7261 7465 6c79 0a20 2020 2020 2020 2062  rately.        b
+00011010: 626f 785f 6c69 6e65 735f 6764 6620 3d20  box_lines_gdf = 
+00011020: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00011030: 280a 2020 2020 2020 2020 2020 2020 6765  (.            ge
+00011040: 6f6d 6574 7279 3d67 656f 7365 7269 6573  ometry=geoseries
+00011050: 5f75 7469 6c2e 706f 6c79 676f 6e73 5f74  _util.polygons_t
+00011060: 6f5f 6c69 6e65 7328 2020 2320 7479 7065  o_lines(  # type
+00011070: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00011080: 2020 2020 2020 2020 2067 7064 2e47 656f           gpd.Geo
+00011090: 5365 7269 6573 285b 7368 5f67 656f 6d2e  Series([sh_geom.
+000110a0: 626f 7828 6262 6f78 5b30 5d2c 2062 626f  box(bbox[0], bbo
+000110b0: 785b 315d 2c20 6262 6f78 5b32 5d2c 2062  x[1], bbox[2], b
+000110c0: 626f 785b 335d 295d 290a 2020 2020 2020  box[3])]).      
+000110d0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+000110e0: 2020 2020 2063 7273 3d69 6e70 7574 5f67       crs=input_g
+000110f0: 6466 2e63 7273 2c20 2023 2074 7970 653a  df.crs,  # type:
+00011100: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00011110: 290a 2020 2020 2020 2020 6f6e 626f 7264  ).        onbord
+00011120: 6572 5f67 6466 203d 2067 7064 2e73 6a6f  er_gdf = gpd.sjo
+00011130: 696e 2864 6973 735f 6764 662c 2062 626f  in(diss_gdf, bbo
+00011140: 785f 6c69 6e65 735f 6764 662c 2070 7265  x_lines_gdf, pre
+00011150: 6469 6361 7465 3d22 696e 7465 7273 6563  dicate="intersec
+00011160: 7473 2229 0a20 2020 2020 2020 206f 6e62  ts").        onb
+00011170: 6f72 6465 725f 6764 662e 6472 6f70 2822  order_gdf.drop("
+00011180: 696e 6465 785f 7269 6768 7422 2c20 6178  index_right", ax
+00011190: 6973 3d31 2c20 696e 706c 6163 653d 5472  is=1, inplace=Tr
+000111a0: 7565 290a 2020 2020 2020 2020 6966 206c  ue).        if l
+000111b0: 656e 286f 6e62 6f72 6465 725f 6764 6629  en(onborder_gdf)
+000111c0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+000111d0: 2020 2320 6173 7365 7274 2074 6f20 6576    # assert to ev
+000111e0: 6164 6520 7079 4c61 6e63 6520 7761 726e  ade pyLance warn
+000111f0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00011200: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00011210: 6528 6f6e 626f 7264 6572 5f67 6466 2c20  e(onborder_gdf, 
+00011220: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00011230: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00011240: 5573 6520 666f 7263 655f 6d75 6c74 6974  Use force_multit
+00011250: 7970 652c 2074 6f20 6576 6164 6520 7761  ype, to evade wa
+00011260: 726e 696e 6773 2077 6865 6e20 736f 6d65  rnings when some
+00011270: 2062 6174 6368 6573 2063 6f6e 7461 696e   batches contain
+00011280: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00011290: 696e 676c 6574 7970 6520 616e 6420 736f  ingletype and so
+000112a0: 6d65 2063 6f6e 7461 696e 206d 756c 7469  me contain multi
+000112b0: 7479 7065 2067 656f 6d65 7472 6965 730a  type geometries.
+000112c0: 2020 2020 2020 2020 2020 2020 6766 6f2e              gfo.
+000112d0: 746f 5f66 696c 6528 0a20 2020 2020 2020  to_file(.       
+000112e0: 2020 2020 2020 2020 206f 6e62 6f72 6465           onborde
+000112f0: 725f 6764 662c 0a20 2020 2020 2020 2020  r_gdf,.         
+00011300: 2020 2020 2020 206f 7574 7075 745f 6f6e         output_on
+00011310: 626f 7264 6572 5f70 6174 682c 0a20 2020  border_path,.   
+00011320: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+00011330: 6572 3d6f 7574 7075 745f 6c61 7965 722c  er=output_layer,
+00011340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011350: 2066 6f72 6365 5f6d 756c 7469 7479 7065   force_multitype
+00011360: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00011370: 2020 2020 2020 2063 7265 6174 655f 7370         create_sp
+00011380: 6174 6961 6c5f 696e 6465 783d 4661 6c73  atial_index=Fals
+00011390: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+000113a0: 0a0a 2020 2020 2020 2020 6e6f 746f 6e62  ..        notonb
+000113b0: 6f72 6465 725f 6764 6620 3d20 6469 7373  order_gdf = diss
+000113c0: 5f67 6466 5b7e 6469 7373 5f67 6466 2e69  _gdf[~diss_gdf.i
+000113d0: 6e64 6578 2e69 7369 6e28 6f6e 626f 7264  ndex.isin(onbord
+000113e0: 6572 5f67 6466 2e69 6e64 6578 295d 0a20  er_gdf.index)]. 
+000113f0: 2020 2020 2020 2069 6620 6c65 6e28 6e6f         if len(no
+00011400: 746f 6e62 6f72 6465 725f 6764 6629 203e  tonborder_gdf) >
+00011410: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00011420: 2320 6173 7365 7274 2074 6f20 6576 6164  # assert to evad
+00011430: 6520 7079 4c61 6e63 6520 7761 726e 696e  e pyLance warnin
+00011440: 670a 2020 2020 2020 2020 2020 2020 6173  g.            as
+00011450: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00011460: 6e6f 746f 6e62 6f72 6465 725f 6764 662c  notonborder_gdf,
+00011470: 2067 7064 2e47 656f 4461 7461 4672 616d   gpd.GeoDataFram
+00011480: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
+00011490: 2055 7365 2066 6f72 6365 5f6d 756c 7469   Use force_multi
+000114a0: 7479 7065 2c20 746f 2065 7661 6465 2077  type, to evade w
+000114b0: 6172 6e69 6e67 7320 7768 656e 2073 6f6d  arnings when som
+000114c0: 6520 6261 7463 6865 7320 636f 6e74 6169  e batches contai
+000114d0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+000114e0: 7369 6e67 6c65 7479 7065 2061 6e64 2073  singletype and s
+000114f0: 6f6d 6520 636f 6e74 6169 6e20 6d75 6c74  ome contain mult
+00011500: 6974 7970 6520 6765 6f6d 6574 7269 6573  itype geometries
+00011510: 0a20 2020 2020 2020 2020 2020 2067 666f  .            gfo
+00011520: 2e74 6f5f 6669 6c65 280a 2020 2020 2020  .to_file(.      
+00011530: 2020 2020 2020 2020 2020 6e6f 746f 6e62            notonb
+00011540: 6f72 6465 725f 6764 662c 0a20 2020 2020  order_gdf,.     
+00011550: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00011560: 745f 6e6f 746f 6e62 6f72 6465 725f 7061  t_notonborder_pa
+00011570: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00011580: 2020 2020 6c61 7965 723d 6f75 7470 7574      layer=output
+00011590: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
+000115a0: 2020 2020 2020 2020 666f 7263 655f 6d75          force_mu
+000115b0: 6c74 6974 7970 653d 5472 7565 2c0a 2020  ltitype=True,.  
+000115c0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000115d0: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
+000115e0: 2020 2020 2020 2020 2020 2063 7265 6174             creat
+000115f0: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
+00011600: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00011610: 2020 2029 0a20 2020 2070 6572 6669 6e66     ).    perfinf
+00011620: 6f5b 2274 696d 655f 746f 5f66 696c 6522  o["time_to_file"
+00011630: 5d20 3d20 2864 6174 6574 696d 652e 6e6f  ] = (datetime.no
+00011640: 7728 2920 2d20 7374 6172 745f 746f 5f66  w() - start_to_f
+00011650: 696c 6529 2e74 6f74 616c 5f73 6563 6f6e  ile).total_secon
+00011660: 6473 2829 0a0a 2020 2020 2320 4669 6e61  ds()..    # Fina
+00011670: 6c69 7365 2e2e 2e0a 2020 2020 6d65 7373  lise....    mess
+00011680: 6167 6520 3d20 6622 6469 7373 6f6c 7665  age = f"dissolve
+00011690: 2072 6561 6479 2069 6e20 7b64 6174 6574   ready in {datet
+000116a0: 696d 652e 6e6f 7728 292d 7374 6172 745f  ime.now()-start_
+000116b0: 7469 6d65 7d20 6f6e 207b 696e 7075 745f  time} on {input_
+000116c0: 7061 7468 7d21 220a 2020 2020 6c6f 6767  path}!".    logg
+000116d0: 6572 2e64 6562 7567 286d 6573 7361 6765  er.debug(message
+000116e0: 290a 0a20 2020 2023 2043 6f6c 6c65 6374  )..    # Collect
+000116f0: 2070 6572 6669 6e66 6f0a 2020 2020 746f   perfinfo.    to
+00011700: 7461 6c5f 7065 7266 5f74 696d 6520 3d20  tal_perf_time = 
+00011710: 300a 2020 2020 7065 7266 7374 7269 6e67  0.    perfstring
+00011720: 203d 2022 220a 2020 2020 666f 7220 7065   = "".    for pe
+00011730: 7266 636f 6465 2069 6e20 7065 7266 696e  rfcode in perfin
+00011740: 666f 3a0a 2020 2020 2020 2020 746f 7461  fo:.        tota
+00011750: 6c5f 7065 7266 5f74 696d 6520 2b3d 2070  l_perf_time += p
+00011760: 6572 6669 6e66 6f5b 7065 7266 636f 6465  erfinfo[perfcode
+00011770: 5d0a 2020 2020 2020 2020 7065 7266 7374  ].        perfst
+00011780: 7269 6e67 202b 3d20 6622 7b70 6572 6663  ring += f"{perfc
+00011790: 6f64 657d 3a20 7b70 6572 6669 6e66 6f5b  ode}: {perfinfo[
+000117a0: 7065 7266 636f 6465 5d3a 2e32 667d 2c20  perfcode]:.2f}, 
+000117b0: 220a 2020 2020 7265 7475 726e 5f69 6e66  ".    return_inf
+000117c0: 6f5b 2274 6f74 616c 5f74 696d 6522 5d20  o["total_time"] 
+000117d0: 3d20 2864 6174 6574 696d 652e 6e6f 7728  = (datetime.now(
+000117e0: 2920 2d20 7374 6172 745f 7469 6d65 292e  ) - start_time).
+000117f0: 746f 7461 6c5f 7365 636f 6e64 7328 290a  total_seconds().
+00011800: 2020 2020 7065 7266 696e 666f 5b22 756e      perfinfo["un
+00011810: 6163 636f 756e 7465 6422 5d20 3d20 7265  accounted"] = re
+00011820: 7475 726e 5f69 6e66 6f5b 2274 6f74 616c  turn_info["total
+00011830: 5f74 696d 6522 5d20 2d20 746f 7461 6c5f  _time"] - total_
+00011840: 7065 7266 5f74 696d 650a 2020 2020 7065  perf_time.    pe
+00011850: 7266 7374 7269 6e67 202b 3d20 6622 756e  rfstring += f"un
+00011860: 6163 636f 756e 7465 643a 207b 7065 7266  accounted: {perf
+00011870: 696e 666f 5b27 756e 6163 636f 756e 7465  info['unaccounte
+00011880: 6427 5d3a 2e32 667d 220a 0a20 2020 2023  d']:.2f}"..    #
+00011890: 2052 6574 7572 6e0a 2020 2020 7265 7475   Return.    retu
+000118a0: 726e 5f69 6e66 6f5b 2270 6572 6669 6e66  rn_info["perfinf
+000118b0: 6f22 5d20 3d20 7065 7266 696e 666f 0a20  o"] = perfinfo. 
+000118c0: 2020 2072 6574 7572 6e5f 696e 666f 5b22     return_info["
+000118d0: 7065 7266 7374 7269 6e67 225d 203d 2070  perfstring"] = p
+000118e0: 6572 6673 7472 696e 670a 2020 2020 7265  erfstring.    re
+000118f0: 7475 726e 5f69 6e66 6f5b 226d 6573 7361  turn_info["messa
+00011900: 6765 225d 203d 206d 6573 7361 6765 0a20  ge"] = message. 
+00011910: 2020 2072 6574 7572 6e20 7265 7475 726e     return return
+00011920: 5f69 6e66 6f0a 0a0a 6465 6620 5f64 6973  _info...def _dis
+00011930: 736f 6c76 6528 0a20 2020 2064 663a 2067  solve(.    df: g
+00011940: 7064 2e47 656f 4461 7461 4672 616d 652c  pd.GeoDataFrame,
+00011950: 0a20 2020 2062 793d 4e6f 6e65 2c0a 2020  .    by=None,.  
+00011960: 2020 6167 6766 756e 633a 204f 7074 696f    aggfunc: Optio
+00011970: 6e61 6c5b 556e 696f 6e5b 7374 722c 2064  nal[Union[str, d
+00011980: 6963 745d 5d20 3d20 2266 6972 7374 222c  ict]] = "first",
+00011990: 0a20 2020 2061 735f 696e 6465 783d 5472  .    as_index=Tr
+000119a0: 7565 2c0a 2020 2020 6c65 7665 6c3d 4e6f  ue,.    level=No
+000119b0: 6e65 2c0a 2020 2020 736f 7274 3d54 7275  ne,.    sort=Tru
+000119c0: 652c 0a20 2020 206f 6273 6572 7665 643d  e,.    observed=
+000119d0: 4661 6c73 652c 0a20 2020 2064 726f 706e  False,.    dropn
+000119e0: 613d 5472 7565 2c0a 2920 2d3e 2067 7064  a=True,.) -> gpd
+000119f0: 2e47 656f 4461 7461 4672 616d 653a 0a20  .GeoDataFrame:. 
+00011a00: 2020 2022 2222 0a20 2020 2044 6973 736f     """.    Disso
+00011a10: 6c76 6520 6765 6f6d 6574 7269 6573 2077  lve geometries w
+00011a20: 6974 6869 6e20 6067 726f 7570 6279 6020  ithin `groupby` 
+00011a30: 696e 746f 2073 696e 676c 6520 6f62 7365  into single obse
+00011a40: 7276 6174 696f 6e2e 0a20 2020 2054 6869  rvation..    Thi
+00011a50: 7320 6973 2061 6363 6f6d 706c 6973 6865  s is accomplishe
+00011a60: 6420 6279 2061 7070 6c79 696e 6720 7468  d by applying th
+00011a70: 6520 6075 6e61 7279 5f75 6e69 6f6e 6020  e `unary_union` 
+00011a80: 6d65 7468 6f64 0a20 2020 2074 6f20 616c  method.    to al
+00011a90: 6c20 6765 6f6d 6574 7269 6573 2077 6974  l geometries wit
+00011aa0: 6869 6e20 6120 6772 6f75 7073 656c 662e  hin a groupself.
+00011ab0: 0a20 2020 204f 6273 6572 7661 7469 6f6e  .    Observation
+00011ac0: 7320 6173 736f 6369 6174 6564 2077 6974  s associated wit
+00011ad0: 6820 6561 6368 2060 6772 6f75 7062 7960  h each `groupby`
+00011ae0: 2067 726f 7570 2077 696c 6c20 6265 2061   group will be a
+00011af0: 6767 7265 6761 7465 640a 2020 2020 7573  ggregated.    us
+00011b00: 696e 6720 7468 6520 6061 6767 6675 6e63  ing the `aggfunc
+00011b10: 602e 0a20 2020 2050 6172 616d 6574 6572  `..    Parameter
+00011b20: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00011b30: 0a20 2020 2062 7920 3a20 7374 7269 6e67  .    by : string
+00011b40: 2c20 6465 6661 756c 7420 4e6f 6e65 0a20  , default None. 
+00011b50: 2020 2020 2020 2043 6f6c 756d 6e20 7768         Column wh
+00011b60: 6f73 6520 7661 6c75 6573 2064 6566 696e  ose values defin
+00011b70: 6520 6772 6f75 7073 2074 6f20 6265 2064  e groups to be d
+00011b80: 6973 736f 6c76 6564 2e20 4966 204e 6f6e  issolved. If Non
+00011b90: 652c 0a20 2020 2020 2020 2077 686f 6c65  e,.        whole
+00011ba0: 2047 656f 4461 7461 4672 616d 6520 6973   GeoDataFrame is
+00011bb0: 2063 6f6e 7369 6465 7265 6420 6120 7369   considered a si
+00011bc0: 6e67 6c65 2067 726f 7570 2e0a 2020 2020  ngle group..    
+00011bd0: 6167 6766 756e 6320 3a20 6675 6e63 7469  aggfunc : functi
+00011be0: 6f6e 2c20 7374 7269 6e67 206f 7220 6469  on, string or di
+00011bf0: 6374 2c20 6465 6661 756c 7420 2266 6972  ct, default "fir
+00011c00: 7374 220a 2020 2020 2020 2020 4167 6772  st".        Aggr
+00011c10: 6567 6174 696f 6e20 6675 6e63 7469 6f6e  egation function
+00011c20: 2066 6f72 206d 616e 6970 756c 6174 696f   for manipulatio
+00011c30: 6e20 6f66 2064 6174 6120 6173 736f 6369  n of data associ
+00011c40: 6174 6564 0a20 2020 2020 2020 2077 6974  ated.        wit
+00011c50: 6820 6561 6368 2067 726f 7570 2e20 5061  h each group. Pa
+00011c60: 7373 6564 2074 6f20 7061 6e64 6173 2060  ssed to pandas `
+00011c70: 6772 6f75 7062 792e 6167 6760 206d 6574  groupby.agg` met
+00011c80: 686f 642e 0a20 2020 2061 735f 696e 6465  hod..    as_inde
+00011c90: 7820 3a20 626f 6f6c 6561 6e2c 2064 6566  x : boolean, def
+00011ca0: 6175 6c74 2054 7275 650a 2020 2020 2020  ault True.      
+00011cb0: 2020 4966 2074 7275 652c 2067 726f 7570    If true, group
+00011cc0: 6279 2063 6f6c 756d 6e73 2062 6563 6f6d  by columns becom
+00011cd0: 6520 696e 6465 7820 6f66 2072 6573 756c  e index of resul
+00011ce0: 742e 0a20 2020 206c 6576 656c 203a 2069  t..    level : i
+00011cf0: 6e74 206f 7220 7374 7220 6f72 2073 6571  nt or str or seq
+00011d00: 7565 6e63 6520 6f66 2069 6e74 206f 7220  uence of int or 
+00011d10: 7365 7175 656e 6365 206f 6620 7374 722c  sequence of str,
+00011d20: 2064 6566 6175 6c74 204e 6f6e 650a 2020   default None.  
+00011d30: 2020 2020 2020 4966 2074 6865 2061 7869        If the axi
+00011d40: 7320 6973 2061 204d 756c 7469 496e 6465  s is a MultiInde
+00011d50: 7820 2868 6965 7261 7263 6869 6361 6c29  x (hierarchical)
+00011d60: 2c20 6772 6f75 7020 6279 2061 0a20 2020  , group by a.   
+00011d70: 2020 2020 2070 6172 7469 6375 6c61 7220       particular 
+00011d80: 6c65 7665 6c20 6f72 206c 6576 656c 732e  level or levels.
+00011d90: 0a20 2020 2020 2020 202e 2e20 7665 7273  .        .. vers
+00011da0: 696f 6e61 6464 6564 3a3a 2030 2e39 2e30  ionadded:: 0.9.0
+00011db0: 0a20 2020 2073 6f72 7420 3a20 626f 6f6c  .    sort : bool
+00011dc0: 2c20 6465 6661 756c 7420 5472 7565 0a20  , default True. 
+00011dd0: 2020 2020 2020 2053 6f72 7420 6772 6f75         Sort grou
+00011de0: 7020 6b65 7973 2e20 4765 7420 6265 7474  p keys. Get bett
+00011df0: 6572 2070 6572 666f 726d 616e 6365 2062  er performance b
+00011e00: 7920 7475 726e 696e 6720 7468 6973 206f  y turning this o
+00011e10: 6666 2e0a 2020 2020 2020 2020 4e6f 7465  ff..        Note
+00011e20: 2074 6869 7320 646f 6573 206e 6f74 2069   this does not i
+00011e30: 6e66 6c75 656e 6365 2074 6865 206f 7264  nfluence the ord
+00011e40: 6572 206f 6620 6f62 7365 7276 6174 696f  er of observatio
+00011e50: 6e73 2077 6974 6869 6e0a 2020 2020 2020  ns within.      
+00011e60: 2020 6561 6368 2067 726f 7570 2e20 4772    each group. Gr
+00011e70: 6f75 7062 7920 7072 6573 6572 7665 7320  oupby preserves 
+00011e80: 7468 6520 6f72 6465 7220 6f66 2072 6f77  the order of row
+00011e90: 7320 7769 7468 696e 2065 6163 6820 6772  s within each gr
+00011ea0: 6f75 702e 0a20 2020 2020 2020 202e 2e20  oup..        .. 
+00011eb0: 7665 7273 696f 6e61 6464 6564 3a3a 2030  versionadded:: 0
+00011ec0: 2e39 2e30 0a20 2020 206f 6273 6572 7665  .9.0.    observe
+00011ed0: 6420 3a20 626f 6f6c 2c20 6465 6661 756c  d : bool, defaul
+00011ee0: 7420 4661 6c73 650a 2020 2020 2020 2020  t False.        
+00011ef0: 5468 6973 206f 6e6c 7920 6170 706c 6965  This only applie
+00011f00: 7320 6966 2061 6e79 206f 6620 7468 6520  s if any of the 
+00011f10: 6772 6f75 7065 7273 2061 7265 2043 6174  groupers are Cat
+00011f20: 6567 6f72 6963 616c 732e 0a20 2020 2020  egoricals..     
+00011f30: 2020 2049 6620 5472 7565 3a20 6f6e 6c79     If True: only
+00011f40: 2073 686f 7720 6f62 7365 7276 6564 2076   show observed v
+00011f50: 616c 7565 7320 666f 7220 6361 7465 676f  alues for catego
+00011f60: 7269 6361 6c20 6772 6f75 7065 7273 2e0a  rical groupers..
+00011f70: 2020 2020 2020 2020 4966 2046 616c 7365          If False
+00011f80: 3a20 7368 6f77 2061 6c6c 2076 616c 7565  : show all value
+00011f90: 7320 666f 7220 6361 7465 676f 7269 6361  s for categorica
+00011fa0: 6c20 6772 6f75 7065 7273 2e0a 2020 2020  l groupers..    
+00011fb0: 2020 2020 2e2e 2076 6572 7369 6f6e 6164      .. versionad
+00011fc0: 6465 643a 3a20 302e 392e 300a 2020 2020  ded:: 0.9.0.    
+00011fd0: 6472 6f70 6e61 203a 2062 6f6f 6c2c 2064  dropna : bool, d
+00011fe0: 6566 6175 6c74 2054 7275 650a 2020 2020  efault True.    
+00011ff0: 2020 2020 4966 2054 7275 652c 2061 6e64      If True, and
+00012000: 2069 6620 6772 6f75 7020 6b65 7973 2063   if group keys c
+00012010: 6f6e 7461 696e 204e 4120 7661 6c75 6573  ontain NA values
+00012020: 2c20 4e41 2076 616c 7565 730a 2020 2020  , NA values.    
+00012030: 2020 2020 746f 6765 7468 6572 2077 6974      together wit
+00012040: 6820 726f 772f 636f 6c75 6d6e 2077 696c  h row/column wil
+00012050: 6c20 6265 2064 726f 7070 6564 2e20 4966  l be dropped. If
+00012060: 2046 616c 7365 2c20 4e41 0a20 2020 2020   False, NA.     
+00012070: 2020 2076 616c 7565 7320 7769 6c6c 2061     values will a
+00012080: 6c73 6f20 6265 2074 7265 6174 6564 2061  lso be treated a
+00012090: 7320 7468 6520 6b65 7920 696e 2067 726f  s the key in gro
+000120a0: 7570 732e 0a20 2020 2020 2020 2054 6869  ups..        Thi
+000120b0: 7320 7061 7261 6d65 7465 7220 6973 206e  s parameter is n
+000120c0: 6f74 2073 7570 706f 7274 6564 2066 6f72  ot supported for
+000120d0: 2070 616e 6461 7320 3c20 312e 312e 302e   pandas < 1.1.0.
+000120e0: 0a20 2020 2020 2020 2041 2077 6172 6e69  .        A warni
+000120f0: 6e67 2077 696c 6c20 6265 2065 6d69 7474  ng will be emitt
+00012100: 6564 2066 6f72 2065 6172 6c69 6572 2070  ed for earlier p
+00012110: 616e 6461 7320 7665 7273 696f 6e73 0a20  andas versions. 
+00012120: 2020 2020 2020 2069 6620 6120 6e6f 6e2d         if a non-
+00012130: 6465 6661 756c 7420 7661 6c75 6520 6973  default value is
+00012140: 2067 6976 656e 2066 6f72 2074 6869 7320   given for this 
+00012150: 7061 7261 6d65 7465 722e 0a20 2020 2020  parameter..     
+00012160: 2020 202e 2e20 7665 7273 696f 6e61 6464     .. versionadd
+00012170: 6564 3a3a 2030 2e39 2e30 0a20 2020 2052  ed:: 0.9.0.    R
+00012180: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+00012190: 2d2d 0a20 2020 2047 656f 4461 7461 4672  --.    GeoDataFr
+000121a0: 616d 650a 2020 2020 4578 616d 706c 6573  ame.    Examples
+000121b0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a 2020  .    --------.  
+000121c0: 2020 3e3e 3e20 6672 6f6d 2073 6861 7065    >>> from shape
+000121d0: 6c79 2e67 656f 6d65 7472 7920 696d 706f  ly.geometry impo
+000121e0: 7274 2050 6f69 6e74 0a20 2020 203e 3e3e  rt Point.    >>>
+000121f0: 2064 203d 207b 0a20 2020 202e 2e2e 2020   d = {.    ...  
+00012200: 2020 2022 636f 6c31 223a 205b 226e 616d     "col1": ["nam
+00012210: 6531 222c 2022 6e61 6d65 3222 2c20 226e  e1", "name2", "n
+00012220: 616d 6531 225d 2c0a 2020 2020 2e2e 2e20  ame1"],.    ... 
+00012230: 2020 2020 2267 656f 6d65 7472 7922 3a20      "geometry": 
+00012240: 5b50 6f69 6e74 2831 2c20 3229 2c20 506f  [Point(1, 2), Po
+00012250: 696e 7428 322c 2031 292c 2050 6f69 6e74  int(2, 1), Point
+00012260: 2830 2c20 3129 5d2c 0a20 2020 202e 2e2e  (0, 1)],.    ...
+00012270: 207d 0a20 2020 203e 3e3e 2067 6466 203d   }.    >>> gdf =
+00012280: 2067 656f 7061 6e64 6173 2e47 656f 4461   geopandas.GeoDa
+00012290: 7461 4672 616d 6528 642c 2063 7273 3d34  taFrame(d, crs=4
+000122a0: 3332 3629 0a20 2020 203e 3e3e 2067 6466  326).    >>> gdf
+000122b0: 0a20 2020 2020 2020 2063 6f6c 3120 2020  .        col1   
+000122c0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
+000122d0: 6f6d 6574 7279 0a20 2020 2030 2020 6e61  ometry.    0  na
+000122e0: 6d65 3120 2050 4f49 4e54 2028 312e 3030  me1  POINT (1.00
+000122f0: 3030 3020 322e 3030 3030 3029 0a20 2020  000 2.00000).   
+00012300: 2031 2020 6e61 6d65 3220 2050 4f49 4e54   1  name2  POINT
+00012310: 2028 322e 3030 3030 3020 312e 3030 3030   (2.00000 1.0000
+00012320: 3029 0a20 2020 2032 2020 6e61 6d65 3120  0).    2  name1 
+00012330: 2050 4f49 4e54 2028 302e 3030 3030 3020   POINT (0.00000 
+00012340: 312e 3030 3030 3029 0a20 2020 203e 3e3e  1.00000).    >>>
+00012350: 2064 6973 736f 6c76 6564 203d 2067 6466   dissolved = gdf
+00012360: 2e64 6973 736f 6c76 6528 2763 6f6c 3127  .dissolve('col1'
+00012370: 290a 2020 2020 3e3e 3e20 6469 7373 6f6c  ).    >>> dissol
+00012380: 7665 6420 2023 2064 6f63 7465 7374 3a20  ved  # doctest: 
+00012390: 2b53 4b49 500a 2020 2020 2020 2020 2020  +SKIP.          
+000123a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123c0: 2020 2020 2020 6765 6f6d 6574 7279 0a20        geometry. 
+000123d0: 2020 2063 6f6c 310a 2020 2020 6e61 6d65     col1.    name
+000123e0: 3120 204d 554c 5449 504f 494e 5420 2830  1  MULTIPOINT (0
+000123f0: 2e30 3030 3030 2031 2e30 3030 3030 2c20  .00000 1.00000, 
+00012400: 312e 3030 3030 3020 322e 3030 3030 3029  1.00000 2.00000)
+00012410: 0a20 2020 206e 616d 6532 2020 2020 2020  .    name2      
+00012420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012430: 2020 504f 494e 5420 2832 2e30 3030 3030    POINT (2.00000
+00012440: 2031 2e30 3030 3030 290a 2020 2020 5365   1.00000).    Se
+00012450: 6520 616c 736f 0a20 2020 202d 2d2d 2d2d  e also.    -----
+00012460: 2d2d 2d0a 2020 2020 4765 6f44 6174 6146  ---.    GeoDataF
+00012470: 7261 6d65 2e65 7870 6c6f 6465 203a 2065  rame.explode : e
+00012480: 7870 6c6f 6465 206d 756c 7469 2d70 6172  xplode multi-par
+00012490: 7420 6765 6f6d 6574 7269 6573 2069 6e74  t geometries int
+000124a0: 6f20 7369 6e67 6c65 2067 656f 6d65 7472  o single geometr
+000124b0: 6965 730a 2020 2020 2222 220a 0a20 2020  ies.    """..   
+000124c0: 2069 6620 6279 2069 7320 4e6f 6e65 2061   if by is None a
+000124d0: 6e64 206c 6576 656c 2069 7320 4e6f 6e65  nd level is None
+000124e0: 3a0a 2020 2020 2020 2020 6279 5f6c 6f63  :.        by_loc
+000124f0: 616c 203d 206e 702e 7a65 726f 7328 6c65  al = np.zeros(le
+00012500: 6e28 6466 292c 2064 7479 7065 3d22 696e  n(df), dtype="in
+00012510: 7436 3422 290a 2020 2020 656c 7365 3a0a  t64").    else:.
+00012520: 2020 2020 2020 2020 6279 5f6c 6f63 616c          by_local
+00012530: 203d 2062 790a 0a20 2020 2067 726f 7570   = by..    group
+00012540: 6279 5f6b 7761 7267 7320 3d20 6469 6374  by_kwargs = dict
+00012550: 280a 2020 2020 2020 2020 6279 3d62 795f  (.        by=by_
+00012560: 6c6f 6361 6c2c 206c 6576 656c 3d6c 6576  local, level=lev
+00012570: 656c 2c20 736f 7274 3d73 6f72 742c 206f  el, sort=sort, o
+00012580: 6273 6572 7665 643d 6f62 7365 7276 6564  bserved=observed
+00012590: 2c20 6472 6f70 6e61 3d64 726f 706e 610a  , dropna=dropna.
+000125a0: 2020 2020 290a 2020 2020 2222 220a 2020      ).    """.  
+000125b0: 2020 6966 206e 6f74 2063 6f6d 7061 742e    if not compat.
+000125c0: 5041 4e44 4153 5f47 455f 3131 3a0a 2020  PANDAS_GE_11:.  
+000125d0: 2020 2020 2020 6772 6f75 7062 795f 6b77        groupby_kw
+000125e0: 6172 6773 2e70 6f70 2822 6472 6f70 6e61  args.pop("dropna
+000125f0: 2229 0a0a 2020 2020 2020 2020 6966 206e  ")..        if n
+00012600: 6f74 2064 726f 706e 613a 2020 2320 4966  ot dropna:  # If
+00012610: 2074 6865 7920 7061 7373 6564 2061 206e   they passed a n
+00012620: 6f6e 2d64 6566 6175 6c74 2064 726f 706e  on-default dropn
+00012630: 6120 7661 6c75 650a 2020 2020 2020 2020  a value.        
+00012640: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00012650: 6e28 2264 726f 706e 6120 6b77 6172 6720  n("dropna kwarg 
+00012660: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+00012670: 2066 6f72 2070 616e 6461 7320 3c20 312e   for pandas < 1.
+00012680: 312e 3022 290a 2020 2020 2222 220a 0a20  1.0").    """.. 
+00012690: 2020 2023 2050 726f 6365 7373 206e 6f6e     # Process non
+000126a0: 2d73 7061 7469 616c 2063 6f6d 706f 6e65  -spatial compone
+000126b0: 6e74 0a20 2020 2064 6174 6120 3d20 7064  nt.    data = pd
+000126c0: 2e44 6174 6146 7261 6d65 2864 662e 6472  .DataFrame(df.dr
+000126d0: 6f70 2863 6f6c 756d 6e73 3d64 662e 6765  op(columns=df.ge
+000126e0: 6f6d 6574 7279 2e6e 616d 6529 290a 0a20  ometry.name)).. 
+000126f0: 2020 2069 6620 6167 6766 756e 6320 6973     if aggfunc is
+00012700: 206e 6f74 204e 6f6e 6520 616e 6420 6973   not None and is
+00012710: 696e 7374 616e 6365 2861 6767 6675 6e63  instance(aggfunc
+00012720: 2c20 6469 6374 2920 616e 6420 2274 6f5f  , dict) and "to_
+00012730: 6a73 6f6e 2220 696e 2061 6767 6675 6e63  json" in aggfunc
+00012740: 3a0a 2020 2020 2020 2020 6167 675f 636f  :.        agg_co
+00012750: 6c75 6d6e 7320 3d20 6c69 7374 2873 6574  lumns = list(set
+00012760: 2861 6767 6675 6e63 5b22 746f 5f6a 736f  (aggfunc["to_jso
+00012770: 6e22 5d29 290a 2020 2020 2020 2020 6167  n"])).        ag
+00012780: 6772 6567 6174 6564 5f64 6174 6120 3d20  gregated_data = 
+00012790: 280a 2020 2020 2020 2020 2020 2020 6461  (.            da
+000127a0: 7461 2e67 726f 7570 6279 282a 2a67 726f  ta.groupby(**gro
+000127b0: 7570 6279 5f6b 7761 7267 7329 0a20 2020  upby_kwargs).   
+000127c0: 2020 2020 2020 2020 202e 6170 706c 7928           .apply(
+000127d0: 6c61 6d62 6461 2067 3a20 675b 6167 675f  lambda g: g[agg_
+000127e0: 636f 6c75 6d6e 735d 2e74 6f5f 6a73 6f6e  columns].to_json
+000127f0: 286f 7269 656e 743d 2272 6563 6f72 6473  (orient="records
+00012800: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00012810: 2e74 6f5f 6672 616d 6528 6e61 6d65 3d22  .to_frame(name="
+00012820: 5f5f 4449 5353 4f4c 5645 5f54 4f4a 534f  __DISSOLVE_TOJSO
+00012830: 4e22 290a 2020 2020 2020 2020 290a 2020  N").        ).  
+00012840: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00012850: 6528 6167 6766 756e 632c 2073 7472 2920  e(aggfunc, str) 
+00012860: 616e 6420 6167 6766 756e 6320 3d3d 2022  and aggfunc == "
+00012870: 6d65 7267 655f 6a73 6f6e 5f6c 6973 7473  merge_json_lists
+00012880: 223a 0a20 2020 2020 2020 2023 204d 6572  ":.        # Mer
+00012890: 6765 2061 6e64 2066 6c61 7474 656e 2074  ge and flatten t
+000128a0: 6865 206a 736f 6e20 6c69 7374 7320 696e  he json lists in
+000128b0: 2074 6865 2067 726f 7570 730a 2020 2020   the groups.    
+000128c0: 2020 2020 6465 6620 6772 6f75 705f 666c      def group_fl
+000128d0: 6174 7465 6e5f 6a73 6f6e 5f6c 6973 7428  atten_json_list(
+000128e0: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
+000128f0: 2320 4576 616c 7561 7465 2061 6c6c 2067  # Evaluate all g
+00012900: 726f 7570 6564 2072 6f77 7320 746f 206a  rouped rows to j
+00012910: 736f 6e20 6f62 6a65 6374 732e 2054 6869  son objects. Thi
+00012920: 7320 7265 7375 6c74 7320 696e 2061 206c  s results in a l
+00012930: 6973 7420 6f66 0a20 2020 2020 2020 2020  ist of.         
+00012940: 2020 2023 206c 6973 7473 206f 6620 6a73     # lists of js
+00012950: 6f6e 206f 626a 6563 7473 2e0a 2020 2020  on objects..    
+00012960: 2020 2020 2020 2020 6a73 6f6e 5f6e 6573          json_nes
+00012970: 7465 645f 6c69 7374 7320 3d20 5b0a 2020  ted_lists = [.  
+00012980: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00012990: 6f6e 2e6c 6f61 6473 286a 736f 6e5f 7661  on.loads(json_va
+000129a0: 6c75 6573 2920 666f 7220 6a73 6f6e 5f76  lues) for json_v
+000129b0: 616c 7565 7320 696e 2067 5b22 5f5f 4449  alues in g["__DI
+000129c0: 5353 4f4c 5645 5f54 4f4a 534f 4e22 5d0a  SSOLVE_TOJSON"].
+000129d0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+000129e0: 2020 2020 2020 2020 2020 2023 2045 7874             # Ext
+000129f0: 7261 6374 2074 6865 2072 6f77 7320 6672  ract the rows fr
+00012a00: 6f6d 2074 6865 206e 6573 7465 6420 6c69  om the nested li
+00012a10: 7374 7320 2b20 7075 7420 696e 2061 2066  sts + put in a f
+00012a20: 6c61 7420 6c69 7374 2061 7320 7374 7269  lat list as stri
+00012a30: 6e67 730a 2020 2020 2020 2020 2020 2020  ngs.            
+00012a40: 6a73 6f6e 7374 725f 666c 6174 203d 205b  jsonstr_flat = [
+00012a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012a60: 206a 736f 6e2e 6475 6d70 7328 6a73 6f6e   json.dumps(json
+00012a70: 5f76 616c 7565 290a 2020 2020 2020 2020  _value).        
+00012a80: 2020 2020 2020 2020 666f 7220 6a73 6f6e          for json
+00012a90: 5f76 616c 7565 7320 696e 206a 736f 6e5f  _values in json_
+00012aa0: 6e65 7374 6564 5f6c 6973 7473 0a20 2020  nested_lists.   
+00012ab0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00012ac0: 206a 736f 6e5f 7661 6c75 6520 696e 206a   json_value in j
+00012ad0: 736f 6e5f 7661 6c75 6573 0a20 2020 2020  son_values.     
+00012ae0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+00012af0: 2020 2020 2020 2320 5265 6d6f 7665 2064        # Remove d
+00012b00: 7570 6c69 6361 7465 730a 2020 2020 2020  uplicates.      
+00012b10: 2020 2020 2020 6a73 6f6e 7373 7472 5f64        jsonsstr_d
+00012b20: 6973 7469 6e63 7420 3d20 7365 7428 6a73  istinct = set(js
+00012b30: 6f6e 7374 725f 666c 6174 290a 0a20 2020  onstr_flat)..   
+00012b40: 2020 2020 2020 2020 2023 2043 6f6e 7665           # Conve
+00012b50: 7274 2074 6865 2064 6174 6120 6167 6169  rt the data agai
+00012b60: 6e20 746f 2061 206c 6973 7420 6f66 206a  n to a list of j
+00012b70: 736f 6e20 6f62 6a65 6374 730a 2020 2020  son objects.    
+00012b80: 2020 2020 2020 2020 6a73 6f6e 5f64 6973          json_dis
+00012b90: 7469 6e63 7420 3d20 5b6a 736f 6e2e 6c6f  tinct = [json.lo
+00012ba0: 6164 7328 6a73 6f6e 5f76 616c 7565 2920  ads(json_value) 
+00012bb0: 666f 7220 6a73 6f6e 5f76 616c 7565 2069  for json_value i
+00012bc0: 6e20 6a73 6f6e 7373 7472 5f64 6973 7469  n jsonsstr_disti
+00012bd0: 6e63 745d 0a0a 2020 2020 2020 2020 2020  nct]..          
+00012be0: 2020 2320 5265 7475 726e 2061 7320 6a73    # Return as js
+00012bf0: 6f6e 2073 7472 696e 670a 2020 2020 2020  on string.      
+00012c00: 2020 2020 2020 7265 7475 726e 206a 736f        return jso
+00012c10: 6e2e 6475 6d70 7328 6a73 6f6e 5f64 6973  n.dumps(json_dis
+00012c20: 7469 6e63 7429 0a0a 2020 2020 2020 2020  tinct)..        
+00012c30: 6167 6772 6567 6174 6564 5f64 6174 6120  aggregated_data 
+00012c40: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00012c50: 6461 7461 2e67 726f 7570 6279 282a 2a67  data.groupby(**g
+00012c60: 726f 7570 6279 5f6b 7761 7267 7329 0a20  roupby_kwargs). 
+00012c70: 2020 2020 2020 2020 2020 202e 6170 706c             .appl
+00012c80: 7928 6c61 6d62 6461 2067 3a20 6772 6f75  y(lambda g: grou
+00012c90: 705f 666c 6174 7465 6e5f 6a73 6f6e 5f6c  p_flatten_json_l
+00012ca0: 6973 7428 6729 290a 2020 2020 2020 2020  ist(g)).        
+00012cb0: 2020 2020 2e74 6f5f 6672 616d 6528 6e61      .to_frame(na
+00012cc0: 6d65 3d22 5f5f 4449 5353 4f4c 5645 5f54  me="__DISSOLVE_T
+00012cd0: 4f4a 534f 4e22 290a 2020 2020 2020 2020  OJSON").        
+00012ce0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00012cf0: 2020 2020 6167 6772 6567 6174 6564 5f64      aggregated_d
+00012d00: 6174 6120 3d20 6461 7461 2e67 726f 7570  ata = data.group
+00012d10: 6279 282a 2a67 726f 7570 6279 5f6b 7761  by(**groupby_kwa
+00012d20: 7267 7329 2e61 6767 2861 6767 6675 6e63  rgs).agg(aggfunc
+00012d30: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
+00012d40: 650a 2020 2020 2020 2020 2320 4368 6563  e.        # Chec
+00012d50: 6b20 6966 2061 6c6c 2063 6f6c 756d 6e73  k if all columns
+00012d60: 2077 6572 6520 7072 6f70 6572 6c79 2061   were properly a
+00012d70: 6767 7265 6761 7465 640a 2020 2020 2020  ggregated.      
+00012d80: 2020 6173 7365 7274 2062 795f 6c6f 6361    assert by_loca
+00012d90: 6c20 6973 206e 6f74 204e 6f6e 650a 2020  l is not None.  
+00012da0: 2020 2020 2020 636f 6c75 6d6e 735f 746f        columns_to
+00012db0: 5f61 6767 203d 205b 636f 6c75 6d6e 2066  _agg = [column f
+00012dc0: 6f72 2063 6f6c 756d 6e20 696e 2064 6174  or column in dat
+00012dd0: 612e 636f 6c75 6d6e 7320 6966 2063 6f6c  a.columns if col
+00012de0: 756d 6e20 6e6f 7420 696e 2062 795f 6c6f  umn not in by_lo
+00012df0: 6361 6c5d 0a20 2020 2020 2020 2069 6620  cal].        if 
+00012e00: 6c65 6e28 636f 6c75 6d6e 735f 746f 5f61  len(columns_to_a
+00012e10: 6767 2920 213d 206c 656e 2861 6767 7265  gg) != len(aggre
+00012e20: 6761 7465 645f 6461 7461 2e63 6f6c 756d  gated_data.colum
+00012e30: 6e73 293a 0a20 2020 2020 2020 2020 2020  ns):.           
+00012e40: 2064 726f 7070 6564 5f63 6f6c 756d 6e73   dropped_columns
+00012e50: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00012e60: 2020 2020 2063 6f6c 756d 6e0a 2020 2020       column.    
+00012e70: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00012e80: 636f 6c75 6d6e 2069 6e20 636f 6c75 6d6e  column in column
+00012e90: 735f 746f 5f61 6767 0a20 2020 2020 2020  s_to_agg.       
+00012ea0: 2020 2020 2020 2020 2069 6620 636f 6c75           if colu
+00012eb0: 6d6e 206e 6f74 2069 6e20 6167 6772 6567  mn not in aggreg
+00012ec0: 6174 6564 5f64 6174 612e 636f 6c75 6d6e  ated_data.column
+00012ed0: 730a 2020 2020 2020 2020 2020 2020 5d0a  s.            ].
+00012ee0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012ef0: 6520 4578 6365 7074 696f 6e28 0a20 2020  e Exception(.   
+00012f00: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+00012f10: 6f6c 756d 6e28 7329 207b 6472 6f70 7065  olumn(s) {droppe
+00012f20: 645f 636f 6c75 6d6e 737d 2061 7265 206e  d_columns} are n
+00012f30: 6f74 2073 7570 706f 7274 6564 2066 6f72  ot supported for
+00012f40: 2061 6767 7265 6761 7469 6f6e 2c20 7374   aggregation, st
+00012f50: 6f70 220a 2020 2020 2020 2020 2020 2020  op".            
+00012f60: 290a 0a20 2020 2023 2050 726f 6365 7373  )..    # Process
+00012f70: 2073 7061 7469 616c 2063 6f6d 706f 6e65   spatial compone
+00012f80: 6e74 0a20 2020 2064 6566 206d 6572 6765  nt.    def merge
+00012f90: 5f67 656f 6d65 7472 6965 7328 626c 6f63  _geometries(bloc
+00012fa0: 6b29 3a0a 2020 2020 2020 2020 6d65 7267  k):.        merg
+00012fb0: 6564 5f67 656f 6d20 3d20 626c 6f63 6b2e  ed_geom = block.
+00012fc0: 756e 6172 795f 756e 696f 6e0a 2020 2020  unary_union.    
+00012fd0: 2020 2020 7265 7475 726e 206d 6572 6765      return merge
+00012fe0: 645f 6765 6f6d 0a0a 2020 2020 6720 3d20  d_geom..    g = 
+00012ff0: 6466 2e67 726f 7570 6279 2867 726f 7570  df.groupby(group
+00013000: 5f6b 6579 733d 4661 6c73 652c 202a 2a67  _keys=False, **g
+00013010: 726f 7570 6279 5f6b 7761 7267 7329 5b64  roupby_kwargs)[d
+00013020: 662e 6765 6f6d 6574 7279 2e6e 616d 655d  f.geometry.name]
+00013030: 2e61 6767 280a 2020 2020 2020 2020 6d65  .agg(.        me
+00013040: 7267 655f 6765 6f6d 6574 7269 6573 0a20  rge_geometries. 
+00013050: 2020 2029 0a0a 2020 2020 2320 4167 6772     )..    # Aggr
+00013060: 6567 6174 650a 2020 2020 6167 6772 6567  egate.    aggreg
+00013070: 6174 6564 5f67 656f 6d65 7472 7920 3d20  ated_geometry = 
+00013080: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00013090: 280a 2020 2020 2020 2020 6461 7461 3d67  (.        data=g
+000130a0: 2c20 6765 6f6d 6574 7279 3d64 662e 6765  , geometry=df.ge
+000130b0: 6f6d 6574 7279 2e6e 616d 652c 2063 7273  ometry.name, crs
+000130c0: 3d64 662e 6372 7320 2023 2074 7970 653a  =df.crs  # type:
+000130d0: 2069 676e 6f72 650a 2020 2020 290a 2020   ignore.    ).  
+000130e0: 2020 2320 5265 636f 6d62 696e 650a 2020    # Recombine.  
+000130f0: 2020 6167 6772 6567 6174 6564 203d 2061    aggregated = a
+00013100: 6767 7265 6761 7465 645f 6765 6f6d 6574  ggregated_geomet
+00013110: 7279 2e6a 6f69 6e28 6167 6772 6567 6174  ry.join(aggregat
+00013120: 6564 5f64 6174 6129 0a0a 2020 2020 2320  ed_data)..    # 
+00013130: 5265 7365 7420 6966 2072 6571 7565 7374  Reset if request
+00013140: 6564 0a20 2020 2069 6620 6e6f 7420 6173  ed.    if not as
+00013150: 5f69 6e64 6578 3a0a 2020 2020 2020 2020  _index:.        
+00013160: 6167 6772 6567 6174 6564 203d 2061 6767  aggregated = agg
+00013170: 7265 6761 7465 642e 7265 7365 745f 696e  regated.reset_in
+00013180: 6465 7828 290a 0a20 2020 2023 204d 616b  dex()..    # Mak
+00013190: 6520 7375 7265 206f 7574 7075 7420 7479  e sure output ty
+000131a0: 7065 7320 6f66 2067 726f 7570 6564 2063  pes of grouped c
+000131b0: 6f6c 756d 6e73 2061 7265 2074 6865 2073  olumns are the s
+000131c0: 616d 6520 6173 2069 6e70 7574 2074 7970  ame as input typ
+000131d0: 6573 2e0a 2020 2020 2320 452e 672e 206f  es..    # E.g. o
+000131e0: 626a 6563 7420 636f 6c75 6d6e 7320 6265  bject columns be
+000131f0: 636f 6d65 2066 6c6f 6174 2069 6620 616c  come float if al
+00013200: 6c20 7661 6c75 6573 2061 7265 204e 6f6e  l values are Non
+00013210: 652e 0a20 2020 2069 6620 6279 2069 7320  e..    if by is 
+00013220: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00013230: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00013240: 6279 2c20 7374 7229 3a0a 2020 2020 2020  by, str):.      
+00013250: 2020 2020 2020 6966 2062 7920 696e 2061        if by in a
+00013260: 6767 7265 6761 7465 642e 636f 6c75 6d6e  ggregated.column
+00013270: 7320 616e 6420 6466 5b62 795d 2e64 7479  s and df[by].dty
+00013280: 7065 2021 3d20 6167 6772 6567 6174 6564  pe != aggregated
+00013290: 5b62 795d 2e64 7479 7065 3a0a 2020 2020  [by].dtype:.    
+000132a0: 2020 2020 2020 2020 2020 2020 6167 6772              aggr
+000132b0: 6567 6174 6564 5b62 795d 203d 2061 6767  egated[by] = agg
+000132c0: 7265 6761 7465 645b 6279 5d2e 6173 7479  regated[by].asty
+000132d0: 7065 2864 665b 6279 5d2e 6474 7970 6529  pe(df[by].dtype)
+000132e0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+000132f0: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00013300: 696e 7374 616e 6365 2862 792c 2049 7465  instance(by, Ite
+00013310: 7261 626c 6529 3a0a 2020 2020 2020 2020  rable):.        
+00013320: 2020 2020 666f 7220 636f 6c20 696e 2062      for col in b
+00013330: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00013340: 2020 2069 6620 636f 6c20 696e 2061 6767     if col in agg
+00013350: 7265 6761 7465 642e 636f 6c75 6d6e 7320  regated.columns 
+00013360: 616e 6420 6466 5b63 6f6c 5d2e 6474 7970  and df[col].dtyp
+00013370: 6520 213d 2061 6767 7265 6761 7465 645b  e != aggregated[
+00013380: 636f 6c5d 2e64 7479 7065 3a0a 2020 2020  col].dtype:.    
+00013390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000133a0: 6167 6772 6567 6174 6564 5b63 6f6c 5d20  aggregated[col] 
+000133b0: 3d20 6167 6772 6567 6174 6564 5b63 6f6c  = aggregated[col
+000133c0: 5d2e 6173 7479 7065 2864 665b 636f 6c5d  ].astype(df[col]
+000133d0: 2e64 7479 7065 290a 0a20 2020 2061 7373  .dtype)..    ass
+000133e0: 6572 7420 6973 696e 7374 616e 6365 2861  ert isinstance(a
+000133f0: 6767 7265 6761 7465 642c 2067 7064 2e47  ggregated, gpd.G
+00013400: 656f 4461 7461 4672 616d 6529 0a20 2020  eoDataFrame).   
+00013410: 2072 6574 7572 6e20 6167 6772 6567 6174   return aggregat
+00013420: 6564 0a0a 0a64 6566 205f 6164 645f 6f72  ed...def _add_or
+00013430: 6465 7262 795f 636f 6c75 6d6e 2870 6174  derby_column(pat
+00013440: 683a 2050 6174 682c 206c 6179 6572 3a20  h: Path, layer: 
+00013450: 7374 722c 206e 616d 653a 2073 7472 293a  str, name: str):
+00013460: 0a20 2020 2023 2050 7265 7061 7265 2074  .    # Prepare t
+00013470: 6865 2065 7870 7265 7373 696f 6e20 746f  he expression to
+00013480: 2063 616c 6375 6c61 7465 2074 6865 206f   calculate the o
+00013490: 7264 6572 6279 2063 6f6c 756d 6e2e 0a20  rderby column.. 
+000134a0: 2020 2023 2049 6e20 6120 7370 6174 6961     # In a spatia
+000134b0: 6c20 6669 6c65 2c20 6120 7370 6174 6961  l file, a spatia
+000134c0: 6c20 6f72 6465 7220 7769 6c6c 206d 616b  l order will mak
+000134d0: 6520 6c61 7465 7220 7573 6520 6d6f 7265  e later use more
+000134e0: 2065 6666 6963 69c3 ab6e 742c 0a20 2020   effici..nt,.   
+000134f0: 2023 2073 6f20 7573 6520 6120 6765 6f68   # so use a geoh
+00013500: 6173 682e 0a20 2020 206c 6179 6572 696e  ash..    layerin
+00013510: 666f 203d 2067 666f 2e67 6574 5f6c 6179  fo = gfo.get_lay
+00013520: 6572 696e 666f 2870 6174 6829 0a20 2020  erinfo(path).   
+00013530: 2069 6620 6c61 7965 7269 6e66 6f2e 6372   if layerinfo.cr
+00013540: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+00013550: 6420 6c61 7965 7269 6e66 6f2e 6372 732e  d layerinfo.crs.
+00013560: 6973 5f67 656f 6772 6170 6869 633a 0a20  is_geographic:. 
+00013570: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+00013580: 636f 6f72 6469 6e61 7465 7320 6172 6520  coordinates are 
+00013590: 6765 6f67 7261 7068 6963 2028 696e 206c  geographic (in l
+000135a0: 6174 2f6c 6f6e 2064 6567 7265 6573 292c  at/lon degrees),
+000135b0: 206f 6b0a 2020 2020 2020 2020 6578 7072   ok.        expr
+000135c0: 6573 7369 6f6e 203d 2066 2253 545f 4765  ession = f"ST_Ge
+000135d0: 6f48 6173 6828 7b6c 6179 6572 696e 666f  oHash({layerinfo
+000135e0: 2e67 656f 6d65 7472 7963 6f6c 756d 6e7d  .geometrycolumn}
+000135f0: 2c20 3130 2922 0a20 2020 2065 6c73 653a  , 10)".    else:
+00013600: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
+00013610: 6579 2061 7265 206e 6f74 2067 656f 6772  ey are not geogr
+00013620: 6170 6869 6320 2869 6e20 6c61 742f 6c6f  aphic (in lat/lo
+00013630: 6e20 6465 6772 6565 7329 2c20 7468 6579  n degrees), they
+00013640: 206e 6565 6420 746f 2062 650a 2020 2020   need to be.    
+00013650: 2020 2020 2320 636f 6e76 6572 7465 6420      # converted 
+00013660: 746f 207e 2064 6567 7265 6573 2074 6f20  to ~ degrees to 
+00013670: 6265 2061 626c 6520 746f 2063 616c 6375  be able to calcu
+00013680: 6c61 7465 2061 2067 656f 6861 7368 2e0a  late a geohash..
+00013690: 0a20 2020 2020 2020 2023 2050 726f 7065  .        # Prope
+000136a0: 726c 7920 6361 6c63 756c 6174 696e 6720  rly calculating 
+000136b0: 7468 6520 7472 616e 7366 6f72 6d61 7469  the transformati
+000136c0: 6f6e 2074 6f20 6567 2e20 5747 5320 6973  on to eg. WGS is
+000136d0: 2074 6572 7269 626c 7920 736c 6f77 2e2e   terribly slow..
+000136e0: 2e0a 2020 2020 2020 2020 2320 6578 7072  ..        # expr
+000136f0: 6573 7369 6f6e 203d 2066 2222 2253 545f  ession = f"""ST_
+00013700: 4765 6f48 6173 6828 5354 5f54 7261 6e73  GeoHash(ST_Trans
+00013710: 666f 726d 284d 616b 6550 6f69 6e74 280a  form(MakePoint(.
+00013720: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00013730: 284d 6272 4d61 7858 2867 656f 6d29 2b4d  (MbrMaxX(geom)+M
+00013740: 6272 4d69 6e58 2867 656f 6d29 292f 322c  brMinX(geom))/2,
+00013750: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+00013760: 2028 4d62 724d 696e 5928 6765 6f6d 292b   (MbrMinY(geom)+
+00013770: 4d62 724d 6178 5928 6765 6f6d 2929 2f32  MbrMaxY(geom))/2
+00013780: 2c20 5354 5f53 5249 4428 6765 6f6d 2929  , ST_SRID(geom))
+00013790: 2c20 3433 3236 292c 2031 3029 2222 220a  , 4326), 10)""".
+000137a0: 2020 2020 2020 2020 2320 536f 2c20 646f          # So, do
+000137b0: 2073 6f6d 6574 6869 6e67 2065 6c73 6520   something else 
+000137c0: 7468 6174 2773 2066 6173 7465 7220 616e  that's faster an
+000137d0: 6420 7374 696c 6c20 6769 7665 7320 6120  d still gives a 
+000137e0: 676f 6f64 0a20 2020 2020 2020 2023 2067  good.        # g
+000137f0: 656f 6772 6170 6869 6320 636c 7573 7465  eographic cluste
+00013800: 7269 6e67 2e0a 2020 2020 2020 2020 746f  ring..        to
+00013810: 5f67 656f 6772 6170 6869 635f 6661 6374  _geographic_fact
+00013820: 6f72 5f61 7070 726f 7820 3d20 3930 202f  or_approx = 90 /
+00013830: 206d 6178 286c 6179 6572 696e 666f 2e74   max(layerinfo.t
+00013840: 6f74 616c 5f62 6f75 6e64 7329 0a20 2020  otal_bounds).   
+00013850: 2020 2020 2065 7870 7265 7373 696f 6e20       expression 
+00013860: 3d20 6622 2222 5354 5f47 656f 4861 7368  = f"""ST_GeoHash
+00013870: 284d 616b 6550 6f69 6e74 280a 2020 2020  (MakePoint(.    
+00013880: 2020 2020 2020 2020 2020 2020 2828 4d62              ((Mb
+00013890: 724d 6178 5828 7b6c 6179 6572 696e 666f  rMaxX({layerinfo
+000138a0: 2e67 656f 6d65 7472 7963 6f6c 756d 6e7d  .geometrycolumn}
+000138b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000138c0: 2020 2020 2b4d 6272 4d69 6e58 287b 6c61      +MbrMinX({la
+000138d0: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+000138e0: 636f 6c75 6d6e 7d29 292f 320a 2020 2020  column}))/2.    
+000138f0: 2020 2020 2020 2020 2020 2020 292a 7b74              )*{t
+00013900: 6f5f 6765 6f67 7261 7068 6963 5f66 6163  o_geographic_fac
+00013910: 746f 725f 6170 7072 6f78 7d2c 0a20 2020  tor_approx},.   
+00013920: 2020 2020 2020 2020 2020 2020 2028 284d               ((M
+00013930: 6272 4d69 6e59 287b 6c61 7965 7269 6e66  brMinY({layerinf
+00013940: 6f2e 6765 6f6d 6574 7279 636f 6c75 6d6e  o.geometrycolumn
+00013950: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00013960: 2020 2020 202b 4d62 724d 6178 5928 7b6c       +MbrMaxY({l
+00013970: 6179 6572 696e 666f 2e67 656f 6d65 7472  ayerinfo.geometr
+00013980: 7963 6f6c 756d 6e7d 2929 2f32 0a20 2020  ycolumn}))/2.   
+00013990: 2020 2020 2020 2020 2020 2020 2029 2a7b               )*{
+000139a0: 746f 5f67 656f 6772 6170 6869 635f 6661  to_geographic_fa
+000139b0: 6374 6f72 5f61 7070 726f 787d 2c20 3433  ctor_approx}, 43
+000139c0: 3236 292c 2031 3029 2222 220a 0a20 2020  26), 10)"""..   
+000139d0: 2023 204e 6f77 2077 6520 6361 6e20 6163   # Now we can ac
+000139e0: 7475 616c 6c79 2061 6464 2074 6865 2063  tually add the c
+000139f0: 6f6c 756d 6e2e 0a20 2020 2067 666f 2e61  olumn..    gfo.a
+00013a00: 6464 5f63 6f6c 756d 6e28 7061 7468 3d70  dd_column(path=p
+00013a10: 6174 682c 206e 616d 653d 6e61 6d65 2c20  ath, name=name, 
+00013a20: 7479 7065 3d67 666f 2e44 6174 6154 7970  type=gfo.DataTyp
+00013a30: 652e 5445 5854 2c20 6578 7072 6573 7369  e.TEXT, expressi
+00013a40: 6f6e 3d65 7870 7265 7373 696f 6e29 0a20  on=expression). 
+00013a50: 2020 2073 716c 6974 655f 7374 6d74 203d     sqlite_stmt =
+00013a60: 2066 2743 5245 4154 4520 494e 4445 5820   f'CREATE INDEX 
+00013a70: 7b6e 616d 657d 5f69 6478 204f 4e20 227b  {name}_idx ON "{
+00013a80: 6c61 7965 727d 2228 7b6e 616d 657d 2927  layer}"({name})'
+00013a90: 0a20 2020 2067 666f 2e65 7865 6375 7465  .    gfo.execute
+00013aa0: 5f73 716c 2870 6174 683d 7061 7468 2c20  _sql(path=path, 
+00013ab0: 7371 6c5f 7374 6d74 3d73 716c 6974 655f  sql_stmt=sqlite_
+00013ac0: 7374 6d74 290a                           stmt).
```

### Comparing `geofileops-0.8.0a5/geofileops/util/_geoops_ogr.py` & `geofileops-0.8.0a6/geofileops/util/_geoops_ogr.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_geoops_sql.py` & `geofileops-0.8.0a6/geofileops/util/_geoops_sql.py`

 * *Files 3% similar despite different names*

```diff
@@ -46,14 +46,16 @@
     distance: float,
     quadrantsegments: int = 5,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
     operation = f"ST_Buffer({{geometrycolumn}}, {distance}, {quadrantsegments})"
@@ -63,15 +65,15 @@
     # Negative buffer creates invalid stuff, so use collectionextract to keep only
     # polygons.
     if distance < 0:
         operation = f"ST_CollectionExtract({operation}, 3)"
 
     # Create the final template
     sql_template = f"""
-        SELECT {operation} AS geom
+        SELECT {operation} AS {{geometrycolumn}}
               {{columns_to_select_str}}
             FROM "{{input_layer}}" layer
             WHERE 1=1
               {{batch_filter}}
     """
 
     # Buffer operation always results in polygons...
@@ -89,39 +91,42 @@
         operation_name="buffer",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def convexhull(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = False,  # Should become True
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
     input_layerinfo = gfo.get_layerinfo(input_path, input_layer)
     sql_template = """
-        SELECT ST_ConvexHull({geometrycolumn}) AS geom
+        SELECT ST_ConvexHull({geometrycolumn}) AS {geometrycolumn}
                 {columns_to_select_str}
           FROM "{input_layer}" layer
          WHERE 1=1
            {batch_filter}
     """
 
     # Go!
@@ -134,36 +139,39 @@
         operation_name="convexhull",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=input_layerinfo.geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def delete_duplicate_geometries(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
+    where: Optional[str] = None,
     force: bool = False,
 ):
     # The query as written doesn't give correct results when parallellized,
     # but it isn't useful to do it for this operation.
     sql_template = """
-        SELECT {geometrycolumn} AS geom
+        SELECT {geometrycolumn} AS {geometrycolumn}
               {columns_to_select_str}
           FROM "{input_layer}" layer
          WHERE layer.rowid IN (
                 SELECT MIN(layer_sub.rowid) AS rowid_to_keep
                   FROM "{input_layer}" layer_sub
                  GROUP BY layer_sub.{geometrycolumn}
             )
@@ -178,16 +186,17 @@
         operation_name="delete_duplicate_geometries",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=input_layer_info.geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=1,
         batchsize=-1,
         force=force,
     )
 
 
 def isvalid(
@@ -200,15 +209,15 @@
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ) -> bool:
     # Prepare sql template for this operation
     sql_template = """
-        SELECT ST_IsValidDetail({geometrycolumn}) AS geom
+        SELECT ST_IsValidDetail({geometrycolumn}) AS {geometrycolumn}
               ,ST_IsValid({geometrycolumn}) AS isvalid
               ,ST_IsValidReason({geometrycolumn}) AS isvalidreason
               {columns_to_select_str}
           FROM "{input_layer}" layer
          WHERE ST_IsValid({geometrycolumn}) <> 1
            {batch_filter}
     """
@@ -220,16 +229,17 @@
         operation_name="isvalid",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=GeometryType.POINT,
         gridsize=0.0,
+        keep_empty_geoms=False,
+        where=None,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
     # Check the number of invalid files
     nb_invalid_geoms = 0
@@ -266,14 +276,16 @@
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
+    where: Optional[str] = None,
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # If output file exists already, either clean up or return...
     operation_name = "makevalid"
@@ -301,15 +313,15 @@
     # If we want a specific geometrytype, only extract the relevant type
     if force_output_geometrytype is not GeometryType.GEOMETRYCOLLECTION:
         primitivetypeid = force_output_geometrytype.to_primitivetype.value
         operation = f"ST_CollectionExtract({operation}, {primitivetypeid})"
 
     # Now we can prepare the entire statement
     sql_template = f"""
-        SELECT {operation} AS geom
+        SELECT {operation} AS {{geometrycolumn}}
                 {{columns_to_select_str}}
           FROM "{{input_layer}}" layer
          WHERE 1=1
            {{batch_filter}}
     """
 
     _single_layer_vector_operation(
@@ -319,16 +331,17 @@
         operation_name=operation_name,
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=0.0,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
     # If asked and output is spatialite based, check if all data can be read
     if validate_attribute_data:
@@ -344,14 +357,15 @@
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = "SQLITE",
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Check if output exists already here, to evade to much logging to be written
     if output_path.exists():
         if force is False:
@@ -377,16 +391,17 @@
         operation_name="select",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=None,
         sql_dialect=sql_dialect,
-        filter_null_geoms=False,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def simplify(
@@ -394,23 +409,26 @@
     output_path: Path,
     tolerance: float,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     columns: Optional[List[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
     sql_template = f"""
-        SELECT ST_SimplifyPreserveTopology({{geometrycolumn}}, {tolerance}) AS geom
-                {{columns_to_select_str}}
+        SELECT ST_SimplifyPreserveTopology({{geometrycolumn}}, {tolerance}
+               ) AS {{geometrycolumn}}
+              {{columns_to_select_str}}
             FROM "{{input_layer}}" layer
             WHERE 1=1
             {{batch_filter}}
     """
 
     # Output geometry type same as input geometry type
     input_layer_info = gfo.get_layerinfo(input_path, input_layer)
@@ -421,16 +439,17 @@
         operation_name="simplify",
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
         force_output_geometrytype=input_layer_info.geometrytype,
         gridsize=gridsize,
+        keep_empty_geoms=keep_empty_geoms,
+        where=where,
         sql_dialect="SQLITE",
-        filter_null_geoms=True,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def _single_layer_vector_operation(
@@ -440,28 +459,31 @@
     operation_name: str,
     input_layer: Optional[str],
     output_layer: Optional[str],
     columns: Optional[List[str]],
     explodecollections: bool,
     force_output_geometrytype: Optional[GeometryType],
     gridsize: float,
+    keep_empty_geoms: bool,
+    where: Optional[str],
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]],
-    filter_null_geoms: bool,
     nb_parallel: int,
     batchsize: int,
     force: bool,
 ):
     # Init
     start_time = datetime.now()
 
-    # Check input parameters...
+    # Check/clean input parameters...
     if not input_path.exists():
         raise ValueError(f"{operation_name}: input_path doesn't exist: {input_path}")
     if input_path == output_path:
         raise ValueError(f"{operation_name}: output_path must not equal input_path")
+    if where is not None and where == "":
+        where = None
 
     # Check/get layer names
     if input_layer is None:
         input_layer = gfo.get_only_layer(input_path)
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
@@ -513,60 +535,95 @@
             columns_asked=columns,
             columns_in_layer=input_layerinfo.columns,
             fid_column=input_layerinfo.fid_column,
         )
 
         # Fill out/add to the sql_template what is already possible
         # ---------------------------------------------------------
-        sql_template = sql_template.format(
-            geometrycolumn=input_layerinfo.geometrycolumn,
-            columns_to_select_str=column_formatter.prefixed_aliased(),
-            input_layer=processing_params.input1_layer,
-            batch_filter="{batch_filter}",
-        )
 
         # Add snaptogrid around sql_template if gridsize specified
         if gridsize != 0.0:
             # Apply snaptogrid, but this results in invalid geometries, so also
             # ST_Makevalid. It can also result in collapsed (pieces of)
             # geometries, so also collectionextract.
-            gridsize_op = f"ST_MakeValid(SnapToGrid(sub_gridsize.geom, {gridsize}))"
+            gridsize_op = (
+                f"ST_MakeValid(SnapToGrid(sub_gridsize.{{geometrycolumn}}, {gridsize}))"
+            )
             if force_output_geometrytype is None:
                 warnings.warn(
                     "a gridsize is specified but no force_output_geometrytype, this "
                     "can result in inconsistent geometries in the output"
                 )
             else:
                 primitivetypeid = force_output_geometrytype.to_primitivetype.value
                 gridsize_op = f"ST_CollectionExtract({gridsize_op}, {primitivetypeid})"
 
             # Get all columns of the sql_template
-            sql_tmp = sql_template.format(batch_filter="")
+            sql_tmp = sql_template.format(
+                geometrycolumn=input_layerinfo.geometrycolumn,
+                columns_to_select_str=column_formatter.prefixed_aliased(),
+                input_layer=processing_params.input1_layer,
+                batch_filter="",
+            )
             cols = _sqlite_util.get_columns(
                 sql_stmt=sql_tmp,
                 input1_path=processing_params.input1_path,  # type: ignore
             )
-            cols = [col for col in cols if col.lower() != "geom"]
+            cols = [
+                col for col in cols if col.lower() != input_layerinfo.geometrycolumn
+            ]
             columns_to_select = _ogr_sql_util.columns_quoted(cols)
             sql_template = f"""
-                SELECT {gridsize_op} AS geom
+                SELECT {gridsize_op} AS {{geometrycolumn}}
                       {columns_to_select}
                   FROM ( {sql_template}
                     ) sub_gridsize
             """
 
-        # Add where filter around sql_template if relevant
-        if filter_null_geoms:
-            where = "sub_where.geom IS NOT NULL"
+        # If empty/null geometries don't need to be kept, filter them away
+        if not keep_empty_geoms:
             sql_template = f"""
-                SELECT sub_where.* FROM
+                SELECT * FROM
                     ( {sql_template}
-                    ) sub_where
+                    )
+                 WHERE {{geometrycolumn}} IS NOT NULL
+            """
+
+        # Prepare/apply where parameter
+        if where is not None and not explodecollections:
+            # explodecollections is not True, so we can add where to sql_stmt.
+            # If explodecollections would be True, we need to wait to apply the
+            # where till after explodecollections is applied, so when appending the
+            # partial results to the output file.
+            sql_template = f"""
+                SELECT * FROM
+                    ( {sql_template}
+                    )
                     WHERE {where}
             """
+            # Where has been applied already so set to None.
+            where = None
+
+        # When null geometries are being kept, we need to make sure the geom in the
+        # first row is not NULL because of a bug in gdal, so add ORDER BY as last step.
+        #   -> https://github.com/geofileops/geofileops/issues/308
+        if keep_empty_geoms:
+            sql_template = f"""
+                SELECT * FROM
+                    ( {sql_template}
+                    )
+                 ORDER BY {{geometrycolumn}} IS NULL
+            """
+
+        sql_template = sql_template.format(
+            geometrycolumn=input_layerinfo.geometrycolumn,
+            columns_to_select_str=column_formatter.prefixed_aliased(),
+            input_layer=processing_params.input1_layer,
+            batch_filter="{batch_filter}",
+        )
 
         # Prepare temp output filename
         tmp_output_path = tempdir / output_path.name
 
         # Processing in threads is 2x faster for small datasets (on Windows)
         calculate_in_threads = True if input_layerinfo.featurecount <= 100 else False
         with _processing_util.PooledExecutorFactory(
@@ -577,15 +634,15 @@
             batches = {}
             future_to_batch_id = {}
             for batch_id in processing_params.batches:
                 batches[batch_id] = {}
                 batches[batch_id]["layer"] = output_layer
 
                 tmp_partial_output_path = (
-                    tempdir / f"{output_path.stem}_{batch_id}{output_path.suffix}"
+                    tempdir / f"{output_path.stem}_{batch_id}.gpkg"
                 )
                 batches[batch_id]["tmp_partial_output_path"] = tmp_partial_output_path
 
                 # Fill out sql_template
                 sql_stmt = sql_template.format(
                     batch_filter=processing_params.batches[batch_id]["batch_filter"]
                 )
@@ -593,24 +650,27 @@
 
                 # If there is only one batch, it is faster to create the spatial index
                 # immediately. Otherwise no index needed, because partial files still
                 # need to be merged to one file later on.
                 create_spatial_index = False
                 if nb_batches == 1:
                     create_spatial_index = True
-
+                preserve_fid = True
+                if explodecollections:
+                    preserve_fid = False
                 translate_info = _ogr_util.VectorTranslateInfo(
                     input_path=processing_params.batches[batch_id]["path"],
                     output_path=tmp_partial_output_path,
                     output_layer=output_layer,
                     sql_stmt=sql_stmt,
                     sql_dialect=sql_dialect,
                     explodecollections=explodecollections,
                     force_output_geometrytype=force_output_geometrytype,
                     options={"LAYER_CREATION.SPATIAL_INDEX": create_spatial_index},
+                    preserve_fid=preserve_fid,
                 )
                 future = calculate_pool.submit(
                     _ogr_util.vector_translate_by_info, info=translate_info
                 )
                 future_to_batch_id[future] = batch_id
 
             # Loop till all parallel processes are ready, but process each one
@@ -638,23 +698,35 @@
                 nb_done += 1
 
                 # Normally all partial files should exist, but to be sure.
                 if not tmp_partial_output_path.exists():
                     logger.warning(f"Result file {tmp_partial_output_path} not found")
                     continue
 
-                # If there is only one batch, just rename because it is already OK
-                if nb_batches == 1:
+                if (
+                    nb_batches == 1
+                    and tmp_partial_output_path.suffix == tmp_output_path.suffix
+                    and where is None
+                ):
+                    # If there is only one batch
+                    #   + partial file is already is correct file format
+                    #   + no more where needs to be applied
+                    # -> just rename partial file, because it is already OK.
                     gfo.move(tmp_partial_output_path, tmp_output_path)
                 else:
+                    # Append partial file to full destination file
+                    if where is not None:
+                        info = gfo.get_layerinfo(tmp_partial_output_path, output_layer)
+                        where = where.format(geometrycolumn=info.geometrycolumn)
                     fileops._append_to_nolock(
                         src=tmp_partial_output_path,
                         dst=tmp_output_path,
                         explodecollections=explodecollections,
                         force_output_geometrytype=force_output_geometrytype,
+                        where=where,
                         create_spatial_index=False,
                     )
                     gfo.remove(tmp_partial_output_path)
 
                 # Log the progress and prediction speed
                 _general_util.report_progress(
                     start_time,
@@ -674,15 +746,16 @@
             gfo.move(tmp_output_path, output_path)
         else:
             logger.debug(f"Result of {operation_name} was empty!")
 
     finally:
         # Clean tmp dir
         shutil.rmtree(tempdir, ignore_errors=True)
-        logger.info(f"Processing ready, took {datetime.now()-start_time}!")
+
+    logger.info(f"Processing ready, took {datetime.now()-start_time}!")
 
 
 ################################################################################
 # Operations on two layers
 ################################################################################
 
 
@@ -692,14 +765,15 @@
     output_path: Path,
     input_layer: Optional[str] = None,
     input_columns: Optional[List[str]] = None,
     clip_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
     input_columns_prefix: str = "",
     output_with_spatial_index: bool = True,
 ):
     # Init
@@ -774,14 +848,15 @@
         input1_columns_prefix=input_columns_prefix,
         input2_layer=clip_layer,
         input2_columns=None,
         input2_columns_prefix="",
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         force_output_geometrytype=force_output_geometrytype,
         output_with_spatial_index=output_with_spatial_index,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
@@ -792,14 +867,15 @@
     output_path: Path,
     input_layer: Optional[str] = None,
     input_columns: Optional[List[str]] = None,
     erase_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
     input_columns_prefix: str = "",
     output_with_spatial_index: bool = True,
 ):
     # Init
@@ -878,14 +954,15 @@
         input2_layer=erase_layer,
         input2_columns=[],
         input2_columns_prefix="",
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
         output_with_spatial_index=output_with_spatial_index,
     )
 
 
@@ -896,14 +973,15 @@
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = "area_inters",
     input_layer: Optional[str] = None,
     input_columns: Optional[List[str]] = None,
     input_to_compare_with_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Prepare sql template for this operation
     # TODO: test performance difference between the following two queries
     input1_layer_rtree = "rtree_{input1_layer}_{input1_geometrycolumn}"
@@ -990,14 +1068,15 @@
         input2_layer=input_to_compare_with_layer,
         input2_columns=[],
         input2_columns_prefix="",
         output_layer=output_layer,
         explodecollections=False,
         force_output_geometrytype=input_layer_info.geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def export_by_distance(
@@ -1006,14 +1085,15 @@
     output_path: Path,
     max_distance: float,
     input1_layer: Optional[str] = None,
     input1_columns: Optional[List[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Prepare sql template for this operation
     input1_layer_rtree = "rtree_{input1_layer}_{input1_geometrycolumn}"
     input2_layer_rtree = "rtree_{input2_layer}_{input2_geometrycolumn}"
@@ -1054,14 +1134,15 @@
         input2_layer=input2_layer,
         input2_columns=[],
         input2_columns_prefix="",
         output_layer=output_layer,
         explodecollections=False,
         force_output_geometrytype=input_layer_info.geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def intersection(
@@ -1073,14 +1154,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # In the query, important to only extract the geometry types that are expected
     # TODO: test for geometrycollection, line, point,...
     input1_layer_info = gfo.get_layerinfo(input1_path, input1_layer)
@@ -1146,14 +1228,15 @@
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def join_by_location(
@@ -1169,14 +1252,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Prepare sql template for this operation
     # Prepare intersection area columns/filter
     area_inters_column_expression = ""
@@ -1290,14 +1374,15 @@
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=input1_layer_info.geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def _prepare_spatial_relations_filter(query: str) -> str:
@@ -1403,15 +1488,15 @@
         input2_tmp_path = input2_path
         input2_tmp_layer = input2_layer
     else:
         # Put input2 layer in sqlite gfo...
         tempdir = _io_util.create_tempdir("geofileops/join_nearest")
         input1_tmp_path = tempdir / "both_input_layers.sqlite"
         input1_tmp_layer = "input1_layer"
-        gfo.convert(
+        gfo.copy_layer(
             src=input1_path,
             src_layer=input1_layer,
             dst=input1_tmp_path,
             dst_layer=input1_tmp_layer,
             preserve_fid=True,
         )
 
@@ -1458,14 +1543,15 @@
         input2_layer=input2_tmp_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         force_output_geometrytype=input1_layer_info.geometrytype,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=None,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
         use_ogr=True,
     )
 
 
@@ -1480,14 +1566,15 @@
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     force_output_geometrytype: Optional[GeometryType] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Go!
     return _two_layer_vector_operation(
         input1_path=input1_path,
@@ -1501,14 +1588,15 @@
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
 def split(
@@ -1520,14 +1608,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
     output_with_spatial_index: bool = True,
 ):
     # In the query, important to only extract the geometry types that are
     # expected, so the primitive type of input1_layer
@@ -1623,14 +1712,15 @@
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
+        where=where,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
         output_with_spatial_index=output_with_spatial_index,
     )
 
 
@@ -1643,14 +1733,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # A symmetric difference can be simulated by doing an "erase" of input1
     # and input2 and then append the result of an erase of input2 with
     # input1...
@@ -1673,14 +1764,15 @@
             input_layer=input1_layer,
             input_columns=input1_columns,
             input_columns_prefix=input1_columns_prefix,
             erase_layer=input2_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
             output_with_spatial_index=False,
         )
 
         if input2_columns is None or len(input2_columns) > 0:
@@ -1704,14 +1796,15 @@
             input_layer=input2_layer,
             input_columns=input2_columns,
             input_columns_prefix=input2_columns_prefix,
             erase_layer=input1_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
             output_with_spatial_index=False,
         )
 
         # Now append
@@ -1723,26 +1816,26 @@
         )
 
         # Convert or add spatial index
         tmp_output_path = erase1_output_path
         if erase1_output_path.suffix != output_path.suffix:
             # Output file should be in diffent format, so convert
             tmp_output_path = tempdir / output_path.name
-            gfo.convert(src=erase1_output_path, dst=tmp_output_path)
+            gfo.copy_layer(src=erase1_output_path, dst=tmp_output_path)
         else:
             # Create spatial index
             gfo.create_spatial_index(path=tmp_output_path, layer=output_layer)
 
         # Now we are ready to move the result to the final spot...
         if output_path.exists():
             gfo.remove(output_path)
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir)
+        shutil.rmtree(tempdir, ignore_errors=True)
 
 
 def union(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
     input1_layer: Optional[str] = None,
@@ -1750,14 +1843,15 @@
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
     input2_columns: Optional[List[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    where: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # A union can be simulated by doing a "split" of input1 and input2 and
     # then append the result of an erase of input2 with input1...
 
@@ -1782,14 +1876,15 @@
             input1_columns_prefix=input1_columns_prefix,
             input2_layer=input2_layer,
             input2_columns=input2_columns,
             input2_columns_prefix=input2_columns_prefix,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
             output_with_spatial_index=False,
         )
 
         # Now erase input1 from input2 to another temporary output gfo...
@@ -1801,14 +1896,15 @@
             input_layer=input2_layer,
             input_columns=input2_columns,
             input_columns_prefix=input2_columns_prefix,
             erase_layer=input1_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
+            where=where,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
             output_with_spatial_index=False,
         )
 
         # Now append
@@ -1820,26 +1916,26 @@
         )
 
         # Convert or add spatial index
         tmp_output_path = split_output_path
         if split_output_path.suffix != output_path.suffix:
             # Output file should be in different format, so convert
             tmp_output_path = tempdir / output_path.name
-            gfo.convert(src=split_output_path, dst=tmp_output_path)
+            gfo.copy_layer(src=split_output_path, dst=tmp_output_path)
         else:
             # Create spatial index
             gfo.create_spatial_index(path=tmp_output_path, layer=output_layer)
 
         # Now we are ready to move the result to the final spot...
         if output_path.exists():
             gfo.remove(output_path)
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir)
+        shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"union ready, took {datetime.now()-start_time}!")
 
 
 def _two_layer_vector_operation(
     input1_path: Path,
     input2_path: Path,
@@ -1852,14 +1948,15 @@
     input2_layer: Optional[str],
     input2_columns: Optional[List[str]],
     input2_columns_prefix: str,
     output_layer: Optional[str],
     explodecollections: bool,
     force_output_geometrytype: Optional[GeometryType],
     gridsize: float,
+    where: Optional[str],
     nb_parallel: int,
     batchsize: int,
     force: bool,
     use_ogr: bool = False,
     output_with_spatial_index: bool = True,
 ):
     """
@@ -1878,14 +1975,17 @@
         output_layer (str, optional): [description]. Defaults to None.
         explodecollections (bool, optional): Explode collecions in output.
             Defaults to False.
         force_output_geometrytype (GeometryType, optional): Defaults to None.
         gridsize (float, optional): the size of the grid the coordinates of the ouput
             will be rounded to. Eg. 0.001 to keep 3 decimals. Value 0.0 doesn't change
             the precision. Defaults to 0.0.
+        where (str, optional): filter to apply to the result of the operation (after
+            explodecollections). It should be in sqlite SQL WHERE syntax and
+            |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): [description]. Defaults to -1.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller nb_parallel, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): [description]. Defaults to False.
         use_ogr (bool, optional): If True, ogr is used to do the processing,
@@ -1893,15 +1993,20 @@
             NOT supported. If False, sqlite3 is used directly.
             Defaults to False.
         output_with_spatial_index (bool, optional): True to create output file with
             spatial index. Defaults to True.
 
     Raises:
         ValueError: [description]
-    """
+
+    .. |spatialite_reference_link| raw:: html
+
+        <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
+
+    """  # noqa: E501
     # Init
     if not input1_path.exists():
         raise ValueError(f"{operation_name}: input1_path doesn't exist: {input1_path}")
     if not input2_path.exists():
         raise ValueError(f"{operation_name}: input2_path doesn't exist: {input2_path}")
     if input1_path == output_path or input2_path == output_path:
         raise ValueError(
@@ -2058,14 +2163,29 @@
             sql_template = f"""
                 SELECT {gridsize_op} AS geom
                         {columns_to_select}
                     FROM ( {sql_template}
                     ) sub_gridsize
             """
 
+        # Prepare/apply where parameter
+        if where is not None and not explodecollections:
+            # explodecollections is not True, so we can add where to sql_stmt.
+            # If explodecollections would be True, we need to wait to apply the
+            # where till after explodecollections is applied, so when appending the
+            # partial results to the output file.
+            sql_template = f"""
+                SELECT * FROM
+                    ( {sql_template}
+                    )
+                    WHERE {where}
+            """
+            # Where has been applied already so set to None.
+            where = None
+
         # Calculate
         # ---------
         # Processing in threads is 2x faster for small datasets (on Windows)
         calculate_in_threads = (
             True if input1_tmp_layerinfo.featurecount <= 100 else False
         )
         logger.info(
@@ -2092,49 +2212,37 @@
                 sql_stmt = sql_template.format(
                     input1_databasename="{input1_databasename}",
                     input2_databasename="{input2_databasename}",
                     batch_filter=processing_params.batches[batch_id]["batch_filter"],
                 )
                 batches[batch_id]["sqlite_stmt"] = sql_stmt
 
+                # If explodecollections and there is a where to be applied, we need to
+                # apply explodecollections now already to be able to apply the where in
+                # the append of partial files later on even though this involves an
+                # extra copy of the result data under the hood in practice!
+                explodecollections_now = False
+                if explodecollections and where is not None:
+                    explodecollections_now = True
                 # Remark: this temp file doesn't need spatial index
-                if use_ogr is False:
-                    # Use an aggressive speedy sqlite profile
-                    future = calculate_pool.submit(
-                        _sqlite_util.create_table_as_sql,
-                        input1_path=processing_params.batches[batch_id]["path"],
-                        input1_layer=processing_params.batches[batch_id]["layer"],
-                        input2_path=processing_params.input2_path,
-                        output_path=tmp_partial_output_path,
-                        sql_stmt=sql_stmt,
-                        output_layer=output_layer,
-                        output_geometrytype=force_output_geometrytype,
-                        create_spatial_index=False,
-                        profile=_sqlite_util.SqliteProfile.SPEED,
-                    )
-                    future_to_batch_id[future] = batch_id
-                else:
-                    # Use ogr to run the query
-                    #   * input2 path (= using attach) doesn't seem to work
-                    #   * ogr doesn't fill out database names, so do it now
-                    sql_stmt = sql_stmt.format(
-                        input1_databasename=processing_params.input1_databasename,
-                        input2_databasename=processing_params.input2_databasename,
-                    )
-
-                    future = calculate_pool.submit(
-                        _ogr_util.vector_translate,
-                        input_path=processing_params.batches[batch_id]["path"],
-                        output_path=tmp_partial_output_path,
-                        sql_stmt=sql_stmt,
-                        output_layer=output_layer,
-                        explodecollections=explodecollections,
-                        force_output_geometrytype=force_output_geometrytype,
-                        options={"LAYER_CREATION.SPATIAL_INDEX": False},
-                    )
+                future = calculate_pool.submit(
+                    calculate_two_layers,
+                    input1_path=processing_params.batches[batch_id]["path"],
+                    input1_layer=processing_params.batches[batch_id]["layer"],
+                    input2_path=processing_params.input2_path,
+                    output_path=tmp_partial_output_path,
+                    sql_stmt=sql_stmt,
+                    input1_databasename=processing_params.input1_databasename,
+                    input2_databasename=processing_params.input2_databasename,
+                    output_layer=output_layer,
+                    explodecollections=explodecollections_now,
+                    force_output_geometrytype=force_output_geometrytype,
+                    use_ogr=use_ogr,
+                    create_spatial_index=False,
+                )
                 future_to_batch_id[future] = batch_id
 
             # Loop till all parallel processes are ready, but process each one
             # that is ready already
             nb_done = 0
             _general_util.report_progress(
                 start_time,
@@ -2168,14 +2276,15 @@
 
                 # If there is only one tmp_partial file and it is already ok as
                 # output file, just rename/move it.
                 if (
                     nb_batches == 1
                     and not explodecollections
                     and force_output_geometrytype is None
+                    and where is None
                     and tmp_partial_output_path.suffix.lower()
                     == tmp_output_path.suffix.lower()
                 ):
                     gfo.move(tmp_partial_output_path, tmp_output_path)
                 else:
                     # If there is only one batch, it is faster to create the spatial
                     # index immediately
@@ -2184,14 +2293,15 @@
                         create_spatial_index = True
 
                     fileops._append_to_nolock(
                         src=tmp_partial_output_path,
                         dst=tmp_output_path,
                         explodecollections=explodecollections,
                         force_output_geometrytype=force_output_geometrytype,
+                        where=where,
                         create_spatial_index=create_spatial_index,
                         preserve_fid=False,
                     )
                     gfo.remove(tmp_partial_output_path)
 
                 # Log the progress and prediction speed
                 _general_util.report_progress(
@@ -2220,14 +2330,78 @@
         gfo.remove(output_path, missing_ok=True)
         gfo.remove(tmp_output_path, missing_ok=True)
         raise
     finally:
         shutil.rmtree(tempdir, ignore_errors=True)
 
 
+def calculate_two_layers(
+    input1_path: Path,
+    input1_layer: str,
+    input2_path: Path,
+    output_path: Path,
+    sql_stmt: str,
+    input1_databasename: str,
+    input2_databasename: str,
+    output_layer: str,
+    explodecollections: bool,
+    force_output_geometrytype: GeometryType,
+    create_spatial_index: bool,
+    use_ogr: bool,
+):
+    if use_ogr is False:
+        # If explodecollections, write first to tmp file, then apply explodecollections
+        # to the final output file.
+        output_tmp_path = output_path
+        if explodecollections:
+            output_name = f"{output_path.stem}_tmp{output_path.suffix}"
+            output_tmp_path = output_path.parent / output_name
+        _sqlite_util.create_table_as_sql(
+            input1_path=input1_path,
+            input1_layer=input1_layer,
+            input2_path=input2_path,
+            output_path=output_tmp_path,
+            sql_stmt=sql_stmt,
+            output_layer=output_layer,
+            output_geometrytype=force_output_geometrytype,
+            create_spatial_index=create_spatial_index,
+            profile=_sqlite_util.SqliteProfile.SPEED,
+        )
+        if explodecollections:
+            _ogr_util.vector_translate(
+                input_path=output_tmp_path,
+                input_layers=output_layer,
+                output_path=output_path,
+                output_layer=output_layer,
+                explodecollections=explodecollections,
+                force_output_geometrytype=force_output_geometrytype,
+                options={"LAYER_CREATION.SPATIAL_INDEX": create_spatial_index},
+                preserve_fid=False,
+            )
+            gfo.remove(output_tmp_path)
+    else:
+        # Use ogr to run the query
+        #   * input2 path (= using attach) doesn't seem to work
+        #   * ogr doesn't fill out database names, so do it now
+        sql_stmt = sql_stmt.format(
+            input1_databasename=input1_databasename,
+            input2_databasename=input2_databasename,
+        )
+
+        _ogr_util.vector_translate(
+            input_path=input1_path,
+            output_path=output_path,
+            sql_stmt=sql_stmt,
+            output_layer=output_layer,
+            explodecollections=explodecollections,
+            force_output_geometrytype=force_output_geometrytype,
+            options={"LAYER_CREATION.SPATIAL_INDEX": create_spatial_index},
+        )
+
+
 class ProcessingParams:
     def __init__(
         self,
         input1_path: Optional[Path] = None,
         input1_layer: Optional[str] = None,
         input1_databasename: Optional[str] = None,
         input2_path: Optional[Path] = None,
@@ -2327,15 +2501,15 @@
             returnvalue.input1_path = input1_path
             if input1_geofiletype == GeofileType.GPKG:
                 # HasSpatialindex doesn't work for spatialite file
                 gfo.create_spatial_index(input1_path, input1_layer, exist_ok=True)
         else:
             # If not ok, copy the input layer to gpkg
             returnvalue.input1_path = tempdir / f"{input1_path.stem}.gpkg"
-            gfo.convert(
+            gfo.copy_layer(
                 src=input1_path,
                 src_layer=input1_layer,
                 dst=returnvalue.input1_path,
                 dst_layer=returnvalue.input1_layer,
                 preserve_fid=True,
             )
 
@@ -2347,15 +2521,15 @@
                 returnvalue.input2_path = input2_path
                 if input2_geofiletype == GeofileType.GPKG:
                     # HasSpatialindex doesn't work for spatialite file
                     gfo.create_spatial_index(input2_path, input2_layer, exist_ok=True)
             else:
                 # If not spatialite compatible, copy the input layer to gpkg
                 returnvalue.input2_path = tempdir / f"{input2_path.stem}.gpkg"
-                gfo.convert(
+                gfo.copy_layer(
                     src=input2_path,
                     src_layer=input2_layer,
                     dst=returnvalue.input2_path,
                     dst_layer=returnvalue.input2_layer,
                     preserve_fid=True,
                 )
 
@@ -2478,14 +2652,16 @@
 def dissolve_singlethread(
     input_path: Path,
     output_path: Path,
     groupby_columns: Union[str, Iterable[str], None] = None,
     agg_columns: Optional[dict] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
+    keep_empty_geoms: bool = True,
+    where: Optional[str] = None,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     force: bool = False,
 ):
     """
     Remark: this is not a parallelized version!!!
     """
@@ -2493,32 +2669,31 @@
     start_time = datetime.now()
 
     # Check input params
     if not input_path.exists():
         raise ValueError(f"input_path doesn't exist: {input_path}")
     if input_path == output_path:
         raise ValueError("output_path must not equal input_path")
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop dissolve: Output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    if where is not None and where == "":
+        where = None
 
     # Check layer names
     if input_layer is None:
         input_layer = gfo.get_only_layer(input_path)
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     # Use get_layerinfo to check if the layer definition is OK
-    layerinfo = gfo.get_layerinfo(input_path, input_layer)
-    fid_column = layerinfo.fid_column if layerinfo.fid_column != "" else "rowid"
+    input_layerinfo = gfo.get_layerinfo(input_path, input_layer)
+    fid_column = (
+        input_layerinfo.fid_column if input_layerinfo.fid_column != "" else "rowid"
+    )
+
     # Prepare some lists for later use
-    columns_available = list(layerinfo.columns) + ["fid"]
+    columns_available = list(input_layerinfo.columns) + ["fid"]
     columns_available_upper = [column.upper() for column in columns_available]
     groupby_columns_upper_dict = {}
     if groupby_columns is not None:
         groupby_columns_upper_dict = {col.upper(): col for col in groupby_columns}
 
     # Prepare the strings regarding groupby_columns to use in the select statement.
     if groupby_columns is not None:
@@ -2553,15 +2728,15 @@
 
         # Start preparation of agg_columns_str
         if "json" in agg_columns:
             # Determine the columns to be put in json
             columns = []
             if agg_columns["json"] is None:
                 # If columns specified is None: all columns not in groupby_columns
-                for column in layerinfo.columns:
+                for column in input_layerinfo.columns:
                     if column.upper() not in groupby_columns_upper_dict:
                         columns.append(column)
             else:
                 for column in agg_columns["json"]:
                     columns.append(column)
             json_columns = [f"'{column}', layer.\"{column}\"" for column in columns]
 
@@ -2617,62 +2792,137 @@
 
                 # Now put everything together
                 agg_columns_str += (
                     f", {aggregation_str}({distinct_str}{column_str}{extra_param_str}) "
                     f'AS "{agg_column["as"]}"'
                 )
 
+    # Check output path
+    if output_path.exists():
+        if force is False:
+            logger.info(f"Stop dissolve: Output exists already {output_path}")
+            return
+        else:
+            gfo.remove(output_path)
+
     # Now prepare the sql statement
     # Remark: calculating the area in the enclosing selects halves the processing time
 
     # The operation to run on the geometry
-    operation = f"ST_union(layer.{layerinfo.geometrycolumn})"
+    operation = f"ST_union(layer.{input_layerinfo.geometrycolumn})"
 
     # If the input is a linestring, also apply st_linemerge(), otherwise the individual
     # lines are just concatenated together and common points are not removed, resulting
     # in the original seperate lines again if explodecollections is True.
-    force_output_geometrytype = None
-    if layerinfo.geometrytype.to_primitivetype == PrimitiveType.LINESTRING:
+    if input_layerinfo.geometrytype.to_primitivetype == PrimitiveType.LINESTRING:
         operation = f"ST_LineMerge({operation})"
-        if explodecollections is True:
-            force_output_geometrytype = GeometryType.LINESTRING
 
-    # If there are no input features, the output geometry type needs to be specified
-    # so gdal can create an empty output file with the right geometry type.
-    if force_output_geometrytype is None and layerinfo.featurecount == 0:
-        force_output_geometrytype = layerinfo.geometrytype
+    # If the output file results in no rows gdal needs force_output_geometrytype to be
+    # able to create an empty output file with the right geometry type.
+    if explodecollections:
+        force_output_geometrytype = input_layerinfo.geometrytype.to_singletype
+    else:
+        force_output_geometrytype = input_layerinfo.geometrytype.to_multitype
 
     # Apply tolerance gridsize on result
     if gridsize != 0.0:
         # Apply snaptogrid, but this results in invalid geometries, so also
         # ST_Makevalid. It can also result in collapsed (pieces of)
         # geometries, so also collectionextract.
         operation = f"ST_MakeValid(SnapToGrid({operation}, {gridsize}))"
-        if force_output_geometrytype is None:
-            warnings.warn(
-                "a gridsize is specified but no force_output_geometrytype, this "
-                "can result in inconsistent geometries in the output"
-            )
-        else:
-            primitivetypeid = force_output_geometrytype.to_primitivetype.value
-            operation = f"ST_CollectionExtract({operation}, {primitivetypeid})"
+        primitivetypeid = force_output_geometrytype.to_primitivetype.value
+        operation = f"ST_CollectionExtract({operation}, {primitivetypeid})"
 
+    # Now the sql query can be assembled
     sql_stmt = f"""
         SELECT {operation} AS geom
             {groupby_columns_for_select_str}
             {agg_columns_str}
         FROM "{input_layer}" layer
         GROUP BY {groupby_columns_for_groupby_str}
     """
 
-    _ogr_util.vector_translate(
-        input_path=input_path,
-        output_path=output_path,
-        output_layer=output_layer,
-        sql_stmt=sql_stmt,
-        sql_dialect="SQLITE",
-        force_output_geometrytype=force_output_geometrytype,
-        explodecollections=explodecollections,
-        options={"LAYER_CREATION.SPATIAL_INDEX": True},
-    )
+    # If empty/null geometries don't need to be kept, filter them away
+    if not keep_empty_geoms:
+        sql_stmt = f"""
+            SELECT * FROM
+                ( {sql_stmt}
+                )
+             WHERE geom IS NOT NULL
+        """
+
+    # Prepare/apply where parameter
+    if where is not None and not explodecollections:
+        # explodecollections is not True, so we can add where to sql_stmt.
+        # If explodecollections would be True, we need to wait to apply the
+        # where till after explodecollections is applied, so when appending
+        # the partial results to the output file.
+        where = where.format(geometrycolumn="geom")
+        sql_stmt = f"""
+            SELECT * FROM
+                ( {sql_stmt}
+                )
+                WHERE {where}
+        """
+        # Where has been applied already so set to None.
+        where = None
+
+    # When null geometries are being kept, we need to make sure the geom in the
+    # first row is not NULL because of a bug in gdal, so add ORDER BY as last step.
+    #   -> https://github.com/geofileops/geofileops/issues/308
+    if keep_empty_geoms:
+        sql_stmt = f"""
+            SELECT * FROM
+                ( {sql_stmt}
+                )
+             ORDER BY geom IS NULL
+        """
+
+    # Now we can really start
+    tempdir = _io_util.create_tempdir("geofileops/dissolve_singlethread")
+    try:
+        create_spatial_index = True
+        suffix = output_path.suffix
+        if where is not None:
+            # Where needs to be applied still, so no spatial index needed
+            create_spatial_index = False
+            suffix = ".gpkg"
+        tmp_output_path = tempdir / f"output_tmp{suffix}"
+
+        _ogr_util.vector_translate(
+            input_path=input_path,
+            output_path=tmp_output_path,
+            output_layer=output_layer,
+            sql_stmt=sql_stmt,
+            sql_dialect="SQLITE",
+            force_output_geometrytype=force_output_geometrytype,
+            explodecollections=explodecollections,
+            options={"LAYER_CREATION.SPATIAL_INDEX": create_spatial_index},
+        )
+
+        # We still need to apply a where filter
+        if where is not None:
+            tmp_output_where_path = tempdir / f"output_tmp2_where{output_path.suffix}"
+            tmp_output_info = gfo.get_layerinfo(tmp_output_path)
+            where = where.format(geometrycolumn=tmp_output_info.geometrycolumn)
+            sql_stmt = f"""
+                SELECT * FROM "{output_layer}"
+                 WHERE {where}
+            """
+            _ogr_util.vector_translate(
+                input_path=tmp_output_path,
+                output_path=tmp_output_where_path,
+                output_layer=output_layer,
+                force_output_geometrytype=force_output_geometrytype,
+                sql_stmt=sql_stmt,
+                sql_dialect="SQLITE",
+                options={"LAYER_CREATION.SPATIAL_INDEX": True},
+            )
+            tmp_output_path = tmp_output_where_path
+
+        # Now we are ready to move the result to the final spot...
+        gfo.move(tmp_output_path, output_path)
+
+    finally:
+        shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Processing ready, took {datetime.now()-start_time}!")
```

### Comparing `geofileops-0.8.0a5/geofileops/util/_io_util.py` & `geofileops-0.8.0a6/geofileops/util/_io_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_ogr_sql_util.py` & `geofileops-0.8.0a6/geofileops/util/_ogr_sql_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_ogr_util.py` & `geofileops-0.8.0a6/geofileops/util/_ogr_util.py`

 * *Files 4% similar despite different names*

```diff
@@ -56,14 +56,15 @@
         input_srs: Union[int, str, None] = None,
         output_srs: Union[int, str, None] = None,
         reproject: bool = False,
         spatial_filter: Optional[Tuple[float, float, float, float]] = None,
         clip_geometry: Optional[Union[Tuple[float, float, float, float], str]] = None,
         sql_stmt: Optional[str] = None,
         sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = None,
+        where: Optional[str] = None,
         transaction_size: int = 65536,
         append: bool = False,
         update: bool = False,
         explodecollections: bool = False,
         force_output_geometrytype: Union[GeometryType, str, None] = None,
         options: dict = {},
         columns: Optional[List[str]] = None,
@@ -77,14 +78,15 @@
         self.input_srs = input_srs
         self.output_srs = output_srs
         self.reproject = reproject
         self.spatial_filter = spatial_filter
         self.clip_geometry = clip_geometry
         self.sql_stmt = sql_stmt
         self.sql_dialect = sql_dialect
+        self.where = where
         self.transaction_size = transaction_size
         self.append = append
         self.update = update
         self.explodecollections = explodecollections
         self.force_output_geometrytype = force_output_geometrytype
         self.options = options
         self.columns = columns
@@ -101,14 +103,15 @@
         input_srs=info.input_srs,
         output_srs=info.output_srs,
         reproject=info.reproject,
         spatial_filter=info.spatial_filter,
         clip_geometry=info.clip_geometry,
         sql_stmt=info.sql_stmt,
         sql_dialect=info.sql_dialect,  # type: ignore
+        where=info.where,
         transaction_size=info.transaction_size,
         append=info.append,
         update=info.update,
         explodecollections=info.explodecollections,
         force_output_geometrytype=info.force_output_geometrytype,
         options=info.options,
         columns=info.columns,
@@ -125,14 +128,15 @@
     input_srs: Union[int, str, None] = None,
     output_srs: Union[int, str, None] = None,
     reproject: bool = False,
     spatial_filter: Optional[Tuple[float, float, float, float]] = None,
     clip_geometry: Optional[Union[Tuple[float, float, float, float], str]] = None,
     sql_stmt: Optional[str] = None,
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = None,
+    where: Optional[str] = None,
     transaction_size: int = 65536,
     append: bool = False,
     update: bool = False,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     options: dict = {},
     columns: Optional[List[str]] = None,
@@ -151,14 +155,16 @@
     if input_path.suffix.lower() == ".shp":
         # For shapefiles, having input_layers not None gives issues
         input_layers = None
     elif sql_stmt is not None:
         # If a sql statement is passed, the input layers are not relevant,
         # and ogr2ogr will give a warning, so clear it.
         input_layers = None
+    if input_layers is not None and isinstance(input_layers, str):
+        input_layers = [input_layers]
 
     # SRS
     if input_srs is not None and isinstance(input_srs, int):
         input_srs = f"EPSG:{input_srs}"
 
     # Sql'ing, Filtering, clipping
     if spatial_filter is not None:
@@ -175,14 +181,16 @@
         if isinstance(clip_geometry, str):
             args.extend([clip_geometry])
         else:
             bounds = [str(coord) for coord in clip_geometry]
             args.extend(bounds)
     if columns is not None:
         args.extend(["-select", ",".join(columns)])
+    if sql_stmt is not None and where is not None:
+        raise ValueError("it is not supported to specify both sql_stmt and where")
 
     # Warp
     if warp is not None:
         gcps = warp.get("gcps", [])
         for gcp in gcps:
             args.extend(["-gcp"])
             args.extend([str(coord) for coord in gcp if coord is not None])
@@ -262,47 +270,14 @@
         if "OGR_SQLITE_CACHE" not in config_options:
             config_options["OGR_SQLITE_CACHE"] = "128"
 
     # Now we can really get to work
     result_ds = None
     gdallog_dir = Path(tempfile.gettempdir()) / "geofileops/gdal_log"
     try:
-        # Consolidate all parameters
-        # First take copy of args, because gdal.VectorTranslateOptions adds all
-        # other parameters to the list passed (by ref)!!!
-        args_copy = list(args)
-        options = gdal.VectorTranslateOptions(
-            options=args_copy,
-            format=output_filetype.ogrdriver,
-            accessMode=None,
-            srcSRS=input_srs,
-            dstSRS=output_srs,
-            reproject=reproject,
-            SQLStatement=sql_stmt,
-            SQLDialect=sql_dialect,
-            where=None,  # "geom IS NOT NULL",
-            selectFields=None,
-            addFields=False,
-            forceNullable=False,
-            spatFilter=spatial_filter,
-            spatSRS=None,
-            datasetCreationOptions=datasetCreationOptions,
-            layerCreationOptions=layerCreationOptions,
-            layers=input_layers,
-            layerName=output_layer,
-            geometryType=output_geometrytypes,
-            dim=None,
-            segmentizeMaxDist=None,
-            zField=None,
-            skipFailures=False,
-            limit=None,
-            callback=None,
-            callback_data=None,
-        )
-
         # In some cases gdal only raises the last exception instead of the stack in
         # VectorTranslate, so you lose necessary details!
         # -> uncomment gdal.DontUseExceptions() when debugging!
         # gdal.DontUseExceptions()
         gdal.UseExceptions()
         enable_debug = True if logger.level == logging.DEBUG else False
         gdal.ConfigurePythonLogging(logger_name="gdal", enable_debug=enable_debug)
@@ -312,18 +287,86 @@
         # afterwards.
         errorlog_path = gdallog_dir / f"gdal_errors_{os.getpid()}.log"
         config_options["CPL_LOG"] = str(errorlog_path)
         config_options["CPL_LOG_ERRORS"] = "ON"
 
         # Go!
         with set_config_options(config_options):
+            # Open input datasource already
+            input_ds = gdal.OpenEx(
+                str(input_path),
+                nOpenFlags=gdal.OF_VECTOR | gdal.OF_READONLY | gdal.OF_SHARED,
+            )
+
+            # If output_srs is not specified and the result has 0 rows, gdal creates the
+            # output file without srs.
+            # documented in https://github.com/geofileops/geofileops/issues/313
+            if output_srs is None:
+                set_output_srs = True
+                datasource_layer = None
+                if input_layers is not None and len(input_layers) == 1:
+                    datasource_layer = input_ds.GetLayer(input_layers[0])
+                else:
+                    nb_layers = input_ds.GetLayerCount()
+                    if nb_layers == 1:
+                        datasource_layer = input_ds.GetLayerByIndex(0)
+                    elif nb_layers == 0:
+                        # We never actually get here, because opening a file without
+                        # layers already gives an error.
+                        raise ValueError(f"no layers found in {input_path}")
+                    else:
+                        # If multiple layers and not explicitly specified, it is in the
+                        # sql statement so difficult to determine... so pass
+                        set_output_srs = False
+
+                if set_output_srs:
+                    # If the layer doesn't exist, return
+                    if datasource_layer is None:
+                        raise RuntimeError(
+                            f"input_layers {input_layers} not found in: {input_path}"
+                        )
+                    spatialref = datasource_layer.GetSpatialRef()
+                    if spatialref is not None:
+                        output_srs = spatialref.ExportToWkt()
+
+            # Consolidate all parameters
+            # First take copy of args, because gdal.VectorTranslateOptions adds all
+            # other parameters to the list passed (by ref)!!!
+            args_copy = list(args)
+            options = gdal.VectorTranslateOptions(
+                options=args_copy,
+                format=output_filetype.ogrdriver,
+                accessMode=None,
+                srcSRS=input_srs,
+                dstSRS=output_srs,
+                reproject=reproject,
+                SQLStatement=sql_stmt,
+                SQLDialect=sql_dialect,
+                where=where,
+                selectFields=None,
+                addFields=False,
+                forceNullable=False,
+                spatFilter=spatial_filter,
+                spatSRS=None,
+                datasetCreationOptions=datasetCreationOptions,
+                layerCreationOptions=layerCreationOptions,
+                layers=input_layers,
+                layerName=output_layer,
+                geometryType=output_geometrytypes,
+                dim=None,
+                segmentizeMaxDist=None,
+                zField=None,
+                skipFailures=False,
+                limit=None,
+                callback=None,
+                callback_data=None,
+            )
+
             result_ds = gdal.VectorTranslate(
-                destNameOrDestDS=str(output_path),
-                srcDS=str(input_path),
-                options=options,
+                destNameOrDestDS=str(output_path), srcDS=input_ds, options=options
             )
 
         # If there is CPL_LOG logging, write to standard logger as well, extract last
         # error and clean log file.
         cpl_error = None
         if errorlog_path.exists() and errorlog_path.stat().st_size > 0:
             with open(errorlog_path, "r+") as errorlog_file:
@@ -338,27 +381,28 @@
                 errorlog_file.truncate(0)  # size '0' when using r+
 
         # If the resulting datasource is None, something went wrong
         if result_ds is None:
             raise GFOError(f"result_ds is None ({cpl_error})")
 
         # If the output file is an empty shapefile and it was the result of a SQLITE sql
-        # statement, delete the "geom" column if it is present
+        # statement, delete the "geom" or "geometry" column if it is present
+        # gdal bug documented in https://github.com/geofileops/geofileops/issues/313
         if (
             sql_stmt is not None
             and sql_dialect == "SQLITE"
             and output_path.suffix.lower() == ".shp"
         ):
             assert isinstance(result_ds, gdal.Dataset)
             result_layer = result_ds.GetLayerByIndex(0)
             if result_layer.GetFeatureCount() == 0:
                 layer_defn = result_layer.GetLayerDefn()
                 for field_idx in range(layer_defn.GetFieldCount()):
                     field_name = layer_defn.GetFieldDefn(field_idx).GetName()
-                    if field_name.lower() == "geom":
+                    if field_name.lower() in ["geom", "geometry"]:
                         result_layer.DeleteField(field_idx)
                         break
 
         # Sometimes an invalid output file is written, so close and try to reopen it.
         result_ds = None
         if output_path.exists():
             try:
@@ -373,17 +417,18 @@
                 result_ds = None
 
     except Exception as ex:
         result_ds = None
         message = f"Error {ex} while creating {output_path}"
         if sql_stmt is not None:
             message = f"{message} using sql_stmt {sql_stmt}"
-        raise GFOError(message)
+        raise GFOError(message) from ex
     finally:
         result_ds = None
+        input_ds = None
 
     return True
 
 
 def _prepare_gdal_options(options: dict, split_by_option_type: bool = False) -> dict:
     """
     Prepares the options so they are ready to pass on to gdal.
```

### Comparing `geofileops-0.8.0a5/geofileops/util/_processing_util.py` & `geofileops-0.8.0a6/geofileops/util/_processing_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/_sqlite_util.py` & `geofileops-0.8.0a6/geofileops/util/_sqlite_util.py`

 * *Files 0% similar despite different names*

```diff
@@ -372,14 +372,15 @@
                 f"    '{output_layer}', 'geom', '{output_geometrytype.name}', 0, 0, "
                 f"    {to_string_for_sql(crs_epsg)});"
             conn.execute(sql)
             """
             columns_for_create = [
                 f'"{columnname}" {column_types[columnname]}\n'
                 for columnname in column_types
+                if columnname.lower() != "fid"
             ]
             sql = f"""
                 CREATE TABLE {output_databasename}."{output_layer}" (
                     fid INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
                     {", ".join(columns_for_create)}
                 )
             """
@@ -415,20 +416,31 @@
                     SELECT RecoverGeometryColumn(
                         '{output_layer}', 'geom',
                         {to_string_for_sql(crs_epsg)}, '{output_geometrytype.name}');
                 """
                 conn.execute(sql)
 
             # Insert data using the sql statement specified
-            columns_for_insert = [f'"{column[1]}"' for column in tmpcolumns]
-            sql = (
-                f'INSERT INTO {output_databasename}."{output_layer}" '
-                f'({", ".join(columns_for_insert)})\n{sql_stmt}'
-            )
-            conn.execute(sql)
+            try:
+                columns_for_insert = [f'"{column[1]}"' for column in tmpcolumns]
+                sql = (
+                    f'INSERT INTO {output_databasename}."{output_layer}" '
+                    f'({", ".join(columns_for_insert)})\n{sql_stmt}'
+                )
+                conn.execute(sql)
+            except Exception as ex:
+                ex_message = str(ex).lower()
+                if ex_message.startswith(
+                    "unique constraint failed:"
+                ) and ex_message.endswith(".fid"):
+                    ex.args = (
+                        f"{ex}: avoid this by not selecting or aliasing fid "
+                        '("select * will select fid!)',
+                    )
+                raise
 
             # Create spatial index if needed
             if create_spatial_index is True:
                 sql = f"SELECT UpdateLayerStatistics('{output_layer}', 'geom');"
                 conn.execute(sql)
                 if output_suffix_lower == ".gpkg":
                     # Create the necessary empty index, triggers,...
```

### Comparing `geofileops-0.8.0a5/geofileops/util/geodataframe_util.py` & `geofileops-0.8.0a6/geofileops/util/geodataframe_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/geofiletype.py` & `geofileops-0.8.0a6/geofileops/util/geofiletype.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/geofiletypes.csv` & `geofileops-0.8.0a6/geofileops/util/geofiletypes.csv`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/geometry_util.py` & `geofileops-0.8.0a6/geofileops/util/geometry_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -84,21 +84,16 @@
                 * string: lookup using case insensitive name
                 * GeometryType: create the same GeometryType as the one passed in
 
         Returns:
             [GeometryType]: The corresponding GeometryType.
         """
         if isinstance(value, str):
-            # If a string is passed in, try lookup based on case insensitive
-            # enum name
+            # If a string is passed in, try lookup based on case insensitive enum name
             return cls(GeometryType[value.upper()])
-        elif isinstance(value, GeometryType):
-            # If a Geometry type is passed in, return same GeometryType
-            # TODO: why create a new one?
-            return cls(value.value)
         # Default behaviour (= lookup based on value)
         return super()._missing_(value)
 
     @property
     def name_camelcase(self) -> str:
         """Get the name in camel case."""
         if self is GeometryType.POINT:
@@ -148,24 +143,45 @@
             return GeometryType.MULTILINESTRING
         elif self is GeometryType.POLYGON:
             return GeometryType.MULTIPOLYGON
         else:
             raise Exception(f"No multitype implemented for: {self}")
 
     @property
+    def to_singletype(self):
+        """Get the corresponding multitype."""
+        if self in [
+            GeometryType.GEOMETRY,
+            GeometryType.POINT,
+            GeometryType.LINESTRING,
+            GeometryType.POLYGON,
+        ]:
+            return self
+        elif self is GeometryType.MULTIPOINT:
+            return GeometryType.POINT
+        elif self is GeometryType.MULTILINESTRING:
+            return GeometryType.LINESTRING
+        elif self is GeometryType.MULTIPOLYGON:
+            return GeometryType.POLYGON
+        elif GeometryType.GEOMETRYCOLLECTION:
+            return GeometryType.GEOMETRY
+        else:
+            raise Exception(f"No multitype implemented for: {self}")
+
+    @property
     def to_primitivetype(self):
         """Get the corresponding primitive type."""
         if self in [GeometryType.POINT, GeometryType.MULTIPOINT]:
             return PrimitiveType.POINT
         elif self in [GeometryType.LINESTRING, GeometryType.MULTILINESTRING]:
             return PrimitiveType.LINESTRING
         elif self in [GeometryType.POLYGON, GeometryType.MULTIPOLYGON]:
             return PrimitiveType.POLYGON
-        elif self is GeometryType.GEOMETRYCOLLECTION:
-            raise Exception("Geometrycollection doesn't have a primitive type")
+        elif self in [GeometryType.GEOMETRY, GeometryType.GEOMETRYCOLLECTION]:
+            raise Exception(f"{self} doesn't have a primitive type")
         else:
             raise Exception(f"No primitive type implemented for {self}")
 
 
 class PrimitiveType(enum.Enum):
     """
     Enumeration of the different existing primitive types of a geometry.
@@ -173,33 +189,41 @@
 
     POINT = 1
     LINESTRING = 2
     POLYGON = 3
 
     @classmethod
     def _missing_(cls, value):
-        if value is None:
-            return None
-        elif isinstance(value, str):
+        if isinstance(value, str):
             return cls(PrimitiveType[value.upper()])
-        elif isinstance(value, PrimitiveType):
-            return cls(value.value)
         return super()._missing_(value)
 
     @property
     def to_multitype(self) -> GeometryType:
         """Get the corresponding multitype."""
         if self is PrimitiveType.POINT:
             return GeometryType.MULTIPOINT
         elif self is PrimitiveType.LINESTRING:
             return GeometryType.MULTILINESTRING
         elif self is PrimitiveType.POLYGON:
             return GeometryType.MULTIPOLYGON
         else:
-            raise Exception(f"No multitype implemented for: {self}")
+            raise Exception(f"no multitype implemented for: {self}")
+
+    @property
+    def to_singletype(self) -> GeometryType:
+        """Get the corresponding multitype."""
+        if self is PrimitiveType.POINT:
+            return GeometryType.POINT
+        elif self is PrimitiveType.LINESTRING:
+            return GeometryType.LINESTRING
+        elif self is PrimitiveType.POLYGON:
+            return GeometryType.POLYGON
+        else:
+            raise Exception(f"no singletype implemented for: {self}")
 
 
 def collection_extract(
     geometry: Optional[sh_geom.base.BaseGeometry], primitivetype: PrimitiveType
 ) -> Optional[sh_geom.base.BaseGeometry]:
     """
     Extracts the geometries from the input geom that comply with the
```

### Comparing `geofileops-0.8.0a5/geofileops/util/geoseries_util.py` & `geofileops-0.8.0a6/geofileops/util/geoseries_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/grid_util.py` & `geofileops-0.8.0a6/geofileops/util/grid_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops/util/test.gpkg` & `geofileops-0.8.0a6/geofileops/util/test.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/geofileops.egg-info/PKG-INFO` & `geofileops-0.8.0a6/geofileops.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: geofileops
-Version: 0.8.0a5
+Version: 0.8.0a6
 Summary: Package to do spatial operations on large geo files.
 Home-page: https://github.com/geofileops/geofileops
 Author: Pieter Roggemans
 Author-email: pieter.roggemans@gmail.com
 Classifier: Programming Language :: Python :: 3
 Classifier: Operating System :: OS Independent
 Requires-Python: >=3.8
```

### Comparing `geofileops-0.8.0a5/geofileops.egg-info/SOURCES.txt` & `geofileops-0.8.0a6/geofileops.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/setup.py` & `geofileops-0.8.0a6/setup.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/BEFL-kbl.gpkg` & `geofileops-0.8.0a6/tests/data/BEFL-kbl.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/geofileops_testdata.qgz` & `geofileops-0.8.0a6/tests/data/geofileops_testdata.qgz`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/linestring-row-trees.gpkg` & `geofileops-0.8.0a6/tests/data/linestring-row-trees.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/linestring-watercourse.gpkg` & `geofileops-0.8.0a6/tests/data/linestring-watercourse.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/linestrings_hedges.gpkg` & `geofileops-0.8.0a6/tests/data/linestrings_hedges.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/point.gpkg` & `geofileops-0.8.0a6/tests/data/point.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-invalid.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-invalid.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-no-rows.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-no-rows.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-all.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-all.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-one.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-one.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-overlappingcircles-two+three.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-overlappingcircles-two+three.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-parcel.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-parcel.gpkg`

 * *Files 2% similar despite different names*

#### sqlite3 {} .dump

```diff
@@ -2,15 +2,15 @@
 BEGIN TRANSACTION;
 CREATE TABLE gpkg_spatial_ref_sys (srs_name TEXT NOT NULL,srs_id INTEGER NOT NULL PRIMARY KEY,organization TEXT NOT NULL,organization_coordsys_id INTEGER NOT NULL,definition  TEXT NOT NULL,description TEXT);
 INSERT INTO gpkg_spatial_ref_sys VALUES('Undefined cartesian SRS',-1,'NONE',-1,'undefined','undefined cartesian coordinate reference system');
 INSERT INTO gpkg_spatial_ref_sys VALUES('Undefined geographic SRS',0,'NONE',0,'undefined','undefined geographic coordinate reference system');
 INSERT INTO gpkg_spatial_ref_sys VALUES('WGS 84 geodetic',4326,'EPSG',4326,'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]]','longitude/latitude coordinates in decimal degrees on the WGS 84 spheroid');
 INSERT INTO gpkg_spatial_ref_sys VALUES('Belge 1972 / Belgian Lambert 72',31370,'EPSG',31370,'PROJCS["Belge 1972 / Belgian Lambert 72",GEOGCS["Belge 1972",DATUM["Reseau_National_Belge_1972",SPHEROID["International 1924",6378388,297,AUTHORITY["EPSG","7022"]],TOWGS84[-106.8686,52.2978,-103.7239,0.3366,-0.457,1.8422,-1.2747],AUTHORITY["EPSG","6313"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4313"]],PROJECTION["Lambert_Conformal_Conic_2SP"],PARAMETER["standard_parallel_1",51.16666723333333],PARAMETER["standard_parallel_2",49.8333339],PARAMETER["latitude_of_origin",90],PARAMETER["central_meridian",4.367486666666666],PARAMETER["false_easting",150000.013],PARAMETER["false_northing",5400088.438],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["X",EAST],AXIS["Y",NORTH],AUTHORITY["EPSG","31370"]]',NULL);
 CREATE TABLE gpkg_contents (table_name TEXT NOT NULL PRIMARY KEY,data_type TEXT NOT NULL,identifier TEXT UNIQUE,description TEXT DEFAULT '',last_change DATETIME NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),min_x DOUBLE, min_y DOUBLE,max_x DOUBLE, max_y DOUBLE,srs_id INTEGER,CONSTRAINT fk_gc_r_srs_id FOREIGN KEY (srs_id) REFERENCES gpkg_spatial_ref_sys(srs_id));
-INSERT INTO gpkg_contents VALUES('parcels','features','parcels','','2022-03-25T23:56:11.288Z',155827.40624999991269,196287.625,156909.23437499991268,197117.9375,31370);
+INSERT INTO gpkg_contents VALUES('parcels','features','parcels','','2023-05-24T09:20:07.920Z',155827.40624999991269,196241.52968238599715,156909.23437499991268,197117.9375,31370);
 CREATE TABLE gpkg_ogr_contents(table_name TEXT NOT NULL PRIMARY KEY,feature_count INTEGER DEFAULT NULL);
 INSERT INTO gpkg_ogr_contents VALUES('parcels',46);
 CREATE TABLE gpkg_geometry_columns (table_name TEXT NOT NULL,column_name TEXT NOT NULL,geometry_type_name TEXT NOT NULL,srs_id INTEGER NOT NULL,z TINYINT NOT NULL,m TINYINT NOT NULL,CONSTRAINT pk_geom_cols PRIMARY KEY (table_name, column_name),CONSTRAINT uk_gc_table_name UNIQUE (table_name),CONSTRAINT fk_gc_tn FOREIGN KEY (table_name) REFERENCES gpkg_contents(table_name),CONSTRAINT fk_gc_srs FOREIGN KEY (srs_id) REFERENCES gpkg_spatial_ref_sys (srs_id));
 INSERT INTO gpkg_geometry_columns VALUES('parcels','geom','MULTIPOLYGON',31370,0,0);
 CREATE TABLE gpkg_tile_matrix_set (table_name TEXT NOT NULL PRIMARY KEY,srs_id INTEGER NOT NULL,min_x DOUBLE NOT NULL,min_y DOUBLE NOT NULL,max_x DOUBLE NOT NULL,max_y DOUBLE NOT NULL,CONSTRAINT fk_gtms_table_name FOREIGN KEY (table_name) REFERENCES gpkg_contents(table_name),CONSTRAINT fk_gtms_srs FOREIGN KEY (srs_id) REFERENCES gpkg_spatial_ref_sys (srs_id));
 CREATE TABLE gpkg_tile_matrix (table_name TEXT NOT NULL,zoom_level INTEGER NOT NULL,matrix_width INTEGER NOT NULL,matrix_height INTEGER NOT NULL,tile_width INTEGER NOT NULL,tile_height INTEGER NOT NULL,pixel_x_size DOUBLE NOT NULL,pixel_y_size DOUBLE NOT NULL,CONSTRAINT pk_ttm PRIMARY KEY (table_name, zoom_level),CONSTRAINT fk_tmm_table_name FOREIGN KEY (table_name) REFERENCES gpkg_contents(table_name));
 CREATE TABLE IF NOT EXISTS "parcels" ("fid" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, "geom" MULTIPOLYGON, "OIDN" INTEGER, "UIDN" INTEGER, "index" INTEGER, "HFDTLT" TEXT(20), "LBLHFDTLT" TEXT(64), "GEWASGROEP" TEXT(64), "PM" TEXT(20), "LBLPM" TEXT(64), "LENGTE" REAL, "OPPERVL" REAL, "DATUM" DATETIME);
@@ -18,15 +18,15 @@
 INSERT INTO parcels VALUES(2,X'475000038a7a0000008c4a6ab81003410000000090120341000000007cf7074100f31f5257fb07410106000000010000000103000000010000000c000000000000009012034100000000e0f9074100000000ac11034100000000b0f9074100c217a6e611034180e3a51b0bf8074100000000f011034100000000c8f70741000000008811034100000000a4f707410000000048110341000000007cf70741008c4a6ab810034100e3369aeffa074100c6dcb5c810034180832fccf3fa074100666666d411034180eb51b838fb07410014ae47dd11034180703d0a3bfb074100098a1f4c12034100f31f5257fb0741000000009012034100000000e0f90741',1183076,2318781,926371521,'201','Silomas','Mas',NULL,NULL,325.57999999999998408,3889.2899999999999634,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(3,X'475000038a7a000000d7a3706f15034100b81e859916034180d409e8fdf8074180c2f52804fc07410106000000010000000103000000010000000700000000b81e85991603410052b81e2ff9074100d5e76adf15034180d409e8fdf8074100d881f39515034100ed0dbedcfa074100d7a3706f15034100f6285cd9fb074100dfe08b7415034100470378dafb07410048e17a3416034180c2f52804fc074100b81e85991603410052b81e2ff90741',1214549,2350254,1322805972,'999','Niet nader omschreven gewas - kleine landbouwer','Overige gewassen',NULL,NULL,233.27000000000001024,2257.3499999999999091,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(4,X'475000038a7a00000014aec7ed14034100d5e76adf15034180158ccadaf8074100f6285cd9fb07410106000000010000000103000000010000000700000000068115d415034100abcf55fbf8074100a392ba4615034180158ccadaf807410014aec7ed1403418025e483bffb074100d7a3706f15034100f6285cd9fb074100d881f39515034100ed0dbedcfa074100d5e76adf15034180d409e8fdf8074100068115d415034100abcf55fbf80741',1025130,2520411,1317713371,'999','Niet nader omschreven gewas - kleine landbouwer','Overige gewassen',NULL,NULL,221.86000000000001364,1670.5799999999999272,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(5,X'475000038a7a000000e17a149214034100a392ba4615034100f6285cc1f807418025e483bffb07410106000000010000000103000000010000000600000000a392ba4615034180158ccadaf8074100713d0ad914034100f6285cc1f8074100e17a14921403410085eb51acfb074100bc9690eb14034180711b0dbffb07410014aec7ed1403418025e483bffb074100a392ba4615034180158ccadaf80741',1025888,2511273,1318227875,'999','Niet nader omschreven gewas - kleine landbouwer','Overige gewassen',NULL,NULL,212.8300000000000125,1198.2000000000000455,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(6,X'475000038a7a0000003d0ad73a1d0341007b14aeef21034100000000b20b084100d7a370ef0f08410106000000010000000103000000010000001b00000000666666da1f034100d7a370ef0f0841006666660020034100d7a370670f0841006666665620034100d7a370710f084100d7a3708f2103418047e17ac40f084100b98d06ac210341006c78fa110f08410085eb51b021034180c2f528f60e084100812642b721034100dbf9fed10e0841007f6abcbd21034180ec9e3cb00e0841008fc2f5c82103418047e17a660e0841005c8fc22921034100295c8f4c0e08410048e17ace20034100ae47e13a0e0841008fc2f5f620034100295c8f8e0d0841005c8fc2df21034180999999b30d0841007b14aeef2103410085eb510a0d0841005d6dc5681f034100f8c264640c084100613255811f034100eeebc0fb0b084100000000ea1d034100000000b20b084100000000461d034100000000e00e0841003d0ad73a1d0341000ad7a3f50e084100840d4faa1e034100d6c56d800f084100713d0ac71e03418014ae478b0f084100faedebe71e0341807aa5ac970f084100575bb1f51e034100f697dd9c0f08410041f163041f0341008d286da20f084100bf7d1d271f034180029a88af0f084100fd87f42e1f03410024287eb20f084100666666da1f034100d7a370ef0f0841',1269459,2559129,1534423802,'60','Grasland','Grasland','MAA','Maaien met afvoer',562.99000000000000909,13275.459999999999127,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(7,X'475000038a7a000000ec51b8ba14034100c3f528ca170341000ad7a380f7074100cdcccc44f907410106000000010000000103000000010000001600000000ae47e1b617034100ae47e1b2f8074100c3f528ca170341803d0ad725f8074100cdccccba170341000ad7a30cf8074100b81e85991703410033333307f807410085eb518017034180703d0a03f8074100b81e85af16034180666666daf70741007b14ae1916034180b81e85bff70741007b14aed515034100f6285cb3f7074100cdcccca215034100d7a370a9f70741005c8fc2d1140341000ad7a380f707410052b81ecf1403410052b81e9df7074100666666c41403410085eb5112f8074100ec51b8ba14034100295c8f7cf8074100adfadcdb14034180984c9582f80741006f8184f7140341809a779c87f80741004a7b034f15034180b81e8597f80741001f85eb5115034100a4703d98f80741006de77be815034100cac3c2bff8074100c3f528a2160341808fc2f5fdf8074100bf0e9cb6160341007e8cb903f9074100d7a3709d17034100cdcccc44f9074100ae47e1b617034100ae47e1b2f80741',1126056,2628034,1428843847,'60','Grasland','Grasland',NULL,NULL,262.17000000000001591,3299.3200000000001636,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(8,X'475000038a7a000000f6285c5d15034100000000561803418047e17a6c090841007b14aeb10c08410106000000010000000103000000010000000b000000000000005e160341000000008809084100ae47e10e1603418047e17a6c09084100f6285c5d150341005c8fc2c90b0841005227207515034100492e7fd30b084100ae47e13616034100ae47e1220c084100083d9b741603418023b97c3b0c084100faed6b2d17034180ed7c3f850c084100a4703d6817034180eb51b89c0c084100e17a14aa170341007b14aeb10c0841000000005618034100000000040a0841000000005e1603410000000088090841',1223118,2654183,902547210,'60','Grasland','Grasland','MAA','Maaien met afvoer',321.68000000000000681,6429.4499999999998179,'2020-05-01T00:00:00Z');
-INSERT INTO parcels VALUES(9,X'475000038a7a000000cac342f20d03410d0acdc4c512034180e17a149cfa07418422afa9f9fe07410106000000020000000103000000010000000f0000000035efb8560e0341007b142e9ffa074100f6285c4f0e034180e17a149cfa074100cac342f20d0341000de02db4fc0741007dd0331810034180ed7c3f34fd0741008fc2f58010034100cdcccc26fb074100f0a7467d100341808638d625fb0741004df30e7910034100c898bb24fb074100ffb27b381003410057ec2f13fb07410014ae472b100341809999990ffb074100cdccccce0f034180c2f528fafa074100143f46e30e034180537424c1fa074100a4703db60e034100a4703db6fa074100e71d27640e034180a44ec0a2fa07410017d9ce580e0341804df30ea0fa07410035efb8560e0341007b142e9ffa074101030000000100000005000000a13483123a11034107edad3145fc074168688dc0ac100341673cb400b3fe0741b2943ad8621203418422afa9f9fe07410d0acdc4c5120341d10df250bdfc0741a13483123a11034107edad3145fc0741',1043123,2661983,903492251,'60','Grasland','Grasland',NULL,NULL,277.89999999999997727,4816.5100000000002182,'2020-05-01T00:00:00Z');
+INSERT INTO parcels VALUES(9,X'475000038a7a0000d2bd0e788e0f0341dffd17fa611403416b1eca3c8cf407416f5ffed1e9f807410106000000020000000103000000010000000f000000d2283aeef20f0341ebb763568ff40741d2e97391eb0f03416b1eca3c8cf40741d2bd0e788e0f0341eb492f56a4f60741d2701b69b41103416b2acc6724f70741d2820d2b1d120341eb091cf516f50741d2e3f27b191203416bc387fe15f50741d2403e4415120341eb04e8e314f50741d2f2fdb0d4110341eb933b5803f50741d207f97cc71103416bd6e8c1fff40741d2c017026b1103416bff4451eaf40741d2078a7b7f1003416b90c34cb1f40741d297bb7252100341ebe0bf65a6f40741d2da685c001003416be19de892f40741d20a2404f50f03416b8a423790f40741d2283aeef20f0341ebb763568ff40741010300000001000000050000007328ce47d6120341f229fd5935f607413a5cd8f54812034152790329a3f807418488850dff1303416f5ffed1e9f80741dffd17fa61140341bc4a4179adf607417328ce47d6120341f229fd5935f60741',1043123,2661983,903492251,'60','Grasland','Grasland',NULL,NULL,277.89999999999997727,4816.5100000000002182,'2020-05-01T00:00:00.000Z');
 INSERT INTO parcels VALUES(10,X'475000038a7a000000b81e858b120341005917b79414034100a089b02102084100c05b20cb05084101060000000100000001030000000100000007000000005917b79414034180af03e7680208410062a1d66113034100a089b02102084100b81e858b120341801e85eb99050841006de77b1613034100925c7eaf05084100302a299e13034100728a8ec405084100daac7ac813034100c05b20cb050841005917b79414034180af03e768020841',819720,2680786,1118250756,'60','Grasland','Grasland',NULL,NULL,304.93999999999999773,4472.2399999999997819,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(11,X'475000038a7a000000daac7ac8130341000000009c15034180af03e76802084100ff21fdeb050841010600000001000000010300000001000000060000000068b3ea7b15034100bbb80d0f030841000000009c15034100000000a6020841005917b79414034180af03e76802084100daac7ac813034100c05b20cb050841007ac7299c14034100ff21fdeb0508410068b3ea7b15034100bbb80d0f030841',819719,2680787,1118250857,'60','Grasland','Grasland',NULL,NULL,281.32999999999998407,3330.6999999999998181,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(12,X'475000038a7a0000009a999923130341009a9999491603410085eb51b60708418047e17a6c09084101060000000100000001030000000100000008000000009a9999491603418047e17ab20808410014ae47a71303410085eb51b6070841006c09799213034100bada8af507084100e17a148813034100cdcccc0e08084100ec51b83e13034180703d0afb070841009a9999231303410085eb516e08084100ae47e10e1603418047e17a6c090841009a9999491603418047e17ab2080841',819684,2680790,1118251362,'60','Grasland','Grasland',NULL,NULL,249.06999999999999318,2454.2899999999999635,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(13,X'475000038a7a000000295c8f661303410014ae477b16034100295c8f260708418047e17ab20808410106000000010000000103000000010000000600000000295c8f6613034180e17a147e0708410014ae47a71303410085eb51b6070841009a9999491603418047e17ab20808410014ae477b1603410085eb51f007084100d7a3708113034100295c8f2607084100295c8f6613034180e17a147e070841',819683,2680791,1118251463,'60','Grasland','Grasland',NULL,NULL,235.71999999999999886,1972.7899999999999636,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(14,X'475000038a7a000000d7a3708113034100666666aa160341000000009c0608410085eb51f00708410106000000010000000103000000010000000a00000000666666aa16034100f6285c35070841008fc2f50a140341000000009c06084100b5157b0614034100000000a806084100a4703d0214034100f6285cb306084100d26fdffd13034180226c78b206084100e3369af9130341001ac05bb2060841008fc2f5a0130341803d0ad7b706084100d7a3708113034100295c8f260708410014ae477b1603410085eb51f007084100666666aa16034100f6285c35070841',1176958,2680792,1118251564,'60','Grasland','Grasland',NULL,NULL,238.40000000000000567,2147.1100000000001273,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(15,X'475000038a7a0000007ac7299c14034100d50968e217034100bbb80d0f03084100e10b93800608410106000000010000000103000000010000000700000000d50968e217034100d42b65b00308410068b3ea7b15034100bbb80d0f030841007ac7299c14034100ff21fdeb05084100ffb2fbdf160341008f53f46906084100a301bc4617034100e10b938006084100b81e85c517034100d7a3703704084100d50968e217034100d42b65b0030841',819681,2680793,1118251665,'60','Grasland','Grasland',NULL,NULL,354.62999999999999544,7822.1300000000001089,'2020-05-01T00:00:00Z');
 INSERT INTO parcels VALUES(16,X'475000038a7a00000014ae471f110341008fc2f56413034100cdcccc2c0708410085eb516e0808410106000000010000000103000000010000000c00000000ec51b83e13034180703d0afb070841008fc2f56413034100a4703de60708410092cbff1f12034180ce8852760708410048e17a4a11034100cdcccc2c07084100713d0a2b11034180eb51b88e070841005c8fc22711034180e17a14980708410031992a2511034180a60a46a107084100f0854923110341806054d2a90708410014ae471f110341808fc2f5c4070841001f85ebb5110341801e85ebf1070841009a9999231303410085eb516e08084100ec51b83e13034180703d0afb070841',1183240,2680794,1118251766,'60','Grasland','Grasland',NULL,NULL,179.18000000000000682,1295.4300000000000636,'2020-05-01T00:00:00Z');
@@ -108,15 +108,15 @@
 INSERT INTO rtree_parcels_geom_rowid VALUES(41,1);
 INSERT INTO rtree_parcels_geom_rowid VALUES(42,1);
 INSERT INTO rtree_parcels_geom_rowid VALUES(43,1);
 INSERT INTO rtree_parcels_geom_rowid VALUES(44,1);
 INSERT INTO rtree_parcels_geom_rowid VALUES(45,1);
 INSERT INTO rtree_parcels_geom_rowid VALUES(46,1);
 CREATE TABLE IF NOT EXISTS "rtree_parcels_geom_node"(nodeno INTEGER PRIMARY KEY,data);
-INSERT INTO rtree_parcels_geom_node VALUES(1,X'0000002e0000000000000001481883574818873a4840375548403ade0000000000000002481885c348189480483fbbe0483fdabb00000000000000034818ab7a4818b4cd483fc7ef483fe02300000000000000044818a76e4818aefd483fc6d6483fdecb00000000000000054818a48f4818aa36483fc609483fddfe00000000000000064818e9d648190f7f48405d9048407f7c00000000000000074818a5d54818be52483fbc05483fca2800000000000000084818aaea4818c2b048404b624840658f000000000000000948186f924818962f483fd4df483ff7cf000000000000000a4818945c4818a4a64840110c48402e5b000000000000000b48189e434818ace04840134748402f60000000000000000c4818991c4818b24d48403db148404b64000000000000000d48189b344818b3db4840393448404594000000000000000e48189c0a4818b554484034e048403f83000000000000000f4818a4e14818bf1448401878484034050000000000000010481888fa48189b28484039664840437300000000000000114818a0564818b70048402f20484039ab00000000000000124818c8714818ee27483fc760483fee8000000000000000134818ab014818d650483fe5154840026300000000000000144818ee034819038048403e0048405fe000000000000000154818da704818ef5048405a9f4840770000000000000000164818ba084818cc4a483fc597483fe720000000000000001748184afe48185af848402b104840404f00000000000000184818664448187fab48402d7848404958000000000000001948185b6648187adf48400c6a48403423000000000000001a4818582f48186a7b4840311e484043f6000000000000001b4818f6cf48191001483fd320483ff210000000000000001c4818e8204818fce1483fcf4a483ff3d0000000000000001d48188c4e48189b0f48400f2648402cd1000000000000001e48187e2a4818886f484024a248402aa6000000000000001f4818769548188db148403b2748404ff80000000000000020481887284818b07848403f8f48405e500000000000000021481890ff48189b84484035cb48403d910000000000000022481881c54818989848402b53484037fb00000000000000234818985048189cf248402d7a48403121000000000000002448187d9d481893d0484056c248407a9300000000000000254818d42c4818f4bd483feba44840061600000000000000264818ba354818c52048401d83484035da000000000000002748182cda48186260483fafe8483fd803000000000000002848191a2a4819267248404ff048405de200000000000000294819102648193b4f484052ca48407638000000000000002a48187be2481891a248400b584840180e000000000000002b4818781448188dd248401b4e48402786000000000000002c481879fd48188fb74840133948401f9c000000000000002d4818777048187f08484023144840278c000000000000002e481862ea48186eba4840475248405fad000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000');
+INSERT INTO rtree_parcels_geom_node VALUES(1,X'0000002e0000000000000001481883574818873a4840375548403ade0000000000000002481885c348189480483fbbe0483fdabb00000000000000034818ab7a4818b4cd483fc7ef483fe02300000000000000044818a76e4818aefd483fc6d6483fdecb00000000000000054818a48f4818aa36483fc609483fddfe00000000000000064818e9d648190f7f48405d9048407f7c00000000000000074818a5d54818be52483fbc05483fca2800000000000000084818aaea4818c2b048404b624840658f000000000000000a4818945c4818a4a64840110c48402e5b000000000000000b48189e434818ace04840134748402f60000000000000000c4818991c4818b24d48403db148404b64000000000000000d48189b344818b3db4840393448404594000000000000000e48189c0a4818b554484034e048403f83000000000000000f4818a4e14818bf1448401878484034050000000000000010481888fa48189b28484039664840437300000000000000114818a0564818b70048402f20484039ab00000000000000124818c8714818ee27483fc760483fee8000000000000000134818ab014818d650483fe5154840026300000000000000144818ee034819038048403e0048405fe000000000000000154818da704818ef5048405a9f4840770000000000000000164818ba084818cc4a483fc597483fe720000000000000001748184afe48185af848402b104840404f00000000000000184818664448187fab48402d7848404958000000000000001948185b6648187adf48400c6a48403423000000000000001a4818582f48186a7b4840311e484043f6000000000000001b4818f6cf48191001483fd320483ff210000000000000001c4818e8204818fce1483fcf4a483ff3d0000000000000001d48188c4e48189b0f48400f2648402cd1000000000000001e48187e2a4818886f484024a248402aa6000000000000001f4818769548188db148403b2748404ff80000000000000020481887284818b07848403f8f48405e500000000000000021481890ff48189b84484035cb48403d910000000000000022481881c54818989848402b53484037fb00000000000000234818985048189cf248402d7a48403121000000000000002448187d9d481893d0484056c248407a9300000000000000254818d42c4818f4bd483feba44840061600000000000000264818ba354818c52048401d83484035da000000000000002748182cda48186260483fafe8483fd803000000000000002848191a2a4819267248404ff048405de200000000000000294819102648193b4f484052ca48407638000000000000002a48187be2481891a248400b584840180e000000000000002b4818781448188dd248401b4e48402786000000000000002c481879fd48188fb74840133948401f9c000000000000002d4818777048187f08484023144840278c000000000000002e481862ea48186eba4840475248405fad000000000000000948187c734818a310483fa460483fc74f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000');
 CREATE TABLE IF NOT EXISTS "rtree_parcels_geom_parent"(nodeno INTEGER PRIMARY KEY,parentnode);
 DELETE FROM sqlite_sequence;
 INSERT INTO sqlite_sequence VALUES('parcels',46);
 CREATE TRIGGER 'gpkg_tile_matrix_zoom_level_insert' BEFORE INSERT ON 'gpkg_tile_matrix' FOR EACH ROW BEGIN SELECT RAISE(ABORT, 'insert on table ''gpkg_tile_matrix'' violates constraint: zoom_level cannot be less than 0') WHERE (NEW.zoom_level < 0); END;
 CREATE TRIGGER 'gpkg_tile_matrix_zoom_level_update' BEFORE UPDATE of zoom_level ON 'gpkg_tile_matrix' FOR EACH ROW BEGIN SELECT RAISE(ABORT, 'update on table ''gpkg_tile_matrix'' violates constraint: zoom_level cannot be less than 0') WHERE (NEW.zoom_level < 0); END;
 CREATE TRIGGER 'gpkg_tile_matrix_matrix_width_insert' BEFORE INSERT ON 'gpkg_tile_matrix' FOR EACH ROW BEGIN SELECT RAISE(ABORT, 'insert on table ''gpkg_tile_matrix'' violates constraint: matrix_width cannot be less than 1') WHERE (NEW.matrix_width < 1); END;
 CREATE TRIGGER 'gpkg_tile_matrix_matrix_width_update' BEFORE UPDATE OF matrix_width ON 'gpkg_tile_matrix' FOR EACH ROW BEGIN SELECT RAISE(ABORT, 'update on table ''gpkg_tile_matrix'' violates constraint: matrix_width cannot be less than 1') WHERE (NEW.matrix_width < 1); END;
```

### Comparing `geofileops-0.8.0a5/tests/data/polygon-simplify-onborder-testcase.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-simplify-onborder-testcase.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-twolayers.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-twolayers.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygon-zone.gpkg` & `geofileops-0.8.0a6/tests/data/polygon-zone.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygonstyle.qml` & `geofileops-0.8.0a6/tests/data/polygonstyle.qml`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/data/polygonstyle.sld` & `geofileops-0.8.0a6/tests/data/polygonstyle.sld`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/test_general_util.py` & `geofileops-0.8.0a6/tests/test_general_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/test_geofile.py` & `geofileops-0.8.0a6/tests/test_geofile.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,30 +1,27 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in geofileops.general.
 """
 
 import os
 from pathlib import Path
-import sys
 
 import geopandas as gpd
 import pandas as pd
 import pytest
 import shapely.geometry as sh_geom
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))  # noqa: E402
 import geofileops as gfo
 from geofileops import fileops
 from geofileops.util import geoseries_util
 from geofileops.util.geometry_util import GeometryType
 from geofileops.util import _io_util
 from tests import test_helper
-from tests.test_helper import DEFAULT_SUFFIXES
+from tests.test_helper import SUFFIXES
 from tests.test_helper import assert_geodataframe_equal
 
 
 ENGINES = ["fiona", "pyogrio"]
 
 
 @pytest.fixture(scope="module", params=ENGINES)
@@ -135,15 +132,15 @@
 
     # Append src file layer to dst file to new layer: "layer2"
     gfo.append_to(src_path, dst_path, dst_layer="layer2")
     dst_layer2_info = gfo.get_layerinfo(dst_path, "layer2")
     assert dst_layer1_info.featurecount == dst_layer2_info.featurecount
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_append_different_columns(tmp_path, suffix):
     src_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
     dst_path = tmp_path / f"dst{suffix}"
     gfo.copy(src_path, dst_path)
     gfo.add_column(src_path, name="extra_column", type=gfo.DataType.INTEGER)
@@ -153,51 +150,51 @@
     res_info = gfo.get_layerinfo(dst_path)
 
     # All rows are appended tot the dst layer, but the extra column is not!
     assert (src_info.featurecount * 2) == res_info.featurecount
     assert len(src_info.columns) == len(res_info.columns) + 1
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_cmp(tmp_path, suffix):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     src2 = test_helper.get_testfile("polygon-invalid", suffix=suffix)
 
     # Copy test file to tmpdir
     dst = tmp_path / f"polygons_parcels_output{suffix}"
     gfo.copy(src, dst)
 
     # Now compare source and dst files
     assert gfo.cmp(src, dst) is True
     assert gfo.cmp(src2, dst) is False
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_convert(tmp_path, suffix):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Convert
     dst = tmp_path / f"{src.stem}-output{suffix}"
-    gfo.convert(src, dst)
+    gfo.copy_layer(src, dst)
 
     # Now compare source and dst file
     src_layerinfo = gfo.get_layerinfo(src)
     dst_layerinfo = gfo.get_layerinfo(dst)
     assert src_layerinfo.featurecount == dst_layerinfo.featurecount
     assert len(src_layerinfo.columns) == len(dst_layerinfo.columns)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_convert_emptyfile(tmp_path, suffix):
     # Convert
     src = test_helper.get_testfile(
         "polygon-parcel", suffix=suffix, dst_dir=tmp_path, empty=True
     )
     dst = tmp_path / f"{src.stem}-output{suffix}"
-    gfo.convert(src, dst)
+    gfo.copy_layer(src, dst)
 
     # Now compare source and dst file
     assert dst.exists()
     src_layerinfo = gfo.get_layerinfo(src)
     dst_layerinfo = gfo.get_layerinfo(dst)
     assert src_layerinfo.featurecount == dst_layerinfo.featurecount
     assert len(src_layerinfo.columns) == len(dst_layerinfo.columns)
@@ -217,24 +214,24 @@
 def test_convert_force_output_geometrytype(tmp_path, testfile, force_geometrytype):
     # The conversion is done by ogr, and the "test" is rather written to
     # explore the behaviour of this ogr functionality
 
     # Convert testfile and force to force_geometrytype
     src = test_helper.get_testfile(testfile)
     dst = tmp_path / f"{src.stem}_to_{force_geometrytype}.gpkg"
-    gfo.convert(src, dst, force_output_geometrytype=force_geometrytype)
+    gfo.copy_layer(src, dst, force_output_geometrytype=force_geometrytype)
     assert gfo.get_layerinfo(dst).geometrytype == force_geometrytype
 
 
 def test_convert_invalid_params(tmp_path):
     # Convert
     src = tmp_path / "nonexisting_file.gpkg"
     dst = tmp_path / "output.gpkg"
     with pytest.raises(ValueError, match="src file doesn't exist: "):
-        gfo.convert(src, dst)
+        gfo.copy_layer(src, dst)
 
 
 @pytest.mark.parametrize(
     "src_suffix, dst_suffix, preserve_fid, exp_preserved_fids",
     [
         (".shp", ".gpkg", True, True),
         (".shp", ".gpkg", False, False),
@@ -251,34 +248,35 @@
     exp_preserved_fids: bool,
 ):
     src = test_helper.get_testfile("polygon-parcel", suffix=src_suffix)
 
     # Convert with preserve_fid=None (default)
     # ----------------------------------------
     dst = tmp_path / f"{src.stem}-output_preserve_fid-{preserve_fid}{dst_suffix}"
-    gfo.convert(src, dst, preserve_fid=preserve_fid)
+    gfo.copy_layer(src, dst, preserve_fid=preserve_fid)
 
     # Now compare source and dst file
     src_gdf = gfo.read_file(src, fid_as_index=True)
     dst_gdf = gfo.read_file(dst, fid_as_index=True)
     assert len(src_gdf) == len(dst_gdf)
     assert len(src_gdf.columns) == len(dst_gdf.columns)
     if exp_preserved_fids:
         assert src_gdf.index.tolist() == dst_gdf.index.tolist()
     else:
         assert src_gdf.index.tolist() != dst_gdf.index.tolist()
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-def test_convert_reproject(tmp_path, suffix):
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("src_crs", [None, 31370])
+def test_convert_reproject(tmp_path, suffix, src_crs):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Convert with reproject
     dst = tmp_path / f"{src.stem}-output_reproj4326{suffix}"
-    gfo.convert(src, dst, dst_crs=4326, reproject=True)
+    gfo.copy_layer(src, dst, src_crs=src_crs, dst_crs=4326, reproject=True)
 
     # Now compare source and dst file
     src_layerinfo = gfo.get_layerinfo(src)
     dst_layerinfo = gfo.get_layerinfo(dst)
     assert src_layerinfo.featurecount == dst_layerinfo.featurecount
     assert src_layerinfo.crs is not None
     assert src_layerinfo.crs.to_epsg() == 31370
@@ -292,15 +290,30 @@
         first_geom if isinstance(first_geom, sh_geom.Polygon) else first_geom.geoms[0]
     )
     assert first_poly.exterior is not None
     for x, y in first_poly.exterior.coords:
         assert x < 100 and y < 100
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_convert_where(tmp_path, suffix):
+    src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+
+    # Convert with where
+    dst = tmp_path / f"{src.stem}-output_where{suffix}"
+    gfo.copy_layer(src, dst, where="ST_Area({geometrycolumn}) > 500")
+
+    # Now compare source and dst file
+    src_layerinfo = gfo.get_layerinfo(src)
+    dst_layerinfo = gfo.get_layerinfo(dst)
+    assert src_layerinfo.featurecount > dst_layerinfo.featurecount
+    assert dst_layerinfo.featurecount == 43
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_copy(tmp_path, suffix):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Copy to dest file
     dst = tmp_path / f"{src.stem}-output{suffix}"
     gfo.copy(src, dst)
     assert src.exists()
@@ -347,15 +360,15 @@
 
     # Test getting a driver for a Path
     path = Path("/testje/path_naar_gfo.sQlItE")
     geofiletype = gfo.GeofileType(path)
     assert geofiletype == gfo.GeofileType.SQLite
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_drop_column(tmp_path, suffix):
     test_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
     original_info = gfo.get_layerinfo(test_path)
     assert "GEWASGROEP" in original_info.columns
     gfo.drop_column(test_path, "GEWASGROEP")
@@ -363,52 +376,52 @@
     assert len(original_info.columns) == len(new_info.columns) + 1
     assert "GEWASGROEP" not in new_info.columns
 
     # dropping column that doesn't exist doesn't give an error
     gfo.drop_column(test_path, "NOT_EXISTING_COLUMN")
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_get_crs(suffix):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     crs = gfo.get_crs(src)
     assert crs.to_epsg() == 31370
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_get_default_layer(suffix):
     # Prepare test data + test
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     layer = gfo.get_default_layer(src)
     assert layer == src.stem
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_get_layer_geometrytypes(suffix):
     # Prepare test data + test
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     geometrytypes = gfo.get_layer_geometrytypes(src)
     assert geometrytypes == ["POLYGON", "MULTIPOLYGON"]
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_get_layer_geometrytypes_empty(tmp_path, suffix):
     # Prepare test data + test
     src = test_helper.get_testfile(
         "polygon-parcel", suffix=suffix, dst_dir=tmp_path, empty=True
     )
     geometrytypes = gfo.get_layer_geometrytypes(src)
     assert geometrytypes == []
 
 
 def test_get_layer_geometrytypes_geometry(tmp_path):
     # Prepare test data + test
     src = test_helper.get_testfile("polygon-parcel", suffix=".gpkg")
     test_path = tmp_path / f"{src.stem}_geometry{src.suffix}"
-    gfo.convert(src, test_path, force_output_geometrytype="GEOMETRY")
+    gfo.copy_layer(src, test_path, force_output_geometrytype="GEOMETRY")
     assert gfo.get_layerinfo(test_path).geometrytypename == "GEOMETRY"
     geometrytypes = gfo.get_layer_geometrytypes(src)
     assert geometrytypes == ["POLYGON", "MULTIPOLYGON"]
 
 
 @pytest.mark.parametrize(
     "testfile, suffix, layer",
@@ -452,15 +465,15 @@
 
     # Multiple layers available, but no layer specified
     if len(gfo.listlayers(src)) > 1:
         with pytest.raises(ValueError, match="Layer has > 1 layer"):
             layerinfo = gfo.get_layerinfo(src)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_get_only_layer_one_layer(suffix):
     # Test Geopackage with 1 layer
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     layer = gfo.get_only_layer(src)
     if suffix == ".gpkg":
         assert layer == "parcels"
     else:
@@ -487,15 +500,15 @@
 
 def test_listlayers_errors():
     path = "not_existing_file.gpkg"
     with pytest.raises(RuntimeError, match=f"listlayers error for {path}"):
         _ = gfo.listlayers(path)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_listlayers_one_layer(suffix):
     # Test with 1 layer
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     layers = gfo.listlayers(src)
     if suffix == ".gpkg":
         assert layers[0] == "parcels"
     else:
@@ -506,15 +519,15 @@
     # Test geopackage with 2 layers
     src = test_helper.get_testfile("polygon-twolayers")
     layers = gfo.listlayers(src)
     assert "parcels" in layers
     assert "zones" in layers
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_move(tmp_path, suffix):
     src = test_helper.get_testfile("polygon-parcel", dst_dir=tmp_path, suffix=suffix)
 
     # Test
     dst = tmp_path / f"{src.stem}-output{suffix}"
     gfo.move(src, dst)
     assert src.exists() is False
@@ -583,15 +596,15 @@
 
     # Try to update column with invalid expression
     assert "not_existing column" not in layerinfo.columns
     with pytest.raises(RuntimeError, match="update_column error for"):
         gfo.update_column(test_path, name="OPPERVL", expression="invalid_expression")
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_read_file(suffix, engine_setter):
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Test with defaults
     read_gdf = gfo.read_file(src)
     assert isinstance(read_gdf, gpd.GeoDataFrame)
@@ -626,15 +639,15 @@
 def test_read_file_invalid_params(tmp_path, engine_setter):
     src = tmp_path / "nonexisting_file.gpkg"
 
     with pytest.raises(ValueError, match="file doesn't exist:"):
         _ = gfo.read_file(src)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_read_file_fid_as_index(suffix, engine_setter):
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # First read without fid_as_index=True
     read_gdf = gfo.read_file(src, rows=slice(5, 10))
     assert isinstance(read_gdf, pd.DataFrame)
@@ -650,15 +663,15 @@
     if gfo.GeofileType(src).is_fid_zerobased:
         assert read_gdf.index[0] == 5
     else:
         # Geopackage fid starts at 1
         assert read_gdf.index[0] == 6
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_read_file_sql(suffix, engine_setter):
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Test
     src_layerinfo = gfo.get_layerinfo(src)
     sql_stmt = f'SELECT * FROM "{src_layerinfo.name}"'
@@ -668,30 +681,30 @@
         return
 
     read_gdf = gfo.read_file(src, sql_stmt=sql_stmt)
     assert isinstance(read_gdf, gpd.GeoDataFrame)
     assert len(read_gdf) == 46
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_read_file_sql_deprecated(suffix, engine_setter):
     if engine_setter == "fiona":
         pytest.skip("sql_stmt param not supported for fiona engine")
 
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Test
     src_layerinfo = gfo.get_layerinfo(src)
     read_gdf = gfo.read_file_sql(src, sql_stmt=f'SELECT * FROM "{src_layerinfo.name}"')
     assert isinstance(read_gdf, gpd.GeoDataFrame)
     assert len(read_gdf) == 46
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_read_file_sql_no_geom(suffix, engine_setter):
     if engine_setter == "fiona":
         pytest.skip("sql_stmt param not supported for fiona engine")
 
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
@@ -700,15 +713,15 @@
     sql_stmt = f'SELECT count(*) AS aantal FROM "{src_layerinfo.name}"'
     read_df = gfo.read_file(src, sql_stmt=sql_stmt)
     assert isinstance(read_df, pd.DataFrame)
     assert len(read_df) == 1
     assert read_df.aantal.item() == 46
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize("columns", [["OIDN", "UIDN"], ["OidN", "UidN"]])
 def test_read_file_sql_placeholders(suffix, engine_setter, columns):
     """
     Test if placeholders are properly filled out + if casing used in columns parameter
     is retained when using placeholders.
     """
     if engine_setter == "fiona":
@@ -741,15 +754,15 @@
     assert len(read_gdf) == 5
 
     read_gdf = gfo.read_file(src, layer="parcels")
     assert isinstance(read_gdf, gpd.GeoDataFrame)
     assert len(read_gdf) == 46
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_rename_column(tmp_path, suffix):
     test_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
 
     # Check if input file is ok
     orig_layerinfo = gfo.get_layerinfo(test_path)
@@ -868,15 +881,15 @@
     with pytest.raises(ValueError, match="Unknown extension .unsupported"):
         _ = gfo.has_spatial_index(path, "layer")
 
     with pytest.raises(ValueError, match="Unknown extension .unsupported"):
         _ = gfo.remove_spatial_index(path, "layer")
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_spatial_index(tmp_path, suffix):
     test_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
     layer = gfo.get_only_layer(test_path)
 
     # Check if spatial index present
@@ -904,15 +917,15 @@
         qix_modified_time_orig = qix_path.stat().st_mtime
         gfo.create_spatial_index(path=test_path, layer=layer, exist_ok=True)
         assert qix_path.stat().st_mtime == qix_modified_time_orig
         gfo.create_spatial_index(path=test_path, layer=layer, force_rebuild=True)
         assert qix_path.stat().st_mtime > qix_modified_time_orig
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file(tmp_path, suffix, engine_setter):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     output_path = tmp_path / f"{src.stem}-output{suffix}"
 
     # Read test file and write to tmppath
     read_gdf = gfo.read_file(src)
     gfo.to_file(read_gdf, output_path)
@@ -922,15 +935,15 @@
 
     # Append the file again to tmppath
     gfo.to_file(read_gdf, output_path, append=True)
     written_gdf = gfo.read_file(output_path)
     assert 2 * len(read_gdf) == len(written_gdf)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file_append_to_unexisting_file(tmp_path, suffix, engine_setter):
     test_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
     test_gdf = gfo.read_file(test_path)
     dst_path = tmp_path / f"dst{suffix}"
     gfo.to_file(test_gdf, path=dst_path, append=True)
@@ -991,15 +1004,15 @@
 
     # Read test file and write to tmppath
     read_gdf = gfo.read_file(src)
     gfo.to_file(read_gdf, output_path, create_spatial_index=create_spatial_index)
     assert gfo.has_spatial_index(output_path) is expected_spatial_index
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file_emptyfile(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     input_layerinfo = gfo.get_layerinfo(input_path)
     read_gdf = gfo.read_file(input_path)
     empty_gdf = read_gdf.drop(read_gdf.index)
     assert isinstance(empty_gdf, gpd.GeoDataFrame)
@@ -1052,15 +1065,15 @@
     output_force_path = tmp_path / f"{input_path.stem}-output-force.gpkg"
     gfo.to_file(poly_gdf, output_force_path, force_multitype=True)
     output_force_info = gfo.get_layerinfo(output_force_path)
     assert output_force_info.featurecount == len(poly_gdf)
     assert output_force_info.geometrytype == GeometryType.MULTIPOLYGON
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file_geomempty(tmp_path, suffix, engine_setter):
     # Test for gdf with an empty polygon + a polygon
     test_gdf = gpd.GeoDataFrame(
         geometry=[  # type: ignore
             sh_geom.GeometryCollection(),
             test_helper.TestData.polygon_with_island,
         ]
@@ -1091,15 +1104,15 @@
         assert isinstance(test_read_gdf.geometry[1], sh_geom.Polygon)
 
         # So the geometrytype of the resulting GeoDataFrame is also POLYGON
         assert len(test_read_geometrytypes) == 1
         assert test_read_geometrytypes[0] is GeometryType.POLYGON
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file_geomnone(tmp_path, suffix, engine_setter):
     # Test for gdf with a None geometry + a polygon
     test_gdf = gpd.GeoDataFrame(
         geometry=[None, test_helper.TestData.polygon_with_island]  # type: ignore
     )
     test_geometrytypes = geoseries_util.get_geometrytypes(test_gdf.geometry)
     assert len(test_geometrytypes) == 1
@@ -1119,15 +1132,15 @@
         assert test_file_geometrytype == test_geometrytypes[0]
     # The result type in the geodataframe is also the same as originaly
     test_read_geometrytypes = geoseries_util.get_geometrytypes(test_read_gdf.geometry)
     assert len(test_gdf) == len(test_read_gdf)
     assert test_read_geometrytypes == test_geometrytypes
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_to_file_index(tmp_path, points_gdf, suffix, engine_setter):
     """Strongly based on similar test in geopandas."""
 
     class FileNumber(object):
         def __init__(self, tmpdir, base, ext):
             self.tmpdir = str(tmpdir)
             self.base = base
@@ -1286,15 +1299,15 @@
     do_checks(gdf, index_is_used=True)
 
     # named DatetimeIndex
     gdf.index.name = "datetime"
     do_checks(gdf, index_is_used=True)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_remove(tmp_path, suffix):
     # Prepare test data
     src = test_helper.get_testfile("polygon-parcel", dst_dir=tmp_path, suffix=suffix)
     assert src.exists()
 
     # Remove and check result
     gfo.remove(src)
```

### Comparing `geofileops-0.8.0a5/tests/test_geofileops_singlelayer_gpd.py` & `geofileops-0.8.0a6/tests/test_geofileops_singlelayer_gpd.py`

 * *Files 9% similar despite different names*

```diff
@@ -4,46 +4,142 @@
 """
 
 import json
 import math
 from pathlib import Path
 
 import geopandas as gpd
-import geopandas._compat as gpd_compat
+import pandas as pd
 import pytest
-
-if gpd_compat.USE_PYGEOS:
-    import pygeos as shapely2_or_pygeos
-else:
-    import shapely as shapely2_or_pygeos
 import shapely.geometry as sh_geom
 
 import geofileops as gfo
 from geofileops import GeometryType
-from geofileops.util import _geoops_gpd, grid_util
 from geofileops.util import geometry_util
+from geofileops.util import _geoops_gpd as geoops_gpd
+from geofileops.util import grid_util
 from tests import test_helper
-from tests.test_helper import DEFAULT_EPSGS, DEFAULT_SUFFIXES
+from tests.test_helper import (
+    EPSGS,
+    SUFFIXES,
+    TESTFILES,
+    WHERE_LENGTH_GT_1000,
+    WHERE_LENGTH_GT_200000,
+    WHERE_AREA_GT_5000,
+)
 
 
 def test_get_parallelization_params():
-    parallelization_params = _geoops_gpd.get_parallelization_params(500000)
+    parallelization_params = geoops_gpd.get_parallelization_params(500000)
     assert parallelization_params is not None
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("only_geom_input, gridsize", [(True, 0.0), (False, 0.001)])
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize(
+    "only_geom_input, gridsize, keep_empty_geoms, where",
+    [
+        (False, 0.0, True, "ST_Area({geometrycolumn}) > 70"),
+        (True, 0.01, False, None),
+    ],
+)
+def test_apply(tmp_path, suffix, only_geom_input, gridsize, keep_empty_geoms, where):
+    # Prepare test data
+    test_gdf = gpd.GeoDataFrame(
+        data=[
+            {"uidn": 1, "geometry": test_helper.TestData.polygon_small_island},
+            {"uidn": 2, "geometry": test_helper.TestData.polygon_with_island},
+        ],
+        crs=31370,  # type: ignore
+    )
+    input_path = tmp_path / f"polygons_small_holes_{suffix}"
+    gfo.to_file(test_gdf, input_path)
+    output_path = tmp_path / f"{input_path.stem}-output{suffix}"
+    input_layerinfo = gfo.get_layerinfo(input_path)
+    batchsize = math.ceil(input_layerinfo.featurecount / 2)
+
+    # Run test
+    if only_geom_input:
+        gfo.apply(
+            input_path=input_path,
+            output_path=output_path,
+            func=lambda geom: geometry_util.remove_inner_rings(
+                geometry=geom, min_area_to_keep=2, crs=input_layerinfo.crs
+            ),
+            only_geom_input=True,
+            gridsize=gridsize,
+            keep_empty_geoms=keep_empty_geoms,
+            where=where,
+            batchsize=batchsize,
+        )
+    else:
+        gfo.apply(
+            input_path=input_path,
+            output_path=output_path,
+            func=lambda row: geometry_util.remove_inner_rings(
+                row.geometry, min_area_to_keep=2, crs=input_layerinfo.crs
+            ),
+            only_geom_input=False,
+            gridsize=gridsize,
+            keep_empty_geoms=keep_empty_geoms,
+            where=where,
+            batchsize=batchsize,
+        )
+
+    # Now check if the output file is correctly created
+    assert output_path.exists()
+    assert gfo.has_spatial_index(output_path)
+
+    # Read result for some more detailed checks
+    output_gdf = gfo.read_file(output_path).sort_values("uidn").reset_index(drop=True)
+    output_layerinfo = gfo.get_layerinfo(output_path)
+
+    assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
+    assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+
+    # Number of rows depends on keep_empty_geoms and where
+    if where == "ST_Area({geometrycolumn}) > 70" and keep_empty_geoms:
+        assert output_layerinfo.featurecount == input_layerinfo.featurecount - 1
+    elif where is None and not keep_empty_geoms:
+        assert output_layerinfo.featurecount == input_layerinfo.featurecount
+    else:
+        raise ValueError(f"unsupported where in test: {where}")
+
+    for row in output_gdf.itertuples():
+        cur_geometry = row.geometry
+        assert cur_geometry is not None
+
+        # It should be a normal Polygon, but might be wrapped as MultiPolygon
+        if isinstance(cur_geometry, sh_geom.MultiPolygon):
+            assert len(cur_geometry.geoms) == 1
+            cur_geometry = cur_geometry.geoms[0]
+        assert isinstance(cur_geometry, sh_geom.Polygon)
+
+        if row.uidn == 1:
+            # In the 1st polygon the island must be removed
+            assert len(cur_geometry.interiors) == 0
+        elif row.uidn == 2:
+            # In the 2nd polygon the island is larger, so should be there
+            assert len(cur_geometry.interiors) == 1
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("only_geom_input", [False, True])
 @pytest.mark.parametrize("force_output_geometrytype", [None, GeometryType.POLYGON])
-def test_apply(tmp_path, suffix, only_geom_input, force_output_geometrytype, gridsize):
+def test_apply_None(tmp_path, suffix, only_geom_input, force_output_geometrytype):
+    """
+    Some tests regarding None geometries.
+
+    The test uses None geometries as input, but is similar to apply resulting in None.
+    """
     # Prepare test data
     test_gdf = gpd.GeoDataFrame(
-        geometry=[  # type: ignore
-            test_helper.TestData.polygon_small_island,
-            test_helper.TestData.polygon_with_island,
-            None,
+        data=[
+            {"id": 1, "geometry": test_helper.TestData.polygon_small_island},
+            {"id": 2, "geometry": test_helper.TestData.polygon_with_island},
+            {"id": 3, "geometry": None},
         ],
         crs=31370,  # type: ignore
     )
     input_path = tmp_path / f"polygons_small_holes_{suffix}"
     gfo.to_file(test_gdf, input_path)
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
@@ -54,46 +150,53 @@
             input_path=input_path,
             output_path=output_path,
             func=lambda geom: geometry_util.remove_inner_rings(
                 geometry=geom, min_area_to_keep=2, crs=input_layerinfo.crs
             ),
             only_geom_input=True,
             force_output_geometrytype=force_output_geometrytype,
-            gridsize=gridsize,
             batchsize=batchsize,
         )
     else:
         gfo.apply(
             input_path=input_path,
             output_path=output_path,
             func=lambda row: geometry_util.remove_inner_rings(
                 row.geometry, min_area_to_keep=2, crs=input_layerinfo.crs
             ),
             only_geom_input=False,
             force_output_geometrytype=force_output_geometrytype,
-            gridsize=gridsize,
             batchsize=batchsize,
         )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
+
+    # Read result for some more detailed checks
+    output_gdf = gfo.read_file(output_path).sort_values("id").reset_index(drop=True)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert input_layerinfo.featurecount == (output_layerinfo.featurecount + 1)
+
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
-    if force_output_geometrytype is None or suffix == ".shp":
+    if force_output_geometrytype is None:
+        # The first partial file during calculation to be completed has None geometry,
+        # so file is created with GEOMETRY type.
+        pass
+    elif force_output_geometrytype is None or suffix == ".shp":
         assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
     else:
         assert output_layerinfo.geometrytype == GeometryType.POLYGON
 
-    # Read result for some more detailed checks
-    output_gdf = gfo.read_file(output_path)
     for index in range(0, 2):
         output_geometry = output_gdf["geometry"][index]
-        assert output_geometry is not None
+        if index == 2:
+            assert output_geometry is None
+            continue
+        else:
+            assert output_geometry is not None
         if isinstance(output_geometry, sh_geom.MultiPolygon):
             assert len(output_geometry.geoms) == 1
             output_geometry = output_geometry.geoms[0]
         assert isinstance(output_geometry, sh_geom.Polygon)
 
         if index == 0:
             # In the 1st polygon the island must be removed
@@ -101,15 +204,15 @@
         elif index == 1:
             # In the 2nd polygon the island is larger, so should be there
             assert len(output_geometry.interiors) == 1
 
 
 def test_apply_geooperation_invalid_operation(tmp_path):
     with pytest.raises(ValueError, match="operation not supported: INVALID"):
-        _geoops_gpd._apply_geooperation(
+        geoops_gpd._apply_geooperation(
             input_path=test_helper.get_testfile("polygon-parcel"),
             output_path=tmp_path / "output.gpkg",
             operation="INVALID",  # type: ignore
             operation_params={},
         )
 
 
@@ -164,19 +267,27 @@
     # Read result for some more detailed checks
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
     area_square_buffer = sum(output_gdf.area)
     assert area_square_buffer > area_default_buffer
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize(
-    "epsg, gridsize, explodecollections", [(31370, 0.001, True), (4326, 0.0, False)]
+    "epsg, gridsize, explodecollections, where",
+    [
+        (31370, 0.001, True, WHERE_LENGTH_GT_1000),
+        (31370, 0.001, False, WHERE_LENGTH_GT_200000),
+        (31370, 0.001, True, ""),
+        (4326, 0.0, False, None),
+    ],
 )
-def test_dissolve_linestrings(tmp_path, suffix, epsg, gridsize, explodecollections):
+def test_dissolve_linestrings(
+    tmp_path, suffix, epsg, gridsize, explodecollections, where
+):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "linestring-watercourse", suffix=suffix, epsg=epsg
     )
     output_basepath = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
@@ -186,42 +297,56 @@
         output_basepath.parent / f"{output_basepath.stem}_expl{output_basepath.suffix}"
     )
     gfo.dissolve(
         input_path=input_path,
         output_path=output_path,
         explodecollections=explodecollections,
         gridsize=gridsize,
+        where=where,
         batchsize=batchsize,
     )
 
     # Check if the result file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    if explodecollections:
-        assert output_layerinfo.featurecount == 83
-    else:
-        assert output_layerinfo.featurecount == 1
     assert output_layerinfo.geometrytype in [
         GeometryType.LINESTRING,
         GeometryType.MULTILINESTRING,
     ]
     assert len(output_layerinfo.columns) >= 0
 
-    # Now check the contents of the result file
+    if explodecollections:
+        if where is None or where == "":
+            assert output_layerinfo.featurecount == 83
+        elif where == WHERE_LENGTH_GT_1000:
+            assert output_layerinfo.featurecount == 13
+        else:
+            raise ValueError(f"check for where {where} not implemented")
+    else:
+        if where is None or where == "":
+            assert output_layerinfo.featurecount == 1
+        elif where == WHERE_LENGTH_GT_200000:
+            assert output_layerinfo.featurecount == 0
+            # Output empty, so nothing more to check
+            return
+        else:
+            raise ValueError(f"check for where {where} not implemented")
+
+    # Check the contents of the result file
     input_gdf = gfo.read_file(input_path)
     output_gdf = gfo.read_file(output_path)
     assert input_gdf.crs == output_gdf.crs
     assert len(output_gdf) == output_layerinfo.featurecount
     assert output_gdf["geometry"][0] is not None
     # TODO: add more in depth check of result
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("epsg", DEFAULT_EPSGS)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("epsg", EPSGS)
 def test_dissolve_linestrings_groupby(tmp_path, suffix, epsg):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "linestring-watercourse", suffix=suffix, epsg=epsg
     )
     output_basepath = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
@@ -256,16 +381,16 @@
     output_gdf = gfo.read_file(output_path)
     assert input_gdf.crs == output_gdf.crs
     assert len(output_gdf) == output_layerinfo.featurecount
     assert output_gdf["geometry"][0] is not None
     # TODO: add more in depth check of result
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("epsg", DEFAULT_EPSGS)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("epsg", EPSGS)
 def test_dissolve_linestrings_aggcolumns_columns(tmp_path, suffix, epsg):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "linestring-watercourse", suffix=suffix, epsg=epsg
     )
     output_basepath = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
@@ -390,28 +515,36 @@
         assert len(json_value[0]) == len(input_layerinfo.columns) + 1
     else:
         # fid_orig is added to json
         assert len(json_value[0]) == len(agg_columns["json"]) + 1
 
 
 @pytest.mark.parametrize(
-    "suffix, epsg, groupby_columns, explode, gridsize, expected_featurecount",
+    "suffix, epsg, groupby_columns, explode, gridsize, where, expected_featurecount",
     [
-        (".gpkg", 31370, ["GEWASGROEP"], True, 0.0, 25),
-        (".gpkg", 31370, ["GEWASGROEP"], False, 0.0, 6),
-        (".gpkg", 31370, ["gewasGROEP"], False, 0.01, 6),
-        (".gpkg", 31370, [], True, 0.0, 23),
-        (".gpkg", 31370, None, False, 0.0, 1),
-        (".gpkg", 4326, ["GEWASGROEP"], True, 0.0, 25),
-        (".shp", 31370, ["GEWASGROEP"], True, 0.0, 25),
-        (".shp", 31370, [], True, 0.0, 23),
+        (".gpkg", 31370, ["GEWASGROEP"], True, 0.0, "", 25),
+        (".gpkg", 31370, ["GEWASGROEP"], False, 0.0, "", 6),
+        (".gpkg", 31370, ["gewasGROEP"], False, 0.01, WHERE_AREA_GT_5000, 4),
+        (".gpkg", 31370, ["gewasGROEP"], True, 0.01, WHERE_AREA_GT_5000, 13),
+        (".gpkg", 31370, [], True, 0.0, None, 23),
+        (".gpkg", 31370, None, False, 0.0, None, 1),
+        (".gpkg", 4326, ["GEWASGROEP"], True, 0.0, None, 25),
+        (".shp", 31370, ["GEWASGROEP"], True, 0.0, None, 25),
+        (".shp", 31370, [], True, 0.0, None, 23),
     ],
 )
 def test_dissolve_polygons(
-    tmp_path, suffix, epsg, groupby_columns, explode, gridsize, expected_featurecount
+    tmp_path,
+    suffix,
+    epsg,
+    groupby_columns,
+    explode,
+    gridsize,
+    where,
+    expected_featurecount,
 ):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix, epsg=epsg)
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
 
     # Test dissolve polygons with different options for groupby and explodecollections
@@ -421,14 +554,15 @@
     output_path = tmp_path / f"{name}{suffix}"
     gfo.dissolve(
         input_path=input_path,
         output_path=output_path,
         groupby_columns=groupby_columns,
         explodecollections=explode,
         gridsize=gridsize,
+        where=where,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Now check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
@@ -448,67 +582,88 @@
     # Now check the contents of the result file
     input_gdf = gfo.read_file(input_path)
     output_gdf = gfo.read_file(output_path)
     assert input_gdf.crs == output_gdf.crs
     assert len(output_gdf) == output_layerinfo.featurecount
     assert output_gdf["geometry"][0] is not None
 
-    # Compare result with geopandas
+    # Compare result expected values using geopandas
     columns = ["geometry"]
     if groupby_columns is None or len(groupby_columns) == 0:
-        output_gpd_gdf = input_gdf[columns].dissolve()  # type: ignore
+        expected_gdf = input_gdf[columns].dissolve()  # type: ignore
     else:
         groupby_columns_upper = {column.upper(): column for column in groupby_columns}
         columns += list(groupby_columns_upper)
-        output_gpd_gdf = (
+        expected_gdf = (
             input_gdf[columns]
             .dissolve(by=list(groupby_columns_upper))  # type: ignore
             .reset_index()
         ).rename(columns=groupby_columns_upper)
-    if explode:
-        output_gpd_gdf = output_gpd_gdf.explode(ignore_index=True)
-    if gridsize != 0.0:
-        output_gpd_gdf.geometry = shapely2_or_pygeos.set_precision(
-            output_gpd_gdf.geometry.array.data, grid_size=gridsize
-        )
-    output_gpd_path = tmp_path / f"{input_path.stem}_gpd-output{suffix}"
-    gfo.to_file(output_gpd_gdf, output_gpd_path)
+    expected_gdf = test_helper.prepare_expected_result(
+        expected_gdf,
+        explodecollections=explode,
+        gridsize=gridsize,
+        keep_empty_geoms=False,
+        where=where,
+    )
+    expected_path = tmp_path / f"{input_path.stem}_gpd-output{suffix}"
+    gfo.to_file(expected_gdf, expected_path)
 
     # Small differences with the geopandas result are expected, because gfo
     # adds points in the tiling process. So only basic checks possible.
+    # output_gdf.geometry = output_gdf.geometry.simplify(0.1)
+    # expected_gdf.geometry = expected_gdf.geometry.simplify(0.1)
     # assert_geodataframe_equal(
-    #        output_gdf, output_gpd_gdf, promote_to_multi=True, sort_values=True,
-    #        normalize=True, check_less_precise=True, output_dir=tmp_path)
+    #     output_gdf, expected_gdf, promote_to_multi=True, sort_values=True,
+    #     normalize=True, check_less_precise=True
+    # )
     if suffix != ".shp":
         # Shapefile needs at least one column, if no columns: fid
-        assert list(output_gdf.columns) == list(output_gpd_gdf.columns)
-    assert len(output_gdf) == len(output_gpd_gdf)
+        assert list(output_gdf.columns) == list(expected_gdf.columns)
+    assert len(output_gdf) == len(expected_gdf)
+    output_area = output_gdf.geometry.area.sort_values().reset_index(drop=True)
+    expected_area = expected_gdf.geometry.area.sort_values().reset_index(drop=True)
+    pd.testing.assert_series_equal(output_area, expected_area)
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-def test_dissolve_emptyfile(tmp_path, suffix):
+@pytest.mark.parametrize("explodecollections", [True, False])
+@pytest.mark.parametrize("testfile", TESTFILES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_dissolve_emptyfile(tmp_path, testfile, suffix, explodecollections):
     # Prepare test data
-    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix, empty=True)
+    input_path = test_helper.get_testfile(testfile, suffix=suffix, empty=True)
 
     # Test dissolve polygons with different options for groupby and explodecollections
     output_path = tmp_path / f"{input_path.stem}_dissolve-emptyfile{suffix}"
-    groupby_columns = ["GEWASGROEP"]
+    if testfile == "polygon-parcel":
+        groupby_columns = ["GEWASGROEP"]
+        expected_geometrytype = GeometryType.POLYGON
+    elif testfile == "linestring-row-trees":
+        groupby_columns = ["rowtype"]
+        expected_geometrytype = GeometryType.LINESTRING
+    elif testfile == "point":
+        groupby_columns = ["type"]
+        expected_geometrytype = GeometryType.POINT
+    else:
+        raise ValueError(f"unimplimentd testfile: {testfile}")
+    if not explodecollections or suffix == ".shp":
+        expected_geometrytype = expected_geometrytype.to_multitype
+
     gfo.dissolve(
         input_path=input_path,
         output_path=output_path,
-        explodecollections=True,
+        explodecollections=explodecollections,
         groupby_columns=groupby_columns,
     )
 
     # Now check if the tmp file is correctly created
     assert output_path.exists()
-    input_layerinfo = gfo.get_layerinfo(input_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 0
-    assert output_layerinfo.geometrytype == input_layerinfo.geometrytype
+    assert output_layerinfo.geometrytype == expected_geometrytype
     assert list(output_layerinfo.columns) == groupby_columns
 
 
 @pytest.mark.parametrize("sql_singlethread", [True, False])
 @pytest.mark.parametrize(
     "exp_match, invalid_params",
     [
@@ -621,15 +776,15 @@
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
     assert (
         output_layerinfo.columns["none_values"].gdal_type
         == input_layerinfo.columns["none_values"].gdal_type
     )
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_dissolve_polygons_specialcases(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     output_basepath = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
 
@@ -667,75 +822,87 @@
         # Now check the contents of the result file
         input_gdf = gfo.read_file(input_path)
         output_gdf = gfo.read_file(output_path)
         assert input_gdf.crs == output_gdf.crs
         assert len(output_gdf) == output_layerinfo.featurecount
         assert output_gdf["geometry"][0] is not None
 
-    # Test dissolve polygons with tiles_path
-    # --------------------------------------
-    output_path = (
-        output_basepath.parent
-        / f"{output_basepath.stem}_tilespath{output_basepath.suffix}"
-    )
-    tiles_path = output_basepath.parent / "tiles.gpkg"
-    tiles_gdf = grid_util.create_grid2(
-        input_layerinfo.total_bounds, nb_squarish_tiles=4, crs=31370
+    # Test dissolve to existing output path without and without force
+    # ---------------------------------------------------------------
+    for force in [True, False]:
+        assert output_path.exists() is True
+        mtime_orig = output_path.stat().st_mtime
+        gfo.dissolve(
+            input_path=input_path,
+            output_path=output_path,
+            explodecollections=True,
+            nb_parallel=2,
+            batchsize=batchsize,
+            force=force,
+        )
+        if force is False:
+            assert output_path.stat().st_mtime == mtime_orig
+        else:
+            assert output_path.stat().st_mtime != mtime_orig
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_dissolve_polygons_tiles_empty(tmp_path, suffix):
+    # Prepare test data
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+    input_layerinfo = gfo.get_layerinfo(input_path)
+    batchsize = math.ceil(input_layerinfo.featurecount / 2)
+    output_path = tmp_path / f"{input_path.stem}-tilesoutput{suffix}"
+    tiles_path = tmp_path / "tiles.gpkg"
+
+    # Make the bounds large enough so there are also empty tiles
+    bounds = input_layerinfo.total_bounds
+    width = bounds[2] - bounds[0]
+    bounds = (
+        bounds[0] - 1,
+        bounds[1] - 1,
+        bounds[2] + 1 + width,
+        bounds[3] + 1,
     )
+    tiles_gdf = grid_util.create_grid2(bounds, nb_squarish_tiles=8, crs=31370)
     gfo.to_file(tiles_gdf, tiles_path)
+
+    # Test!
     gfo.dissolve(
         input_path=input_path,
         output_path=output_path,
         tiles_path=tiles_path,
         explodecollections=False,
         nb_parallel=2,
         batchsize=batchsize,
         force=True,
     )
 
     # Now check if the result file is correctly created
     assert output_path.exists()
+    input_gdf = gfo.read_file(input_path)
+    output_gdf = gfo.read_file(output_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 4
-    if output_basepath.suffix == ".shp":
+    if suffix == ".shp":
         # Shapefile always has an FID field
         # but only if there is no other column???
         # TODO: think about whether this should also be the case for geopackage???
         assert len(output_layerinfo.columns) == 1
     else:
         assert len(output_layerinfo.columns) == 1
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
-    input_gdf = gfo.read_file(input_path)
-    output_gdf = gfo.read_file(output_path)
     assert input_gdf.crs == output_gdf.crs
     assert len(output_gdf) == output_layerinfo.featurecount
     assert output_gdf["geometry"][0] is not None
 
-    # Test dissolve to existing output path without and without force
-    # ---------------------------------------------------------------
-    for force in [True, False]:
-        assert output_path.exists() is True
-        mtime_orig = output_path.stat().st_mtime
-        gfo.dissolve(
-            input_path=input_path,
-            output_path=output_path,
-            explodecollections=True,
-            nb_parallel=2,
-            batchsize=batchsize,
-            force=force,
-        )
-        if force is False:
-            assert output_path.stat().st_mtime == mtime_orig
-        else:
-            assert output_path.stat().st_mtime != mtime_orig
-
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_dissolve_polygons_aggcolumns_columns(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
     output_basepath = tmp_path / f"{input_path.stem}-output{suffix}"
```

### Comparing `geofileops-0.8.0a5/tests/test_geofileops_singlelayer_ogr.py` & `geofileops-0.8.0a6/tests/test_geofileops_singlelayer_ogr.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,26 +1,21 @@
 # -*- coding: utf-8 -*-
 """
 Tests for operations using GeoPandas.
 """
 
-from pathlib import Path
-import sys
-
 import pytest
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 import geofileops as gfo
 from geofileops import GeometryType
 from tests import test_helper
-from tests.test_helper import DEFAULT_SUFFIXES
+from tests.test_helper import SUFFIXES
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_clip_by_geometry(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Do operation
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     clip_wkt = (
@@ -41,15 +36,15 @@
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_export_by_bounds(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Do operation
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     filter = (156036, 196691, 156368, 196927)
```

### Comparing `geofileops-0.8.0a5/tests/test_geofileops_singlelayer_sql.py` & `geofileops-0.8.0a6/tests/test_geofileops_singlelayer_sql.py`

 * *Files 7% similar despite different names*

```diff
@@ -13,17 +13,17 @@
     import pygeos as shapely2_or_pygeos
 else:
     import shapely as shapely2_or_pygeos
 from shapely.geometry import MultiPolygon, Polygon
 
 import geofileops as gfo
 from geofileops import GeometryType
-from geofileops.util import _geoops_sql
+from geofileops.util import _geoops_sql as geoops_sql
 from tests import test_helper
-from tests.test_helper import DEFAULT_EPSGS, DEFAULT_SUFFIXES
+from tests.test_helper import EPSGS, SUFFIXES
 from tests.test_helper import assert_geodataframe_equal
 
 
 @pytest.mark.parametrize("gridsize", [0.0, 0.1])
 def test_delete_duplicate_geometries(tmp_path, gridsize):
     # Prepare test data
     test_gdf = gpd.GeoDataFrame(
@@ -64,33 +64,33 @@
 def test_dissolve_singlethread_output_exists(tmp_path):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel")
     output_path = tmp_path / f"{input_path.stem}-output{input_path.suffix}"
     output_path.touch()
 
     # Run test without force
-    _geoops_sql.dissolve_singlethread(
+    geoops_sql.dissolve_singlethread(
         input_path=input_path,
         output_path=output_path,
     )
     assert output_path.exists()
     assert output_path.stat().st_size == 0
 
     # Run test with force
-    _geoops_sql.dissolve_singlethread(
+    geoops_sql.dissolve_singlethread(
         input_path=input_path,
         output_path=output_path,
         force=True,
     )
     assert output_path.exists()
     assert output_path.stat().st_size != 0
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("epsg", DEFAULT_EPSGS)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("epsg", EPSGS)
 def test_isvalid(tmp_path, suffix, epsg):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "polygon-invalid", dst_dir=tmp_path, suffix=suffix, epsg=epsg
     )
 
     # Now run test
@@ -124,15 +124,15 @@
     assert len(input_layerinfo.columns) == len(result_auto_layerinfo.columns) - 2
 
     output_auto_gdf = gfo.read_file(output_auto_path)
     assert output_auto_gdf["geometry"][0] is not None
     assert output_auto_gdf["isvalid"][0] == 0
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize("input_empty", [True, False])
 def test_makevalid(tmp_path, suffix, input_empty):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "polygon-invalid", suffix=suffix, empty=input_empty
     )
 
@@ -241,29 +241,27 @@
             input_path="abc",
             output_path="def",
             gridsize=1,
             precision=1,
         )
 
 
-@pytest.mark.parametrize("input_suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("output_suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize("gridsize", [0.0, 0.01])
-def test_select(tmp_path, input_suffix, output_suffix, gridsize):
+def test_select(tmp_path, suffix, gridsize):
     # Prepare test data
-    input_path = test_helper.get_testfile("polygon-parcel", suffix=input_suffix)
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Now run test
-    name = f"{input_path.stem}-{input_suffix.replace('.', '')}-output{output_suffix}"
-    output_path = tmp_path / name
+    output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     layerinfo_input = gfo.get_layerinfo(input_path)
+    sql_stmt = 'SELECT {geometrycolumn}, "oidn", "UIDN" FROM "{input_layer}"'
     # Column casing seems to behave odd: without gridsize (=subselect) results in upper
     # casing rgardless of quotes or not, with gridsize (=subselect) casing in select is
     # retained in output.
-    sql_stmt = 'SELECT {geometrycolumn}, "oidn", "UIDN" FROM "{input_layer}"'
     gfo.select(
         input_path=input_path,
         output_path=output_path,
         sql_stmt=sql_stmt,
         gridsize=gridsize,
     )
 
@@ -277,15 +275,15 @@
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_select_column_casing(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", tmp_path, suffix)
 
     # Check if columns parameter works (case insensitive)
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     columns = ["OIDN", "uidn", "HFDTLT", "lblhfdtlt", "GEWASGROEP", "lengte", "OPPERVL"]
@@ -307,16 +305,16 @@
     assert "uidn" in layerinfo_select.columns
     assert len(layerinfo_select.columns) == len(columns)
 
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
-@pytest.mark.parametrize("input_suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("output_suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("input_suffix", SUFFIXES)
+@pytest.mark.parametrize("output_suffix", SUFFIXES)
 def test_select_emptyinput(tmp_path, input_suffix, output_suffix):
     # Prepare test data
     input_path = test_helper.get_testfile(
         "polygon-parcel", suffix=input_suffix, dst_dir=tmp_path, empty=True
     )
     input_layerinfo = gfo.get_layerinfo(input_path)
     assert input_layerinfo.featurecount == 0
@@ -328,25 +326,25 @@
     sql_stmt = 'SELECT {geometrycolumn}, oidn, uidn FROM "{input_layer}"'
 
     gfo.select(input_path=input_path, output_path=output_path, sql_stmt=sql_stmt)
 
     # Now check if the tmp file is correctly created
     layerinfo_output = gfo.get_layerinfo(output_path)
     assert layerinfo_output.featurecount == 0
-    assert "OIDN" in layerinfo_output.columns
-    assert "UIDN" in layerinfo_output.columns
+    assert "oidn" in layerinfo_output.columns
+    assert "uidn" in layerinfo_output.columns
     assert len(layerinfo_output.columns) == 2
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
 
 @pytest.mark.parametrize(
     "input_suffix, output_suffix",
     [
         (".gpkg", ".gpkg"),
-        # (".gpkg", ".shp"),
+        (".gpkg", ".shp"),
         (".shp", ".gpkg"),
         (".shp", ".shp"),
     ],
 )
 def test_select_emptyinput_operation(tmp_path, input_suffix, output_suffix):
     """
     A select with a geometry operation (eg. buffer,...) on an empty input file should
@@ -361,47 +359,84 @@
     assert input_layerinfo.featurecount == 0
 
     # Test with complex select: with geometry operation
     # -------------------------------------------------
     output_stem = f"{input_path.stem}-{input_suffix.replace('.', '')}-complex"
     output_path = tmp_path / f"{output_stem}{output_suffix}"
     sql_stmt = """
-        SELECT st_buffer({geometrycolumn}, 1, 5) as geom, oidn, uidn
+        SELECT st_buffer({geometrycolumn}, 1, 5) as {geometrycolumn}, oidn, uidn
           FROM "{input_layer}"
     """
     gfo.select(input_path=input_path, output_path=output_path, sql_stmt=sql_stmt)
 
     assert output_path.exists()
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 0
 
 
-@pytest.mark.parametrize("input_suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("output_suffix", DEFAULT_SUFFIXES)
-def test_select_emptyresult(tmp_path, input_suffix, output_suffix):
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_select_emptyresult(tmp_path, suffix):
     # Prepare test data
-    input_path = test_helper.get_testfile("polygon-parcel", suffix=input_suffix)
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Now run test
-    output_stem = f"{input_path.stem}-{input_suffix.replace('.', '')}-output"
-    output_path = tmp_path / f"{output_stem}{output_suffix}"
+    output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     sql_stmt = 'SELECT {geometrycolumn}, oidn, uidn FROM "{input_layer}" WHERE 1=0'
 
     gfo.select(input_path=input_path, output_path=output_path, sql_stmt=sql_stmt)
 
     # Now check if the tmp file is correctly created
     layerinfo_output = gfo.get_layerinfo(output_path)
     assert layerinfo_output.featurecount == 0
-    assert "OIDN" in layerinfo_output.columns
-    assert "UIDN" in layerinfo_output.columns
+    assert "oidn" in layerinfo_output.columns
+    assert "uidn" in layerinfo_output.columns
     assert len(layerinfo_output.columns) == 2
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize(
+    "sql_stmt",
+    [
+        'SELECT {geometrycolumn}, "oidn", "UIDN" FROM "{input_layer}"',
+    ],
+)
+@pytest.mark.parametrize("input_suffix", SUFFIXES)
+@pytest.mark.parametrize("output_suffix", SUFFIXES)
+@pytest.mark.parametrize("gridsize", [0.0])
+def test_select_geom_aliases(tmp_path, input_suffix, output_suffix, sql_stmt, gridsize):
+    # Prepare test data
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=input_suffix)
+
+    # Now run test
+    name = f"{input_path.stem}-{input_suffix.replace('.', '')}-output{output_suffix}"
+    output_path = tmp_path / name
+    layerinfo_input = gfo.get_layerinfo(input_path)
+    gfo.select(
+        input_path=input_path,
+        output_path=output_path,
+        sql_stmt=sql_stmt,
+        gridsize=gridsize,
+    )
+
+    # Now check if the tmp file is correctly created
+    assert output_path.exists()
+    layerinfo_output = gfo.get_layerinfo(output_path)
+    assert layerinfo_input.featurecount == layerinfo_output.featurecount
+    columns_output_upper = [col.upper() for col in layerinfo_output.columns]
+    assert "OIDN" in columns_output_upper
+    assert "UIDN" in columns_output_upper
+    assert len(layerinfo_output.columns) == 2
+    assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
+
+    # Now check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_select_invalid_sql(tmp_path, suffix):
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
 
     # Now run test
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     sql_stmt = 'SELECT {geometrycolumn}, not_existing_column FROM "{input_layer}"'
@@ -418,15 +453,15 @@
     sql_stmt = 'SELECT {geometrycolumn}, oidn, uidn FROM "{input_layer}"'
 
     # Now run test
     gfo.select(input_path=input_path, output_path=output_path, sql_stmt=sql_stmt)
     assert output_path.stat().st_size == 0
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize(
     "nb_parallel, has_batch_filter, exp_raise",
     [(1, False, False), (2, True, False), (2, False, True)],
 )
 def test_select_batch_filter(
     tmp_path, suffix, nb_parallel, has_batch_filter, exp_raise
 ):
@@ -448,7 +483,42 @@
         with pytest.raises(
             ValueError,
             match="Number batches > 1 requires a batch_filter placeholder in ",
         ):
             gfo.select(input_path, output_path, sql_stmt, nb_parallel=nb_parallel)
     else:
         gfo.select(input_path, output_path, sql_stmt, nb_parallel=nb_parallel)
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize("explodecollections", [True, False])
+def test_select_star(tmp_path, suffix, explodecollections):
+    # Prepare test data
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+
+    # Now run test
+    name = f"{input_path.stem}-output{suffix}"
+    output_path = tmp_path / name
+    input_layerinfo = gfo.get_layerinfo(input_path)
+    sql_stmt = 'SELECT * FROM "{input_layer}"'
+    gfo.select(
+        input_path=input_path,
+        output_path=output_path,
+        sql_stmt=sql_stmt,
+        explodecollections=explodecollections,
+    )
+
+    # Now check if the tmp file is correctly created
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    if explodecollections:
+        assert output_layerinfo.featurecount == input_layerinfo.featurecount + 2
+    else:
+        assert output_layerinfo.featurecount == input_layerinfo.featurecount
+    columns_output_upper = [col.upper() for col in output_layerinfo.columns]
+    assert "OIDN" in columns_output_upper
+    assert "UIDN" in columns_output_upper
+    assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
+    assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+
+    # Now check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
```

### Comparing `geofileops-0.8.0a5/tests/test_geofileops_twolayers.py` & `geofileops-0.8.0a6/tests/test_geofileops_twolayers.py`

 * *Files 9% similar despite different names*

```diff
@@ -14,32 +14,33 @@
     import pygeos as shapely2_or_pygeos
 else:
     import shapely as shapely2_or_pygeos
 
 
 import geofileops as gfo
 from geofileops import GeometryType, PrimitiveType
-from geofileops.util import _geoops_sql
+from geofileops.util import _geoops_sql as geoops_sql
 from tests import test_helper
-from tests.test_helper import DEFAULT_SUFFIXES, DEFAULT_TESTFILES
+from tests.test_helper import SUFFIXES, TESTFILES
 from tests.test_helper import assert_geodataframe_equal
 
 
-@pytest.mark.parametrize("testfile", DEFAULT_TESTFILES)
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("testfile", TESTFILES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_clip(tmp_path, testfile, suffix):
     input_path = test_helper.get_testfile(testfile, suffix=suffix)
     clip_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
     gfo.clip(
         input_path=input_path,
         clip_path=clip_path,
         output_path=output_path,
+        where=None,
         batchsize=batchsize,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     output_gdf = gfo.read_file(output_path)
@@ -47,29 +48,32 @@
     clip_gdf = gfo.read_file(clip_path)
     output_gpd_gdf = gpd.clip(input_gdf, clip_gdf, keep_geom_type=True)
     assert_geodataframe_equal(
         output_gdf, output_gpd_gdf, promote_to_multi=True, sort_values=True
     )
 
 
-@pytest.mark.parametrize("testfile", DEFAULT_TESTFILES)
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("gridsize", [0.0, 0.001])
-def test_erase(tmp_path, testfile, suffix, gridsize):
+@pytest.mark.parametrize("testfile", TESTFILES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize(
+    "gridsize, where", [(0.0, "ST_Area(geom) > 2000"), (0.001, None)]
+)
+def test_erase(tmp_path, testfile, suffix, gridsize, where):
     input_path = test_helper.get_testfile(testfile, suffix=suffix)
     erase_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     input_layerinfo = gfo.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
 
     gfo.erase(
         input_path=input_path,
         erase_path=erase_path,
         output_path=output_path,
         gridsize=gridsize,
+        where=where,
         batchsize=batchsize,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     output_gdf = gfo.read_file(output_path)
@@ -78,14 +82,17 @@
     output_gpd_gdf = gpd.overlay(
         input_gdf, erase_gdf, how="difference", keep_geom_type=True
     )
     if gridsize != 0.0:
         output_gpd_gdf.geometry = shapely2_or_pygeos.set_precision(
             output_gpd_gdf.geometry.array.data, grid_size=gridsize
         )
+    if where is not None:
+        output_gpd_gdf = output_gpd_gdf[output_gpd_gdf.geometry.area > 2000]
+
     assert_geodataframe_equal(
         output_gdf,
         output_gpd_gdf,
         promote_to_multi=True,
         sort_values=True,
         check_less_precise=True,
         normalize=True,
@@ -123,50 +130,54 @@
         promote_to_multi=True,
         sort_values=True,
         check_less_precise=True,
         normalize=True,
     )
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
-@pytest.mark.parametrize("gridsize", [0.0, 0.001])
-def test_export_by_location(tmp_path, suffix, gridsize):
+@pytest.mark.parametrize("suffix", SUFFIXES)
+@pytest.mark.parametrize(
+    "gridsize, where, exp_featurecount",
+    [(0.0, "ST_Area(geom) > 2000", 25), (0.001, None, 27)],
+)
+def test_export_by_location(tmp_path, suffix, gridsize, where, exp_featurecount):
     input_to_select_from_path = test_helper.get_testfile(
         "polygon-parcel", suffix=suffix
     )
     input_to_compare_with_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     output_path = tmp_path / f"{input_to_select_from_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
 
     # Test
     gfo.export_by_location(
         input_to_select_from_path=input_to_select_from_path,
         input_to_compare_with_path=input_to_compare_with_path,
         output_path=output_path,
         gridsize=gridsize,
+        where=where,
         batchsize=batchsize,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 26
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns) + 1
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == exp_featurecount
 
     # Check the contents of the result file
     # TODO: this test should be more elaborate...
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_export_by_distance(tmp_path, testfile, suffix):
     input_to_select_from_path = test_helper.get_testfile(testfile, suffix=suffix)
     input_to_compare_with_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     input_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
     output_path = tmp_path / f"{input_to_select_from_path.stem}-output{suffix}"
 
@@ -191,25 +202,27 @@
     # TODO: this test should be more elaborate...
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
 @pytest.mark.parametrize(
-    "suffix, epsg, gridsize, nb_parallel",
+    "suffix, epsg, gridsize, explodecollections, nb_parallel",
     [
-        (".gpkg", 31370, 0.0, 1),
-        (".gpkg", 31370, 0.01, 1),
-        (".gpkg", 31370, 0.0, 2),
-        (".gpkg", 4326, 0.0, 2),
-        (".shp", 31370, 0.0, 1),
-        (".shp", 31370, 0.0, 2),
+        (".gpkg", 31370, 0.0, True, 1),
+        (".gpkg", 31370, 0.01, True, 1),
+        (".gpkg", 31370, 0.0, False, 2),
+        (".gpkg", 4326, 0.0, True, 2),
+        (".shp", 31370, 0.0, True, 1),
+        (".shp", 31370, 0.0, False, 2),
     ],
 )
-def test_intersection(tmp_path, testfile, suffix, epsg, gridsize, nb_parallel):
+def test_intersection(
+    tmp_path, testfile, suffix, epsg, explodecollections, gridsize, nb_parallel
+):
     input1_path = test_helper.get_testfile(testfile, suffix=suffix, epsg=epsg)
     input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix, epsg=epsg)
 
     # Now run test
     output_path = (
         tmp_path / f"{input1_path.stem}_intersection_{input2_path.stem}{suffix}"
     )
@@ -218,50 +231,56 @@
     if nb_parallel > 1:
         batchsize = math.ceil(input1_layerinfo.featurecount / 2)
     gfo.intersection(
         input1_path=input1_path,
         input2_path=input2_path,
         output_path=output_path,
         gridsize=gridsize,
+        explodecollections=explodecollections,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 29
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    if explodecollections:
+        assert output_layerinfo.featurecount == 31
+    else:
+        assert output_layerinfo.featurecount == 30
 
     # Check the contents of the result file
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
     input1_gdf = gfo.read_file(input1_path)
     input2_gdf = gfo.read_file(input2_path)
     overlay_operation = "intersection"
-    output_gpd_gdf = input1_gdf.overlay(
+    expected_gdf = input1_gdf.overlay(
         input2_gdf, how=overlay_operation, keep_geom_type=True
     )
     renames = {
         name_gpd: name_gfo
-        for name_gpd, name_gfo in zip(output_gpd_gdf.columns, output_gdf.columns)
+        for name_gpd, name_gfo in zip(expected_gdf.columns, output_gdf.columns)
     }
-    output_gpd_gdf = output_gpd_gdf.rename(columns=renames)
+    expected_gdf = expected_gdf.rename(columns=renames)
     if gridsize != 0.0:
-        output_gpd_gdf.geometry = shapely2_or_pygeos.set_precision(
-            output_gpd_gdf.geometry.array.data, grid_size=gridsize
+        expected_gdf.geometry = shapely2_or_pygeos.set_precision(
+            expected_gdf.geometry.array.data, grid_size=gridsize
         )
+    if explodecollections:
+        expected_gdf = expected_gdf.explode(ignore_index=True)
     assert_geodataframe_equal(
-        output_gdf, output_gpd_gdf, check_dtype=False, sort_values=True
+        output_gdf, expected_gdf, check_dtype=False, sort_values=True
     )
 
 
 def test_intersection_input_no_index(tmp_path):
     """
     Test if intersection works if the input gpkg files don't have a spatial index.
     """
@@ -381,15 +400,15 @@
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
 
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_intersection_columns_fid(tmp_path, testfile, suffix):
     input1_path = test_helper.get_testfile(testfile, suffix=suffix)
     input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     batchsize = math.ceil(input1_layerinfo.featurecount / 2)
 
     # Now run test
@@ -409,29 +428,82 @@
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 29
     assert len(output_layerinfo.columns) == len(input1_columns) + len(input2_columns)
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == 30
 
     # Check the contents of the result file
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
     assert "l1_fid" in output_gdf.columns
     assert "l2_FiD" in output_gdf.columns
     if gfo.GeofileType(input2_path).is_fid_zerobased:
         assert sorted(output_gdf.l2_FiD.unique().tolist()) == [0, 1, 2, 3, 4]
     else:
         assert sorted(output_gdf.l2_FiD.unique().tolist()) == [1, 2, 3, 4, 5]
 
 
+@pytest.mark.parametrize(
+    "suffix, explodecollections, where, exp_featurecount",
+    [
+        (".gpkg", False, None, 30),
+        (".gpkg", True, None, 31),
+        (".gpkg", False, "ST_Area(geom) > 1000", 26),
+        (".shp", False, "ST_Area(geom) > 1000", 26),
+        (".gpkg", True, "ST_Area(geom) > 1000", 27),
+        (".shp", True, "ST_Area(geom) > 1000", 27),
+    ],
+)
+def test_intersection_where(
+    tmp_path, suffix, explodecollections, where, exp_featurecount
+):
+    """Test intersection with where parameter."""
+    # TODO: test data should be changed so explodecollections results in more rows
+    # without where already!!!
+    input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+    input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
+
+    # Now run test
+    output_path = (
+        tmp_path / f"{input1_path.stem}_intersection_{input2_path.stem}{suffix}"
+    )
+    batchsize = -1
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    batchsize = math.ceil(input1_layerinfo.featurecount / 2)
+    gfo.intersection(
+        input1_path=input1_path,
+        input2_path=input2_path,
+        output_path=output_path,
+        explodecollections=explodecollections,
+        where=where,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    assert gfo.has_spatial_index(output_path)
+    input2_layerinfo = gfo.get_layerinfo(input2_path)
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == (
+        len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
+    )
+    assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == exp_featurecount
+
+    # Check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
+
+
 def test_prepare_spatial_relations_filter():
     # Test all existing named relations
     named_relations = [
         "equals",
         "touches",
         "within",
         "overlaps",
@@ -439,25 +511,25 @@
         "intersects",
         "contains",
         "covers",
         "coveredby",
     ]
     for relation in named_relations:
         query = f"{relation} is True"
-        filter = _geoops_sql._prepare_spatial_relations_filter(query)
+        filter = geoops_sql._prepare_spatial_relations_filter(query)
         assert filter is not None and filter != ""
 
     # Test extra queries that should work
     ok_queries = [
         "intersects is False",
         "(intersects is False and within is True) and crosses is False"
         "(((T******** is False)))",
     ]
     for query in ok_queries:
-        filter = _geoops_sql._prepare_spatial_relations_filter(query)
+        filter = geoops_sql._prepare_spatial_relations_filter(query)
         assert filter is not None and filter != ""
 
     # Test queries that should fail
     error_queries = [
         ("Intersects is False", "named relations should be in lowercase"),
         ("intersects Is False", "is should be in lowercase"),
         ("intersects is false", "false should be False"),
@@ -468,32 +540,32 @@
         ("T**T**T**T is False", "predicate should be 9 characters, not 10"),
         ("A**T**T** is False", "A is not a valid character in a predicate"),
         ("'T**T**T**' is False", "predicates should not be quoted"),
         ("[T**T**T** is False ]", "square brackets are not supported"),
     ]
     for query, error_reason in error_queries:
         try:
-            _ = _geoops_sql._prepare_spatial_relations_filter(query)
+            _ = geoops_sql._prepare_spatial_relations_filter(query)
             error = False
         except Exception:
             error = True
         assert error is True, error_reason
 
 
 @pytest.mark.parametrize(
     "suffix, epsg, spatial_relations_query, discard_nonmatching, "
     "min_area_intersect, area_inters_column_name, expected_featurecount",
     [
         (".gpkg", 31370, "intersects is False", False, None, None, 46),
         (".gpkg", 31370, "intersects is False", True, None, None, 0),
         (".gpkg", 31370, "intersects is True", False, 1000, "area_test", 48),
         (".gpkg", 31370, "intersects is True", False, None, None, 49),
-        (".gpkg", 31370, "intersects is True", True, 1000, None, 25),
-        (".gpkg", 31370, "intersects is True", True, None, None, 29),
-        (".gpkg", 4326, "T******** is True or *T******* is True", True, None, None, 29),
+        (".gpkg", 31370, "intersects is True", True, 1000, None, 26),
+        (".gpkg", 31370, "intersects is True", True, None, None, 30),
+        (".gpkg", 4326, "T******** is True or *T******* is True", True, None, None, 30),
         (".gpkg", 4326, "intersects is True", False, None, None, 49),
         (".shp", 31370, "intersects is True", False, None, None, 49),
     ],
 )
 def test_join_by_location(
     tmp_path,
     suffix: str,
@@ -655,15 +727,15 @@
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 29
+    assert output_layerinfo.featurecount == 30
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns) + 1
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
     # Check the contents of the result file
     output_gdf = gfo.read_file(output_path)
@@ -723,15 +795,15 @@
             input1_path=input1_path,
             input2_path=input2_path,
             output_path=output_path,
             sql_stmt=sql_stmt,
         )
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 def test_select_two_layers_invalid_sql(tmp_path, suffix):
     # Prepare test data
     input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
 
     # Now run test
     output_path = tmp_path / f"output{suffix}"
@@ -750,15 +822,15 @@
             input1_path=input1_path,
             input2_path=input2_path,
             output_path=output_path,
             sql_stmt=sql_stmt,
         )
 
 
-@pytest.mark.parametrize("suffix", DEFAULT_SUFFIXES)
+@pytest.mark.parametrize("suffix", SUFFIXES)
 @pytest.mark.parametrize(
     "nb_parallel, has_batch_filter, exp_raise",
     [(1, False, False), (2, True, False), (2, False, True)],
 )
 def test_select_two_layers_batch_filter(
     tmp_path, suffix, nb_parallel, has_batch_filter, exp_raise
 ):
@@ -789,14 +861,117 @@
             )
     else:
         gfo.select_two_layers(
             input1_path, input2_path, output_path, sql_stmt, nb_parallel=nb_parallel
         )
 
 
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_select_two_layers_select_star_fids_not_unique(tmp_path, suffix):
+    # Prepare test data
+    input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+    input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
+
+    # Now run test
+    output_path = tmp_path / f"output{suffix}"
+    sql_stmt = """
+        SELECT layer1.*
+          FROM {input1_databasename}."{input1_layer}" layer1
+          CROSS JOIN {input2_databasename}."{input2_layer}" layer2
+         WHERE 1=1
+           AND ST_Area(layer1.{input1_geometrycolumn}) > 5
+    """
+    with pytest.raises(Exception, match="Error <Error UNIQUE constraint failed"):
+        gfo.select_two_layers(
+            input1_path=input1_path,
+            input2_path=input2_path,
+            output_path=output_path,
+            sql_stmt=sql_stmt,
+        )
+
+
+@pytest.mark.parametrize("suffix", SUFFIXES)
+def test_select_two_layers_select_star_fids_unique(tmp_path, suffix):
+    """
+    Test for a join where the fid of one layer is selected (select *), but where this
+    fid will stay unique because the rows in this layer won't be duplicated.
+    """
+    # Prepare test data
+    input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+    input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
+    one_zone_path = tmp_path / f"one_zone{suffix}"
+    input2_gdf = gfo.read_file(input2_path)
+    gfo.to_file(input2_gdf.iloc[[0]], one_zone_path)
+    one_zone_layerinfo = gfo.get_layerinfo(one_zone_path)
+    assert one_zone_layerinfo.featurecount == 1
+
+    # Test with 1 * in the select
+    # ---------------------------
+    output_path = tmp_path / f"output_1star{suffix}"
+    sql_stmt = """
+        SELECT layer1.*
+          FROM {input1_databasename}."{input1_layer}" layer1
+          CROSS JOIN {input2_databasename}."{input2_layer}" layer2
+         WHERE 1=1
+    """
+    gfo.select_two_layers(
+        input1_path=input1_path,
+        input2_path=one_zone_path,
+        output_path=output_path,
+        sql_stmt=sql_stmt,
+    )
+    assert output_path.exists()
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    # Same number of columns expected as layer1: fid is "reused"
+    assert len(output_layerinfo.columns) == len(input1_layerinfo.columns)
+
+    # Test with 2 *'s in select
+    # -------------------------
+    output_path = tmp_path / f"output_2stars{suffix}"
+    sql_stmt = """
+        SELECT layer1.*, layer2.*
+          FROM {input1_databasename}."{input1_layer}" layer1
+          CROSS JOIN {input2_databasename}."{input2_layer}" layer2
+         WHERE 1=1
+    """
+    gfo.select_two_layers(
+        input1_path=input1_path,
+        input2_path=one_zone_path,
+        output_path=output_path,
+        sql_stmt=sql_stmt,
+    )
+    assert output_path.exists()
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    # 2 extra columns expected: layer2.fid is aliased + the layer2.geom is aliased
+    exp_nb_columns = len(input1_layerinfo.columns) + len(one_zone_layerinfo.columns) + 2
+    assert len(output_layerinfo.columns) == exp_nb_columns
+
+    # Test with 2 fid's in select
+    # -------------------------
+    output_path = tmp_path / f"output_2fids{suffix}"
+    sql_stmt = """
+        SELECT layer1.{input1_geometrycolumn}, layer1.fid, layer2.fid
+          FROM {input1_databasename}."{input1_layer}" layer1
+          CROSS JOIN {input2_databasename}."{input2_layer}" layer2
+         WHERE 1=1
+    """
+    gfo.select_two_layers(
+        input1_path=input1_path,
+        input2_path=one_zone_path,
+        output_path=output_path,
+        sql_stmt=sql_stmt,
+    )
+    assert output_path.exists()
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    # 1 attribute column expected: layer2.fid is aliased
+    exp_nb_columns = 1
+    assert len(output_layerinfo.columns) == exp_nb_columns
+
+
 @pytest.mark.parametrize(
     "suffix, epsg, gridsize",
     [(".gpkg", 31370, 0.001), (".gpkg", 4326, 0.0), (".shp", 31370, 0.001)],
 )
 def test_split(tmp_path, suffix, epsg, gridsize):
     # Prepare test data
     input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix, epsg=epsg)
@@ -815,15 +990,15 @@
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 66
+    assert output_layerinfo.featurecount == 67
     assert (len(input1_layerinfo.columns) + len(input2_layerinfo.columns)) == len(
         output_layerinfo.columns
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
     # Check the contents of the result file
     # TODO: this test should be more elaborate...
@@ -901,18 +1076,24 @@
         check_dtype=False,
         check_less_precise=True,
         normalize=True,
     )
 
 
 @pytest.mark.parametrize(
-    "suffix, epsg, gridsize",
-    [(".gpkg", 31370, 0.001), (".gpkg", 4326, 0.0), (".shp", 31370, 0.0)],
+    "suffix, epsg, gridsize, where, explodecollections, exp_featurecount",
+    [
+        (".gpkg", 31370, 0.001, "ST_Area(geom) > 1000", True, 62),
+        (".shp", 31370, 0.0, "ST_Area(geom) > 1000", False, 59),
+        (".gpkg", 4326, 0.0, None, False, 72),
+    ],
 )
-def test_union(tmp_path, suffix, epsg, gridsize):
+def test_union(
+    tmp_path, suffix, epsg, gridsize, where, explodecollections, exp_featurecount
+):
     # Prepare test files
     input1_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix, epsg=epsg
     )
     input2_path = test_helper.get_testfile(
         "polygon-zone", dst_dir=tmp_path, suffix=suffix, epsg=epsg
     )
@@ -926,27 +1107,29 @@
 
     # Test
     gfo.union(
         input1_path=input1_path,
         input2_path=input2_path,
         output_path=output_path,
         gridsize=gridsize,
+        explodecollections=explodecollections,
+        where=where,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == 71
     assert (len(input1_layerinfo.columns) + len(input2_layerinfo.columns)) == len(
         output_layerinfo.columns
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == exp_featurecount
 
     # Check the contents of the result file
     output_gfo_gdf = gfo.read_file(output_path)
     assert output_gfo_gdf["geometry"][0] is not None
     input1_gdf = gfo.read_file(input1_path)
     input2_gdf = gfo.read_file(input2_path)
     output_gpd_gdf = input1_gdf.overlay(input2_gdf, how="union", keep_geom_type=True)
@@ -956,14 +1139,19 @@
     }
     output_gpd_gdf = output_gpd_gdf.rename(columns=renames)
     output_gpd_gdf["l1_DATUM"] = pd.to_datetime(output_gpd_gdf["l1_DATUM"])
     if gridsize != 0.0:
         output_gpd_gdf.geometry = shapely2_or_pygeos.set_precision(
             output_gpd_gdf.geometry.array.data, grid_size=gridsize
         )
+    if explodecollections:
+        output_gpd_gdf = output_gpd_gdf.explode(ignore_index=True)
+    if where is not None:
+        output_gpd_gdf = output_gpd_gdf[output_gpd_gdf.geometry.area > 1000]
+
     assert_geodataframe_equal(
         output_gfo_gdf,
         output_gpd_gdf,
         promote_to_multi=True,
         sort_values=True,
         check_less_precise=True,
         normalize=True,
```

### Comparing `geofileops-0.8.0a5/tests/test_geofiletype.py` & `geofileops-0.8.0a6/tests/test_geofiletype.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,17 +1,14 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in geofileops.general.
 """
 
 from pathlib import Path
-import sys
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 from geofileops.util.geofiletype import GeofileType
 
 
 def test_geofiletype_enum():
     # Test ESRIShapefile geofiletype
     # Test getting a geofiletype for a suffix
     assert GeofileType(".shp") == GeofileType.ESRIShapefile
```

### Comparing `geofileops-0.8.0a5/tests/test_geometry_util.py` & `geofileops-0.8.0a6/tests/test_geometry_util.py`

 * *Files 14% similar despite different names*

```diff
@@ -16,44 +16,95 @@
 from geofileops.util import grid_util
 from tests import test_helper
 
 
 def test_geometrytype():
     # Creating a GeometryType from None is invalid
     with pytest.raises(ValueError, match="None is not a valid GeometryType"):
-        geometrytype = GeometryType(None)
+        _ = GeometryType(None)
 
     # Create different types of Geometrytype
-    geometrytype = GeometryType(3)
-    assert geometrytype is GeometryType.POLYGON
-    geometrytype = GeometryType("PoLyGoN")
-    assert geometrytype is GeometryType.POLYGON
-    geometrytype = GeometryType(GeometryType.POLYGON)
-    assert geometrytype is GeometryType.POLYGON
+    assert GeometryType(3) is GeometryType.POLYGON
+    assert GeometryType("PoLyGoN") is GeometryType.POLYGON
+    assert GeometryType("PoLyGoN") is GeometryType.POLYGON
+    assert GeometryType(GeometryType.POLYGON) is GeometryType.POLYGON
+
+
+def test_geometrytype_name_camelcase():
+    # Test to_singletype
+    assert GeometryType.POLYGON.name_camelcase == "Polygon"
+    assert GeometryType.MULTIPOLYGON.name_camelcase == "MultiPolygon"
+    assert GeometryType.LINESTRING.name_camelcase == "LineString"
+    assert GeometryType.MULTILINESTRING.name_camelcase == "MultiLineString"
+    assert GeometryType.POINT.name_camelcase == "Point"
+    assert GeometryType.MULTIPOINT.name_camelcase == "MultiPoint"
+    assert GeometryType.GEOMETRY.name_camelcase == "Geometry"
+    assert GeometryType.GEOMETRYCOLLECTION.name_camelcase == "GeometryCollection"
 
+
+def test_geometrytype_to_primitivetype():
     # Test to_primitivetype
-    primitivetype = GeometryType.POLYGON.to_primitivetype
-    assert primitivetype is PrimitiveType.POLYGON
-    primitivetype = GeometryType.MULTIPOLYGON.to_primitivetype
-    assert primitivetype is PrimitiveType.POLYGON
+    assert GeometryType.POLYGON.to_primitivetype is PrimitiveType.POLYGON
+    assert GeometryType.MULTIPOLYGON.to_primitivetype is PrimitiveType.POLYGON
+    assert GeometryType.LINESTRING.to_primitivetype is PrimitiveType.LINESTRING
+    assert GeometryType.MULTILINESTRING.to_primitivetype is PrimitiveType.LINESTRING
+    assert GeometryType.POINT.to_primitivetype is PrimitiveType.POINT
+    assert GeometryType.MULTIPOINT.to_primitivetype is PrimitiveType.POINT
 
     # A geometry collection doesn't have a primitive type
     with pytest.raises(
-        Exception, match="Geometrycollection doesn't have a primitive type"
+        Exception, match="GeometryType.GEOMETRYCOLLECTION doesn't have a primitive type"
     ):
         GeometryType.GEOMETRYCOLLECTION.to_primitivetype
 
 
+def test_geometrytype_to_multitype():
+    # Test to_multitype
+    assert GeometryType.POLYGON.to_multitype is GeometryType.MULTIPOLYGON
+    assert GeometryType.MULTIPOLYGON.to_multitype is GeometryType.MULTIPOLYGON
+    assert GeometryType.LINESTRING.to_multitype is GeometryType.MULTILINESTRING
+    assert GeometryType.MULTILINESTRING.to_multitype is GeometryType.MULTILINESTRING
+    assert GeometryType.POINT.to_multitype is GeometryType.MULTIPOINT
+    assert GeometryType.MULTIPOINT.to_multitype is GeometryType.MULTIPOINT
+    assert GeometryType.GEOMETRY.to_multitype is GeometryType.GEOMETRY
+    assert (
+        GeometryType.GEOMETRYCOLLECTION.to_multitype is GeometryType.GEOMETRYCOLLECTION
+    )
+
+
+def test_geometrytype_to_singletype():
+    # Test to_singletype
+    assert GeometryType.POLYGON.to_singletype is GeometryType.POLYGON
+    assert GeometryType.MULTIPOLYGON.to_singletype is GeometryType.POLYGON
+    assert GeometryType.LINESTRING.to_singletype is GeometryType.LINESTRING
+    assert GeometryType.MULTILINESTRING.to_singletype is GeometryType.LINESTRING
+    assert GeometryType.POINT.to_singletype is GeometryType.POINT
+    assert GeometryType.MULTIPOINT.to_singletype is GeometryType.POINT
+    assert GeometryType.GEOMETRY.to_singletype is GeometryType.GEOMETRY
+    assert GeometryType.GEOMETRYCOLLECTION.to_singletype is GeometryType.GEOMETRY
+
+
 def test_primitivetype():
-    primitivetype = PrimitiveType(3)
-    assert primitivetype is PrimitiveType.POLYGON
-    primitivetype = PrimitiveType("PoLyGoN")
-    assert primitivetype is PrimitiveType.POLYGON
-    primitivetype = PrimitiveType(PrimitiveType.POLYGON)
-    assert primitivetype is PrimitiveType.POLYGON
+    assert PrimitiveType(3) is PrimitiveType.POLYGON
+    assert PrimitiveType(2) is PrimitiveType.LINESTRING
+    assert PrimitiveType(1) is PrimitiveType.POINT
+    assert PrimitiveType("PoLyGoN") is PrimitiveType.POLYGON
+    assert PrimitiveType(PrimitiveType.POLYGON) is PrimitiveType.POLYGON
+
+
+def test_primitivetype_to_multitype():
+    assert PrimitiveType.POLYGON.to_multitype is GeometryType.MULTIPOLYGON
+    assert PrimitiveType.LINESTRING.to_multitype is GeometryType.MULTILINESTRING
+    assert PrimitiveType.POINT.to_multitype is GeometryType.MULTIPOINT
+
+
+def test_primitivetype_to_singletype():
+    assert PrimitiveType.POLYGON.to_singletype is GeometryType.POLYGON
+    assert PrimitiveType.LINESTRING.to_singletype is GeometryType.LINESTRING
+    assert PrimitiveType.POINT.to_singletype is GeometryType.POINT
 
 
 def test_makevalid():
     # Test Point
     point_valid = geometry_util.make_valid(test_helper.TestData.point)
     assert isinstance(point_valid, sh_geom.Point)
```

### Comparing `geofileops-0.8.0a5/tests/test_geoseries_util.py` & `geofileops-0.8.0a6/tests/test_geoseries_util.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,22 +1,16 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in geoseries_util.
 """
 
-from pathlib import Path
-import sys
-
 import geopandas as gpd
 import pytest
 import shapely.geometry as sh_geom
 
-# Add path so the local geofileops packages are found
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 import geofileops as gfo
 import geofileops._compat as compat
 from geofileops.util import geoseries_util
 from geofileops.util.geometry_util import GeometryType, PrimitiveType, SimplifyAlgorithm
 from tests import test_helper
```

### Comparing `geofileops-0.8.0a5/tests/test_helper.py` & `geofileops-0.8.0a6/tests/test_helper.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,37 +1,93 @@
 # -*- coding: utf-8 -*-
 """
 Helper functions for all tests.
 """
 
 from pathlib import Path
 import tempfile
-from typing import Optional, Union
-import sys
+from typing import List, Optional, Union
 
 import geopandas as gpd
 import geopandas._compat as gpd_compat
 import geopandas.testing as gpd_testing
 
 if gpd_compat.USE_PYGEOS:
     import pygeos as shapely2_or_pygeos
 else:
     import shapely as shapely2_or_pygeos
 import shapely.geometry as sh_geom
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 import geofileops as gfo
 from geofileops.util import geodataframe_util
 from geofileops.util import geoseries_util
 
 _data_dir = Path(__file__).parent.resolve() / "data"
-DEFAULT_EPSGS = [31370, 4326]
-DEFAULT_SUFFIXES = [".gpkg", ".shp"]
-DEFAULT_TESTFILES = ["polygon-parcel", "linestring-row-trees", "point"]
+EPSGS = [31370, 4326]
+GRIDSIZE_DEFAULT = 0.0
+SUFFIXES = [".gpkg", ".shp"]
+TESTFILES = ["polygon-parcel", "linestring-row-trees", "point"]
+WHERE_AREA_GT_400 = "ST_Area({geometrycolumn}) > 400"
+WHERE_AREA_GT_5000 = "ST_Area({geometrycolumn}) > 5000"
+WHERE_LENGTH_GT_1000 = "ST_Length({geometrycolumn}) > 1000"
+WHERE_LENGTH_GT_200000 = "ST_Length({geometrycolumn}) > 200000"
+
+
+def prepare_expected_result(
+    gdf: gpd.GeoDataFrame,
+    keep_empty_geoms: bool,
+    gridsize: float = 0.0,
+    where: Optional[str] = None,
+    explodecollections=False,
+    columns: Optional[List[str]] = None,
+) -> gpd.GeoDataFrame:
+    """Prepare expected data"""
+
+    expected_gdf = gdf.copy()
+
+    if gridsize != 0.0:
+        expected_gdf.geometry = shapely2_or_pygeos.set_precision(
+            expected_gdf.geometry.array.data, grid_size=gridsize
+        )
+    if explodecollections:
+        expected_gdf = expected_gdf.explode(ignore_index=True)  # type: ignore
+
+    # Check what filtering is needed
+    filter_area_gt = None
+    if where is None or where == "":
+        pass
+    elif where == "ST_Area({geometrycolumn}) > 400":
+        filter_area_gt = 400
+    elif where == "ST_Area({geometrycolumn}) > 5000":
+        filter_area_gt = 5000
+    else:
+        raise ValueError(f"unsupported where parameter in test: {where}")
+
+    # Apply filtering
+    if keep_empty_geoms is None or not keep_empty_geoms:
+        expected_gdf = expected_gdf[~expected_gdf.geometry.isna()]
+        expected_gdf = expected_gdf[~expected_gdf.geometry.is_empty]
+    if filter_area_gt is not None:
+        expected_gdf = expected_gdf[expected_gdf.geometry.area > filter_area_gt]
+
+    if columns is not None:
+        column_mapper = {}
+        columns_to_drop = []
+        columns_dict = {column.upper(): column for column in columns}
+        for column in expected_gdf.columns:
+            if column.upper() in columns_dict:
+                column_mapper[column] = columns_dict[column.upper()]
+            elif column != "geometry":
+                columns_to_drop.append(column)
+        expected_gdf = expected_gdf.rename(columns=column_mapper)
+        if len(columns_to_drop) > 0:
+            expected_gdf = expected_gdf.drop(columns=columns_to_drop)
+
+    assert isinstance(expected_gdf, gpd.GeoDataFrame)
+    return expected_gdf
 
 
 def prepare_test_file(
     input_path: Path,
     output_dir: Path,
     suffix: str,
     crs_epsg: Optional[int] = None,
@@ -51,25 +107,25 @@
         if input_prepared_path.exists() is False:
             input_layerinfo = gfo.get_layerinfo(input_path)
             assert input_layerinfo.crs is not None
             if input_layerinfo.crs.to_epsg() == crs_epsg:
                 if input_path.suffix == suffix:
                     gfo.copy(input_path, input_prepared_path)
                 else:
-                    gfo.convert(input_path, input_prepared_path)
+                    gfo.copy_layer(input_path, input_prepared_path)
             else:
                 test_gdf = gfo.read_file(input_path)
                 test_gdf = test_gdf.to_crs(crs_epsg)
                 assert isinstance(test_gdf, gpd.GeoDataFrame)
                 gfo.to_file(test_gdf, input_prepared_path)
     elif input_path.suffix != suffix:
         # No crs specified, but different suffix asked, so convert file
         input_prepared_path = tmp_cache_dir / f"{input_path.stem}{suffix}"
         if input_prepared_path.exists() is False:
-            gfo.convert(input_path, input_prepared_path)
+            gfo.copy_layer(input_path, input_prepared_path)
 
     # Now copy the prepared file to the output dir
     output_path = output_dir / input_prepared_path.name
     if str(input_prepared_path) != str(output_path):
         gfo.copy(input_prepared_path, output_path)
     return output_path
 
@@ -100,15 +156,15 @@
         raise ValueError(
             f"multilayer testfile ({testfile}) cannot be converted to single layer "
             f"geofiletype: {dst_geofiletype}"
         )
 
     # Convert all layers found
     for layer in layers:
-        gfo.convert(
+        gfo.copy_layer(
             testfile_path,
             prepared_path,
             src_layer=layer,
             dst_layer=layer,
             dst_crs=epsg,
             reproject=True,
             append=True,
@@ -182,23 +238,24 @@
     raise Exception(
         "Wasn't able to create a temporary dir with basedir: "
         f"{parent_dir / base_dirname}"
     )
 
 
 def assert_geodataframe_equal(
-    left,
-    right,
+    left: gpd.GeoDataFrame,
+    right: gpd.GeoDataFrame,
     check_dtype=True,
     check_index_type: Union[bool, str] = "equiv",
     check_column_type: Union[bool, str] = "equiv",
     check_frame_type=True,
     check_like=False,
     check_less_precise=False,
     check_geom_type=False,
+    check_geom_empty_vs_None=True,
     check_crs=True,
     normalize=False,
     promote_to_multi=False,
     sort_columns=False,
     sort_values=False,
     output_dir: Optional[Path] = None,
 ):
@@ -217,14 +274,16 @@
         will attempt to convert both into GeoDataFrame.
     check_like : bool, default False
         If true, ignore the order of rows & columns
     check_less_precise : bool, default False
         If True, use geom_almost_equals. if False, use geom_equals.
     check_geom_type : bool, default False
         If True, check that all the geom types are equal.
+    check_geom_empty_vs_None : bool, default True
+        If False, ignore differences between empty and None geometries.
     check_crs: bool, default True
         If `check_frame_type` is True, then also check that the
         crs matches.
     normalize: bool, default False
         If True, normalize the geometries before comparing equality.
         Typically useful with ``check_less_precise=True``, which uses
         ``geom_almost_equals`` and requires exact coordinate order.
@@ -240,38 +299,46 @@
         directory as geojson files. If normalize, promote_to_multi and/or
         sort_values are True, the will be applied before writing.
     """
     if sort_columns:
         left = left[sorted(left.columns)]
         right = right[sorted(right.columns)]
 
+    if not check_geom_empty_vs_None:
+        # Set empty geoms to None for both inputs
+        left = left.copy()
+        left.loc[left.geometry.is_empty, ["geometry"]] = None
+        right = right.copy()
+        right.loc[right.geometry.is_empty, ["geometry"]] = None
+
     if sort_values:
         if normalize:
             left.geometry = gpd.GeoSeries(
-                shapely2_or_pygeos.normalize(left.geometry.array.data)
+                shapely2_or_pygeos.normalize(left.geometry.array.data), index=left.index
             )
             right.geometry = gpd.GeoSeries(
-                shapely2_or_pygeos.normalize(right.geometry.array.data)
+                shapely2_or_pygeos.normalize(right.geometry.array.data),
+                index=right.index,
             )
         if promote_to_multi:
             left.geometry = geoseries_util.harmonize_geometrytypes(
                 left.geometry, force_multitype=True
             )
             right.geometry = geoseries_util.harmonize_geometrytypes(
                 right.geometry, force_multitype=True
             )
         left = geodataframe_util.sort_values(left).reset_index(drop=True)
         right = geodataframe_util.sort_values(right).reset_index(drop=True)
 
     if output_dir is not None:
         output_dir.mkdir(parents=True, exist_ok=True)
         output_path = output_dir / "left.geojson"
-        gfo.to_file(left, output_path)
+        gfo.to_file(left, output_path, create_spatial_index=None)
         output_path = output_dir / "right.geojson"
-        gfo.to_file(right, output_path)
+        gfo.to_file(right, output_path, create_spatial_index=None)
 
     gpd_testing.assert_geodataframe_equal(
         left=left,
         right=right,
         check_dtype=check_dtype,
         check_index_type=check_index_type,  # type: ignore
         check_column_type=check_column_type,  # type: ignore
```

### Comparing `geofileops-0.8.0a5/tests/test_io_util.py` & `geofileops-0.8.0a6/tests/test_io_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/test_layerstyles.py` & `geofileops-0.8.0a6/tests/test_layerstyles.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/test_ogr_sql_util.py` & `geofileops-0.8.0a6/tests/test_ogr_sql_util.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,20 +1,16 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in sql_util.
 """
 
-from pathlib import Path
-import sys
 from typing import Iterable, List, Optional
 
 import pytest
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 from geofileops.util import _ogr_sql_util
 
 
 @pytest.mark.parametrize(
     "descr, columns_specified, columns_available, table_alias, columnname_prefix, "
     "fid_column, "
     "exp_quoted, exp_prefixed, exp_prefixed_aliased, "
```

### Comparing `geofileops-0.8.0a5/tests/test_ogr_util.py` & `geofileops-0.8.0a6/tests/test_ogr_util.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,21 +1,20 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in ogr_util.
 """
 
 import os
-from pathlib import Path
-import sys
 
 from osgeo import gdal
+import pytest
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
+import geofileops as gfo
 from geofileops.util import _ogr_util
+from tests import test_helper
 
 
 def test_get_drivers():
     drivers = _ogr_util.get_drivers()
     assert len(drivers) > 0
     assert "GPKG" in drivers
     assert "ESRI Shapefile" in drivers
@@ -93,7 +92,40 @@
     assert gdal.GetConfigOption(test2_config_alreadyset) is None
     # assert gdal.GetConfigOption(test2_config_alreadyset) == "test2_original_value"
     assert gdal.GetConfigOption(test3_config_envset) == "test3_original_env_value"
 
     # If option via env is changed, it changes here as well
     os.environ[test3_config_envset] = "test3_new_env_value"
     assert gdal.GetConfigOption(test3_config_envset) == "test3_new_env_value"
+
+
+@pytest.mark.parametrize(
+    "expected_error, kwargs",
+    [
+        (
+            "it is not supported to specify both sql_stmt and where",
+            {"where": "abc", "sql_stmt": "def"},
+        ),
+        (
+            "Error input_layers .* not found in",
+            {"input_layers": "unexisting"},
+        ),
+    ],
+)
+def test_vector_translate_invalid_params(tmp_path, kwargs, expected_error):
+    input_path = test_helper.get_testfile("polygon-parcel")
+    output_path = tmp_path / f"output{input_path.suffix}"
+
+    with pytest.raises(Exception, match=expected_error):
+        _ogr_util.vector_translate(str(input_path), output_path, **kwargs)
+
+
+def test_vector_translate_input_nolayer(tmp_path):
+    input_path = test_helper.get_testfile("polygon-parcel", dst_dir=tmp_path)
+    output_path = tmp_path / f"output{input_path.suffix}"
+    layer = gfo.get_only_layer(input_path)
+    gfo.execute_sql(input_path, sql_stmt=f'DROP TABLE "{layer}"')
+
+    with pytest.raises(
+        Exception, match="Error .* not recognized as a supported file format"
+    ):
+        _ogr_util.vector_translate(str(input_path), output_path)
```

### Comparing `geofileops-0.8.0a5/tests/test_parameter_helper.py` & `geofileops-0.8.0a6/tests/test_parameter_helper.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in _processing_util.
 """
 
 import re
+
 import pytest
 
 from geofileops.helpers import _parameter_helper
 
 
 @pytest.mark.parametrize(
     "agg_columns_value",
```

### Comparing `geofileops-0.8.0a5/tests/test_processing_util.py` & `geofileops-0.8.0a6/tests/test_processing_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.0a5/tests/test_spatialite.py` & `geofileops-0.8.0a6/tests/test_spatialite.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,20 +1,16 @@
 # -*- coding: utf-8 -*-
 """
 Tests for functionalities in ogr_util.
 """
 
 import os
-from pathlib import Path
-import sys
 
 import pytest
 
-# Add path so the local geofileops packages are found
-sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
 import geofileops as gfo
 from tests import test_helper
 
 
 @pytest.mark.skipif(
     "GITHUB_ACTIONS" in os.environ,
     reason="Don't run on CI: just to followup odd behaviour in spatialite.",
```

### Comparing `geofileops-0.8.0a5/tests/test_sqlite_util.py` & `geofileops-0.8.0a6/tests/test_sqlite_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -4,15 +4,15 @@
 """
 
 from pathlib import Path
 
 import pytest
 
 import geofileops as gfo
-from geofileops.util import _sqlite_util
+from geofileops.util import _sqlite_util as sqlite_util
 from tests import test_helper
 
 
 @pytest.mark.parametrize("create_spatial_index", [(True), (False)])
 def test_create_table_as_sql(tmp_path, create_spatial_index):
     output_path = tmp_path / "output.gpkg"
     input1_path = test_helper.get_testfile(testfile="polygon-parcel", dst_dir=tmp_path)
@@ -36,30 +36,30 @@
                AND layer1tree.maxx >= layer2tree.minx
                AND layer1tree.miny <= layer2tree.maxy
                AND layer1tree.maxy >= layer2tree.miny
                AND ST_Intersects(layer1.geom, layer2.geometry) = 1
                AND ST_Touches(layer1.geom, layer2.geometry) = 0
             """
 
-    _sqlite_util.create_table_as_sql(
+    sqlite_util.create_table_as_sql(
         input1_path=input1_path,
         input1_layer="parcels",
         input2_path=input2_path,
         output_path=output_path,
         output_layer=output_path.stem,
         output_geometrytype=gfo.GeometryType.MULTIPOLYGON,
         sql_stmt=sql_stmt,
-        profile=_sqlite_util.SqliteProfile.SPEED,
+        profile=sqlite_util.SqliteProfile.SPEED,
         create_spatial_index=create_spatial_index,
     )
 
     assert output_path.exists()
     assert gfo.has_spatial_index(output_path) is create_spatial_index
     output_info = gfo.get_layerinfo(output_path)
-    assert output_info.featurecount == 6
+    assert output_info.featurecount == 7
 
 
 @pytest.mark.parametrize(
     "kwargs, expected_error",
     [
         ({"append": True}, "append=True nor update=True are implemented."),
         ({"update": True}, "append=True nor update=True are implemented."),
@@ -91,28 +91,28 @@
         kwargs["output_layer"] = "output_layer"
     if "sql_stmt" not in kwargs:
         kwargs["sql_stmt"] = "SELECTje"
     if "output_geometrytype" not in kwargs:
         kwargs["output_geometrytype"] = None
 
     with pytest.raises(ValueError, match=expected_error):
-        _sqlite_util.create_table_as_sql(**kwargs)
+        sqlite_util.create_table_as_sql(**kwargs)
 
 
 def test_execute_sql(tmp_path):
     test_path = test_helper.get_testfile(testfile="polygon-parcel", dst_dir=tmp_path)
     assert gfo.has_spatial_index(test_path)
     info_input = gfo.get_layerinfo(test_path)
     nb_deleted = 0
 
     # Execute one statement
     sql_stmt = "DELETE FROM parcels WHERE rowid = (SELECT MIN(rowid) FROM parcels)"
-    _sqlite_util.execute_sql(test_path, sql_stmt=sql_stmt)
+    sqlite_util.execute_sql(test_path, sql_stmt=sql_stmt)
     nb_deleted += 1
     info = gfo.get_layerinfo(test_path)
     assert info.featurecount == info_input.featurecount - nb_deleted
 
     # Execute a list of statements
-    _sqlite_util.execute_sql(test_path, sql_stmt=[sql_stmt, sql_stmt])
+    sqlite_util.execute_sql(test_path, sql_stmt=[sql_stmt, sql_stmt])
     nb_deleted += 2
     info = gfo.get_layerinfo(test_path)
     assert info.featurecount == info_input.featurecount - nb_deleted
```

